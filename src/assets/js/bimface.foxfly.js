!function(){"use strict";var e,t,i,r=window.CLOUD=window.CLOUD||{};e=1,t=1,function(e){function t(r){if(i[r])return i[r].exports;var n=i[r]={exports:{},id:r,loaded:!1};return e[r].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){i(1),i(50),i(51),i(52),i(54),i(55),i(58),i(59),i(60),i(61),i(62),i(63),i(64),i(65),i(66),i(68),i(70),i(72),i(74),i(77),i(78),i(79),i(83),i(86),i(87),i(88),i(89),i(91),i(92),i(93),i(94),i(95),i(97),i(99),i(100),i(101),i(103),i(104),i(105),i(107),i(108),i(109),i(111),i(112),i(113),i(114),i(115),i(116),i(117),i(118),i(119),i(120),i(121),i(122),i(123),i(124),i(126),i(130),i(131),i(132),i(133),i(137),i(139),i(140),i(141),i(142),i(143),i(144),i(145),i(146),i(147),i(148),i(149),i(150),i(151),i(152),i(158),i(159),i(161),i(162),i(163),i(167),i(168),i(169),i(170),i(171),i(173),i(174),i(175),i(176),i(179),i(181),i(182),i(183),i(185),i(187),i(189),i(190),i(191),i(193),i(194),i(195),i(196),i(203),i(206),i(207),i(209),i(210),i(211),i(212),i(213),i(214),i(215),i(216),i(217),i(218),i(219),i(220),i(222),i(223),i(224),i(225),i(226),i(227),i(228),i(229),i(231),i(234),i(235),i(237),i(238),i(239),i(240),i(241),i(242),i(243),i(244),i(245),i(246),i(247),i(249),i(250),i(251),i(252),i(253),i(254),i(255),i(256),i(258),i(259),i(261),i(262),i(263),i(264),i(267),i(268),i(269),i(270),i(271),i(272),i(273),i(274),i(276),i(277),i(278),i(279),i(280),i(281),i(282),i(283),i(284),i(285),i(286),i(287),i(288),i(291),i(156),i(293),i(292),i(294),i(295),i(296),i(297),i(298),i(300),i(301),i(302),i(304),e.exports=i(305)},function(e,t,r){var n=r(2),a=r(3),s=r(4),o=r(6),l=r(16),d=r(20).KEY,h=r(5),c=r(21),u=r(22),p=r(17),m=r(23),f=r(24),g=r(25),v=r(27),y=r(40),M=r(43),E=r(10),x=r(30),_=r(14),b=r(15),I=r(44),T=r(47),S=r(49),C=r(9),w=r(28),R=S.f,B=C.f,A=T.f,P=n.Symbol,L=n.JSON,O=L&&L.stringify,D="prototype",N=m("_hidden"),H=m("toPrimitive"),U={}.propertyIsEnumerable,F=c("symbol-registry"),k=c("symbols"),G=c("op-symbols"),V=Object[D],z="function"==typeof P,j=n.QObject,W=!j||!j[D]||!j[D].findChild,q=s&&h((function(){return 7!=I(B({},"a",{get:function(){return B(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=R(V,t);r&&delete V[t],B(e,t,i),r&&e!==V&&B(V,t,r)}:B,X=function(e){var t=k[e]=I(P[D]);return t._k=e,t},Y=z&&"symbol"==typeof P.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof P},K=function(e,t,i){return e===V&&K(G,t,i),E(e),t=_(t,!0),E(i),a(k,t)?(i.enumerable?(a(e,N)&&e[N][t]&&(e[N][t]=!1),i=I(i,{enumerable:b(0,!1)})):(a(e,N)||B(e,N,b(1,{})),e[N][t]=!0),q(e,t,i)):B(e,t,i)},Z=function(e,t){E(e);for(var i,r=y(t=x(t)),n=0,a=r.length;a>n;)K(e,i=r[n++],t[i]);return e},Q=function(e){var t=U.call(this,e=_(e,!0));return!(this===V&&a(k,e)&&!a(G,e))&&(!(t||!a(this,e)||!a(k,e)||a(this,N)&&this[N][e])||t)},J=function(e,t){if(e=x(e),t=_(t,!0),e!==V||!a(k,t)||a(G,t)){var i=R(e,t);return!i||!a(k,t)||a(e,N)&&e[N][t]||(i.enumerable=!0),i}},$=function(e){for(var t,i=A(x(e)),r=[],n=0;i.length>n;)a(k,t=i[n++])||t==N||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===V,r=A(i?G:x(e)),n=[],s=0;r.length>s;)!a(k,t=r[s++])||i&&!a(V,t)||n.push(k[t]);return n};z||(P=function(){if(this instanceof P)throw TypeError("Symbol is not a constructor!");var e=p(arguments.length>0?arguments[0]:i),t=function(i){this===V&&t.call(G,i),a(this,N)&&a(this[N],e)&&(this[N][e]=!1),q(this,e,b(1,i))};return s&&W&&q(V,e,{configurable:!0,set:t}),X(e)},l(P[D],"toString",(function(){return this._k})),S.f=J,C.f=K,r(48).f=T.f=$,r(42).f=Q,r(41).f=ee,s&&!r(26)&&l(V,"propertyIsEnumerable",Q,!0),f.f=function(e){return X(m(e))}),o(o.G+o.W+o.F*!z,{Symbol:P});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)m(te[ie++]);for(te=w(m.store),ie=0;te.length>ie;)g(te[ie++]);o(o.S+o.F*!z,"Symbol",{for:function(e){return a(F,e+="")?F[e]:F[e]=P(e)},keyFor:function(e){if(Y(e))return v(F,e);throw TypeError(e+" is not a symbol!")},useSetter:function(){W=!0},useSimple:function(){W=!1}}),o(o.S+o.F*!z,"Object",{create:function(e,t){return t===i?I(e):Z(I(e),t)},defineProperty:K,defineProperties:Z,getOwnPropertyDescriptor:J,getOwnPropertyNames:$,getOwnPropertySymbols:ee}),L&&o(o.S+o.F*(!z||h((function(){var e=P();return"[null]"!=O([e])||"{}"!=O({a:e})||"{}"!=O(Object(e))}))),"JSON",{stringify:function(e){if(e!==i&&!Y(e)){for(var t,r,n=[e],a=1;arguments.length>a;)n.push(arguments[a++]);return"function"==typeof(t=n[1])&&(r=t),!r&&M(t)||(t=function(e,t){if(r&&(t=r.call(this,e,t)),!Y(t))return t}),n[1]=t,O.apply(L,n)}}}),P[D][H]||r(8)(P[D],H,P[D].valueOf),u(P,"Symbol"),u(Math,"Math",!0),u(n.JSON,"JSON",!0)},function(e,i){var r=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof t&&(t=r)},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){e.exports=!i(5)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,r){var n=r(2),a=r(7),s=r(8),o=r(16),l=r(18),d="prototype",h=function(e,t,r){var c,u,p,m,f=e&h.F,g=e&h.G,v=e&h.S,y=e&h.P,M=e&h.B,E=g?n:v?n[t]||(n[t]={}):(n[t]||{})[d],x=g?a:a[t]||(a[t]={}),_=x[d]||(x[d]={});for(c in g&&(r=t),r)p=((u=!f&&E&&E[c]!==i)?E:r)[c],m=M&&u?l(p,n):y&&"function"==typeof p?l(Function.call,p):p,E&&o(E,c,p,e&h.U),x[c]!=p&&s(x,c,m),y&&_[c]!=p&&(_[c]=p)};n.core=a,h.F=1,h.G=2,h.S=4,h.P=8,h.B=16,h.W=32,h.U=64,h.R=128,e.exports=h},function(t,i){var r=t.exports={version:"2.4.0"};"number"==typeof e&&(e=r)},function(e,t,i){var r=i(9),n=i(15);e.exports=i(4)?function(e,t,i){return r.f(e,t,n(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var r=i(10),n=i(12),a=i(14),s=Object.defineProperty;t.f=i(4)?Object.defineProperty:function(e,t,i){if(r(e),t=a(t,!0),r(i),n)try{return s(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t,i){var r=i(11);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(4)&&!i(5)((function(){return 7!=Object.defineProperty(i(13)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){var r=i(11),n=i(2).document,a=r(n)&&r(n.createElement);e.exports=function(e){return a?n.createElement(e):{}}},function(e,t,i){var r=i(11);e.exports=function(e,t){if(!r(e))return e;var i,n;if(t&&"function"==typeof(i=e.toString)&&!r(n=i.call(e)))return n;if("function"==typeof(i=e.valueOf)&&!r(n=i.call(e)))return n;if(!t&&"function"==typeof(i=e.toString)&&!r(n=i.call(e)))return n;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,i){var r=i(2),n=i(8),a=i(3),s=i(17)("src"),o="toString",l=Function[o],d=(""+l).split(o);i(7).inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,i,o){var l="function"==typeof i;l&&(a(i,"name")||n(i,"name",t)),e[t]!==i&&(l&&(a(i,s)||n(i,s,e[t]?""+e[t]:d.join(String(t)))),e===r?e[t]=i:o?e[t]?e[t]=i:n(e,t,i):(delete e[t],n(e,t,i)))})(Function.prototype,o,(function(){return"function"==typeof this&&this[s]||l.call(this)}))},function(e,t){var r=0,n=Math.random();e.exports=function(e){return"Symbol(".concat(e===i?"":e,")_",(++r+n).toString(36))}},function(e,t,r){var n=r(19);e.exports=function(e,t,r){if(n(e),t===i)return e;switch(r){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,n){return e.call(t,i,r,n)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,i){var r=i(17)("meta"),n=i(11),a=i(3),s=i(9).f,o=0,l=Object.isExtensible||function(){return!0},d=!i(5)((function(){return l(Object.preventExtensions({}))})),h=function(e){s(e,r,{value:{i:"O"+ ++o,w:{}}})},c=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!n(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,r)){if(!l(e))return"F";if(!t)return"E";h(e)}return e[r].i},getWeak:function(e,t){if(!a(e,r)){if(!l(e))return!0;if(!t)return!1;h(e)}return e[r].w},onFreeze:function(e){return d&&c.NEED&&l(e)&&!a(e,r)&&h(e),e}}},function(e,t,i){var r=i(2),n="__core-js_shared__",a=r[n]||(r[n]={});e.exports=function(e){return a[e]||(a[e]={})}},function(e,t,i){var r=i(9).f,n=i(3),a=i(23)("toStringTag");e.exports=function(e,t,i){e&&!n(e=i?e:e.prototype,a)&&r(e,a,{configurable:!0,value:t})}},function(e,t,i){var r=i(21)("wks"),n=i(17),a=i(2).Symbol,s="function"==typeof a;(e.exports=function(e){return r[e]||(r[e]=s&&a[e]||(s?a:n)("Symbol."+e))}).store=r},function(e,t,i){t.f=i(23)},function(e,t,i){var r=i(2),n=i(7),a=i(26),s=i(24),o=i(9).f;e.exports=function(e){var t=n.Symbol||(n.Symbol=a?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||o(t,e,{value:s.f(e)})}},function(e,t){e.exports=!1},function(e,t,i){var r=i(28),n=i(30);e.exports=function(e,t){for(var i,a=n(e),s=r(a),o=s.length,l=0;o>l;)if(a[i=s[l++]]===t)return i}},function(e,t,i){var r=i(29),n=i(39);e.exports=Object.keys||function(e){return r(e,n)}},function(e,t,i){var r=i(3),n=i(30),a=i(34)(!1),s=i(38)("IE_PROTO");e.exports=function(e,t){var i,o=n(e),l=0,d=[];for(i in o)i!=s&&r(o,i)&&d.push(i);for(;t.length>l;)r(o,i=t[l++])&&(~a(d,i)||d.push(i));return d}},function(e,t,i){var r=i(31),n=i(33);e.exports=function(e){return r(n(e))}},function(e,t,i){var r=i(32);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(e==i)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var r=i(30),n=i(35),a=i(37);e.exports=function(e){return function(t,i,s){var o,l=r(t),d=n(l.length),h=a(s,d);if(e&&i!=i){for(;d>h;)if((o=l[h++])!=o)return!0}else for(;d>h;h++)if((e||h in l)&&l[h]===i)return e||h||0;return!e&&-1}}},function(e,t,i){var r=i(36),n=Math.min;e.exports=function(e){return e>0?n(r(e),9007199254740991):0}},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)}},function(e,t,i){var r=i(36),n=Math.max,a=Math.min;e.exports=function(e,t){return(e=r(e))<0?n(e+t,0):a(e,t)}},function(e,t,i){var r=i(21)("keys"),n=i(17);e.exports=function(e){return r[e]||(r[e]=n(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){var r=i(28),n=i(41),a=i(42);e.exports=function(e){var t=r(e),i=n.f;if(i)for(var s,o=i(e),l=a.f,d=0;o.length>d;)l.call(e,s=o[d++])&&t.push(s);return t}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,i){var r=i(32);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,r){var n=r(10),a=r(45),s=r(39),o=r(38)("IE_PROTO"),l=function(){},d="prototype",h=function(){var e,t=r(13)("iframe"),i=s.length;for(t.style.display="none",r(46).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),h=e.F;i--;)delete h[d][s[i]];return h()};e.exports=Object.create||function(e,t){var r;return null!==e?(l[d]=n(e),r=new l,l[d]=null,r[o]=e):r=h(),t===i?r:a(r,t)}},function(e,t,i){var r=i(9),n=i(10),a=i(28);e.exports=i(4)?Object.defineProperties:function(e,t){n(e);for(var i,s=a(t),o=s.length,l=0;o>l;)r.f(e,i=s[l++],t[i]);return e}},function(e,t,i){e.exports=i(2).document&&document.documentElement},function(e,t,i){var r=i(30),n=i(48).f,a={}.toString,s="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return s&&"[object Window]"==a.call(e)?function(e){try{return n(e)}catch(e){return s.slice()}}(e):n(r(e))}},function(e,t,i){var r=i(29),n=i(39).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,n)}},function(e,t,i){var r=i(42),n=i(15),a=i(30),s=i(14),o=i(3),l=i(12),d=Object.getOwnPropertyDescriptor;t.f=i(4)?d:function(e,t){if(e=a(e),t=s(t,!0),l)try{return d(e,t)}catch(e){}if(o(e,t))return n(!r.f.call(e,t),e[t])}},function(e,t,i){var r=i(6);r(r.S+r.F*!i(4),"Object",{defineProperty:i(9).f})},function(e,t,i){var r=i(6);r(r.S+r.F*!i(4),"Object",{defineProperties:i(45)})},function(e,t,i){var r=i(30),n=i(49).f;i(53)("getOwnPropertyDescriptor",(function(){return function(e,t){return n(r(e),t)}}))},function(e,t,i){var r=i(6),n=i(7),a=i(5);e.exports=function(e,t){var i=(n.Object||{})[e]||Object[e],s={};s[e]=t(i),r(r.S+r.F*a((function(){i(1)})),"Object",s)}},function(e,t,i){var r=i(6);r(r.S,"Object",{create:i(44)})},function(e,t,i){var r=i(56),n=i(57);i(53)("getPrototypeOf",(function(){return function(e){return n(r(e))}}))},function(e,t,i){var r=i(33);e.exports=function(e){return Object(r(e))}},function(e,t,i){var r=i(3),n=i(56),a=i(38)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=n(e),r(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t,i){var r=i(56),n=i(28);i(53)("keys",(function(){return function(e){return n(r(e))}}))},function(e,t,i){i(53)("getOwnPropertyNames",(function(){return i(47).f}))},function(e,t,i){var r=i(11),n=i(20).onFreeze;i(53)("freeze",(function(e){return function(t){return e&&r(t)?e(n(t)):t}}))},function(e,t,i){var r=i(11),n=i(20).onFreeze;i(53)("seal",(function(e){return function(t){return e&&r(t)?e(n(t)):t}}))},function(e,t,i){var r=i(11),n=i(20).onFreeze;i(53)("preventExtensions",(function(e){return function(t){return e&&r(t)?e(n(t)):t}}))},function(e,t,i){var r=i(11);i(53)("isFrozen",(function(e){return function(t){return!r(t)||!!e&&e(t)}}))},function(e,t,i){var r=i(11);i(53)("isSealed",(function(e){return function(t){return!r(t)||!!e&&e(t)}}))},function(e,t,i){var r=i(11);i(53)("isExtensible",(function(e){return function(t){return!!r(t)&&(!e||e(t))}}))},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{assign:i(67)})},function(e,t,i){var r=i(28),n=i(41),a=i(42),s=i(56),o=i(31),l=Object.assign;e.exports=!l||i(5)((function(){var e={},t={},i=Symbol(),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach((function(e){t[e]=e})),7!=l({},e)[i]||Object.keys(l({},t)).join("")!=r}))?function(e,t){for(var i=s(e),l=arguments.length,d=1,h=n.f,c=a.f;l>d;)for(var u,p=o(arguments[d++]),m=h?r(p).concat(h(p)):r(p),f=m.length,g=0;f>g;)c.call(p,u=m[g++])&&(i[u]=p[u]);return i}:l},function(e,t,i){var r=i(6);r(r.S,"Object",{is:i(69)})},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,i){var r=i(6);r(r.S,"Object",{setPrototypeOf:i(71).set})},function(e,t,r){var n=r(11),a=r(10),s=function(e,t){if(a(e),!n(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,i){try{(i=r(18)(Function.call,r(49).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,r){return s(e,r),t?e.__proto__=r:i(e,r),e}}({},!1):i),check:s}},function(e,t,i){var r=i(73),n={};n[i(23)("toStringTag")]="z",n+""!="[object z]"&&i(16)(Object.prototype,"toString",(function(){return"[object "+r(this)+"]"}),!0)},function(e,t,r){var n=r(32),a=r(23)("toStringTag"),s="Arguments"==n(function(){return arguments}());e.exports=function(e){var t,r,o;return e===i?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),a))?r:s?n(t):"Object"==(o=n(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,i){var r=i(6);r(r.P,"Function",{bind:i(75)})},function(e,t,i){var r=i(19),n=i(11),a=i(76),s=[].slice,o={},l=function(e,t,i){if(!(t in o)){for(var r=[],n=0;n<t;n++)r[n]="a["+n+"]";o[t]=Function("F,a","return new F("+r.join(",")+")")}return o[t](e,i)};e.exports=Function.bind||function(e){var t=r(this),i=s.call(arguments,1),o=function(){var r=i.concat(s.call(arguments));return this instanceof o?l(t,r.length,r):a(t,r,e)};return n(t.prototype)&&(o.prototype=t.prototype),o}},function(e,t){e.exports=function(e,t,r){var n=r===i;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},function(e,t,i){var r=i(9).f,n=i(15),a=i(3),s=Function.prototype,o=/^\s*function ([^ (]*)/,l="name",d=Object.isExtensible||function(){return!0};l in s||i(4)&&r(s,l,{configurable:!0,get:function(){try{var e=this,t=(""+e).match(o)[1];return a(e,l)||!d(e)||r(e,l,n(5,t)),t}catch(e){return""}}})},function(e,t,i){var r=i(11),n=i(57),a=i(23)("hasInstance"),s=Function.prototype;a in s||i(9).f(s,a,{value:function(e){if("function"!=typeof this||!r(e))return!1;if(!r(this.prototype))return e instanceof this;for(;e=n(e);)if(this.prototype===e)return!0;return!1}})},function(e,t,i){var r=i(2),n=i(3),a=i(32),s=i(80),o=i(14),l=i(5),d=i(48).f,h=i(49).f,c=i(9).f,u=i(81).trim,p="Number",m=r[p],f=m,g=m.prototype,v=a(i(44)(g))==p,y="trim"in String.prototype,M=function(e){var t=o(e,!1);if("string"==typeof t&&t.length>2){var i,r,n,a=(t=y?t.trim():u(t,3)).charCodeAt(0);if(43===a||45===a){if(88===(i=t.charCodeAt(2))||120===i)return NaN}else if(48===a){switch(t.charCodeAt(1)){case 66:case 98:r=2,n=49;break;case 79:case 111:r=8,n=55;break;default:return+t}for(var s,l=t.slice(2),d=0,h=l.length;d<h;d++)if((s=l.charCodeAt(d))<48||s>n)return NaN;return parseInt(l,r)}}return+t};if(!m(" 0o1")||!m("0b1")||m("+0x1")){m=function(e){var t=arguments.length<1?0:e,i=this;return i instanceof m&&(v?l((function(){g.valueOf.call(i)})):a(i)!=p)?s(new f(M(t)),i,m):M(t)};for(var E,x=i(4)?d(f):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),_=0;x.length>_;_++)n(f,E=x[_])&&!n(m,E)&&c(m,E,h(f,E));m.prototype=g,g.constructor=m,i(16)(r,p,m)}},function(e,t,i){var r=i(11),n=i(71).set;e.exports=function(e,t,i){var a,s=t.constructor;return s!==i&&"function"==typeof s&&(a=s.prototype)!==i.prototype&&r(a)&&n&&n(e,a),e}},function(e,t,i){var r=i(6),n=i(33),a=i(5),s=i(82),o="["+s+"]",l=RegExp("^"+o+o+"*"),d=RegExp(o+o+"*$"),h=function(e,t,i){var n={},o=a((function(){return!!s[e]()||"​"!="​"[e]()})),l=n[e]=o?t(c):s[e];i&&(n[i]=l),r(r.P+r.F*o,"String",n)},c=h.trim=function(e,t){return e=String(n(e)),1&t&&(e=e.replace(l,"")),2&t&&(e=e.replace(d,"")),e};e.exports=h},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,i){var r=i(6),n=i(36),a=i(84),s=i(85),o=1..toFixed,l=Math.floor,d=[0,0,0,0,0,0],h="Number.toFixed: incorrect invocation!",c="0",u=function(e,t){for(var i=-1,r=t;++i<6;)r+=e*d[i],d[i]=r%1e7,r=l(r/1e7)},p=function(e){for(var t=6,i=0;--t>=0;)i+=d[t],d[t]=l(i/e),i=i%e*1e7},m=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==d[e]){var i=String(d[e]);t=""===t?i:t+s.call(c,7-i.length)+i}return t},f=function(e,t,i){return 0===t?i:t%2==1?f(e,t-1,i*e):f(e*e,t/2,i)};r(r.P+r.F*(!!o&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!i(5)((function(){o.call({})}))),"Number",{toFixed:function(e){var t,i,r,o,l=a(this,h),d=n(e),g="",v=c;if(d<0||d>20)throw RangeError(h);if(l!=l)return"NaN";if(l<=-1e21||l>=1e21)return String(l);if(l<0&&(g="-",l=-l),l>1e-21)if(t=function(e){for(var t=0,i=e;i>=4096;)t+=12,i/=4096;for(;i>=2;)t+=1,i/=2;return t}(l*f(2,69,1))-69,i=t<0?l*f(2,-t,1):l/f(2,t,1),i*=4503599627370496,(t=52-t)>0){for(u(0,i),r=d;r>=7;)u(1e7,0),r-=7;for(u(f(10,r,1),0),r=t-1;r>=23;)p(1<<23),r-=23;p(1<<r),u(1,1),p(2),v=m()}else u(0,i),u(1<<-t,0),v=m()+s.call(c,d);return v=d>0?g+((o=v.length)<=d?"0."+s.call(c,d-o)+v:v.slice(0,o-d)+"."+v.slice(o-d)):g+v}})},function(e,t,i){var r=i(32);e.exports=function(e,t){if("number"!=typeof e&&"Number"!=r(e))throw TypeError(t);return+e}},function(e,t,i){var r=i(36),n=i(33);e.exports=function(e){var t=String(n(this)),i="",a=r(e);if(a<0||a==1/0)throw RangeError("Count can't be negative");for(;a>0;(a>>>=1)&&(t+=t))1&a&&(i+=t);return i}},function(e,t,r){var n=r(6),a=r(5),s=r(84),o=1..toPrecision;n(n.P+n.F*(a((function(){return"1"!==o.call(1,i)}))||!a((function(){o.call({})}))),"Number",{toPrecision:function(e){var t=s(this,"Number#toPrecision: incorrect invocation!");return e===i?o.call(t):o.call(t,e)}})},function(e,t,i){var r=i(6);r(r.S,"Number",{EPSILON:Math.pow(2,-52)})},function(e,t,i){var r=i(6),n=i(2).isFinite;r(r.S,"Number",{isFinite:function(e){return"number"==typeof e&&n(e)}})},function(e,t,i){var r=i(6);r(r.S,"Number",{isInteger:i(90)})},function(e,t,i){var r=i(11),n=Math.floor;e.exports=function(e){return!r(e)&&isFinite(e)&&n(e)===e}},function(e,t,i){var r=i(6);r(r.S,"Number",{isNaN:function(e){return e!=e}})},function(e,t,i){var r=i(6),n=i(90),a=Math.abs;r(r.S,"Number",{isSafeInteger:function(e){return n(e)&&a(e)<=9007199254740991}})},function(e,t,i){var r=i(6);r(r.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(e,t,i){var r=i(6);r(r.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(e,t,i){var r=i(6),n=i(96);r(r.S+r.F*(Number.parseFloat!=n),"Number",{parseFloat:n})},function(e,t,i){var r=i(2).parseFloat,n=i(81).trim;e.exports=1/r(i(82)+"-0")!=-1/0?function(e){var t=n(String(e),3),i=r(t);return 0===i&&"-"==t.charAt(0)?-0:i}:r},function(e,t,i){var r=i(6),n=i(98);r(r.S+r.F*(Number.parseInt!=n),"Number",{parseInt:n})},function(e,t,i){var r=i(2).parseInt,n=i(81).trim,a=i(82),s=/^[\-+]?0[xX]/;e.exports=8!==r(a+"08")||22!==r(a+"0x16")?function(e,t){var i=n(String(e),3);return r(i,t>>>0||(s.test(i)?16:10))}:r},function(e,t,i){var r=i(6),n=i(98);r(r.G+r.F*(parseInt!=n),{parseInt:n})},function(e,t,i){var r=i(6),n=i(96);r(r.G+r.F*(parseFloat!=n),{parseFloat:n})},function(e,t,i){var r=i(6),n=i(102),a=Math.sqrt,s=Math.acosh;r(r.S+r.F*!(s&&710==Math.floor(s(Number.MAX_VALUE))&&s(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:n(e-1+a(e-1)*a(e+1))}})},function(e,t){e.exports=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)}},function(e,t,i){var r=i(6),n=Math.asinh;r(r.S+r.F*!(n&&1/n(0)>0),"Math",{asinh:function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}})},function(e,t,i){var r=i(6),n=Math.atanh;r(r.S+r.F*!(n&&1/n(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}})},function(e,t,i){var r=i(6),n=i(106);r(r.S,"Math",{cbrt:function(e){return n(e=+e)*Math.pow(Math.abs(e),1/3)}})},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t,i){var r=i(6);r(r.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},function(e,t,i){var r=i(6),n=Math.exp;r(r.S,"Math",{cosh:function(e){return(n(e=+e)+n(-e))/2}})},function(e,t,i){var r=i(6),n=i(110);r(r.S+r.F*(n!=Math.expm1),"Math",{expm1:n})},function(e,t){var i=Math.expm1;e.exports=!i||i(10)>22025.465794806718||i(10)<22025.465794806718||-2e-17!=i(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:i},function(e,t,i){var r=i(6),n=i(106),a=Math.pow,s=a(2,-52),o=a(2,-23),l=a(2,127)*(2-o),d=a(2,-126);r(r.S,"Math",{fround:function(e){var t,i,r=Math.abs(e),a=n(e);return r<d?a*function(e){return e+1/s-1/s}(r/d/o)*d*o:(i=(t=(1+o/s)*r)-(t-r))>l||i!=i?a*(1/0):a*i}})},function(e,t,i){var r=i(6),n=Math.abs;r(r.S,"Math",{hypot:function(e,t){for(var i,r,a=0,s=0,o=arguments.length,l=0;s<o;)l<(i=n(arguments[s++]))?(a=a*(r=l/i)*r+1,l=i):a+=i>0?(r=i/l)*r:i;return l===1/0?1/0:l*Math.sqrt(a)}})},function(e,t,i){var r=i(6),n=Math.imul;r(r.S+r.F*i(5)((function(){return-5!=n(4294967295,5)||2!=n.length})),"Math",{imul:function(e,t){var i=65535,r=+e,n=+t,a=i&r,s=i&n;return 0|a*s+((i&r>>>16)*s+a*(i&n>>>16)<<16>>>0)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{log10:function(e){return Math.log(e)/Math.LN10}})},function(e,t,i){var r=i(6);r(r.S,"Math",{log1p:i(102)})},function(e,t,i){var r=i(6);r(r.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}})},function(e,t,i){var r=i(6);r(r.S,"Math",{sign:i(106)})},function(e,t,i){var r=i(6),n=i(110),a=Math.exp;r(r.S+r.F*i(5)((function(){return-2e-17!=!Math.sinh(-2e-17)})),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(n(e)-n(-e))/2:(a(e-1)-a(-e-1))*(Math.E/2)}})},function(e,t,i){var r=i(6),n=i(110),a=Math.exp;r(r.S,"Math",{tanh:function(e){var t=n(e=+e),i=n(-e);return t==1/0?1:i==1/0?-1:(t-i)/(a(e)+a(-e))}})},function(e,t,i){var r=i(6);r(r.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}})},function(e,t,i){var r=i(6),n=i(37),a=String.fromCharCode,s=String.fromCodePoint;r(r.S+r.F*(!!s&&1!=s.length),"String",{fromCodePoint:function(e){for(var t,i=[],r=arguments.length,s=0;r>s;){if(t=+arguments[s++],n(t,1114111)!==t)throw RangeError(t+" is not a valid code point");i.push(t<65536?a(t):a(55296+((t-=65536)>>10),t%1024+56320))}return i.join("")}})},function(e,t,i){var r=i(6),n=i(30),a=i(35);r(r.S,"String",{raw:function(e){for(var t=n(e.raw),i=a(t.length),r=arguments.length,s=[],o=0;i>o;)s.push(String(t[o++])),o<r&&s.push(String(arguments[o]));return s.join("")}})},function(e,t,i){i(81)("trim",(function(e){return function(){return e(this,3)}}))},function(e,t,i){var r=i(6),n=i(125)(!1);r(r.P,"String",{codePointAt:function(e){return n(this,e)}})},function(e,t,r){var n=r(36),a=r(33);e.exports=function(e){return function(t,r){var s,o,l=String(a(t)),d=n(r),h=l.length;return d<0||d>=h?e?"":i:(s=l.charCodeAt(d))<55296||s>56319||d+1===h||(o=l.charCodeAt(d+1))<56320||o>57343?e?l.charAt(d):s:e?l.slice(d,d+2):o-56320+(s-55296<<10)+65536}}},function(e,t,r){var n=r(6),a=r(35),s=r(127),o="endsWith",l=""[o];n(n.P+n.F*r(129)(o),"String",{endsWith:function(e){var t=s(this,e,o),r=arguments.length>1?arguments[1]:i,n=a(t.length),d=r===i?n:Math.min(a(r),n),h=String(e);return l?l.call(t,h,d):t.slice(d-h.length,d)===h}})},function(e,t,i){var r=i(128),n=i(33);e.exports=function(e,t,i){if(r(t))throw TypeError("String#"+i+" doesn't accept regex!");return String(n(e))}},function(e,t,r){var n=r(11),a=r(32),s=r(23)("match");e.exports=function(e){var t;return n(e)&&((t=e[s])!==i?!!t:"RegExp"==a(e))}},function(e,t,i){var r=i(23)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[r]=!1,!"/./"[e](t)}catch(e){}}return!0}},function(e,t,r){var n=r(6),a=r(127),s="includes";n(n.P+n.F*r(129)(s),"String",{includes:function(e){return!!~a(this,e,s).indexOf(e,arguments.length>1?arguments[1]:i)}})},function(e,t,i){var r=i(6);r(r.P,"String",{repeat:i(85)})},function(e,t,r){var n=r(6),a=r(35),s=r(127),o="startsWith",l=""[o];n(n.P+n.F*r(129)(o),"String",{startsWith:function(e){var t=s(this,e,o),r=a(Math.min(arguments.length>1?arguments[1]:i,t.length)),n=String(e);return l?l.call(t,n,r):t.slice(r,r+n.length)===n}})},function(e,t,r){var n=r(125)(!0);r(134)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,r=this._i;return r>=t.length?{value:i,done:!0}:(e=n(t,r),this._i+=e.length,{value:e,done:!1})}))},function(e,t,r){var n=r(26),a=r(6),s=r(16),o=r(8),l=r(3),d=r(135),h=r(136),c=r(22),u=r(57),p=r(23)("iterator"),m=!([].keys&&"next"in[].keys()),f="keys",g="values",v=function(){return this};e.exports=function(e,t,r,y,M,E,x){h(r,t,y);var _,b,I,T=function(e){if(!m&&e in R)return R[e];switch(e){case f:case g:return function(){return new r(this,e)}}return function(){return new r(this,e)}},S=t+" Iterator",C=M==g,w=!1,R=e.prototype,B=R[p]||R["@@iterator"]||M&&R[M],A=B||T(M),P=M?C?T("entries"):A:i,L="Array"==t&&R.entries||B;if(L&&(I=u(L.call(new e)))!==Object.prototype&&(c(I,S,!0),n||l(I,p)||o(I,p,v)),C&&B&&B.name!==g&&(w=!0,A=function(){return B.call(this)}),n&&!x||!m&&!w&&R[p]||o(R,p,A),d[t]=A,d[S]=v,M)if(_={values:C?A:T(g),keys:E?A:T(f),entries:P},x)for(b in _)b in R||s(R,b,_[b]);else a(a.P+a.F*(m||w),t,_);return _}},function(e,t){e.exports={}},function(e,t,i){var r=i(44),n=i(15),a=i(22),s={};i(8)(s,i(23)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(s,{next:n(1,i)}),a(e,t+" Iterator")}},function(e,t,i){i(138)("anchor",(function(e){return function(t){return e(this,"a","name",t)}}))},function(e,t,i){var r=i(6),n=i(5),a=i(33),s=/"/g,o=function(e,t,i,r){var n=String(a(e)),o="<"+t;return""!==i&&(o+=" "+i+'="'+String(r).replace(s,"&quot;")+'"'),o+">"+n+"</"+t+">"};e.exports=function(e,t){var i={};i[e]=t(o),r(r.P+r.F*n((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3})),"String",i)}},function(e,t,i){i(138)("big",(function(e){return function(){return e(this,"big","","")}}))},function(e,t,i){i(138)("blink",(function(e){return function(){return e(this,"blink","","")}}))},function(e,t,i){i(138)("bold",(function(e){return function(){return e(this,"b","","")}}))},function(e,t,i){i(138)("fixed",(function(e){return function(){return e(this,"tt","","")}}))},function(e,t,i){i(138)("fontcolor",(function(e){return function(t){return e(this,"font","color",t)}}))},function(e,t,i){i(138)("fontsize",(function(e){return function(t){return e(this,"font","size",t)}}))},function(e,t,i){i(138)("italics",(function(e){return function(){return e(this,"i","","")}}))},function(e,t,i){i(138)("link",(function(e){return function(t){return e(this,"a","href",t)}}))},function(e,t,i){i(138)("small",(function(e){return function(){return e(this,"small","","")}}))},function(e,t,i){i(138)("strike",(function(e){return function(){return e(this,"strike","","")}}))},function(e,t,i){i(138)("sub",(function(e){return function(){return e(this,"sub","","")}}))},function(e,t,i){i(138)("sup",(function(e){return function(){return e(this,"sup","","")}}))},function(e,t,i){var r=i(6);r(r.S,"Array",{isArray:i(43)})},function(e,t,r){var n=r(18),a=r(6),s=r(56),o=r(153),l=r(154),d=r(35),h=r(155),c=r(156);a(a.S+a.F*!r(157)((function(e){})),"Array",{from:function(e){var t,r,a,u,p=s(e),m="function"==typeof this?this:Array,f=arguments.length,g=f>1?arguments[1]:i,v=g!==i,y=0,M=c(p);if(v&&(g=n(g,f>2?arguments[2]:i,2)),M==i||m==Array&&l(M))for(r=new m(t=d(p.length));t>y;y++)h(r,y,v?g(p[y],y):p[y]);else for(u=M.call(p),r=new m;!(a=u.next()).done;y++)h(r,y,v?o(u,g,[a.value,y],!0):a.value);return r.length=y,r}})},function(e,t,r){var n=r(10);e.exports=function(e,t,r,a){try{return a?t(n(r)[0],r[1]):t(r)}catch(t){var s=e.return;throw s!==i&&n(s.call(e)),t}}},function(e,t,r){var n=r(135),a=r(23)("iterator"),s=Array.prototype;e.exports=function(e){return e!==i&&(n.Array===e||s[a]===e)}},function(e,t,i){var r=i(9),n=i(15);e.exports=function(e,t,i){t in e?r.f(e,t,n(0,i)):e[t]=i}},function(e,t,r){var n=r(73),a=r(23)("iterator"),s=r(135);e.exports=r(7).getIteratorMethod=function(e){if(e!=i)return e[a]||e["@@iterator"]||s[n(e)]}},function(e,t,i){var r=i(23)("iterator"),n=!1;try{var a=[7][r]();a.return=function(){n=!0},Array.from(a,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!n)return!1;var i=!1;try{var a=[7],s=a[r]();s.next=function(){return{done:i=!0}},a[r]=function(){return s},e(a)}catch(e){}return i}},function(e,t,i){var r=i(6),n=i(155);r(r.S+r.F*i(5)((function(){function e(){}return!(Array.of.call(e)instanceof e)})),"Array",{of:function(){for(var e=0,t=arguments.length,i=new("function"==typeof this?this:Array)(t);t>e;)n(i,e,arguments[e++]);return i.length=t,i}})},function(e,t,r){var n=r(6),a=r(30),s=[].join;n(n.P+n.F*(r(31)!=Object||!r(160)(s)),"Array",{join:function(e){return s.call(a(this),e===i?",":e)}})},function(e,t,i){var r=i(5);e.exports=function(e,t){return!!e&&r((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},function(e,t,r){var n=r(6),a=r(46),s=r(32),o=r(37),l=r(35),d=[].slice;n(n.P+n.F*r(5)((function(){a&&d.call(a)})),"Array",{slice:function(e,t){var r=l(this.length),n=s(this);if(t=t===i?r:t,"Array"==n)return d.call(this,e,t);for(var a=o(e,r),h=o(t,r),c=l(h-a),u=Array(c),p=0;p<c;p++)u[p]="String"==n?this.charAt(a+p):this[a+p];return u}})},function(e,t,r){var n=r(6),a=r(19),s=r(56),o=r(5),l=[].sort,d=[1,2,3];n(n.P+n.F*(o((function(){d.sort(i)}))||!o((function(){d.sort(null)}))||!r(160)(l)),"Array",{sort:function(e){return e===i?l.call(s(this)):l.call(s(this),a(e))}})},function(e,t,i){var r=i(6),n=i(164)(0),a=i(160)([].forEach,!0);r(r.P+r.F*!a,"Array",{forEach:function(e){return n(this,e,arguments[1])}})},function(e,t,r){var n=r(18),a=r(31),s=r(56),o=r(35),l=r(165);e.exports=function(e,t){var r=1==e,d=2==e,h=3==e,c=4==e,u=6==e,p=5==e||u,m=t||l;return function(t,l,f){for(var g,v,y=s(t),M=a(y),E=n(l,f,3),x=o(M.length),_=0,b=r?m(t,x):d?m(t,0):i;x>_;_++)if((p||_ in M)&&(v=E(g=M[_],_,y),e))if(r)b[_]=v;else if(v)switch(e){case 3:return!0;case 5:return g;case 6:return _;case 2:b.push(g)}else if(c)return!1;return u?-1:h||c?c:b}}},function(e,t,i){var r=i(166);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,r){var n=r(11),a=r(43),s=r(23)("species");e.exports=function(e){var t;return a(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!a(t.prototype)||(t=i),n(t)&&null===(t=t[s])&&(t=i)),t===i?Array:t}},function(e,t,i){var r=i(6),n=i(164)(1);r(r.P+r.F*!i(160)([].map,!0),"Array",{map:function(e){return n(this,e,arguments[1])}})},function(e,t,i){var r=i(6),n=i(164)(2);r(r.P+r.F*!i(160)([].filter,!0),"Array",{filter:function(e){return n(this,e,arguments[1])}})},function(e,t,i){var r=i(6),n=i(164)(3);r(r.P+r.F*!i(160)([].some,!0),"Array",{some:function(e){return n(this,e,arguments[1])}})},function(e,t,i){var r=i(6),n=i(164)(4);r(r.P+r.F*!i(160)([].every,!0),"Array",{every:function(e){return n(this,e,arguments[1])}})},function(e,t,i){var r=i(6),n=i(172);r(r.P+r.F*!i(160)([].reduce,!0),"Array",{reduce:function(e){return n(this,e,arguments.length,arguments[1],!1)}})},function(e,t,i){var r=i(19),n=i(56),a=i(31),s=i(35);e.exports=function(e,t,i,o,l){r(t);var d=n(e),h=a(d),c=s(d.length),u=l?c-1:0,p=l?-1:1;if(i<2)for(;;){if(u in h){o=h[u],u+=p;break}if(u+=p,l?u<0:c<=u)throw TypeError("Reduce of empty array with no initial value")}for(;l?u>=0:c>u;u+=p)u in h&&(o=t(o,h[u],u,d));return o}},function(e,t,i){var r=i(6),n=i(172);r(r.P+r.F*!i(160)([].reduceRight,!0),"Array",{reduceRight:function(e){return n(this,e,arguments.length,arguments[1],!0)}})},function(e,t,i){var r=i(6),n=i(34)(!1),a=[].indexOf,s=!!a&&1/[1].indexOf(1,-0)<0;r(r.P+r.F*(s||!i(160)(a)),"Array",{indexOf:function(e){return s?a.apply(this,arguments)||0:n(this,e,arguments[1])}})},function(e,t,i){var r=i(6),n=i(30),a=i(36),s=i(35),o=[].lastIndexOf,l=!!o&&1/[1].lastIndexOf(1,-0)<0;r(r.P+r.F*(l||!i(160)(o)),"Array",{lastIndexOf:function(e){if(l)return o.apply(this,arguments)||0;var t=n(this),i=s(t.length),r=i-1;for(arguments.length>1&&(r=Math.min(r,a(arguments[1]))),r<0&&(r=i+r);r>=0;r--)if(r in t&&t[r]===e)return r||0;return-1}})},function(e,t,i){var r=i(6);r(r.P,"Array",{copyWithin:i(177)}),i(178)("copyWithin")},function(e,t,r){var n=r(56),a=r(37),s=r(35);e.exports=[].copyWithin||function(e,t){var r=n(this),o=s(r.length),l=a(e,o),d=a(t,o),h=arguments.length>2?arguments[2]:i,c=Math.min((h===i?o:a(h,o))-d,o-l),u=1;for(d<l&&l<d+c&&(u=-1,d+=c-1,l+=c-1);c-- >0;)d in r?r[l]=r[d]:delete r[l],l+=u,d+=u;return r}},function(e,t,r){var n=r(23)("unscopables"),a=Array.prototype;a[n]==i&&r(8)(a,n,{}),e.exports=function(e){a[n][e]=!0}},function(e,t,i){var r=i(6);r(r.P,"Array",{fill:i(180)}),i(178)("fill")},function(e,t,r){var n=r(56),a=r(37),s=r(35);e.exports=function(e){for(var t=n(this),r=s(t.length),o=arguments.length,l=a(o>1?arguments[1]:i,r),d=o>2?arguments[2]:i,h=d===i?r:a(d,r);h>l;)t[l++]=e;return t}},function(e,t,r){var n=r(6),a=r(164)(5),s="find",o=!0;s in[]&&Array(1)[s]((function(){o=!1})),n(n.P+n.F*o,"Array",{find:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),r(178)(s)},function(e,t,r){var n=r(6),a=r(164)(6),s="findIndex",o=!0;s in[]&&Array(1)[s]((function(){o=!1})),n(n.P+n.F*o,"Array",{findIndex:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),r(178)(s)},function(e,t,r){var n=r(178),a=r(184),s=r(135),o=r(30);e.exports=r(134)(Array,"Array",(function(e,t){this._t=o(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=i,a(1)):a(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])}),"values"),s.Arguments=s.Array,n("keys"),n("values"),n("entries")},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){i(186)("Array")},function(e,t,i){var r=i(2),n=i(9),a=i(4),s=i(23)("species");e.exports=function(e){var t=r[e];a&&t&&!t[s]&&n.f(t,s,{configurable:!0,get:function(){return this}})}},function(e,t,r){var n=r(2),a=r(80),s=r(9).f,o=r(48).f,l=r(128),d=r(188),h=n.RegExp,c=h,u=h.prototype,p=/a/g,m=/a/g,f=new h(p)!==p;if(r(4)&&(!f||r(5)((function(){return m[r(23)("match")]=!1,h(p)!=p||h(m)==m||"/a/i"!=h(p,"i")})))){h=function(e,t){var r=this instanceof h,n=l(e),s=t===i;return!r&&n&&e.constructor===h&&s?e:a(f?new c(n&&!s?e.source:e,t):c((n=e instanceof h)?e.source:e,n&&s?d.call(e):t),r?this:u,h)};for(var g=function(e){e in h||s(h,e,{configurable:!0,get:function(){return c[e]},set:function(t){c[e]=t}})},v=o(c),y=0;v.length>y;)g(v[y++]);u.constructor=h,h.prototype=u,r(16)(n,"RegExp",h)}r(186)("RegExp")},function(e,t,i){var r=i(10);e.exports=function(){var e=r(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,r){r(190);var n=r(10),a=r(188),s=r(4),o="toString",l=/./[o],d=function(e){r(16)(RegExp.prototype,o,e,!0)};r(5)((function(){return"/a/b"!=l.call({source:"a",flags:"b"})}))?d((function(){var e=n(this);return"/".concat(e.source,"/","flags"in e?e.flags:!s&&e instanceof RegExp?a.call(e):i)})):l.name!=o&&d((function(){return l.call(this)}))},function(e,t,i){i(4)&&"g"!=/./g.flags&&i(9).f(RegExp.prototype,"flags",{configurable:!0,get:i(188)})},function(e,t,r){r(192)("match",1,(function(e,t,r){return[function(r){var n=e(this),a=r==i?i:r[t];return a!==i?a.call(r,n):new RegExp(r)[t](String(n))},r]}))},function(e,t,i){var r=i(8),n=i(16),a=i(5),s=i(33),o=i(23);e.exports=function(e,t,i){var l=o(e),d=i(s,l,""[e]),h=d[0],c=d[1];a((function(){var t={};return t[l]=function(){return 7},7!=""[e](t)}))&&(n(String.prototype,e,h),r(RegExp.prototype,l,2==t?function(e,t){return c.call(e,this,t)}:function(e){return c.call(e,this)}))}},function(e,t,r){r(192)("replace",2,(function(e,t,r){return[function(n,a){var s=e(this),o=n==i?i:n[t];return o!==i?o.call(n,s,a):r.call(String(s),n,a)},r]}))},function(e,t,r){r(192)("search",1,(function(e,t,r){return[function(r){var n=e(this),a=r==i?i:r[t];return a!==i?a.call(r,n):new RegExp(r)[t](String(n))},r]}))},function(e,t,r){r(192)("split",2,(function(e,t,n){var a=r(128),s=n,o=[].push,l="split",d="length",h="lastIndex";if("c"=="abbc"[l](/(b)*/)[1]||4!="test"[l](/(?:)/,-1)[d]||2!="ab"[l](/(?:ab)*/)[d]||4!="."[l](/(.?)(.?)/)[d]||"."[l](/()()/)[d]>1||""[l](/.?/)[d]){var c=/()??/.exec("")[1]===i;n=function(e,t){var r=String(this);if(e===i&&0===t)return[];if(!a(e))return s.call(r,e,t);var n,l,u,p,m,f=[],g=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),v=0,y=t===i?4294967295:t>>>0,M=new RegExp(e.source,g+"g");for(c||(n=new RegExp("^"+M.source+"$(?!\\s)",g));(l=M.exec(r))&&!((u=l.index+l[0][d])>v&&(f.push(r.slice(v,l.index)),!c&&l[d]>1&&l[0].replace(n,(function(){for(m=1;m<arguments[d]-2;m++)arguments[m]===i&&(l[m]=i)})),l[d]>1&&l.index<r[d]&&o.apply(f,l.slice(1)),p=l[0][d],v=u,f[d]>=y));)M[h]===l.index&&M[h]++;return v===r[d]?!p&&M.test("")||f.push(""):f.push(r.slice(v)),f[d]>y?f.slice(0,y):f}}else"0"[l](i,0)[d]&&(n=function(e,t){return e===i&&0===t?[]:s.call(this,e,t)});return[function(r,a){var s=e(this),o=r==i?i:r[t];return o!==i?o.call(r,s,a):n.call(String(s),r,a)},n]}))},function(e,t,r){var n,a,s,o=r(26),l=r(2),d=r(18),h=r(73),c=r(6),u=r(11),p=r(19),m=r(197),f=r(198),g=r(199),v=r(200).set,y=r(201)(),M="Promise",E=l.TypeError,x=l.process,_=l[M],b="process"==h(x=l.process),I=function(){},T=!!function(){try{var e=_.resolve(1),t=(e.constructor={})[r(23)("species")]=function(e){e(I,I)};return(b||"function"==typeof PromiseRejectionEvent)&&e.then(I)instanceof t}catch(e){}}(),S=function(e,t){return e===t||e===_&&t===s},C=function(e){var t;return!(!u(e)||"function"!=typeof(t=e.then))&&t},w=function(e){return S(_,e)?new R(e):new a(e)},R=a=function(e){var t,r;this.promise=new e((function(e,n){if(t!==i||r!==i)throw E("Bad Promise constructor");t=e,r=n})),this.resolve=p(t),this.reject=p(r)},B=function(e){try{e()}catch(e){return{error:e}}},A=function(e,t){if(!e._n){e._n=!0;var i=e._c;y((function(){for(var r=e._v,n=1==e._s,a=0,s=function(t){var i,a,s=n?t.ok:t.fail,o=t.resolve,l=t.reject,d=t.domain;try{s?(n||(2==e._h&&O(e),e._h=1),!0===s?i=r:(d&&d.enter(),i=s(r),d&&d.exit()),i===t.promise?l(E("Promise-chain cycle")):(a=C(i))?a.call(i,o,l):o(i)):l(r)}catch(e){l(e)}};i.length>a;)s(i[a++]);e._c=[],e._n=!1,t&&!e._h&&P(e)}))}},P=function(e){v.call(l,(function(){var t,r,n,a=e._v;if(L(e)&&(t=B((function(){b?x.emit("unhandledRejection",a,e):(r=l.onunhandledrejection)?r({promise:e,reason:a}):(n=l.console)&&n.error&&n.error("Unhandled promise rejection",a)})),e._h=b||L(e)?2:1),e._a=i,t)throw t.error}))},L=function(e){if(1==e._h)return!1;for(var t,i=e._a||e._c,r=0;i.length>r;)if((t=i[r++]).fail||!L(t.promise))return!1;return!0},O=function(e){v.call(l,(function(){var t;b?x.emit("rejectionHandled",e):(t=l.onrejectionhandled)&&t({promise:e,reason:e._v})}))},D=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),A(t,!0))},N=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw E("Promise can't be resolved itself");(t=C(e))?y((function(){var r={_w:i,_d:!1};try{t.call(e,d(N,r,1),d(D,r,1))}catch(e){D.call(r,e)}})):(i._v=e,i._s=1,A(i,!1))}catch(e){D.call({_w:i,_d:!1},e)}}};T||(_=function(e){m(this,_,M,"_h"),p(e),n.call(this);try{e(d(N,this,1),d(D,this,1))}catch(e){D.call(this,e)}},(n=function(e){this._c=[],this._a=i,this._s=0,this._d=!1,this._v=i,this._h=0,this._n=!1}).prototype=r(202)(_.prototype,{then:function(e,t){var r=w(g(this,_));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=b?x.domain:i,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(e){return this.then(i,e)}}),R=function(){var e=new n;this.promise=e,this.resolve=d(N,e,1),this.reject=d(D,e,1)}),c(c.G+c.W+c.F*!T,{Promise:_}),r(22)(_,M),r(186)(M),s=r(7)[M],c(c.S+c.F*!T,M,{reject:function(e){var t=w(this);return(0,t.reject)(e),t.promise}}),c(c.S+c.F*(o||!T),M,{resolve:function(e){if(e instanceof _&&S(e.constructor,this))return e;var t=w(this);return(0,t.resolve)(e),t.promise}}),c(c.S+c.F*!(T&&r(157)((function(e){_.all(e).catch(I)}))),M,{all:function(e){var t=this,r=w(t),n=r.resolve,a=r.reject,s=B((function(){var r=[],s=0,o=1;f(e,!1,(function(e){var l=s++,d=!1;r.push(i),o++,t.resolve(e).then((function(e){d||(d=!0,r[l]=e,--o||n(r))}),a)})),--o||n(r)}));return s&&a(s.error),r.promise},race:function(e){var t=this,i=w(t),r=i.reject,n=B((function(){f(e,!1,(function(e){t.resolve(e).then(i.resolve,r)}))}));return n&&r(n.error),i.promise}})},function(e,t){e.exports=function(e,t,r,n){if(!(e instanceof t)||n!==i&&n in e)throw TypeError(r+": incorrect invocation!");return e}},function(e,t,i){var r=i(18),n=i(153),a=i(154),s=i(10),o=i(35),l=i(156),d={},h={};t=e.exports=function(e,t,i,c,u){var p,m,f,g,v=u?function(){return e}:l(e),y=r(i,c,t?2:1),M=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(p=o(e.length);p>M;M++)if((g=t?y(s(m=e[M])[0],m[1]):y(e[M]))===d||g===h)return g}else for(f=v.call(e);!(m=f.next()).done;)if((g=n(f,y,m.value,t))===d||g===h)return g},t.BREAK=d,t.RETURN=h},function(e,t,r){var n=r(10),a=r(19),s=r(23)("species");e.exports=function(e,t){var r,o=n(e).constructor;return o===i||(r=n(o)[s])==i?t:a(r)}},function(e,t,i){var r,n,a,s=i(18),o=i(76),l=i(46),d=i(13),h=i(2),c=h.process,u=h.setImmediate,p=h.clearImmediate,m=h.MessageChannel,f=0,g={},v="onreadystatechange",y=function(){var e=+this;if(g.hasOwnProperty(e)){var t=g[e];delete g[e],t()}},M=function(e){y.call(e.data)};u&&p||(u=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return g[++f]=function(){o("function"==typeof e?e:Function(e),t)},r(f),f},p=function(e){delete g[e]},"process"==i(32)(c)?r=function(e){c.nextTick(s(y,e,1))}:m?(a=(n=new m).port2,n.port1.onmessage=M,r=s(a.postMessage,a,1)):h.addEventListener&&"function"==typeof postMessage&&!h.importScripts?(r=function(e){h.postMessage(e+"","*")},h.addEventListener("message",M,!1)):r=v in d("script")?function(e){l.appendChild(d("script"))[v]=function(){l.removeChild(this),y.call(e)}}:function(e){setTimeout(s(y,e,1),0)}),e.exports={set:u,clear:p}},function(e,t,r){var n=r(2),a=r(200).set,s=n.MutationObserver||n.WebKitMutationObserver,o=n.process,l=n.Promise,d="process"==r(32)(o);e.exports=function(){var e,t,r,h=function(){var n,a;for(d&&(n=o.domain)&&n.exit();e;){a=e.fn,e=e.next;try{a()}catch(n){throw e?r():t=i,n}}t=i,n&&n.enter()};if(d)r=function(){o.nextTick(h)};else if(s){var c=!0,u=document.createTextNode("");new s(h).observe(u,{characterData:!0}),r=function(){u.data=c=!c}}else if(l&&l.resolve){var p=l.resolve();r=function(){p.then(h)}}else r=function(){a.call(n,h)};return function(n){var a={fn:n,next:i};t&&(t.next=a),e||(e=a,r()),t=a}}},function(e,t,i){var r=i(16);e.exports=function(e,t,i){for(var n in t)r(e,n,t[n],i);return e}},function(e,t,r){var n=r(204);e.exports=r(205)("Map",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{get:function(e){var t=n.getEntry(this,e);return t&&t.v},set:function(e,t){return n.def(this,0===e?0:e,t)}},n,!0)},function(e,t,r){var n=r(9).f,a=r(44),s=r(202),o=r(18),l=r(197),d=r(33),h=r(198),c=r(134),u=r(184),p=r(186),m=r(4),f=r(20).fastKey,g=m?"_s":"size",v=function(e,t){var i,r=f(t);if("F"!==r)return e._i[r];for(i=e._f;i;i=i.n)if(i.k==t)return i};e.exports={getConstructor:function(e,t,r,c){var u=e((function(e,n){l(e,u,t,"_i"),e._i=a(null),e._f=i,e._l=i,e[g]=0,n!=i&&h(n,r,e[c],e)}));return s(u.prototype,{clear:function(){for(var e=this,t=e._i,r=e._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=i),delete t[r.i];e._f=e._l=i,e[g]=0},delete:function(e){var t=this,i=v(t,e);if(i){var r=i.n,n=i.p;delete t._i[i.i],i.r=!0,n&&(n.n=r),r&&(r.p=n),t._f==i&&(t._f=r),t._l==i&&(t._l=n),t[g]--}return!!i},forEach:function(e){l(this,u,"forEach");for(var t,r=o(e,arguments.length>1?arguments[1]:i,3);t=t?t.n:this._f;)for(r(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!v(this,e)}}),m&&n(u.prototype,"size",{get:function(){return d(this[g])}}),u},def:function(e,t,r){var n,a,s=v(e,t);return s?s.v=r:(e._l=s={i:a=f(t,!0),k:t,v:r,p:n=e._l,n:i,r:!1},e._f||(e._f=s),n&&(n.n=s),e[g]++,"F"!==a&&(e._i[a]=s)),e},getEntry:v,setStrong:function(e,t,r){c(e,t,(function(e,t){this._t=e,this._k=t,this._l=i}),(function(){for(var e=this,t=e._k,r=e._l;r&&r.r;)r=r.p;return e._t&&(e._l=r=r?r.n:e._t._f)?u(0,"keys"==t?r.k:"values"==t?r.v:[r.k,r.v]):(e._t=i,u(1))}),r?"entries":"values",!r,!0),p(t)}}},function(e,t,r){var n=r(2),a=r(6),s=r(16),o=r(202),l=r(20),d=r(198),h=r(197),c=r(11),u=r(5),p=r(157),m=r(22),f=r(80);e.exports=function(e,t,r,g,v,y){var M=n[e],E=M,x=v?"set":"add",_=E&&E.prototype,b={},I=function(e){var t=_[e];s(_,e,"delete"==e||"has"==e?function(e){return!(y&&!c(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return y&&!c(e)?i:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,i){return t.call(this,0===e?0:e,i),this})};if("function"==typeof E&&(y||_.forEach&&!u((function(){(new E).entries().next()})))){var T=new E,S=T[x](y?{}:-0,1)!=T,C=u((function(){T.has(1)})),w=p((function(e){new E(e)})),R=!y&&u((function(){for(var e=new E,t=5;t--;)e[x](t,t);return!e.has(-0)}));w||(E=t((function(t,r){h(t,E,e);var n=f(new M,t,E);return r!=i&&d(r,v,n[x],n),n})),E.prototype=_,_.constructor=E),(C||R)&&(I("delete"),I("has"),v&&I("get")),(R||S)&&I(x),y&&_.clear&&delete _.clear}else E=g.getConstructor(t,e,v,x),o(E.prototype,r),l.NEED=!0;return m(E,e),b[e]=E,a(a.G+a.W+a.F*(E!=M),b),y||g.setStrong(E,e,v),E}},function(e,t,r){var n=r(204);e.exports=r(205)("Set",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{add:function(e){return n.def(this,e=0===e?0:e,e)}},n)},function(e,t,r){var n,a=r(164)(0),s=r(16),o=r(20),l=r(67),d=r(208),h=r(11),c=o.getWeak,u=Object.isExtensible,p=d.ufstore,m={},f=function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},g={get:function(e){if(h(e)){var t=c(e);return!0===t?p(this).get(e):t?t[this._i]:i}},set:function(e,t){return d.def(this,e,t)}},v=e.exports=r(205)("WeakMap",f,g,d,!0,!0);7!=(new v).set((Object.freeze||Object)(m),7).get(m)&&(l((n=d.getConstructor(f)).prototype,g),o.NEED=!0,a(["delete","has","get","set"],(function(e){var t=v.prototype,i=t[e];s(t,e,(function(t,r){if(h(t)&&!u(t)){this._f||(this._f=new n);var a=this._f[e](t,r);return"set"==e?this:a}return i.call(this,t,r)}))})))},function(e,t,r){var n=r(202),a=r(20).getWeak,s=r(10),o=r(11),l=r(197),d=r(198),h=r(164),c=r(3),u=h(5),p=h(6),m=0,f=function(e){return e._l||(e._l=new g)},g=function(){this.a=[]},v=function(e,t){return u(e.a,(function(e){return e[0]===t}))};g.prototype={get:function(e){var t=v(this,e);if(t)return t[1]},has:function(e){return!!v(this,e)},set:function(e,t){var i=v(this,e);i?i[1]=t:this.a.push([e,t])},delete:function(e){var t=p(this.a,(function(t){return t[0]===e}));return~t&&this.a.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,r,s){var h=e((function(e,n){l(e,h,t,"_i"),e._i=m++,e._l=i,n!=i&&d(n,r,e[s],e)}));return n(h.prototype,{delete:function(e){if(!o(e))return!1;var t=a(e);return!0===t?f(this).delete(e):t&&c(t,this._i)&&delete t[this._i]},has:function(e){if(!o(e))return!1;var t=a(e);return!0===t?f(this).has(e):t&&c(t,this._i)}}),h},def:function(e,t,i){var r=a(s(t),!0);return!0===r?f(e).set(t,i):r[e._i]=i,e},ufstore:f}},function(e,t,r){var n=r(208);r(205)("WeakSet",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{add:function(e){return n.def(this,e,!0)}},n,!1,!0)},function(e,t,i){var r=i(6),n=i(19),a=i(10),s=(i(2).Reflect||{}).apply,o=Function.apply;r(r.S+r.F*!i(5)((function(){s((function(){}))})),"Reflect",{apply:function(e,t,i){var r=n(e),l=a(i);return s?s(r,t,l):o.call(r,t,l)}})},function(e,t,i){var r=i(6),n=i(44),a=i(19),s=i(10),o=i(11),l=i(5),d=i(75),h=(i(2).Reflect||{}).construct,c=l((function(){function e(){}return!(h((function(){}),[],e)instanceof e)})),u=!l((function(){h((function(){}))}));r(r.S+r.F*(c||u),"Reflect",{construct:function(e,t){a(e),s(t);var i=arguments.length<3?e:a(arguments[2]);if(u&&!c)return h(e,t,i);if(e==i){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(d.apply(e,r))}var l=i.prototype,p=n(o(l)?l:Object.prototype),m=Function.apply.call(e,p,t);return o(m)?m:p}})},function(e,t,i){var r=i(9),n=i(6),a=i(10),s=i(14);n(n.S+n.F*i(5)((function(){Reflect.defineProperty(r.f({},1,{value:1}),1,{value:2})})),"Reflect",{defineProperty:function(e,t,i){a(e),t=s(t,!0),a(i);try{return r.f(e,t,i),!0}catch(e){return!1}}})},function(e,t,i){var r=i(6),n=i(49).f,a=i(10);r(r.S,"Reflect",{deleteProperty:function(e,t){var i=n(a(e),t);return!(i&&!i.configurable)&&delete e[t]}})},function(e,t,r){var n=r(6),a=r(10),s=function(e){this._t=a(e),this._i=0;var t,i=this._k=[];for(t in e)i.push(t)};r(136)(s,"Object",(function(){var e,t=this,r=t._k;do{if(t._i>=r.length)return{value:i,done:!0}}while(!((e=r[t._i++])in t._t));return{value:e,done:!1}})),n(n.S,"Reflect",{enumerate:function(e){return new s(e)}})},function(e,t,r){var n=r(49),a=r(57),s=r(3),o=r(6),l=r(11),d=r(10);o(o.S,"Reflect",{get:function e(t,r){var o,h,c=arguments.length<3?t:arguments[2];return d(t)===c?t[r]:(o=n.f(t,r))?s(o,"value")?o.value:o.get!==i?o.get.call(c):i:l(h=a(t))?e(h,r,c):void 0}})},function(e,t,i){var r=i(49),n=i(6),a=i(10);n(n.S,"Reflect",{getOwnPropertyDescriptor:function(e,t){return r.f(a(e),t)}})},function(e,t,i){var r=i(6),n=i(57),a=i(10);r(r.S,"Reflect",{getPrototypeOf:function(e){return n(a(e))}})},function(e,t,i){var r=i(6);r(r.S,"Reflect",{has:function(e,t){return t in e}})},function(e,t,i){var r=i(6),n=i(10),a=Object.isExtensible;r(r.S,"Reflect",{isExtensible:function(e){return n(e),!a||a(e)}})},function(e,t,i){var r=i(6);r(r.S,"Reflect",{ownKeys:i(221)})},function(e,t,i){var r=i(48),n=i(41),a=i(10),s=i(2).Reflect;e.exports=s&&s.ownKeys||function(e){var t=r.f(a(e)),i=n.f;return i?t.concat(i(e)):t}},function(e,t,i){var r=i(6),n=i(10),a=Object.preventExtensions;r(r.S,"Reflect",{preventExtensions:function(e){n(e);try{return a&&a(e),!0}catch(e){return!1}}})},function(e,t,r){var n=r(9),a=r(49),s=r(57),o=r(3),l=r(6),d=r(15),h=r(10),c=r(11);l(l.S,"Reflect",{set:function e(t,r,l){var u,p,m=arguments.length<4?t:arguments[3],f=a.f(h(t),r);if(!f){if(c(p=s(t)))return e(p,r,l,m);f=d(0)}return o(f,"value")?!(!1===f.writable||!c(m)||(u=a.f(m,r)||d(0),u.value=l,n.f(m,r,u),0)):f.set!==i&&(f.set.call(m,l),!0)}})},function(e,t,i){var r=i(6),n=i(71);n&&r(r.S,"Reflect",{setPrototypeOf:function(e,t){n.check(e,t);try{return n.set(e,t),!0}catch(e){return!1}}})},function(e,t,i){var r=i(6);r(r.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,i){var r=i(6),n=i(56),a=i(14);r(r.P+r.F*i(5)((function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})})),"Date",{toJSON:function(e){var t=n(this),i=a(t);return"number"!=typeof i||isFinite(i)?t.toISOString():null}})},function(e,t,i){var r=i(6),n=i(5),a=Date.prototype.getTime,s=function(e){return e>9?e:"0"+e};r(r.P+r.F*(n((function(){return"0385-07-25T07:06:39.999Z"!=new Date(-50000000000001).toISOString()}))||!n((function(){new Date(NaN).toISOString()}))),"Date",{toISOString:function(){if(!isFinite(a.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),i=e.getUTCMilliseconds(),r=t<0?"-":t>9999?"+":"";return r+("00000"+Math.abs(t)).slice(r?-6:-4)+"-"+s(e.getUTCMonth()+1)+"-"+s(e.getUTCDate())+"T"+s(e.getUTCHours())+":"+s(e.getUTCMinutes())+":"+s(e.getUTCSeconds())+"."+(i>99?i:"0"+s(i))+"Z"}})},function(e,t,i){var r=Date.prototype,n="Invalid Date",a="toString",s=r[a],o=r.getTime;new Date(NaN)+""!=n&&i(16)(r,a,(function(){var e=o.call(this);return e==e?s.call(this):n}))},function(e,t,i){var r=i(23)("toPrimitive"),n=Date.prototype;r in n||i(8)(n,r,i(230))},function(e,t,i){var r=i(10),n=i(14),a="number";e.exports=function(e){if("string"!==e&&e!==a&&"default"!==e)throw TypeError("Incorrect hint");return n(r(this),e!=a)}},function(e,t,r){var n=r(6),a=r(232),s=r(233),o=r(10),l=r(37),d=r(35),h=r(11),c=r(2).ArrayBuffer,u=r(199),p=s.ArrayBuffer,m=s.DataView,f=a.ABV&&c.isView,g=p.prototype.slice,v=a.VIEW,y="ArrayBuffer";n(n.G+n.W+n.F*(c!==p),{ArrayBuffer:p}),n(n.S+n.F*!a.CONSTR,y,{isView:function(e){return f&&f(e)||h(e)&&v in e}}),n(n.P+n.U+n.F*r(5)((function(){return!new p(2).slice(1,i).byteLength})),y,{slice:function(e,t){if(g!==i&&t===i)return g.call(o(this),e);for(var r=o(this).byteLength,n=l(e,r),a=l(t===i?r:t,r),s=new(u(this,p))(d(a-n)),h=new m(this),c=new m(s),f=0;n<a;)c.setUint8(f++,h.getUint8(n++));return s}}),r(186)(y)},function(e,t,i){for(var r,n=i(2),a=i(8),s=i(17),o=s("typed_array"),l=s("view"),d=!(!n.ArrayBuffer||!n.DataView),h=d,c=0,u="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");c<9;)(r=n[u[c++]])?(a(r.prototype,o,!0),a(r.prototype,l,!0)):h=!1;e.exports={ABV:d,CONSTR:h,TYPED:o,VIEW:l}},function(e,t,r){var n=r(2),a=r(4),s=r(26),o=r(232),l=r(8),d=r(202),h=r(5),c=r(197),u=r(36),p=r(35),m=r(48).f,f=r(9).f,g=r(180),v=r(22),y="ArrayBuffer",M="DataView",E="prototype",x="Wrong length!",_="Wrong index!",b=n[y],I=n[M],T=n.Math,S=n.RangeError,C=n.Infinity,w=b,R=T.abs,B=T.pow,A=T.floor,P=T.log,L=T.LN2,O="buffer",D="byteLength",N="byteOffset",H=a?"_b":O,U=a?"_l":D,F=a?"_o":N,k=function(e,t,i){var r,n,a,s=Array(i),o=8*i-t-1,l=(1<<o)-1,d=l>>1,h=23===t?B(2,-24)-B(2,-77):0,c=0,u=e<0||0===e&&1/e<0?1:0;for((e=R(e))!=e||e===C?(n=e!=e?1:0,r=l):(r=A(P(e)/L),e*(a=B(2,-r))<1&&(r--,a*=2),(e+=r+d>=1?h/a:h*B(2,1-d))*a>=2&&(r++,a/=2),r+d>=l?(n=0,r=l):r+d>=1?(n=(e*a-1)*B(2,t),r+=d):(n=e*B(2,d-1)*B(2,t),r=0));t>=8;s[c++]=255&n,n/=256,t-=8);for(r=r<<t|n,o+=t;o>0;s[c++]=255&r,r/=256,o-=8);return s[--c]|=128*u,s},G=function(e,t,i){var r,n=8*i-t-1,a=(1<<n)-1,s=a>>1,o=n-7,l=i-1,d=e[l--],h=127&d;for(d>>=7;o>0;h=256*h+e[l],l--,o-=8);for(r=h&(1<<-o)-1,h>>=-o,o+=t;o>0;r=256*r+e[l],l--,o-=8);if(0===h)h=1-s;else{if(h===a)return r?NaN:d?-C:C;r+=B(2,t),h-=s}return(d?-1:1)*r*B(2,h-t)},V=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},z=function(e){return[255&e]},j=function(e){return[255&e,e>>8&255]},W=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},q=function(e){return k(e,52,8)},X=function(e){return k(e,23,4)},Y=function(e,t,i){f(e[E],t,{get:function(){return this[i]}})},K=function(e,t,i,r){var n=+i,a=u(n);if(n!=a||a<0||a+t>e[U])throw S(_);var s=e[H]._b,o=a+e[F],l=s.slice(o,o+t);return r?l:l.reverse()},Z=function(e,t,i,r,n,a){var s=+i,o=u(s);if(s!=o||o<0||o+t>e[U])throw S(_);for(var l=e[H]._b,d=o+e[F],h=r(+n),c=0;c<t;c++)l[d+c]=h[a?c:t-c-1]},Q=function(e,t){c(e,b,y);var i=+t,r=p(i);if(i!=r)throw S(x);return r};if(o.ABV){if(!h((function(){new b}))||!h((function(){new b(.5)}))){b=function(e){return new w(Q(this,e))};for(var J,$=b[E]=w[E],ee=m(w),te=0;ee.length>te;)(J=ee[te++])in b||l(b,J,w[J]);s||($.constructor=b)}var ie=new I(new b(2)),re=I[E].setInt8;ie.setInt8(0,2147483648),ie.setInt8(1,2147483649),!ie.getInt8(0)&&ie.getInt8(1)||d(I[E],{setInt8:function(e,t){re.call(this,e,t<<24>>24)},setUint8:function(e,t){re.call(this,e,t<<24>>24)}},!0)}else b=function(e){var t=Q(this,e);this._b=g.call(Array(t),0),this[U]=t},I=function(e,t,r){c(this,I,M),c(e,b,M);var n=e[U],a=u(t);if(a<0||a>n)throw S("Wrong offset!");if(a+(r=r===i?n-a:p(r))>n)throw S(x);this[H]=e,this[F]=a,this[U]=r},a&&(Y(b,D,"_l"),Y(I,O,"_b"),Y(I,D,"_l"),Y(I,N,"_o")),d(I[E],{getInt8:function(e){return K(this,1,e)[0]<<24>>24},getUint8:function(e){return K(this,1,e)[0]},getInt16:function(e){var t=K(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=K(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return V(K(this,4,e,arguments[1]))},getUint32:function(e){return V(K(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return G(K(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return G(K(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){Z(this,1,e,z,t)},setUint8:function(e,t){Z(this,1,e,z,t)},setInt16:function(e,t){Z(this,2,e,j,t,arguments[2])},setUint16:function(e,t){Z(this,2,e,j,t,arguments[2])},setInt32:function(e,t){Z(this,4,e,W,t,arguments[2])},setUint32:function(e,t){Z(this,4,e,W,t,arguments[2])},setFloat32:function(e,t){Z(this,4,e,X,t,arguments[2])},setFloat64:function(e,t){Z(this,8,e,q,t,arguments[2])}});v(b,y),v(I,M),l(I[E],o.VIEW,!0),t[y]=b,t[M]=I},function(e,t,i){var r=i(6);r(r.G+r.W+r.F*!i(232).ABV,{DataView:i(233).DataView})},function(e,t,i){i(236)("Int8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,r){if(r(4)){var n=r(26),a=r(2),s=r(5),o=r(6),l=r(232),d=r(233),h=r(18),c=r(197),u=r(15),p=r(8),m=r(202),f=r(36),g=r(35),v=r(37),y=r(14),M=r(3),E=r(69),x=r(73),_=r(11),b=r(56),I=r(154),T=r(44),S=r(57),C=r(48).f,w=r(156),R=r(17),B=r(23),A=r(164),P=r(34),L=r(199),O=r(183),D=r(135),N=r(157),H=r(186),U=r(180),F=r(177),k=r(9),G=r(49),V=k.f,z=G.f,j=a.RangeError,W=a.TypeError,q=a.Uint8Array,X="ArrayBuffer",Y="Shared"+X,K="BYTES_PER_ELEMENT",Z="prototype",Q=Array[Z],J=d.ArrayBuffer,$=d.DataView,ee=A(0),te=A(2),ie=A(3),re=A(4),ne=A(5),ae=A(6),se=P(!0),oe=P(!1),le=O.values,de=O.keys,he=O.entries,ce=Q.lastIndexOf,ue=Q.reduce,pe=Q.reduceRight,me=Q.join,fe=Q.sort,ge=Q.slice,ve=Q.toString,ye=Q.toLocaleString,Me=B("iterator"),Ee=B("toStringTag"),xe=R("typed_constructor"),_e=R("def_constructor"),be=l.CONSTR,Ie=l.TYPED,Te=l.VIEW,Se="Wrong length!",Ce=A(1,(function(e,t){return Le(L(e,e[_e]),t)})),we=s((function(){return 1===new q(new Uint16Array([1]).buffer)[0]})),Re=!!q&&!!q[Z].set&&s((function(){new q(1).set({})})),Be=function(e,t){if(e===i)throw W(Se);var r=+e,n=g(e);if(t&&!E(r,n))throw j(Se);return n},Ae=function(e,t){var i=f(e);if(i<0||i%t)throw j("Wrong offset!");return i},Pe=function(e){if(_(e)&&Ie in e)return e;throw W(e+" is not a typed array!")},Le=function(e,t){if(!_(e)||!(xe in e))throw W("It is not a typed array constructor!");return new e(t)},Oe=function(e,t){return De(L(e,e[_e]),t)},De=function(e,t){for(var i=0,r=t.length,n=Le(e,r);r>i;)n[i]=t[i++];return n},Ne=function(e,t,i){V(e,t,{get:function(){return this._d[i]}})},He=function(e){var t,r,n,a,s,o,l=b(e),d=arguments.length,c=d>1?arguments[1]:i,u=c!==i,p=w(l);if(p!=i&&!I(p)){for(o=p.call(l),n=[],t=0;!(s=o.next()).done;t++)n.push(s.value);l=n}for(u&&d>2&&(c=h(c,arguments[2],2)),t=0,r=g(l.length),a=Le(this,r);r>t;t++)a[t]=u?c(l[t],t):l[t];return a},Ue=function(){for(var e=0,t=arguments.length,i=Le(this,t);t>e;)i[e]=arguments[e++];return i},Fe=!!q&&s((function(){ye.call(new q(1))})),ke=function(){return ye.apply(Fe?ge.call(Pe(this)):Pe(this),arguments)},Ge={copyWithin:function(e,t){return F.call(Pe(this),e,t,arguments.length>2?arguments[2]:i)},every:function(e){return re(Pe(this),e,arguments.length>1?arguments[1]:i)},fill:function(e){return U.apply(Pe(this),arguments)},filter:function(e){return Oe(this,te(Pe(this),e,arguments.length>1?arguments[1]:i))},find:function(e){return ne(Pe(this),e,arguments.length>1?arguments[1]:i)},findIndex:function(e){return ae(Pe(this),e,arguments.length>1?arguments[1]:i)},forEach:function(e){ee(Pe(this),e,arguments.length>1?arguments[1]:i)},indexOf:function(e){return oe(Pe(this),e,arguments.length>1?arguments[1]:i)},includes:function(e){return se(Pe(this),e,arguments.length>1?arguments[1]:i)},join:function(e){return me.apply(Pe(this),arguments)},lastIndexOf:function(e){return ce.apply(Pe(this),arguments)},map:function(e){return Ce(Pe(this),e,arguments.length>1?arguments[1]:i)},reduce:function(e){return ue.apply(Pe(this),arguments)},reduceRight:function(e){return pe.apply(Pe(this),arguments)},reverse:function(){for(var e,t=this,i=Pe(t).length,r=Math.floor(i/2),n=0;n<r;)e=t[n],t[n++]=t[--i],t[i]=e;return t},some:function(e){return ie(Pe(this),e,arguments.length>1?arguments[1]:i)},sort:function(e){return fe.call(Pe(this),e)},subarray:function(e,t){var r=Pe(this),n=r.length,a=v(e,n);return new(L(r,r[_e]))(r.buffer,r.byteOffset+a*r.BYTES_PER_ELEMENT,g((t===i?n:v(t,n))-a))}},Ve=function(e,t){return Oe(this,ge.call(Pe(this),e,t))},ze=function(e){Pe(this);var t=Ae(arguments[1],1),i=this.length,r=b(e),n=g(r.length),a=0;if(n+t>i)throw j(Se);for(;a<n;)this[t+a]=r[a++]},je={entries:function(){return he.call(Pe(this))},keys:function(){return de.call(Pe(this))},values:function(){return le.call(Pe(this))}},We=function(e,t){return _(e)&&e[Ie]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},qe=function(e,t){return We(e,t=y(t,!0))?u(2,e[t]):z(e,t)},Xe=function(e,t,i){return!(We(e,t=y(t,!0))&&_(i)&&M(i,"value"))||M(i,"get")||M(i,"set")||i.configurable||M(i,"writable")&&!i.writable||M(i,"enumerable")&&!i.enumerable?V(e,t,i):(e[t]=i.value,e)};be||(G.f=qe,k.f=Xe),o(o.S+o.F*!be,"Object",{getOwnPropertyDescriptor:qe,defineProperty:Xe}),s((function(){ve.call({})}))&&(ve=ye=function(){return me.call(this)});var Ye=m({},Ge);m(Ye,je),p(Ye,Me,je.values),m(Ye,{slice:Ve,set:ze,constructor:function(){},toString:ve,toLocaleString:ke}),Ne(Ye,"buffer","b"),Ne(Ye,"byteOffset","o"),Ne(Ye,"byteLength","l"),Ne(Ye,"length","e"),V(Ye,Ee,{get:function(){return this[Ie]}}),e.exports=function(e,t,r,d){var h=e+((d=!!d)?"Clamped":"")+"Array",u="Uint8Array"!=h,m="get"+e,f="set"+e,v=a[h],y=v||{},M=v&&S(v),E=!v||!l.ABV,b={},I=v&&v[Z],w=function(e,i){var r=e._d;return r.v[m](i*t+r.o,we)},R=function(e,i,r){var n=e._d;d&&(r=(r=Math.round(r))<0?0:r>255?255:255&r),n.v[f](i*t+n.o,r,we)},B=function(e,t){V(e,t,{get:function(){return w(this,t)},set:function(e){return R(this,t,e)},enumerable:!0})};E?(v=r((function(e,r,n,a){c(e,v,h,"_d");var s,o,l,d,u=0,m=0;if(_(r)){if(!(r instanceof J||(d=x(r))==X||d==Y))return Ie in r?De(v,r):He.call(v,r);s=r,m=Ae(n,t);var f=r.byteLength;if(a===i){if(f%t)throw j(Se);if((o=f-m)<0)throw j(Se)}else if((o=g(a)*t)+m>f)throw j(Se);l=o/t}else l=Be(r,!0),s=new J(o=l*t);for(p(e,"_d",{b:s,o:m,l:o,e:l,v:new $(s)});u<l;)B(e,u++)})),I=v[Z]=T(Ye),p(I,"constructor",v)):N((function(e){new v(null),new v(e)}),!0)||(v=r((function(e,r,n,a){var s;return c(e,v,h),_(r)?r instanceof J||(s=x(r))==X||s==Y?a!==i?new y(r,Ae(n,t),a):n!==i?new y(r,Ae(n,t)):new y(r):Ie in r?De(v,r):He.call(v,r):new y(Be(r,u))})),ee(M!==Function.prototype?C(y).concat(C(M)):C(y),(function(e){e in v||p(v,e,y[e])})),v[Z]=I,n||(I.constructor=v));var A=I[Me],P=!!A&&("values"==A.name||A.name==i),L=je.values;p(v,xe,!0),p(I,Ie,h),p(I,Te,!0),p(I,_e,v),(d?new v(1)[Ee]==h:Ee in I)||V(I,Ee,{get:function(){return h}}),b[h]=v,o(o.G+o.W+o.F*(v!=y),b),o(o.S,h,{BYTES_PER_ELEMENT:t,from:He,of:Ue}),K in I||p(I,K,t),o(o.P,h,Ge),H(h),o(o.P+o.F*Re,h,{set:ze}),o(o.P+o.F*!P,h,je),o(o.P+o.F*(I.toString!=ve),h,{toString:ve}),o(o.P+o.F*s((function(){new v(1).slice()})),h,{slice:Ve}),o(o.P+o.F*(s((function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()}))||!s((function(){I.toLocaleString.call([1,2])}))),h,{toLocaleString:ke}),D[h]=P?A:L,n||P||p(I,Me,L)}}else e.exports=function(){}},function(e,t,i){i(236)("Uint8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}),!0)},function(e,t,i){i(236)("Int16",2,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint16",2,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Int32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Float32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Float64",8,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,r){var n=r(6),a=r(34)(!0);n(n.P,"Array",{includes:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),r(178)("includes")},function(e,t,i){var r=i(6),n=i(125)(!0);r(r.P,"String",{at:function(e){return n(this,e)}})},function(e,t,r){var n=r(6),a=r(248);n(n.P,"String",{padStart:function(e){return a(this,e,arguments.length>1?arguments[1]:i,!0)}})},function(e,t,r){var n=r(35),a=r(85),s=r(33);e.exports=function(e,t,r,o){var l=String(s(e)),d=l.length,h=r===i?" ":String(r),c=n(t);if(c<=d||""==h)return l;var u=c-d,p=a.call(h,Math.ceil(u/h.length));return p.length>u&&(p=p.slice(0,u)),o?p+l:l+p}},function(e,t,r){var n=r(6),a=r(248);n(n.P,"String",{padEnd:function(e){return a(this,e,arguments.length>1?arguments[1]:i,!1)}})},function(e,t,i){i(81)("trimLeft",(function(e){return function(){return e(this,1)}}),"trimStart")},function(e,t,i){i(81)("trimRight",(function(e){return function(){return e(this,2)}}),"trimEnd")},function(e,t,i){var r=i(6),n=i(33),a=i(35),s=i(128),o=i(188),l=RegExp.prototype,d=function(e,t){this._r=e,this._s=t};i(136)(d,"RegExp String",(function(){var e=this._r.exec(this._s);return{value:e,done:null===e}})),r(r.P,"String",{matchAll:function(e){if(n(this),!s(e))throw TypeError(e+" is not a regexp!");var t=String(this),i="flags"in l?String(e.flags):o.call(e),r=new RegExp(e.source,~i.indexOf("g")?i:"g"+i);return r.lastIndex=a(e.lastIndex),new d(r,t)}})},function(e,t,i){i(25)("asyncIterator")},function(e,t,i){i(25)("observable")},function(e,t,i){var r=i(6),n=i(221),a=i(30),s=i(49),o=i(155);r(r.S,"Object",{getOwnPropertyDescriptors:function(e){for(var t,i=a(e),r=s.f,l=n(i),d={},h=0;l.length>h;)o(d,t=l[h++],r(i,t));return d}})},function(e,t,i){var r=i(6),n=i(257)(!1);r(r.S,"Object",{values:function(e){return n(e)}})},function(e,t,i){var r=i(28),n=i(30),a=i(42).f;e.exports=function(e){return function(t){for(var i,s=n(t),o=r(s),l=o.length,d=0,h=[];l>d;)a.call(s,i=o[d++])&&h.push(e?[i,s[i]]:s[i]);return h}}},function(e,t,i){var r=i(6),n=i(257)(!0);r(r.S,"Object",{entries:function(e){return n(e)}})},function(e,t,i){var r=i(6),n=i(56),a=i(19),s=i(9);i(4)&&r(r.P+i(260),"Object",{__defineGetter__:function(e,t){s.f(n(this),e,{get:a(t),enumerable:!0,configurable:!0})}})},function(e,t,i){e.exports=i(26)||!i(5)((function(){var e=Math.random();__defineSetter__.call(null,e,(function(){})),delete i(2)[e]}))},function(e,t,i){var r=i(6),n=i(56),a=i(19),s=i(9);i(4)&&r(r.P+i(260),"Object",{__defineSetter__:function(e,t){s.f(n(this),e,{set:a(t),enumerable:!0,configurable:!0})}})},function(e,t,i){var r=i(6),n=i(56),a=i(14),s=i(57),o=i(49).f;i(4)&&r(r.P+i(260),"Object",{__lookupGetter__:function(e){var t,i=n(this),r=a(e,!0);do{if(t=o(i,r))return t.get}while(i=s(i))}})},function(e,t,i){var r=i(6),n=i(56),a=i(14),s=i(57),o=i(49).f;i(4)&&r(r.P+i(260),"Object",{__lookupSetter__:function(e){var t,i=n(this),r=a(e,!0);do{if(t=o(i,r))return t.set}while(i=s(i))}})},function(e,t,i){var r=i(6);r(r.P+r.R,"Map",{toJSON:i(265)("Map")})},function(e,t,i){var r=i(73),n=i(266);e.exports=function(e){return function(){if(r(this)!=e)throw TypeError(e+"#toJSON isn't generic");return n(this)}}},function(e,t,i){var r=i(198);e.exports=function(e,t){var i=[];return r(e,!1,i.push,i,t),i}},function(e,t,i){var r=i(6);r(r.P+r.R,"Set",{toJSON:i(265)("Set")})},function(e,t,i){var r=i(6);r(r.S,"System",{global:i(2)})},function(e,t,i){var r=i(6),n=i(32);r(r.S,"Error",{isError:function(e){return"Error"===n(e)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{iaddh:function(e,t,i,r){var n=e>>>0,a=i>>>0;return(t>>>0)+(r>>>0)+((n&a|(n|a)&~(n+a>>>0))>>>31)|0}})},function(e,t,i){var r=i(6);r(r.S,"Math",{isubh:function(e,t,i,r){var n=e>>>0,a=i>>>0;return(t>>>0)-(r>>>0)-((~n&a|~(n^a)&n-a>>>0)>>>31)|0}})},function(e,t,i){var r=i(6);r(r.S,"Math",{imulh:function(e,t){var i=65535,r=+e,n=+t,a=r&i,s=n&i,o=r>>16,l=n>>16,d=(o*s>>>0)+(a*s>>>16);return o*l+(d>>16)+((a*l>>>0)+(d&i)>>16)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{umulh:function(e,t){var i=65535,r=+e,n=+t,a=r&i,s=n&i,o=r>>>16,l=n>>>16,d=(o*s>>>0)+(a*s>>>16);return o*l+(d>>>16)+((a*l>>>0)+(d&i)>>>16)}})},function(e,t,i){var r=i(275),n=i(10),a=r.key,s=r.set;r.exp({defineMetadata:function(e,t,i,r){s(e,t,n(i),a(r))}})},function(e,t,r){var n=r(203),a=r(6),s=r(21)("metadata"),o=s.store||(s.store=new(r(207))),l=function(e,t,r){var a=o.get(e);if(!a){if(!r)return i;o.set(e,a=new n)}var s=a.get(t);if(!s){if(!r)return i;a.set(t,s=new n)}return s};e.exports={store:o,map:l,has:function(e,t,r){var n=l(t,r,!1);return n!==i&&n.has(e)},get:function(e,t,r){var n=l(t,r,!1);return n===i?i:n.get(e)},set:function(e,t,i,r){l(i,r,!0).set(e,t)},keys:function(e,t){var i=l(e,t,!1),r=[];return i&&i.forEach((function(e,t){r.push(t)})),r},key:function(e){return e===i||"symbol"==typeof e?e:String(e)},exp:function(e){a(a.S,"Reflect",e)}}},function(e,t,r){var n=r(275),a=r(10),s=n.key,o=n.map,l=n.store;n.exp({deleteMetadata:function(e,t){var r=arguments.length<3?i:s(arguments[2]),n=o(a(t),r,!1);if(n===i||!n.delete(e))return!1;if(n.size)return!0;var d=l.get(t);return d.delete(r),!!d.size||l.delete(t)}})},function(e,t,r){var n=r(275),a=r(10),s=r(57),o=n.has,l=n.get,d=n.key,h=function(e,t,r){if(o(e,t,r))return l(e,t,r);var n=s(t);return null!==n?h(e,n,r):i};n.exp({getMetadata:function(e,t){return h(e,a(t),arguments.length<3?i:d(arguments[2]))}})},function(e,t,r){var n=r(206),a=r(266),s=r(275),o=r(10),l=r(57),d=s.keys,h=s.key,c=function(e,t){var i=d(e,t),r=l(e);if(null===r)return i;var s=c(r,t);return s.length?i.length?a(new n(i.concat(s))):s:i};s.exp({getMetadataKeys:function(e){return c(o(e),arguments.length<2?i:h(arguments[1]))}})},function(e,t,r){var n=r(275),a=r(10),s=n.get,o=n.key;n.exp({getOwnMetadata:function(e,t){return s(e,a(t),arguments.length<3?i:o(arguments[2]))}})},function(e,t,r){var n=r(275),a=r(10),s=n.keys,o=n.key;n.exp({getOwnMetadataKeys:function(e){return s(a(e),arguments.length<2?i:o(arguments[1]))}})},function(e,t,r){var n=r(275),a=r(10),s=r(57),o=n.has,l=n.key,d=function(e,t,i){if(o(e,t,i))return!0;var r=s(t);return null!==r&&d(e,r,i)};n.exp({hasMetadata:function(e,t){return d(e,a(t),arguments.length<3?i:l(arguments[2]))}})},function(e,t,r){var n=r(275),a=r(10),s=n.has,o=n.key;n.exp({hasOwnMetadata:function(e,t){return s(e,a(t),arguments.length<3?i:o(arguments[2]))}})},function(e,t,r){var n=r(275),a=r(10),s=r(19),o=n.key,l=n.set;n.exp({metadata:function(e,t){return function(r,n){l(e,t,(n!==i?a:s)(r),o(n))}}})},function(e,t,i){var r=i(6),n=i(201)(),a=i(2).process,s="process"==i(32)(a);r(r.G,{asap:function(e){var t=s&&a.domain;n(t?t.bind(e):e)}})},function(e,t,r){var n=r(6),a=r(2),s=r(7),o=r(201)(),l=r(23)("observable"),d=r(19),h=r(10),c=r(197),u=r(202),p=r(8),m=r(198),f=m.RETURN,g=function(e){return null==e?i:d(e)},v=function(e){var t=e._c;t&&(e._c=i,t())},y=function(e){return e._o===i},M=function(e){y(e)||(e._o=i,v(e))},E=function(e,t){h(e),this._c=i,this._o=e,e=new x(this);try{var r=t(e),n=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){n.unsubscribe()}:d(r),this._c=r)}catch(t){return void e.error(t)}y(this)&&v(this)};E.prototype=u({},{unsubscribe:function(){M(this)}});var x=function(e){this._s=e};x.prototype=u({},{next:function(e){var t=this._s;if(!y(t)){var i=t._o;try{var r=g(i.next);if(r)return r.call(i,e)}catch(e){try{M(t)}finally{throw e}}}},error:function(e){var t=this._s;if(y(t))throw e;var r=t._o;t._o=i;try{var n=g(r.error);if(!n)throw e;e=n.call(r,e)}catch(e){try{v(t)}finally{throw e}}return v(t),e},complete:function(e){var t=this._s;if(!y(t)){var r=t._o;t._o=i;try{var n=g(r.complete);e=n?n.call(r,e):i}catch(e){try{v(t)}finally{throw e}}return v(t),e}}});var _=function(e){c(this,_,"Observable","_f")._f=d(e)};u(_.prototype,{subscribe:function(e){return new E(e,this._f)},forEach:function(e){var t=this;return new(s.Promise||a.Promise)((function(i,r){d(e);var n=t.subscribe({next:function(t){try{return e(t)}catch(e){r(e),n.unsubscribe()}},error:r,complete:i})}))}}),u(_,{from:function(e){var t="function"==typeof this?this:_,i=g(h(e)[l]);if(i){var r=h(i.call(e));return r.constructor===t?r:new t((function(e){return r.subscribe(e)}))}return new t((function(t){var i=!1;return o((function(){if(!i){try{if(m(e,!1,(function(e){if(t.next(e),i)return f}))===f)return}catch(e){if(i)throw e;return void t.error(e)}t.complete()}})),function(){i=!0}}))},of:function(){for(var e=0,t=arguments.length,i=Array(t);e<t;)i[e]=arguments[e++];return new("function"==typeof this?this:_)((function(e){var t=!1;return o((function(){if(!t){for(var r=0;r<i.length;++r)if(e.next(i[r]),t)return;e.complete()}})),function(){t=!0}}))}}),p(_.prototype,l,(function(){return this})),n(n.G,{Observable:_}),r(186)("Observable")},function(e,t,i){var r=i(6),n=i(200);r(r.G+r.B,{setImmediate:n.set,clearImmediate:n.clear})},function(e,t,i){for(var r=i(183),n=i(16),a=i(2),s=i(8),o=i(135),l=i(23),d=l("iterator"),h=l("toStringTag"),c=o.Array,u=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],p=0;p<5;p++){var m,f=u[p],g=a[f],v=g&&g.prototype;if(v)for(m in v[d]||s(v,d,c),v[h]||s(v,h,f),o[f]=c,r)v[m]||n(v,m,r[m],!0)}},function(e,t,i){var r=i(2),n=i(6),a=i(76),s=i(289),o=r.navigator,l=!!o&&/MSIE .\./.test(o.userAgent),d=function(e){return l?function(t,i){return e(a(s,[].slice.call(arguments,2),"function"==typeof t?t:Function(t)),i)}:e};n(n.G+n.B+n.F*l,{setTimeout:d(r.setTimeout),setInterval:d(r.setInterval)})},function(e,t,i){var r=i(290),n=i(76),a=i(19);e.exports=function(){for(var e=a(this),t=arguments.length,i=Array(t),s=0,o=r._,l=!1;t>s;)(i[s]=arguments[s++])===o&&(l=!0);return function(){var r,a=this,s=arguments.length,d=0,h=0;if(!l&&!s)return n(e,i,a);if(r=i.slice(),l)for(;t>d;d++)r[d]===o&&(r[d]=arguments[h++]);for(;s>h;)r.push(arguments[h++]);return n(e,r,a)}}},function(e,t,i){e.exports=i(2)},function(e,t,r){function n(e){var t=d(null);return e!=i&&(g(e)?f(e,!0,(function(e,i){t[e]=i})):l(t,e)),t}var a=r(18),s=r(6),o=r(15),l=r(67),d=r(44),h=r(57),c=r(28),u=r(9),p=r(27),m=r(19),f=r(198),g=r(292),v=r(136),y=r(184),M=r(11),E=r(30),x=r(4),_=r(3),b=function(e){var t=1==e,r=4==e;return function(s,o,l){var d,h,c,u=a(o,l,3),p=E(s),m=t||7==e||2==e?new("function"==typeof this?this:n):i;for(d in p)if(_(p,d)&&(c=u(h=p[d],d,s),e))if(t)m[d]=c;else if(c)switch(e){case 2:m[d]=h;break;case 3:return!0;case 5:return h;case 6:return d;case 7:m[c[0]]=c[1]}else if(r)return!1;return 3==e||r?r:m}},I=b(6),T=function(e){return function(t){return new S(t,e)}},S=function(e,t){this._t=E(e),this._a=c(e),this._i=0,this._k=t};v(S,"Dict",(function(){var e,t=this,r=t._t,n=t._a,a=t._k;do{if(t._i>=n.length)return t._t=i,y(1)}while(!_(r,e=n[t._i++]));return y(0,"keys"==a?e:"values"==a?r[e]:[e,r[e]])})),n.prototype=null,s(s.G+s.F,{Dict:n}),s(s.S,"Dict",{keys:T("keys"),values:T("values"),entries:T("entries"),forEach:b(0),map:b(1),filter:b(2),some:b(3),every:b(4),find:b(5),findKey:I,mapPairs:b(7),reduce:function(e,t,i){m(t);var r,n,a=E(e),s=c(a),o=s.length,l=0;if(arguments.length<3){if(!o)throw TypeError("Reduce of empty object with no initial value");r=a[s[l++]]}else r=Object(i);for(;o>l;)_(a,n=s[l++])&&(r=t(r,a[n],n,e));return r},keyOf:p,includes:function(e,t){return(t==t?p(e,t):I(e,(function(e){return e!=e})))!==i},has:_,get:function(e,t){if(_(e,t))return e[t]},set:function(e,t,i){return x&&t in Object?u.f(e,t,o(0,i)):e[t]=i,e},isDict:function(e){return M(e)&&h(e)===n.prototype}})},function(e,t,r){var n=r(73),a=r(23)("iterator"),s=r(135);e.exports=r(7).isIterable=function(e){var t=Object(e);return t[a]!==i||"@@iterator"in t||s.hasOwnProperty(n(t))}},function(e,t,i){var r=i(10),n=i(156);e.exports=i(7).getIterator=function(e){var t=n(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return r(t.call(e))}},function(e,t,i){var r=i(2),n=i(7),a=i(6),s=i(289);a(a.G+a.F,{delay:function(e){return new(n.Promise||r.Promise)((function(t){setTimeout(s.call(t,!0),e)}))}})},function(e,t,i){var r=i(290),n=i(6);i(7)._=r._=r._||{},n(n.P+n.F,"Function",{part:i(289)})},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{isObject:i(11)})},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{classof:i(73)})},function(e,t,i){var r=i(6),n=i(299);r(r.S+r.F,"Object",{define:n})},function(e,t,i){var r=i(9),n=i(49),a=i(221),s=i(30);e.exports=function(e,t){for(var i,o=a(s(t)),l=o.length,d=0;l>d;)r.f(e,i=o[d++],n.f(t,i));return e}},function(e,t,i){var r=i(6),n=i(299),a=i(44);r(r.S+r.F,"Object",{make:function(e,t){return n(a(e),t)}})},function(e,t,r){r(134)(Number,"Number",(function(e){this._l=+e,this._i=0}),(function(){var e=this._i++,t=!(e<this._l);return{done:t,value:t?i:e}}))},function(e,t,i){var r=i(6),n=i(303)(/[\\^$*+?.()|[\]{}]/g,"\\$&");r(r.S,"RegExp",{escape:function(e){return n(e)}})},function(e,t){e.exports=function(e,t){var i=t===Object(t)?function(e){return t[e]}:t;return function(t){return String(t).replace(e,i)}}},function(e,t,i){var r=i(6),n=i(303)(/[&<>"']/g,{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"});r(r.P+r.F,"String",{escapeHTML:function(){return n(this)}})},function(e,t,i){var r=i(6),n=i(303)(/&(?:amp|lt|gt|quot|apos);/g,{"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"});r(r.P+r.F,"String",{unescapeHTML:function(){return n(this)}})}]),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define((function(){return e})):t.core=e;r.CollisionManager=class{constructor(){this.condition=[{categoryId:"-2000011"}],this.conditionIds=[],this.originCondition=[{categoryId:"-2000011"}],this.distance=15,this.unselected=!1,this.selectAll=!1,this.selectNone=!1}setCondition(e){this.unselected=!1,this.selectAll=!1,this.selectNone=!1,this.originCondition=e,this.condition=[],this.conditionIds=[],e instanceof Array?this.condition=e:e instanceof Object&&(r.Utils.defined(e.all)&&!0===e.all&&(this.selectAll=!0),r.Utils.defined(e.inSelection)&&!1===e.inSelection&&(this.unselected=!0,this.selectAll&&(this.selectNone=!0,this.selectAll=!1,this.unselected=!1)),e.objectData&&(this.condition=e.objectData),e.objectIds&&(this.conditionIds=e.objectIds))}getCondition(){return this.originCondition}getDistance(){return this.distance}setDistance(e){this.distance=e}matchConditions(e,t){var i=this.condition,r=this.conditionIds;if(this.selectAll)return!0;if(this.selectNone)return!1;if(0==i.length&&0==r.length)return!!this.unselected;var n=!0;0==i.length&&(n=!1);for(var a=0,s=i.length;a<s;a++){var o=i[a];for(var l in o)if(!e.hasOwnProperty(l)||e[l]!=o[l]){n=!1;break}if(1==n)break;a<i.length-1&&(n=!0)}return!n&&r.length>0&&r.indexOf(t)>-1&&(n=!0),this.unselected&&(n=!n),n}hasCollision(e,t,i){if(!e)return!1;var r=this.matchConditions(e,t),n=i<=this.distance;return!(!r||!n)}},function(){let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector2,n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Plane,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=!1,c=new THREE.Vector3,u=new THREE.Matrix4;r.UserInputHelper=class{constructor(e,t){this.camera=e.camera,this.cameraControl=e,this.domElement=t,this.intersectContext=new r.IntersectContext,this.rayCaster=new r.Raycaster,this._lastTrackingPoint=new THREE.Vector3,this.viewer=e.viewer,this._rotatePivot=new THREE.Vector3,this.pivot=null,this._assistGroundPlane=new r.Ground,this.boundaryLimitFactor=2,this._planIntersect=new THREE.Vector3,this.intersectHelper=e.intersector,this._minObjectOffset=.5,this.isThroughWall=!1,this.throughWallDistance=new THREE.Vector3,this.throughWallTime=1e3,this._minDistance=-1,this._minimumDistanceForSpeed=5}getWorldDimension(t,i,n){var s=this.camera.position,o=this.camera.direction(a).normalize(),l=this.getTrackingPoint(t,i,!0),d=e.subVectors(l,s),h=Math.abs(o.dot(d)),c=r.DomUtil.getContainerOffsetToClient(this.domElement),u=c.width/c.height,p=2*h*Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),m=p*u;return r.Utils.isDefined(n)||(console.warn("result is needed for function UserInputHelper.getWorldDimension()"),n=new THREE.Vector2),n.set(m,p),n}getTrackingPoint(t,i,n){e.set(t,i),this.getIntersectContext(e);let o=null;if(o=!0===n&&r.GlobalData.ZoomHitByBox?this.intersectHelper.hitTestByBox(this.intersectContext):this.intersectHelper.hitTest(this.intersectContext),o)this._lastTrackingPoint.copy(o),h=!0;else{const e=this.getRayCaster(t,i).ray;if(h){const t=this.camera.direction(a).normalize();if(s.setFromNormalAndCoplanarPoint(t,this._lastTrackingPoint),o=e.intersectPlane(s,this._planIntersect),o){const t=this.camera.position;o.distanceTo(t)<r.Math.EPSILON1&&(o=this._getTrackingPointFromScene(e),h=!1)}else o=this._getTrackingPointFromScene(e),h=!1}else o=this._getTrackingPointFromScene(e)}return o}getRotatePivot(t,i){var n=null;let a=this.viewer.getRotationCenter();if(r.Utils.isDefined(a))return a;switch(t){case r.RotatePivotMode.SELECTION:n=this._getRotatePivotFromSelection(i,this._rotatePivot);break;case r.RotatePivotMode.CENTER:n=this.viewer.getScene().getBoundingBox().getCenter(e);break;case r.RotatePivotMode.CAMERA:n=null;break;default:n=this._getRotatePivotFromIntersect(i)}return this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),this.pivot=n,n}getPanOffset(e,t,i,n){var a=r.DomUtil.getContainerOffsetToClient(this.domElement),s=e.x-a.left,h=e.y-a.top;o.x=s/a.width,o.y=h/a.height,s=t.x-a.left,h=t.y-a.top,l.x=s/a.width,l.y=h/a.height,d.subVectors(l,o);var c=-d.x*i.x,u=d.y*i.y,p=this.cameraControl.getWorldRight().multiplyScalar(c),m=this.cameraControl.getWorldUp().multiplyScalar(u);return this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),n.addVectors(p,m),n}adjustCameraForPan(t){if(!this.lockPan){var i=this.camera;if(e.copy(i.position),e.add(t),!(null!=i.minimumElevation&&t.y<0&&e.y<i.minimumElevation)){if(this._limitWorldScalar&&this.cameraControl._checkZoomNearBoundary(e,-1)){if(e.x<0&&t.x<0||e.z<0&&t.z<0)return;if(e.x>0&&t.x>0||e.z>0&&t.z>0)return}this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),i.target.add(t),i.position.add(t)}}}adjustCameraForZoom(i,n){if(Math.abs(i)<r.Math.EPSILON6)return!1;const s=this.camera,o=s.position,l=s.direction(a);if(n?t.subVectors(n,o):t.copy(l),e.copy(t),t.multiplyScalar(i),s.isPerspective){e.length();const r=this.viewer.modelManager.isMeterUnit()?1:.001;var d=this.viewer.getScene().getRawMatrixGlobal();u.copy(d).invert(),e.applyMatrix4(u);const n=e.length()*(1-i)*r;let a=this._minObjectOffset;this.viewer.getBoundingBoxWorld().getSize(e);const s=e.length(),o=this.viewer.modelManager.isMeterUnit()?s:s/1e3;(this.viewer.modelManager.isMeterUnit()&&s<1||!this.viewer.modelManager.isMeterUnit()&&s<1e3)&&(a=s/1e3),n<=this._minimumDistanceForSpeed&&(o>1?(this._minDistance<0&&(e.setLength(this._minimumDistanceForSpeed/((1-i)*r)),e.applyMatrix4(d),t.setLength(e.length()*i),this._minDistance=t.length()),t.normalize().multiplyScalar(this._minDistance),this.cameraControl.setTrackPointChanging(!0)):(this._minDistance<0&&(this._minDistance=t.length()),t.normalize().multiplyScalar(this._minDistance),this.cameraControl.setTrackPointChanging(!0)))}else s.orthoScale*=i+1;s.zoom&&s.setZoom(s.zoom*(i+1)),t.add(o),r.Utils.isDefined(s.minimumElevation)&&t.y<s.minimumElevation||this._checkCameraLimitBoundary(s,t,i)||(s.position.copy(t),s.target.copy(l.add(t)),this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0))}clientToViewport(e,t,i){var n=r.DomUtil.getContainerOffsetToClient(this.domElement),a=i||new THREE.Vector2;return a.x=(e-n.left)/n.width*2-1,a.y=-(t-n.top)/n.height*2+1,a}viewportToClient(e,t,i){var n=r.DomUtil.getContainerOffsetToClient(this.domElement),a=i||new THREE.Vector2;return a.x=(e+1)/2*n.width+n.left,a.y=(1-t)/2*n.height+n.top,a}getIntersectContext(e){var t=this.viewer.modelManager;return this.intersectContext.scene=this.viewer.getScene(),this.intersectContext.camera=this.camera,r.Utils.isDefined(e)&&(this.clientToViewport(e.x,e.y,this.intersectContext.mouse),this.intersectContext.pointer={x:e.x,y:e.y}),this.intersectContext.viewportSize=this.viewer.getViewportSize(),this.intersectContext.octreeRoots=t.getOctreeRoots(),this.intersectContext.octantMap=t.getOctantMap(),this.intersectContext}getRayCaster(e,t){return this.clientToViewport(e,t,i),this.rayCaster.setFromCamera(i,this.camera),this.rayCaster}_getTrackingPointFromScene(t){let i=1/0;const r=t.origin,a=this.viewer.getScene().getBoundingBox();if(t.intersectBox(a,n))return n;e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,a.max);let o=0;return t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),e.set(0,-1,0),s.setFromNormalAndCoplanarPoint(e,a.max),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),e.set(-1,0,0),s.setFromNormalAndCoplanarPoint(e,a.max),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,a.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),e.set(0,-1,0),s.setFromNormalAndCoplanarPoint(e,a.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,a.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,n.copy(this._planIntersect))),n}getVisibleBox(e,t){const i=e.getFilter(),n=r.Math.EPSILON1;if(i._hasVisibleFilter()){if(r.Math.equalsEpsilon(t.min.x,t.max.x,n)||r.Math.equalsEpsilon(t.min.y,t.max.y,n)||r.Math.equalsEpsilon(t.min.z,t.max.z,n))return t;const a=i.getVisibleComponentsBbox();return a.applyMatrix4(e.getScene().getRawMatrixGlobal()),t&&a.intersectsBox(t)&&a.intersect(t),a}return t}_getRotatePivotFromIntersect(e,t){var i=this.getIntersectContext(e);let n;if(n=r.GlobalData.ZoomHitByBox?this.intersectHelper.hitTestByBox(i):this.intersectHelper.hitTest(i),e&&n)return n;if(t&&!t.isEmpty()){return this.getVisibleBox(this.viewer,t).getCenter(c),c}{const e=this.viewer.getScene().getBoundingBox();return this.getVisibleBox(this.viewer,e).getCenter(c)}}_getRotatePivotFromSelection(t,i){const n=this.viewer,a=n.getScene();let s=null;if(a.hasClipPlanes()){const e=r.ClipPlaneManager.getInstance(a);if(e.isEnabled()&&(s=e.getClipBoundingBox(),r.Utils.isDefined(s)&&!s.isEmpty())){if(n.editorManager.getToolByName("clipByBox").isReverse){const e=this.viewer.getScene().getBoundingBox(),t=this.getVisibleBox(n,e);let r=t.min.x,a=t.max.x,o=t.min.y,l=t.max.y,d=t.min.z,h=t.max.z,c=s.min.x,u=s.max.x,p=s.min.y,m=s.max.y,f=s.min.z,g=s.max.z,v=r,y=a;r>=c&&a<=u||c>=r&&u<=a||(r>=c?v=u:a<=u&&(y=c));let M=o,E=l;o>=p&&l<=m||p>=o&&m<=l||(o>=p?M=m:l<=m&&(E=p));let x=d,_=h;d>=f&&h<=g||f>=d&&g<=h||(d>=f?x=g:h<=g&&(_=f)),i.set(.5*(v+y),.5*(M+E),.5*(x+_))}else i.copy(s.getCenter(c))}}const o=n.getFilter().getVisibleComponentSetWithModelId(n.modelManager.sceneState.getSelectionSetWithModelId());let l=n.getBoundingBoxByIdsWithModelIdSet(o),d=null;if(!l||l.isEmpty()){if(s){var h=this.camera.position;const e=n.getScene();var u=e.getBoundingBox();return r.ClipPlaneManager.getInstance(e).visible&&!u.containsPoint(h)||(i=this._getRotatePivotFromIntersect(t)),i}if(a.hasFillClipPlanes()){const e=r.FillClipPlaneManager.getInstance(a),t=100;let i=Math.floor(Math.abs(e.rotation.x*t)),n=Math.floor(Math.abs(e.rotation.y*t)),s=Math.floor(Math.abs(e.rotation.z*t)),o=Math.floor(r.Math.PI_OVER_TWO*t);if(i%o==0&&n%o==0&&s%o==0){const t=e.getFillClipBoundingBox();r.Utils.isDefined(t)&&(d=t)}}i.copy(this._getRotatePivotFromIntersect(t,d))}else{const t=l.clone();if(r.Utils.isDefined(s))t.intersect(s);else if(a.hasFillClipPlanes()){const e=r.FillClipPlaneManager.getInstance(a);if(e.isEnabled()){const i=e.getFillClipBoundingBox();r.Utils.isDefined(i)&&t.intersect(i)}}t.isEmpty()||l.copy(t),i.copy(l.getCenter(e))}return i}_checkCameraLimitBoundary(t,i,n){if(!t.isPerspective||!r.GlobalData.ConstraintZoom)return!1;const a=this.viewer.getScene().getBoundingBox();if(r.Utils.isDefined(n)&&n>0)return!t.getFrustum().intersectsBox(a);const s=.5*a.getSize(e).length()/Math.tan(THREE.Math.degToRad(.5*t.fov))*this.boundaryLimitFactor,o=a.getCenter(e);return!(i.distanceTo(o)<s)}}}(),function(){const e=new THREE.Vector3(0,1,0);let t=new THREE.Vector3(0,0,1),i=new THREE.Vector3,n=new THREE.Quaternion,a=new THREE.Matrix4,s=new THREE.Vector3,o=new THREE.Quaternion,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Matrix4,u=new THREE.Matrix4,p=new THREE.Box3,m=new THREE.Box3,f=new THREE.Vector3;function g(e,t,i,r){a.copy(t).invert();var n=new THREE.Vector3(e.position.x,e.position.y,e.position.z),s=n.clone();s.applyMatrix4(a);var o=new THREE.Vector3(i.x,i.y,i.z);o.add(n),o.applyMatrix4(a),o.sub(s).normalize().multiplyScalar(r);var l=o.clone();return o.add(s),o.applyMatrix4(t),o.sub(n),{stepDiffWorld:l,stepDiffDrawing:o}}function v(e){if(e.viewer.getRotationCenter())return e.viewer.getRotationCenter();var t=e.viewer.modelManager.sceneState;if(t.hasSelection()){var i=e.viewer.getFilter().getVisibleComponentArray(t.getSelectionSet()),r=e.viewer.getBoundingBoxByIds(i);if(r&&!r.isEmpty())return r.getCenter(d)}return e.pivot?e.pivot:e.scene.getBoundingBox().getCenter(d)}function y(i,r,n,a){if(null==a||void 0===a)return!0;const s=a[0],o=a[1];var l=i.position;let d=new THREE.Vector3;i.getWorldDirection(d);var h=i.realUp||i.up,c=d.clone().cross(h).normalize(),u=(new THREE.Quaternion).setFromAxisAngle(c,r);l.clone().sub(n).normalize();var p=d.clone().negate(),m=p.angleTo(e.clone()),f=p.clone().projectOnPlane(e.clone()),g=f.angleTo(t.clone());f.x<0&&(g=2*Math.PI-g),d.applyQuaternion(u).normalize();var v=d.clone().negate(),y=v.angleTo(e.clone()),M=v.clone().projectOnPlane(e.clone()),E=M.angleTo(t.clone());if(M.x<0&&(E=2*Math.PI-E),Math.abs(E-g)>.001)return!1;if(m>s&&m<o){if(y>o||y<s)return!1}else if((m>o?y-m:m-y)>0)return!1;return!0}r.CameraControl=class{constructor(e,t,i,n,a,s){this.viewer=e,this.camera=i,this.domElement=n,this.scene=t,this.intersector=new r.IntersectHelper(e),this._ground=new r.Ground,this.collisionManager=new r.CollisionManager,this.pivotBallGroup=null,this.minDollyDistance=5,this.gravity=0,this.farFactor=2,this.maxPitch=void 0,this.minPitch=void 0,this._cameraChanging=!1,s=r.Utils.defaultValue(s,{}),this._enableDamping=r.Utils.defaultValue(s.enableDamping,!1),this._dynamicDampingFactor=r.Utils.defaultValue(s.dynamicDampingFactor,.1),this._limitWorldScalar=!0,this.lockPan=!1,this.userInputWorking=!1,this._changeCallBack=a,this._planIntersect=new THREE.Vector3,this.userInputHelper=new r.UserInputHelper(this,n),this._lastTrackPoint=new THREE.Vector3,this._lastZoomCxy=new THREE.Vector2}destroy(){this.viewer=null,this.camera=null,this.domElement=null,this.scene=null,this.intersector.destroy(),this.intersector=null,this.collisionManager=null,this.pivotBallGroup=null,this._changeCallBack=null,this._planIntersect=null,this._lastTrackPoint=null,this._lastZoomCxy=null,this.userInputHelper=null}enableDamping(){this._enableDamping=!0;const e=this.viewer.editorManager.userInputEditor;r.Utils.isDefined(e)&&e.resetDynamicMoving()}disableDamping(){this._enableDamping=!1;const e=this.viewer.editorManager.userInputEditor;r.Utils.isDefined(e)&&e.resetDynamicMoving()}isEnableDamping(){return this._enableDamping}dynamicDampingFactor(e){return r.Utils.isDefined(e)&&(this._dynamicDampingFactor=e),this._dynamicDampingFactor}enableLimitWorldScalar(e){this._limitWorldScalar=e}isCameraChanging(){return this._cameraChanging}setCameraChanging(e){this._cameraChanging=e,this.camera.dirty=e}setCamera(e){this.camera=e}getCamera(){return this.camera.updateMVP(),this.camera}dirtyCamera(e){this.camera.dirty=e}getFrustum(){return this.camera.getFrustum()}lockAxisZ(e){r.EditorConfig.LockAxisZ=e}isLockedAxisZ(){return r.EditorConfig.LockAxisZ}setLockAxisZRange(e){r.EditorConfig.LockAxisZRange=e}getLockAxisZRange(){return r.EditorConfig.LockAxisZRange}updateMaxPitch(e){this.maxPitch=e}updateMinPitch(e){this.minPitch=e}processRotate(e,t){var i=this.viewer.getClientSize(),r=-2*Math.PI*e.x/i.x,n=-2*Math.PI*e.y/i.y;this.handleRotation(r,n,t)}handleRotation(t,i,n){var a=this.camera,s=a.position,o=a.target;a.getWorldDirection(l);var d,h=o.clone().sub(s),c=h.length(),u=null,p=function(e,t=!1){var i,r,d,u=new THREE.Vector3;if(n){if(r=(i=s.clone().sub(n)).length(),i.normalize(),d=i.clone().applyQuaternion(e).normalize(),t&&null!=a.minimumElevation){let e=s.clone();if(e.copy(n).add(d.clone().multiplyScalar(r)),e.y<a.minimumElevation)return!1}s.copy(n).add(d.multiplyScalar(r)),l.applyQuaternion(e).normalize(),u.copy(s).add(l.multiplyScalar(c)),o.copy(u)}else i=h.clone(),r=c,i.normalize(),d=i.clone().applyQuaternion(e).normalize(),u.copy(s).add(d.multiplyScalar(r)),o.copy(u);return!0},m=a.up,f=l.clone().cross(m).normalize().clone().cross(l).normalize();if(a.realUp.copy(f),r.EditorConfig.LockAxisZ){if(Math.abs(t)>Math.abs(i))d=e,p(u=(new THREE.Quaternion).setFromAxisAngle(d,t)),a.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp();else if(null!=r.EditorConfig.LockAxisZRange&&Math.abs(i)>1e-4){const e=r.EditorConfig.LockAxisZRange;y(this.camera,i,n,e)&&(d=l.clone().cross(m).normalize(),p(u=(new THREE.Quaternion).setFromAxisAngle(d,i)),a.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp())}}else{if(Math.abs(t)>Math.abs(i))(Math.abs(l.y+1)<1e-4||Math.abs(l.y-1)<1e-4)&&(d=l.clone().cross(a.realUp).normalize(),p(u=(new THREE.Quaternion).setFromAxisAngle(d,.1)),a.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()),d=l.y>0&&a.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),p(u=(new THREE.Quaternion).setFromAxisAngle(d,t)),a.realUp.applyQuaternion(u).normalize();else if(Math.abs(i)>1e-4){if(null!=this.maxPitch&&null!=this.minPitch){const e=a.target.clone().sub(a.position);let t=new THREE.Vector2(Math.sqrt(e.x*e.x+e.z*e.z)*(a.realUp.y>0?1:-1),e.y).angle();if(t-Math.PI>0&&(t-=2*Math.PI),t=-t,i<0){if(t-i*(a.realUp.y>0?1:-1)>=this.maxPitch)return}else if(null!=a.minimumElevation&&a.position.y<a.minimumElevation||t-i<=this.minPitch)return}if(d=l.clone().cross(a.realUp).normalize(),!p(u=(new THREE.Quaternion).setFromAxisAngle(d,i),i>0))return;a.realUp.applyQuaternion(u).normalize()}this.adjustCameraUp()}this.updateCamera(),this.dirtyCamera(!0),this.setCameraChanging(!0)}updateCamera(){var e=this.camera;e.dirty&&(e.lookAt(e.target),e.updateMVP())}update(e,t){this.updateCamera();var a=this.camera;e?(void 0!==t&&this.needUpdateRenderList(t),!1!==r.GlobalData.BatchMergeEnabled&&r.GlobalData.Renderer!==r.EnumRendererType.INCREMENT||this.viewer.render(),i.copy(a.position),n.copy(a.quaternion)):(i.distanceToSquared(a.position)>r.Math.EPSILON6||8*(1-n.dot(a.quaternion))>r.Math.EPSILON6)&&(i.copy(a.position),n.copy(a.quaternion))}updateView(e){void 0!==e&&this.needUpdateRenderList(e),this._changeCallBack()}updateHighlight(){this._changeCallBack(!0)}needUpdateRenderList(e){this.viewer.editorManager.isUpdateRenderList=e,this.setCameraChanging(e)}pan(e,t){var i=this.domElement===document?this.domElement.body:this.domElement,n=new THREE.Vector3;const a=this;function s(e){var t=a.camera.matrix.elements;n.set(t[0],t[1],t[2]),n.multiplyScalar(-e),a.camera.target.add(n),a.camera.position.add(n)}function o(e){var t=a.camera.matrix.elements;n.set(t[4],t[5],t[6]),n.multiplyScalar(e),a.camera.target.add(n),a.camera.position.add(n)}if(this.camera.isPerspective){var l=this.camera.position.clone().sub(this.camera.target).length();s(2*e*(l*=Math.tan(this.camera.fov/2*Math.PI/180))/i.clientHeight),o(2*t*l/i.clientHeight)}else void 0!==this.camera.top?(s(e*(this.camera.right-this.camera.left)/i.clientWidth),o(t*(this.camera.top-this.camera.bottom)/i.clientHeight)):r.Logger.warn("WARNING: CloudPickEditor.js encountered an unknown camera type - pan disabled.")}_checkZoomNearBoundary(e,t){if(t<0){d.copy(e);var i=this.scene.getOriginalBoundingBoxWorld(),r=.5*i.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),n=this.scene.getMatrixWorldGlobal();a.copy(n).invert(),d.applyMatrix4(a);var s=20*r,o=i.getCenter(d);if(d.distanceTo(o)>s)return!0}return!1}endOperation(){this.intersector.lastIntersect=null}onUserInputFinished(){this.userInputWorking=!1,this.viewer.render()}setTrackPointChanging(e){this._trackPointChanging=e}isTrackPointChanging(){return this._trackPointChanging}zoom(e,t,i){let n=null;this._lastZoomCxy.x!==t||this._lastZoomCxy.y!==i||this.isTrackPointChanging()?r.Utils.isDefined(t)&&r.Utils.isDefined(i)&&(n=this.userInputHelper.getTrackingPoint(t,i,!0),this._lastZoomCxy.x=t,this._lastZoomCxy.y=i,this._lastTrackPoint=n,this.setTrackPointChanging(!1)):n=this._lastTrackPoint,this.userInputHelper.adjustCameraForZoom(e,n),this.update()}touchDolly(e,t,i){const r=.5*i;var n=new THREE.Vector2(e,t),a=this.getIntersectContext(n),s=this.intersector.hitTest(a);null!=s?this.userInputHelper.adjustCameraForZoom(r,s):this.userInputHelper.adjustCameraForZoom(r,null)}zoomWithCenter(e,t){let i=e>0?e/(1-e):e;this.userInputHelper.adjustCameraForZoom(i,this.scene.worldToDrawing(t)),this.update()}getContainerDimensions(){return r.DomUtil.getContainerOffsetToClient(this.domElement)}screenToCanvas(e,t){var i=this.getContainerDimensions();return{x:e-i.left,y:t-i.top}}calculatePivot(e,t){return this.userInputHelper.getRotatePivot(e,t)}mapWindowToViewport(e,t,i){var r=this.getContainerDimensions(),n=i||new THREE.Vector2;return n.x=(e-r.left)/r.width*2-1,n.y=-(t-r.top)/r.height*2+1,n}mapViewportToWindow(e,t,i){var r=this.getContainerDimensions(),n=i||new THREE.Vector2;return n.x=(e+1)/2*r.width+r.left,n.y=(1-t)/2*r.height+r.top,n}computeFrustum(e,t,i,r,n,a){var s=this.camera,o=s.near*Math.tan(THREE.Math.degToRad(.5*s.fov)),l=o*s.aspect,d=(e-a.left)/a.width*2-1,h=(t-a.left)/a.width*2-1,p=-(i-a.top)/a.height*2+1,m=-(r-a.top)/a.height*2+1;if(s.isPerspective?c.makePerspective(d*l,h*l,p*o,m*o,s.near,s.far):c.makeOrthographic(d*l,h*l,p*o,m*o,s.near,s.far),s.updateMatrixWorld(),s.matrixWorldInverse.copy(s.matrixWorld).invert(),u.multiplyMatrices(c,s.matrixWorldInverse),n.setFromProjectionMatrix(u),!s.isPerspective){const a=(e,t,i,r,a)=>{const s=[this.viewer.worldToDrawing(this.viewer.clientToWorld({x:t,y:i,z:0})),this.viewer.worldToDrawing(this.viewer.clientToWorld({x:r,y:a,z:0})),this.viewer.worldToDrawing(this.viewer.clientToWorld({x:r,y:a,z:1}))];n.planes[e].setFromCoplanarPoints(...s)};a(0,e,i,e,r),a(1,t,r,t,i),a(2,e,r,t,r),a(3,t,i,e,i)}}getCameraName(){return this.camera===this.viewer.defaultCamera?this.camera.isPerspective?"persp":"orth":this.camera.name}getCameraInfo(){var e=new r.CameraInfo(this.getCameraName(),this.camera.position,this.camera.target,this.camera.up);return JSON.stringify(e)}adjustCameraUp(){this.camera.realUp.y>0?this.camera.up.set(0,1,0):this.camera.realUp.y<0?this.camera.up.set(0,-1,0):this.camera.realUp.x>0?this.camera.up.set(1,0,0):this.camera.realUp.x<0?this.camera.up.set(-1,0,0):this.camera.realUp.z>0?this.camera.up.set(0,0,1):this.camera.realUp.z<0&&this.camera.up.set(0,0,-1)}getWorldRight(){var e=new THREE.Vector3,t=this.camera.up,i=this.camera.direction(h);return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()}getWorldRightByRealUp(){var e=new THREE.Vector3,t=this.camera.realUp,i=this.camera.direction(h);return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()}getWorldUp(){var e=this.getWorldRight(),t=this.camera.direction(h);return e.cross(t).normalize()}getWorldPointFromNearPlane(e,t){var i=new THREE.Vector3(e,t,0);return i.unproject(this.camera),i}setCameraPosition(e){var t=this.camera,i=this.camera.direction(),r=i.length(),n=i.clone();n.normalize(),n.setLength(r),t.position.copy(e),t.target.addVectors(t.position,n),this.dirtyCamera(!0),this.setCameraChanging(!0)}moveStraight(e,t){var i=this.camera.position,r=this.camera.target;if(t){var n=new THREE.Vector3(r.x-i.x,0,r.z-i.z),a=e/n.length(),s=new THREE.Vector3(n.x*a,0,n.z*a);i.add(s),r.add(s)}else{var o=r.clone().sub(i);this.camera.translateZ(-e),r.addVectors(i,o)}}getIntersectContext(e){return this.userInputHelper.getIntersectContext(e)}getLastIntersect(){return this.intersector.lastIntersect}touchUpdateRotationInPersonView(t,i){this.dirtyCamera(!0),this.setCameraChanging(!0);var n=this,a=this.camera.position,s=this.camera.target.clone().sub(a).length();this.camera.getWorldDirection(l);var o=this.camera.realUp||this.camera.up,d=l.clone().cross(o).normalize(),h=d.clone().cross(l).normalize();this.camera.realUp.copy(h);const c=r.EditorConfig.LockAxisZRange;var u,p;if(Math.abs(t)>Math.abs(i))u=e,p=t;else{if(r.EditorConfig.LockAxisZ&&!y(this.camera,i,this.camera.target,c))return;u=d;var m=new THREE.Vector3(0,1,0).clone().cross(o),f=m.dot(d),g=Math.asin(m.length());f<0&&(g=-g),g+i>Math.PI/4-r.Math.EPSILON6?i=Math.PI/4-r.Math.EPSILON6-g:g+i<-Math.PI/4+r.Math.EPSILON6&&(i=-Math.PI/4+r.Math.EPSILON6-g),p=i}var v,M,E=(new THREE.Quaternion).setFromAxisAngle(u,p);v=E,M=new THREE.Vector3,l.applyQuaternion(v).normalize(),M.copy(a).add(l.multiplyScalar(s)),n.camera.target.copy(M),this.camera.realUp.applyQuaternion(E).normalize()}touchUpdateRotationInModelView(t,i,n){this.dirtyCamera(!0),this.setCameraChanging(!0);var a=n||this.scene.getBoundingBox().getCenter(d),s=this.camera.position,o=this.camera.target.clone().sub(s).length(),h=s.clone().sub(a),c=h.length(),u=null;this.camera.getWorldDirection(l),h.normalize();const p=this;var m,f=function(e){var t=new THREE.Vector3,i=h.clone().applyQuaternion(e).normalize();s.copy(a).add(i.multiplyScalar(c)),l.applyQuaternion(e).normalize(),t.copy(s).add(l.multiplyScalar(o)),p.camera.target.copy(t)},g=this.camera.up,M=l.clone().cross(g).normalize(),E=M.clone().cross(l).normalize();if(this.camera.realUp.copy(E),r.EditorConfig.LockAxisZ){if(Math.abs(t)>Math.abs(i))m=e,f(u=(new THREE.Quaternion).setFromAxisAngle(m,t)),this.camera.realUp.applyQuaternion(u).normalize();else if(null!=r.EditorConfig.LockAxisZRange&&Math.abs(i)>1e-4){const e=r.EditorConfig.LockAxisZRange;y(this.camera,i,a,e)&&(m=l.clone().cross(g).normalize(),f(u=(new THREE.Quaternion).setFromAxisAngle(m,i)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp())}}else if(Math.abs(t)>Math.abs(i))(Math.abs(l.y+1)<1e-4||Math.abs(l.y-1)<1e-4)&&(m=l.clone().cross(this.camera.realUp).normalize(),f(u=(new THREE.Quaternion).setFromAxisAngle(m,.1)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()),m=l.y>0&&this.camera.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),f(u=(new THREE.Quaternion).setFromAxisAngle(m,t)),this.camera.realUp.applyQuaternion(u).normalize();else if(Math.abs(i)>.01){m=l.clone().cross(this.camera.realUp).normalize();var x=new THREE.Vector3(0,1,0).clone().cross(g),_=x.dot(M),b=Math.asin(x.length());_<0&&(b=-b),b+i>Math.PI/2-r.Math.EPSILON6?i=Math.PI/2-r.Math.EPSILON6-b:b+i<-Math.PI/2+r.Math.EPSILON6&&(i=-Math.PI/2+r.Math.EPSILON6-b),f(u=(new THREE.Quaternion).setFromAxisAngle(m,i)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()}this.pivotBallGroup||function(e){e.pivotBallGroup=e.scene.getOrCreateObjectGroup(r.ObjectGroupType.PIVOTBALL,{priority:10,globalSpace:!1});var t=new THREE.SphereBufferGeometry(15,64,64),i=new THREE.Mesh(t,new r.PhongLightingMaterial({color:16777215,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide,unlight:!0}));t=new THREE.SphereBufferGeometry(1,64,64);var n=new THREE.Mesh(t,new r.PhongLightingMaterial({color:16711680,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide,unlight:!0}));e.pivotBallGroup.add(i),e.pivotBallGroup.add(n)}(this),this.pivotBallGroup.visible=!0;for(var I=function(e){var t=e.camera,i=t.position,r=e.camera.target.clone().sub(i);r.normalize();var n=new THREE.Plane;n.setFromNormalAndCoplanarPoint(r.clone().negate(),v(e)),n.normalize();var a=n.distanceToPoint(i)*Math.tan(.5*t.fov),s=e.getContainerDimensions();return 2*a/(s.height-s.top)}(this),T=v(this),S=0;S<this.pivotBallGroup.children.length;S++){var C=this.pivotBallGroup.children[S];C.position.copy(T),C.scale.set(I,I,I),C.updateMatrixWorld()}}touchUpdateRotation(e,t){var i=this.camera.position;this.scene.getBoundingBox().containsPoint(i)?this.touchUpdateRotationInPersonView(e,t):this.touchUpdateRotationInModelView(e,t,v(this))}clearTouchRotateState(){this.pivotBallGroup&&(this.pivotBallGroup.visible=!1)}touchEndHandler(){this.viewer.editorManager.cameraChange=!1,this.clearTouchRotateState(),this.touchUpdate()}touchUpdate(){var e=new THREE.Vector3;e.copy(this.camera.up),this.camera.up.copy(this.camera.realUp),this.camera.lookAt(this.camera.target),this.camera.up.copy(e),this.camera.updateMVP(),(s.distanceToSquared(this.camera.position)>r.Math.EPSILON6||8*(1-o.dot(this.camera.quaternion))>r.Math.EPSILON6)&&(this._changeCallBack(),this.dirtyCamera(!1),s.copy(this.camera.position),o.copy(this.camera.quaternion))}goTurnForWalk(e){var t=this.getCamera(),i=t.position,r=t.target,n=new THREE.Vector3(r.x-i.x,0,r.z-i.z),a=Math.cos(e),s=Math.sin(e),o=new THREE.Vector3(n.x*a-n.z*s,0,n.x*s+n.z*a);r.x=i.x+o.x,r.z=i.z+o.z,this.dirtyCamera(!0),this.setCameraChanging(!0)}goPitchForWalk(e){var t=this.getCamera(),i=t.position,r=t.target,n=r.x-i.x,a=r.z-i.z,s=Math.sqrt(n*n+a*a),o=new THREE.Vector3(s,r.y-i.y,0),l=Math.cos(e),d=Math.sin(e),h=new THREE.Vector3(o.x*l-o.y*d,o.x*d+o.y*l,0);r.y=i.y+h.y,this.dirtyCamera(!0),this.setCameraChanging(!0)}goUpDownForWalk(e,t){var i=this.getCamera(),r=i.position,n=i.target,a=i.up,s=g(i,this.scene.getRawMatrixGlobal(),a,e);t&&(t.position.z+=s.stepDiffWorld.z,t.box.min.z+=s.stepDiffWorld.z,t.box.max.z+=s.stepDiffWorld.z),r.y+=s.stepDiffDrawing.y,n.y+=s.stepDiffDrawing.y,this.dirtyCamera(!0),this.setCameraChanging(!0)}stepCameraForWalk(e,t,i){var n,a=this.getCamera(),s=a.position,o=a.target,l=new THREE.Vector3(o.x-s.x,0,o.z-s.z).normalize(),d=new THREE.Vector3(0,1,0),h=l.clone().cross(d),c=this.scene.getRawMatrixGlobal();switch(e){case r.MoveDirection.FORWARD:n=g(a,c,l,t);break;case r.MoveDirection.BACK:l.multiplyScalar(-1),n=g(a,c,l,t);break;case r.MoveDirection.LEFT:h.multiplyScalar(-1),n=g(a,c,h,t);break;case r.MoveDirection.RIGHT:n=g(a,c,h,t)}if(n.stepDiffDrawing.y=0,n.stepDiffWorld.z=0,i)return n;s.add(n.stepDiffDrawing),o.add(n.stepDiffDrawing),this.dirtyCamera(!0),this.setCameraChanging(!0)}hitTestWithGround(e){var t=this.getCamera(),i=t.up.clone().multiplyScalar(-1);if(e){let t=e.position;d.set(t.x,t.y,e.box.max.z)}var n=e?this.scene.worldToDrawing(d):t.position.clone(),a=new r.Raycaster(n,i),s=this.getIntersectContext(null),o=this.intersector.byGravity;this.intersector.byGravity=!0;var l=this.intersector.getObjectsByRaycaster(s,a,!0);return this.intersector.byGravity=o,l[0]}hitTestForward(e,t,i){var n=this.getCamera(),a=this.camera.direction();a.normalize(),a=a.multiplyScalar(e);let s,o=[];const l=this.getIntersectContext(null);if(t)o=this.intersector.intersectByBox(l,t,i);else{s=n.position.clone();const e=new r.Raycaster(s,a),t=this.intersector.getObjectsByRaycaster(l,e,!1);t&&t.length>0&&o.push(t[0])}return o}hitTestRight(e,t,i){//!!
var n=this.getCamera(),a=this.camera.direction();a.normalize();var s=n.up,o=a.cross(s).normalize();let l;o=o.multiplyScalar(e);let d=[];var h=this.getIntersectContext(null);if(t)d=this.intersector.intersectByBox(h,t,i);else{l=n.position.clone();const e=new r.Raycaster(l,o),t=this.intersector.getObjectsByRaycaster(h,e,!1);t&&t.length>0&&d.push(t[0])}return d}computeGravity(e){this.gravity=0;var t=this.hitTestWithGround(e);if(null==t){var i=this.scene.getRawMatrixGlobal();a.copy(i).invert();var r=this.camera.position.clone();r.applyMatrix4(a),r.z=0,r.applyMatrix4(i),this.distanceToGround=Math.abs(this.camera.position.y-r.y),null!=this.hitNullCount&&0!=this.hitNullCount||(this.hitNullCount=1)}else this.hitNullCount=0;if(1==this.hitNullCount)return void(this.gravity=0);const n=e?e.manHeight:this.manHeight;if(void 0===n)this.computeManHeight(e);else{var s=t?t.distance-n:this.distanceToGround-n;if(s/=this.scene.getGlobalScaleFactor(),Math.abs(s)<.1)return;this.gravity=s}}computeManHeight(e){let t=this.viewer.modelManager.isMeterUnit()?.001:1;if(!(e?e.manHeight:this.manHeight)){var i=this.hitTestWithGround(e),r=e?e.box.getSize(d).z:1650*t,n=this.scene.getRawMatrixGlobal();if(a.copy(n).invert(),null!=i){var s=i.point.clone();s.applyMatrix4(a),s.z+=r,s.applyMatrix4(n);const t=Math.abs(i.point.y-s.y);e?e.manHeight=t:this.manHeight=t}else{var o=e?e.box.min.clone():this.camera.position.clone();o.applyMatrix4(a),o.z=0;var l=o.clone();l.z+=r,o.applyMatrix4(n),l.applyMatrix4(n);const t=Math.abs(l.y-o.y);e?e.manHeight=t:this.manHeight=t}}}walkWithParallelEye(){var e=this.camera,t=this.camera.direction().length(),i=this.scene.getBoundingBox().getCenter(d),r=new THREE.Vector3;r.subVectors(i,e.position);var n=r.length();r.y=0,r.normalize(),r.multiplyScalar(n),e.position.subVectors(i,r),e.target.addVectors(e.position,r.normalize().multiplyScalar(t));var a=new THREE.Vector3(0,1,0);e.up.copy(a),e.realUp.copy(a),this.dirtyCamera(!0),this.setCameraChanging(!0),this.update(!0)}updateFlyMove(e,t){var i=this.camera;this.dirtyCamera(!0),this.setCameraChanging(!0);var n=r.MoveDirection;e&n.FORWARD&&i.translateZ(-t),e&n.BACK&&i.translateZ(t),e&n.LEFT&&i.translateX(-t),e&n.RIGHT&&i.translateX(t),e&n.UP&&i.translateY(t),e&n.DOWN&&i.translateY(-t),this.flyOnWorld()}flyOnWorld(e){var t=this.camera,r=t.up.clone();(e=!1!==e)&&t.realUp&&(t.up.copy(t.realUp),t.lookAt(t.target),t.up.copy(r)),this._changeCallBack(),this.dirtyCamera(!1),i.copy(t.position),n.copy(t.quaternion)}rotateForFly(e,t,i,n){var a=this.camera,s=a.position,o=a.target,l=o.clone().sub(s),d=new THREE.Vector3(0,1,0),h=a.realUp||a.up,c=l.clone().cross(h).normalize();if(this.dirtyCamera(!0),this.setCameraChanging(!0),r.EditorConfig.LockAxisZ&&(t=0),0!=t){var u=(new THREE.Quaternion).setFromAxisAngle(c,-t),p=l.clone();p.applyQuaternion(u);var m=p.angleTo(d);(m-=.5*Math.PI)>=i&&m<=n&&l.applyQuaternion(u)}if(0!=e){var f=(new THREE.Quaternion).setFromAxisAngle(d,-e);l.applyQuaternion(f)}o.addVectors(s,l),this.flyOnWorld()}fitAndRotateBySelection(){this.viewer.zoomToSelection()}flyToPointWithParallelEye(e){var t=this.camera.direction(),i=t.length(),r=t.clone();r.y=0,r.normalize(),r.setLength(i);var n=new THREE.Vector3(0,1,0);this.camera.up=n,this.camera.realUp=n.clone(),this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,r),this.update(!0)}flyToPoint(e){var t=this.camera.direction();this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,t),this.update(!0)}setCameraHeight(e,t){this.cameraAbsoluteHeightEnabled=!1,this.cameraRelativeHeight=t,void 0===this.cameraConstraintHeights?this.cameraConstraintHeights=[]:this.cameraConstraintHeights.length=0;for(var i=0,r=e.length;i<r;++i)this.cameraConstraintHeights[i]=e[i]}updateCameraHeight(){var e,t,i=this.scene,n=this.getCamera(),a=i.drawingToWorld(n.position),s=a.z;if(this.cameraAbsoluteHeightEnabled)void 0===this.cameraAbsoluteHeight&&(this.cameraAbsoluteHeight=s),e=this.cameraAbsoluteHeight;else if(void 0===this.cameraConstraintHeights)e=s;else{var o=r.Utils.findRange(this.cameraConstraintHeights,s);if(e=this.cameraConstraintHeights[o],e+=this.cameraRelativeHeight,o<this.cameraConstraintHeights.length-1){var l=this.cameraConstraintHeights[o+1];e>l&&(e=l)}}e!==s&&(t=i.worldToDrawing({x:a.x,y:a.y,z:e}),this.setCameraPosition(t))}getRaycaster(e,t){var i=new r.Raycaster,n=new THREE.Vector2;return this.userInputHelper.clientToViewport(e,t,n),i.setFromCamera(n,this.camera),i}translateCameraForWalk(e,t){var i=this.collisionManager;if(0!==e.x){if(!1===r.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t);var n=1;e.x<0&&(n=-1);var a=this.hitTestRight(n);if(0==a.length)this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t);else{var s=(h=this.viewer.modelManager.getNodeInfosByUserId(a[0].userId))?h[0].userData:null;0==i.hasCollision(s,a[0].userId,a[0].distance)&&this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t)}}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5);else if(r.GlobalData.WalkingWithGravity){var o=t;if(0!=this.gravity){var l=Math.abs(this.gravity);o=o>=l?l:.2*l}this.gravity>0?this.goUpDownForWalk(-o):this.gravity<0&&this.goUpDownForWalk(o)}if(0!==e.z){if(!1===r.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t);n=1;e.z>0&&(n=-1);var d=this.hitTestForward(n);if(0==d.length)this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t);else{var h;s=(h=this.viewer.modelManager.getNodeInfosByUserId(d[0].userId))?h[0].userData:null;0==i.hasCollision(s,d[0].userId,d[0].distance)&&this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t)}}}translateCameraForThirdpersonWalk(e,t,i,n){var a=this.collisionManager;if(i.box.getSize(f),p.set(i.box.min,i.box.max),p.min.z+=.5*f.z,p.max.z-=.2*f.z,m.copy(p),0!==e.x){let d=this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t,i);var s=1;if(e.x<0&&(s=-1),p.min.add(d.stepDiffWorld),p.max.add(d.stepDiffWorld),p.union(m),!1===r.GlobalData.EnableHitDetection)return void this.stepObjectForWalk(d,i,p,n,0);var o=this.hitTestRight(s,p,!0);let h=!1;for(let e=0;e<o.length;e++){let t=o[e];var l=(u=this.viewer.modelManager.getNodeInfosByUserId(t))?u[0].userData:null;if(h=a.hasCollision(l,t,0),h)break}h||this.stepObjectForWalk(d,i,p,n,0)}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5,i);else if(r.GlobalData.WalkingWithGravity){var d=t;if(0!=this.gravity){var h=Math.abs(this.gravity);d=d>=h?h:.2*h}this.gravity>0?this.goUpDownForWalk(-d,i):this.gravity<0&&this.goUpDownForWalk(d,i)}if(0!==e.z){let o=this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t,i);s=1;if(e.z>0&&(s=-1),p.min.add(o.stepDiffWorld),p.max.add(o.stepDiffWorld),p.union(m),!1===r.GlobalData.EnableHitDetection)return void this.stepObjectForWalk(o,i,p,n,s);var c=this.hitTestForward(s,p,!0);let d=!1;for(let e=0;e<c.length;e++){let t=c[e];var u;l=(u=this.viewer.modelManager.getNodeInfosByUserId(t))?u[0].userData:null;if(d=a.hasCollision(l,t,0),d)break}d||this.stepObjectForWalk(o,i,p,n,s)}}checkCollisionInCameraAndObject(e){if(!e)return null;var t=this.getCamera();let i=e.position;d.set(i.x,i.y,e.box.max.z);var n=this.scene.worldToDrawing(d);let a=new THREE.Vector3;a.subVectors(t.position,n),a.normalize();const s=this.getIntersectContext(null),o=new r.Raycaster(n,a),l=this.intersector.getObjectsByRaycaster(s,o,!0)[0];if(l){var h=t.position.distanceTo(n);if(l.distance<h&&l.userId!=e.name)return l.point}return null}stepObjectForWalk(e,t,i,r,n){if(!this.scene.getBoundingBoxWorld().intersectsBox(i))return;t.box.min.add(e.stepDiffWorld),t.box.max.add(e.stepDiffWorld),t.position.add(e.stepDiffWorld);var a=this.getCamera(),s=a.position,o=a.target;let l,h=0,c=t.position;n>=0?(l=this.checkCollisionInCameraAndObject(t),l?h=1:1==n&&(d.set(c.x,c.y,t.box.max.z),a.getDistanceByPos(d,this.scene.getRawMatrixGlobal())<r&&(h=2))):(s.add(e.stepDiffDrawing),o.add(e.stepDiffDrawing),l=this.checkCollisionInCameraAndObject(t),h=l?-1:3),d.set(c.x,c.y,t.box.max.z);var u=this.scene.worldToDrawing(d);switch(h){case 0:s.add(e.stepDiffDrawing),o.copy(u);break;case 1:s.set(l.x,l.y,l.z),o.copy(u);break;case 2:o.copy(u);break;case 3:let i=new THREE.Vector3;i.copy(e.stepDiffWorld),i.normalize();let n=this.scene.worldToDrawing(d),a=this.scene.worldToDrawing(d.addVectors(d,i.multiplyScalar(r)));s.set(a.x,a.y,a.z),o.set(n.x,n.y,n.z);var p=this.checkCollisionInCameraAndObject(t);p&&s.set(p.x,p.y,p.z);break;case-1:s.sub(e.stepDiffDrawing),o.copy(u)}this.dirtyCamera(!0),this.setCameraChanging(!0)}rotateCameraForWalk(e,t){0!==e.y&&(this.goTurnForWalk(-e.y*Math.PI*t),e.y=0),0!==e.x&&(this.goPitchForWalk(e.x*Math.PI),e.x=0)}movePlane(e,t,i,r,n){if(null==n){var a=new THREE.Plane;a.setComponents(e.x,e.y,e.z,e.w),n=new THREE.Vector3,a.coplanarPoint(n)}var s=new THREE.Vector3(e.x,e.y,e.z),o=this.camera.getWorldDirection(d),l=new THREE.Plane;l.setFromNormalAndCoplanarPoint(o,n);var h=this.getRaycaster(t.clientX,t.clientY),c=new THREE.Vector3,u=this.getRaycaster(i.x,i.y),p=new THREE.Vector3;if(h.ray.intersectPlane(l,c)&&u.ray.intersectPlane(l,p)){c.subVectors(c,p),c.projectOnVector(s);var m=c.length();if(c.dot(s)<0&&(m=-m),0!=m)return r&&(s.multiplyScalar(m),m=s.x+s.y+s.z),m}return null}getZenith(){var t=this.camera.position,i=this.viewer.getBoundingBox().getCenter(d);return t.clone().sub(i.clone()).clone().angleTo(e.clone())}getAzimuth(){var i=camera.position,r=this.viewer.getBoundingBox().getCenter(d),n=i.clone().sub(r.clone()).clone().projectOnPlane(e.clone()),a=n.angleTo(t.clone());return n.x<0&&(a=360-a),a}getCurrentRangeofCamera(){var e=this.viewer,t=this.camera,i=e.getBoundingBox(),r=t.position,n=.5*i.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*t.fov));return i.getCenter(d).distanceTo(r)/n}setMaximalRangeofCamera(e=2){this.farFactor=e,this.userInputHelper.boundaryLimitFactor=e}getMaximalRangeofCamera(){return this.farFactor}cameraWithinMaximumRange(e){var t=e||this.farFactor;return!(this.getCurrentRangeofCamera()>t)}resetCameraToMaximumRange(e){const t=this.viewer,i=this.camera,r=t.getBoundingBox(),n=i.position;var a=e||this.farFactor,s=.5*r.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*i.fov));const o=r.getCenter(d);var l=(new THREE.Vector3).subVectors(o,n);l.setLength(a*s);var h=o.clone().sub(l),c=this.camera.direction();this.camera.position.copy(h),this.camera.target.copy(c.add(h)),this.updateView(!0)}zoomToHeight(e){const t=e.destination;if(!r.Utils.isDefined(t))return void console.log("destination is required");if(!r.Utils.isDefined(e.globe))return void console.log("globe object is required");const i=r.Tile.TileMath.fromDegreesYUp(t.lon,t.lat,t.height,e.globe.radius),n=this.camera;var a={position:n.position.clone(),target:n.target.clone(),up:n.realUp.clone()||n.up.clone(),zoom:n.zoom};const s={position:i,target:n.target.clone(),up:n.realUp.clone()||n.up.clone(),zoom:n.zoom},o=this.viewer,l=this;return new Promise(((e,t)=>{const i=new r.CameraAnimator;i.setDuration(2e3),i.active(a,s,o,(function(e){l.update(!0,!0)}),(function(){e()}))}))}setObjectOffset(e){if(!r.Utils.isDefined(e))return void console.warn("The parameter offset is undefined.");if("number"!=typeof e)return void console.warn("The parameter offset is not a number.");let t=r.Math.clamp(e,.2,100);this.userInputHelper._minObjectOffset=t}getObjectOffset(){return this.userInputHelper._minObjectOffset}}}(),(()=>{let e=new THREE.Matrix4,t=new THREE.Matrix4,i=new THREE.Sphere,n=new THREE.Box3,a=new THREE.Box3;r.PickUtil=class{constructor(){}static pickByRect(e,t,i,n,a,s,o){var l;if(!s&&!o)return[];l=s&&o?o.x>s.x?"window":"cross":"window";var d=new Map,h=n.modelManager,c=h.getOctreeRoots(),u=h.getOctantMap(),p=h.getSceneState(),m=e.getRawMatrixGlobal(),f=new THREE.Box3,g=new THREE.Vector3(Math.min(s.x,o.x),Math.min(s.y,o.y),0),v=new THREE.Vector3(Math.max(s.x,o.x),Math.max(s.y,o.y),0),y=new THREE.Box3(g,v);function M(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!n.clipPoint(t))return!1;return!0}function E(e,i){if(f.set(e.min,e.max),t.intersectsBox(f)){i.push(e);for(var r=0,n=e.childOctants.length;r<n;++r){E(e.childOctants[r],i)}}}function x(e,i,a,s){if(function(e,t){var i=h.isHiddenSourceObjectUserId(e.userId);return C&&!S._isVisible(e,t)||w&&!S._isPickable(e,t)||i}(i,s))return;let o=null;o=a||i.boundingBox,M(o)||("window"!==l||D[i.userId]?"cross"!==l||N[i.userId]||("in"===r.GeomUtil.intersectBox(t,o)||"intersect"===r.GeomUtil.intersectBox(t,o)&&function(e,t){var i=[];n.modelManager.traverseModels((function(t){i=i.concat(t.getGeometryBuffersByUserId(e))})),i.sort(((e,t)=>e.index.length-t.index.length));for(var a=0;a<i.length;a++)for(var s=i[a].position,o=i[a].index,l=i[a].matrix,d=0;d<o.length;d+=3){var h=new THREE.Vector3(s[3*o[d]],s[3*o[d]+1],s[3*o[d]+2]),c=new THREE.Vector3(s[3*o[d+1]],s[3*o[d+1]+1],s[3*o[d+1]+2]),u=new THREE.Vector3(s[3*o[d+2]],s[3*o[d+2]+1],s[3*o[d+2]+2]);l&&(h.applyMatrix4(l),c.applyMatrix4(l),u.applyMatrix4(l)),t&&(h.applyMatrix4(t),c.applyMatrix4(t),u.applyMatrix4(t));var p=n.worldToClient(h),m=n.worldToClient(c),f=n.worldToClient(u),g=new THREE.Vector3(p.x,p.y,0),v=new THREE.Vector3(m.x,m.y,0),M=new THREE.Vector3(f.x,f.y,0),E=new THREE.Triangle(g,v,M);if(r.GeomUtil.boxIntersectsTriangle(y,E))return!0}return!1}(i.userId,O))&&(e.set(i.userId,!0),N[i.userId]=!0):"in"===r.GeomUtil.intersectBox(t,o)||"intersect"===r.GeomUtil.intersectBox(t,o)&&function(e,i){var r=[],a=[];n.modelManager.traverseModels((function(t){r=r.concat(t.getGeometryBuffersByUserId(e))}));for(var s=0;s<r.length;s++)for(var o=r[s].position,l=r[s].matrix,d=0;d<o.length;d+=3){var h=new THREE.Vector3(o[d],o[d+1],o[d+2]);l&&h.applyMatrix4(l),i&&h.applyMatrix4(i),h.applyMatrix4(m),a.push(h)}var c=!0;return a.every((e=>(t.containsPoint(e)||(c=!1),c))),c}(i.userId,O)?e.set(i.userId,!0):(D[i.userId]=!0,e.delete(i.userId)))}function _(e,t,n){let s=[];for(const i of t.keys()){const t=e.getRealUserId(i);t&&s.push(t)}return s.length>0&&!1!==a&&(r.OPSELECTIONTYPE.Remove===i&&n.removeSelection(s,e.id),r.OPSELECTIONTYPE.Add===i&&n.addSelection(s,e.id)),s}var b,I,T,S=h.getFilter(),C=S._hasVisibleFilter(),w=S._hasPickableFilter();function R(e){const i=e.getUserIdMapByFrustum(t),r=e.getDescriptor();let n=new THREE.Box3;for(const t in i)r.getNodeInfoByUserIdCallback(t,(t=>{const i=t.nodeInfo;n.copy(i.boundingBox.clone().applyMatrix4(O).applyMatrix4(m)),x(d,i,n,e.id)}));return _(e,d,p)}function B(){const e=L.tilesLoader.tileReader;L.filter.objectInfoManager;return e.getAllUserIndexCallback((t=>{const i=e.getUserIdDrawingBoxByIndex(t,L);x(d,{userId:t,name:t,box:i},i,L.id)})),_(L,d,p)}if(i===r.OPSELECTIONTYPE.Clear)return void p.clearSelection();let A=[];for(var P in c){b=[],d.clear(),T=u[P],I=c[P];var L=n.modelManager.modelCollection.getById(P);if(L){var O=L.transformMatrix.clone(),D={},N={};if(r.BimTilesVersionControl.isVersion_3(L.dataVersion))A=A.concat(B());else if(L.tilesLoader)A=A.concat(R(L));else{var H,U;for(H=0,U=I.length;H<U;H++)E(I[H],b);for(H=0,U=b.length;H<U;H++){var F=T.info[b[H].octantId];if(F)for(var k=0,G=F.length;k<G;k++){var V=F[k];const e=V.boundingBox.clone().applyMatrix4(O).applyMatrix4(m),t=V.userId;x(d,{userId:t,name:t,boundingBox:e},void 0,L.id)}}A=A.concat(_(L,d,p))}}}function z(e){for(var t=e.geometry.attributes.position.array,i=e.matrix,a=0;a<t.length;a+=9){var s=new THREE.Vector3(t[a],t[a+1],t[a+2]),o=new THREE.Vector3(t[a+3],t[a+4],t[a+5]),l=new THREE.Vector3(t[a+6],t[a+7],t[a+8]);i&&(s.applyMatrix4(i),o.applyMatrix4(i),l.applyMatrix4(i));var d=n.worldToClient(s),h=n.worldToClient(o),c=n.worldToClient(l),u=new THREE.Vector3(d.x,d.y,0),p=new THREE.Vector3(h.x,h.y,0),m=new THREE.Vector3(c.x,c.y,0),f=new THREE.Triangle(u,p,m);if(r.GeomUtil.boxIntersectsTriangle(y,f))return!0}return!1}function j(e){for(var i=[],r=e.geometry.attributes.position.array,n=e.matrix,a=0;a<r.length;a+=3){var s=new THREE.Vector3(r[a],r[a+1],r[a+2]);n&&s.applyMatrix4(n),s.applyMatrix4(m),i.push(s)}var o=!0;return i.every((e=>(t.containsPoint(e)||(o=!1),o))),o}const W=n.getScene().getObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER),q=[];if(W){for(let e=0;e<W.children.length;e++){let i=W.children[e];if(i.name.indexOf("wireframe_")<0&&i.visible){let e=new THREE.Box3;if(e.copy(i.geometry.boundingBox),e.applyMatrix4(i.matrix).applyMatrix4(m),M(e))return;"window"===l?("in"===r.GeomUtil.intersectBox(t,e)||"intersect"===r.GeomUtil.intersectBox(t,e)&&j(i))&&q.push(i.name):"cross"===l&&("in"===r.GeomUtil.intersectBox(t,e)||"intersect"===r.GeomUtil.intersectBox(t,e)&&z(i))&&q.push(i.name)}}q.length>0&&!1!==a&&(r.OPSELECTIONTYPE.Remove===i&&p.removeSelection(q),r.OPSELECTIONTYPE.Add===i&&p.addSelection(q)),A=[...A,...q]}return A}static getObjectsInBox(e,t,i,n){var a={},s=i.getOctreeRoots(),o=i.getOctantMap(),l=e.getRawMatrixGlobal(),d=new THREE.Box3;function h(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!n.clipPoint(t))return!1;return!0}function c(e){return!(e.max.x<t.min.x||e.min.x>t.max.x||e.max.y<t.min.y||e.min.y>t.max.y||e.max.z<t.min.z||e.min.z>t.max.z)}function u(e){return e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z}function p(e,t){if(d.set(e.min,e.max),c(d)){t.push(e);for(var i=0,r=e.childOctants.length;i<r;++i){p(e.childOctants[i],t)}}}var m,f,g=i.getFilter(),v=g._hasVisibleFilter(),y=g._hasPickableFilter();for(var M in s){var E,x,_=[],b=o[M],I=s[M],T=n.modelManager.modelCollection.getById(M).transformMatrix.clone();for(E=0,x=I.length;E<x;E++)p(I[E],_);for(E=0,x=_.length;E<x;E++){var S=b.info[_[E].octantId];if(S)for(var C=0,w=S.length;C<w;C++){var R=S[C];(m=R,f=void 0,f=i.isHiddenSourceObjectUserId(m.userId),v&&!g._isVisible(m)||y&&!g._isPickable(m)||f)||(d.copy(R.boundingBox),d.applyMatrix4(T).applyMatrix4(l),!c(d)||u(d)||h(d)||(a[R.userId]=!0))}}const e=n.modelManager.getModel(M);if(r.BimTilesVersionControl.isVersion_3(e.dataVersion)){if(!e.isUserIdDataReady())return;e.getObjectsInBoxByBimtile(a,t,l,u)}else if(e.tilesLoader){if(!e.isUserIdDataReady())return;e.tilesLoader.tileReader.searchTreeManager.getObjectsInBoxByBimtile(a,e,t,l,u)}}return Object.keys(a)}},r.IntersectContext=class{constructor(){this.scene=null,this.camera=null,this.octreeRoots=null,this.octantMap=null,this.mouse=new THREE.Vector2}},r.IntersectHelper=class{constructor(e){this.viewer=e,this.filter=e.getFilter(),this.raycaster=new r.Raycaster,this.lastIntersect=null,this.highPriorities=[r.ObjectGroupType.EXTRUDEBODYMANAGER],this._ground=null,this._pickedLocalPos=null,this._pickedWorldPos=null}destroy(){this.viewer=null,this.filter=null,this.raycaster=null,this.lastIntersect=null,this.highPriorities=null,this._ground=null,this._pickedLocalPos=null,this._pickedWorldPos=null}defaultIntersect(e,t,i,n,a,s){if(e.visible||a){var o=[];e.raycast(this.raycaster,o,{unitScale:s});var l=[];if(o.length>0)for(var d=0;d<o.length;d++)o[d].distance<=i.far&&o[d].distance>=i.near&&(e.name==r.GlobalData.TilePlaneGroupName||!this.viewer.clipPoint(o[d].point))&&null!=o[d]&&l.push(o[d]);return n?l:(l.sort((function(e,t){return e.distance-t.distance})),l.length>0?l[0]:null)}}intersectMeshesWithDistance(e,t,i){const{pickable:n,distanceScope:a,isExploded:s,bIsGetAllIntersects:o,modelTransform:l,modelId:d,hitBox:h}=i;if(!t||!t.mesh)return null;var c,u=r.Utils.MinusEpsilon,p=this.raycaster,m=[];const f=this.viewer.modelManager,g=f.getModel(d),v=g.filter,y=v._hasVisibleFilter(),M=v._hasPickableFilter(),E=g.getUnit()===r.EnumLengthlUnits.Meter?.001:1,x=r.GlobalData.LineSelectRange/2*E;var _=function(e,t){var i=f.isHiddenSourceObjectUserId(e.userId,d);if(t){if(y&&!v._isVisible(e)||M&&!v._isPickable(e)||i)return!0}else if(y&&!v._isVisible(e)||i)return!0;return!1};1==this.byGravity?a.near=0:a.near+=u;var b,I,T=t.info,S=t.mesh,C=[],w=this.viewer.modelManager.getMatrixWorldGlobal();if(s){function G(e,t){if(t.push(e),e.childOctants)for(var i=0,r=e.childOctants.length;i<r;i++)G(e.childOctants[i],t)}for(b=0,I=e.length;b<I;b++)G(e[b],C)}else for(b=0,I=e.length;b<I;b++)p.intersectOctantForNode(e[b],C);for(b=0,I=C.length;b<I;b++){var R=T[C[b].octantId];if(R)for(var B=0,A=R.length;B<A;B++){var P=R[B];if(!_(P,n)){var L=P.boundingBox.clone();if("string"==typeof P.nodeId&&P.nodeId.indexOf("line")>-1&&L.expandByScalar(x),L.applyMatrix4(l),L.applyMatrix4(w),!((c=p.ray.intersectBoxWithDistance(L))<a.near||c>a.far)){delete P.isExploded,s&&(P.isExploded=!0);var O=S[r.ModelView.BaseDescriptor.getMeshIdFromOctantMap(P)];if(O)for(var D=0,N=O.length;D<N;D++)m.push({object:O[D],distance:c,nodeInfo:P,modelTransform:l})}}}}if(m.sort((function(e,t){return e.distance-t.distance})),h){let V=p.ray.origin.clone(),z=p.ray.direction.clone();if(0===m.length)return null;let j=m[0].distance;return j=0===j?3:j,m[0].point=V.add(z.multiplyScalar(j)),m[0].object=m[0].object.object,m[0]}var H=[];const U=v.getLocalClippingList();for(b=0;b<m.length;b++)m[b].distance>a.far||m[b].distance<a.near||m[b].object.raycast(p,m[b].nodeInfo,a,this.viewer,H,o,U,m[b].modelTransform);if(H.sort((function(e,t){return e.distance-t.distance})),o){var F=[];for(b=0,I=H.length;b<I;b++){var k=H[b];F.push({object:k.object,distance:k.distance,matrix:k.object.matrix,userId:k.userId,face:k.face,point:k.point})}return F}return H.length>0?H[0]:null}intersect(e,t,i,n,a){var s=this.raycaster;if(n=!0===n,a=!0===a,null===t)s.setFromCamera(e.mouse,e.camera);else{var o=t.origin,l=t.direction;s.set(o,l)}s.camera=e.camera,s.viewportSize=e.viewportSize;var d={near:0,far:1/0};e.scene.shrinkScopeByClipPlane(s,d);var h=[],c=e.scene.getObjectGroups();this.viewer.terrainOperationManager;const u=this.viewer.holesManager;var p=new THREE.Vector2;this.viewer.cameraControl.mapViewportToWindow(e.mouse.x,e.mouse.y,p);let m=!1;u.pickExcavation(p)&&(m=!0);for(var f=0;f<c.length;f++){if(!c[f].isPickable()||0===c[f].children.length)continue;if(m)break;var g=null,v=e.scene.getObjectGroupType(c[f].name);if(this.highPriorities.indexOf(v.groupType)>-1){let e=this.defaultIntersect(c[f],i,d,!0,!0);e=e.filter((e=>{if(!0===e.object.isMesh)return e})),e.sort(((e,t)=>e.distance-t.distance)),(g=e[0])&&(g.databagId=v.databagId,g.objectType=c[f].pickableType,g.hoverEnabled=c[f].hoverEnabled,h.push(g));continue}const t=this.viewer.modelManager;let o=t.getModel(v.databagId),l=o?o.getTransformMatrix():new THREE.Matrix4,u=!1;switch(u=!!(o&&o.id&&t.explosionManager.isExploded(o.id)),v.groupType){case r.ObjectGroupType.MODEL:var y=v.databagId;if(e.octreeRoots[y]&&e.octantMap[y]){const t={pickable:i,distanceScope:d,isExploded:u,bIsGetAllIntersects:a,modelTransform:l,modelId:o.id,hitBox:n};g=this.intersectMeshesWithDistance(e.octreeRoots[y],e.octantMap[y],t)}break;case r.ObjectGroupType.GEOMETRY:for(var y in e.octreeRoots){const t={pickable:i,distanceScope:d,isExploded:u,bIsGetAllIntersects:a,modelTransform:l,modelId:y,hitBox:n};g=this.intersectMeshesWithDistance(e.octreeRoots[y],e.octantMap[y],t)}break;case r.ObjectGroupType.BIMTILESGROUP:if(o){const h=o.config.metadata.content,p=o.config.metadata.enableSelect;if(r.BimTilesVersionControl.isVersion_3(o.dataVersion)){const r={pickable:i,distanceScope:d,isExploded:u,bIsGetAllIntersects:a,modelTransform:l,hitBox:n,raycaster:s,inverseMatrixGlobal:this.viewer.getScene().getInverseMatrixGlobal(),modelManager:t},h=this.viewer.getRenderer(),c=o.objectGroup.visible,p=o.objectGroup.parent.children,m=p.length;let f=new Array(E);for(let e=0;e<m;++e)f[e]=p[e].visible,p[e].visible=!1;o.objectGroup.visible=c,g=o.pickHelper.render(h,e.scene,e.camera,e.pointer,r);for(let e=0;e<m;++e)p[e].visible=f[e];f=null}else if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[h]||p){const e={pickable:i,distanceScope:d,isExploded:u,bIsGetAllIntersects:a,modelTransform:l,hitBox:n};g=this.intersectBimTile(o,e)}else g=this.defaultIntersect(c[f],i,d);if(g){const e=o.tilesLoader.tileReader;if(Array.isArray(g))for(var M of g){const t=e.getUserIdByIndex(M.userId);M.userId=t}else{const t=e.getUserIdByIndex(g.userId);g.userId=t}}}break;default:let h=1;const p=this.viewer.getSceneUnit();p&&p===r.EnumLengthlUnits.Meter&&(h=.001),g=this.defaultIntersect(c[f],i,d,void 0,void 0,h)}if(g)if(Array.isArray(g))for(var M of g)M.databagId=v.databagId,M.objectType=c[f].pickableType,M.hoverEnabled=c[f].hoverEnabled,o&&o.id&&(M.modelId=o.id),h.push(M);else g.databagId=v.databagId,g.objectType=c[f].pickableType,g.hoverEnabled=c[f].hoverEnabled,o&&o.id&&(g.modelId=o.id),h.push(g)}h.sort((function(e,t){return e.distance-t.distance}));var E=h.length;if(E>0){let e=null;for(var x=0;x<E;++x){var _=(g=h[x]).object;if(null==_&&g.face)return this.lastIntersect={intersect:g,pickable:i},g;if(_.geometry){if(g.objectType===r.PICKABLETYPE.Marker3d?g.userId=g.id:void 0===g.userId&&(g.userId=_.userId||_.name),void 0!==_.databagId&&(g.databagId=_.databagId),void 0!==_.fileId&&(g.fileId=_.fileId),e)return e.intersectWithoutMap=g,e;if(0!=x||a||(this.lastIntersect={intersect:g,pickable:i}),g.objectType===r.PICKABLETYPE.Map&&x<E-1)e=g;else if(!a)return g}}return h}return this.lastIntersect=null,null}_intersectOctantForNodeByBox(e,t,i){var r=new THREE.Box3;!function t(n){var a,s;if(r.set(n.boundingBoxWorld.min,n.boundingBoxWorld.max),e.intersectsBox(r)&&(i.push(n),n.childOctants))for(a=0,s=n.childOctants.length;a<s;a++)t(n.childOctants[a])}(t)}intersectMeshByBox(e,i,a,s,o,l){if(!i||!i.mesh)return null;r.Utils.MinusEpsilon,this.raycaster;var d=[],h=this.filter,c=h._hasVisibleFilter(),u=(h._hasPickableFilter(),this.viewer.modelManager);const p=t.copy(s).invert(),m=n.copy(o).applyMatrix4(p);var f,g,v=function(e){var t=u.isHiddenSourceObjectUserId(e.userId,l);return!!(c&&!h._isVisible(e)||t)},y=i.info,M=i.mesh,E=[];this.viewer.modelManager.getMatrixWorldGlobal();if(a){function B(e,t){if(t.push(e),e.childOctants)for(var i=0,r=e.childOctants.length;i<r;i++)B(e.childOctants[i],t)}for(f=0,g=e.length;f<g;f++)B(e[f],E)}else{var x=m;for(f=0,g=e.length;f<g;f++)this._intersectOctantForNodeByBox(x,e[f],E)}for(f=0,g=E.length;f<g;f++){var _=y[E[f].octantId];if(_)for(var b=0,I=_.length;b<I;b++){var T=_[b];if(v(T))continue;var S=T.boundingBox.clone();if(S.applyMatrix4(s),o.intersectsBox(S)){var C=M[r.ModelView.BaseDescriptor.getMeshIdFromOctantMap(T)];if(C)for(var w=0,R=C.length;w<R;w++)C[w].object&&!0===C[w].object.isLine||C[w].intersectByBox(m,d,T)&&(d[d.length-1].userId=T.userId)}}}return d}intersectByBox(e,t,i){var n={},a=e.scene.getObjectGroups(),s=this.viewer.terrainOperationManager,o=new THREE.Vector2;this.viewer.cameraControl.mapViewportToWindow(e.mouse.x,e.mouse.y,o);for(var l=0;l<a.length;l++){if(!a[l].isPickable()||0===a[l].children.length)continue;if(a[l].name==r.GlobalData.TilePlaneGroupName&&s.pickExcavation(o))continue;var d=null,h=e.scene.getObjectGroupType(a[l].name);const u=this.viewer.modelManager;let p=u.getModel(h.databagId),m=p?p.getTransformMatrix():new THREE.Matrix4,f=!1;switch(f=!!(p&&p.id&&u.explosionManager.isExploded(p.id)),h.groupType){case r.ObjectGroupType.MODEL:var c=h.databagId;if(e.octreeRoots[c]&&e.octantMap[c]){if(!(d=this.intersectMeshByBox(e.octreeRoots[c],e.octantMap[c],f,m,t,p?p.id:void 0)))break;d.forEach((e=>{p&&p.id&&(e.modelId=p.id),n[e.userId]=!0}))}break;case r.ObjectGroupType.GEOMETRY:for(var c in e.octreeRoots){if(!(d=this.intersectMeshByBox(e.octreeRoots[c],e.octantMap[c],f,m,t,p?p.id:void 0)))break;d.forEach((e=>{p&&p.id&&(e.modelId=p.id),n[e.userId]=!0}))}break;case r.ObjectGroupType.BIMTILESGROUP:if(p){const e=p.config.metadata.content,a=p.config.metadata.enableSelect;if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[e]||a){const e={pickable:!1,distanceScope:{near:0,far:1/0},isExploded:f,bIsGetAllIntersects:!0,modelTransform:m,intersectBox:t,intersectSphereHit:i};d=r.BimTilesVersionControl.isVersion_3(p.dataVersion)?this.intersectBimTileV3(p,e):this.intersectBimTile(p,e)}if(!d)break;const s=p.tilesLoader.tileReader;d.forEach((e=>{p&&p.id&&(e.modelId=p.id);const t=s.getUserIdByIndex(e.userId);n[t]=!0}))}}}return Object.keys(n)}getObjectsByClientCoordinates(e){var t=this.viewer.cameraControl.getIntersectContext(e),i=this.raycaster;return i.setFromCamera(t.mouse,t.camera),i.camera=t.camera,i.viewportSize=t.viewportSize,this.getObjectsByRaycaster(t,i)}getObjectsByRaycaster(e,t,i){this.raycaster=t,t.camera=e.camera,t.viewportSize=e.viewportSize;var n={near:i?0:e.camera.near,far:Infinity};e.scene.shrinkScopeByClipPlane(t,n);for(var a=[],s=e.scene.getObjectGroups(),o=0;o<s.length;o++){if(!s[o].isPickable()||0===s[o].children.length)continue;var l=[],d=e.scene.getObjectGroupType(s[o].name);const t=this.viewer.modelManager;let i=t.getModel(d.databagId),c=i?i.getTransformMatrix():new THREE.Matrix4,u=!1;switch(u=!!(i&&i.id&&t.explosionManager.isExploded(i.id)),d.groupType){case r.ObjectGroupType.MODEL:var h=d.databagId;if(e.octreeRoots[h]&&e.octantMap[h]){const t={pickable:!1,distanceScope:n,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c,modelId:i.id};null!=(l=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],t))&&(l.forEach((e=>i&&i.id&&(e.modelId=i.id))),a=a.concat(l))}break;case r.ObjectGroupType.GEOMETRY:for(var h in e.octreeRoots){const t={pickable:!1,distanceScope:n,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c,modelId:h};null!=(l=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],t))&&(l.forEach((e=>i&&i.id&&(e.modelId=i.id))),a=a.concat(l))}break;case r.ObjectGroupType.BIMTILESGROUP:const t=i.config.metadata.content;if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[t]){const e={pickable:!0,distanceScope:n,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c};let t=(l=r.BimTilesVersionControl.isVersion_3(i.dataVersion)?this.intersectBimTileV3(i,e):this.intersectBimTile(i,e)).length;for(let e=0;e<t;++e){let t=l[e];const r=i.tilesLoader.tileReader.getUserIdByIndex(t.userId);t.userId=r}}else l=this.defaultIntersect(s[o],!1,n,!0);null!=l&&(l.forEach((e=>i&&i.id&&(e.modelId=i.id))),a=a.concat(l));break;default:null!=(l=this.defaultIntersect(s[o],!1,n,!0))&&(l.forEach((e=>i&&i.id&&(e.modelId=i.id))),a=a.concat(l))}}a.sort((function(e,t){return e.distance-t.distance}));let c=new Map;for(let e of a){const t=`${e.modelId}${e.userId}`;c.has(t)||c.set(t,e)}return a=[...c.values()]}hitTest(e){var t=this.intersect(e,null,!1);return null!==t?t.point:null}hitTestByBox(e){const t=this.intersect(e,null,!1,!0);return null!==t?t.point:null}pick(e,t,i){var r=this.intersect(e,null,!0,null,i);return t&&t(r),r}pickGlobe(e,t){var i=this.raycaster,n=e.scene.getObjectGroup(r.GlobalData.TilePlaneGroupName);if(!n||!n.visible)return null;i.setFromCamera(e.mouse,e.camera),i.camera=e.camera,i.viewportSize=e.viewportSize;var a={near:0,far:1/0};e.scene.shrinkScopeByClipPlane(i,a);var s=[];n.raycast(this.raycaster,s),s.sort((function(e,t){return e.distance-t.distance}));var o=s.length>0?s[0]:null;return o&&(o.objectType=n.pickableType,o.hoverEnabled=n.hoverEnabled),o}pickGround(t,i){const r=t.viewer.ground;if(!r)return console.log("there is no ground in current viewer"),null;if(!t.camera)return console.log("camera have not been initialized"),null;const n=this.raycaster;let a;n.setFromCamera(t.mouse,t.camera),n.camera=t.camera,n.viewportSize=t.viewportSize;const s=r.intersect(n.ray);if(s){const i=t.scene.getRawMatrixGlobal();this._pickedWorldPos||(this._pickedWorldPos=new THREE.Vector3),e.copy(i).invert(),this._pickedWorldPos.setX(s.x),this._pickedWorldPos.setY(s.y),this._pickedWorldPos.setZ(s.z),this._pickedWorldPos.applyMatrix4(e),a={point:s,worldPosition:this._pickedWorldPos.setZ(r.elevation),pickFromReferencePlane:!0}}return i&&i(a),a}getIntersectByRay(e,t){return this.intersect(e,t,!0)}intersectBimTile(e,s){const{pickable:o,distanceScope:l,isExploded:d,bIsGetAllIntersects:h,modelTransform:c,intersectBox:u,intersectSphereHit:p,hitBox:m}=s;let f=this.raycaster;const g=e.getDescriptor(),v=this.viewer.modelManager.getMatrixWorldGlobal(),y=this.viewer.getScene().getInverseMatrixGlobal(),M=t.copy(c).invert(),E=this.viewer.modelManager,x=e.getFilter(),_=x._hasVisibleFilter(),b=x._hasPickableFilter(),I=e.getUnit()===r.EnumLengthlUnits.Meter?.001:1;let T=new THREE.Vector3,S=u?function(e,t,r){let a=n.copy(e);return a.applyMatrix4(t),p?(u.getBoundingSphere(i),i.intersectsBox(a)?0:-1):u.intersectsBox(a)?0:-1}:function(e,t,i,r,a){let s=n.copy(e);return!0===r&&(s.getSize(T),T.x<.001||T.y<.001?s.expandByScalar(a):(s.min.z-=a,s.max.z+=a)),s.applyMatrix4(t),s.applyMatrix4(i),f.ray.intersectBoxWithDistance(s)},C=e=>!e||!e.parent||!1===e.visible||!1===e.parent.visible;function w(t,i){let r=E.isHiddenSourceObjectUserId(t.userId,e.id);if(i){if(_&&!x._isVisible(t)||b&&!x._isPickable(t)||r)return!0}else if(_&&!x._isVisible(t)||r)return!0;return!1}if(!e.isUserIdDataReady())return h?[]:void 0;const R=e.getBoundingBoxWorld();R.applyMatrix4(v);if(f.ray.intersectBoxWithDistance(R)<0&&!d)return h?[]:void 0;const B=e.tilesLoader.tileReader.searchTreeManager;let A=B.intersect(f,u,y,c,v,d),P=[];for(const t in A)g.getNodeInfoByUserIdCallback(t,(i=>{const r=i.nodeInfo;if(w(r,o))return;let n=S(r.boundingBox,c,v,B.is2D,B.lineBoxScale);if(n<0||n>l.far)return;if(0==i.instanceOrNot){const i=r.parent,a=e.tilesLoader.getMeshNodeById(i);if(C(a))return;const s=a.indexGroups.get(parseInt(t)).get(r.nodeId);if(!s)return;const o=s;return o.userId=t,void P.push({meshNode:a,distance:n,nodeInfo:o,meshId:i})}const a=r.nodeId,s=e.tilesLoader.getInstanceMeshNodeById(a);if(s&&void 0!==r.matrix)for(const[e,t]of s){const e=t.mesh;if(C(e))return;let i=Object.create(r),s=i.matrix.clone();i.matrix=s,P.push({meshNode:e,distance:n,nodeInfo:i,meshId:a})}}));if(P.sort(((e,t)=>e.distance-t.distance)),m){let e=f.ray.origin.clone(),t=f.ray.direction.clone();if(0===P.length)return null;let i=P[0].distance;return i=0===i?3:i,P[0].point=e.add(t.multiplyScalar(i)),P[0].object=P[0].meshNode,P[0]}let L=[],O=this;const D=e.filter.getLocalClippingList();const N=u?a.copy(u).applyMatrix4(M):void 0;let H=u?function(e,t,i,r){return N&&e.intersectByBox(N,t,i,r),t}:function(t,i,r,n,a,s){t.raycastByIndices(f,i,r,n,I,s);const o=e.tilesLoader.tileReader.getUserIdByIndex(a);return e.filter._hasLocalClipping()&&!D.get(o)||(i=i.filter((e=>!O.viewer.clipPoint(e.point)&&e))),i.sort(((e,t)=>e.distance-t.distance)),i};for(let e=0;e<P.length&&null!==P[e];e++){let t=[],i=P[e].nodeInfo,r=null,n=i;if(i.instanceOrNot&&(r=i.matrix,n=null),n&&(delete n.isExploded,d&&(n.isExploded=!0)),t=H(P[e].meshNode,t,n,r,i.userId,c),0===t.length)continue;if(t[0].userId=i.userId,t[0].indexInfo=i,t[0].meshId=P[e].meshId,L.push(t[0]),h)continue;let a=t[0].distance;t.map((e=>{e.distance<a&&(a=e.distance)}));for(let t=e+1;t<P.length&&null!==P[t];t++)P[t].distance<=a||(P[t]=null)}return L.sort(((e,t)=>e.distance-t.distance)),h?L:L[0]}intersectBimTileV3(e,s){const{pickable:o,distanceScope:l,isExploded:d,bIsGetAllIntersects:h,modelTransform:c,intersectBox:u,intersectSphereHit:p,hitBox:m}=s;let f=this.raycaster;const g=e.getDescriptor(),v=this.viewer.modelManager.getMatrixWorldGlobal(),y=this.viewer.getScene().getInverseMatrixGlobal(),M=t.copy(c).invert(),E=this.viewer.modelManager,x=e.getFilter(),_=x._hasVisibleFilter(),b=x._hasPickableFilter(),I=e.getUnit()===r.EnumLengthlUnits.Meter?.001:1,T=f.ray.clone().applyMatrix4(y).applyMatrix4(t);let S=new THREE.Vector3,C=u?function(e,t,r){let a=n.copy(e);return a.applyMatrix4(t),p?(u.getBoundingSphere(i),i.intersectsBox(a)?0:-1):u.intersectsBox(a)?0:-1}:function(e,t,i,r,a){let s=n.copy(e);return!0===r&&(s.getSize(S),S.x<.001||S.y<.001?s.expandByScalar(a):(s.min.z-=a,s.max.z+=a)),T.intersectBoxWithDistance(s)};function w(t,i){let r=E.isHiddenSourceObjectUserId(t.userId,e.id);if(i){if(_&&!x._isVisible(t)||b&&!x._isPickable(t)||r)return!0}else if(_&&!x._isVisible(t)||r)return!0;return!1}if(!e.isUserIdDataReady())return h?[]:void 0;const R=e.getBoundingBoxWorld();R.applyMatrix4(v);if(f.ray.intersectBoxWithDistance(R)<0)return h?[]:void 0;let B=[];if(e._tileset._selectedTiles.map((t=>{let i=n.copy(t.boundingBox);if(u){if(i.applyMatrix4(c),!u.intersectsBox(i))return}else if(T.intersectBoxWithDistance(i)<0)return;const a=t.content.meshes;a.children.forEach((i=>{if(0==t.isInstanceTile){const t=i.indexGroups;for(const[n,a]of t){if(w(g.userIdInfoMap.get(n),o))continue;const t=e.getBoundBoxByUserIndex(n);let s=C(t,c,v,e.is2D,r.GlobalData.LineSelectRange/2*.1);s<0||s>l.far||(a.userId=n,B.push({meshNode:i,distance:s,nodeInfo:a,meshId:i.name}))}}else{t.instanceInfo.entityInfoArray.forEach(((i,n)=>{const s=i.userID,d=g.userIdInstanceInfoMap.get(s);if(w(d,o))return;const h=e.getBoundBoxByUserIndex(s);let u=C(h,c,v,e.is2D,r.GlobalData.LineSelectRange/2*.1);if(u<0||u>l.far)return;let p=i.entityMatrix.clone(),m=Object.create(d);m.matrix=p,B.push({meshNode:a.children[0],distance:u,nodeInfo:m,meshId:`${t.tileId}_0`})}))}}))})),B.sort(((e,t)=>e.distance-t.distance)),m){let e=f.ray.origin.clone(),t=f.ray.direction.clone();if(0===B.length)return null;let i=B[0].distance;return i=0===i?3:i,B[0].point=e.add(t.multiplyScalar(i)),B[0].object=B[0].meshNode,B[0]}let A=[],P=this;const L=u?a.copy(u).applyMatrix4(M):void 0;let O=u?function(e,t,i,r){return L&&e.intersectByBox(L,t,i,r),t}:function(e,t,i,r,n){return e.raycastByIndices(f,t,i,r,I,n),(t=t.filter((e=>!P.viewer.clipPoint(e.point)&&e))).sort(((e,t)=>e.distance-t.distance)),t};for(let e=0;e<B.length&&null!==B[e];e++){let t=[],i=B[e].nodeInfo,r=null,n=i;if(i.instanceOrNot&&(r=i.matrix,n=null),n&&(delete n.isExploded,d&&(n.isExploded=!0)),t=O(B[e].meshNode,t,n,r,c),0===t.length)continue;if(t[0].userId=i.userId,t[0].indexInfo=i,t[0].meshId=B[e].meshId,A.push(t[0]),h)continue;let a=t[0].distance;t.map((e=>{e.distance<a&&(a=e.distance)}));for(let t=e+1;t<B.length&&null!==B[t];t++)B[t].distance<=a||(B[t]=null)}return A.sort(((e,t)=>e.distance-t.distance)),h?A:A[0]}}})(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Box3,l=new THREE.Vector3,d=null,h=null,c=null,u=new Array(1e3);const p={endPoint:{name:"EndPoint",order:0},intersectionPoint:{name:"IntersectionPoint",order:1},midPoint:{name:"MidPoint",order:2}};let m=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter}),f=null;function g(e,a,s){if(r.Math.equalsEpsilonVec3(e,a,r.Math.EPSILON10))return e.clone();t.subVectors(a,e),i.subVectors(s,e);var o=t.dot(i);if(o<0)return e;var l=t.dot(t);return o>l?a:(o/=l,n.copy(e),n.addScaledVector(t,o),n)}function v(e){l.copy(e),l.applyMatrix4(c);var t=.5*(l.x-d.x)*h.width,i=.5*(l.y-d.y)*h.height;return Math.sqrt(t*t+i*i)}function y(e,t,i){return Math.abs(e-t)<=i}function M(e,t,i){return e===t||y(e.x,t.x,i)&&y(e.y,t.y,i)&&y(e.z,t.z,i)}function E(e,t,i,r,n){let o=1/0,l=1/0,d={};for(let h=0;h<t.length;h+=2){a.set(e[3*t[h]],e[3*t[h]+1],e[3*t[h]+2]),a.applyMatrix4(r),s.set(e[3*t[h+1]],e[3*t[h+1]+1],e[3*t[h+1]+2]),s.applyMatrix4(r);let c=g(a,s,i),p=v(c);if(p>n)continue;let m={};m.point1=a.clone(),m.point2=s.clone(),m.length=p,u.push(m),p<o&&(d.line={pointA:m.point1,pointB:m.point2,point:c.clone()},d.lineDistance=p,o=p),p=v(m.point1),p<l&&p<n&&(d.point=m.point1,d.pointDistance=p,l=p),p=v(m.point2),p<l&&p<n&&(d.point=m.point2,d.pointDistance=p,l=p)}return d}r.PickHelper=class{constructor(e){this.cameraControl=e,this.scene=e.scene,this.timerId=null,this.lastIntersected=null,this._pickObjectByHover=!1}destroy(){this.cameraControl=null,this.scene=null,this.lastIntersected=null,this.timerId&&(clearTimeout(this.timerId),this.timerId=null)}click(e,t,i){var r=this;function n(){t&&!1===t.pickable&&(t=null),r.handleMousePick(e,!1,t),r.clearDelayClickState()}this.setDelayClickState(!0),e.button!==THREE.MOUSE.RIGHT?i?n():(this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(n,500)):n()}doubleClick(e){e.preventDefault(),this.timerId&&clearTimeout(this.timerId),this.handleMousePick(e,!0,null),this.clearDelayClickState()}handleMousePick(e,t,i){if(this._canPick()||e.button!==THREE.MOUSE.LEFT){var n=this.cameraControl,a=n.viewer.modelManager.sceneState,s=new THREE.Vector2(e.clientX,e.clientY),o=n.screenToCanvas(e.clientX,e.clientY),l=n.viewer.modelManager,d=null;if(i)i.pickable&&(d=i.intersect);else{var h=n.getIntersectContext(s);d=n.intersector.pick(h,null)}if(d){var c=d.userId;if(r.Utils.isMobileDevice()&&(n.pivot=d.point),this.scene.intersectToWorld(d,n.viewer),d.intersectWithoutMap&&this.scene.intersectToWorld(d.intersectWithoutMap,n.viewer),d.innnerDebugging=e.altKey,d.cx=s.x,d.cy=s.y,d.face&&d.face.normal){var u=d.face.normal;for(var p in u)u[p]=u[p]==-u[p]?Math.abs(u[p]):u[p]}if(e.button!==THREE.MOUSE.RIGHT)if(t)a.clearSelection(),r.GlobalData.EnableDemolishByDClick?(n.viewer.isEnabledDoubleClick&&a.setSelection([c],d.databagId),g(d,!0),n.updateView(!0)):(a.setSelection([c],d.databagId),n.fitAndRotateBySelection(),g(d,!0));else{const t=a.isSelected(c,d.databagId);if(e.ctrlKey)t?a.removeSelection([c],d.databagId):a.addSelection([c],d.databagId);else if(t)n.pivot=null,a.clearSelection();else{const e=d.objectType===r.PICKABLETYPE.Map;a.clearSelection(void 0,e),a.setSelection([c],d.databagId)}g(d,!0),n.updateView(!0)}else g(d,!1)}else{n.pivot=null;var m=a.hasSelection();if(e.ctrlKey)return;if(e.button!=THREE.MOUSE.RIGHT&&m&&(a.clearSelection(),n.updateView(!0)),i&&!i.pickable)(d=i.intersect).cx=s.x,d.cy=s.y,g(d,!1);else{var f=n.getIntersectContext(s);n.viewer.ground?(f.viewer=n.viewer,g(d=n.intersector.pickGround(f))):g(null)}}}function g(i,n){var a=null;if(i&&i.objectType==r.PICKABLETYPE.Room){if(!i.face)return;var s=i.face.contourIndex,d=i.object.geometry.contour;a=s?{startPoint:d[s.st],endPoint:d[s.ed]}:null}const h=e=>e?{selectedObjectId:r.Utils.isDefined(e.userId)?e.userId:null,objectType:r.Utils.isDefined(e.objectType)?e.objectType:null,selectable:r.Utils.isDefined(e.selectable)?n:null,modelId:r.Utils.isDefined(e.databagId)?e.databagId:null,fileId:r.Utils.isDefined(e.fileId)?e.fileId:null,unit:r.Utils.isDefined(e.unit)?e.unit:null,worldPosition:r.Utils.isDefined(e.worldPosition)?e.worldPosition:null,worldBoundingBox:r.Utils.isDefined(e.worldBoundingBox)?e.worldBoundingBox:null,point:r.Utils.isDefined(e.point)?e.point:null,innnerDebugging:r.Utils.isDefined(e.innnerDebugging)?e.innnerDebugging:null,normal:r.Utils.isDefined(e.face)&&r.Utils.isDefined(e.face.normal)?e.face.normal:null,boundaryPoints:r.Utils.isDefined(e.boundaryPoints)?a:null}:null;if(i&&i.modelId&&i.point){let e=l.getModel(i.modelId);e&&e.processBimtileUnit&&(i.point=e.processBimtileUnit(i.point))}l.dispatchEvent({type:i&&i.objectType===r.PICKABLETYPE.Marker3d?r.EVENTS.ON_CLICK_MARKER3D_PICK:r.EVENTS.ON_CLICK_PICK,event:e,doubleClick:t,canvasPos:{x:o.x,y:o.y},intersectInfo:h(i),intersectInfoWithoutMap:i&&h(i.intersectWithoutMap)})}}handleMouseMeasure(e,t,i,n){if(this._canPick()){var a=this.cameraControl,s=(a.scene,n||r.EVENTS.ON_MEASURE_PICK),o={x:e.clientX,y:e.clientY},l=this.pickToPoint(o,5);null!=l?(t&&i&&i.copy(l.pickPoint),d(l.pickPoint,l.pickLine,l.pickPlane,l.face?l.face.normal:null,l.userId,l.modelId,l.pointType)):d(null,null,!1)}function d(i,r,n,o,l,d,h){var c=a.viewer.modelManager;if(null!=i){var u=a.scene.drawingToWorld(i);i.copy(u)}if(null!=r){var p=a.scene.drawingToWorld(r[0]),m=a.scene.drawingToWorld(r[1]);r[0].copy(p),r[1].copy(m)}c.dispatchEvent({type:s,event:e,pick:t,pickPoint:i,pickLine:r,pickPlane:n,normal:o,userId:l,modelId:d,pointType:h})}}handleMouseMovePick(e){if(!r.GlobalData.MouseMovePick)return;if(!this._canPick())return;const t=this.cameraControl,i=t.screenToCanvas(e.clientX,e.clientY),n=this,a=new THREE.Vector2(e.clientX,e.clientY),s=t.getIntersectContext(a);if(s.viewer=t.viewer,s.needsObject=void 0,this._pickObjectByHover){if(this.lastIntersected)o(this.lastIntersected,!0,!1);else if(t.viewer.ground){o(t.intersector.pickGround(s),!1,!0)}}else s.needsObject=!0,t.intersector.pick(s,(e=>{if(e)n.scene.intersectToWorld(e,t.viewer),o(e,!0,!1);else if(t.viewer.ground){o(t.intersector.pickGround(s),!1,!0)}}));function o(n,a,s){if(null==n)return;const o=t.viewer.modelManager,l={type:r.EVENTS.ON_MOUSE_MOVE_PICK,event:e,selectable:a,canvasPos:{x:i.x,y:i.y},intersectInfo:{}};if(l.intersectInfo.pickFromReferencePlane=s,void 0!==n.userId&&(l.intersectInfo.selectedObjectId=n.userId),void 0!==n.objectType&&(l.intersectInfo.objectType=n.objectType),void 0!==n.databagId&&(l.intersectInfo.modelId=n.databagId),void 0!==n.worldPosition&&(l.intersectInfo.worldPosition=n.worldPosition),void 0!==n.worldBoundingBox&&(l.intersectInfo.worldBoundingBox=n.worldBoundingBox),void 0!==n.point&&(l.intersectInfo.point=n.point),void 0!==n.innnerDebugging&&(l.intersectInfo.innnerDebugging=n.innnerDebugging),l.intersectInfo.fileId=r.Utils.isDefined(n.fileId)?n.fileId:null,l.intersectInfo.unit=r.Utils.isDefined(n.unit)?n.unit:null,l.intersectInfo.modelId){let e=o.getModel(l.intersectInfo.modelId);e&&e.processBimtileUnit&&(l.intersectInfo.point=e.processBimtileUnit(l.intersectInfo.point))}o.dispatchEvent(l)}this._pickObjectByHover=!1}isAxisGridHoverEnabled(){if(0==this.scene.hasObjectGroup(r.ObjectGroupType.AXISGRIDMANAGER))return!1;var e=0,t=this.scene.axisGridEnableHover;if(t){for(var i in this.scene.axisGridManagerMap){e+=r.AxisGridManager.getInstance(this.scene,i).getElements().length}0===e&&(t=!1)}return t}handleMouseHover(e){if(this._canPick()){var t=this.cameraControl,i=t.viewer.modelManager.sceneState,n=this;if(this.isAxisGridHoverEnabled()){var a=this.scene.getRawMatrixGlobal(),s=new THREE.Vector2(e.clientX,e.clientY),o=t.getRaycaster(s.x,s.y),l=[];for(var d in this.scene.axisGridManagerMap){var h=r.AxisGridManager.getInstance(this.scene,d),c=h.getIntersectPoints(o,a);h.snapOnFloors(c).forEach((e=>{e.modelId=d,l.push(e)}))}t.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_AXIS_GRID_HOVER,snaps:l})}if(r.GlobalData.Hover||function(){let e=!1;return n.scene.children[0].children.some((t=>{if(t.name&&t.name.indexOf(r.ObjectGroupType.MARKER3D)>=0&&t.children.length>0)return e=!0})),e}()){var u=t.screenToCanvas(e.clientX,e.clientY),p=new THREE.Vector2(e.clientX,e.clientY),m=t.getIntersectContext(p);t.intersector.pick(m,(function(a){function s(e){if(e.objectType===r.PICKABLETYPE.Marker3d)e.object.setAttributeSize(e.index,e.object.initSize[e.index]||e.currentSize);else i.clearHover()}n._pickObjectByHover=!0;let o=t.viewer.domElement.getBoundingClientRect(),l=!1;if(e.clientX>=o.left&&e.clientX<=o.right&&e.clientY>=o.top&&e.clientY<=o.bottom&&(l=!0),a&&l){var d=r.GlobalData.Hover||a.hoverEnabled;n.lastIntersected&&(n.lastIntersected.userId!=a.userId&&s(n.lastIntersected),n.lastIntersected.hoverEnabled&&f(null)),d?(n.lastIntersected&&n.lastIntersected.userId==a.userId||(!function(e){if(e.objectType===r.PICKABLETYPE.Marker3d){var t=e.object;e.currentSize=t.getAttributeSize(e.index),t.initSize[e.index]=t.initSize[e.index]||e.currentSize,t.getAttributeHoverAnimation(e.index)&&e.currentSize===t.initSize[e.index]&&t.setAttributeSize(e.index,Math.floor(1.5*e.currentSize))}else i.setHoverId(e.userId)}(a),n.lastIntersected=a),f(a,!0)):n.lastIntersected=a,t.updateHighlight()}else n.lastIntersected&&(s(n.lastIntersected),n.lastIntersected=null,f(null),t.updateHighlight())}))}}function f(i,a){var s=t.viewer.modelManager;if(null!=i&&n.scene.intersectToWorld(i,t.viewer),i&&i.modelId&&i.point){let e=t.viewer.modelManager.getModel(i.modelId);e&&e.processBimtileUnit&&(i.point=e.processBimtileUnit(i.point))}s.dispatchEvent({type:r.EVENTS.ON_HOVER_PICK,event:e,canvasPos:{x:u.x,y:u.y},intersectInfo:i?{selectedObjectId:i.userId,objectType:i.objectType,selectable:a,modelId:i.databagId,fileId:i.fileId,unit:i.unit,worldPosition:i.worldPosition,worldBoundingBox:i.worldBoundingBox,point:i.point,innnerDebugging:i.innnerDebugging}:null})}}_canPick(){return!!this.cameraControl.viewer.modelManager.hasModelDataReady()}_calcLineIntersectionPt(e){for(var t=[],i=0;i<u.length;++i)for(var n=u[i],a=i+1;a<u.length;++a){var s=u[a],o=r.Utils.lineLineIntersection3d(n.point1,n.point2,s.point1,s.point2);if(o){if(v(o)>e)continue;if(M(o,n.point1,r.Math.EPSILON4)||M(o,n.point2,r.Math.EPSILON4)||M(o,s.point1,r.Math.EPSILON4)||M(o,s.point2,r.Math.EPSILON4))continue;t.push(o.clone())}}return 0===t.length?null:(t.sort(((e,t)=>v(e)-v(t))),t[0])}_getLineIntersectionPt(e,t){if(!e)return null;u.length=0;for(let i=0;i<e.length;++i){const r=e[i];if("LineSegmentsEx"!==r.object.type)continue;const n=r.point,o=r.object.geometry,l=r.object.matrixWorld,d=o.attributes?o:o._bufferGeometry,h=d.index.array,c=d.attributes.position.array;for(let e=0;e<h.length;e+=2){a.set(c[3*h[e]],c[3*h[e]+1],c[3*h[e]+2]),a.applyMatrix4(l),s.set(c[3*h[e+1]],c[3*h[e+1]+1],c[3*h[e+1]+2]),s.applyMatrix4(l);if(v(g(a,s,n))>t)continue;const i={};i.point1=a.clone(),i.point2=s.clone(),u.push(i)}if(u.length>1e3)break}return u.length>1e3?null:this._calcLineIntersectionPt(t)}_getClipLinePickInfo(e,t,i,n,a){const s=this.cameraControl.scene.getRawMatrixGlobal();let l=null;u.length=0;let d=1/0,h=1/0,c=null,m=null;if(t.forEach(((t,l)=>{if(!i||l.databagId===i.databagId)for(let[i,p]of t)if(p&&!(u.length>1e3)){if(o.makeEmpty(),r.BimTilesVersionControl.isVersion_3(l.dataVersion)){const e=l.tilesLoader.tileReader,t=e.getIndexByUserId(i),r=e.getUserIdBoxByIndex(t);if(!r)continue;o.copy(r);const a=s.clone();if(a.multiply(l.transformMatrix),o.applyMatrix4(a),!o.containsPoint(n))continue}else if(r.BimTilesVersionControl.isVersion_2(l.dataVersion)||r.BimTilesVersionControl.isVersion_1(l.dataVersion)){const e=l.tilesLoader.tileReader,t=e.getIndexByUserId(i),r=e.descriptor.getNodeInfosByUserId(t);for(let e=0;e<r.length;++e){const t=r[e].boundingBox;t&&o.union(t)}const a=s.clone();if(a.multiply(l.transformMatrix),o.applyMatrix4(a),!o.containsPoint(n))continue}for(let t=0;t<p.length;++t){const i=e.slice(p[t][0],p[t][1]),r=[];for(let e=0;e<i.length;e+=3)r.push(e/3);const o=E(i,r,n,s,a);o.point&&o.pointDistance<d&&(c=o.point,d=o.pointDistance),o.line&&o.lineDistance<h&&(m=o.line,h=o.lineDistance)}}})),c)l={},l.pickPointInfos=[],l.pickPointInfos.push({type:p.endPoint,point:c});else if(m){let e=m.pointA,t=m.pointB,i=m.point;n.copy(i),l={},l.pickPointInfos=[],l.pickLine=new Array,l.pickLine.push(e),l.pickLine.push(t);let r=new THREE.Vector3((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2);v(r)<a&&l.pickPointInfos.push({type:p.midPoint,point:r})}if(!l)return null;if(0===l.pickPointInfos.length){const e=this._calcLineIntersectionPt(a);e&&(l.pickPointInfos=[],l.pickPointInfos.push({type:p.intersectionPoint,point:e}))}return l}_getIsIntersectClipCaps(e,t,i){const a=e.viewer,s=a.clipCapsManager.target.texture,o=a.getRenderer();let l=t,d=l.parent,h=l.material;i=n.copy(i),l.worldToLocal(i);const c=a.clipCapsManager.target.width,u=a.clipCapsManager.target.height;f||(f=new r.ClipCapsPickTestMaterial),f.uniforms.pickPoint.value=i,f.uniforms.pickTemplate.value=s,f.uniforms.viewportSize.value.set(c,u),f.uniforms.pixelRatio.value=o.getPixelRatio(),f.uniforms.cameraNear.value=this.cameraControl.camera.near;let p=f.uniforms.frustumPlanes.value;p.x=e.camera.near*Math.tan(.5*THREE.Math.degToRad(e.camera.fov)),p.y=-p.x,p.w=e.camera.aspect*p.x,p.z=-p.w,l.material=f,l.parent=null;const g=e.scene.children;e.scene.children=[],e.scene.add(l),m.setSize(c,u),o.setRenderTarget(m),o.render(e.scene,e.camera);let v=new Uint8Array(c*u*4);o.readRenderTargetPixels(m,0,0,c,u,v),o.setRenderTarget(null),e.scene.children=g,e.scene.remove(l),l.parent=d,l.material=h;for(let e=0;e<v.length;++e)if(v[e]>0)return!0;return!1}_getClipPickInfo(e,t,i){const n=e.scene;let a=null,s=null,o=null,l=null;const d=r.FillClipPlaneManager.getInstance(n),h=d&&d.isEnabled(),c=r.ClipPlaneManager.getInstance(n),u=c&&c.isEnabled();if(h)a=d.planeMesh,s=d.renderClipPlane.normal,o=d.capsIntersectPosition,l=d.capsIntersectPositionGroup;else{if(!u)return null;{const t=c.visible;c.visible=!0,c.raycast(e.intersector.raycaster),c.visible=t;const i=c.selectIndex;c.selectIndex=null,a=c.children[i],s=c.clipplanes[i],o=c.capsIntersectPosition[i],l=c.capsIntersectPositionGroup[i]}}if(a){let r=[];if(a.raycast(e.intersector.raycaster,r),r.length>0){let d=r[0].point,h=this._getClipLinePickInfo(o,l,t,d,i);if(h)return{type:1,info:h,pickPoint:d};if(this._getIsIntersectClipCaps(e,a,d)){let e={};return e.pickPoint=d,e.pickLine=null,e.pickPlane=!0,e.type="Plane",e.pointType=null,r[0].face.normal=n.drawingToWorld(s),r[0].face.normal.negate().normalize(),e.face=r[0].face,{type:2,info:e}}}}return null}_getAxisIntersectInfo(e,t,i){let n=null;u.length=0;var a=e.getRawMatrixGlobal();let s=1/0,o=1/0,l=null,d=null;for(let n in e.axisGridManagerMap){const h=r.AxisGridManager.getInstance(e,n).getIntersectPoints(t.intersector.raycaster,a);if(0===h.length)continue;h.sort(((e,i)=>e.distanceTo(t.camera.position)-i.distanceTo(t.camera.position)));const c=h[0];c.applyMatrix4(a);const u=e.axisGridManagerMap[n];for(let e=0;e<u.children.length;++e){const t=u.children[e],r=t.matrixWorld;if("Line"===t.type){const e=t.geometry.attributes.position.array,n=[];for(let t=0;t<e.length;t+=3)n.push(t/3);const a=E(e,n,c,r,i);a.point&&a.pointDistance<s&&(l=a.point,s=a.pointDistance),a.line&&a.lineDistance<o&&(d=a.line,o=a.lineDistance)}else t.type}}if(l)n={},n.pickPointInfos=[],n.pickPointInfos.push({type:p.endPoint,point:l}),n.pickPoint=l.clone();else if(d){let e=d.pointA,t=d.pointB;n={},n.pickPointInfos=[],n.pickLine=new Array,n.pickLine.push(e),n.pickLine.push(t),n.pickPoint=d.point.clone();let r=new THREE.Vector3((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2);v(r)<i&&n.pickPointInfos.push({type:p.midPoint,point:r})}if(!n)return null;if(0===n.pickPointInfos.length){const e=this._calcLineIntersectionPt(i);e&&(n.pickPointInfos=[],n.pickPoint=p.intersectionPoint,n.pickPointInfos.push({type:p.intersectionPoint,point:e}))}return n}pickToPoint(t,i){r.Utils.defaultValue(i,5);let n=this.cameraControl,a=n.scene,s=new THREE.Vector2(t.x,t.y),o=n.getIntersectContext(s);o.snapIntersection=!0;let l=n.intersector.pick(o,null,!0);c=n.camera.projScreenMatrix,d=o.mouse,h=o.viewportSize;let u=null;u=Array.isArray(l)?l[0]:l;let m=n.viewer.getModelManager(),f=m.getSceneUnit(),g=u?m.getModelUnit(u.databagId):null,y=f===g?1:f===r.EnumLengthlUnits.Meter?.001:1e3,M=null,x=null,_=!1,b=[],I=null,T=null;if(this.isAxisGridHoverEnabled()&&(T=this._getAxisIntersectInfo(a,n,i),T&&(x=T.pickPoint)),r.GlobalData.SnapClippingLine){const e=this._getClipPickInfo(this.cameraControl,u,i);if(e)if(1===e.type)I=e.info,x=e.pickPoint;else if(2===e.type)return e.info.unit=g,e.info.sceneUnit=f,e.info.unitScalar=y,e.info}if(u){if(!u.object||u.object.parent instanceof r.ExtrudeBodyManager)return null;let t=u.object.matrixWorld.clone(),n=u.point;r.GlobalData.SnapClippingLine&&x||(x=n.clone());{let e=this._getLineIntersectionPt(l,i);e&&b.push({type:p.intersectionPoint,point:e})}let a=u.object.geometry;if(!a.attributes&&!a._bufferGeometry)return null;let s,o=a.attributes?a:a._bufferGeometry;if("MeshLineGeometry"===o.type){let i={};e.copy(t).invert();let r=new THREE.Vector3(n.x,n.y,n.z);return i.pickPoint=r,i.pickLine=null,i.pickPlane=null,i.type="Line",i.pointType=null,i.face=u.face,i.userId=u.userId,i.modelId=u.databagId,i.fileId=u.fileId,i.unit=g,i.sceneUnit=f,i.unitScalar=y,i}if(!o.index)return null;void 0!==u.indexInfo&&(s=u.indexInfo);let d=[],h=0,c=0;s?(d=o.index.array,h=s.indexStart,c=s.indexStart+s.indexCount):(r.GlobalData.BatchMergeEnabled&&u.matrix&&t.multiply(u.matrix),d=r.RemoveDuplicateVertex(o.attributes.position.array,o.index.array),c=d.length);let m=[],I=[];const T=!r.Utils.isDefined(o.attributes.normal)&&!r.Utils.isDefined(o.attributes.cNormal);if(s){m=o.attributes.position.array.slice(s.positionStart,s.positionStart+s.positionCount);const e=r.Utils.getMin(d.slice(h,c)),t=[];for(let i=h;i<c;++i)t.push(d[i]-e);I=T?t:r.BuildEdge(m,t)}else{m=o.attributes.position.array;const e=o.index.array;I=T?e:r.BuildEdge(o.attributes.position.array,e)}const S=E(m,I,x,t,i);if(S.point)b.push({type:p.endPoint,point:S.point}),x.copy(S.point);else if(S.line){let e=S.line.pointA,t=S.line.pointB,r=S.line.point;M=new Array,M.push(e),M.push(t),x.copy(r);let n=new THREE.Vector3((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2);v(n)<i&&b.push({type:p.midPoint,point:n})}else T||(_=!0)}I&&(_=!1,M||(M=I.pickLine),b.push(...I.pickPointInfos)),T&&(_=!1,M||(M=T.pickLine),b.push(...T.pickPointInfos)),b.sort(((e,t)=>{let i=e.type.order-t.type.order;return 0!==i?i:v(e.point)-v(t.point)}));let S=null;if(b[0]&&(x=b[0].point,S=b[0].type.name),x||M||_){let e=null;e=S?"Point":_?"Plane":M?"Line":"Point";let t={};return t.pickPoint=x,t.pickLine=M,t.pickPlane=_,t.type=e,t.pointType=S,t.face=u?u.face:null,t.userId=u?u.userId:null,t.modelId=u?u.databagId:null,t.fileId=u?u.fileId:null,t.unit=g,t.sceneUnit=f,t.unitScalar=y,t}return null}handleTabs(e){var t=this.cameraControl.viewer.modelManager.sceneState;null!=e&&null!=e.userId&&t.setSelection([e.userId],e.databagId)}pickAllObjectsByPosition(e){var t=new THREE.Vector2(e.clientX,e.clientY);return this.cameraControl.intersector.getObjectsByClientCoordinates(t)}clearDelayClickState(){this.cameraControl.viewer.editorManager.clearDelayClickState(),this.setDelayClickState(!1)}setDelayClickState(e){this.cameraControl.viewer.editorManager.setDelayClickState(e)}}}(),r.EditTool=class{constructor(e){this.name=e,this._mousePressed=!1}getName(){return this.name}onExit(){}destroy(){}processMouseDown(e){return!1}processMouseMove(e){return!1}processMouseUp(e){return!1}processMouseWheel(e){return!1}processMouseDoubleClick(e){return!1}processKeyDown(e){return!1}processKeyUp(e){return e.keyCode===r.Keys.ESC&&(this._mousePressed=!1),!1}processTouchstart(e){return!1}processTouchmove(e){return!1}processTouchend(e){return!1}processHover(e){return!1}onEvent(e){var t=!1;switch(e.type){case"touchmove":t=this.processTouchmove(e);break;case"touchstart":t=this.processTouchstart(e);break;case"touchend":t=this.processTouchend(e);break;case"keydown":t=this.processKeyDown(e);break;case"keyup":t=this.processKeyUp(e);break;case"mousewheel":case"DOMMouseScroll":t=this.processMouseWheel(e);break;case"mousedown":this._mousePressed=!0,t=this.processMouseDown(e);break;case"mousemove":t=this._mousePressed?this.processMouseMove(e):this.processHover(e);break;case"mouseup":t=this.processMouseUp(e);break;case"dblclick":t=this.processMouseDoubleClick(e)}return t}clearDelayClickState(){this._mousePressed=!1}},(()=>{class e extends r.EditTool{constructor(e,t,i){super(e),this.cameraControl=t,this.frustum=new THREE.Frustum,this.startPt=new THREE.Vector2,this.endPt=new THREE.Vector2,this.eventDispatcher=i}destroy(){super.destroy(),this.cameraControl=null,this.frustum=null,this.startPt=null,this.endPt=null,this.eventDispatcher=null}onUpdateUI(e){this.eventDispatcher.dispatchEvent({type:r.EVENTS.ON_EDITOR_UPDATEUI,data:e,editor:this.name})}updateFrustum(e,t){var i=this.startPt.x,r=this.endPt.x,n=this.startPt.y,a=this.endPt.y;if(i>r){var s=i;i=r,r=s}if(n>a){var o=n;n=a,a=o}if(r-i==0||a-n==0)return!1;var l=this.cameraControl,d=l.getContainerDimensions();return e&&l.computeFrustum(i,r,n,a,this.frustum,d),t&&this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:i-d.left,top:n-d.top,width:r-i,height:a-n}),!0}computeFrustum(){var e=this.startPt.x,t=this.endPt.x,i=this.startPt.y,r=this.endPt.y;let n=new THREE.Vector3(e,i),a=new THREE.Vector3(e,r),s=new THREE.Vector3(t,r),o=new THREE.Vector3(t,i),l=[];l.push(n,a,s,o);let d=this.cameraControl.viewer,h=[];for(let e=0;e<l.length;e++){let t=[];t.push(l[e]),t.push(l[(e+1)%l.length]),t.push(l[e].clone().setZ(1)),h.push(m(p(d,t)))}let c=[];c.push(n,o,s),h.push(m(p(d,c)));let u=[];function p(e,t){let i=[];for(const r of t){let t=e.clientToWorld(r.clone()),n=e.worldToDrawing(t);i.push(new THREE.Vector3(n.x,n.y,n.z))}return i}function m(e){return(new THREE.Plane).setFromCoplanarPoints(e[0],e[1],e[2])}u.push(n.setZ(1),a.setZ(1),s.setZ(1)),h.push(m(p(d,u)));let f=new THREE.Frustum;for(let e=0;e<h.length;e++)f.planes[e].copy(h[e]);return f}}r.RectOpTool=e})(),(()=>{class e extends r.RectOpTool{constructor(e){super(r.EditToolMode.PICK_BY_RECT,e.cameraControl,e.modelManager),this.viewer=e,this.scene=e.getScene(),this.pickHelper=new r.PickHelper(this.cameraControl),this.activatePick=!1,this.pickPoint=new THREE.Vector3,this.snapIsEnabled=!1,this._triggerByCtrlKey=!0}destroy(){super.destroy(),this.pickHelper.destroy(),this.pickHelper=null,this.viewer=null,this.scene=null,this.pickPoint=null}processMouseDown(e){if(!r.EditorConfig.NoKey){e.preventDefault();var t=["pickByMeasure"],i=this.viewer.editorManager.tools,n=!0;return i.some((e=>{if(t.indexOf(e.name)>=0)return n=!1,!0})),this.activatePick=n&&(e.ctrlKey||e.altKey||!this._triggerByCtrlKey),this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),!0):super.processMouseDown(e)}}processMouseMove(e){if(!r.EditorConfig.NoKey)return this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):super.processMouseMove(e)}processMouseUp(e){if(!r.EditorConfig.NoKey){if(this.onUpdateUI({visible:!1}),this.activatePick&&e.button===THREE.MOUSE.LEFT){if(this.activatePick=!1,Math.abs(this.startPt.x-e.clientX)<2&&Math.abs(this.startPt.y-e.clientY)<2)return this.pickHelper.click(e,null),!0;if(this.endPt.set(e.clientX,e.clientY),!this.updateFrustum(!0,!1))return this.pickHelper.click(e),!0;var t=r.OPSELECTIONTYPE.Clear;return e.ctrlKey||!this._triggerByCtrlKey&&!e.altKey?t=r.OPSELECTIONTYPE.Add:e.altKey&&(t=r.OPSELECTIONTYPE.Remove),r.PickUtil.pickByRect(this.scene,this.frustum,t,this.viewer,void 0,this.startPt,this.endPt),this.pickHelper.lastPickedUserId="",this.cameraControl.updateView(!0),!0}return super.processMouseUp(e)}}processHover(e){if(this.snapIsEnabled)return r.GlobalData.IsMobile||this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint,r.EVENTS.ON_HOVER_SNAP),!0}enableSnap(e){this.snapIsEnabled=e}triggerByCtrlKey(e){this._triggerByCtrlKey=e}onExit(e){this.destroy()}}r.RectPickTool=e})(),(()=>{let e=new THREE.Vector3;class t extends r.RectOpTool{constructor(e){super(r.EditToolMode.ZOOM_BY_RECT,e.cameraControl,e.modelManager),this.scene=e.getScene(),this.camera=e.camera,this.activateZoom=!1}destroy(){super.destroy(),this.scene=null}processTouchstart(e){if(1===e.touches.length){const t=e.touches[0].clientX,i=e.touches[0].clientY;return this.startPt.set(t,i),this.activateZoom=!0,!0}return super.processTouchstart(e)}processTouchmove(e){if(this.activateZoom){e.preventDefault();const t=e.touches[0].clientX,i=e.touches[0].clientY;return this.endPt.set(t,i),this.updateFrustum(!1,!0),!0}return super.processTouchmove(e)}processTouchend(e){if(this.activateZoom){this.activateZoom=!1,this.onUpdateUI({visible:!1});const t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY;if(this.endPt.set(t,i),this.updateFrustum(!0,!1)){this.zoomToRectangle()&&!0!==this.camera.isPerspective&&this.orthoCameraZoom()}return!0}return super.processTouchend(e)}processMouseDown(e){return e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),this.activateZoom=!0,!0):super.processMouseDown(e)}processMouseMove(e){return this.activateZoom?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):super.processMouseMove(e)}processMouseUp(e){if(this.activateZoom){if(this.activateZoom=!1,this.onUpdateUI({visible:!1}),this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!0,!1)){this.zoomToRectangle()&&!0!==this.camera.isPerspective&&this.orthoCameraZoom()}return!0}return super.processMouseUp(e)}orthoCameraZoom(){let e=this.cameraControl.getContainerDimensions(),t=e.width/e.height;var i=Math.abs(this.endPt.x-this.startPt.x),r=Math.abs(this.endPt.y-this.startPt.y);let n=1;n=t<i/r?i/e.width:r/e.height;let a=this.cameraControl.camera;a.orthoScale/=n,this.cameraControl.dirtyCamera(!0),a.setZoom(a.orthoScale),this.cameraControl.setCameraChanging(!0),this.cameraControl.update(!0,!0)}zoomToRectangle(){var t=this.cameraControl.camera,i=this.cameraControl.camera.target,n=this.cameraControl.getContainerDimensions(),a=this.startPt.x,s=this.startPt.y,o=this.endPt.x,l=this.endPt.y,d=Math.abs(o-a),h=Math.abs(s-l);if(0===d||0===h)return;var c=new THREE.Vector2((a+o)/2,(s+l)/2),u=this.cameraControl.getIntersectContext(c);const p=r.GlobalData.LineSelectRange;r.GlobalData.LineSelectRange=500;var m=this.cameraControl.intersector.hitTest(u);if(r.GlobalData.LineSelectRange=p,!m){let t=this.cameraControl.viewer,i=new r.RectPickTool(t);i.startPt.set(a,o),i.endPt.set(s,l);let n=r.PickUtil.pickByRect(this.scene,this.computeFrustum(),r.OPSELECTIONTYPE.Add,t,!1);var f=new THREE.Box3;for(const e of n){const i=t.getComponentInfoByUserId(e);if(!i)continue;const r=i.boundingBox;f.expandByPoint(r.min),f.expandByPoint(r.max)}if(!1===f.isEmpty()){let i=t.worldToDrawing(f.getCenter(e));m=new THREE.Vector3(i.x,i.y,i.z)}}if(!m)return!1;let g=t.position.clone();var v=d/h>n.width/n.height?d/n.width:h/n.height,y=m.distanceTo(g)*v,M=i.clone().sub(g),E=M.length();M.normalize();let x=M.clone().negate().multiplyScalar(y);return g=m.clone().add(x),t.position.copy(g),i.copy(g).sub(x.clone().normalize().multiplyScalar(E)),this.cameraControl.updateView(!0),!0}worldToClient(e){var t=this.cameraControl.camera,i=new THREE.Vector3(e.x,e.y,e.z);return i.project(t),i}clientToWorld(e){var t=this.cameraControl.getContainerDimensions(),i=this.cameraControl.camera,r=new THREE.Vector3;return r.x=e.x/t.width*2-1,r.y=-e.y/t.height*2+1,r.z=e.z,r.unproject(i),r}}r.RectZoomTool=t})(),(()=>{class e extends r.EditTool{constructor(e){super(r.EditToolMode.PICK_BY_MEASURE),this.editorManager=e.editorManager,this.viewer=e,this.pickHelper=new r.PickHelper(e.cameraControl),this.mouseDown=new THREE.Vector2,this.lastEvent=null,this.pick=!1,this.pickPoint=new THREE.Vector3}destroy(){super.destroy(),this.editorManager=null,this.mouseDown=null,this.lastEvent=null,this.pickPoint=null,this.pickHelper.destroy(),this.pickHelper=null}processMouseDown(e){return!!r.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT?(this.mouseDown.x=e.clientX,this.mouseDown.y=e.clientY,!1):super.processMouseDown(e))}processMouseMove(e){return!1}processMouseUp(e){if(r.GlobalData.IsMobile)return!0;var t=new THREE.Vector2(e.clientX,e.clientY).distanceTo(this.mouseDown);if(e.button===THREE.MOUSE.LEFT){if(t<=2){this.editorManager.isUpdateRenderList=!0;var i=this.pickPoint.clone();this.pickHelper.handleMouseMeasure(e,!0,i),i.equals(this.pickPoint)||(this.pick=!this.pick,this.pickPoint.copy(i))}return this.dispatchEvent({type:r.EVENTS.ON_TOOL_END}),!0}if(e.button===THREE.MOUSE.RIGHT){if(t<=2){i=this.pickPoint.clone();this.pickHelper.handleMouseMeasure(e,!0,i,r.EVENTS.ON_MEASURE_RESET)}return!0}return super.processMouseUp(e)}processHover(e){return r.GlobalData.IsMobile||this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint),!0}processTouchstart(e){return this.mouseDown.x=e.touches[0].clientX,this.mouseDown.y=e.touches[0].clientY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,this.lastEvent=e,super.processTouchstart(e)}processTouchmove(e){const t=this.mouseDown.x,i=this.mouseDown.y,r=e.touches[0].clientX,n=e.touches[0].clientY;return Math.pow(r-t,2)+Math.pow(n-i,2)>25&&(this.lastEvent=null),super.processTouchmove(e)}processTouchend(e){return null!=this.lastEvent&&(this.pickHelper.handleMouseMeasure(this.lastEvent,!0,this.pickPoint),this.editorManager.isUpdateRenderList=!0),super.processTouchend(e)}onExit(e){}dispatchEvent(e){this.viewer.modelManager.dispatchEvent(e)}}r.MeasureTool=e})(),r.ActionTool=class{constructor(e){this.cameraControl=e,this.action=[],this.editorMap={}}destroy(){}addEditor(e,t,i){this.editorMap[t]||(this.editorMap[t]=[]);const n={editor:e,event:i};this.editorMap[t].push(n),this.cameraControl.setCameraChanging(!0),!1!==r.GlobalData.BatchMergeEnabled&&r.GlobalData.Renderer!==r.EnumRendererType.INCREMENT||(e[t](i),this.cameraControl.updateCamera(!0),this.cameraControl.viewer.render())}clearEditorMap(){this.editorMap={}}setEvent(e){this.event=e}MethodToEditorMethod(){for(const e in this.editorMap){const t=this.editorMap[e].pop(),{editor:i,event:r}=t;i[e](r)}}execute(){this.MethodToEditorMethod(),this.clearEditorMap()}isProcessingMouse(){return Object.keys(this.editorMap).length>0}},(()=>{r.Keys={ALT:18,BACKSPACE:8,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189,ZERO:48,ESC:27,TAB:9},r.EditorConfig={ReverseWheelDirection:!1,MovementSpeedRate:1,WalkSpeedRate:1,RotatePivotMode:0,NoPan:!1,NoRotate:!1,NoZoom:!1,NoKey:!1,LockAxisZ:!1,LockAxisZRange:null};r.BaseEditor=class{constructor(e,t){this.name=e,this.cameraControl=t,this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.StateType={NONE:-1,ROTATE:0,DOLLY:1,PAN:2},this.state=this.StateType.NONE,this.zoomSpeed=Math.pow(.95,.2),this.defaultMovementSpeed=.005*r.GlobalData.SceneSize,this.movementSpeed=this.defaultMovementSpeed,this.minMovementSpeed=.001,this.defaultKeyPanSpeed=2,this.keyPanSpeed=this.defaultKeyPanSpeed,this.minKeyPanSpeed=.01,this.wheelZoomFactor=45e-5}getName(){return this.name}destroy(){this.scene=null,this.cameraControl=null,this.mouseButtons=null,this.StateType=null}onExit(){}onEnter(){}processMouseDown(e){}processMouseMove(e){}processMouseUp(e){}processMouseWheel(e){}processMouseDoubleClick(e){}processKeyDown(e){}processKeyUp(e){}processTouchstart(e){}processTouchmove(e){}processTouchend(e){}processHover(e){}update(){}moveTo(e,t,i){}rotateTo(e){}dispatchEvent(e){this.cameraControl.viewer.modelManager.dispatchEvent(e)}updateButtons(e){void 0!==e.ORBIT&&(this.mouseButtons.ORBIT=e.ORBIT),void 0!==e.PAN&&(this.mouseButtons.PAN=e.PAN),void 0!==e.PAN2&&(this.mouseButtons.PAN2=e.PAN2),void 0!==e.ZOOM&&(this.mouseButtons.ZOOM=e.ZOOM)}isUserInputEditor(){return this.name===r.EditorMode.PAN||this.name===r.EditorMode.ZOOM||this.name===r.EditorMode.ORBIT}}})(),(()=>{class e extends r.BaseEditor{constructor(e,t){super(e,t),this.oldMouseX=-1,this.oldMouseY=-1,this.modelManager=t.viewer.modelManager,this._worldDimension=new THREE.Vector2,this.pickHelper=new r.PickHelper(t),this.longTapFlag=!1,r.Utils.isMobileDevice()?this.selectPad=new r.SelectPad(this):this.selectPad=null,this.startPt=new THREE.Vector2,this.viewer=t.viewer,this._timeHandle=null}destroy(){super.destroy(),this.modelManager=null,this._worldDimension=null,this.startPt=null,this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null),this._timeHandle=null,this.viewer=null}longTap(){this.longTapFlag=!0,r.Logger.log("long tap"),this.selectPad&&this.selectPad.showOverlay(this.startPt)}beginPan(e,t){this._panStart.set(e,t),this.cameraControl.userInputHelper.getWorldDimension(e,t,this._worldDimension)}moveTo(e){if(void 0!==e){var t=this.cameraControl;if(!r.EditorConfig.NoKey&&!r.EditorConfig.NoPan){var i=this.movementSpeed*r.EditorConfig.MovementSpeedRate,n=this.keyPanSpeed*r.EditorConfig.MovementSpeedRate,a=r.MoveDirection;switch(e){case a.FORWARD:t.moveForward(i,!0);break;case a.BACK:t.moveBackward(i,!0);break;case a.LEFT:t.pan(n,0);break;case a.RIGHT:t.pan(-n,0);break;case a.UP:t.pan(0,n);break;case a.DOWN:t.pan(0,-n);break;default:e=a.NONE}e!==a.NONE&&t.update(!0,!0)}}}onExit(){r.GlobalData.BatchMergeEnabled&&this.animationStarted&&(this._stop(),this.animationStarted=!1)}}r.NormalEditor=e})(),function(){class e extends r.NormalEditor{constructor(e,t=r.EditorMode.ORBIT){super(t,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._lastDampingOffset=new THREE.Vector2,this._curDampingOffset=new THREE.Vector2,this.rotatePivot=null,this.enable=!0,this.rotateSpeed=.2;"windows"===r.Utils.getOS()&&(this.rotateSpeed=.8),this._rotateMoving=!1}processMouseDown(e,t){e.preventDefault(),e.button===this.mouseButtons.ORBIT&&!r.EditorConfig.NoRotate&&this.enable&&(this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,t.addEditor(this,"processMouseDownOnRender",e))}processMouseDownOnRender(e){const t=this.cameraControl;void 0!==t.viewer.getBoundingBox()&&(this.rotatePivot=t.userInputHelper.getRotatePivot(r.EditorConfig.RotatePivotMode,{x:e.clientX,y:e.clientY}),this._rotateStart.set(e.clientX,e.clientY),this._rotateEnd.set(e.clientX,e.clientY),this.resetDynamicRotate(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:r.EditorMode.ORBIT,editor:this.name,startPt:this._rotateStart}),this.state=this.StateType.ROTATE)}processMouseMove(e,t){if(this.state!==this.StateType.ROTATE)return!1;r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._rotateMoving=!0,this._timeHandle=setTimeout((()=>{this._rotateMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processMouseMoveOnRender",e)}get mouseMoving(){return this._rotateMoving}processMouseMoveOnRender(e,t){const i=this.cameraControl;if(e.preventDefault(),i.userInputWorking||(i.userInputWorking=!0),this._rotateEnd.set(e.clientX,e.clientY),!(this.cameraControl.isEnableDamping()||(this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),Math.abs(this._rotateDelta.x)<r.Math.EPSILON2&&Math.abs(this._rotateDelta.y)<r.Math.EPSILON2))){if(this._rotateStart.copy(this._rotateEnd),!0===this.viewer.gisMode){var n=new THREE.Vector3,a=this.cameraControl.camera.position;this.viewer.getScene().getBoundingBox().getCenter(n),(r.Math.equalsEpsilonVec3(this.rotatePivot,n,1e-5)||a.y<2e4&&this.rotatePivot.distanceTo(a)>15e4)&&this.rotatePivot.set(a.x+1e-5,a.y+1e-5,a.z+1e-5)}if(this._processRotate(this._rotateDelta,this.rotatePivot),t){const e=this.viewer.getClientSize();var s=-2*Math.PI*this._rotateDelta.x/e.x*this.rotateSpeed,o=-2*Math.PI*this._rotateDelta.y/e.y*this.rotateSpeed;i.pivot=this.rotatePivot,i.touchUpdateRotation(s,o),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ROTATING}),i.touchUpdate()}else this.dispatchEvent({type:r.EVENTS.ON_EDITOR_ROTATING,editor:this.name})}}processMouseUp(e,t){if(this.state!==this.StateType.ROTATE)return!1;t.addEditor(this,"processMouseMoveUpRender",e)}processMouseMoveUpRender(e){const t=this.cameraControl;return this.state=this.StateType.NONE,t.endOperation(),t.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ORBIT,editor:this.name}),!0}processTouchstart(e,t){1===e.touches.length&&t.addEditor(this,"processOrbitTouchstartOnRender",e)}processOrbitTouchstartOnRender(e){const t=this.cameraControl;r.EditorConfig.NoRotate||void 0!==t.viewer.getBoundingBox()&&(this.rotatePivot=t.userInputHelper.getRotatePivot(r.EditorConfig.RotatePivotMode,{x:e.touches[0].clientX,y:e.touches[0].clientY}),this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:r.EditorMode.ORBIT,editor:this.name,startPt:this._rotateStart}))}processTouchmove(e,t){if(this.state!==this.StateType.ROTATE)return!1;2===e.touches.length&&(this._hasRotateMove=!0,r.Utils.isDefined(this._rotateTimeHandle)&&(clearTimeout(this._rotateTimeHandle),this._rotateTimeHandle=null),this._rotateTimeHandle=setTimeout((()=>{this._hasRotateMove=!1}),350)),1!==e.touches.length||this._hasRotateMove||(e.preventDefault(),r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._rotateMoving=!0,this._timeHandle=setTimeout((()=>{this._rotateMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processOrbitTouchmoveOnRender",e))}processOrbitTouchmoveOnRender(e){e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,this.processMouseMoveOnRender(e,!0)}processTouchend(e,t){if(this.state!==this.StateType.ROTATE)return!1;t.addEditor(this,"processOrbitTouchendOnRender",e)}processOrbitTouchendOnRender(e){const t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ORBIT,editor:this.name})}dynamicRotate(){this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart);let e=!1;if((Math.abs(this._rotateDelta.x)>r.Math.EPSILON4||Math.abs(this._rotateDelta.y)>r.Math.EPSILON4)&&(e=!0),this._lastDampingOffset.length()>r.Math.EPSILON4&&(e=!0),e){const e=this.viewer.getClientSize(),t=-2*Math.PI*this._rotateDelta.x/e.x,i=-2*Math.PI*this._rotateDelta.y/e.y;this._lastDampingOffset.add(new THREE.Vector2(t,i)),this._curDampingOffset.copy(this._lastDampingOffset);const r=this._curDampingOffset.multiplyScalar(this.cameraControl.dynamicDampingFactor());this.cameraControl.handleRotation(r.x,r.y,this.rotatePivot),this._rotateStart.copy(this._rotateEnd),this._lastDampingOffset.multiplyScalar(1-this.cameraControl.dynamicDampingFactor())}}resetDynamicRotate(){this._lastDampingOffset.set(0,0),this._curDampingOffset.set(0,0)}_processRotate(e,t){var i=this.viewer.getClientSize(),r=-2*Math.PI*e.x/i.x,n=-2*Math.PI*e.y/i.y;this.cameraControl.handleRotation(r,n,t)}}r.OrbitEditor=e}(),(()=>{class e extends r.NormalEditor{constructor(e){super(r.EditorMode.PICK,e),this.tabIndex=0,this.intersectOfMouseDown=null,this.pickObjects=[],this._touchStartTime=null}destroy(){super.destroy(),this.pickObjects=null}processMouseDown(e){this.intersectOfMouseDown=null,e.preventDefault();Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1&&(this.intersectOfMouseDown=this.cameraControl.getLastIntersect()),this.oldMouseX=e.clientX,this.oldMouseY=e.clientY}processMouseUp(e){e.preventDefault();const t=Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1,i=t;return e.button!==THREE.MOUSE.LEFT&&e.button!==THREE.MOUSE.RIGHT||!t?(this.intersectOfMouseDown=null,this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,!1):(this.viewer.hasBimtilesModel()||(this.pickObjects=this.pickHelper.pickAllObjectsByPosition(e)),this.pickHelper.click(e,this.intersectOfMouseDown),this.cameraControl.update(!0),this.intersectOfMouseDown=null,i)}processMouseDoubleClick(e){e.button===THREE.MOUSE.LEFT&&this.pickHelper.doubleClick(e)}processMouseMove(){this.pickObjects=[]}processMouseWheel(){this.pickObjects=[]}processKeyDown(e){if(super.processKeyDown(e),e.preventDefault(),this.state=this.StateType.NONE,!(r.EditorConfig.NoKey||this.pickObjects.length<=0)){var t=r.Keys;if(e.keyCode===t.TAB)e.shiftKey?(--this.tabIndex,this.tabIndex<0?(this.tabIndex=this.pickObjects.length+this.tabIndex,this.pickHelper.handleTabs(this.pickObjects[this.tabIndex])):this.pickHelper.handleTabs(this.pickObjects[this.tabIndex])):(++this.tabIndex,this.tabIndex>=this.pickObjects.length&&(this.tabIndex=0),this.pickHelper.handleTabs(this.pickObjects[this.tabIndex]));this.cameraControl.update(!0)}}processKeyUp(e){if(e.keyCode===r.Keys.ESC)this.cameraControl.viewer.clearSelection(),this.pickHelper.lastPickedUserId=void 0,this.cameraControl.updateView(!0)}processHover(e){this.pickHelper.handleMouseHover(e),this.pickHelper.handleMouseMovePick(e)}processTouchstart(e){if(1!==e.touches.length)return;this.intersectOfMouseDown=null,e.preventDefault();const t=e.touches[0].clientX,i=e.touches[0].clientY;Math.abs(this.oldMouseX-t)<=1&&Math.abs(this.oldMouseY-i)<=1&&(this.intersectOfMouseDown=this.cameraControl.getLastIntersect()),this.oldMouseX=t,this.oldMouseY=i;const r=new Date;this._touchStartTime=r.getTime()}processTouchend(e){if(0!==e.touches.length)return;if((new Date).getTime()-this._touchStartTime>400)return;e.preventDefault();const t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY;if(Math.abs(this.oldMouseX-t)<=1&&Math.abs(this.oldMouseY-i)<=1){let e={clientX:t,clientY:i,button:THREE.MOUSE.LEFT};return this.pickHelper.click(e,this.intersectOfMouseDown,!0),this.cameraControl.update(!0),this.intersectOfMouseDown=null,!0}return this.intersectOfMouseDown=null,this.oldMouseX=t,this.oldMouseY=i,!1}}r.PickEditor=e})(),function(){class e extends r.EditTool{constructor(e){super(r.EditToolMode.VOLUME_MEASURE),this._viewer=e,this._externalObjectConverter=new r.ExternalObjectConverter(this._viewer),this._measuredObject={},this._lastMousePos=new THREE.Vector2,this._pickHelper=new r.PickHelper(e.cameraControl),this._pickPoint=new THREE.Vector3,this._touchMoved=!1}destroy(){super.destroy(),this._measuredObject=null,this._externalObjectConverter=null,this._viewer=null,this._pickHelper=null}processMouseDown(e){return!!r.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT?(this._lastMousePos.x=e.clientX,this._lastMousePos.y=e.clientY,!1):super.processMouseDown(e))}processMouseUp(e){if(r.GlobalData.IsMobile)return!0;const i=new THREE.Vector2(e.clientX,e.clientY).distanceTo(this._lastMousePos);if(e.button===THREE.MOUSE.LEFT){if(i<=2){let i={x:e.clientX,y:e.clientY},n=t.call(this,i);r.Utils.isDefined(n)&&this.dispatchEvent(n)}return!0}}processTouchstart(e){return this._touchMoved=!1,this._lastMousePos.x=e.touches[0].clientX,this._lastMousePos.y=e.touches[0].clientY,super.processTouchstart(e)}processTouchmove(e){return this._touchMoved=!0,super.processTouchmove(e)}processTouchend(e){if(!this._touchMoved){let e=t.call(this,this.s);r.Utils.isDefined(e)&&this.dispatchEvent(e)}return super.processTouchend(e)}onExit(e){this.destroy()}dispatchEvent(e){this._viewer.modelManager.dispatchEvent(e)}}function t(e){var t=this._pickHelper.pickToPoint(e,5);if(!r.Utils.isDefined(t))return null;if(!t.userId||!t.modelId)return null;const i=this._viewer.modelManager.getModel(t.modelId);let n=0;const a=`volumeMeasureObject_${t.userId}_${t.modelId}`;let s;if(void 0!==this._measuredObject[a])n=this._measuredObject[a].volume,s="m"===this._measuredObject[a].unit?"m³":"mm³";else{const e=void 0!==t.modelId?{modelId:t.modelId,objectId:t.userId}:t.userId,o=this._externalObjectConverter.convertToExternalObject(a,e,!1),l=r.GeomUtil.geometryVolume(o,this._viewer);n=l.volume,l.unit=i.isBmdLayer?i.getUnit()===r.EnumLengthlUnits.Meter?"m":"mm":"m",this._measuredObject[a]=l,s="m"===l.unit?"m³":"mm³"}return{volume:n,position:t.pickPoint,unit:s,objectId:t.userId,modelId:t.modelId,type:r.EVENTS.ON_VOLUME_MEASURE_END}}r.VolumeMeasureTool=e}(),function(){class e extends r.NormalEditor{constructor(e){super(r.EditorMode.ZOOM,e),this.mouseButtons={},this.enable=!0,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this.touchZoomSpeed=.24,this._curZoomFactor={},this._isZooming=!1,this._isThroughWalling=!1}destroy(){super.destroy(),this.mouseButtons=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._curZoomFactor=null}processMouseWheel(e,t){if(!r.EditorConfig.NoZoom&&this.enable){r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),e.preventDefault(),e.stopPropagation();var i=0;e.wheelDelta?i=e.wheelDelta:e.detail&&(i=40*-e.detail),Math.abs(i)>720&&(i=i>0?720:-720),i*=this.wheelZoomFactor,((i=r.EditorConfig.ReverseWheelDirection?-i:i)>0&&this._curZoomFactor.scale<0||i<0&&this._curZoomFactor.scale>0)&&this.cameraControl.setTrackPointChanging(!0),this._curZoomFactor.scale=i,this._curZoomFactor.clientX=e.clientX,this._curZoomFactor.clientY=e.clientY,t.addEditor(this,"processMouseWheelOnRender",e),this._isZooming=!0,this._timeHandle=setTimeout((()=>{this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END}),this._isZooming=!1}),r.GlobalData.InputDelayTimeInterval)}}get isZooming(){return this._isZooming}processMouseWheelOnRender(e){this.cameraControl.isEnableDamping()&&this.cameraControl.userInputHelper.isThroughWall||void 0!==this.cameraControl.viewer.getBoundingBox()&&this._zoom(this._curZoomFactor.scale)}processMouseDown(e,t){e.preventDefault(),e.button!==this.mouseButtons.ZOOM||r.EditorConfig.NoZoom||t.addEditor(this,"processMouseDownOnRender",e)}processMouseDownOnRender(e){this.state=this.StateType.NONE,this.state=this.StateType.DOLLY,this._dollyStart.set(e.clientX,e.clientY),this._dollyEnd.set(e.clientX,e.clientY),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:r.EditorMode.ZOOM,editor:this.name,startPt:this._dollyStart})}processMouseMove(e,t){this.state===this.StateType.DOLLY&&t.addEditor(this,"processMouseMoveOnRender",e)}processMouseMoveOnRender(e){const t=this.cameraControl;if(e.preventDefault(),t.userInputWorking||(t.userInputWorking=!0),this._dollyEnd.set(e.clientX,e.clientY),this.cameraControl.isEnableDamping())return;if(this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)<r.Math.EPSILON2)return;let i=this._dollyDelta.y>0?this.zoomSpeed:1/this.zoomSpeed;this._zoom(i-1),this._dollyStart.copy(this._dollyEnd),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM,editor:this.name})}processMouseUp(e,t){this.state===this.StateType.DOLLY&&t.addEditor(this,"processMouseMoveUpRender",e)}processMouseMoveUpRender(e){const t=this.cameraControl;return this.state=this.StateType.NONE,t.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ZOOM,editor:this.name}),!0}processTouchstart(e,t){2===e.touches.length&&(r.EditorConfig.NoZoom||2===e.touches.length&&t.addEditor(this,"processZoomTouchstartOnRender",e))}processZoomTouchstartOnRender(e){const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;this._dollyStart.set(0,Math.sqrt(t*t+i*i)),this.state=this.StateType.DOLLY}processTouchmove(e,t){this.state===this.StateType.DOLLY&&(r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),e.preventDefault(),2===e.touches.length&&(this._isZooming=!0,this._timeHandle=setTimeout((()=>{this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END}),this._isZooming=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processZoomTouchmoveOnRender",e)))}processZoomTouchmoveOnRender(e){const t=this.cameraControl,i=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,a=Math.sqrt(i*i+n*n);if(this._dollyEnd.set(0,a),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)>3){const i=(.01*this.touchZoomSpeed+1e-4)*this._dollyDelta.y;this._dollyStart.copy(this._dollyEnd);const n=.5*(e.touches[0].clientX+e.touches[1].clientX),a=.5*(e.touches[0].clientY+e.touches[1].clientY);t.touchDolly(n,a,i),this.state=this.StateType.DOLLY,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}t.touchUpdate()}processTouchend(e,t){if(this.state!==this.StateType.DOLLY)return!1;t.addEditor(this,"processZoomTouchendOnRender",e)}processZoomTouchendOnRender(e){this.state=this.StateType.NONE,this.cameraControl.viewer.editorManager.cameraChange=!1,this.cameraControl.touchUpdate()}dynamicZoom(){let e=!1;Math.abs(this._curZoomFactor.scale)>r.Math.EPSILON2?e=!0:this._curZoomFactor.scale=0,void 0!==this.cameraControl.viewer.getBoundingBox()&&e&&(this._curZoomFactor.scale*=1-this.cameraControl.dynamicDampingFactor(),this._zoom(this._curZoomFactor.scale))}throughWallZoom(){let e=!1;Math.abs(this._curZoomFactor.scale)>r.Math.EPSILON2?e=!0:this._curZoomFactor.scale=0,e&&this.troughWall()}troughWall(){var e=this;e.viewer.cameraControl.userInputHelper.isThroughWall&&function(){if(!0===e._isThroughWalling)return;const t=e.viewer.cameraControl,i=t.camera,n=t.userInputHelper.throughWallDistance,a={position:i.position.clone(),target:i.target.clone(),up:i.realUp.clone()||i.up.clone(),zoom:i.zoom},s={position:i.position.clone().add(n),target:i.target.clone().add(n),up:a.up,zoom:a.zoom},o=e.viewer;e._isThroughWalling=!0;new Promise(((t,i)=>{const n=new r.CameraAnimator;n.setDuration(800),n.active(a,s,o,void 0,(()=>{e.viewer.cameraControl.userInputHelper.isThroughWall=!1,e.viewer.editorManager.enabled=!0,e._isThroughWalling=!1,t()}))}))}()}resetDynamicZoom(){this._curZoomFactor.scale=0}resetMobileParamsByBox(e){if(!r.GlobalData.IsMobile)return;let t=new THREE.Vector3;e.getSize(t);let i=this.cameraControl.viewer.modelManager.isMeterUnit()?100:1e5;(t.x>i||t.y>i)&&(this.touchZoomSpeed=.3)}setZoomSpeed(e){if(!r.Utils.isDefined(e))return void console.warn("The parameter speed is undefined.");if("number"!=typeof e)return void console.warn("The parameter speed is not a number.");let t=r.Math.clamp(e,0,1);return r.GlobalData.IsMobile?(this.touchZoomSpeed=t,t):(this.wheelZoomFactor=t/1e3,t)}getZoomSpeed(){return r.GlobalData.IsMobile?this.touchZoomSpeed:1e3*this.wheelZoomFactor}_zoom(e){this.cameraControl.zoom(e,this._curZoomFactor.clientX,this._curZoomFactor.clientY),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}}r.ZoomEditor=e}(),function(){class e extends r.NormalEditor{constructor(e){super(r.EditorMode.PAN,e),this.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this._panStart=new THREE.Vector3,this._panEnd=new THREE.Vector3,this._panDelta=new THREE.Vector3,this._panOffset=new THREE.Vector3,this._lastDampingOffset=new THREE.Vector3,this._curDampingOffset=new THREE.Vector3,this._worldDimension=new THREE.Vector3,this.enable=!0,this._moving=!1,this._panMoving=!1}destroy(){super.destroy(),this.mouseButtons=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._panOffset=null,this._lastDampingOffset=null,this._curDampingOffset=null,this._worldDimension=null}processMouseDown(e,t){e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||r.EditorConfig.NoPan||!this.enable||t.addEditor(this,"processMouseDownOnRender",e)}processMouseDownOnRender(e){const t=this.cameraControl;if(void 0===t.viewer.getBoundingBox())return;t.userInputWorking||(t.userInputWorking=!0),this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,this._panStart.set(e.clientX,e.clientY),this._panEnd.set(e.clientX,e.clientY),this._panOffset.set(0,0,0),this.resetDynamicPan();let i=this._panStart;t.userInputHelper.getWorldDimension(e.clientX,e.clientY,this._worldDimension);let n=r.EditorMode.PAN;this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:n,editor:this.name,startPt:i}),this.state=this.StateType.PAN}processMouseUp(e,t){if(this.state!==this.StateType.PAN)return!1;t.addEditor(this,"processMouseMoveUpOnRender",e)}processMouseMoveUpOnRender(e){return this.cameraControl.endOperation(),this.cameraControl.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.PAN,editor:this.name}),this.state=this.StateType.NONE,!0}processMouseMove(e,t){if(this.state!==this.StateType.PAN)return!1;r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._panMoving=!0,this._timeHandle=setTimeout((()=>{this._panMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processMouseMoveOnRender",e)}processMouseMoveOnRender(e){this._panEnd.set(e.clientX,e.clientY),this.cameraControl.isEnableDamping()||(this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<r.Math.EPSILON2&&Math.abs(this._panDelta.y)<r.Math.EPSILON2||(this.cameraControl.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),this.cameraControl.userInputHelper.adjustCameraForPan(this._panOffset),this._panStart.copy(this._panEnd),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_PANING,editor:this.name})))}processKeyDown(e,t){r.EditorConfig.NoKey||r.EditorConfig.NoPan||t.addEditor(this,"processKeyDownOnRender",e)}processKeyDownOnRender(e){const t=this.cameraControl;this._moving=!0;let i=!1,n=this.movementSpeed*r.EditorConfig.MovementSpeedRate,a=this.keyPanSpeed*r.EditorConfig.MovementSpeedRate;switch(e.keyCode){case r.Keys.ZERO:this.keyPanSpeed=this.defaultKeyPanSpeed,this.movementSpeed=this.defaultMovementSpeed;break;case r.Keys.PLUS:this.keyPanSpeed*=1.1,this.movementSpeed*=1.1;break;case r.Keys.SUB:this.keyPanSpeed*=.9,this.keyPanSpeed=this.keyPanSpeed<this.minKeyPanSpeed?this.minKeyPanSpeed:this.keyPanSpeed,this.movementSpeed*=.9,this.movementSpeed=this.movementSpeed<this.minMovementSpeed?this.minMovementSpeed:this.movementSpeed;break;case r.Keys.Q:t.pan(0,a),i=!0;break;case r.Keys.E:t.pan(0,-a),i=!0;break;case r.Keys.LEFT:case r.Keys.A:t.pan(a,0),i=!0;break;case r.Keys.RIGHT:case r.Keys.D:t.pan(-a,0),i=!0;break;case r.Keys.UP:case r.Keys.W:t.moveStraight(n,!e.shiftKey),i=!0;break;case r.Keys.DOWN:case r.Keys.S:t.moveStraight(-n,!e.shiftKey),i=!0}i&&(this.cameraControl.userInputWorking||(this.cameraControl.userInputWorking=!0))}processKeyUp(e){if(!r.EditorConfig.NoKey&&!r.EditorConfig.NoPan)switch(e.keyCode){case r.Keys.Q:case r.Keys.E:case r.Keys.LEFT:case r.Keys.A:case r.Keys.RIGHT:case r.Keys.D:case r.Keys.UP:case r.Keys.W:case r.Keys.DOWN:case r.Keys.S:this.cameraControl.onUserInputFinished()}}processTouchstart(e,t){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId),this.timeId=setTimeout(this.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),2===e.touches.length&&t.addEditor(this,"processPanTouchstartOnRender",e)}processPanTouchstartOnRender(e){if(r.EditorConfig.NoPan)return;if(void 0===this.cameraControl.viewer.getBoundingBox())return;let t=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);this.cameraControl.userInputHelper.getWorldDimension(t,i,this._worldDimension),this._panStart.set(t,i),this.state=this.StateType.PAN}processTouchmove(e,t){if(this.state!==this.StateType.PAN)return!1;this.timeId&&clearTimeout(this.timeId),e.preventDefault(),2===e.touches.length&&(r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._panMoving=!0,this._timeHandle=setTimeout((()=>{this._panMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processPanTouchmoveOnRender",e))}get mouseMoving(){return this._panMoving}processPanTouchmoveOnRender(e){const t=this.cameraControl;let i=.5*(e.touches[0].clientX+e.touches[1].clientX),n=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(i,n),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<r.Math.EPSILON1&&Math.abs(this._panDelta.y)<r.Math.EPSILON1)return!1;t.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),t.userInputHelper.adjustCameraForPan(this._panOffset),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_PANING}),t.touchUpdate()}processTouchend(e,t){if(this.state!==this.StateType.PAN)return!1;this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault()),t.addEditor(this,"processPanTouchendOnRender",e)}processPanTouchendOnRender(e){this.state=this.StateType.NONE,this.cameraControl.viewer.editorManager.cameraChange=!1,this.cameraControl.touchUpdate()}dynamicPan(){this._panDelta.subVectors(this._panEnd,this._panStart);let e=!1;if((Math.abs(this._panDelta.x)>r.Math.EPSILON2||Math.abs(this._panDelta.y)>r.Math.EPSILON2)&&(e=!0),this._lastDampingOffset.length()>r.Math.EPSILON2&&(e=!0),e){this._lastDampingOffset.add(this._panOffset),this._curDampingOffset.copy(this._lastDampingOffset);const e=this._curDampingOffset.multiplyScalar(this.cameraControl.dynamicDampingFactor());this.cameraControl.userInputHelper.adjustCameraForPan(e),this.cameraControl.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),this._panStart.copy(this._panEnd),this._lastDampingOffset.multiplyScalar(1-this.cameraControl.dynamicDampingFactor())}}resetDynamicPan(){this._lastDampingOffset.set(0,0,0),this._curDampingOffset.set(0,0,0)}}r.PanEditor=e}(),(()=>{class e extends r.BaseEditor{constructor(e){super(r.EditorMode.FLY,e),this.lookSpeed=.001,this.constrainPitch=!0,this.pitchMin=THREE.Math.degToRad(5)-.5*Math.PI,this.pitchMax=.5*Math.PI-this.pitchMin,this.pitchDeltaTotal=0,this.moveState=r.MoveDirection.NONE,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.lastMousePoint=new THREE.Vector2,this.isLockHeight=!1,this.lockedHeight=0,this.pickHelper=new r.PickHelper(e),this.intersectOfMouseDown=null}destroy(){super.destroy(),this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.lastMousePoint=null,this.intersectOfMouseDown=null,this.pickHelper.destroy(),this.pickHelper=null}processMouseDown(e){e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY);const t=this.cameraControl;if(this.intersectOfMouseDown=null,e.button===this.mouseButtons.ORBIT){if(r.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(r.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),t.userInputHelper.getWorldDimension(e.clientX,e.clientY,this._worldDimension),this.intersectOfMouseDown=t.getLastIntersect(),this.state=this.StateType.PAN,this.isLockHeight&&(this.lockedHeight=e.clientY)}}doPan(e,t){var i=this.cameraControl;this._panEnd.set(e,this.isLockHeight?this.lockedHeight:t),this._panDelta.subVectors(this._panEnd,this._panStart),0===this._panDelta.x&&0===this._panDelta.y||(i.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._pan),i.userInputHelper.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),i.update(!0))}processMouseMove(e){var t=this.cameraControl;if(e.preventDefault(),this.state===this.StateType.ROTATE){if(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),0!=this.rotateDelta.x||0!=this.rotateDelta.y){var i=this.rotateDelta.x*this.lookSpeed,r=this.rotateDelta.y*this.lookSpeed;t.rotateForFly(i,r,this.pitchMin,this.pitchMax)}}else this.state===this.StateType.PAN&&this.doPan(e.clientX,e.clientY)}processMouseUp(e){if(e.preventDefault(),e.stopPropagation(),e.button!==THREE.MOUSE.LEFT||this.lastMousePoint.x!==e.clientX||this.lastMousePoint.y!==e.clientY){this.intersectOfMouseDown=null;var t=this.cameraControl;switch(this.state){case this.StateType.ROTATE:this.rotateDelta.set(0,0);t.rotateForFly(0,0,this.pitchMin,this.pitchMax),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:"look",editor:this.name});break;case this.StateType.PAN:this.doPan(e.clientX,e.clientY)}t.endOperation(),this.state=this.StateType.NONE}else this.pickHelper.click(e,this.intersectOfMouseDown)}processHover(e){this.pickHelper.handleMouseHover(e)}processMouseWheel(e){e.preventDefault(),e.stopPropagation();var t=this.cameraControl;if(!r.EditorConfig.NoZoom){var i=e.wheelDelta||e.detail;i=Math.abs(i)>10?i:40*-i,i*=5e-4,r.EditorConfig.ReverseWheelDirection&&(i*=-1);var n=t.getContainerDimensions(),a=n.left+.5*n.width,s=n.top+.5*n.height;t.zoom(i,a,s)}}processKeyDown(e){if(!r.EditorConfig.NoKey&&!e.altKey){var t=r.MoveDirection,i=t.NONE;switch(e.keyCode){case r.Keys.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case r.Keys.PLUS:this.movementSpeed*=1.1;break;case r.Keys.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case r.Keys.UP:case r.Keys.W:i=t.FORWARD;break;case r.Keys.DOWN:case r.Keys.S:i=t.BACK;break;case r.Keys.LEFT:case r.Keys.A:i=t.LEFT;break;case r.Keys.RIGHT:case r.Keys.D:i=t.RIGHT;break;case r.Keys.Q:i=t.UP;break;case r.Keys.E:i=t.DOWN}i!==t.NONE&&(this.moveState|=i,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYDOWN,event:e,state:i,direction:t,editor:this.name}),this.cameraControl.updateFlyMove(this.moveState,this.movementSpeed*r.EditorConfig.MovementSpeedRate))}}processKeyUp(e){if(!r.EditorConfig.NoKey){var t=r.MoveDirection,i=t.NONE;switch(e.keyCode){case r.Keys.UP:case r.Keys.W:i=t.FORWARD;break;case r.Keys.DOWN:case r.Keys.S:i=t.BACK;break;case r.Keys.LEFT:case r.Keys.A:i=t.LEFT;break;case r.Keys.RIGHT:case r.Keys.D:i=t.RIGHT;break;case r.Keys.Q:i=t.UP;break;case r.Keys.E:i=t.DOWN}i!==t.NONE&&(this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYUP,event:e,state:i,direction:t,editor:this.name}),this.moveState&=~i)}}moveTo(e){this.cameraControl.updateFlyMove(e,this.movementSpeed*r.EditorConfig.MovementSpeedRate)}}r.FlyEditor=e})(),(()=>{class e extends r.BaseEditor{constructor(e){super(r.EditorMode.WALK,e),this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.pickHelper=new r.PickHelper(e),this.lastMousePoint=new THREE.Vector2,this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.startPt=new THREE.Vector2,this.timeId=null,this.rotateSpeed=1,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,r.Utils.isMobileDevice()?this.selectPad=new r.SelectPad(this):this.selectPad=null,this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.zoomDelta=0,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this.firstRotate=!0,this.dragLook=!0,this.lockHeightEnabled=!1,this.isLockHeight=!1,this.lockedHeight=0,this.pickEnabled=!0,this._keyboardRotationDegree=7,this.defaultMovementSpeed=750,this.movementSpeed=this.defaultMovementSpeed}destroy(){super.destroy(),this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null),this.timeId&&(clearTimeout(this.timeId),this.timeId=null),this._clock=null,this._animateBinded=null,this.mouseButtons=null,this.moveState=null,this.startPt=null,this.lastMousePoint=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._rotateStart=null,this._rotateEnd=null,this._rotateDelta=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._dollyCenter=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.moveVector=null,this.rotationVector=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null}_animate(){this._reqid=requestAnimationFrame(this._animateBinded),this.updateWalkMove()}_start(){this._animate()}_stop(){cancelAnimationFrame(this._reqid)}_updateMovement(){this.moveVector.x=-this.moveState.left+this.moveState.right,this.isLockHeight?this.moveVector.y=0:this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-this.moveState.forward+this.moveState.back}_updateRotation(){r.EditorConfig.LockAxisZ?this.rotationVector.x=0:this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}_doRotate(e){e.x*=r.GlobalData.WalkRotationSpeed,e.y*=r.GlobalData.WalkRotationSpeed;var t=this.cameraControl.getContainerDimensions(),i=t.width/2,n=t.height/2;this.moveState.yawLeft=-e.x/i,this.moveState.pitchDown=e.y/n,this._updateRotation()}processMouseDown(e){if(e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY),this.firstRotate=!1,e.button===this.mouseButtons.ORBIT){if(r.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}}processMouseUp(e){return e.preventDefault(),e.stopPropagation(),this.pickEnabled&&(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:"look",editor:this.name})),this.state=this.StateType.NONE,!0)}processMouseMove(e){e.preventDefault(),this.dragLook&&this.state===this.StateType.ROTATE&&(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))}processTouchstart(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);switch(this.timeId=setTimeout(this.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE;break;case 2:if(!r.EditorConfig.NoPan){var t=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(t,i)}break;default:this.state=this.StateType.NONE}}processTouchmove(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:this.dragLook&&this.state===this.StateType.ROTATE&&(this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateStart.copy(this._rotateEnd),this._doRotate(this._rotateDelta));break;case 2:if(t.clearTouchRotateState(),!r.EditorConfig.NoPan){var i=.5*(e.touches[0].clientX+e.touches[1].clientX),n=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(i,n),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;t.userInputHelper.getWorldDimension(i,n,this._worldDimension),t.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._pan),t.userInputHelper.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()}processTouchend(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}}processHover(e){e.preventDefault(),this.dragLook||(this.firstRotate&&(this.firstRotate=!1,this.rotateStart.set(e.clientX,e.clientY)),this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))}_rotateDegree(e){this.rotateStart||(this.rotateStart=new THREE.Vector2),this.rotateEnd.set(e.x,e.y),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta)}processKeyDown(e){if(r.EditorConfig.NoKey)return;if(e.altKey)return;var t=r.MoveDirection.NONE,i=r.Keys;let n=!0;switch(e.keyCode){case i.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case i.PLUS:this.movementSpeed*=1.1;break;case i.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case i.UP:n=!1,this._rotateDegree({x:this.rotateStart.x,y:this.rotateStart.y-this._keyboardRotationDegree});break;case i.W:t=r.MoveDirection.FORWARD,this.moveState.forward=1;break;case i.DOWN:n=!1,this._rotateDegree({x:this.rotateStart.x,y:this.rotateStart.y+this._keyboardRotationDegree});break;case i.S:t=r.MoveDirection.BACK,this.moveState.back=1;break;case i.LEFT:n=!1,this._rotateDegree({x:this.rotateStart.x-this._keyboardRotationDegree,y:this.rotateStart.y});break;case i.A:t=r.MoveDirection.LEFT,this.moveState.left=1;break;case i.RIGHT:n=!1,this._rotateDegree({x:this.rotateStart.x+this._keyboardRotationDegree,y:this.rotateStart.y});break;case i.D:t=r.MoveDirection.RIGHT,this.moveState.right=1;break;case i.Q:t=r.MoveDirection.UP,this.moveState.up=1;break;case i.E:t=r.MoveDirection.DOWN,this.moveState.down=1;break;case i.TAB:return this.moveVector.set(0,0,0),this.moveState.forward=0,this.moveState.back=0,this.moveState.left=0,this.moveState.right=0,this.moveState.up=0,void(this.moveState.down=0);default:return}n&&(this._updateMovement(),this._updateRotation(),t!==r.MoveDirection.NONE&&this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYDOWN,event:e,direction:t,editor:this.name}))}processKeyUp(e){if(r.EditorConfig.NoKey)return;var t=r.MoveDirection.NONE,i=r.Keys;let n=!0;switch(e.keyCode){case i.UP:n=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.W:t=r.MoveDirection.FORWARD,this.moveState.forward=0;break;case i.DOWN:n=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.S:t=r.MoveDirection.BACK,this.moveState.back=0;break;case i.LEFT:n=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.A:t=r.MoveDirection.LEFT,this.moveState.left=0;break;case i.RIGHT:n=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.D:t=r.MoveDirection.RIGHT,this.moveState.right=0;break;case i.Q:t=r.MoveDirection.UP,this.moveState.up=0;break;case i.E:t=r.MoveDirection.DOWN,this.moveState.down=0;break;default:return}n&&(this._updateMovement(),this._updateRotation(),t!==r.MoveDirection.NONE&&this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYUP,event:e,direction:t,editor:this.name}))}updateWalkMove(){var e=this._clock.getDelta(),t=this.cameraControl,i=t.camera.position.y;if(0===this.moveVector.x&&0===this.moveVector.y&&0===this.moveVector.z&&0===this.rotationVector.x&&0===this.rotationVector.y&&0===this.rotationVector.z&&0===this.zoomDelta&&0===t.gravity)return;var n=this.movementSpeed*r.EditorConfig.WalkSpeedRate*e;if(1==r.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(),t.computeGravity()),t.dirtyCamera(!0),0!==this.zoomDelta){var a=this.zoomDelta*e;t.userInputHelper.adjustCameraForZoom(a),this.zoomDelta=0}t.translateCameraForWalk(this.moveVector,n),this.dragLook?t.rotateCameraForWalk(this.rotationVector,1):t.rotateCameraForWalk(this.rotationVector,2),t.flyOnWorld(!1);let s=t.viewer.modelManager;i!==t.camera.position.y&&s.dispatchEvent({type:r.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()}),s.dispatchEvent({type:r.EVENTS.ON_EDITOR_WALKING})}onEnter(){var e=this.cameraControl.scene,t=this.cameraControl.getCamera();t.isPerspective||(console.log("Current camera is Orthographic"),t.toPerspective()),e.getBoundingBox().containsPoint(t.position)&&t.position.y!=t.target.y&&function(e){var t=e.target.clone().sub(e.position),i=t.length(),r=t.clone();r.y=0,r.normalize(),r.multiplyScalar(i),e.target.addVectors(e.position,r)}(t),this._start()}onExit(){this._stop(),this.moveVector=new THREE.Vector3(0,0,0),this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}}rotateTo(e){this._doRotate(e)}moveTo(e,t,i){if(void 0===i&&(i=!0),void 0===t&&(t=1),i)switch(e){case r.MoveDirection.FORWARD:this.moveState.forward=t;break;case r.MoveDirection.BACK:this.moveState.back=t;break;case r.MoveDirection.LEFT:this.moveState.left=t;break;case r.MoveDirection.RIGHT:this.moveState.right=t;break;case r.MoveDirection.UP:this.moveState.up=t;break;case r.MoveDirection.DOWN:this.moveState.down=t}else switch(e){case r.MoveDirection.FORWARD:this.moveState.forward=0;break;case r.MoveDirection.BACK:this.moveState.back=0;break;case r.MoveDirection.LEFT:this.moveState.left=0;break;case r.MoveDirection.RIGHT:this.moveState.right=0;break;case r.MoveDirection.UP:this.moveState.up=0;break;case r.MoveDirection.DOWN:this.moveState.down=0}this._updateMovement()}setHeightLocked(e){this.lockHeightEnabled&&this.isLockHeight!==e&&(this.isLockHeight=e)}setDragLook(e){this.dragLook!==e&&(this.firstRotate=!0,this.dragLook=e)}}r.WalkEditor=e})(),(()=>{let e=new THREE.Vector3;(new THREE.Matrix4).makeRotationFromQuaternion((new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)));class t extends r.WalkEditor{constructor(e){super(e),this.isMeterUnit=e.viewer.modelManager.isMeterUnit(),this.object=null,this.unitRate=this.isMeterUnit?.001:1,this.cameraDis=5e3*this.unitRate,this.minCameraDis=3e3*this.unitRate,this.rotatePivot=new THREE.Vector3,this.objectId=null,this.externalObjectManager=null,this.mixer=null,this.actions=[],this.prepared=!1,this.rotating=!1,this.poseEnum={walk:0,run:1,stand:2},this.poseIndex=0,this.walkIndex=3,this.rotateQuaternion=new THREE.Quaternion,this.tmpVec=new THREE.Vector3,this.objectDirection=new THREE.Vector3(0,-1,0),this.objectInfoMap={},this.zoomWithCollision=!1,this.enableGTAO=!1,this._curPersonType=void 0,r.GlobalData.EnableHitDetection=!0,r.GlobalData.WalkingWithGravity=!0}destroy(){super.destroy(),this.object=null,this.rotatePivot=null,this.objectId=null,this.externalObjectManager=null,this.mixer=null,this.actions=null,this.objectInfoMap=null}_doRotate(t){let i=this.cameraControl,r=i.camera,n=r.target.clone(),a=r.position.clone();i.processRotate(t,i.viewer.worldToDrawing(this.rotatePivot)),this.object.visible=!1;var s=i.checkCollisionInCameraAndObject(this.object);this.object.visible=!0,s&&r.position.copy(s);let o=this.object.position;e.set(o.x,o.y,this.object.box.max.z);let l=i.scene.worldToDrawing(e);r.target.set(l.x,l.y,l.z);let d=i.viewer.drawingToWorld(r.position);this.object.box.containsPoint(d)&&(r.target.copy(n),r.position.copy(a)),this.updateRotateForObject(),i.updateCamera(),this.rotating=!0}processMouseUp(e){return e.preventDefault(),e.stopPropagation(),this.rotating=!1,this.pickEnabled&&(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0),this.state=this.StateType.NONE,!0)}processMouseWheel(t){var i=this.cameraControl;if(t.preventDefault(),t.stopPropagation(),!r.EditorConfig.NoZoom){var n=t.wheelDelta||t.detail;if(n=Math.abs(n)>10?n:40*-n,n*=this.wheelZoomFactor,r.EditorConfig.ReverseWheelDirection&&(n*=-1),!r.GlobalData.ConstraintZoom||i.cameraWithinMaximumRange())if(this.prepared){this.zoomDelta*n<0&&(this.zoomWithCollision=!1);let t=this.object.position;if(e.set(t.x,t.y,this.object.box.max.z),!this.zoomWithCollision&&(n<0||n>0&&i.camera.getDistanceByPos(e,i.scene.getRawMatrixGlobal())>this.minCameraDis)){let t=i.camera,r=t.position.clone(),a=t.target.clone();i.zoomWithCenter(n,e),i.checkCollisionInCameraAndObject(this.object)&&(t.position.set(r.x,r.y,r.z),t.target.set(a.x,a.y,a.z),this.zoomWithCollision=!0)}}else i.zoom(n,t.clientX,t.clientY);else i.resetCameraToMaximumRange();this.zoomDelta=n,i.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}}updateWalkMove(){if(!this.prepared)return;var e=this._clock.getDelta();this.mixer.update(e),this.object.updateMatrixWorld();var t=this.cameraControl,i=t.camera.position.y;if(0===this.moveVector.x&&0===this.moveVector.y&&0===this.moveVector.z&&!this.rotating&&0===t.gravity)return this.changePose(this.poseEnum.stand),void t.flyOnWorld(!1);this.object.visible&&this.changePose(this.walkIndex),this.zoomWithCollision=!1;var n=this.movementSpeed*r.EditorConfig.WalkSpeedRate*e;const a=this.object.visible;this.object.visible=!1,1==r.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(this.object),t.computeGravity(this.object)),t.dirtyCamera(!0),t.translateCameraForThirdpersonWalk(this.moveVector,n,this.object,this.cameraDis),this.object.visible=a;var s=this.object.position;this.rotatePivot.set(s.x,s.y,this.object.box.max.z),this.updateRotateForObject(),this.externalObjectManager.setTransform(this.objectId,void 0,void 0,this.rotateQuaternion),t.flyOnWorld(!1);let o=t.viewer.modelManager;i!==t.camera.position.y&&o.dispatchEvent({type:r.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()}),o.dispatchEvent({type:r.EVENTS.ON_EDITOR_WALKING})}updateRotateForObject(e,t){const i=this.cameraControl;this.tmpVec.copy(t||i.camera.target);const r=i.viewer.drawingToWorld(this.tmpVec);this.tmpVec.copy(e||i.camera.position);const n=i.viewer.drawingToWorld(this.tmpVec),a=r.subVectors(r,n);a.z=0,a.normalize(),this.rotateQuaternion.setFromUnitVectors(this.objectDirection,a)}setThirdPersonHeight(t){t&&this.personHeight!==t&&(this.personHeight=t,this._updateCameraAndPersonPosition((()=>{var t=new THREE.Vector3(0,.5*this.object.box.getSize(e).y,0);this.distanceTol=Math.abs(this.cameraControl.scene.worldToDrawing(t).z);let i=this.walkIndex===this.poseEnum.run;this.oldCollisionDis=this.cameraControl.collisionManager.getDistance(),this.cameraControl.collisionManager.setDistance((i?8:1)+this.distanceTol)})))}_getThirdPersonScaleFactor(){if(!this.object||void 0===this.personHeight)return 1;return this.object.originBox.getSize(e),this.personHeight/e.z}_updateCameraAndPersonPosition(e){const t=this.cameraControl.camera,i=this.cameraControl.viewer,r=t.position;let n=new THREE.Vector3;this.object.box.getSize(n);let a=new THREE.Vector3(0,0,.5*n.z);const s=this.object.position;a.subVectors(s,a);const o=this._getThirdPersonScaleFactor(),l=1e3*this.unitRate*o;this.externalObjectManager.setTransform(this.objectId,void 0,new THREE.Vector3(l,l,l)),this.object.box.getSize(n);let d=new THREE.Vector3(0,0,.5*n.z);if(d.add(a),this.object.manHeight=void 0,d.equals(this.object.position))return void(e&&e());let h=new THREE.Vector3(0,0,n.z);h.add(a);const c=this._getCameraPositionByPos(r,h),u=i.worldToDrawing(h);this.updateRotateForObject(c,u),this.externalObjectManager.setTransform(this.objectId,d,void 0,this.rotateQuaternion),this.rotatePivot.set(d.x,d.y,h.z);const p=u.clone().sub(c),m=p.length(),f=p.normalize();t.LookAt(u,f,new THREE.Vector3(0,1,0),m),i.cameraControl.update(!0,!0),e&&e()}setThirdPerson(t,i){const{objectId:n,externalObjectManager:a,isRunMode:s,initialPosition:o,personType:l,personHeight:d,animationClip:h}=i;this.object=t,this.object.visible=!1,this.object.traverse((function(e){e.frustumCulled=!1})),this.objectId=n,this.externalObjectManager=a;let c=new THREE.Vector3;switch(l){case r.ThirdPersonType.ConstructionWorker:this.object.originBox.getSize(c),this.object.originBox.min.y-=.15*(c.x-c.y),this.object.originBox.min.x/=2.3,this.object.originBox.max.x/=2.3,this.object.originBox.min.z-=.13*c.z;break;case r.ThirdPersonType.OfficeMale:default:this.object.originBox.getSize(c),this.object.originBox.max.z-=.45*c.z,this.object.originBox.min.z-=.5*c.z,this.object.originBox.min.y-=.3*(c.x-c.y)}this.mixer=new THREE.AnimationMixer(this.object);const u=THREE.AnimationUtils.subclip(this.object.animations[0],"walk",h.walk[0],h.walk[1],30),p=THREE.AnimationUtils.subclip(this.object.animations[0],"run",h.run[0],h.run[1],30),m=THREE.AnimationUtils.subclip(this.object.animations[0],"stand",h.stand[0],h.stand[1],30);this.actions=[],this.actions[this.poseEnum.walk]=this.mixer.clipAction(u),this.actions[this.poseEnum.run]=this.mixer.clipAction(p),this.actions[this.poseEnum.stand]=this.mixer.clipAction(m),this.actions[this.poseEnum.stand].play(),this.prepare(s,o,d,l),this.objectInfoMap[l]={object:t,objectId:n,walkAction:this.actions[this.poseEnum.walk],runAction:this.actions[this.poseEnum.run],standAction:this.actions[this.poseEnum.stand],mixer:this.mixer};var f=new THREE.Vector3(0,.5*t.box.getSize(e).y,0);this.distanceTol=Math.abs(this.cameraControl.scene.worldToDrawing(f).z)}_initializeObject(){var e=this.cameraControl,t=this.object;t.visible=!0,t.disPickable=!0,this.changePose(this.poseEnum.stand),this.object.updateMatrixWorld(),e.flyOnWorld(!1)}prepare(e,t,i,r){this.objectInfoMap[r]&&(this.object=this.objectInfoMap[r].object,this.objectId=this.objectInfoMap[r].objectId,this.actions[this.poseEnum.walk]=this.objectInfoMap[r].walkAction,this.actions[this.poseEnum.run]=this.objectInfoMap[r].runAction,this.actions[this.poseEnum.stand]=this.objectInfoMap[r].standAction,this.mixer=this.objectInfoMap[r].mixer,this.object.manHeight=void 0),this.personHeight=i,this.object.visible=!1,this._initializeCamera(t,r,(()=>{this.walkIndex=e?this.poseEnum.run:this.poseEnum.walk,this._initializeObject(),this.prepared=!0,this.oldCollisionDis=this.cameraControl.collisionManager.getDistance(),this.cameraControl.collisionManager.setDistance((e?8:1)+this.distanceTol),this.oldMinPitch=this.cameraControl.minPitch,this.oldMaxPitch=this.cameraControl.maxPitch,this.cameraControl.minPitch=-Math.PI/3,this.cameraControl.maxPitch=Math.PI/3}))}onEnter(){super.onEnter(),this.enableGTAO=r.GlobalData.GTAO,!0===this.enableGTAO&&(r.GlobalData.GTAO=!1)}onExit(){super.onExit(),this.prepared=!1,this.object.visible=!1,r.GlobalData.GTAO=this.enableGTAO,this.cameraControl.collisionManager.setDistance(this.oldCollisionDis),this.cameraControl.minPitch=this.oldMinPitch,this.cameraControl.maxPitch=this.oldMaxPitch,this.cameraControl.flyOnWorld(!1)}changePose(e){if(this.poseIndex!=e){var t=this.actions[this.poseIndex],i=this.actions[e],n=1*this.unitRate/r.EditorConfig.WalkSpeedRate;t.fadeOut(n),i.reset(),i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.fadeIn(n),i.play(),this.poseIndex=e}}_getCameraPositionByPos(e,t){let i=e.clone();const r=this.cameraControl.scene.getRawMatrixGlobal();let n=new THREE.Matrix4;n.copy(r).invert(),i.applyMatrix4(n);var a=i.distanceTo(t),s=this.cameraDis/a,o=new THREE.Vector3;return o.subVectors(i,t),o.multiplyScalar(s),o.addVectors(t,o),o.applyMatrix4(r),o}_initializeCamera(e,t,i){e&&null!=e.x&&null!=e.y&&null!=e.z?this._initializeCameraWithPosition(e,t,i):this._initializeCameraWithoutPosition(i)}_initializeCameraWithPosition(t,i,r){var n=this.cameraControl.camera,a=this.cameraControl.viewer,s=n.position,o=this._getThirdPersonScaleFactor(),l=1e3*this.unitRate*o;this.externalObjectManager.setTransform(this.objectId,void 0,new THREE.Vector3(l,l,l));let d=new THREE.Vector3;this.object.box.getSize(d);let h=new THREE.Vector3(0,0,.5*d.z);if(h.addVectors(h,t),h.equals(this.object.position)&&this._curPersonType===i)return void(r&&r());e.copy(this.object.position);let c=new THREE.Vector3(0,0,d.z);c.addVectors(c,t);let u=this._getCameraPositionByPos(s,c);var p=a.worldToDrawing(c);this.updateRotateForObject(u,p),this.externalObjectManager.setTransform(this.objectId,h,void 0,this.rotateQuaternion),this.rotatePivot.set(h.x,h.y,c.z);const m=a.getScene(),f=this.externalObjectManager.meshes;var g=a.modelManager.boundingBox.clone();for(var v in f)for(var y=0;y<f[v].length;y++){var M=f[v][y].box;g.min.x=Math.min(g.min.x,M.min.x),g.min.y=Math.min(g.min.y,M.min.y),g.min.z=Math.min(g.min.z,M.min.z),g.max.x=Math.max(g.max.x,M.max.x),g.max.y=Math.max(g.max.y,M.max.y),g.max.z=Math.max(g.max.z,M.max.z)}m.setBoundingBoxWorld(g);let E=(new THREE.Vector3).subVectors(u,p);n._direction?E.addVectors(n._direction.clone().normalize().multiplyScalar(E.length()),n.position):E=n.target.clone();var x={position:n.position.clone(),target:E,up:n.realUp.clone()||n.up.clone(),zoom:n.zoom},_={position:u,target:p,up:new THREE.Vector3(0,1,0),zoom:n.zoom};if(h.equals(e)){this._curPersonType=i,n.setZoom(n.zoom);const e=p.clone().sub(u),t=e.length(),s=e.normalize();return n.LookAt(p,s,_.up,t),a.cameraControl.update(!0,!0),void(r&&r())}a.animator.active(x,_,a,(function(e){a.cameraControl.update(!0,!0)}),(()=>{this._curPersonType=i,r&&r()}))}_initializeCameraWithoutPosition(t){if(this.prepared)t&&t();else{var i=this.cameraControl.camera,r=this.cameraControl.viewer,n=i.position,a=this.cameraControl.scene.getBoundingBox(),s=(this.cameraControl.scene.getBoundingBoxWorld(),new THREE.Vector3(n.x,a.max.y,n.z)),o=function(e,t){var i=e.x<t.min.x?0:1,r=e.x<t.max.x?0:2,n=e.z<t.min.z?0:4,a=e.z<t.max.z?0:8,s=t.max.y,o=e;switch(i|r|n|a){case 0:o=new THREE.Vector3(t.min.x,s,t.min.z);break;case 1:o=new THREE.Vector3(e.x,s,t.min.z);break;case 3:o=new THREE.Vector3(t.max.x,s,t.min.z);break;case 4:o=new THREE.Vector3(t.min.x,s,e.z);break;case 7:o=new THREE.Vector3(t.max.x,s,e.z);break;case 12:o=new THREE.Vector3(t.min.x,s,t.max.z);break;case 13:o=new THREE.Vector3(e.x,s,t.max.z);break;case 15:o=new THREE.Vector3(t.max.x,s,t.max.z)}return o}(s,a),l=o.equals(s)?i.target.clone():a.getCenter(e);l.y=o.y;var d=this.cameraControl.scene.getRawMatrixGlobal(),h=i.getPositionByDis(this.cameraDis,d,o,l);h.z=r.drawingToWorld(o).z,this.updateRotateForObject(o,l);var c=this._getThirdPersonScaleFactor(),u=1e3*this.unitRate*c;this.externalObjectManager.setTransform(this.objectId,h,new THREE.Vector3(u,u,u),this.rotateQuaternion),this.cameraControl.computeManHeight(this.object),this.cameraControl.computeGravity(this.object),o.y-=this.cameraControl.gravity*r.getScene().getGlobalScaleFactor(),l.y=o.y,this.cameraControl.gravity=0;var p=i.getPositionByDis(this.cameraDis,d,o,l);this.externalObjectManager.setTransform(this.objectId,p),this.rotatePivot.set(p.x,p.y,this.object.box.max.z);var m={position:i.position.clone(),target:i.target.clone(),up:i.realUp.clone()||i.up.clone(),zoom:i.zoom},f={position:o,target:l,up:new THREE.Vector3(0,1,0),zoom:i.zoom};r.animator.active(m,f,r,(function(e){r.cameraControl.update(!0,!0)}),(function(){t&&t()}))}}getObjectPosition(){if(this.object){let e=this.object.position,t=new THREE.Vector3;return this.object.box.getSize(t),{x:e.x,y:e.y,z:e.z-.5*t.z}}return null}}r.ThirdPersonWalkEditor=t})(),r.EditorManager=function(){this.editor=null,this.editors={},this.tools=[],this.domElement=null,this.enabled=!0,this.isUpdateRenderList=!0,this._mousePressed=!1,this._mouseClickDelay=!1,this.userInputEditor=null,this._pressedKeys=[];var e=this;function t(t){if(!function(e,t){if(e==t)return!0;if(!t||!t.nodeType||1!==t.nodeType)return!1;if(e.contains)return e.contains(t);if(e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));for(var i=t.parentNode;i&&i!=window.document.body;){if(i==e)return!0;i=i.parentNode}return!1}(e.domElement,t.target)&&(e.editor.name==r.EditorMode.THIRDPERSONWALK||e.editor.name==r.EditorMode.WALK)&&e._pressedKeys.length>0){for(let t=0;t<e._pressedKeys.length;t++){let i=new KeyboardEvent("keyup",{keyCode:e._pressedKeys[t]});e.editor.processKeyUp(i)}e._pressedKeys.length=0}}function i(t){if(!e.enabled)return void(e.cameraChange=!1);const i=e.tools;for(var r=i.length-1;r>=0;r--)if(i[r].onEvent(t)){if("mouseup"===t.type)e.userInputEditor.processMouseUp(t),e._mousePressed=!1,e.clearDelayClickState();return}switch(t.type){case"touchmove":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchmove(t),e.userInputEditor.processTouchmove(t)}(t);break;case"touchstart":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchstart(t),e.userInputEditor.processTouchstart(t)}(t);break;case"touchend":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchend(t),e.userInputEditor.processTouchend(t)}(t);break;case"keydown":!function(t){e._pressedKeys.indexOf(t.keyCode)<=-1&&e._pressedKeys.push(t.keyCode),e.editor.isUserInputEditor()||e.editor.processKeyDown(t),e.userInputEditor.processKeyDown(t)}(t);break;case"keyup":!function(t){var i=e._pressedKeys.indexOf(t.keyCode);i>-1&&e._pressedKeys.splice(i,1),e.editor.isUserInputEditor()||e.editor.processKeyUp(t),e.userInputEditor.processKeyUp(t)}(t);break;case"mousewheel":case"DOMMouseScroll":!function(t){e.cameraChange=!0,e.editor.isUserInputEditor()||e.editor.processMouseWheel(t),e.userInputEditor.processMouseWheel(t)}(t);break;case"mousedown":!function(t){n(),e._mousePressed=!0,e.isUpdateRenderList=!1,e.editor.isUserInputEditor()||e.editor.processMouseDown(t),e.userInputEditor.processMouseDown(t)}(t);break;case"mousemove":!function(t){e._mousePressed?(e.isUpdateRenderList=!1,e.cameraChange=!0,e.editor.isUserInputEditor()||e.editor.processMouseMove(t),e.userInputEditor.processMouseMove(t)):e.editor.processHover(t)}(t);break;case"mouseup":!function(t){e.isUpdateRenderList=!0,e._mousePressed&&(e.editor.isUserInputEditor()||e.editor.processMouseUp(t),e.userInputEditor.processMouseUp(t),e._mousePressed=!1,e.isMouseDelayClick()||e.clearDelayClickState())}(t);break;case"dblclick":e.editor.processMouseDoubleClick(t)}}function n(){if(e.domElement){var t=e.domElement.querySelector("#cloud-main-canvas");t&&t.focus&&t.focus()}}function a(e){e.preventDefault()}this.registerDomEventListeners=function(e){this.domElement=e;let s=()=>{e.addEventListener("touchstart",i,!1),e.addEventListener("touchend",i,!1),e.addEventListener("touchmove",i,!1)},o=()=>{e.addEventListener("contextmenu",a,!1),e.addEventListener("mousedown",i,!1),e.addEventListener("mousewheel",i,!1),e.addEventListener("DOMMouseScroll",i,!1),e.addEventListener("dblclick",i,!1),window.addEventListener("mousemove",i,!1),window.addEventListener("mouseup",i,!1),e.addEventListener("keydown",i,!1),e.addEventListener("keyup",i,!1),window.addEventListener("mousedown",t,!1)};"windows"===r.Utils.getOS()?(s(),o()):r.GlobalData.IsMobile?s():o(),n()},this.unregisterDomEventListeners=function(e){let n=()=>{e.removeEventListener("touchstart",i,!1),e.removeEventListener("touchend",i,!1),e.removeEventListener("touchmove",i,!1)},s=()=>{e.removeEventListener("contextmenu",a,!1),e.removeEventListener("mousedown",i,!1),e.removeEventListener("mousewheel",i,!1),e.removeEventListener("DOMMouseScroll",i,!1),e.removeEventListener("dblclick",i,!1),window.removeEventListener("mousemove",i,!1),window.removeEventListener("mouseup",i,!1),e.removeEventListener("keydown",i,!1),e.removeEventListener("keyup",i,!1),window.removeEventListener("mousedown",t,!1)};"windows"===r.Utils.getOS()?(n(),s()):r.GlobalData.IsMobile?n():s()}},r.EditorManager.prototype={constructor:r.EditorManager,destroy:function(){for(var e in this.editors){this.editors[e].destroy()}this.editors=null,this.editor=null;for(var t=0,i=this.tools.length;t<i;t++)this.tools[t].destroy();this.tools=null,this.unregisterDomEventListeners(this.domElement),this.domElement=null},getCurrentEditorName:function(){return this.editor?this.editor.name:""},_getEditorByName:function(e,t){let i=this.editors[t];const n=r.EditorMode;this.viewer=e;const a=e.cameraControl;switch(t){case n.ORBIT:this.userInputEditor.setOrbitEditorMode(),i=this.userInputEditor.orbitEditor;break;case n.PAN:this.userInputEditor.setPanEditorMode(),i=this.userInputEditor.panEditor;break;case n.ZOOM:this.userInputEditor.setZoomEditorMode(),i=this.userInputEditor.zoomEditor;break;case n.PICK:this.userInputEditor.setDefaultEditorMode(),i=r.Utils.isDefined(i)?i:new r.PickEditor(a);break;case n.FLY:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.FlyEditor(a);break;case n.WALK:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.WalkEditor(a);break;case n.THIRDPERSONWALK:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.ThirdPersonWalkEditor(a);break;default:i=null,console.error("invalid editor name")}return i&&(i.name=t,this.editors[t]=i),i},getCurrentEditor:function(){return this.editor},getUserInputEditor(){return this.userInputEditor},setupUserInputEditor(e){this.userInputEditor=new r.UserInputEditor(e)},setEditorMode:function(e,t){var i=this._getEditorByName(e,t);i&&this.editor!==i&&(null!==this.editor&&(this.editor.dispatchEvent({type:r.EVENTS.ON_EDITOR_EXIST,name:this.editor.getName()}),this.editor.onExit()),this.editor=i,this.editor.onEnter(),this.editor.dispatchEvent({type:r.EVENTS.ON_EDITOR_ENTER,name:this.editor.getName()}))},getToolByName:function(e){for(var t=this.tools.length,i=0;i<t;++i)if(this.tools[i].name==e)return this.tools[i];return null},enableTool:function(e,t){var i=r.EditToolMode,n=null;if(n=this.getToolByName(t))return n;switch(t){case i.PICK_BY_RECT:n=new r.RectPickTool(e);break;case i.ZOOM_BY_RECT:n=new r.RectZoomTool(e);break;case i.CLIP_BY_BOX:n=new r.ClipPlanesTool(e);break;case i.CLIP_FILL:n=new r.FillClipPlaneTool(e);break;case i.PICK_BY_MEASURE:n=new r.MeasureTool(e);break;case i.VIEW_SHED_ANALYSIS:n=new r.ViewshedTool(e);break;case i.VOLUME_MEASURE:n=new r.VolumeMeasureTool(e)}return n&&this.tools.push(n),n},disableTool:function(e){for(var t=this.tools,i=0,r=t.length;i<r;i++)if(t[i].name==e){t[i].onExit(),t.splice(i,1);break}},setInteractiveState:function(e){this.enabled=e},update:function(){this.userInputEditor.update()},onRender:function(){this.userInputEditor.onRender()},clearDelayClickState:function(){this.tools.forEach((e=>{e.clearDelayClickState()}))},setDelayClickState:function(e){this._mouseClickDelay=e},isMouseDelayClick:function(){return this._mouseClickDelay}},r.SelectPad=class{constructor(e){this.editor=e,this.cameraControl=e.cameraControl,this.dim=this.cameraControl.getContainerDimensions(),this.pad=null,this.padSize=96,this.startPt=new THREE.Vector2,this.position=new THREE.Vector2,this.callback=null,this.intersect=null,this.init(),this.padInitBind=this.padInit.bind(this),this.padOnTouchStartBind=this.onTouchStart.bind(this),this.padOnTouchEndBind=this.onTouchEnd.bind(this),this.padOnTouchMoveBind=this.onTouchMove.bind(this)}destroy(){this.editor=null,this.cameraControl=null,this.dim=null,this.pad=null,this.startPt=null,this.position=null,this.callback=null,this.intersect=null}init(){window.addEventListener("resize",this.padInitBind,!1),this.pad=document.createElement("div"),this.padInit(),this.cameraControl.domElement.appendChild(this.pad),this.addEventListener()}addEventListener(){this.pad.addEventListener("touchstart",this.padOnTouchStartBind,!1),this.pad.addEventListener("touchmove",this.padOnTouchMoveBind,!1),this.pad.addEventListener("touchend",this.padOnTouchEndBind,!1)}padInit(){null!=this.pad&&(this.pad.style.backgroundImage="url(images/selectPad.png)",this.pad.style.backgroundSize="100%",this.pad.style.position="absolute",this.pad.style.width=this.padSize.toString()+"px",this.pad.style.height=this.padSize.toString()+"px",this.pad.style.zIndex="10",this.pad.style.display="none")}showOverlay(e){this.position=e,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.pad.style.display=""}hideOverlay(){this.pad.style.display="none"}pick(){var e=this.position.x,t=this.position.y,i=this.cameraControl,r=(this.editor.pickHelper,i.viewer.modelManager.sceneState),n=this,a=new THREE.Vector2(e,t),s=i.getIntersectContext(a);i.intersector.pick(s,(function(e){if(r.clearSelection(),!e)return i.updateView(!0),void(n.intersect=null);var t=e.userId;i.viewer.getScene().intersectToWorld(e,i.viewer),r.addSelection([t]),n.intersect=e,i.updateView(!0)})),null!=n.intersect&&(n.intersect.cx=e,n.intersect.cy=t)}onTouchStart(e){1===e.touches.length&&(e.stopPropagation(),e.preventDefault(),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY))}onTouchMove(e){if(1===e.touches.length){e.stopPropagation(),e.preventDefault();var t=e.touches[0].clientX-this.startPt.x,i=e.touches[0].clientY-this.startPt.y;this.position.x+=t,this.position.y+=i,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.pick(e)}}onTouchEnd(e){e.stopPropagation(),null!=this.callback?this.callback(this.intersect):console.log("selectPad click",this.intersect)}},r.UserInputEditor=class{constructor(e){this.viewer=e,this.cameraControl=e.cameraControl,this.panEditor=new r.PanEditor(this.cameraControl),this.orbitEditor=new r.OrbitEditor(this.cameraControl),this.zoomEditor=new r.ZoomEditor(this.cameraControl),this.enable=!0,this.currentMouseMode="right",this.actionTool=new r.ActionTool(this.cameraControl)}setDefaultEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!0,this.zoomEditor.enable=!0,this.switchHandMode(this.currentMouseMode)}setPanEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!1,this.zoomEditor.enable=!0,this.panEditor.mouseButtons={PAN2:THREE.MOUSE.RIGHT,PAN:THREE.MOUSE.LEFT},this.zoomEditor.mouseButtons={}}setOrbitEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!0,this.zoomEditor.enable=!0,this.setDefaultEditorMode()}setZoomEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!1,this.zoomEditor.enable=!0,this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.zoomEditor.mouseButtons={ZOOM:THREE.MOUSE.LEFT}}switchHandMode(e){this.currentMouseMode=e,"left"===e?(this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.orbitEditor.mouseButtons={ORBIT:THREE.MOUSE.LEFT}):"right"===e&&(this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.orbitEditor.mouseButtons={ORBIT:THREE.MOUSE.RIGHT})}update(){this.cameraControl.isEnableDamping()&&this.enable?(this.panEditor.dynamicPan(),this.orbitEditor.dynamicRotate(),this.zoomEditor.dynamicZoom()):this.cameraControl.userInputHelper.isThroughWall&&this.zoomEditor.throughWallZoom()}onRender(){this.actionTool.isProcessingMouse()&&this.actionTool.execute()}processMouseDown(e){this.enable&&(this.actionEditorList=[],this.cameraControl.isEnableDamping()&&this.resetDynamicMoving(),this.panEditor.processMouseDown(e,this.actionTool),this.orbitEditor.processMouseDown(e,this.actionTool),this.zoomEditor.processMouseDown(e,this.actionTool))}processMouseMove(e){this.enable&&(this.panEditor.processMouseMove(e,this.actionTool),this.orbitEditor.processMouseMove(e,this.actionTool),this.zoomEditor.processMouseMove(e,this.actionTool))}processMouseUp(e){this.enable&&(this.panEditor.processMouseUp(e,this.actionTool),this.orbitEditor.processMouseUp(e,this.actionTool),this.zoomEditor.processMouseUp(e,this.actionTool))}processMouseWheel(e){this.enable&&(this.cameraControl.isEnableDamping()&&this.resetDynamicMoving(),this.zoomEditor.processMouseWheel(e,this.actionTool))}processKeyDown(e){this.enable&&this.panEditor.processKeyDown(e,this.actionTool)}processTouchmove(e){this.enable&&(this.panEditor.processTouchmove(e,this.actionTool),this.orbitEditor.processTouchmove(e,this.actionTool),this.zoomEditor.processTouchmove(e,this.actionTool))}processTouchstart(e){this.enable&&(this.panEditor.processTouchstart(e,this.actionTool),this.orbitEditor.processTouchstart(e,this.actionTool),this.zoomEditor.processTouchstart(e,this.actionTool))}processTouchend(e){this.enable&&(this.panEditor.processTouchend(e,this.actionTool),this.orbitEditor.processTouchend(e,this.actionTool),this.zoomEditor.processTouchend(e,this.actionTool))}processKeyUp(e){this.enable&&this.panEditor.processKeyUp(e,this.actionTool)}resetDynamicMoving(){this.enable&&(this.orbitEditor.resetDynamicRotate(),this.panEditor.resetDynamicPan(),this.zoomEditor.resetDynamicZoom())}resetMobileParamsByBox(e){this.zoomEditor.resetMobileParamsByBox(e)}setZoomSpeed(e){this.zoomEditor.setZoomSpeed(e)}getZoomSpeed(){return this.zoomEditor.getZoomSpeed()}},r.InputStatusMonitor=class{constructor(e){this._cameraChanging=!1,this.editorManager=e,this._isEnable=!0,this.isZooming=void 0,this.isRotating=void 0,this.isMoving=void 0}destroy(){this._cameraChanging=void 0,this.editorManager=null,this.isZooming=void 0,this.isRotating=void 0,this.isMoving=void 0}needsStopUpdateScene(){if(!1===this._isEnable)return!1;this.editorManager._mousePressed;const e=this.editorManager.userInputEditor.zoomEditor.isZooming,t=this.editorManager.userInputEditor.orbitEditor.mouseMoving,i=this.editorManager.userInputEditor.panEditor.mouseMoving;return!0===e||!0===t||!0===i}get isCameraChanging(){return this._cameraChanging}set isCameraChanging(e){this._cameraChanging=e}enableStopUpdateScene(e){this._isEnable=e}forceShouldRender(){if(!1===this._isEnable)return!1;const e=this.editorManager.userInputEditor.zoomEditor.isZooming,t=this.editorManager.userInputEditor.orbitEditor.mouseMoving,i=this.editorManager.userInputEditor.panEditor.mouseMoving;let r=!1;return(!0===this.isZooming&&!1===e||!0===this.isRotating&&!1===t||!0===this.isMoving&&!1===i)&&(r=!0),this.isZooming=e,this.isRotating=t,this.isMoving=i,r}},function(){function e(e,t,i){return t<=e&&e<=i}function t(e){if(void 0===e)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function i(e){this.tokens=[].slice.call(e)}i.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():-1},prepend:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.unshift(t.pop());else this.tokens.unshift(e)},push:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.push(t.shift());else this.tokens.push(e)}};var r=-1;function n(e,t){if(e)throw TypeError("Decoder error");return t||65533}var a="utf-8";function s(e,i){if(!(this instanceof s))return new s(e,i);if((e=void 0!==e?String(e).toLowerCase():a)!==a)throw new Error("Encoding not supported. Only utf-8 is supported");i=t(i),this._streaming=!1,this._BOMseen=!1,this._decoder=null,this._fatal=Boolean(i.fatal),this._ignoreBOM=Boolean(i.ignoreBOM),Object.defineProperty(this,"encoding",{value:"utf-8"}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})}function o(e,i){if(!(this instanceof o))return new o(e,i);if((e=void 0!==e?String(e).toLowerCase():a)!==a)throw new Error("Encoding not supported. Only utf-8 is supported");i=t(i),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(i.fatal)},Object.defineProperty(this,"encoding",{value:"utf-8"})}function l(t){var i=t.fatal,a=0,s=0,o=0,l=128,d=191;this.handler=function(t,h){if(-1===h&&0!==o)return o=0,n(i);if(-1===h)return r;if(0===o){if(e(h,0,127))return h;if(e(h,194,223))o=1,a=h-192;else if(e(h,224,239))224===h&&(l=160),237===h&&(d=159),o=2,a=h-224;else{if(!e(h,240,244))return n(i);240===h&&(l=144),244===h&&(d=143),o=3,a=h-240}return a<<=6*o,null}if(!e(h,l,d))return a=o=s=0,l=128,d=191,t.prepend(h),n(i);if(l=128,d=191,a+=h-128<<6*(o-(s+=1)),s!==o)return null;var c=a;return a=o=s=0,c}}function d(t){t.fatal;this.handler=function(t,i){if(-1===i)return r;if(e(i,0,127))return i;var n,a;e(i,128,2047)?(n=1,a=192):e(i,2048,65535)?(n=2,a=224):e(i,65536,1114111)&&(n=3,a=240);for(var s=[(i>>6*n)+a];n>0;){var o=i>>6*(n-1);s.push(128|63&o),n-=1}return s}}function h(){if("undefined"!=typeof self)return self;if("undefined"!=typeof global)return global;throw new Error("No global found")}s.prototype={decode:function(e,n){var a;a="object"==typeof e&&e instanceof ArrayBuffer?new Uint8Array(e):"object"==typeof e&&"buffer"in e&&e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0),n=t(n),this._streaming||(this._decoder=new l({fatal:this._fatal}),this._BOMseen=!1),this._streaming=Boolean(n.stream);for(var s,o=new i(a),d=[];!o.endOfStream()&&(s=this._decoder.handler(o,o.read()))!==r;)null!==s&&(Array.isArray(s)?d.push.apply(d,s):d.push(s));if(!this._streaming){do{if((s=this._decoder.handler(o,o.read()))===r)break;null!==s&&(Array.isArray(s)?d.push.apply(d,s):d.push(s))}while(!o.endOfStream());this._decoder=null}return d.length&&(-1===["utf-8"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===d[0]?(this._BOMseen=!0,d.shift()):this._BOMseen=!0)),function(e){for(var t="",i=0;i<e.length;++i){var r=e[i];r<=65535?t+=String.fromCharCode(r):(r-=65536,t+=String.fromCharCode(55296+(r>>10),56320+(1023&r)))}return t}(d)}},o.prototype={encode:function(e,n){e=e?String(e):"",n=t(n),this._streaming||(this._encoder=new d(this._options)),this._streaming=Boolean(n.stream);for(var a,s=[],o=new i(function(e){for(var t=String(e),i=t.length,r=0,n=[];r<i;){var a=t.charCodeAt(r);if(a<55296||a>57343)n.push(a);else if(56320<=a&&a<=57343)n.push(65533);else if(55296<=a&&a<=56319)if(r===i-1)n.push(65533);else{var s=e.charCodeAt(r+1);if(56320<=s&&s<=57343){var o=1023&a,l=1023&s;n.push(65536+(o<<10)+l),r+=1}else n.push(65533)}r+=1}return n}(e));!o.endOfStream()&&(a=this._encoder.handler(o,o.read()))!==r;)Array.isArray(a)?s.push.apply(s,a):s.push(a);if(!this._streaming){for(;(a=this._encoder.handler(o,o.read()))!==r;)Array.isArray(a)?s.push.apply(s,a):s.push(a);this._encoder=null}return new Uint8Array(s)}},"function"!=typeof TextDecoder&&(h().TextDecoder=s),"function"!=typeof TextEncoder&&(h().TextEncoder=o)}();class n{constructor(){this.utf8Decoder=new TextDecoder("utf-8")}parse(e){if(!e)return Promise.reject(e);const t=new DataView(e);let i=0;const r={};let n={},a={};if(r.magic=this.utf8Decoder.decode(new Uint8Array(e,i,4)),i+=4,r.magic){if(r.version=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.byteLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTJSONLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTBinaryLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTJSONLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTBinaryLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTBinaryLength>0&&(a=this.parseFeatureBinary(e,i,r.FTJSONLength)),r.BTJSONLength>0){const t=28+r.FTJSONLength+r.FTBinaryLength;n=BatchTableParser.parse(e.slice(t,r.BTJSONLength+t))}const s={point:a,batchTable:n};return Promise.resolve(s)}throw new Error("Invalid pnts file.")}parseFeatureBinary(e,t,i){const r=new THREE.BufferGeometry,n=this.utf8Decoder.decode(new Uint8Array(e,t,i)),a=JSON.parse(n);let s;if(a.POINTS_LENGTH&&(s=a.POINTS_LENGTH),a.POSITION){const i=a.POSITION.byteOffset+n.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("position",new THREE.BufferAttribute(o,3))}if(a.RGB){const i=a.RGB.byteOffset+n.length+t,o=new Uint8Array(e,i,3*s);r.setAttribute("color",new THREE.BufferAttribute(o,3,!0))}if(a.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(a.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(a.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(a.NORMAL){const i=a.RGB.byteOffset+n.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(a.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(a.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:r,offset:a.RTC_CENTER?(new THREE.Vector3).fromArray(a.RTC_CENTER):void 0}}}r.PntsParser=n;r.PntLoader=class{constructor(e,t){this.unitScale=t,this.pntParser=new n,this.utf8Decoder=new TextDecoder("utf-8"),this.tileIndexMap={},this.rootPntUrl=void 0,this.maximumScreenSpaceError=void 0===e?5:e,this.loadPromises=[],this.camera=void 0,this.globalInverseMatrix=new THREE.Matrix4,this.box=null,this.loadJsonPromises=[],this.pntFileList={}}loadPntTotalJson(e,t){let i=this;i.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1);return new Promise((function(n,a){(new THREE.FileLoader).load(e,(function(e){let a=JSON.parse(e);i.box=a.root.boundingVolume.box,t&&t(i.box),i.parseTilesJson(a.root);var s=Promise.all(i.loadJsonPromises.map((function(e){return e.catch((function(e){return e}))}))),o=new r.TaskManager;s.then((e=>{let t=0;for(let e in i.tileIndexMap){let r=i.tileIndexMap[e];const n=e.slice(0,e.lastIndexOf("/")+1);for(let a in r.index){let s=n+r.index[a].content.url;o.addTask(t),i.pntFileList[t]={},i.pntFileList[t].jsonUrl=e,i.pntFileList[t].pntUrl=s,i.pntFileList[t].index=a,t++}}o.processTasks(i.loadPnt.bind(i),void 0,(function(e){var t={};for(let e in i.pntFileList){if(!((s=i.pntFileList[e].jsonUrl)in t)){let e=new r.ObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0});t[s]=e}i.tileIndexMap[s].index[i.pntFileList[e].index].points=i.pntFileList[e].result,t[s].add(i.pntFileList[e].result)}var a=[];for(var s in t)a.push(t[s]);n(a)}))}))}))}))}parseTilesJson(e){let t=this;if(e.content&&e.content.url){let i=this.rootPntUrl+e.content.url;t.loadTileSetJson(i)}if(e.children)for(let t of e.children)this.parseTilesJson(t)}loadTileSetJson(e){let t=this;const i=new Promise((function(i,r){var n=new THREE.FileLoader;n.setResponseType("json"),n.load(e,(function(n){if(null==n)r(n);else{let r=new ExtendTileset(n,"");t.tileIndexMap[e]=r;r.index[1],e.slice(0,e.lastIndexOf("/")+1);i(r)}}),void 0,(function(t){r(data),console.error(`Load ${e} failed, ${t}`)}))}));return t.loadJsonPromises.push(i),i}ProcessTileIndexs(e,t){this.camera=e,this.globalInverseMatrix=t;for(let e in this.tileIndexMap){const t=this.tileIndexMap[e].index[1];this.ProcessNode(t,e)}}ProcessNode(e,t,i){e.visible=!1;let r=this.tileIndexMap[t].index[e.tileId].points;if(null!=r){if(r.visible=!1,this.$3dTilesSubdivisionControl(this.camera,e)&&(r.visible=!0,e.visible=!0),null!=i)if("ADD"===i.refine.toUpperCase());else{i.visible=!1,this.tileIndexMap[t].index[i.tileId].visible=!1}if(e.children)for(let i of e.children)this.ProcessNode(i,t,e)}}$3dTilesSubdivisionControl(e,t){return this.computeNodeSSE(e,t)>this.maximumScreenSpaceError}computeNodeSSE(e,t){const i=new THREE.Box3,r=new THREE.Sphere;let n=e.position.clone();if(n.multiplyScalar(1/this.unitScale),n.applyMatrix4(this.globalInverseMatrix),t.distance=0,t.boundingVolume.region)i.copy(t.boundingVolume.region.box3D),i.applyMatrix4(t.boundingVolume.region.matrixWorld),t.distance=i.distanceToPoint(n);else if(t.boundingVolume.box)i.copy(t.boundingVolume.box),t.matrixWorld&&i.applyMatrix4(t.matrixWorld),t.distance=i.distanceToPoint(n);else{if(!t.boundingVolume.sphere)return 1/0;r.copy(t.boundingVolume.sphere),r.applyMatrix4(t.matrixWorld),t.distance=Math.max(0,r.distanceToPoint(n))}return 0===t.distance?1/0:(t.geometricError-0<1e-4&&(t.geometricError=1),e._preSSE*(t.geometricError/t.distance))}updatePreSse(e,t){const i=e.fov,r=THREE.Math.degToRad(i),n=t/(2*Math.tan(.5*r));e._preSSE=n}loadPnt(e,t){let i=this;var r=i.pntFileList[e].pntUrl;return new Promise((function(n,a){var s=new THREE.FileLoader;s.setResponseType("arraybuffer"),s.load(r,(function(n){if(void 0!==n){const a=i.utf8Decoder.decode(new Uint8Array(n,0,4));if("{"===a[0]){n=JSON.parse(i.utf8Decoder.decode(new Uint8Array(n)));r.slice(0,r.lastIndexOf("/")+1)}else if("b3dm"==a)console.log("b3dm is load");else{if("pnts"!=a)return Promise.reject(`Unsupported magic code ${a}`);console.log("pnts is load")}i.pntParser.parse(n).then((n=>{const a=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),s=new THREE.Points(n.point.geometry,a);n.point.offset&&s.position.copy(n.point.offset),s.visible=!1,s.name=r,i.pntFileList[e].result=s,t()}))}}),void 0,(function(e){a(void 0)}))}))}loadPntByPromise(e){let t=this;return new Promise((function(i,r){var n=new THREE.FileLoader;n.setResponseType("arraybuffer"),n.load(e,(function(r){if(void 0!==r){const n=t.utf8Decoder.decode(new Uint8Array(r,0,4));if("{"===n[0]){r=JSON.parse(t.utf8Decoder.decode(new Uint8Array(r)));e.slice(0,e.lastIndexOf("/")+1)}else if("b3dm"==n)console.log("b3dm is load");else{if("pnts"!=n)return Promise.reject(`Unsupported magic code ${n}`);console.log("pnts is load")}t.pntParser.parse(r).then((t=>{const r=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),n=new THREE.Points(t.point.geometry,r);t.point.offset&&n.position.copy(t.point.offset),n.visible=!1,n.name=e,i(n)}))}}),void 0,(function(e){r(void 0)}))}))}loadPntTotalJsonByPromise(e,t){let i=this;i.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1);return new Promise((function(n,a){(new THREE.FileLoader).load(e,(function(e){let a=JSON.parse(e);i.box=a.root.boundingVolume.box,t&&t(i.box),i.parseTilesJson(a.root),Promise.all(i.loadJsonPromises.map((function(e){return e.catch((function(e){return e}))}))).then((e=>{var t=[];for(let e in i.tileIndexMap){i.urlPointGroupMap[e]={};let r=i.tileIndexMap[e];const n=e.slice(0,e.lastIndexOf("/")+1);for(let a in r.index){let s=n+r.index[a].content.url;t.push(i.loadPnt(s).then((t=>({url:e,context:{index:a,result:t}}))))}}Promise.all(t.map((function(e){return e.catch((function(e){return e}))}))).then((e=>{for(let e in i.urlPointGroupMap){let t=new r.ObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0});i.urlPointGroupMap[e]=t}for(const t of e){if(void 0!==t)i.tileIndexMap[t.url].index[t.context.index].points=t.context.result,i.urlPointGroupMap[t.url].add(t.context.result)}var t=[];for(var a in i.urlPointGroupMap)t.push(i.urlPointGroupMap[a]);n(t)}))})).catch((function(e){console.log("promise reject failed reason",e)}))}))}))}},r.Version="1.0.0.20200210",r.BuildVersion="2024-4-3 8:11:01 PM",r.GlobalData={SceneSize:1e3,TextureResRoot:"images/",EnableTextureMapping:!1,EnableTextureLoading:!0,MaxTexturePixels:25e4,EnableLightmap:!1,LightmapIntensity:1,ClippingCaps:!0,ClippingCapsType:0,CalculateClippingLine:!0,SnapClippingLine:!1,SelectionColor:{color:1170103,side:THREE.DoubleSide},DisableAntialias:!1,EnableDemolishByDClick:!1,IsMobile:!1,WorkersRoot:"../libs/",WorkerEnabled:!0,ZipResourcePostfix:".gz",JsonResourcePostfix:".json",HasLayerData:!1,Instance:!0,InstanceAsyncProcessing:!1,InstanceAsyncProcessingStep:500,InstanceSharedMeshEnabled:!0,InstanceSharedMeshThreshold:10,BatchAsyncProcessingFrequency:10,DataProvider:0,Renderer:0,MaxMemeorySizeToFullRender:1500,BatchMergeEnabled:!1,SegmentedBatchMergeEnable:!1,maxIndicesNumberPerBathSegment:65535,IncrementRender:!0,LimitFrameTime:250,maxObjectNumInPool:6e4,maxDrawCacheNum:4e4,OctantDepth:15,MaximumDepth:0,ConcurrencyRequestCount:8,ShowOctant:!1,EnableOctant:!0,LightPreset:3,IBL:!1,ToneMapping:1,LightIntensityFactor:1.5,Hover:!1,MouseMovePick:!1,OcclusionTranslucentEnabled:!1,OcclusionOpacity:.5,OcclusionDistanceToCamera:1e3,LineSelectRange:30,DrawingStyle:0,DrawingBoardlineEnabled:!0,DrawingBoardlineLimit:!0,DrawingBoardlineLimitThreshold:2e5,CanUseWireframeFromData:!0,BorderLineBatched:!1,BorderLineDelayLoaded:!1,InitWireframeData:!1,IsPackingMaterialEnable:!0,SSAO:!1,GTAO:!1,SSR:!1,EnableGlow:!1,GlowCount:0,HighLightOutlineCount:0,BloomCount:0,EnableShadowMap:!1,MeasureHighlightPlane:!1,WalkingWithGravity:!1,EnableHitDetection:!1,TranslucentDepthDisabled:!1,LoadMpkOnDemand:!1,EnableLoadOnDemand:!0,EnableSnowPass:!1,EnableFogPass:!1,EnableRainPass:!1,EnableSkylinePass:!1,ScanRingCount:0,FanScanCount:0,EnableDisposeBufferAfterVbo:!0,OrganizeNodesByCameraView:!1,CanUseCompressedTexture:!1,CanUseSmallTexture:!0,DEBUG:!1,EnableExplosion:!1,EnableLogarithmicDepthBuffer:!1,ConstraintZoom:!1,PickingEffect:!0,PickingLineWidthEnabled:!1,EnableGisMap:!1,TerrainScale:1,TerrainResourceFileName:"terrain.bin",TerrainZipResourceFileName:"terrain.gz",TilePlaneGroupName:"TilePlaneGroup",TileGlobalGroupName:"TileGlobalGroup",TdTileGroupName:"3dTilesGroup",BimTilesGroupName:"BimTilesGroup",DracoLibUrl:void 0,DynamicScheduling:!1,EnableSchedulingSort:!1,EnableSplitComponent:!1,DelayLoadTexture:!1,EnableLodDemDom:!1,EnableCSM:!1,SceneUnit:void 0,ForcedUseWebgl1:!1,EnableDomainDiversion:!0,WalkRotationSpeed:1,InputDelayTimeInterval:400,EnableTilevisibilityBoxs:!1,EnableRequestStatics:!0,EnableOcclusionCulling:!1,EnableMeshCreateLimit:!1,EnableReplenishShadowTile:!1},r.EnumStandardView={ISO:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44},r.CAMERATYPE={ORTHOGRAPHIC:0,PERSPECTIVE:1},r.OPSELECTIONTYPE={Clear:0,Add:1,Remove:2},r.PICKABLETYPE={Geometry:1,Marker3d:2,Room:3,ExternalComponent:4,Axis:5,Map:6,UnPickable:0},r.LOADERROREVENTS={LOAD_ERROR:1e3,LOAD_SCENE_ERROR:1001,LOAD_MATERIAL_ERROR:1002,LOAD_SYMBOL_ERROR:1003,LOAD_OCTREEINNER_ERROR:1004,LOAD_OCTREEOUTER_ERROR:1005,LOAD_USERID_ERROR:1006,LOAD_USERDATA_ERROR:1007,LOAD_CAMERA_ERROR:1008,LOAD_TEXTURE_ERROR:1009,LOAD_MPK_ERROR:1010,LOAD_IBLCONFIG_ERROR:1011},r.EnumRenderType={RENDER:0,RENDER_FINISHED:1,RESIZE:2},r.PrimitiveCount={vertexCount:0,triangleCount:0},r.RotatePivotMode={MOUSEPOINT:0,SELECTION:1,CENTER:2,CAMERA:3},r.EditorMode={ORBIT:"orbit",PICK:"pick",PAN:"pan",ZOOM:"zoom",FLY:"fly",WALK:"walk",THIRDPERSONWALK:"ThirdPersonWalk"},r.EditToolMode={PICK_BY_RECT:"pickByRect",ZOOM_BY_RECT:"zoomByRect",CLIP_BY_BOX:"clipByBox",CLIP_FILL:"fillClip",PICK_BY_MEASURE:"pickByMeasure",EDIT_CONTROL:"editControl",VIEW_SHED_ANALYSIS:"viewshedAnalysis",VOLUME_MEASURE:"volumeMeasure"},r.MoveDirection={NONE:0,UP:1,DOWN:2,LEFT:4,RIGHT:8,FORWARD:16,BACK:32},r.DrawingStyle={SHADING:0,BOARDLINE:1,SHADINGWITHLINE:2},r.EnumElementState={HIDDEN:-1,NONE:0,SELECTED:1,BLINK:2,HOVER:4,TRANSPARENT:8,LOCALCLIPPING:16,CLIPPING:32,OVERRIDED:64,DEACTIVATE:128,MODIFYOPACITY:256},r.EnumElementWireFrameState={HIDDEN:-1,NONE:0,OVERRIDED:1},r.EnumDataProvider={AUTO:0,DEFAULT:1,MERGED:2,LAYER:3,LAYER_SCENE:4},r.EnumRendererType={AUTO:0,FULL:1,INCREMENT:2},r.EnumShaderColorState={NONE:0,BLINK:1,SELECT:2},r.EnumCesiumImageryLayerType={AUTO:0,BAIDU:1,GAODE:2,MAPBOX:3,ARCGIS:4,GOOGLE:5},r.EnumRenderOrder={BeforeComponent:-1,Component:0,AfterComponent:1,Increment:1e4,WireFrame:10090,ClipPlane:10100,Effect:10200},r.EnumLayerBaseRenderOrder={MODEL:0,MAP:-100},r.EnumRenderCallbackType=Object.freeze({PRE_RENDER:"preRender",RENDER:"render",POST_RENDER:"postRender",FINISH_RENDER:"renderFinished"}),r.EnumLengthlUnits=Object.freeze({Meter:"Meter",Millimeter:"Millimeter"}),r.EnumClippingCapsTypes=Object.freeze({None:0,ClipPlane:1,ClipBox:2}),r.FILLPATTERN={fullFill:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],noFill:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],horizontalLine:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255],verticalLine:[128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128],rightDiagonalLine:[0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0,0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0],leftDiagonalLine:[1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128],orthogonalCrossLine:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255],skewCrossLine:[65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128],halftone:[136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34],doubleCross:[65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255]},r.EnumShowTileType=Object.freeze({All:0,OnlyInstance:1,ExceptInstance:2,OnlyExterior:3,OnlyExteriorShadow:4,ExceptExterior:5}),r.EnumSubBimTileType=Object.freeze({SubBt_unknown:0,SubBt_instance:1,SubBt_visibility:2}),r.ThirdPersonType=Object.freeze({OfficeMale:0,ConstructionWorker:1}),r.EnumAntialiasMode=Object.freeze({NOAA:0,FXAA:1,SSAA:2,SMAA:3}),r.BimtileVersion=Object.freeze({VERSION:"0.0.3",VERSION_MINOR:"1"}),r.Layer={},r.Workers={};var a=a||{};!function(){class e{static isAvailable(t){return("WGS84"===t||"CGCS2000"==t)&&(e.setupCoordinateSystem(t),!0)}static setupCoordinateSystem(e){if(!proj4.testDef(e))switch(e){case"WGS84":proj4.defs("WGS84","+proj=longlat +datum=WGS84 +no_defs");break;case"CGCS2000":proj4.defs("CGCS2000","+proj=longlat +ellps=GRS80 +no_defs")}}static setupMercator(){proj4.testDef("WEB_MERCATOR")||proj4.defs("WEB_MERCATOR","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")}}e.WGS84="WGS84",e.CGCS2000="CGCS2000",r.geoCoordinateSystem=e}(),function(){class e{constructor(){}static lonLatToWebMercator(e,t,i){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");r.geoCoordinateSystem.setupMercator();const n=proj4(proj4(t),proj4("WEB_MERCATOR"),proj4.toPoint([e.x,e.y]));if("object"==typeof i)return i.x=n.x,i.y=n.y,i;{const e=new THREE.Vector2;return e.x=n.x,e.y=n.y,e}}static webMercatorToLonLat(e,t,i){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");r.geoCoordinateSystem.setupMercator();const n=proj4(proj4("WEB_MERCATOR"),proj4(t),proj4.toPoint([e.x,e.y]));if("object"==typeof i)return i.x=n.x,i.y=n.y,i;{const e=new THREE.Vector2;return e.x=n.x,e.y=n.y,e}}static lonLatToGauss(t,i,n,a){if(!r.geoCoordinateSystem.isAvailable(i))return void console.log("unknown coordinate system ");const s=void 0!==a.span?a.span:3,o=void 0===a.withLineCode||a.withLineCode,l=e.gaussInfo(t.x,s),d=void 0!==a.lineCode?a.lineCode:l.lineCode;let h;if(o){if(h=`CGCS_GAUSS_${s}_ZONE_${d}`,!proj4.testDef(h)){const e=`+proj=tmerc +lat_0=0 +lon_0=${l.centerLng} +k=1 +x_0=${d}500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(h,e)}}else if(h=`CGCS_GAUSS_${s}_${l.centerLng}E`,!proj4.testDef(h)){const e=`+proj=tmerc +lat_0=0 +lon_0=${l.centerLng} +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(h,e)}const c=proj4(proj4(i),proj4(h),proj4.toPoint([t.x,t.y]));if("object"==typeof n)return n.x=c.x,n.y=c.y,n;{const e=new THREE.Vector2;return e.x=c.x,e.y=c.y,e}}static guassToLonLat(e,t,i,n){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");if(void 0===n.span)return void console.log("unknown projection info");let a,s=Math.floor(e.x/1e6);if(s<0&&!n.lineCode)return void console.log("error projection coordinate");if(n.lineCode&&n.lineCode!=s&&s>0)return void console.log("error projection coordinate");s<=0?(a=proj4.toPoint([e.x+1e6*n.lineCode,e.y]),s=n.lineCode):a=proj4.toPoint([e.x,e.y]);const o=`CGCS_GAUSS_${n.span}_ZONE_${s}`;if(!proj4.testDef(o)){let e=s*n.span;Math.abs(n.span-6)<Math.abs(r.Utils.MinusEpsilon)&&(e-=6);const t=`+proj=tmerc +lat_0=0 +lon_0=${e} +k=1 +x_0=${s}500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(o,t)}const l=proj4(proj4(o),proj4(t),a);if("object"==typeof i)return i.x=l.x,i.y=l.y,i;{const e=new THREE.Vector2;return e.x=l.x,e.y=l.y,e}}static gaussInfo(e,t){let i=0,n=0;return Math.abs(t-3)<Math.abs(r.Utils.MinusEpsilon)?(i=Math.floor((e+t/2)/t),n=3*i):Math.abs(t-6)<Math.abs(r.Utils.MinusEpsilon)&&(i=Math.floor((e+t)/t),n=6*i-3),{lineCode:i,centerLng:n}}}r.Projection=e}(),function(e){function t(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function i(e,i,r,n,a,s){return t((o=t(t(i,e),t(n,s)))<<(l=a)|o>>>32-l,r);var o,l}function n(e,t,r,n,a,s,o){return i(t&r|~t&n,e,t,a,s,o)}function a(e,t,r,n,a,s,o){return i(t&n|r&~n,e,t,a,s,o)}function s(e,t,r,n,a,s,o){return i(t^r^n,e,t,a,s,o)}function o(e,t,r,n,a,s,o){return i(r^(t|~n),e,t,a,s,o)}function l(e,i){var r,l,d,h,c;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;var u=1732584193,p=-271733879,m=-1732584194,f=271733878;for(r=0;r<e.length;r+=16)l=u,d=p,h=m,c=f,u=n(u,p,m,f,e[r],7,-680876936),f=n(f,u,p,m,e[r+1],12,-389564586),m=n(m,f,u,p,e[r+2],17,606105819),p=n(p,m,f,u,e[r+3],22,-1044525330),u=n(u,p,m,f,e[r+4],7,-176418897),f=n(f,u,p,m,e[r+5],12,1200080426),m=n(m,f,u,p,e[r+6],17,-1473231341),p=n(p,m,f,u,e[r+7],22,-45705983),u=n(u,p,m,f,e[r+8],7,1770035416),f=n(f,u,p,m,e[r+9],12,-1958414417),m=n(m,f,u,p,e[r+10],17,-42063),p=n(p,m,f,u,e[r+11],22,-1990404162),u=n(u,p,m,f,e[r+12],7,1804603682),f=n(f,u,p,m,e[r+13],12,-40341101),m=n(m,f,u,p,e[r+14],17,-1502002290),u=a(u,p=n(p,m,f,u,e[r+15],22,1236535329),m,f,e[r+1],5,-165796510),f=a(f,u,p,m,e[r+6],9,-1069501632),m=a(m,f,u,p,e[r+11],14,643717713),p=a(p,m,f,u,e[r],20,-373897302),u=a(u,p,m,f,e[r+5],5,-701558691),f=a(f,u,p,m,e[r+10],9,38016083),m=a(m,f,u,p,e[r+15],14,-660478335),p=a(p,m,f,u,e[r+4],20,-405537848),u=a(u,p,m,f,e[r+9],5,568446438),f=a(f,u,p,m,e[r+14],9,-1019803690),m=a(m,f,u,p,e[r+3],14,-187363961),p=a(p,m,f,u,e[r+8],20,1163531501),u=a(u,p,m,f,e[r+13],5,-1444681467),f=a(f,u,p,m,e[r+2],9,-51403784),m=a(m,f,u,p,e[r+7],14,1735328473),u=s(u,p=a(p,m,f,u,e[r+12],20,-1926607734),m,f,e[r+5],4,-378558),f=s(f,u,p,m,e[r+8],11,-2022574463),m=s(m,f,u,p,e[r+11],16,1839030562),p=s(p,m,f,u,e[r+14],23,-35309556),u=s(u,p,m,f,e[r+1],4,-1530992060),f=s(f,u,p,m,e[r+4],11,1272893353),m=s(m,f,u,p,e[r+7],16,-155497632),p=s(p,m,f,u,e[r+10],23,-1094730640),u=s(u,p,m,f,e[r+13],4,681279174),f=s(f,u,p,m,e[r],11,-358537222),m=s(m,f,u,p,e[r+3],16,-722521979),p=s(p,m,f,u,e[r+6],23,76029189),u=s(u,p,m,f,e[r+9],4,-640364487),f=s(f,u,p,m,e[r+12],11,-421815835),m=s(m,f,u,p,e[r+15],16,530742520),u=o(u,p=s(p,m,f,u,e[r+2],23,-995338651),m,f,e[r],6,-198630844),f=o(f,u,p,m,e[r+7],10,1126891415),m=o(m,f,u,p,e[r+14],15,-1416354905),p=o(p,m,f,u,e[r+5],21,-57434055),u=o(u,p,m,f,e[r+12],6,1700485571),f=o(f,u,p,m,e[r+3],10,-1894986606),m=o(m,f,u,p,e[r+10],15,-1051523),p=o(p,m,f,u,e[r+1],21,-2054922799),u=o(u,p,m,f,e[r+8],6,1873313359),f=o(f,u,p,m,e[r+15],10,-30611744),m=o(m,f,u,p,e[r+6],15,-1560198380),p=o(p,m,f,u,e[r+13],21,1309151649),u=o(u,p,m,f,e[r+4],6,-145523070),f=o(f,u,p,m,e[r+11],10,-1120210379),m=o(m,f,u,p,e[r+2],15,718787259),p=o(p,m,f,u,e[r+9],21,-343485551),u=t(u,l),p=t(p,d),m=t(m,h),f=t(f,c);return[u,p,m,f]}function d(e){var t,i="",r=32*e.length;for(t=0;t<r;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function h(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function c(e){var t,i,r="0123456789abcdef",n="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),n+=r.charAt(t>>>4&15)+r.charAt(15&t);return n}function u(e){return unescape(encodeURIComponent(e))}function p(e){return function(e){return d(l(h(e),8*e.length))}(u(e))}function m(e,t){return function(e,t){var i,r,n=h(e),a=[],s=[];for(a[15]=s[15]=void 0,n.length>16&&(n=l(n,8*e.length)),i=0;i<16;i+=1)a[i]=909522486^n[i],s[i]=1549556828^n[i];return r=l(a.concat(h(t)),512+8*t.length),d(l(s.concat(r),640))}(u(e),u(t))}r.md5=function(e,t,i){return t?i?m(t,e):c(m(t,e)):i?p(e):c(p(e))}}(),r.Utils={scratchVector_1:new THREE.Vector3,scratchVector_2:new THREE.Vector3,scratchVector_3:new THREE.Vector3,scratchMatrix3:new THREE.Matrix3,scratchMatrix4_1:new THREE.Matrix4,scratchMatrix4_2:new THREE.Matrix4,scratchQuaternion_1:new THREE.Quaternion,scratchBoundingBox:new THREE.Box3,TemporaryMatrix:new THREE.Matrix4,MinusEpsilon:-1e-6,MatrixFromMillimeterToMeter:(new THREE.Matrix4).makeScale(.001,.001,.001),MatrixFromMeterToMillimeter:(new THREE.Matrix4).makeScale(1e3,1e3,1e3),isDefined:function(e){return null!=e},isDesktop:function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),a=(/(?:Chrome|CriOS)/.test(e),/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e));return!(/(?:iPhone)/.test(e)&&!a||r||i||a)},getOS:function(){var e=navigator.userAgent;return e.match(/compatible/i)||e.match(/Windows/i)?"windows":e.match(/Macintosh/i)||e.match(/MacIntel/i)?"macOS":e.match(/iphone/i)||e.match(/Ipad/i)?"ios":e.match(/android/i)?"android":"other"},isMacOS:function(){return"macOS"===r.Utils.getOS()},supportWorker:function(){return"undefined"!=typeof Worker||(console.log("Sorry! Web Worker is not supported."),!1)},supportsBlobArrayBuffer:function(e){return"function"==typeof e.arrayBuffer},supportsImageBitmap:function(){return"function"==typeof createImageBitmap},box3FromArray:function(e,t){if(e instanceof Array){var i=t||new THREE.Box3;return i.min.fromArray(e,0),i.max.fromArray(e,3),i}return null},box3FromSize:function(e,t,i){return r.Utils.isDefined(i)||(i=new THREE.Box3),i.min.set(-t.x/2,-t.y/2,-t.z/2),i.max.set(t.x/2,t.y/2,t.z/2),i.translate(e),i},box3FromArrayRange:function(e,t,i){for(var r=new THREE.Box3,n=1/0,a=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=t,c=i;h<c;h+=3){var u=e[h],p=e[h+1],m=e[h+2];u<n&&(n=u),p<a&&(a=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}return r.min.set(n,a,s),r.max.set(o,l,d),r},computeBBox:function(e){for(var t=new THREE.Box3,i=new THREE.Vector3,r=0,n=e.length;r<n;++r)i.fromArray(e[r],0),t.expandByPoint(i);return t},mergeBBox:function(e){if(e.length<1)return null;for(var t=new THREE.Box3,i=new THREE.Vector3,r=new THREE.Vector3,n=new THREE.Box3,a=0,s=e.length;a<s;a++)i.set(e[a].max.x,e[a].max.y,e[a].max.z),r.set(e[a].min.x,e[a].min.y,e[a].min.z),n.set(r,i),t.union(n);return t},parseTransform:function(e,t,i){var n=!1;if(t.rotation&&(e.rotation.fromArray(t.rotation),n=!0),t.position&&(e.position.fromArray(t.position),n=!0),t.scale&&(e.scale.fromArray(t.scale),n=!0),t.quaternion&&(e.quaternion.fromArray(t.quaternion),n=!0),n&&e.updateMatrix(),t.matrix&&e.matrix.fromArray(t.matrix),i){var a=e.matrix.clone();a.multiplyMatrices(i,e.matrix),e.matrix=a}e.matrixAutoUpdate=!1,void 0!==e.boundingBox&&(e.boundingBox=r.Utils.box3FromArray(t.bbox))},isMobileDevice:function(){var e=navigator.platform;return 0!==e.indexOf("Win")&&0!==e.indexOf("Mac")},findRange:function(e,t){if(t<Math.min.apply(null,e))return 0;if(t>Math.max.apply(null,e))return e.length-1;for(var i=0,r=0,n=e.length;r<n;++r)if(e[r]>t){i=r-1;break}return i},stringToByte:function(e){var t,i,r=new Array;t=e.length;for(var n=0;n<t;n++)(i=e.charCodeAt(n))>=65536&&i<=1114111?(r.push(i>>18&7|240),r.push(i>>12&63|128),r.push(i>>6&63|128),r.push(63&i|128)):i>=2048&&i<=65535?(r.push(i>>12&15|224),r.push(i>>6&63|128),r.push(63&i|128)):i>=128&&i<=2047?(r.push(i>>6&31|192),r.push(63&i|128)):r.push(255&i);return r},byteToString:function(e){if("string"==typeof e)return e;for(var t="",i=e,r=0;r<i.length;r++){var n=i[r].toString(2),a=n.match(/^1+?(?=0)/);if(a&&8==n.length){for(var s=a[0].length,o=i[r].toString(2).slice(7-s),l=1;l<s;l++)o+=i[l+r].toString(2).slice(2);t+=String.fromCharCode(parseInt(o,2)),r+=s-1}else t+=String.fromCharCode(i[r])}return t},strToBinary:function(e){for(var t=[],i=e.split(""),r=0;r<i.length;r++){0!=r&&t.push(" ");var n=i[r].charCodeAt().toString(2);t.push(n)}return t.join("")},binaryToStr:function(e){for(var t=[],i=e.split(" "),r=0;r<i.length;r++){var n=i[r],a=parseInt(n,2),s=String.fromCharCode(a);t.push(s)}return t.join("")},byteArr2Int:function(e){return(255&e[0])<<24|(255&e[1])<<16|(255&e[2])<<8|(255&e[3])<<0},int2ByteArr:function(e){var t=[];return t[0]=e>>24,t[1]=e>>16,t[2]=e>>8,t[3]=e>>0,t},checkVersionMatch:function(e,t){var i=e.split(".");if(i.length>1){var r=parseInt(i[0]),n=parseInt(i[1]),a=t.toLowerCase();if((a=parseFloat(a))<.04&&0===r&&n<7)return!0;if(a>=.04&&(r>0||0===r&&n>=7))return!0}return!1},isEmptyObject:function(e){if(!e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},isEmptyObjectSimple:function(e){for(var t in e)return!1;return!0},isOwnEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},hexStrToRgb:function(e){var t=e.replace("#",""),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16)/255,g:parseInt(i[2],16)/255,b:parseInt(i[3],16)/255}:null},hexToRgb:function(e){var t={};return t.r=(e>>16&255)/255,t.g=(e>>8&255)/255,t.b=(255&e)/255,t},getMin:function(e){for(var t=e.length,i=1/0;t--;)i=e[t]<i?e[t]:i;return i},getMax:function(e){for(var t=e.length,i=-1/0;t--;)i=e[t]>i?e[t]:i;return i},freezeObject:function(e){return Object.freeze?Object.freeze(e):e},getEncodedId:function(e){return r.md5&&"function"==typeof r.md5?r.md5(e):e},arrayToMap:function(e,t){t=t||{};for(var i=0,r=e.length;i<r;i++)t[e[i]]=!0;return t},mapToArray:function(e){let t=[];for(const i in e)t.push(i);return t},getDifferentialIdxs:function(e,t){var i,r={},n={},a={};if(t)if(this.isEmptyObject(e))n=t;else{for(i in t)e[i]&&(a[i]=!0);if(this.isEmptyObject(a))r=e,n=t;else{for(i in t)a[i]||(n[i]=!0);for(i in e)a[i]||(r[i]=!0)}}else this.isEmptyObject(e)||(r=e);return{objCurrUsedIdxs:e,addIdxs:Object.keys(r),removeIdxs:Object.keys(n)}},getCombinedKeyString:function(e,t){return t=t||"&",e.join(t)},splitCombinedKeyString:function(e,t){return t=t||"&",e.split(t)},isGroupObject:function(e){return!(!e.children||!e.children.length)},isMeshObject:function(e){return!!(e.isMesh||e.isLine||e.isPoints)},extendObject:function(e,t,i){if(i)for(var n in t)"object"==typeof t[n]?r.Utils.extendObject(e[n],t[n],!0):e[n]=t[n];else for(var n in t)null!==e[n]&&void 0!==e[n]?"object"==typeof t[n]&&r.Utils.extendObject(e[n],t[n],!1):e[n]=t[n];return e},computeExplodeTranslation:function(e,t,i){let r=new THREE.Vector3;var n=t.getCenter(r),a=i*e.distanceTo(n),s=new THREE.Vector3;return s.subVectors(n,e),0!=s.length()&&s.normalize(),s.multiplyScalar(a),s},computeAfterExplodeTranslation:function(e,t,i){let r=new THREE.Vector3;if(0===i)return r;var n=t.getCenter(r),a=e.distanceTo(n),s=new THREE.Vector3;return s.subVectors(n,e),0!=s.length()&&s.normalize(),s.multiplyScalar(a/(i+1)),s},minDistanceBetweenTriToMesh:function(e,t,i,r){function n(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function a(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function s(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function o(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function l(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function d(e,t,i,r){var d,h,c,u,p,m,f=o(t,r),g=o(t,t),v=o(r,r),y=n(i,e),M=o(t,y),E=o(r,y);return(d=(M*v-E*f)/(g*v-f*f))<0||isNaN(d)?d=0:d>1&&(d=1),(h=(d*f-E)/v)<=0||isNaN(h)?(u=i,(d=M/g)<=0||isNaN(d)?(c=e,p=n(i,e)):d>=1?p=n(i,c=a(e,t)):(c=s(e,t,d),m=l(y,t),p=l(t,m))):h>=1?(u=a(i,r),(d=(f+M)/g)<=0||isNaN(d)?(c=e,p=n(u,e)):d>=1?p=n(u,c=a(e,t)):(c=s(e,t,d),m=l(y=n(u,e),t),p=l(t,m))):(u=s(i,r,h),d<=0||isNaN(d)?(c=e,m=l(y,r),p=l(r,m)):d>=1?(m=l(y=n(i,c=a(e,t)),r),p=l(r,m)):(c=s(e,t,d),o(p=l(t,r),y)<0&&p.multiplyScalar(-1))),{vec:p,closestP:c,closestQ:u}}function h(e,t){var i,r,a,h,c,u,p=[],m=[];p[0]=n(e[1],e[0]),p[1]=n(e[2],e[1]),p[2]=n(e[0],e[2]),m[0]=n(t[1],t[0]),m[1]=n(t[2],t[1]),m[2]=n(t[0],t[2]);for(var f=0,g=e[0].distanceToSquared(t[0])+1,v=0;v<3;v++)for(var y=0;y<3;y++){var M=d(e[v],p[v],t[y],m[y]);a=M.vec,i=M.closestP;var E=o(h=n(r=M.closestQ,i),h);if(E<=g){c=i.clone(),u=r.clone(),g=E;var x=o(n(e[(v+2)%3],i),a),_=o(n(t[(y+2)%3],r),a);if(x<=0&&_>=0)return{start:i.clone(),end:r.clone(),minDistance:Math.sqrt(E)};x<0&&(x=0),_>0&&(_=0),o(h,a)-x+_>0&&(f=1)}}var b=l(p[0],p[1]),I=o(b,b);if(I>1e-15){var T=[];h=n(e[0],t[0]),T[0]=o(h,b),h=n(e[0],t[1]),T[1]=o(h,b),h=n(e[0],t[2]),T[2]=o(h,b);var S=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(S=T[0]<T[1]?0:1,T[2]<T[S]&&(S=2)):T[0]<0&&T[1]<0&&T[2]<0&&(S=T[0]>T[1]?0:1,T[2]>T[S]&&(S=2)),S>=0&&(f=1,o(h=n(t[S],e[0]),l(b,p[0]))>0&&o(h=n(t[S],e[1]),l(b,p[1]))>0&&o(h=n(t[S],e[2]),l(b,p[2]))>0))return i=s(t[S],b,T[S]/I),r=t[S].clone(),{start:i.clone(),end:r,minDistance:i.distanceTo(r)}}var C=l(m[0],m[1]),w=o(C,C);if(w>1e-15){var R=[];h=n(t[0],e[0]),R[0]=o(h,C),h=n(t[0],e[1]),R[1]=o(h,C),h=n(t[0],e[2]),R[2]=o(h,C);S=-1;if(R[0]>0&&R[1]>0&&R[2]>0?(S=R[0]<R[1]?0:1,R[2]<R[S]&&(S=2)):R[0]<0&&R[1]<0&&R[2]<0&&(S=R[0]>R[1]?0:1,R[2]>R[S]&&(S=2)),S>=0&&(f=1,o(h=n(e[S],t[0]),l(C,m[0]))>0&&o(h=n(e[S],t[1]),l(C,m[1]))>0&&o(h=n(e[S],t[2]),l(C,m[2]))>0))return{start:i=e[S].clone(),end:(r=s(e[S],C,R[S]/w)).clone(),minDistance:i.distanceTo(r)}}return f?(i=c,r=u,{start:c.clone(),end:u.clone(),minDistance:Math.sqrt(g)}):{start:c.clone(),end:u.clone(),minDistance:0}}var c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3;function m(e,t,i,r,n,a){c.fromBufferAttribute(t,i),u.fromBufferAttribute(t,r),p.fromBufferAttribute(t,n),a&&(c.applyMatrix4(a),u.applyMatrix4(a),p.applyMatrix4(a)),e.push(c),e.push(u),e.push(p)}for(var f={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},g=t.geometry,v=g.attributes.position,y=i?i.indexStart:0,M=g.getIndex().array,E=y,x=i?i.indexStart+i.indexCount:M.length;E<x;E+=3){var _=[];m(_,v,M[E],M[E+1],M[E+2],r);var b=h(e,_);if(f.minDistance>b.minDistance&&(f.minDistance=b.minDistance,f.start=b.start.clone(),f.end=b.end.clone()),b.minDistance<=0)return f}return f},asyncProcess(e,t,i,r,n){requestAnimationFrame(function a(s){var o=s;return function(){var s,l;for(l=o+i>t?t:o+i,s=o;s<l;s++){r&&r(e,s),s===l-1&&(l!==t?requestAnimationFrame(a(s+1)):n&&n(e))}}}(0))},hasSimilarProperty:function(e,t){if(!(e instanceof Object&&t instanceof Object))return!1;for(var i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},arrayMax:function(e){if(0===e.length)return-1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]>t&&(t=e[i]);return t},arrayMin:function(e){if(0===e.length)return 1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]<t&&(t=e[i]);return t},ab2str:function(e){return(new TextDecoder).decode(new Uint8Array(e))},str2ab:function(e){return(new TextEncoder).encode(e).buffer},getEncodedString:function(e){return r.md5&&"function"==typeof r.md5?r.md5(e):e},toMemoryString(e){var t=e/1048576;return t<1?t.toLocaleString(void 0,{maximumFractionDigits:3}):Math.round(t).toLocaleString()},defined:e=>null!=e,defaultValue:(e,t)=>null!=e?e:t,clone:function(e,t){if(null===e||"object"!=typeof e)return e;t=r.Utils.defaultValue(t,!1);var i=new e.constructor;for(var n in e)if(e.hasOwnProperty(n)){var a=e[n];t&&(a=r.Utils.clone(a,t)),i[n]=a}return i},binarySearch(e,t,i){for(var r,n,a=0,s=e.length-1;a<=s;)if((n=i(e[r=~~((a+s)/2)],t))<0)a=r+1;else{if(!(n>0))return r;s=r-1}return~(s+1)},unpackRGBAToDepth(e){if(!r.Utils.UnpackFactors){var t=255/256,i=new THREE.Vector3(16777216,65536,256);r.Utils.UnpackFactors=new THREE.Vector4(t/i.x,t/i.y,t/i.z,t)}return e.dot(r.Utils.UnpackFactors)},computeViewportTransformation(e,t,i,n){var a=r.Utils.defaultValue(e.x,0),s=r.Utils.defaultValue(e.y,0),o=r.Utils.defaultValue(e.width,0),l=r.Utils.defaultValue(e.height,0);t=r.Utils.defaultValue(t,0);var d=.5*o,h=.5*l,c=.5*((i=r.Utils.defaultValue(i,1))-t),u=d,p=h,m=c,f=a+d,g=s+h,v=t+c;return r.Utils.defined(n)||(n=new THREE.Matrix4),n.elements[0]=u,n.elements[1]=0,n.elements[2]=0,n.elements[3]=0,n.elements[4]=0,n.elements[5]=p,n.elements[6]=0,n.elements[7]=0,n.elements[8]=0,n.elements[9]=0,n.elements[10]=m,n.elements[11]=0,n.elements[12]=f,n.elements[13]=g,n.elements[14]=v,n.elements[15]=1,n},computeView:(e,t,i,n,a)=>(r.Utils.defined(a)||(a=new THREE.Matrix4),a.elements[0]=n.x,a.elements[1]=i.x,a.elements[2]=-t.x,a.elements[3]=0,a.elements[4]=n.y,a.elements[5]=i.y,a.elements[6]=-t.y,a.elements[7]=0,a.elements[8]=n.z,a.elements[9]=i.z,a.elements[10]=-t.z,a.elements[11]=0,a.elements[12]=-n.dot(e),a.elements[13]=-i.dot(e),a.elements[14]=t.dot(e),a.elements[15]=1,a),getTranslationFromMatrix4:(e,t)=>(r.Utils.defined(t)||(t=new THREE.Vector3),t.x=e.elements[12],t.y=e.elements[13],t.z=e.elements[14],t),pointInPolygon(e,t){for(var i=e.x,r=e.y,n=!1,a=0,s=t.length-1;a<t.length;s=a++){var o=t[a].x,l=t[a].y,d=t[s].x,h=t[s].y;l>r!=h>r&&i<(d-o)*(r-l)/(h-l)+o&&(n=!n)}return n},area(e){for(var t=e.length,i=0,r=t-1,n=0;n<t;r=n++)i+=e[r].x*e[n].y-e[n].x*e[r].y;return.5*i},isClockWise:e=>r.Utils.area(e)<0,lineLineIntersection(e,t,i,r){const n=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y),a=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),s=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x);if(0==n)return void 0;const o=a/n,l=s/n;return o>=0&&o<=1&&l>=0&&l<=1?new THREE.Vector2(e.x+o*(t.x-e.x),e.y+o*(t.y-e.y)):void 0},lineLineIntersection3d(e,t,i,n){const a=1e-5;function s(e,t,i){return!!(r.Math.lessThanOrEquals(i.x,Math.max(e.x,t.x),a)&&r.Math.lessThanOrEquals(Math.min(e.x,t.x),i.x,a)&&r.Math.lessThanOrEquals(i.y,Math.max(e.y,t.y),a)&&r.Math.lessThanOrEquals(Math.min(e.y,t.y),i.y,a)&&r.Math.lessThanOrEquals(i.z,Math.max(e.z,t.z),a)&&r.Math.lessThanOrEquals(Math.min(e.z,t.z),i.z,a))}var o=(new THREE.Vector3).subVectors(t,e),l=(new THREE.Vector3).subVectors(n,i);if(r.Math.equalsEpsilon(o.dot(l),a))return!1;var d=(new THREE.Vector3).subVectors(i,e),h=(new THREE.Vector3).crossVectors(o,l),c=(new THREE.Vector3).crossVectors(d,l),u=d.dot(h);if(r.Math.equalsEpsilon(u,0,a)&&!r.Math.equalsEpsilon(h.lengthSq(),a)){var p=c.dot(h)/h.lengthSq();if(!r.Math.lessThan(1,p,a)&&!r.Math.lessThan(u,0,a)){var m=e.clone().add(new THREE.Vector3(o.x*p,o.y*p,o.z*p));return s(e,t,m)&&s(i,n,m)?m:void 0}}},lineStartScratch:new THREE.Vector2,lineEndScratch:new THREE.Vector2,linePolygonIntersection(e,t,i){for(var n,a=0;a<i.length;a++)if(r.Utils.lineStartScratch.set(i[a].x,i[a].y),r.Utils.lineEndScratch.set(i[(a+1)%i.length].x,i[(a+1)%i.length].y),n=r.Utils.lineLineIntersection(e,t,r.Utils.lineStartScratch,r.Utils.lineEndScratch))return n},linePolygonIntersection2(e,t,i){for(var n,a=0;a<i.length;a++)if(r.Utils.lineStartScratch.set(i[a].x,i[a].y),r.Utils.lineEndScratch.set(i[(a+1)%i.length].x,i[(a+1)%i.length].y),n=r.Utils.lineLineIntersection(e,t,r.Utils.lineStartScratch,r.Utils.lineEndScratch))return n.index=a,n},delaunay(e){var t=1/1048576;let i=function(e,i,r,n){var a,s,o,l,d,h,c,u,p,m,f=e[i][0],g=e[i][1],v=e[r][0],y=e[r][1],M=e[n][0],E=e[n][1],x=Math.abs(g-y),_=Math.abs(y-E);return x<t?s=(l=-(M-v)/(E-y))*((a=(v+f)/2)-(h=(v+M)/2))+(u=(y+E)/2):_<t?s=(o=-(v-f)/(y-g))*((a=(M+v)/2)-(d=(f+v)/2))+(c=(g+y)/2):(a=((o=-(v-f)/(y-g))*(d=(f+v)/2)-(l=-(M-v)/(E-y))*(h=(v+M)/2)+(u=(y+E)/2)-(c=(g+y)/2))/(o-l),s=x>_?o*(a-d)+c:l*(a-h)+u),{i:i,j:r,k:n,x:a,y:s,r:(p=v-a)*p+(m=y-s)*m}},r=function(e){var t,i,r,n,a,s;for(i=e.length;i;)for(n=e[--i],r=e[--i],t=i;t;)if(s=e[--t],r===(a=e[--t])&&n===s||r===s&&n===a){e.splice(i,2),e.splice(t,2);break}};var n,a,s,o,l,d,h,c,u,p,m,f,g=e.length;if(g<3)return[];for(e=e.slice(0),s=new Array(g),n=g;n--;)s[n]=n;for(s.sort((function(t,i){var r=e[i][0]-e[t][0];return 0!==r?r:t-i})),o=function(e){var t,i,r,n,a,s,o=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY;for(t=e.length;t--;)e[t][0]<o&&(o=e[t][0]),e[t][0]>d&&(d=e[t][0]),e[t][1]<l&&(l=e[t][1]),e[t][1]>h&&(h=e[t][1]);return r=h-l,[[(a=o+.5*(i=d-o))-20*(n=Math.max(i,r)),(s=l+.5*r)-n],[a,s+20*n],[a+20*n,s-n]]}(e),e.push(o[0],o[1],o[2]),l=[i(e,g+0,g+1,g+2)],d=[],h=[],n=s.length;n--;h.length=0){for(f=s[n],a=l.length;a--;)(c=e[f][0]-l[a].x)>0&&c*c>l[a].r?(d.push(l[a]),l.splice(a,1)):c*c+(u=e[f][1]-l[a].y)*u-l[a].r>t||(h.push(l[a].i,l[a].j,l[a].j,l[a].k,l[a].k,l[a].i),l.splice(a,1));for(r(h),a=h.length;a;)m=h[--a],p=h[--a],l.push(i(e,p,m,f))}for(n=l.length;n--;)d.push(l[n]);for(l.length=0,n=d.length;n--;)d[n].i<g&&d[n].j<g&&d[n].k<g&&l.push(d[n].i,d[n].j,d[n].k);return l},bestdim(e,t){const i=1e-4*t.length();let r=Math.floor(1*e);r=Math.max(r,1);let n=[1,1,1];if(t.x>i)if(t.y>i)if(t.z>i){const e=Math.pow(r/(t.x*t.y*t.z),1/3);n[0]=Math.floor(t.x*e),n[1]=Math.floor(t.y*e),n[2]=Math.floor(t.z*e)}else n[0]=Math.floor(Math.sqrt(r*t.x/t.y)),n[1]=Math.floor(Math.sqrt(r*t.y/t.x));else t.z>i?(n[0]=Math.floor(Math.sqrt(r*t.x/t.z)),n[2]=Math.floor(Math.sqrt(r*t.z/t.x))):n[0]=Math.floor(r);else t.y>i?t.z>i?(n[1]=Math.floor(Math.sqrt(r*t.y/t.z)),n[2]=Math.floor(Math.sqrt(r*t.z/t.y))):n[1]=Math.floor(r):t.z>i&&(n[2]=Math.floor(r));return n[0]=Math.max(n[0],1),n[1]=Math.max(n[1],1),n[2]=Math.max(n[2],1),n},charCodeUrl(e){let t=4;e.endsWith(".json.gz")?t=9:e.endsWith("bimtiles.json.gz")&&(t=17);let i=e.length,r=0;for(let n=i-t;n>=i-t-6;n--)r+=e[n].charCodeAt(0);return r},getPickPointByPixel(e,t,i){const r=e.getRenderer(),n=e.camera,a=e.rendererManager.renderer,s=e.getViewportSize();let o=s.width,l=s.height;i=s.height-i;var d=window.devicePixelRatio||1;o*=d,l*=d;const h=new THREE.WebGLRenderTarget(o,l,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter});a.renderCustomDepth&&a.renderCustomDepth(r,e.getScene(),n,h,!0);let c=new Uint8Array(4);r.readRenderTargetPixels(h,t*d,i*d,1,1,c);const u=n.near,p=n.far,m=2/(Math.log(p+1)/Math.LN2),f=n.projectionMatrix;this.TemporaryMatrix.copy(f).invert();const g=n.matrixWorld,v=new THREE.Vector4;let y=new THREE.Vector4;const M=c[0],E=c[1],x=c[2],_=c[3];v.set(M,E,x,_);let b=this.unpackRGBAToDepth(v);if(0==b)return;b/=255;const I=2*b/m,T=Math.pow(2,I)-1;let S=p*(1-u/T)/(p-u);const C=2*t/o-1,w=2*i/l-1;return S=2*S-1,y.set(C,w,S,1),y.multiplyScalar(T),y.applyMatrix4(this.TemporaryMatrix),y.applyMatrix4(g),this.scratchVector_1.set(y.x,y.y,y.z),this.scratchVector_1},computeBoxSSE(e,t){let i=t.distanceToPoint(e.cameraPositionWc);i=i<r.Math.EPSILON2?r.Math.EPSILON2:i;const n=t.max.distanceTo(t.min)*(void 0!==e.geoErrScaleFactor?e.geoErrScaleFactor:1);return e.cameraPreSSE*(n/i)},UInt32ToVec4:e=>[parseInt(e/16777216),parseInt(e/65536)%256,parseInt(e/256)%256,e%256],SortMapByValue(e){let t=Array.from(e);t.sort((function(e,t){return t[1]-e[1]}));return[...new Map(t.map((e=>[e[0],e[1]]))).keys()]},CheckBimtilesVersionMatch:function(e,t){if(!r.Utils.defined(t))return!0;if("bimtiles"!==t.asset)return!0;const i=e.VERSION,n=e.VERSION_MINOR,a=void 0===t.version?"0.0.0":t.version,s=void 0===t.versionMinor?"0":t.versionMinor;return i>=a&&n>=s}},THREE.Math=THREE.MathUtils,r.Compatibility={convertAnnotationsToV3:function(e,t){var i=JSON.parse(t);function n(e,t,i){var n;n="string"==typeof e?JSON.parse(window.atob(e)):{position:{x:e.position.x,y:e.position.y,z:e.position.z},target:{x:e.target.x,y:e.target.y,z:e.target.z},up:{x:e.up.x,y:e.up.y,z:e.up.z}};var a=new THREE.Vector3(n.position.x,n.position.y,n.position.z),s=new THREE.Vector3(n.target.x,n.target.y,n.target.z),o=new THREE.Vector3(n.up.x,n.up.y,n.up.z),l=new r.CameraInfo("persp",a,s,o);return l=r.Camera.drawingToWorld(l,t),l=new r.CameraInfo("persp",l.position,l.target,l.up),l=r.Camera.worldToDrawing(l,i),n.position.x=l.position.x,n.position.y=l.position.y,n.position.z=l.position.z,n.target.x=l.target.x,n.target.y=l.target.y,n.target.z=l.target.z,n.up.x=l.up.x,n.up.y=l.up.y,n.up.z=l.up.z,"string"==typeof e&&(n=window.btoa(JSON.stringify(n))),n}if(i.filter){var a=JSON.parse(i.filter);if(a.filter||a.basicIds){var s=e.getScene(),o=s.getTransformMatrixGlobal();(new THREE.Matrix4).copy(o).invert();var l=s.getRawMatrixGlobal();(new THREE.Matrix4).copy(l).invert();var d=e.getFilter().getFilterType(),h={state:{}};a.filter?(a.fileFilter&&(h.state[d.FILE_HIDDEN]=a.fileFilter),a.selectionSet&&(h.state[d.SELECTED]=a.selectionSet),a.filter.visibleIds&&(h.state[d.VISIBLE]=a.filter.visibleIds),a.filter.invisibleIds&&(h.state[d.HIDDEN]=a.filter.invisibleIds),a.filter.conditions&&(h.state[d.CONDITION_HIDDEN_OTHERS]=a.filter.conditions),a.filter.filters&&(h.state[d.USER_HIDDEN]=a.filter.filters),a.frozenSet&&(h.state[d.FROZENFILTER]=a.frozenSet),a.isolateSet&&(h.state[d.ISOLATE_HIDDEN_OTHERS]=a.isolateSet),a.overriderByIds&&(h.state[d.OVERRIDEFILTER]=a.overriderByIds),a.overriderByData&&(h.state[d.USER_OVERRIDE]=a.overriderByData),a.overriderCondition&&(h.state[d.CONDITION_OVERRIDE]=a.overriderCondition),a.isolateCondition&&(h.state[d.ISOLATE_CONDITION_HIDDEN_OTHERS]=a.isolateCondition),h.state.sceneState=a.overriderByScene):a.basicIds&&(a.basicIds[1]&&(h.state[d.FILE_HIDDEN]=a.basicIds[1]),a.basicIds[2]&&(h.state[d.SELECTED]=a.basicIds[2]),a.basicIds[3]&&(h.state[d.VISIBLE]=a.basicIds[3]),a.basicIds[4]&&(h.state[d.HIDDEN]=a.basicIds[4]),a.conditions[0]&&(h.state[d.CONDITION_HIDDEN_OTHERS]=a.conditions[0]),a.userHiddenIds&&(h.state[d.USER_HIDDEN]=a.userHiddenIds),a.frozenIds&&(h.state[d.FROZENFILTER]=a.frozenIds),a.isolateIds&&(h.state[d.ISOLATE_HIDDEN_OTHERS]=a.isolateIds),a.overrideByIds&&(h.state[d.OVERRIDEFILTER]=a.overrideByIds),a.overrideByData&&(h.state[d.USER_OVERRIDE]=a.overrideByData),a.conditions[2]&&(h.state[d.CONDITION_OVERRIDE]=a.conditions[2]),a.isolateConditions&&(a.isolateConditions[0]&&(h.state[d.ISOLATE_CONDITION_HIDDEN]=a.isolateConditions[0]),a.isolateConditions[1]&&(h.state[d.ISOLATE_CONDITION_HIDDEN_OTHERS]=a.isolateConditions[1]),a.isolateConditions[2]&&(h.state[d.ISOLATE_CONDITION_TRANSLUCENT]=a.isolateConditions[2]),a.isolateConditions[3]&&(h.state[d.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=a.isolateConditions[3])),h.state.sceneState=a.sceneState),a.camera?h.camera=n(a.camera,o,l):h.camera=n(i.camera,o,l),a=h,i.filter=JSON.stringify(a)}}return i},isLoadLinesEnabled:function(e){return!(parseFloat(e)<=.12)},isLoadBMpkEnabled:function(e){return!(parseFloat(e)<.13)},isLoadLayerSceneEnabled:function(e){return!(parseFloat(e)<.15)},isUse32MpkData:function(e){return!(parseFloat(e)<.15)},use32MpkData:!1,isUseMergeTexturePkg:function(e){return!(parseFloat(e)<.16)},isUseMergeTextureOptimize:function(e){return parseFloat(e)>.17},isUseDoubleMatrix:function(e){return parseFloat(e)>=.2},isUseDoubleMatrixMPKHeader:function(e){return parseFloat(e)>=.21},isUseINCREMENTByBmpkCount:function(e,t){return 0===e&&t>0},getMatrixSize:function(e){return this.isUseDoubleMatrix(e)?128:64},getMatrixDatatype:function(e){return this.isUseDoubleMatrix(e)?Float64Array:Float32Array},useMergeTexturePkg:!1},r.DomUtil={getContainerOffsetToClient:function(e){var t,i;if(e!=document){var r=(i=e).getBoundingClientRect?function(e){var t=e.getBoundingClientRect(),i=document.body,r=document.documentElement,n=r.clientTop||i.clientTop,a=r.clientLeft||i.clientLeft,s=t.top-n,o=t.left-a;return{top:Math.round(s),left:Math.round(o)}}(i):function(e){for(var t=0,i=0;e;)t+=e.offsetTop,i+=e.offsetLeft,e=e.offsetParent;var r=document.body,n=document.documentElement;return{top:t-=window.pageYOffset||n.scrollTop||r.scrollTop,left:i-=window.pageXOffset||n.scrollLeft||r.scrollLeft}}(i);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t},loadXML:function(e,t){let i;if(window.ActiveXObject){const e=["MSXML2.DOMDocument.6.0","MSXML2.DOMDocument.5.0","MSXML2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","Microsoft.XMLDOM","MSXML.DOMDocument"];for(let t=0,r=e.length;t<r;++t){try{i=new ActiveXObject(e[t])}catch(e){continue}if(i)break}}else{if(!document.implementation||!document.implementation.createDocument)return console.log("不能创建 XML DOM对象，请更新你的浏览器……"),null;i=document.implementation.createDocument("","",null)}return i.async=t,i.load(e),i},loadXMLDoc:function(e){let t;return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t.open("GET",e,!1),t.send(),t.responseXML},getXMLAttributeValues:function(e,t){const i=e.getElementsByTagName(t);if(0===i.length)return;const r=i[0],n={};for(let e=0,t=r.attributes.length;e<t;++e){const t=r.attributes[e].nodeName;n[t]=r.getAttribute(t)}return n},getXMLAttributeValuesByAttrName:function(e,t,i){const r=e.getElementsByTagName(t);if(0===r.length)return;const n=[];for(let e=0,t=r.length;e<t;++e){const t=r[e].getAttribute(i);t&&n.push(t)}return n}},(()=>{const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3(0,0,1),s=new THREE.Matrix4,o=new THREE.Matrix3;var l;function d(e){let t=[];for(let i of e){const e=i.clone();e.z=0,t.push(e)}return t}function h(e){let t=[],i=-1/0,r=0;e.forEach(((e,n)=>{const a=e.clone();a.z>i&&(i=a.z,r=n),t.push(a)}));for(let e of t)e.z=i;return{topPoints:t,maxIndex:r}}function c(e){n.set(0,0,0);for(let t of e)n.add(t);const t=n.angleTo(a);return t>-Math.PI/2&&t<Math.PI/2}r.GeomUtil={EmptyGeometry:new THREE.BufferGeometry,UnitCylinderInstance:new THREE.CylinderBufferGeometry(1,1,1,32,1,!1),UnitBoxInstance:new THREE.BoxBufferGeometry(1,1,1),UnitTextureCylinder:null,UnitTextureBox:null,initializeUnitInstances:function(){r.GeomUtil.UnitCylinderInstance.boundingBox||r.GeomUtil.UnitCylinderInstance.computeBoundingBox(),r.GeomUtil.UnitBoxInstance.boundingBox||r.GeomUtil.UnitBoxInstance.computeBoundingBox()},destroyUnitInstances:function(){r.GeomUtil.UnitCylinderInstance.dispose(),r.GeomUtil.UnitBoxInstance.dispose()},getBoxData:function(e){for(var t=[[],[],[],[],[],[]],i=0;i<4;++i)t[0].push(-1,0,0);for(i=0;i<4;++i)t[1].push(0,-1,0);for(i=0;i<4;++i)t[2].push(0,0,-1);for(i=0;i<4;++i)t[3].push(0,0,1);for(i=0;i<4;++i)t[4].push(0,1,0);for(i=0;i<4;++i)t[5].push(1,0,0);var r=[[],[],[],[],[],[]];return r[0]=r[2]=r[4]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],r[1]=r[3]=r[5]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],{vertex:[[-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5],[-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,.5],[-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5],[-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5],[-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5],[.5,-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5]][e],normal:t[e],uv:r[e],index:[[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3]][e]}},getPipeData2:function(){var e=[.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5,.5,0,-.5,.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5],t=[0,9,1,1,9,10,1,10,2,2,10,11,2,11,3,3,11,12,3,12,4,4,12,13,4,13,5,5,13,14,5,14,6,6,14,15,6,15,7,7,15,16,7,16,8,8,16,17,18,19,20,18,20,21,18,21,22,18,22,23,18,23,24,18,24,25,26,28,27,26,29,28,26,30,29,26,31,30,26,32,31,26,33,32],i=[1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],r=[-.5,.5,-.375,.5,-.25,.5,-.125,.5,0,.5,.125,.5,.25,.5,.375,.5,.5,.5,-.5,-.5,-.375,-.5,-.25,-.5,-.125,-.5,0,-.5,.125,-.5,.25,-.5,.375,-.5,.5,-.5,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875];return function(){return{vertex:e,normal:i,uv:r,index:t}}}(),getPipeData:function(e){(void 0===e||e<8)&&(e=8),e>256&&(e=256);var t,i,r=.5,n=4*e+2,a=3*(4*e-4),s=e+1,o=1/e,l=6.28318530714/e,d=[];for(t=0;t<e;++t)d.push(r*Math.cos(t*l)),d.push(r*Math.sin(t*l));d.push(r),d.push(0);var h=[];for(i=2*s,t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(r);for(t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(-.5);for(i=2*e,t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(r);for(t=i;t>0;t-=2)h.push(d[t]),h.push(d[t+1]),h.push(-.5);var c=[],u=e+1;for(t=0;t<e;++t)c.push(t),c.push(t+u),c.push(t+1),c.push(t+1),c.push(t+u),c.push(t+u+1);var p=2*s;for(t=1;t<e-1;++t)c.push(p),c.push(p+t),c.push(p+t+1);for(p+=e,t=1;t<e-1;++t)c.push(p),c.push(p+t),c.push(p+t+1);var m=[];for(t=e;t>=0;--t)m.push(t*o-r),m.push(-.5);for(t=e;t>=0;--t)m.push(t*o-r),m.push(r);for(i=2*e,t=0;t<i;t+=2)m.push(d[t]),m.push(d[t+1]);for(t=i;t>0;t-=2)m.push(d[t]),m.push(d[t+1]);i=3*n;var f,g,v,y=[];for(t=0;t<i;++t)y.push(0);var M=new THREE.Vector3,E=new THREE.Vector3,x=new THREE.Vector3,_=new THREE.Vector3,b=new THREE.Vector3;for(t=0;t<a;t+=3)f=3*c[t],g=3*c[t+1],v=3*c[t+2],M.fromArray(h,f),E.fromArray(h,g),x.fromArray(h,v),_.subVectors(x,E),b.subVectors(M,E),_.cross(b),y[f]+=_.x,y[f+1]+=_.y,y[f+2]+=_.z,y[g]+=_.x,y[g+1]+=_.y,y[g+2]+=_.z,y[v]+=_.x,y[v+1]+=_.y,y[v+2]+=_.z;var I=new THREE.Vector3;for(i=3*n,t=0;t<i;t+=3)I.fromArray(y,t),I.normalize(),y[t]=I.x,y[t+1]=I.y,y[t+2]=I.z;return{vertex:h,normal:y,uv:m,index:c,edges:e}},getInstancePipeData:function(e,t){var i=this.getPipeData(e);(void 0===e||e<8)&&(e=8),e>256&&(e=256);var r=2*(e+1),n=r+e,a=4*e+2,s=[[],[],[]];s[0]=i.vertex.slice(0,3*r),s[1]=i.vertex.slice(3*r,3*n),s[2]=i.vertex.slice(3*n,3*a);var o=[[],[],[]],l=e+1,d=0;for(d=0;d<e;++d)o[0].push(d),o[0].push(d+l),o[0].push(d+1),o[0].push(d+1),o[0].push(d+l),o[0].push(d+l+1);for(d=1;d<e-1;++d)o[1].push(0),o[1].push(d),o[1].push(d+1);for(d=1;d<e-1;++d)o[2].push(0),o[2].push(d),o[2].push(d+1);var h=[[],[],[]];h[0]=i.uv.slice(0,2*r),h[1]=i.uv.slice(2*r,2*n),h[2]=i.uv.slice(2*n,2*a);var c=[[],[],[]];return c[0]=i.normal.slice(0,3*r),c[1]=i.normal.slice(3*r,3*n),c[2]=i.normal.slice(3*n,3*a),{vertex:s[t],normal:c[t],uv:h[t],index:o[t]}},getUnitTextureCylinder:function(){if(null==r.GeomUtil.UnitTextureCylinder){r.GeomUtil.UnitTextureCylinder=new Array(3);for(var e=0;e<3;++e){var t=r.GeomUtil.getInstancePipeData(32,e);r.GeomUtil.UnitTextureCylinder[e]=new THREE.BufferGeometry,r.GeomUtil.UnitTextureCylinder[e].setIndex(t.index),r.GeomUtil.UnitTextureCylinder[e].setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.GeomUtil.UnitTextureCylinder[e].setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r.GeomUtil.UnitTextureCylinder[e].setAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return r.GeomUtil.UnitTextureCylinder},getUnitTextureBox:function(){if(null===r.GeomUtil.UnitTextureBox){r.GeomUtil.UnitTextureBox=new Array(6);for(var e=0;e<6;++e){var t=r.GeomUtil.getBoxData(e);r.GeomUtil.UnitTextureBox[e]=new THREE.BufferGeometry,r.GeomUtil.UnitTextureBox[e].setIndex(t.index),r.GeomUtil.UnitTextureBox[e].setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.GeomUtil.UnitTextureBox[e].setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r.GeomUtil.UnitTextureBox[e].setAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return r.GeomUtil.UnitTextureBox},getBoxBufferGeometryWithUvMatrices:function(e){for(var t,i=[],n=new THREE.Matrix3,a=new THREE.Vector3,s=!!e,o=0;o<6;++o){t=new THREE.BufferGeometry;var l=r.GeomUtil.getBoxData(o);if(s){var d=[];n.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1);for(var h=0,c=l.uv.length;h<c;h+=2)a.set(l.uv[h],l.uv[h+1],1),a.applyMatrix3(n),d.push(a.x),d.push(a.y);t.setAttribute("uv",new THREE.Float32BufferAttribute(d,2))}t.setIndex(new THREE.BufferAttribute(Uint32Array.from(l.index),1)),t.setAttribute("position",new THREE.Float32BufferAttribute(l.vertex,3)),t.setAttribute("normal",new THREE.Float32BufferAttribute(l.normal,3)),i.push(t)}return r.GeomUtil.mergeBufferGeometries2(i)},getPipeBufferGeometryWithUvMatrices:function(e){var t=r.GeomUtil.getPipeData(32),i=t.edges,n=!(!e||18!==e.length),a=new THREE.BufferGeometry;if(n){for(var s=[],o=0,l=e.length;o<l;o+=6){var d=new THREE.Matrix3;d.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1),s.push(d)}for(var h=[],c=new THREE.Vector3,u=4*(i+1),p=u+2*i,m=0,f=t.uv.length;m<f;m+=2)c.set(t.uv[m],t.uv[m+1],1),m<u?c.applyMatrix3(s[0]):m<p?c.applyMatrix3(s[1]):c.applyMatrix3(s[2]),h.push(c.x),h.push(c.y);a.setAttribute("uv",new THREE.Float32BufferAttribute(h,2))}return a.setIndex(new THREE.Uint32BufferAttribute(t.index,1)),a.setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),a.setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),a},getWorldMatrixOfMesh:function(e){for(var t=[],i=e.parent;i;)t.push(i.matrix),i=i.parent;var r=new THREE.Matrix4;if(t.length>0){r=t[t.length-1];for(var n=t.length-2;n>=0;--n)r.multiply(t[n])}var a=new THREE.Matrix4;return a.multiplyMatrices(r,e.matrix),a},getWorldPositionOfMesh:function(e,t){t||(t=new THREE.Matrix4),s.copy(t).invert();var i=e.clone();return i.applyMatrix4(s),i},getBoundingBoxWorldOfMesh:function(e){var t=e.boundingBox;return t||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),t=e.geometry.boundingBox),t.clone()},getBoundingBoxWorldOfGeometry:function(e){return e.boundingBox||e.computeBoundingBox(),e.boundingBox.clone()},mergeBufferGeometries:function(e,t){for(var i=null!==e[0].geometry.index,r=new Set(Object.keys(e[0].geometry.attributes)),n=new Set(Object.keys(e[0].geometry.morphAttributes)),a={},s={},o=new THREE.BufferGeometry,l=0;l<e.length;++l){var d=e[l].geometry;if(i!==(null!==d.index))return null;for(var h in d.attributes){if(!r.has(h))return console.log("attributes not Used: ",h),null;void 0===a[h]&&(a[h]=[]),a[h].push(d.attributes[h])}for(var h in d.morphAttributes){if(!n.has(h))return null;void 0===s[h]&&(s[h]=[]),s[h].push(d.morphAttributes[h])}void 0!==d.userData&&(o.userData=o.userData||{},o.userData.mergedUserData=o.userData.mergedUserData||[],o.userData.mergedUserData.push(d.userData))}if(i){var c=0,u=[],p=0;for(l=0;l<e.length;++l){var m=e[l].geometry.index;if(c>0){m=m.clone();for(var f=0;f<m.count;++f)m.setX(f,m.getX(f)+c)}u.push(m),c+=e[l].geometry.attributes.position.count,void 0===t[e[l].name]&&(t[e[l].name]=[]),t[e[l].name].push({nodeId:e[l].nodeId,indexStart:p,indexCount:m.count,materialId:e[l].materialId}),p+=m.count}var g=this.mergeBufferAttributes(u);if(!g)return null;o.index=g}for(var h in a){var v=this.mergeBufferAttributes(a[h]);if(!v)return null;o.setAttribute(h,v)}for(var h in s){var y=s[h][0].length;if(0===y)break;o.morphAttributes=o.morphAttributes||{},o.morphAttributes[h]=[];for(l=0;l<y;++l){var M=[];for(f=0;f<s[h].length;++f)M.push(s[h][f][l]);var E=this.mergeBufferAttributes(M);if(!E)return null;o.morphAttributes[h].push(E)}}return o},mergeBufferGeometries2:function(e){for(var t=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),r={},n=new THREE.BufferGeometry,a=0;a<e.length;++a){var s=e[a];if(t!==(null!==s.index))return null;for(var o in s.attributes){if(!i.has(o))return null;void 0===r[o]&&(r[o]=[]),r[o].push(s.attributes[o])}}if(t){var l=0,d=[];for(a=0;a<e.length;++a){var h=e[a].index;if(l>0){h=h.clone();for(var c=0;c<h.count;++c)h.setX(c,h.getX(c)+l)}d.push(h),l+=e[a].attributes.position.count}var u=this.mergeBufferAttributes(d);if(!u)return null;n.index=u}for(var o in r){var p=this.mergeBufferAttributes(r[o]);if(!p)return null;n.setAttribute(o,p)}return n},mergeBufferAttributes:function(e){for(var t,i,r,n=0,a=0;a<e.length;++a){var s=e[a];if(s.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=s.array.constructor),t!==s.array.constructor)return null;if(void 0===i&&(i=s.itemSize),i!==s.itemSize)return null;if(void 0===r&&(r=s.normalized),r!==s.normalized)return null;n+=s.array.length}for(var o=new t(n),l=0,d=0;d<e.length;++d)o.set(e[d].array,l),l+=e[d].array.length;return new THREE.BufferAttribute(o,i,r)},applyMatrix3ToBuffer:(l=new THREE.Vector3,function(e,t){for(var i=0,r=t.length;i<r;i+=3)l.x=t[i+0],l.y=t[i+1],l.z=t[i+2],l.applyMatrix3(e),t[i+0]=l.x,t[i+1]=l.y,t[i+2]=l.z;return t}),applyMatrix4ToBuffer:function(){var e=new THREE.Vector3;return function(t,i){for(var r=0,n=i.length;r<n;r+=3)e.x=i[r+0],e.y=i[r+1],e.z=i[r+2],e.applyMatrix4(t),i[r+0]=e.x,i[r+1]=e.y,i[r+2]=e.z;return i}}(),normalizeBuffer:function(e){for(var t,i,r,n,a=0,s=e.length;a<s;a+=3)t=e[a],i=e[a+1],r=e[a+2],n=1/Math.sqrt(t*t+i*i+r*r),e[a+0]=t*n,e[a+1]=i*n,e[a+2]=r*n},disposeBufferFromGeometry:function(e,t){for(var i=0,r=t.length;i<r;i++){var n=e.getAttribute(t[i]);n&&(n.array=null)}},disposeIndexBufferFromGeometry:function(e){e.index&&(e.index.array=null)},copyMeshProperties:function(e,t){e.name=t.name,e.up.copy(t.up),e.position.copy(t.position),e.quaternion.copy(t.quaternion),e.scale.copy(t.scale),e.matrix.copy(t.matrix),e.matrixWorld.copy(t.matrixWorld),e.matrixAutoUpdate=t.matrixAutoUpdate,e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate},createBufferGeometryWithPosAndSkin:function(e,t){var i=new THREE.BufferGeometry;if(e.isBufferGeometry||e._bufferGeometry){var r=e.isBufferGeometry?e:e._bufferGeometry;if(!r.getAttribute("position"))return null;i.setAttribute("position",r.getAttribute("position")),r.getAttribute("skinIndex")&&i.setAttribute("skinIndex",r.getAttribute("skinIndex")),r.getAttribute("skinWeight")&&i.setAttribute("skinWeight",r.getAttribute("skinWeight"));var n=r.getIndex();n&&i.setIndex(n),t&&r.getAttribute("uv")&&i.setAttribute("uv",r.getAttribute("uv")),r.getAttribute("previous")&&(i.setAttribute("previous",r.getAttribute("previous")),i.setAttribute("next",r.getAttribute("next")),i.setAttribute("uv",r.getAttribute("uv")))}else if(e.isGeometry){if(0===e.vertices.length)return null;var a=new THREE.Float32BufferAttribute(3*e.vertices.length,3);if(i.setAttribute("position",a.copyVector3sArray(e.vertices)),e.skinIndices.length>0){var s=new THREE.Float32BufferAttribute(4*e.skinIndices.length,4);i.setAttribute("skinIndex",s.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var o=new THREE.Float32BufferAttribute(4*e.skinWeights.length,4);this.setAttribute("skinWeight",o.copyVector4sArray(e.skinWeights))}if(e.faces.length){for(var l=e.faces,d=[],h=0;h<l.length;h++){var c=l[h];d.push(c.a,c.b,c.c)}i.setIndex(d)}}if(!i.getIndex()){for(var u,p=[],m=Math.floor(i.attributes.position.count/3),f=0;f<m;f++)u=3*f,p.push(u,u+1,u+2);i.setIndex(p)}return i},limitGeometryBufferSize:function(e){var t,i,r,n,a,s,o=45e6;if(e.groups.length){var l=e.groups,d=!1;for(i=0,r=l.length;i<r;i++)if(l[i].count>o){d=!0;break}if(!d)return;for(e.clearGroups(),i=0,r=l.length;i<r;i++){var h=l[i];if((n=h.count)>o){for(a=Math.floor(n/o),s=n%o,t=0;t<a;t++)e.addGroup(h.start+t*o,o,h.materialIndex);s&&e.addGroup(h.start+a*o,s,h.materialIndex)}else e.addGroup(h.start,h.count,h.materialIndex)}}else if((n=e.index?e.index.count:0)>o){for(a=Math.floor(n/o),s=n%o,t=0;t<a;t++)e.addGroup(t*o,o,0);s&&e.addGroup(a*o,s,0)}},getUnitLightmapBox:function(){if(void 0===r.GeomUtil.UnitLightmapBoxGeometry){for(var e,t,i=[],n=[],a=[],s=[],o=0,l=0;l<6;++l){var d=r.GeomUtil.getBoxData(l);for(e=0,t=d.index.length;e<t;e++){var h=d.index[e];i.push(d.vertex[3*h]),i.push(d.vertex[3*h+1]),i.push(d.vertex[3*h+2]),n.push(d.normal[3*h]),n.push(d.normal[3*h+1]),n.push(d.normal[3*h+2]),a.push(d.uv[2*h]),a.push(d.uv[2*h+1]),s.push(e+o)}o+=d.index.length}r.GeomUtil.UnitLightmapBoxGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapBoxGeometry.setIndex(s),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(n,3)),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(a,2))}return r.GeomUtil.UnitLightmapBoxGeometry},getUnitLightmapBoxM:function(){if(void 0===r.GeomUtil.UnitLightmapBoxMGeometry){r.GeomUtil.UnitLightmapBoxMGeometry=new Array(6);for(var e=0;e<6;++e){for(var t=r.GeomUtil.getBoxData(e),i=[],n=[],a=[],s=[],o=0,l=t.index.length;o<l;o++){var d=t.index[o];n.push(t.vertex[3*d]),n.push(t.vertex[3*d+1]),n.push(t.vertex[3*d+2]),a.push(t.normal[3*d]),a.push(t.normal[3*d+1]),a.push(t.normal[3*d+2]),s.push(t.uv[2*d]),s.push(t.uv[2*d+1]),i.push(o)}r.GeomUtil.UnitLightmapBoxMGeometry[e]=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapBoxMGeometry[e].setIndex(i),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("position",new THREE.Float32BufferAttribute(n,3)),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("uv",new THREE.Float32BufferAttribute(s,2))}}return r.GeomUtil.UnitLightmapBoxMGeometry},getUnitLightmapPipeM:function(){if(void 0===r.GeomUtil.UnitLightmapPipeMGeometry){var e,t,i=[],n=[],a=[],s=[],o=r.GeomUtil.getPipeData(32);for(e=0,t=o.index.length;e<t;e++){var l=o.index[e];i.push(o.vertex[3*l]),i.push(o.vertex[3*l+1]),i.push(o.vertex[3*l+2]),n.push(o.normal[3*l]),n.push(o.normal[3*l+1]),n.push(o.normal[3*l+2]),a.push(o.uv[2*l]),a.push(o.uv[2*l+1]),s.push(e)}r.GeomUtil.UnitLightmapPipeMGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapPipeMGeometry.setIndex(s),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(n,3)),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(a,2))}return r.GeomUtil.UnitLightmapPipeMGeometry},getUnitLightmapPipe:function(){if(void 0===r.GeomUtil.UnitLightmapPipeGeometry){var e,t,i=[],n=[],a=[],s=[],o=r.GeomUtil.UnitCylinderInstance,l=o.getAttribute("position").array,d=o.getAttribute("normal").array,h=o.getAttribute("uv").array,c=o.getIndex().array;for(e=0,t=c.length;e<t;e++){var u=c[e];i.push(l[3*u]),i.push(l[3*u+1]),i.push(l[3*u+2]),n.push(d[3*u]),n.push(d[3*u+1]),n.push(d[3*u+2]),a.push(h[2*u]),a.push(h[2*u+1]),s.push(e)}r.GeomUtil.UnitLightmapPipeGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapPipeGeometry.setIndex(s),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(n,3)),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(a,2))}return r.GeomUtil.UnitLightmapPipeGeometry},getGeometrySplitByPlane:function(e,t){var i=function(e){return e<0?s:e>0?a:o},n=function(e,t){return t.distanceToPoint(e)},a="front",s="back",o="on",l=["a","b","c"];let d=e.geometry,h=e._modelMatrix||new THREE.Matrix4,c=e.matrix.clone().premultiply(h.clone().invert()),u=c.clone().invert(),p=(new THREE.Matrix3).getNormalMatrix(u);if("BufferGeometry"!=d.type){var m=new THREE.BufferGeometry;m.fromGeometry(d),m.applyMatrix4(c),d=m}else d=d.clone().applyMatrix4(c);for(var f=new r.SplitGeometryBuilder(d,t),g=[],v=[],y=d.attributes.position.array,M=new THREE.Vector3,E=0;E<y.length;E+=3){M.set(y[E],y[E+1],y[E+2]);var x=n(M,t),_=i(x);g.push(x),v.push(_)}var b=d.index.array,I=0;for(b.length,E=0;E<b.length;E+=3){for(var T=[],S=E;S<E+3;S++)T.push(v[b[S]]);if(-1!==T.indexOf(a)||-1===T.indexOf(s)){var C={a:b[E],b:b[E+1],c:b[E+2]};f.startFace(I,C);var w=l[l.length-1],R=b[E+2],B=g[R],A=v[R];l.map((function(e){var t=C[e],i=g[t],r=v[t];r===a&&(A===s?(f.addIntersection(w,e,B,i),f.addVertex(e)):f.addVertex(e)),r===o&&f.addVertex(e),r===s&&A===a&&f.addIntersection(w,e,B,i),w=e,R=t,A=r,B=i})),f.endFace(),I++}}var P=new THREE.BufferGeometry;return P.setAttribute("position",new THREE.Float32BufferAttribute(f.targetPositions,3)),P.setAttribute("normal",new THREE.Float32BufferAttribute(f.targetNormals,3)),f.targetUvs.length>0&&P.setAttribute("uv",new THREE.Float32BufferAttribute(f.targetUvs,2)),f.targetUv3s.length>0&&P.setAttribute("uv3",new THREE.Float32BufferAttribute(f.targetUv3s,2)),P.getAttribute("position").applyMatrix4(u),P.getAttribute("normal").applyNormalMatrix(p),f.targetColors&&P.setAttribute("color",new THREE.Uint8BufferAttribute(f.targetColors,4,!0)),f.targetIds&&P.setAttribute("id",new THREE.Uint8BufferAttribute(f.targetIds,4)),f.targetVStates&&P.setAttribute("vState",new THREE.Float32BufferAttribute(f.targetVStates,4)),f.targetColorStates&&P.setAttribute("pointColorState",new THREE.Uint8BufferAttribute(f.targetColorStates,4)),f.targetBarycentric&&P.setAttribute("barycentric",new THREE.Float32BufferAttribute(f.targetBarycentric,3)),P.setIndex(new THREE.Uint32BufferAttribute(f.targetIndices,1)),{geometry:P,nodeInfoMatrix:c}},getGeometrySplitByMultiPlane:function(e,t){let i=0,n=[],a=[],s=[],o=[],l=[];for(let t=0,r=e.length;t<r;t++){const r=e[t].object.matrix.clone(),d=e[t].object._modelMatrix||new THREE.Matrix4;r.premultiply(d.clone().invert());let h=e[t].object.geometry;if("BufferGeometry"!=e[t].object.geometry.type){let e=new THREE.BufferGeometry;e.fromGeometry(h),h=e}let c=Array.from(h.attributes.position.array),u=Array.from(h.index.array),p=null==h.attributes.normal?void 0:Array.from(h.attributes.normal.array),m=null==h.attributes.uv?void 0:Array.from(h.attributes.uv.array);for(let e=0,t=c.length;e<t;e+=3){const t=[0,1,2].map((t=>c[e+t]));let i=new THREE.Vector3(t[0],t[1],t[2]);i.applyMatrix4(r),c[e+0]=i.x,c[e+1]=i.y,c[e+2]=i.z}if(n=n.concat(c),u=u.map((e=>e+i)),a=a.concat(u),l=l.concat(Array.from({length:u.length/3},((e,i)=>t))),p)for(let e=0,t=p.length;e<t;e+=3){const t=[0,1,2].map((t=>p[e+t]));let i=new THREE.Vector4(t[0],t[1],t[2],1);i.applyMatrix4(r.clone().invert().transpose()),p[e+0]=i.x,p[e+1]=i.y,p[e+2]=i.z}s=s.concat(p||Array.from({length:c.length},((e,t)=>{}))),o=o.concat(m||Array.from({length:2*c.length/3},((e,t)=>{}))),i+=c.length/3}let d={vertices:n,indices:a,normal:s,uvs:o},h=function(e,t,i,r){const n=t.clone().sub(e),a=i.clone().sub(e),s=a.length()/n.length();return!r&&(r=1e-8),n.clone().cross(a).length()<r&&s>0-r&&s<1+r},c=function(e,t,i,r){const n=[0,1,2].map((e=>i[e])),a=[0,1,2].map((i=>function(e,t,i,r,n){const a=e,s=t.clone().sub(e),o=i,l=r.clone().sub(i);let d=o.clone().sub(a).cross(l),h=s.clone().cross(l),c=d.dot(h)/(d.length()*h.length());const u=c*d.length()/h.length();d=o.clone().sub(a).cross(s),h=s.clone().cross(l),c=d.dot(h)/(d.length()*h.length());const p=c*d.length()/h.length();return!n&&(n=1e-8),!(s.clone().cross(l).length()<n&&o.clone().sub(a).cross(s).length()<n)&&!(s.clone().cross(l).length()<n&&o.clone().sub(a).cross(s).length()>n)&&s.clone().cross(l).length()>n&&u>0-n&&u<1+n&&p>0-n&&p<1+n&&a.clone().add(s.clone().multiplyScalar(u))}(e,t,n[i],n[(i+1)%3],r)));return a.filter((e=>e))},u=function(e,t,i,r){const n=e.clone().sub(r),a=n.dot(t),s=n.dot(i);return new THREE.Vector3(a,s,0)},p=function(e,t,i,r){const n=t.clone().multiplyScalar(e.x),a=i.clone().multiplyScalar(e.y);return n.clone().add(a).add(r)},m=function(e,t,i){let r=new THREE.Triangle;return r.a=e,r.b=t,r.c=i,r.getArea()},f=function(e,t){const i=t[0],r=t[1],n=t[2],a=r.clone().sub(i),s=e.clone().sub(i),o=n.clone().sub(r),l=e.clone().sub(r),d=i.clone().sub(n),h=e.clone().sub(n);return a.clone().cross(s).z>=0&&o.clone().cross(l).z>=0&&d.clone().cross(h).z>=0},g=function(e,i,n){const a=e[0],s=e[1],o=e[2],l=s.clone().sub(a),d=o.clone().sub(a),g=s.clone().sub(o);let v=1e-7*Math.max(l.length(),g.length(),d.length());if(l.length()<v||g.length()<v||d.length()<v)return;v=1e-7*Math.min(l.length(),g.length(),d.length());const y=l.clone().cross(d).normalize(),M=l.clone().normalize(),E=y.clone().cross(M).normalize();let x=[].concat(t.points);const _=t.points.map((e=>{const i=function(e,t,i,r,n){!n&&(n=1e-8);let a=r.clone();for(;Math.abs(t.dot(a))<n;)a=a.clone().multiplyScalar(.99).add(t.clone().multiplyScalar(.01));const s=i.clone().sub(e).dot(a)/t.dot(a);return e.clone().add(t.clone().multiplyScalar(s))}(e,t.stretch,a,y,v);return u(i,M,E,a)}));let b=[u(a,M,E,a),u(s,M,E,a),u(o,M,E,a)],I=[];if(_.length<2)return;const T=_[0].clone().sub(_[_.length-1]).length()<v;if(T){if(2==_.length)return;_.pop(),x.pop();let e=_.length;for(;f(_[0],b)&&e--;)_.push(_.shift()),x.push(x.shift());f(_[0],b)?I=I.concat(_):(_.push(_[0].clone()),x.push(x[0].clone()))}let S,C,w="INITIAL";for(let e=0,t=_.length;e<t;e++)if("INITIAL"!=w||f(_[e],b))if("OUT"==w&&f(_[e],b)){w="IN",C=_[e];const t=c(S,C,b,v).filter((e=>{for(let t of b)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));if(I=I.concat(t),I.push(C),t.length>0)break;S=_[e]}else if("OUT"!=w||f(_[e],b))if("IN"!=w||f(_[e],b))if("IN"==w&&f(_[e],b)){C=_[e];const t=c(S,C,b,v);I=I.concat(t),I.push(C),S=_[e]}else;else{w="OUT",C=_[e];const t=c(S,C,b,v);I=I.concat(t),S=_[e]}else{C=_[e];const t=c(S,C,b,v).filter((e=>{for(let t of b)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));if(I=I.concat(t),t.length>0)break;S=_[e]}else w="OUT",S=_[e];I=I.filter((e=>{for(let t of b)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));const R=I.map((e=>{for(let t=0;t<3;t++){const i=b[(t+0)%3],r=b[(t+1)%3],n=new THREE.Vector3;(new THREE.Line3).set(i,r).closestPointToPoint(e,!1,n);if(e.distanceTo(n)<v)return i.clone().add(r).multiplyScalar(.5)}return b[0].clone().add(b[1].clone()).add(b[2].clone()).multiplyScalar(1/3)})),B=b.concat(R).map((e=>[e.x,e.y]));let A;try{A=r.Utils.delaunay(B)}catch(e){return}const P=b.concat(I).map((e=>p(e,M,E,a)));let L=[],O=[];P.forEach((e=>{const t=P[0],r=P[1],a=P[2],s=m(t,r,a),o=m(e,r,a)/s,l=m(e,a,t)/s,d=m(e,t,r)/s;i&&L.push(i[0].clone().multiplyScalar(o).add(i[1].clone().multiplyScalar(l)).add(i[2].clone().multiplyScalar(d))),n&&O.push(n[0].clone().multiplyScalar(o).add(n[1].clone().multiplyScalar(l)).add(n[2].clone().multiplyScalar(d)))}));for(let e=0,t=A.length;e<t;e+=3){const t=[0,1,2].map((t=>A[e+t])).map((e=>P[e])),i=t[1].clone().sub(t[0]),r=t[2].clone().sub(t[0]);i.clone().cross(r).dot(y)<0&&([A[e+1],A[e+2]]=[A[e+2],A[e+1]])}let D=[];for(let e=0,i=A.length;e<i&&3==A.length;e+=3){const i=[0,1,2].map((t=>A[e+t])).map((e=>new THREE.Vector3(B[e][0],B[e][1],0)));if(T){const n=function(e){return 1==t.stretch.x?new THREE.Vector2(e.y,e.z):1==t.stretch.y?new THREE.Vector2(e.x,e.z):1==t.stretch.z?new THREE.Vector2(e.x,e.y):void 0},s=x.map((e=>n(e))),o=[0,1,2].map((e=>i[e].clone().add(i[(e+1)%3]).multiplyScalar(.5))),l=i[0].clone().add(i[1]).add(i[2]).multiplyScalar(1/3);if(-1==i.concat(o).concat([l]).map((e=>{const t=r.Utils.pointInPolygon(n(p(e,M,E,a)),s);let i=!1;for(let t=0,r=_.length-1;t<r;t++)S=_[t],C=_[t+1],h(S,C,e,v)&&(i=!0);return t||i})).indexOf(!1)){D.push(e/3);continue}}else for(let r=0,n=_.length-1;r<n;r++){S=_[r],C=_[r+1];let n=i.map((e=>e.clone())).filter((e=>!h(S,C,e,v)));const s=new THREE.Plane;if(s.setFromNormalAndCoplanarPoint(x[r+1].clone().sub(x[r]).cross(t.stretch),x[r+1]),1==n.length){if(s.distanceToPoint(p(n[0],M,E,a))>0){D.push(e/3);break}}else if(0==n.length){D.push(e/3);break}}}let N=[];for(let e=0,t=B.length;e<t&&3==A.length;e++){const t=new THREE.Vector3(B[e][0],B[e][1],0);for(let i=0,r=_.length-1;i<r;i++)if(S=_[i],C=_[i+1],h(S,C,t,v)){N.push(e);break}}return{vertices:P,normal:L,uvs:O,indices:A,positive:D,onMultiline:N}},v=[],y=[];for(let e=0;e<d.indices.length;){const t=[0,1,2].map((t=>d.indices[e+t])),i=t.map((e=>new THREE.Vector3(d.vertices[3*e+0],d.vertices[3*e+1],d.vertices[3*e+2])));let r=!1,n=!1;t.forEach((e=>{[0,1,2].forEach((t=>{null==d.normal[3*e+t]&&(r=!0)})),[0,1].forEach((t=>{null==d.uvs[2*e+t]&&(n=!0)}))}));const a=r?void 0:t.map((e=>new THREE.Vector3(d.normal[3*e+0],d.normal[3*e+1],d.normal[3*e+2]))),s=n?void 0:t.map((e=>new THREE.Vector2(d.uvs[2*e+0],d.uvs[2*e+1]))),o=g(i,a,s),h=d.vertices.length/3,c=d.indices.length/3;if(o){for(let t=0;t<o.positive.length;t++)v.push(0==o.positive[t]?e/3:o.positive[t]-1+c);o.onMultiline.forEach((e=>{e<3&&(y[t[e]]=!0),e>=3&&(y[e-3+h]=!0)}))}if(o&&3!=o.vertices.length){for(let e=3;e<o.vertices.length;e++){const t=o.vertices[e],i=o.normal[e],a=o.uvs[e];d.vertices.push(t.x,t.y,t.z),!r&&d.normal.push(i.x,i.y,i.z),r&&d.normal.push(void 0,void 0,void 0),!n&&d.uvs.push(a.x,a.y),n&&d.uvs.push(void 0,void 0)}o.indices=o.indices.map((t=>t<3?d.indices[e+t]:t-3+h)),[0,1,2].forEach((t=>d.indices[e+t]=o.indices[t]));for(let e=3;e<o.indices.length;e++)d.indices.push(o.indices[e]);l=l.concat(Array.from({length:o.indices.length/3-1},((t,i)=>l[e/3])))}else e+=3}let M=[];({vertices:n,indices:a,normal:s,uvs:o}=d);let E=new THREE.Box3;for(let e=0,t=n.length;e<t;e+=3)E.expandByPoint(new THREE.Vector3(n[e+0],n[e+1],n[e+2]));E.expandByScalar(.01);const x=E.max.clone().sub(E.min),_=r.Utils.bestdim(n.length/3,x),b=new THREE.Vector3(x.x/_[0],x.y/_[1],x.z/_[2]);let I=function(e){return 73856093*Math.floor(e.x)^19349663*Math.floor(e.y)^83492791*Math.floor(e.z)},T={};for(let e=0,t=a.length;e<t;e+=3){[0,1,2].map((t=>a[e+t])).forEach((t=>{null==T[t]&&(T[t]=[]),T[t].push(e/3)}))}let S={};for(let e=0,t=n.length;e<t;e+=3){const t=new THREE.Vector3(n[e+0],n[e+1],n[e+2]),i=new THREE.Vector3(t.x/b.x,t.y/b.y,t.z/b.z),r=I(i);null==S[r]&&(S[r]=[]),S[r].push(e/3)}for(v=Array.from(new Set(v)),v.forEach((e=>M[e]=1));0!=v.length;){const e=v.shift();M[e]=1;const t=[0,1,2].map((t=>a[3*e+t])),i=t.map((e=>new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]))).map((e=>new THREE.Vector3(e.x/b.x,e.y/b.y,e.z/b.z)));let r=[];i.forEach((e=>r=r.concat(S[I(e)]))),r=Array.from(new Set(r));let s=[];r.forEach((e=>{e&&T[e]&&(s=s.concat(T[e]))})),s=Array.from(new Set(s));for(let e=0,i=s.length;e<i;e++){const i=s[e];if(M[i])continue;let r=!1;const o=[0,1,2].map((e=>a[3*i+e])),l=o.map((e=>new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]))),d=t.filter((e=>-1!=o.indexOf(e))),h=1e-5*Math.max(x.x,x.y,x.z),c=t.filter((e=>{const t=new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]);for(let e of l)if(Math.abs(e.clone().sub(t).length()-0)<h)return!0}));d.concat(c).forEach((e=>r=r||!y[e])),r&&(M[i]=1,v.push(i))}}let C=function(e,t){let i={},r=[],a=[],l=[],d=!1,h=!1;[...new Set(e)].forEach((e=>{let c=new THREE.Vector3(n[3*e],n[3*e+1],n[3*e+2]);c.applyMatrix4(t.clone().invert()),r.push(c.x,c.y,c.z),[0,1,2].forEach((t=>{a.push(s[3*e+t]),isNaN(s[3*e+t])&&(d=!0)})),[0,1].forEach((t=>{l.push(o[2*e+t]),isNaN(o[2*e+t])&&(h=!0)})),i[e]=r.length/3-1}));let c=new THREE.BufferGeometry;const u=e.map((e=>i[e]));return c.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),!d&&c.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),!h&&c.setAttribute("uv",new THREE.Float32BufferAttribute(l,2)),c.setIndex(new THREE.Uint32BufferAttribute(u,1)),{geometry:c,nodeInfoMatrix:t}},w=[];for(let t=0,i=e.length;t<i;t++){let i=e[t].object._modelMatrix||new THREE.Matrix4;i=i.clone().invert();let r=e[t].object.matrix.clone().premultiply(i),n=[],s=[];for(let e=0;e<a.length;e+=3)l[e/3]==t&&(M[e/3]&&n.push(a[e+0],a[e+1],a[e+2]),!M[e/3]&&s.push(a[e+0],a[e+1],a[e+2]));w.push([C(n,r),C(s,r)])}return w},getGeometrySplitByFinitePlane:function(e,t){let i=function(e,i){if(0==e.clone().sub(i).length())return-1;if(0==e.clone().sub(i).dot(t.normal))return-1;const r=-e.clone().sub(t.center).dot(t.normal)/i.clone().sub(e).dot(t.normal),n=e.clone().add(i.clone().sub(e).multiplyScalar(r)).clone().sub(t.center);return Math.abs(n.clone().dot(t.x))>t.x.length()*t.x.length()||Math.abs(n.clone().dot(t.y))>t.y.length()*t.y.length()?-1:r},n=function(e,i){const r=new THREE.Plane;r.setFromNormalAndCoplanarPoint(t.normal,t.center);const n=r.distanceToPoint(e);if(Math.abs(n)>i)return!1;const a=e.clone().sub(t.center);return!(Math.abs(a.clone().dot(t.x))>t.x.length()*t.x.length())&&!(Math.abs(a.clone().dot(t.y))>t.y.length()*t.y.length())},a=function(e,t,i,r){let n=function(e,n){const a=Array.from(Array(n),((e,t)=>t)),s=a.map((i=>e[n*t+i])),o=a.map((t=>e[n*i+t]));if(new Set(s.concat(o)).has(void 0))a.forEach((t=>e.push(void 0)));else{a.map((e=>s[e]+r*(o[e]-s[e]))).forEach((t=>e.push(t)))}};n(e.vertices,3),n(e.normal,3),n(e.uvs,2)},s=0,o=[],l=[],d=[],h=[],c=[];for(let t=0,i=e.length;t<i;t++){const i=e[t].object.matrix.clone(),r=e[t].object._modelMatrix||new THREE.Matrix4;i.premultiply(r.clone().invert());let n=e[t].object.geometry;if("BufferGeometry"!=e[t].object.geometry.type){let e=new THREE.BufferGeometry;e.fromGeometry(n),n=e}let a=Array.from(n.attributes.position.array),u=Array.from(n.index.array),p=null==n.attributes.normal?void 0:Array.from(n.attributes.normal.array),m=null==n.attributes.uv?void 0:Array.from(n.attributes.uv.array);for(let e=0,t=a.length;e<t;e+=3){const t=[0,1,2].map((t=>a[e+t]));let r=new THREE.Vector3(t[0],t[1],t[2]);r.applyMatrix4(i),a[e+0]=r.x,a[e+1]=r.y,a[e+2]=r.z}if(o=o.concat(a),u=u.map((e=>e+s)),l=l.concat(u),c=c.concat(Array.from({length:u.length/3},((e,i)=>t))),p)for(let e=0,t=p.length;e<t;e+=3){const t=[0,1,2].map((t=>p[e+t]));let r=new THREE.Vector4(t[0],t[1],t[2],1);r.applyMatrix4(i.clone().invert().transpose()),p[e+0]=r.x,p[e+1]=r.y,p[e+2]=r.z}d=d.concat(p||Array.from({length:a.length},((e,t)=>{}))),h=h.concat(m||Array.from({length:2*a.length/3},((e,t)=>{}))),s+=a.length/3}let u={vertices:o,indices:l,normal:d,uvs:h};const p=new THREE.Plane;p.setFromNormalAndCoplanarPoint(t.normal,t.center);let m=[],f=[];for(let e=0,t=l.length;e<t;e+=3){const t=l[e+0],r=l[e+1],n=l[e+2],s=new THREE.Vector3(o[3*t+0],o[3*t+1],o[3*t+2]),d=new THREE.Vector3(o[3*r+0],o[3*r+1],o[3*r+2]),h=new THREE.Vector3(o[3*n+0],o[3*n+1],o[3*n+2]),m=i(s,d),g=i(d,h),v=i(h,s);if(m>0&&m<1&&g>0&&g<1){a(u,t,r,m),a(u,r,n,g);const i=u.vertices.length/3-2;u.indices[e+0]=i+0,u.indices[e+2]=i+1,u.indices.push(t,i+0,i+1,t,i+1,n),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(d)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(m>0&&m<1&&v>0&&v<1){a(u,t,r,m),a(u,n,t,v);const i=u.vertices.length/3-2;u.indices[e+1]=i+0,u.indices[e+2]=i+1,u.indices.push(i+0,r,n,i+1,i+0,n),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(g>0&&g<1&&v>0&&v<1){a(u,r,n,g),a(u,n,t,v);const i=u.vertices.length/3-2;u.indices[e+0]=i+1,u.indices[e+1]=i+0,u.indices.push(t,r,i+1,i+1,r,i+0),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(h)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(0==m&&1==v&&g>0&&g<1){a(u,r,n,g);const i=u.vertices.length/3-1;u.indices[e+2]=i,u.indices.push(t,i,n),c.push(c[e/3]);if(p.distanceToPoint(d)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}else if(1==m&&0==g&&v>0&&v<1){a(u,n,t,v);const i=u.vertices.length/3-1;u.indices[e+2]=i,u.indices.push(i,r,n),c.push(c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}else if(1==g&&0==v&&m>0&&m<1){a(u,t,r,m);const i=u.vertices.length/3-1;u.indices[e+1]=i,u.indices.push(i,r,n),c.push(c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}}({vertices:o,indices:l,normal:d,uvs:h}=u);let g=new THREE.Box3;for(let e=0,t=o.length;e<t;e+=3)g.expandByPoint(new THREE.Vector3(o[e+0],o[e+1],o[e+2]));g.expandByScalar(.01);const v=g.max.clone().sub(g.min),y=r.Utils.bestdim(o.length/3,v),M=new THREE.Vector3(v.x/y[0],v.y/y[1],v.z/y[2]);let E=function(e){return 73856093*Math.floor(e.x)^19349663*Math.floor(e.y)^83492791*Math.floor(e.z)},x={};for(let e=0,t=l.length;e<t;e+=3){[0,1,2].map((t=>l[e+t])).forEach((t=>{!x[t]&&(x[t]=[]),x[t].push(e/3)}))}let _={};for(let e=0,t=o.length;e<t;e+=3){const t=new THREE.Vector3(o[e+0],o[e+1],o[e+2]),i=new THREE.Vector3(t.x/M.x,t.y/M.y,t.z/M.z),r=E(i);!_[r]&&(_[r]=[]),_[r].push(e/3)}for(;0!=f.length;){const e=f.shift();m[e]=1;const t=[0,1,2].map((t=>l[e+t])),i=t.map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),r=i.map((e=>new THREE.Vector3(e.x/M.x,e.y/M.y,e.z/M.z)));let a=[];r.forEach((e=>a=a.concat(_[E(e)]))),a=Array.from(new Set(a));let s=[];a.forEach((function(e){null!=e&&null!=x[e]&&(s=s.concat(x[e]))})),s=Array.from(new Set(s));for(let e=0,r=s.length;e<r;e++){const r=3*s[e];if(null!=m[r])continue;let a=!1;const d=[0,1,2].map((e=>l[r+e])),h=d.map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),c=t.filter((e=>-1!=d.indexOf(e))).map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),u=1e-6*Math.max(v.x,v.y,v.z),p=i.filter((e=>{for(let t of h)if(Math.abs(t.clone().sub(e).length()-0)<u)return!0}));c.concat(p).forEach((e=>a=a||!n(e,u))),a&&(m[r+0]=1,f.push(r))}}let b=function(e,t){let i={},r=[],n=[],a=[],s=!1,l=!1;[...new Set(e)].forEach((e=>{let c=new THREE.Vector3(o[3*e],o[3*e+1],o[3*e+2]);c.applyMatrix4(t.clone().invert()),r.push(c.x,c.y,c.z),[0,1,2].forEach((t=>{n.push(d[3*e+t]),isNaN(d[3*e+t])&&(s=!0)})),[0,1].forEach((t=>{a.push(h[2*e+t]),isNaN(h[2*e+t])&&(l=!0)})),i[e]=r.length/3-1}));let c=new THREE.BufferGeometry;const u=e.map((e=>i[e]));return c.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),!s&&c.setAttribute("normal",new THREE.Float32BufferAttribute(n,3)),!l&&c.setAttribute("uv",new THREE.Float32BufferAttribute(a,2)),c.setIndex(new THREE.Uint32BufferAttribute(u,1)),{geometry:c,nodeInfoMatrix:t}},I=[];for(let t=0,i=e.length;t<i;t++){let i=e[t].object._modelMatrix||new THREE.Matrix4;i=i.clone().invert();let r=e[t].object.matrix.clone().premultiply(i),n=[],a=[];for(let e=0;e<l.length;e+=3)c[e/3]==t&&(m[e]&&n.push(l[e+0],l[e+1],l[e+2]),!m[e]&&a.push(l[e+0],l[e+1],l[e+2]));I.push([b(n,r),b(a,r)])}return I},intersectBox:function(e,t){for(var i=new THREE.Vector3,r=new THREE.Vector3,n=0,a=e.planes,s=0;s<6;s++){var o=a[s];i.x=o.normal.x>0?t.min.x:t.max.x,r.x=o.normal.x>0?t.max.x:t.min.x,i.y=o.normal.y>0?t.min.y:t.max.y,r.y=o.normal.y>0?t.max.y:t.min.y,i.z=o.normal.z>0?t.min.z:t.max.z,r.z=o.normal.z>0?t.max.z:t.min.z;var l=o.distanceToPoint(i),d=o.distanceToPoint(r);if(l<0&&d<0)return!1;l*d>=0&&++n}return 6===n?"in":"intersect"},satForAxes:function(e,t,i,r,n){var a,s;for(a=0,s=e.length-3;a<=s;a+=3){var o=new THREE.Vector3(e[a],e[a+1],e[a+2]),l=n.x*Math.abs(o.x)+n.y*Math.abs(o.y)+n.z*Math.abs(o.z),d=t.dot(o),h=i.dot(o),c=r.dot(o);if(Math.max(-Math.max(d,h,c),Math.min(d,h,c))>l)return!1}return!0},boxIntersectsTriangle:function(e,t){var i=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3;h.copy(e.getCenter(n)),c=e.max.clone().sub(h),i=t.a.clone().sub(h),a=t.b.clone().sub(h),s=t.c.clone().sub(h),o=a.clone().sub(i),l=s.clone().sub(a),d=i.clone().sub(s);var p=[0,-o.z,o.y,0,-l.z,l.y,0,-d.z,d.y,o.z,0,-o.x,l.z,0,-l.x,d.z,0,-d.x,-o.y,o.x,0,-l.y,l.x,0,-d.y,d.x,0];return!!r.GeomUtil.satForAxes(p,i,a,s,c)&&(p=[1,0,0,0,1,0,0,0,1],!!r.GeomUtil.satForAxes(p,i,a,s,c)&&(p=[(u=o.clone().cross(l)).x,u.y,u.z],r.GeomUtil.satForAxes(p,i,a,s,c)))},geometryVolume(e,t){const i=f(e);if(!r.Utils.isDefined(f))return{volume:null,boundingBox:null,unit:unit};const a=i.position,s=i.index,o=i.normal;if(!this.isGeometryClosed(s))return console.log("object is not closed"),0;const l=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3;let y=0;for(let e=0;e<s.length;e+=3){const t=3*s[e],i=3*s[e+1],n=3*s[e+2];l.set(a[t],a[t+1],a[t+2]),u.set(a[i],a[i+1],a[i+2]),p.set(a[n],a[n+1],a[n+2]),m.set(o[t],o[t+1],o[t+2]),g.set(o[i],o[i+1],o[i+2]),v.set(o[n],o[n+1],o[n+2]);const f=[l,u,p],M=d(f),E=h(f),x=this.triangleArea(M);if(x<r.Math.EPSILON12)continue;const _=x*E.topPoints[0].z,{maxIndex:b}=E,I=[...E.topPoints];I.splice(b,1);const T=[...f];T.splice(b,1),I.push(T[0]),I.push(f[b]),T.push(I[1]),T.push(f[b]);let S=this.mitsubishiConeVolume(I);S+=this.mitsubishiConeVolume(T),S=_-S,S=c([m,g,v])?S:-S,y+=S}const M=i.boundingBox;return y=function(e,t){const i=t.getSize(n);return e>i.x*i.y*i.z||e<r.Math.EPSILON4?null:e}(y,M),{volume:y,boundingBox:M}},isGeometryClosed(e){const t={};return e.forEach(((i,n)=>{let a=(n+1)%3==0?n-2:n+1;a=e[a];const s=i>a?`${i}_${a}`:`${a}_${i}`;let o=t[s];r.Utils.isDefined(o)?o&&(t[s]=!1):t[s]=!0})),!0},triangleArea:i=>!!Array.isArray(i)&&(3===i.length&&(e.subVectors(i[1],i[0]),t.subVectors(i[2],i[0]),n.crossVectors(e,t),n.length()/2)),mitsubishiConeVolume(r){if(!Array.isArray(r))return!1;if(4!==r.length)return!1;return e.subVectors(r[1],r[0]),t.subVectors(r[2],r[0]),i.subVectors(r[3],r[0]),n.crossVectors(e,t),Math.abs(n.dot(i))/6},applyMatrix4ToNormalBuffer(e,t){t&&(o.getNormalMatrix(e),r.GeomUtil.applyMatrix3ToBuffer(o,t),r.GeomUtil.normalizeBuffer(t))},swapGeometryIndex(e){let t;for(let i=0,r=e.length;i<r;i+=3)t=e[i+1],e[i+1]=e[i+2],e[i+2]=t},sliceGeometryBuffer(e,t){if(!t)return;let{position:i,index:r,normal:n,uv:a}=e;r=r.slice(t.indexStart,t.indexStart+t.indexCount),i=i.slice(t.positionStart,t.positionStart+t.positionCount),n=n?n.slice(t.positionStart,t.positionStart+t.positionCount):null,a=a&&t.uvCount?a.slice(t.uvStart,t.uvStart+t.uvCount):null;const s=t.positionStart/3;r.forEach((function(e,t,i){i[t]-=s})),e.index=r,e.position=i,e.normal=n,e.uv=a},getGeometryBuffer(e,t,i,n,a){if(!e||!e.buffer)return null;let s=null,o=null,l=null,d=null;e.isDataView?(o=Uint32Array.from(e.buffer.I),s=Float32Array.from(e.buffer.P),l=Float32Array.from(e.buffer.N),d=e.buffer.UV&&e.buffer.UV.length?Float32Array.from(e.buffer.UV):null):(o=new Uint32Array(e.buffer.I),s=new Float32Array(e.buffer.P),l=new Float32Array(e.buffer.N),d=e.buffer.UV&&e.buffer.UV.byteLength?new Float32Array(e.buffer.UV):null);const h={index:o,position:s,normal:l,uv:d};return e.indexInfo&&r.GeomUtil.sliceGeometryBuffer(h,e.indexInfo),i&&r.GeomUtil.swapGeometryIndex(h.index),(n=r.Utils.defaultValue(n,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,h.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,h.normal)),h},getLineGeometryBuffer(e,t,i,n,a){if(!e||!e.buffer)return null;let s=e.isDataView?Float32Array.from(e.buffer.P):new Float32Array(e.buffer.P);const o={index:e.isDataView?Uint32Array.from(e.buffer.I):new Uint32Array(e.buffer.I),position:s,normal:null,uv:null};return e.indexInfo&&r.GeomUtil.sliceGeometryBuffer(o,e.indexInfo),(n=r.Utils.defaultValue(n,!0))&&r.GeomUtil.applyMatrix4ToBuffer(t,o.position),o},getPipeGeometryBuffer(e,t,i){const n=r.GeomUtil.UnitCylinderInstance;let a=Float32Array.from(n.attributes.position.array);const s={index:Uint32Array.from(n.index.array),position:a,normal:Float32Array.from(n.attributes.normal.array),uv:null};return t&&r.GeomUtil.swapGeometryIndex(s.index),(i=r.Utils.defaultValue(i,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(e,s.position),r.GeomUtil.applyMatrix4ToNormalBuffer(e,s.normal)),s},getPipeMGeometryBuffer(e,t,i,n){let a=r.GeomUtil.getPipeMBuffer(e),s=Float32Array.from(a.vertex);const o={index:Uint32Array.from(a.index),position:s,normal:Float32Array.from(a.normal),uv:a.uv?Float32Array.from(a.uv):null};return i&&r.GeomUtil.swapGeometryIndex(o.index),(n=r.Utils.defaultValue(n,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,o.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,o.normal)),o},getBoxMGeometryBuffer(e,t,i,n){let a=r.GeomUtil.getBoxMBuffer(e),s=Float32Array.from(a.vertex);const o={index:Uint32Array.from(a.index),position:s,normal:Float32Array.from(a.normal),uv:a.uv?Float32Array.from(a.uv):null};return i&&r.GeomUtil.swapGeometryIndex(o.index),(n=r.Utils.defaultValue(n,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,o.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,o.normal)),o},getBufferGeometry(e,t){if(!e)return null;const i=new THREE.BufferGeometry;let n;return t?(n=Uint32Array.from(e.I),r.GeomUtil.swapGeometryIndex(n)):n=e.I,i.setIndex(new THREE.BufferAttribute(n,1)),i.setAttribute("position",new THREE.BufferAttribute(e.P,3)),e.N?i.setAttribute("normal",new THREE.BufferAttribute(e.N,3)):i.computeVertexNormals(),e.UV&&i.setAttribute("uv",new THREE.BufferAttribute(e.UV,2)),i},getLineBufferGeometry(e,t){if(!e)return null;const i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(e.I,1)),i.setAttribute("position",new THREE.BufferAttribute(e.P,3)),i},getPipeBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapPipe():r.GeomUtil.UnitCylinderInstance;return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getPipeMBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapPipeM():r.GeomUtil.getUnitTextureCylinder();return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getBoxBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapBox():r.GeomUtil.UnitBoxInstance;return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getBoxMBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapBoxM():r.GeomUtil.getUnitTextureBox();return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},copyGeometryIndexOnly(e,t){if(Array.isArray(e)){let i=[];return e.forEach((e=>{const n=new THREE.BufferGeometry,a=Uint32Array.from(e.getIndex().array);t&&r.GeomUtil.swapGeometryIndex(a),n.setIndex(new THREE.BufferAttribute(a,1)),n.setAttribute("position",e.getAttribute("position"));const s=e.getAttribute("normal");s?n.setAttribute("normal",s):n.computeVertexNormals();const o=e.getAttribute("uv");o&&n.setAttribute("uv",o),i.push(n)})),i}let i=new THREE.BufferGeometry;const n=Uint32Array.from(e.getIndex().array);t&&r.GeomUtil.swapGeometryIndex(n),i.setIndex(new THREE.BufferAttribute(n,1)),i.setAttribute("position",e.getAttribute("position"));const a=e.getAttribute("normal");a?i.setAttribute("normal",a):i.computeVertexNormals();const s=e.getAttribute("uv");return s&&i.setAttribute("uv",s),i}},r.GeomUtil.getBoxMBuffer=function(){for(var e,t,i=[],n=[],a=[],s=0,o=0;o<6;++o){var l=r.GeomUtil.getBoxData(o);for(e=0,t=l.vertex.length;e<t;e++)i.push(l.vertex[e]);for(e=0,t=l.index.length;e<t;e++)a.push(l.index[e]+s);for(s+=l.vertex.length/3,e=0,t=l.normal.length;e<t;e++)n.push(l.normal[e])}return function(e){var t=null;if(e){var s=new THREE.Matrix3,o=new THREE.Vector3;t=[];for(var l=0;l<6;++l){var d=r.GeomUtil.getBoxData(l);s.set(e[6*l],e[6*l+2],e[6*l+4],e[6*l+1],e[6*l+3],e[6*l+5],0,0,1);for(var h=0,c=d.uv.length;h<c;h+=2)o.set(d.uv[h],d.uv[h+1],1),o.applyMatrix3(s),t.push(o.x),t.push(o.y)}}return{vertex:i,normal:n,uv:t,index:a}}}(),r.GeomUtil.getPipeMBuffer=function(){var e=r.GeomUtil.getPipeData(32),t=e.edges,i=e.vertex,n=e.normal,a=e.index;return function(e){var s=null;if(!(!e||18!==e.length)){s=[];for(var o=[],l=0,d=e.length/6;l<d;l++){var h=new THREE.Matrix3;h.set(e[6*l],e[6*l+2],e[6*l+4],e[6*l+1],e[6*l+3],e[6*l+5],0,0,1),o.push(h)}for(var c=r.GeomUtil.getPipeData(32),u=4*(t+1),p=u+2*t,m=new THREE.Vector3,f=0,g=c.uv.length;f<g;f+=2)m.set(c.uv[f],c.uv[f+1],1),f<u?m.applyMatrix3(o[0]):f<p?m.applyMatrix3(o[1]):m.applyMatrix3(o[2]),s.push(m.x),s.push(m.y)}return{vertex:i,normal:n,uv:s,index:a}}}(),r.GeomUtil.isVector3Equal=function(e,t,i){return void 0===i?t.x===e.x&&t.y===e.y&&t.z===e.z:Math.abs(t.x-e.x)<i&&Math.abs(t.y-e.y)<i&&Math.abs(t.z-e.z)<i},r.GeomUtil.getMatrixFromGeometry=function(e,t){e.boundingBox||e.computeBoundingBox(),e.boundingBox.getCenter(n);let i=null,r=e.attributes.position.array;if(!(n.x>16777216||n.x<-16777216||n.y>16777216||n.y<-16777216||n.z>16777216||n.z<-16777216)){if(r instanceof Float64Array){const t=new Float32Array(r);e.setAttribute("position",new THREE.BufferAttribute(t,3))}return}i=(new THREE.Matrix4).setPosition(n.x,n.y,n.z);const a=r.length;for(let e=0;e<a;e+=3)r[e]=r[e]-n.x,r[e+1]=r[e+1]-n.y,r[e+2]=r[e+2]-n.z;if(r instanceof Float64Array){const t=new Float32Array(r);e.setAttribute("position",new THREE.BufferAttribute(t,3))}return i},r.GeomUtil.getMatrixFromInstancedBufferAttribute=function(e){if(e.array instanceof Float32Array)return e.originMatrix;const t=e.array;e.array=new Float32Array(t)},r.GeomUtil.getPositionArrayFromFloat64=function(e){let t=new THREE.Box3;const i=e.length;for(let r=0;r<i;r+=3)t.expandByPoint({x:e[r],y:e[r+1],z:e[r+2]});return t.getCenter(n),n.x>16777216||n.x<-16777216||n.y>16777216||n.y<-16777216||n.z>16777216||n.z<-16777216?e:new Float32Array(e)},r.GeomUtil.boxIntersectsPlaneWithMatrix=function(e,t,i){const r=t.clone();return r.applyMatrix4(i),r.intersectsPlane(e)},r.GeomUtil.applyMatrix4ToList=function(e,t){let i=[];for(let r=0,n=e.length;r<n;r+=3){let n=new THREE.Vector3(e[r],e[r+1],e[r+2]);n.applyMatrix4(t),i.push(n.x,n.y,n.z)}return i},r.GeomUtil.computeBoundingBoxPositions=function(e){var t=e.max.x-e.min.x,i=e.max.y-e.min.y,r=e.max.z-e.min.z,n=e.min.x,a=e.min.y,s=e.min.z,o={x:n,y:a,z:s+r},l={x:n+t,y:a,z:s+r},d={x:n,y:a+i,z:s+r},h={x:n+t,y:a+i,z:s+r},c={x:n,y:a,z:s},u={x:n+t,y:a,z:s},p={x:n,y:a+i,z:s},m={x:n+t,y:a+i,z:s};return new Float32Array([o.x,o.y,o.z,l.x,l.y,l.z,d.x,d.y,d.z,d.x,d.y,d.z,l.x,l.y,l.z,h.x,h.y,h.z,l.x,l.y,l.z,u.x,u.y,u.z,h.x,h.y,h.z,h.x,h.y,h.z,u.x,u.y,u.z,m.x,m.y,m.z,l.x,u.y,u.z,c.x,c.y,c.z,m.x,m.y,m.z,m.x,m.y,m.z,c.x,c.y,c.z,p.x,p.y,p.z,c.x,c.y,c.z,o.x,o.y,o.z,p.x,p.y,p.z,p.x,p.y,p.z,o.x,o.y,o.z,d.x,d.y,d.z,d.x,d.y,d.z,h.x,h.y,h.z,p.x,p.y,p.z,p.x,p.y,p.z,h.x,h.y,h.z,m.x,m.y,m.z,c.x,c.y,c.z,u.x,u.y,u.z,o.x,o.y,o.z,o.x,o.y,o.z,u.x,u.y,u.z,l.x,l.y,l.z])},r.GeomUtil.expandBufferGeometryWithUV2=function(e){const t=e.index.array,i=e.attributes,r=t.length,n=i.position.array,a=[],s=i.id.array,o=[],l=i.vState.array,d=[],h=i.pointColorState.array,c=[];let u,p,m,f;i.barycentric&&(u=[]),i.cNormal&&(p=[]),i.uv&&(m=[]),i.uv3&&(f=[]);const g=i.uv2.array;let v=[],y=0;for(let e=0;e<r;++e){const r=t[e];a.push(n[3*r]),a.push(n[3*r+1]),a.push(n[3*r+2]),o.push(s[4*r]),o.push(s[4*r+1]),o.push(s[4*r+2]),o.push(s[4*r+3]),d.push(l[4*r]),d.push(l[4*r+1]),d.push(l[4*r+2]),d.push(l[4*r+3]),c.push(h[4*r]),c.push(h[4*r+1]),c.push(h[4*r+2]),c.push(h[4*r+3]),v.push(g[2*e]),v.push(g[2*e+1]),u&&(u.push(i.barycentric.array[3*r]),u.push(i.barycentric.array[3*r+1]),u.push(i.barycentric.array[3*r+2])),p&&(p.push(i.cNormal.array[2*r]),p.push(i.cNormal.array[2*r+1])),m&&(m.push(i.uv.array[2*r]),m.push(i.uv.array[2*r+1])),f&&(f.push(i.uv3.array[2*r]),f.push(i.uv3.array[2*r+1])),t[e]=y,y++}e.setAttribute("position",new THREE.Float32BufferAttribute(a,3));const M=new THREE.Uint8BufferAttribute(o,4);M.normalized=!0,e.setAttribute("id",M);const E=new THREE.Float32BufferAttribute(d,4);E.normalized=!1,e.setAttribute("vState",E);const x=new THREE.Uint8BufferAttribute(c,4);x.normalized=!0,e.setAttribute("pointColorState",x);const _=new THREE.Float32BufferAttribute(v,2);_.normalized=!1,e.setAttribute("uv2",_),u&&e.setAttribute("barycentric",new THREE.Uint8BufferAttribute(u,3)),p&&e.setAttribute("cNormal",new THREE.Uint8BufferAttribute(p,2)),m&&e.setAttribute("uv",new THREE.Int16BufferAttribute(m,2)),f&&e.setAttribute("uv3",new THREE.Float32BufferAttribute(f,2)),e.setIndex(new THREE.BufferAttribute(t,1))};const u=new THREE.Vector3,p=new THREE.Quaternion,m=new THREE.Vector3;function f(e){const t=e.children;if(t.length<=0)return null;let i=[],a=[],o=[];const l=new THREE.Box3;let d=0;return t.forEach((e=>{e.matrix.decompose(u,p,m),u.set(0,0,0),s.compose(u,p,m);const t=e.geometry;if(l.union(r.GeomUtil.getBoundingBoxWorldOfMesh(e).applyMatrix4(e.matrix)),!r.Utils.isDefined(t.getAttribute("normal")))return;let h=t.getAttribute("normal").array;if(!r.Utils.isDefined(t.getAttribute("position")))return;let c,f=t.getAttribute("position").array;if(r.Utils.isDefined(t.getIndex()))c=t.getIndex().array,c=Array.from(c),c.forEach(((e,t)=>{c[t]=e+d}));else{c=[];for(let e=0;e<f.length/3;++e)c.push(e+d)}h=Array.from(h),a=a.concat(c),f=Array.from(f);for(let t=0;t<f.length;t+=3)n.set(f[t],f[t+1],f[t+2]),n.applyMatrix4(e.matrix),o.push(n.x),o.push(n.y),o.push(n.z),n.set(h[t],h[t+1],h[t+2]),n.applyMatrix4(s),n.normalize(),i.push(n.x),i.push(n.y),i.push(n.z);d=o.length/3})),{position:o,normal:i,index:a,boundingBox:l}}})(),r.Logger={log:function(){r.GlobalData.DEBUG&&console.log.apply(console,arguments)},debug:function(){r.GlobalData.DEBUG&&console.debug.apply(console,arguments)},warn:function(){r.GlobalData.DEBUG&&console.warn.apply(console,arguments)},error:function(){r.GlobalData.DEBUG&&console.error.apply(console,arguments)},time:function(){r.GlobalData.DEBUG&&console.time.apply(console,arguments)},timeEnd:function(){r.GlobalData.DEBUG&&console.timeEnd.apply(console,arguments)}},function(){class e extends THREE.MeshPhongMaterial{constructor(e){super(e),this.isCloudMeshPhongMaterial=!0,this.type="CloudMeshPhongMaterial",this.growthAnimationPlanes=null,this.defines={},e&&e.growthAnimationPlanes&&(this.growthAnimationPlanes=e.growthAnimationPlanes),this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{growthAnimationPlanes:{value:this.growthAnimationPlanes}}]),this.vertexShader=THREE.ShaderLib.phong.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n          #include <clipping_planes_pars_vertex>\n          #include <growthAnimation_pars_vertex>\n          varying vec3 vViewPosition;\n        ").replace("#include <clipping_planes_vertex>","\n            #include <clipping_planes_vertex>\n            vViewPosition = - mvPosition.xyz;\n            #include <growthAnimation_vertex>\n          "),this.fragmentShader=THREE.ShaderLib.phong.fragmentShader.replace("#include <clipping_planes_pars_fragment>","\n          #include <clipping_planes_pars_fragment>\n          #include <growthAnimation_pars_fragment>\n          varying vec3 vViewPosition;\n        ").replace("#include <clipping_planes_fragment>","\n            #include <clipping_planes_fragment>\n            #include <growthAnimation_fragment>\n          ")}copy(e){return THREE.MeshPhongMaterial.prototype.copy.call(this,e),this.growthAnimationPlanes=e.growthAnimationPlanes,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.growthAnimationPlanes.value=this.growthAnimationPlanes}}r.CloudMeshPhongMaterial=e}(),function(){const e=new WeakMap;class t extends THREE.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null,this.detectedSupport=!1}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this.detectedSupport=!0,this}supportsImageBitmap(e){return"function"==typeof e.arrayBuffer}loadFromBlob(t,i,r,n){var a=new THREE.CompressedTexture;i.arrayBuffer().then((t=>{if(e.has(t))return e.get(t).promise.then(r).catch(n);this._createTexture([t]).then((function(e){a.copy(e),a.needsUpdate=!0,r&&r(a)})).catch(n)}))}loadFromBuffer(t,i,r){const n=new THREE.CompressedTexture;if(e.has(t)){return e.get(t).promise.then(i).catch(r)}return this._createTexture([t]).then((function(e){n.copy(e),n.needsUpdate=!0,i&&i(n)})).catch(r)}load(t,i,r,n){const a=new THREE.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setWithCredentials(this.withCredentials);const s=new THREE.CompressedTexture;return a.load(t,(t=>{if(e.has(t)){return e.get(t).promise.then(i).catch(n)}this._createTexture([t]).then((function(e){s.copy(e),s.needsUpdate=!0,i&&i(s)})).catch(n)}),r,n),s}parseInternalAsync(t){const{levels:i}=t,r=new Set;for(let e=0;e<i.length;e++)r.add(i[e].data.buffer);let n=Array.from(r);return e.has(n[0])?e.get(n[0]).promise:this._createTexture(Array.from(r),{...t,lowLevel:!0})}_createTexture(t,i={}){let r,n;const a=i;let s=0;for(let e=0;e<t.length;e++)s+=t[e].byteLength;const o=this._allocateWorker(s).then((e=>(r=e,n=this.workerNextTaskID++,new Promise(((e,i)=>{r._callbacks[n]={resolve:e,reject:i},r.postMessage({type:"transcode",id:n,buffers:t,taskConfig:a},t)}))))).then((e=>{const{mipmaps:t,width:i,height:r,format:n}=e,a=new THREE.CompressedTexture(t,i,r,n,THREE.UnsignedByteType);return a.minFilter=1===t.length?THREE.LinearFilter:THREE.LinearMipmapLinearFilter,a.magFilter=THREE.LinearFilter,a.generateMipmaps=!1,a.needsUpdate=!0,a}));return o.catch((()=>!0)).then((()=>{r&&n&&(r._taskLoad-=s,delete r._callbacks[n])})),e.set(t[0],{promise:o}),o}_initTranscoder(){if(!this.transcoderPending){const e=new THREE.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const i=new Promise(((t,i)=>{e.load("basis_transcoder.js",t,void 0,i)})),r=new THREE.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);const n=new Promise(((e,t)=>{r.load("basis_transcoder.wasm",e,void 0,t)}));this.transcoderPending=Promise.all([i,n]).then((([e,i])=>{const r=t.BasisWorker.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(t.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(t.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(t.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n])),this.transcoderBinary=i}))}return this.transcoderPending}_allocateWorker(e){return this._initTranscoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskLoad=0,e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),e.onmessage=function(t){const i=t.data;switch(i.type){case"transcode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t}))}dispose(){for(let e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}t.BasisFormat={ETC1S:0,UASTC_4x4:1},t.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},t.EngineFormat={RGBAFormat:THREE.RGBAFormat,RGBA_ASTC_4x4_Format:THREE.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:THREE.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:THREE.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:THREE.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:THREE.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:THREE.RGB_ETC1_Format,RGB_ETC2_Format:THREE.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:THREE.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:THREE.RGB_S3TC_DXT1_Format},t.BasisWorker=function(){let e,t,i;const r=_EngineFormat,n=_TranscoderFormat,a=_BasisFormat;onmessage=function(r){const n=r.data;switch(n.type){case"init":e=n.config,s=n.transcoderBinary,t=new Promise((e=>{i={wasmBinary:s,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis()}));break;case"transcode":t.then((()=>{try{const{width:e,height:t,hasAlpha:r,mipmaps:s,format:o}=n.taskConfig.lowLevel?function(e){const{basisFormat:t,width:r,height:n,hasAlpha:s}=e,{transcoderFormat:o,engineFormat:l}=d(t,r,n,s),m=i.getBytesPerBlockOrPixel(o);h(i.isFormatSupported(o),"THREE.BasisTextureLoader: Unsupported format.");const f=[];if(t===a.ETC1S){const t=new i.LowLevelETC1SImageTranscoder,{endpointCount:r,endpointsData:n,selectorCount:a,selectorsData:l,tablesData:d}=e.globalData;try{let i;i=t.decodePalettes(r,n,a,l),h(i,"THREE.BasisTextureLoader: decodePalettes() failed."),i=t.decodeTables(d),h(i,"THREE.BasisTextureLoader: decodeTables() failed.");for(let r=0;r<e.levels.length;r++){const n=e.levels[r],a=e.globalData.imageDescs[r],l=p(o,n.width,n.height),d=new Uint8Array(l);i=t.transcodeImage(o,d,l/m,n.data,c(o,n.width),u(o,n.height),n.width,n.height,n.index,a.rgbSliceByteOffset,a.rgbSliceByteLength,a.alphaSliceByteOffset,a.alphaSliceByteLength,a.imageFlags,s,!1,0,0),h(i,"THREE.BasisTextureLoader: transcodeImage() failed for level "+n.index+"."),f.push({data:d,width:n.width,height:n.height})}}finally{t.delete()}}else for(let t=0;t<e.levels.length;t++){const r=e.levels[t],n=p(o,r.width,r.height),a=new Uint8Array(n);h(i.transcodeUASTCImage(o,a,n/m,r.data,c(o,r.width),u(o,r.height),r.width,r.height,r.index,0,r.data.byteLength,0,s,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+r.index+"."),f.push({data:a,width:r.width,height:r.height})}return{width:r,height:n,hasAlpha:s,mipmaps:f,format:l}}(n.taskConfig):function(e){const t=new i.BasisFile(new Uint8Array(e)),r=t.isUASTC()?a.UASTC_4x4:a.ETC1S,n=t.getImageWidth(0,0),s=t.getImageHeight(0,0),o=t.getNumLevels(0),l=t.getHasAlpha();function h(){t.close(),t.delete()}const{transcoderFormat:c,engineFormat:u}=d(r,n,s,l);if(!n||!s||!o)throw h(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!t.startTranscoding())throw h(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");const p=[];for(let e=0;e<o;e++){const i=t.getImageWidth(0,e),r=t.getImageHeight(0,e),n=new Uint8Array(t.getImageTranscodedSizeInBytes(0,e,c));if(!t.transcodeImage(n,0,e,c,0,l)&&e!==o-1)throw h(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");p.push({data:n,width:i,height:r})}return h(),{width:n,height:s,hasAlpha:l,mipmaps:p,format:u}}(n.buffers[0]),l=[];for(let e=0;e<s.length;++e)l.push(s[e].data.buffer);self.postMessage({type:"transcode",id:n.id,width:e,height:t,hasAlpha:r,mipmaps:s,format:o},l)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}}))}var s};const s=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC1,n.BC3],engineFormat:[r.RGB_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC1],engineFormat:[r.RGB_ETC1_Format,r.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=s.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function d(t,i,s,d){let h,c;const u=t===a.ETC1S?o:l;for(let r=0;r<u.length;r++){const n=u[r];if(e[n.if]&&(n.basisFormat.includes(t)&&(!n.needsPowerOfTwo||m(i)&&m(s))))return h=n.transcoderFormat[d?1:0],c=n.engineFormat[d?1:0],{transcoderFormat:h,engineFormat:c}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),h=n.RGBA32,c=r.RGBAFormat,{transcoderFormat:h,engineFormat:c}}function h(e,t){if(!e)throw new Error(t)}function c(e,t){return Math.ceil(t/i.getFormatBlockWidth(e))}function u(e,t){return Math.ceil(t/i.getFormatBlockHeight(e))}function p(e,t,r){const a=i.getBytesPerBlockOrPixel(e);if(i.formatIsUncompressed(e))return t*r*a;if(e===n.PVRTC1_4_RGB||e===n.PVRTC1_4_RGBA){const e=t+3&-4,i=r+3&-4;return(Math.max(8,e)*Math.max(8,i)*4+7)/8}return c(e,t)*u(e,r)*a}function m(e){return e<=2||0==(e&e-1)&&0!==e}},THREE.BasisTextureLoader=t}(),function(){class e extends THREE.TextureLoader{constructor(e){super(e),this.options={imageOrientation:"none",premultiplyAlpha:"none",colorSpaceConversion:"none"}}setOptions(e){return this.options=e,this}supportsImageBitmap(){return"function"==typeof createImageBitmap}loadFromBlob(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,a=THREE.Cache.get(e);if(void 0!==a)return n.manager.itemStart(e),setTimeout((()=>{i&&i(a),n.manager.itemEnd(e)}),0),a;Promise.resolve().then((()=>createImageBitmap(t,n.options))).then((t=>{const r=new THREE.CanvasTexture(t);THREE.Cache.add(e,r),i&&i(r),n.manager.itemEnd(e)})).catch((t=>{r&&r(t),n.manager.itemError(e),n.manager.itemEnd(e)})),n.manager.itemStart(e)}}r.TextureLoader=e}();var s=166,o={RGB:0,RRR:3,GGG:4,AAA:15},l={RGB:0,RGBA:3,RRR:4,RRRG:5},d=2,h=2;class c extends THREE.CompressedTextureLoader{constructor(e){super(e),this.basisLoader=new THREE.BasisTextureLoader(e),this.zstd=new ZSTDDecoder,this.zstd.init(),"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.basisLoader.setTranscoderPath(e),this}setWorkerLimit(e){return this.basisLoader.setWorkerLimit(e),this}detectSupport(e){return this.basisLoader.detectSupport(e),this}dispose(){return this.basisLoader.dispose(),this}load(e,t,i,r){var n=this,a=new THREE.CompressedTexture;return new Promise((function(t,r){new THREE.FileLoader(n.manager).setPath(n.path).setResponseType("arraybuffer").load(e,t,i,r)})).then((function(e){n.parse(e,(function(e){a.copy(e),a.needsUpdate=!0,t&&t(a)}),r)})).catch(r),a}parse(e,t,i){var r=this,n=readKTX(new Uint8Array(e));if(n.pixelDepth>0)throw new Error("THREE.KTX2Loader: Only 2D textures are currently supported.");if(n.layerCount>1)throw new Error("THREE.KTX2Loader: Array textures are not currently supported.");if(n.faceCount>1)throw new Error("THREE.KTX2Loader: Cube textures are not currently supported.");var a=T.getBasicDFD(n);return T.createLevels(n,this.zstd).then((function(e){var t=a.colorModel===s?THREE.BasisTextureLoader.BasisFormat.UASTC_4x4:THREE.BasisTextureLoader.BasisFormat.ETC1S,i={levels:e,width:n.pixelWidth,height:n.pixelHeight,basisFormat:t,hasAlpha:T.getAlpha(n)};return t===THREE.BasisTextureLoader.BasisFormat.ETC1S&&(i.globalData=n.globalData),r.basisLoader.parseInternalAsync(i)})).then((function(e){e.encoding=a.transferFunction===h?THREE.sRGBEncoding:THREE.LinearEncoding,e.premultiplyAlpha=T.getPremultiplyAlpha(n),t(e)})).catch(i),this}}THREE.KTX2Loader=c;var u,p,m,f,g,v,y,M,E,x,_,b,I,T={createLevels:async function(e,t){e.supercompressionScheme===d&&await t.init();for(var i=[],r=e.pixelWidth,n=e.pixelHeight,a=0;a<e.levels.length;a++){var s=Math.max(1,Math.floor(r/Math.pow(2,a))),o=Math.max(1,Math.floor(n/Math.pow(2,a))),l=e.levels[a].levelData;e.supercompressionScheme===d&&(l=t.decode(l,e.levels[a].uncompressedByteLength)),i.push({index:a,width:s,height:o,data:l})}return i},getBasicDFD:function(e){return e.dataFormatDescriptor[0]},getAlpha:function(e){var t=this.getBasicDFD(e);return t.colorModel===s?(15&t.samples[0].channelID)===l.RGBA:2===t.samples.length&&(15&t.samples[1].channelID)===o.AAA},getPremultiplyAlpha:function(e){return!!(1&this.getBasicDFD(e).flags)}};(()=>{let e=null,t=null,i=null,n=null,a=null,s=null,o=null,l=null,d=null,h=null;class c{constructor(){}}c.DefaultMaterial=new THREE.MeshPhongMaterial({color:255,side:THREE.DoubleSide}),c.DefaultCloudMaterial=new r.CloudMeshPhongMaterial({color:255,side:THREE.DoubleSide}),c.DefaultWireframeColor={color:new THREE.Color(0,0,0),opacity:.4},c.SetDefaultWireframeColor=e=>{c.DefaultWireframeColor.color.setRGB(e.red/255,e.green/255,e.blue/255),c.DefaultWireframeColor.opacity=e.alpha},c.getBasisLibUrl=()=>(l||(l=window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?window.BimfaceLoaderConfig.fullStaticHost+"/lib/basis/":"../../lib/basis/"),l),c.getBasisTextureLoader=()=>(d||(d=new THREE.BasisTextureLoader,d.setTranscoderPath(r.MaterialUtil.getBasisLibUrl())),d),c.getKTX2TextureLoader=()=>(h||(h=new THREE.KTX2Loader,h.setTranscoderPath(r.MaterialUtil.getBasisLibUrl())),h),c.getDefaultStandardMaterial=()=>(e||(e=new r.CloudStandardMaterial({color:13024187,side:THREE.DoubleSide})),e),c.disposeDefaultStandardMaterial=()=>{e&&(e.dispose(),e=null)},c.getDefaultInstanceMaterial=()=>(t||(t=new r.CloudStandardMaterial({color:13024187,side:THREE.DoubleSide}),t.forInstance=!0,t.defines.USE_INSTANCE="",t.defines.USE_INSTANCE_NORMAL="",t.colorState=r.EnumShaderColorState.BLINK,t.refreshUniforms()),t),c.disposeDefaultInstanceMaterial=()=>{t&&(t.dispose(),t=null)},c.getDefaultStandardMaterialV3=()=>(i||(i=new r.CloudStandardBatchedMaterialV3({color:13024187,side:THREE.DoubleSide})),i),c.disposeDefaultStandardMaterialV3=()=>{i&&(i.dispose(),i=null)},c.getDefaultInstanceMaterialV3=()=>(n||(n=new r.CloudStandardInstanceMaterialV3({color:13024187,side:THREE.DoubleSide}),n.forInstance=!0,n.defines.USE_INSTANCE_NORMAL="",n.colorState=r.EnumShaderColorState.BLINK,n.refreshUniforms()),n),c.disposeDefaultInstanceMaterialV3=()=>{n&&(n.dispose(),n=null)},c.getDefaultSelectedMaterial=()=>(a||(a=new r.MeshBasicClipMaterial({color:1170103,opacity:.3,transparent:!0})),a),c.disposeDefaultSelectedMaterial=()=>{a&&(a.dispose(),a=null)},c.getDefaultSelectedMaterialV3=e=>(s||(s=new r.MeshBasicClipMaterial({color:1170103,opacity:.3,transparent:!0}),s.setBorderLineVisible(e)),s.clippingPlanes=null,s.clipIntersection=!1,s),c.disposeDefaultSelectedMaterialV3=()=>{s&&(s.dispose(),s=null)},c.getDefaultSelectedInstanceMaterialV3=()=>(o||(o=new r.CloudStandardInstanceMaterialV3({color:1170103,opacity:.3,transparent:!0,useBCOutline:!0}),o.defines.USE_COLORWITHOUTLIGHT="",o.setBorderLineVisible(!0),o.setOutLineColor(o.color),o.colorState=r.EnumShaderColorState.BLINK,o.refreshUniforms()),o),c.disposeDefaultSelectedInstanceMaterialV3=()=>{o&&(o.dispose(),o=null)},c.disposeAllDefaultMaterial=()=>{c.disposeDefaultStandardMaterial(),c.disposeDefaultInstanceMaterial(),c.disposeDefaultSelectedMaterial(),c.disposeDefaultStandardMaterialV3(),c.disposeDefaultInstanceMaterialV3(),c.disposeDefaultSelectedMaterialV3(),c.disposeDefaultSelectedInstanceMaterialV3()},c.createInstancePhongMaterial=e=>e.clone(),c.updateBasicMaterial=(e,t)=>{e.needsUpdate=!0},c.setMatrixUniform=e=>{r.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.transformMatrix.value=e},c.createPhongMaterial=e=>{let t=new THREE.MeshPhongMaterial(e);return t.type="FillFacePhong",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.fillFacePhong.uniforms]),t.vertexShader=THREE.ShaderLib.fillFacePhong.vertexShader,t.fragmentShader=THREE.ShaderLib.fillFacePhong.fragmentShader,t.side=THREE.DoubleSide,t},c.createStandardMaterial=(e,t)=>{let i;return t?(i=new H.IBLMaterial(e),i.type="IBL"):i=new r.CloudStandardMaterial(e),e.fillMap&&(i.defines.USE_FILLPATTERN=""),i.refreshUniforms(),i},c.createStandardMaterialV3=(e,t)=>{let i;return t?(i=new H.IBLMaterial(e),i.type="IBL"):i=new r.CloudStandardBatchedMaterialV3(e),e.fillMap&&(i.defines.USE_FILLPATTERN=""),i.refreshUniforms(),i},c.createInstanceMaterial=(e,t,i)=>{let n=r.MaterialUtil.createStandardMaterial(e,i);return n.forInstance=!0,n.defines.USE_INSTANCE="",t&&(n.defines.USE_INSTANCE_NORMAL=""),n.colorState=r.EnumShaderColorState.BLINK,n.refreshUniforms(),n},c.createNewStyleMaterial=e=>{let t=new THREE.MeshStandardMaterial(e);return t.type="NewStyle",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms]),t.vertexShader=THREE.ShaderLib.newStyle.vertexShader,t.fragmentShader=THREE.ShaderLib.newStyle.fragmentShader,t.metalness=0,t},c.createHighlightMaterial=()=>c.createStandardMaterial(r.GlobalData.SelectionColor),c.getBlinkMaterial=(e,t)=>{const i=r.MaterialUtil.getMaterialParameters(e);let n=r.MaterialUtil.createStandardMaterial(i);return e.useCompressedNormal&&void 0!==e.defines.CNORMAL&&(n.defines.CNORMAL="",n.useCompressedNormal=!0),t.w<1&&(n.transparent=!0),n.blinkColor.copy(t),n.colorState=r.EnumShaderColorState.BLINK,n.refreshUniforms(),n},c.getBlinkMaterialV3=(e,t)=>{const i=r.MaterialUtil.getMaterialParameters(e);let n=new r.CloudStandardBatchedMaterialV3(i);return t.w<1&&(n.transparent=!0),n.blinkColor.copy(t),n.colorState=r.EnumShaderColorState.BLINK,n.refreshUniforms(),n},c.resetCompressParm=(e,t)=>{let i=!1;if(r.Utils.isDefined(t.useCompressedNormal)&&e.useCompressedNormal!==t.useCompressedNormal&&(i=!0),r.Utils.isDefined(t.useCompressedColor)&&e.useCompressedColor!==t.useCompressedColor&&(i=!0),r.Utils.isDefined(t.useCompressedUv)&&e.useCompressedUv!==t.useCompressedUv&&(i=!0),r.Utils.isDefined(t.useBCOutline)&&e.useBCOutline!==t.useBCOutline&&(i=!0),i){const i=e.clone();return i.useCompressedColor=t.useCompressedColor,delete i.defines.CCOLOR,i.useCompressedNormal=t.useCompressedNormal,delete i.defines.CNORMAL,r.Utils.isDefined(t.useBCOutline)&&(i.useBCOutline=t.useBCOutline,delete i.defines.USE_BC_OUTLINE),r.Utils.isDefined(t.useCompressedUv)&&(i.useCompressedUv=t.useCompressedUv,i.uvCenter=t.uvCenter,i.uvHalfExtent=t.uvHalfExtent),delete i.defines.USE_COMPRESS_UV,r.MaterialUtil.setCompressParm(i,t),i}return e},c.setCompressParm=(e,t)=>{r.Utils.isDefined(t.useCompressedNormal)&&!0===t.useCompressedNormal&&(null!=e.defines&&(e.defines.CNORMAL=""),e.useCompressedNormal=!0),r.Utils.isDefined(t.useCompressedColor)&&!0===t.useCompressedColor&&(e.defines.CCOLOR="",e.useCompressedColor=!0),r.Utils.isDefined(t.useCompressedUv)&&!0===t.useCompressedUv&&(e.defines.USE_COMPRESS_UV="",e.useCompressedUv=!0),r.Utils.isDefined(t.useCompressedUv)&&!0===t.useCompressedUv&&(e.defines.USE_COMPRESS_UV="",e.useCompressedUv=!0),r.Utils.isDefined(t.useBCOutline)&&!0===t.useBCOutline&&(e.useBCOutline=!0)},c.getMaterialParameters=e=>{let t={};return e.hasOwnProperty("color")&&(t.color=e.color),t.opacity=1,t.transparent=!1,e.hasOwnProperty("opacity")&&(t.opacity=e.opacity,e.opacity<1&&(t.transparent=!0)),e.hasOwnProperty("side")&&(t.side=e.side),e.hasOwnProperty("emissive")&&(t.emissive=e.emissive),e.hasOwnProperty("specular")&&(t.specular=e.specular),e.hasOwnProperty("shininess")&&(t.shininess=e.shininess),e.hasOwnProperty("map")&&(t.map=e.map),e.useAlphaMap&&(t.useAlphaMap=e.useAlphaMap),e.hasOwnProperty("bumpMap")&&(t.bumpMap=e.bumpMap),e.hasOwnProperty("bumpScale")&&(t.bumpScale=e.bumpScale),e.hasOwnProperty("normalMap")&&(t.normalMap=e.normalMap),e.hasOwnProperty("normalScale")&&(t.normalScale=e.normalScale),e.hasOwnProperty("alphaMap")&&(t.alphaMap=e.alphaMap),e.hasOwnProperty("alphaTest")&&(t.alphaTest=e.alphaTest),e.hasOwnProperty("transparent")&&(t.transparent=e.transparent),e.hasOwnProperty("emissiveMap")&&(t.emissiveMap=e.emissiveMap),e.hasOwnProperty("envMap")&&(t.envMap=e.envMap),e.hasOwnProperty("envMapIntensity")&&(t.envMapIntensity=e.envMapIntensity),e.hasOwnProperty("roughness")&&(t.roughness=e.roughness),e.hasOwnProperty("metalness")&&(t.metalness=e.metalness),e.hasOwnProperty("originRoughness")&&(t.originRoughness=e.originRoughness),e.hasOwnProperty("originMetalness")&&(t.originMetalness=e.originMetalness),r.GlobalData.IBL&&e.hasOwnProperty("iblProbe")&&(t.iblProbe=e.iblProbe),e.hasOwnProperty("shift")&&(t.shift=e.shift),e.hasOwnProperty("pureColor")&&(t.pureColor=e.pureColor),e.hasOwnProperty("tag")&&(t.tag=e.tag),e.hasOwnProperty("textureColor")&&(t.textureColor=e.textureColor),e.hasOwnProperty("imageFade")&&(t.imageFade=e.imageFade),e.hasOwnProperty("tintColor")&&(t.tintColor=e.tintColor),"cloudStandard"==e.type&&e.hasOwnProperty("lights")&&(t.lights=e.lights),e.hasOwnProperty("lightMap")&&(t.lightMap=e.lightMap),e.hasOwnProperty("lightMapIntensity")&&(t.lightMapIntensity=e.lightMapIntensity),e.hasOwnProperty("viewportSize")&&(t.viewportSize=e.viewportSize),e.hasOwnProperty("fillMap")&&(t.fillMap=e.fillMap),e.hasOwnProperty("heightLimitSampler")&&(t.heightLimitSampler=e.heightLimitSampler),e.hasOwnProperty("heightColorSampler")&&(t.heightColorSampler=e.heightColorSampler),e.hasOwnProperty("heightLimitOrthoMatrix")&&(t.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix),e.hasOwnProperty("receiveIBL")&&(t.receiveIBL=e.receiveIBL),e.hasOwnProperty("localClipping")&&(t.localClipping=e.localClipping),e.hasOwnProperty("clippingPlanes")&&(t.clippingPlanes=e.clippingPlanes),e.hasOwnProperty("useCompressedColor")&&(t.useCompressedColor=e.useCompressedColor),e.hasOwnProperty("useCompressedNormal")&&(t.useCompressedNormal=e.useCompressedNormal),e.hasOwnProperty("vertexColors")&&(t.vertexColors=e.vertexColors),e.hasOwnProperty("useClampToBorder")&&(t.useClampToBorder=e.useClampToBorder),e.hasOwnProperty("useCompressedUv")&&(t.useCompressedUv=e.useCompressedUv,t.uvCenter=e.uvCenter,t.uvHalfExtent=e.uvHalfExtent),e.hasOwnProperty("clipIntersection")&&(t.clipIntersection=e.clipIntersection),e.hasOwnProperty("useBCOutline")&&(t.useBCOutline=e.useBCOutline),e.hasOwnProperty("borderLineVisible")&&(t.borderLineVisible=e.borderLineVisible),e.hasOwnProperty("packingMaterialEnable")&&(t.packingMaterialEnable=e.packingMaterialEnable),e.hasOwnProperty("packingMatMap")&&(t.packingMatTexture=e.packingMatMap),e.hasOwnProperty("outLineColor")&&(t.outLineColor=e.outLineColor),e.hasOwnProperty("useEnvLight")&&(t.useEnvLight=e.useEnvLight),e.hasOwnProperty("growthAnimationPlanes")&&(t.growthAnimationPlanes=e.growthAnimationPlanes),e.hasOwnProperty("growthAnimationMap")&&(t.growthAnimationMap=e.growthAnimationMap),e.hasOwnProperty("growthAnimationMapSizeWidth")&&(t.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth),e.hasOwnProperty("growthAnimationMapSizeHeight")&&(t.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight),t},c.nextHighestPowerOfTwo=e=>{--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1},c.getImageByteSize=e=>e.width*e.height*4,c.ensurePowerOfTwo=e=>{if(0==e.width||0==e.height)return e;if(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height)){let t=document.createElement("canvas");t.width=r.MaterialUtil.nextHighestPowerOfTwo(e.width),t.height=r.MaterialUtil.nextHighestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},c.ensureQuadrate=e=>{let t=e.width,i=e.height;if(0==t||0==i||THREE.Math.isPowerOfTwo(t)&&THREE.Math.isPowerOfTwo(i)&&t===i)return e;THREE.Math.isPowerOfTwo(t)||(t=r.MaterialUtil.nextHighestPowerOfTwo(t)),THREE.Math.isPowerOfTwo(i)||(i=r.MaterialUtil.nextHighestPowerOfTwo(i));let n=0,a=0,s=e.width,o=e.height,l=Math.max(t,i);if(s>=o){o*=l/s,s=l,a=.5*(l-o)}else{s*=l/o,o=l,n=.5*(l-s)}let d=document.createElement("canvas");d.width=d.height=l;return d.getContext("2d").drawImage(e,n,a,s,o),d},c.getColorParamsByMaterial=e=>({rgbaColor:[e.color.r,e.color.g,e.color.b,e.opacity],transparent:e.transparent}),c.getHoverColorByColor=e=>{let t={};return t.r=e.r,t.g=e.g,t.b=e.b,t.a=r.MaterialUtil.getHoverOpacity(e.a),t},c.getHoverOpacity=e=>e>=.4?e-.3:e+.3,c.cloneMaterialBaseOnColor=(e,t)=>{if(!e.color&&!e.diffuse)return e;let i=e.clone();return i.opacity=t.opacity,i.transparent=t.transparent,i.color&&i.color.isColor&&t.color&&t.color.isColor&&i.color.copy(t.color),i.diffuse&&i.diffuse.isColor&&t.diffuse&&t.diffuse.isColor&&i.diffuse.copy(t.diffuse),void 0!==i.map&&t.map&&(i.map=t.map,i.alphaMap=t.alphaMap,i.alphaTest=t.alphaTest),i},c.updateUVMatrix=e=>{e.matrixAutoUpdate=!1,c.setUvTransform(e.offset.x,e.offset.y,e.repeat.x,e.repeat.y,e.rotation,e.center.x,e.center.y,e.matrix)},c.setUvTransform=(e,t,i,r,n,a,s,o)=>{const l=Math.cos(n),d=Math.sin(n);return o.set(i*l,-i*d,-i*l*e+d*i*t,r*d,r*l,-r*d*e-r*l*t,0,0,1),o},c.updateUVMatrix2=e=>{e.matrixAutoUpdate=!1,c.setUvTransform2(e.offset.x,e.offset.y,e.repeat.x,e.repeat.y,e.rotation,e.center.x,e.center.y,e.matrix)},c.setUvTransform2=(e,t,i,r,n,a,s,o)=>{const l=Math.cos(n),d=Math.sin(n);return o.set(i*l,-i*d,-.5*i*l+.5*i*d+.5*i-i*e,r*d,r*l,-.5*r*d-.5*r*l+.5*r-r*t,0,0,1),o},c.loadFillMap=(e,t)=>{let i=[];const r=c.createFillPatternByWidth(e,t);if(!r)return;for(let e=0;e<1024;e++){let t=r[Math.floor(e/8)];const n=Math.floor(Math.pow(2,e%8));t=Math.floor(t&n),0===t?(i.push(0),i.push(0),i.push(0),i.push(0)):(i.push(255),i.push(255),i.push(255),i.push(255))}let n=new THREE.DataTexture(new Uint8Array(i),32,32,THREE.RGBAFormat,THREE.UnsignedByteType);return n.minFilter=THREE.NearestFilter,n.magFilter=THREE.NearestFilter,n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.needsUpdate=!0,n},c.createFillPatternByWidth=(e,t)=>{if(void 0===t)return r.FILLPATTERN[e];let i=[...r.FILLPATTERN[e]];if("horizontalLine"===e)for(let e=0;e<128;e++)i[e]=e%32<24?0:255;if("verticalLine"===e)for(let e=0;e<128;e++)i[e]=192;if("orthogonalCrossLine"===e)for(let e=0;e<32;e++)for(let t=0;t<4;t++)i[4*e+t]=192,e%8>5&&(i[4*e+t]=255);if("rightDiagonalLine"===e){let e=192;const t=8;for(let r=0;r<32;r++){let n=e>>r%t;1==n&&(n=129),i[4*r]=n,i[4*r+1]=n,i[4*r+2]=n,i[4*r+3]=n}}if("leftDiagonalLine"===e){let e=3;const t=8;for(let r=0;r<32;r++){let n=e<<r%t;384==n&&(n=129),i[4*r]=n,i[4*r+1]=n,i[4*r+2]=n,i[4*r+3]=n}}if("skewCrossLine"===e){const e=[195,102,60,24,60,102,195,129],t=8;for(let r=0;r<32;r++){const n=r%t;i[4*r]=e[n],i[4*r+1]=e[n],i[4*r+2]=e[n],i[4*r+3]=e[n]}}return i},c.loadTexture=(e,t,i)=>{(new TEST.CryptoResourceLoader).loadURL(e,(e=>{var n=new Blob([e],{type:"jpeg"});let a=new Image;a.onload=function(){!function(e){var i=new THREE.Texture;i.image=r.MaterialUtil.ensurePowerOfTwo(e),i.needsUpdate=!0,i.encoding=THREE.GammaEncoding,r.MaterialUtil.updateUVMatrix(i),i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,t&&t(i)}(a)},a.onerror=e=>{console.log("ERROR: image load error!!"),console.log(e),i&&i(e)},a.src=URL.createObjectURL(n)}),null,(e=>{console.log("ERROR: image load error!!"),console.log(e),i&&i(e)}))},c.AddCloseSSAODefine=e=>{r.Utils.isDefined(e.defines)?e.defines.USE_NO_SSAO="":e.defines={USE_NO_SSAO:""}},c.AddCloseSSRDefine=e=>{r.Utils.isDefined(e.defines)?e.defines.USE_NO_SSR="":e.defines={USE_NO_SSR:""}},r.MaterialUtil=c})(),r.UIHelper={debugInfoDiv:null,lastDebugInfoDivShow:null,showPickedInformation:function(e){var t=340,i=320,r=this;function n(){var e=r.debugInfoDiv;e&&"none"!==e.style.display&&(e.style.display="none",r.lastDebugInfoDivShow&&(e.removeEventListener("dblclick",n,!1),r.lastDebugInfoDivShow=!1))}if(e&&e.intersectInfo){var a=e.intersectInfo,s=e.canvasPos.x,o=e.canvasPos.y;this.debugInfoDiv||(this.debugInfoDiv=document.createElement("div"),this.debugInfoDiv.id="debugPickedInfo",this.debugInfoDiv.style.display="block",this.debugInfoDiv.style.position="absolute",this.debugInfoDiv.style.width="340px",this.debugInfoDiv.style.height="320px",this.debugInfoDiv.style.backgroundColor="#ffffdd",this.debugInfoDiv.style.borderWidth="2px",this.debugInfoDiv.style.borderStyle="solid",this.debugInfoDiv.style.opacity="0.8",document.body.appendChild(this.debugInfoDiv)),this.debugInfoDiv.style.display="",this.lastDebugInfoDivShow||(this.lastDebugInfoDivShow=!0,this.debugInfoDiv.addEventListener("dblclick",n,!1));var l=a.axisGridInfo,d=a.worldPosition,h="";h+="<span>&#9830;&nbsp;&nbsp;Base Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;border-bottom: 1px solid #ccc;float:left;width:80px;height:66px;text-align:left;line-height:66px'>ID</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:66px;text-align:left;'>"+a.selectedObjectId+"</li>",h+="</ul>",h+="</br><span>&#9830;&nbsp;&nbsp;Position</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>X</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+d.x+"</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>Y</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+d.y+"</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>Z</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>"+d.z+"</li>",h+="</ul>",l?(h+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>distanceX</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>("+l.numeralName+", "+l.offsetX+")</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>distanceY</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>("+l.abcName+", "+l.offsetY+")</li>",h+="</ul>"):(h+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>message</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'><span style='color: red'> not exist axis grid!!!</span></li>",h+="</ul>"),this.debugInfoDiv.innerHTML=h+"<br /><br />",function(e,r,n){if(e&&"none"!=e.style.display){var a,s,o,l=r+t,d=n+i;if(void 0!==r&&void 0!==n)if(window.innerWidth)a=l>window.innerWidth?window.pageXOffset+(r-t)+"px":window.pageXOffset+r+"px",s=d>window.innerHeight?window.pageYOffset+(n-i)+"px":window.pageYOffset+n+"px";else a=(o=document.documentElement).scrollLeft+r+"px",s=o.scrollTop+n+"px";else if(window.innerWidth)a=window.pageXOffset+(window.innerWidth-t)/2+"px",s=window.pageYOffset+(window.innerHeight-i)/2+"px";else a=(o=document.documentElement).scrollLeft+(o.offsetWidth-t)/2+"px",s=o.scrollTop+(o.offsetHeight-i)/2+"px";e.style.left=a,e.style.top=s}}(this.debugInfoDiv,s,o)}else n()}},function(){let e=new THREE.Vector3,t=new THREE.Vector2;r.Edge=function(){this.vertexIndex=new Array(2),this.faceIndex=new Array(2)},r.RemoveDuplicateIndex=function(e,t){var i=e.length/3,r=new Array(i),n=new Array(i);function a(e,t){var i=r[e],n=r[t];return i.x!=n.x?i.x-n.x:i.y!=n.y?i.y-n.y:i.z-n.z}for(var s=0;s<i;++s)r[s]=new THREE.Vector3(e[3*s],e[3*s+1],e[3*s+2]),n[s]=s;n.sort((function(e,t){var i=a(e,t);return 0==i?e-t:i}));var o={},l=n[0];for(s=1;s<i;++s)0==a(l,n[s])?o[n[s]]=l:l=n[s];var d=new Array(t.length);for(s=0;s<t.length;++s)o.hasOwnProperty(t[s])?d[s]=o[t[s]]:d[s]=t[s];return d},r.RemoveDuplicateVertex=function(e,t){function i(e,t){return e-t}var n=r.RemoveDuplicateIndex(e,t);n.sort(i);var a=new Array,s=n[0];a.push(s);for(var o=1;o<n.length;++o)n[o]!=s&&(s=n[o],a.push(s));return a.sort(i)},r.BuildEdge=function(e,t,i){if(t.length%3==0){i=null==i?Math.PI/4:i;for(var n=r.RemoveDuplicateIndex(e,t),a=n.length,s=e.length/3,o=new Array(s+a),l=s,d=n.length/3,h=0;h<s;++h)o[h]=-1;var c=new Array(a),u=0;for(h=0;h<d;++h)for(var p=n[3*h+2],m=0;m<3;++m){var f=!1,g=n[3*h+m];if(p>g){f=!0;var v=p;p=g,g=v}var y=new r.Edge;y.vertexIndex[0]=p,y.vertexIndex[1]=g,y.faceIndex[0]=h,y.faceIndex[1]=h;var M=o[p];if(-1==M)o[p]=u,c[u]=y,o[l+u]=-1,u++;else for(;;){if((_=c[M]).vertexIndex[1]==g){_.faceIndex[1]=h;break}var E=o[l+M];if(-1==E){o[l+M]=u,c[u]=y,o[l+u]=-1,u++;break}M=E}f||(p=g)}var x=[];for(h=0;h<u;++h){var _;if((_=c[h]).faceIndex[0]==_.faceIndex[1])x.push(_.vertexIndex[0]),x.push(_.vertexIndex[1]);else{var b=_.faceIndex[0],I=n[3*b],T=n[3*b+1],S=n[3*b+2],C=new THREE.Vector3(e[3*I],e[3*I+1],e[3*I+2]),w=new THREE.Vector3(e[3*T],e[3*T+1],e[3*T+2]),R=new THREE.Vector3(e[3*S],e[3*S+1],e[3*S+2]),B=C.sub(w),A=w.sub(R),P=B.cross(A);P.normalize();var L=_.faceIndex[1];I=n[3*L],T=n[3*L+1],S=n[3*L+2],C=new THREE.Vector3(e[3*I],e[3*I+1],e[3*I+2]),w=new THREE.Vector3(e[3*T],e[3*T+1],e[3*T+2]),R=new THREE.Vector3(e[3*S],e[3*S+1],e[3*S+2]),B=C.sub(w),A=w.sub(R);var O=B.cross(A);O.normalize(),Math.abs(P.dot(O))<i&&(x.push(_.vertexIndex[0]),x.push(_.vertexIndex[1]))}}return x}},r.GetFaceIndex=function(i,n,a,s,o,l){for(var d=a.length/3,h=new Array,c=0;c<d;++c){var u=a[3*c];l?(t.set(n[2*u],n[2*u+1]),e=r.Math.octDecode(t,e)):e.set(n[3*u],n[3*u+1],n[3*u+2]);var p=e.dot(o);if(Math.abs(p-1)<.001){var m=-new THREE.Vector3(i[3*u],i[3*u+1],i[3*u+2]).dot(e),f=Math.abs(s.dot(e)+m);Math.abs(f)<3&&h.push(a[3*c],a[3*c+1],a[3*c+2])}}return h},r.BuildRoomEdge=function(e,t,i,r,n){function a(e,t){return Math.abs(e-t)<=.1}var s=e.length;a(e[0].x,e[s-1].x)&&a(e[0].y,e[s-1].y)||e.push(e[0]),s=e.length;for(var o=[],l=[],d=new THREE.BufferGeometry,h=0;h<s;++h)l.push(e[h].x-t,e[h].y-i,e[h].z-r);for(h=0;h<s;++h)l.push(e[h].x-t,e[h].y-i,e[h].z-r+n);for(h=0;h<2*s-1;++h)h!=s-1&&o.push(h,h+1);for(h=0;h<s-1;++h)o.push(h,h+s);return d.setIndex(new THREE.BufferAttribute(new Uint16Array(o),1)),d.setAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),d.computeBoundingSphere(),d},r.LineTextureManager=class e{static get uLineTexture(){if(null==e._uLineTexture){let t=new THREE.DataTexture(null);t.colorSpace=THREE.SRGBColorSpace,t.minFilter=THREE.LinearMipmapLinearFilter,t.magFilter=THREE.LinearFilter,t.wrapS=THREE.MirroredRepeatWrapping,t.wrapT=THREE.MirroredRepeatWrapping,t.format=THREE.LuminanceFormat,t.interFormat="LUMINANCE",t.generateMipmaps=!0,t.type=THREE.UnsignedByteType,t.flipY=!1;let i=16384,r=1,n=0,a=152;for(;i>=1;){let e=new Uint8Array(i*r*1),s=[a];1==i&&(s=[0]),i<=64&&(a-=12),a<0&&(a=0),e.set(s,0),t.mipmaps[n]={data:e,width:i,height:r},i/=2,n+=1}t.needsUpdate=!0,e._uLineTexture=t}return e._uLineTexture}}}(),THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse,this.loadBuffer=THREE.DDSLoader.loadBuffer},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function n(e,t,i,r){for(var n=i*r*4,a=new Uint8Array(e,t,n),s=new Uint8Array(n),o=0,l=0,d=0;d<r;d++)for(var h=0;h<i;h++){var c=a[l],u=a[++l],p=a[++l],m=a[++l];l++,s[o]=p,s[++o]=u,s[++o]=c,s[++o]=m,o++}return s}var a,s=r("DXT1"),o=r("DXT3"),l=r("DXT5"),d=r("ETC1"),h=new Int32Array(e,0,31);if(542327876!==h[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),i;if(4&!h[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),i;var c,u=h[21],p=!1;switch(u){case s:a=8,i.format=THREE.RGB_S3TC_DXT1_Format;break;case o:a=16,i.format=THREE.RGBA_S3TC_DXT3_Format;break;case l:a=16,i.format=THREE.RGBA_S3TC_DXT5_Format;break;case d:a=8,i.format=THREE.RGB_ETC1_Format;break;default:if(!(32===h[22]&&16711680&h[23]&&65280&h[24]&&255&h[25]&&4278190080&h[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",(c=u,String.fromCharCode(255&c,c>>8&255,c>>16&255,c>>24&255))),i;p=!0,a=64,i.format=THREE.RGBAFormat}i.mipmapCount=1,131072&h[2]&&!1!==t&&(i.mipmapCount=Math.max(1,h[7]));var m=h[28];if(i.isCubemap=!!(512&m),i.isCubemap&&(!(1024&m)||!(2048&m)||!(4096&m)||!(8192&m)||!(16384&m)||!(32768&m)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),i;i.width=h[4],i.height=h[3];for(var f=h[1]+4,g=i.isCubemap?6:1,v=0;v<g;v++)for(var y=i.width,M=i.height,E=0;E<i.mipmapCount;E++){if(p)var x=(_=n(e,f,y,M)).length;else{x=Math.max(4,y)/4*Math.max(4,M)/4*a;var _=new Uint8Array(e,f,x)}var b={data:_,width:y,height:M};i.mipmaps.push(b),f+=x,y=Math.max(y>>1,1),M=Math.max(M>>1,1)}return i},THREE.DDSLoader.loadBuffer=function(e,t){var i=[],r=new THREE.CompressedTexture;r.image=i;var n=this._parser(e,!0);if(n.isCubemap)for(var a=n.mipmaps.length/n.mipmapCount,s=0;s<a;s++){i[s]={mipmaps:[]};for(var o=0;o<n.mipmapCount;o++)i[s].mipmaps.push(n.mipmaps[s*n.mipmapCount+o]),i[s].format=n.format,i[s].width=n.width,i[s].height=n.height}else r.image.width=n.width,r.image.height=n.height,r.mipmaps=n.mipmaps;1===n.mipmapCount&&(r.minFilter=THREE.LinearFilter),r.format=n.format,r.needsUpdate=!0,t&&t(r)},function(){const e={};class t extends THREE.FileLoader{constructor(e){super(e),this.timeoutTimes={}}load(t,i,r,n,a){const s=THREE.Cache;void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const o=this,l=s.get(t);if(void 0!==l)return o.manager.itemStart(t),setTimeout((function(){i&&i(l),o.manager.itemEnd(t)}),0),l;if(void 0!==e[t])return void e[t].push({onLoad:i,onProgress:r,onError:n,onTimeout:a});const d=t.match(/^data:(.*?)(;base64)?,(.*)$/);let h;if(d){const e=d[1],r=!!d[2];let a=d[3];a=decodeURIComponent(a),r&&(a=atob(a));try{let r;const n=(this.responseType||"").toLowerCase();switch(n){case"arraybuffer":case"blob":const t=new Uint8Array(a.length);for(let e=0;e<a.length;e++)t[e]=a.charCodeAt(e);r="blob"===n?new Blob([t.buffer],{type:e}):t.buffer;break;case"document":const i=new DOMParser;r=i.parseFromString(a,e);break;case"json":r=JSON.parse(a);break;default:r=a}setTimeout((function(){i&&i(r),o.manager.itemEnd(t)}),0)}catch(e){setTimeout((function(){n&&n(e),o.manager.itemError(t),o.manager.itemEnd(t)}),0)}}else{e[t]=[],e[t].push({onLoad:i,onProgress:r,onError:n,onTimeout:a}),h=new XMLHttpRequest,h.timeout=2e4,h.open("GET",t,!0),h.addEventListener("load",(function(i){const r=this.response,n=e[t];if(delete e[t],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),s.add(t,r);for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onLoad&&t.onLoad(r)}o.manager.itemEnd(t)}else{for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onError&&t.onError(i)}o.manager.itemError(t),o.manager.itemEnd(t)}}),!1),h.addEventListener("progress",(function(i){const r=e[t];for(let e=0,t=r.length;e<t;e++){const t=r[e];t.onProgress&&t.onProgress(i)}}),!1),h.addEventListener("error",(function(i){const r=e[t];delete e[t];for(let e=0,t=r.length;e<t;e++){const t=r[e];t.onError&&t.onError(i)}o.manager.itemError(t),o.manager.itemEnd(t)}),!1),h.addEventListener("abort",(function(i){const r=e[t];delete e[t];for(let e=0,t=r.length;e<t;e++){const t=r[e];t.onError&&t.onError(i)}o.manager.itemError(t),o.manager.itemEnd(t)}),!1),h.addEventListener("timeout",(function(i){const r=e[t];if(delete e[t],void 0===o.timeoutTimes[t]?o.timeoutTimes[t]=1:o.timeoutTimes[t]++,3===o.timeoutTimes[t])return console.log(t),o.manager.itemError(t),void o.manager.itemEnd(t);for(let e=0,n=r.length;e<n;e++){const n=r[e];n.onTimeout&&n.onTimeout(i),o.load(t,n.onLoad,n.onProgress,n.onError,n.onTimeout)}}),!1),void 0!==this.responseType&&(h.responseType=this.responseType),void 0!==this.withCredentials&&(h.withCredentials=this.withCredentials),h.overrideMimeType&&h.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const e in this.requestHeader)h.setRequestHeader(e,this.requestHeader[e]);h.send(null)}return o.manager.itemStart(t),h}}r.FileLoader=t}(),r.SplitGeometryBuilder=class{constructor(e,t){this.sourceGeometry=e,this.slicePlane=t,this.addedVertices=[],this.addedIntersections=[];var i=this.sourceGeometry.getAttribute("uv");this.uvs=i?i.array:null;const r=this.sourceGeometry.getAttribute("uv3");this.uv3s=r?r.array:null;var n=this.sourceGeometry.getAttribute("normal");this.normals=n?n.array:null;var a=this.sourceGeometry.getAttribute("position");this.positions=a?a.array:null;const s=this.sourceGeometry.getAttribute("color");this.colors=s?s.array:null;const o=this.sourceGeometry.getAttribute("id");this.ids=o?o.array:null;const l=this.sourceGeometry.getAttribute("vState");this.vStates=l?l.array:null;const d=this.sourceGeometry.getAttribute("pointColorState");this.colorStates=d?d.array:null;const h=this.sourceGeometry.getAttribute("barycentric");this.barycentric=h?h.array:null,this.targetIndices=[],this.targetNormals=[],this.targetUvs=[],this.targetUv3s=[],this.targetPositions=[],this.targetColors=[],this.targetIds=[],this.targetVStates=[],this.targetColorStates=[],this.targetBarycentric=[]}startFace(e,t){this.sourceFaceIndex=e,this.sourceFace=t,this.faceIndices=[]}endFace(){this._addFace(this.faceIndices)}addVertex(e){var t,i=this.sourceFace[e];if(this.addedVertices.hasOwnProperty(i))t=this.addedVertices[i];else{var r=3*i;if(this.targetPositions.push(this.positions[r]),this.targetPositions.push(this.positions[r+1]),this.targetPositions.push(this.positions[r+2]),null!==this.colors){const e=4*i;this.targetColors.push(this.colors[e]),this.targetColors.push(this.colors[e+1]),this.targetColors.push(this.colors[e+2]),this.targetColors.push(this.colors[e+3])}if(null!==this.ids){const e=4*i;this.targetIds.push(this.ids[e]),this.targetIds.push(this.ids[e+1]),this.targetIds.push(this.ids[e+2]),this.targetIds.push(this.ids[e+3])}if(null!==this.vStates){const e=4*i;this.targetVStates.push(this.vStates[e]),this.targetVStates.push(this.vStates[e+1]),this.targetVStates.push(this.vStates[e+2]),this.targetVStates.push(this.vStates[e+3])}if(null!==this.colorStates){const e=4*i;this.targetColorStates.push(this.colorStates[e]),this.targetColorStates.push(this.colorStates[e+1]),this.targetColorStates.push(this.colorStates[e+2]),this.targetColorStates.push(this.colorStates[e+3])}null!==this.barycentric&&(this.targetBarycentric.push(this.barycentric[r]),this.targetBarycentric.push(this.barycentric[r+1]),this.targetBarycentric.push(this.barycentric[r+2])),t=this.targetPositions.length/3-1,this.addedVertices[i]=t,this._addUv(e),this._addUv3(e),this._addNormal(e)}this.faceIndices.push(t)}addIntersection(e,t,i,r){var n,a=Math.abs(i)/(Math.abs(i)+Math.abs(r)),s=this.sourceFace[e],o=this.sourceFace[t],l=this._intersectionId(s,o);if(this.addedIntersections.hasOwnProperty(l))n=this.addedIntersections[l];else{var d=3*s,h=3*o,c=this.positions[d],u=this.positions[d+1],p=this.positions[d+2];if(this.targetPositions.push(c+(this.positions[h]-c)*a),this.targetPositions.push(u+(this.positions[h+1]-u)*a),this.targetPositions.push(p+(this.positions[h+2]-p)*a),null!==this.colors){const e=4*s,t=4*o;this.targetColors.push((this.colors[e]+this.colors[t])/2),this.targetColors.push((this.colors[e+1]+this.colors[t+1])/2),this.targetColors.push((this.colors[e+2]+this.colors[t+2])/2),this.targetColors.push((this.colors[e+3]+this.colors[t+3])/2)}if(null!==this.ids){const e=4*s;this.targetIds.push(this.ids[e]),this.targetIds.push(this.ids[e+1]),this.targetIds.push(this.ids[e+2]),this.targetIds.push(this.ids[e+3])}if(null!==this.vStates&&this.targetVStates.push(this.vStates[s]),null!==this.colorStates){const e=4*s;this.targetColorStates.push(this.colorStates[e]),this.targetColorStates.push(this.colorStates[e+1]),this.targetColorStates.push(this.colorStates[e+2]),this.targetColorStates.push(this.colorStates[e+3])}if(null!==this.barycentric){const e=this.barycentric[d],t=this.barycentric[d+1],i=this.barycentric[d+2];this.targetBarycentric.push(e+(this.barycentric[h]-e)*a),this.targetBarycentric.push(t+(this.barycentric[h+1]-t)*a),this.targetBarycentric.push(i+(this.barycentric[h+2]-i)*a)}n=this.targetPositions.length/3-1,this.addedIntersections[l]=n,this._addIntersectionUv(e,t,a),this._addIntersectionUv3(e,t,a),this._addIntersectionNormal(e,t,a)}this.faceIndices.push(n)}_addUv(e){if(this.uvs){var t=2*this._keyIndex(e),i=this.uvs[t],r=this.uvs[t+1];this.targetUvs.push(i),this.targetUvs.push(r)}}_addUv3(e){if(this.uv3s){var t=2*this._keyIndex(e),i=this.uv3s[t],r=this.uv3s[t+1];this.targetUv3s.push(i),this.targetUv3s.push(r)}}_addIntersectionUv(e,t,i){if(this.uvs){var r=2*this._keyIndex(e),n=2*this._keyIndex(t),a=this.uvs[r],s=this.uvs[r+1],o=a+(this.uvs[n]-a)*i,l=s+(this.uvs[n+1]-s)*i;this.targetUvs.push(o),this.targetUvs.push(l)}}_addIntersectionUv3(e,t,i){if(this.uv3s){var r=2*this._keyIndex(e),n=2*this._keyIndex(t),a=this.uv3s[r],s=this.uv3s[r+1],o=a+(this.uv3s[n]-a)*i,l=s+(this.uv3s[n+1]-s)*i;this.targetUv3s.push(o),this.targetUv3s.push(l)}}_addNormal(e){if(this.normals){var t=3*this._keyIndex(e);this.targetNormals.push(this.normals[t]),this.targetNormals.push(this.normals[t+1]),this.targetNormals.push(this.normals[t+2])}}_addIntersectionNormal(e,t,i){if(this.normals){var r=3*this._keyIndex(e),n=3*this._keyIndex(t),a=this.normals[r],s=this.normals[r+1],o=this.normals[r+2];this.targetNormals.push(a+(this.normals[n]-a)*i),this.targetNormals.push(s+(this.normals[n+1]-s)*i),this.targetNormals.push(o+(this.normals[n+2]-o)*i)}}_addFace(e){if(!(e.length<3)){if(3===e.length)return this.targetIndices.push(e[0]),this.targetIndices.push(e[1]),void this.targetIndices.push(e[2]);for(var t=[],i=0;i<e.length;i++)for(var r=i+1;r<e.length;r++){var n=Math.abs(i-r);n>1&&n<e.length-1&&t.push([e[i],e[r]])}t.sort(function(e,t){return this._faceEdgeLength(e[0],e[1])-this._faceEdgeLength(t[0],t[1])}.bind(this));var a=e.indexOf(t[0][0]),s=(e=e.slice(a).concat(e.slice(0,a))).indexOf(t[0][1]),o=e.slice(0,s+1),l=e.slice(s).concat(e.slice(0,1));this._addFace(o),this._addFace(l)}}_faceEdgeLength(e,t){var i=3*this.faceIndices[e],r=3*this.faceIndices[t],n=this.targetPositions[i],a=this.targetPositions[i+1],s=this.targetPositions[i+2],o=n-this.targetPositions[r],l=a-this.targetPositions[r+1],d=s-this.targetPositions[r+2];return o*o+l*l+d*d}_intersectionId(e,t){return[e,t].sort().join(",")}_keyIndex(e){return this.sourceFace[e]}},function(){r.PerformanceStats=class{constructor(e){e.container||r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"container is required"),this._container=e.container,this._fpsPanel=document.createElement("div"),this._fpsPanel.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000;background:#002;color:#0ff",this._container.appendChild(this._fpsPanel),this._fpsText=document.createTextNode(""),this._fpsPanel.appendChild(this._fpsText),this._beginTime=this.getTimestamp(),this._prevTime=this._beginTime,this._frames=0,this._minFps=1/0,this._maxFps=0}destroy(){this._fpsText.parentNode&&(this._fpsText.parentNode.removeChild(this._fpsText),this._fpsText=null),this._fpsPanel.parentNode&&(this._fpsPanel.parentNode.removeChild(this._fpsPanel),this._fpsPanel=null),this._container=null}begin(){this._beginTime=this.getTimestamp()}end(){++this._frames;let e=this.getTimestamp(),t=e-this._prevTime;if(t>500){const i=1e3*this._frames/t|0;this._minFps=Math.min(i,this._minFps),this._maxFps=Math.max(i,this._maxFps),this._fpsText.nodeValue=Math.round(i)+" FPS ("+Math.round(this._minFps)+"-"+Math.round(this._maxFps)+")",this._prevTime=e,this._frames=0}return e}update(){this._beginTime=this.end()}getTimestamp(){return(performance||Date).now()}};r.FpsStats=class{constructor(){this._elapsedTimeThreshold=500,this._enabled=!1,this.reset()}destroy(){}set elapsedTimeThreshold(e){this._elapsedTimeThreshold=e}get elapsedTimeThreshold(){return this._elapsedTimeThreshold}isEnabled(){return this._enabled}enable(){this._enabled||(this.reset(),this._enabled=!0)}disable(){this._enabled&&(this.reset(),this._enabled=!1)}getTimestamp(){return(performance||Date).now()}reset(){this._beginTime=this.getTimestamp(),this._prevTime=this._beginTime,this._frames=0,this._minFps=1/0,this._maxFps=0,this._currentFps=0,this._averageFPS=0,this._fpsText="",this._minMs=1/0,this._maxMs=0,this._currentMs=0,this._msText="",this._totalTimeCost=0,this._totalFrames=0}begin(){this._beginTime=this.getTimestamp()}end(){++this._frames,++this._totalFrames;let e=this.getTimestamp();this._updateMS(e-this._beginTime);let t=e-this._prevTime;if(t>this._elapsedTimeThreshold){this._updateTotalTimeCost(t);const i=1e3*this._frames/t;this._updateFPS(i),this._prevTime=e,this._frames=0}return e}_updateTotalTimeCost(e){this._totalTimeCost+=e,this._averageFPS=1e3*this._totalFrames/this._totalTimeCost}_updateFPS(e){this._currentFps=e,this._minFps=Math.min(this._minFps,e),this._maxFps=Math.max(this._maxFps,e),this._fpsText=Math.round(e)+" FPS ("+Math.round(this._minFps)+"-"+Math.round(this._maxFps)+")  | "+Math.round(this._averageFPS)+" AVG FPS"}_updateMS(e){this._currentMs=e,this._minMs=Math.min(this._minMs,e),this._maxMs=Math.max(this._maxMs,e),this._msText=Math.round(e)+" MS ("+Math.round(this._minMs)+"-"+Math.round(this._maxMs)+")"}update(){this._beginTime=this.end()}getFPS(){return this._minFps!==1/0?{currentFPS:Math.round(this._currentFps),averageFPS:Math.round(this._averageFPS),minFPS:Math.round(this._minFps),maxFPS:Math.round(this._maxFps)}:{}}getMS(){return this.minMS!==1/0?{currentMS:Math.round(this._currentMs),minMS:Math.round(this._minMs),maxMS:Math.round(this._maxMs)}:{}}}}(),r.SkeletonUtils={parallelTraverse:function(e,t,i){i(e,t);for(var r=0;r<e.children.length;r++)this.parallelTraverse(e.children[r],t.children[r],i)},retarget:(y=new THREE.Vector3,M=new THREE.Quaternion,E=new THREE.Vector3,x=new THREE.Matrix4,_=new THREE.Matrix4,b=new THREE.Matrix4,function(e,t,i){(i=i||{}).preserveMatrix=void 0===i.preserveMatrix||i.preserveMatrix,i.preservePosition=void 0===i.preservePosition||i.preservePosition,i.preserveHipPosition=void 0!==i.preserveHipPosition&&i.preserveHipPosition,i.useTargetMatrix=void 0!==i.useTargetMatrix&&i.useTargetMatrix,i.hip=void 0!==i.hip?i.hip:"hip",i.names=i.names||{};var r,n,a,s,o,l,d=t.isObject3D?t.skeleton.bones:this.getBones(t),h=e.isObject3D?e.skeleton.bones:this.getBones(e);if(e.isObject3D?e.skeleton.pose():(i.useTargetMatrix=!0,i.preserveMatrix=!1),i.preservePosition)for(o=[],l=0;l<h.length;l++)o.push(h[l].position.clone());if(i.preserveMatrix)for(e.updateMatrixWorld(),e.matrixWorld.identity(),l=0;l<e.children.length;++l)e.children[l].updateMatrixWorld(!0);if(i.offsets)for(r=[],l=0;l<h.length;++l)n=h[l],a=i.names[n.name]||n.name,i.offsets&&i.offsets[a]&&(n.matrix.multiply(i.offsets[a]),n.matrix.decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld()),r.push(n.matrixWorld.clone());for(l=0;l<h.length;++l){if(n=h[l],a=i.names[n.name]||n.name,s=this.getBoneByName(a,d),b.copy(n.matrixWorld),s){if(s.updateMatrixWorld(),i.useTargetMatrix?_.copy(s.matrixWorld):(_.copy(e.matrixWorld).invert(),_.multiply(s.matrixWorld)),E.setFromMatrixScale(_),_.scale(E.set(1/E.x,1/E.y,1/E.z)),b.makeRotationFromQuaternion(M.setFromRotationMatrix(_)),e.isObject3D){var c=h.indexOf(n),u=r?r[c]:x.copy(e.skeleton.boneInverses[c]).invert();b.multiply(u)}b.copyPosition(_)}n.parent&&n.parent.isBone?(n.matrix.copy(n.parent.matrixWorld).invert(),n.matrix.multiply(b)):n.matrix.copy(b),i.preserveHipPosition&&a===i.hip&&n.matrix.setPosition(y.set(0,n.position.y,0)),n.matrix.decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld()}if(i.preservePosition)for(l=0;l<h.length;++l)n=h[l],(a=i.names[n.name]||n.name)!==i.hip&&n.position.copy(o[l]);i.preserveMatrix&&e.updateMatrixWorld(!0)}),retargetClip:function(e,t,i,r){(r=r||{}).useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],t.isObject3D||(t=this.getHelperFromSkeleton(t));var n,a,s,o,l,d,h=Math.round(i.duration*(r.fps/1e3)*1e3),c=1/r.fps,u=[],p=new THREE.AnimationMixer(t),m=this.getBones(e.skeleton),f=[];for(p.clipAction(i).play(),p.update(0),t.updateMatrixWorld(),l=0;l<h;++l){var g=l*c;for(this.retarget(e,t,r),d=0;d<m.length;++d)o=r.names[m[d].name]||m[d].name,this.getBoneByName(o,t.skeleton)&&(a=m[d],s=f[d]=f[d]||{bone:a},r.hip===o&&(s.pos||(s.pos={times:new Float32Array(h),values:new Float32Array(3*h)}),r.useFirstFramePosition&&(0===l&&(n=a.position.clone()),a.position.sub(n)),s.pos.times[l]=g,a.position.toArray(s.pos.values,3*l)),s.quat||(s.quat={times:new Float32Array(h),values:new Float32Array(4*h)}),s.quat.times[l]=g,a.quaternion.toArray(s.quat.values,4*l));p.update(c),t.updateMatrixWorld()}for(l=0;l<f.length;++l)(s=f[l])&&(s.pos&&u.push(new THREE.VectorKeyframeTrack(".bones["+s.bone.name+"].position",s.pos.times,s.pos.values)),u.push(new THREE.QuaterQuaternionKeyframeTrackion(".bones["+s.bone.name+"].quaternion",s.quat.times,s.quat.values)));return p.uncacheAction(i),new THREE.AnimationClip(i.name,-1,u)},getHelperFromSkeleton:function(e){var t=new THREE.SkeletonHelper(e.bones[0]);return t.skeleton=e,t},getSkeletonOffsets:(u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector2,v=new THREE.Vector2,function(e,t,i){(i=i||{}).hip=void 0!==i.hip?i.hip:"hip",i.names=i.names||{},t.isObject3D||(t=this.getHelperFromSkeleton(t));var r,n,a,s,o=Object.keys(i.names),l=Object.values(i.names),d=t.isObject3D?t.skeleton.bones:this.getBones(t),h=e.isObject3D?e.skeleton.bones:this.getBones(e),c=[];for(e.skeleton.pose(),s=0;s<h.length;++s)if(r=h[s],a=i.names[r.name]||r.name,(n=this.getBoneByName(a,d))&&a!==i.hip){var y=this.getNearestBone(r.parent,o),M=this.getNearestBone(n.parent,l);y.updateMatrixWorld(),M.updateMatrixWorld(),u.setFromMatrixPosition(y.matrixWorld),p.setFromMatrixPosition(r.matrixWorld),m.setFromMatrixPosition(M.matrixWorld),f.setFromMatrixPosition(n.matrixWorld),g.subVectors(new THREE.Vector2(p.x,p.y),new THREE.Vector2(u.x,u.y)).normalize(),v.subVectors(new THREE.Vector2(f.x,f.y),new THREE.Vector2(m.x,m.y)).normalize();var E=g.angle()-v.angle(),x=(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(0,0,E));r.matrix.multiply(x),r.matrix.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(),c[a]=x}return c}),renameBones:function(e,t){for(var i=this.getBones(e),r=0;r<i.length;++r){var n=i[r];t[n.name]&&(n.name=t[n.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var i=0,r=this.getBones(t);i<r.length;i++)if(e===r[i].name)return r[i]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){for(var i=/\[(.*)\]\.(.*)/,r={name:e},n=0;n<t.length;++n){var a=i.exec(t[n].name);a&&e===a[1]&&(r[a[2]]=n)}return r},getEqualsBonesNames:function(e,t){var i=this.getBones(e),r=this.getBones(t),n=[];e:for(var a=0;a<i.length;a++)for(var s=i[a].name,o=0;o<r.length;o++)if(s===r[o].name){n.push(s);continue e}return n},clone:function(e){var t=new Map,i=new Map,r=e.clone();return this.parallelTraverse(e,r,(function(e,r){t.set(r,e),i.set(e,r)})),r.traverse((function(e){if(e.isSkinnedMesh){var r=e,n=t.get(e),a=n.skeleton.bones;r.skeleton=n.skeleton.clone(),r.bindMatrix.copy(n.bindMatrix),r.skeleton.bones=a.map((function(e){return i.get(e)})),r.bind(r.skeleton,r.bindMatrix)}})),r}},function(){function e(e,r,a){a=a||2;var s,o,l,c,u,m,f,g=r&&r.length,v=g?r[0]*a:e.length,y=t(e,0,v,a,!0),M=[];if(!y||y.next===y.prev)return M;if(g&&(y=function(e,r,n,a){var s,o,l,c=[];for(s=0,o=r.length;s<o;s++)(l=t(e,r[s]*a,s<o-1?r[s+1]*a:e.length,a,!1))===l.next&&(l.steiner=!0),c.push(p(l));for(c.sort(d),s=0;s<c.length;s++)h(c[s],n),n=i(n,n.next);return n}(e,r,y,a)),e.length>80*a){s=l=e[0],o=c=e[1];for(var E=a;E<v;E+=a)(u=e[E])<s&&(s=u),(m=e[E+1])<o&&(o=m),u>l&&(l=u),m>c&&(c=m);f=0!==(f=Math.max(l-s,c-o))?1/f:0}return n(y,M,a,s,o,f),M}function t(e,t,i,r,n){var a,s;if(n===S(e,t,i,r)>0)for(a=t;a<i;a+=r)s=b(a,e[a],e[a+1],s);else for(a=i-r;a>=t;a-=r)s=b(a,e[a],e[a+1],s);return s&&v(s,s.next)&&(I(s),s=s.next),s}function i(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!v(r,r.next)&&0!==g(r.prev,r,r.next))r=r.next;else{if(I(r),(r=t=r.prev)===r.next)break;i=!0}}while(i||r!==t);return t}function n(e,t,r,d,h,c,p){if(e){!p&&c&&function(e,t,i,r){var n=e;do{null===n.z&&(n.z=u(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,i,r,n,a,s,o,l,d=1;do{for(i=e,e=null,a=null,s=0;i;){for(s++,r=i,o=0,t=0;t<d&&(o++,r=r.nextZ);t++);for(l=d;o>0||l>0&&r;)0!==o&&(0===l||!r||i.z<=r.z)?(n=i,i=i.nextZ,o--):(n=r,r=r.nextZ,l--),a?a.nextZ=n:e=n,n.prevZ=a,a=n;i=r}a.nextZ=null,d*=2}while(s>1)}(n)}(e,d,h,c);for(var m,f,g=e;e.prev!==e.next;)if(m=e.prev,f=e.next,c?s(e,d,h,c):a(e))t.push(m.i/r),t.push(e.i/r),t.push(f.i/r),I(e),e=f.next,g=f.next;else if((e=f)===g){p?1===p?n(e=o(i(e),t,r),t,r,d,h,c,2):2===p&&l(e,t,r,d,h,c):n(i(e),t,r,d,h,c,1);break}}}function a(e){var t=e.prev,i=e,r=e.next;if(g(t,i,r)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(m(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&g(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function s(e,t,i,r){var n=e.prev,a=e,s=e.next;if(g(n,a,s)>=0)return!1;for(var o=n.x<a.x?n.x<s.x?n.x:s.x:a.x<s.x?a.x:s.x,l=n.y<a.y?n.y<s.y?n.y:s.y:a.y<s.y?a.y:s.y,d=n.x>a.x?n.x>s.x?n.x:s.x:a.x>s.x?a.x:s.x,h=n.y>a.y?n.y>s.y?n.y:s.y:a.y>s.y?a.y:s.y,c=u(o,l,t,i,r),p=u(d,h,t,i,r),f=e.prevZ,v=e.nextZ;f&&f.z>=c&&v&&v.z<=p;){if(f!==e.prev&&f!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,v!==e.prev&&v!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;v&&v.z<=p;){if(v!==e.prev&&v!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function o(e,t,r){var n=e;do{var a=n.prev,s=n.next.next;!v(a,s)&&y(a,n,n.next,s)&&x(a,s)&&x(s,a)&&(t.push(a.i/r),t.push(n.i/r),t.push(s.i/r),I(n),I(n.next),n=e=s),n=n.next}while(n!==e);return i(n)}function l(e,t,r,a,s,o){var l=e;do{for(var d=l.next.next;d!==l.prev;){if(l.i!==d.i&&f(l,d)){var h=_(l,d);return l=i(l,l.next),h=i(h,h.next),n(l,t,r,a,s,o),void n(h,t,r,a,s,o)}d=d.next}l=l.next}while(l!==e)}function d(e,t){return e.x-t.x}function h(e,t){if(t=function(e,t){var i,r=t,n=e.x,a=e.y,s=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var o=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=n&&o>s){if(s=o,o===n){if(a===r.y)return r;if(a===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(n===s)return i;var l,d=i,h=i.x,u=i.y,p=1/0;r=i;do{n>=r.x&&r.x>=h&&n!==r.x&&m(a<u?n:s,a,h,u,a<u?s:n,a,r.x,r.y)&&(l=Math.abs(a-r.y)/(n-r.x),x(r,e)&&(l<p||l===p&&(r.x>i.x||r.x===i.x&&c(i,r)))&&(i=r,p=l)),r=r.next}while(r!==d);return i}(e,t),t){var r=_(t,e);i(t,t.next),i(r,r.next)}}function c(e,t){return g(e.prev,e,t.prev)<0&&g(t.next,e,e.next)<0}function u(e,t,i,r,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function m(e,t,i,r,n,a,s,o){return(n-s)*(t-o)-(e-s)*(a-o)>=0&&(e-s)*(r-o)-(i-s)*(t-o)>=0&&(i-s)*(a-o)-(n-s)*(r-o)>=0}function f(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&y(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(x(e,t)&&x(t,e)&&function(e,t){var i=e,r=!1,n=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&n<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(g(e.prev,e,t.prev)||g(e,t.prev,t))||v(e,t)&&g(e.prev,e,e.next)>0&&g(t.prev,t,t.next)>0)}function g(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function v(e,t){return e.x===t.x&&e.y===t.y}function y(e,t,i,r){var n=E(g(e,t,i)),a=E(g(e,t,r)),s=E(g(i,r,e)),o=E(g(i,r,t));return n!==a&&s!==o||(!(0!==n||!M(e,i,t))||(!(0!==a||!M(e,r,t))||(!(0!==s||!M(i,e,r))||!(0!==o||!M(i,t,r)))))}function M(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function E(e){return e>0?1:e<0?-1:0}function x(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function _(e,t){var i=new T(e.i,e.x,e.y),r=new T(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,a.next=r,r.prev=a,r}function b(e,t,i,r){var n=new T(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function I(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function T(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function S(e,t,i,r){for(var n=0,a=t,s=i-r;a<i;a+=r)n+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return n}e.deviation=function(e,t,i,r){var n=t&&t.length,a=n?t[0]*i:e.length,s=Math.abs(S(e,0,a,i));if(n)for(var o=0,l=t.length;o<l;o++){var d=t[o]*i,h=o<l-1?t[o+1]*i:e.length;s-=Math.abs(S(e,d,h,i))}var c=0;for(o=0;o<r.length;o+=3){var u=r[o]*i,p=r[o+1]*i,m=r[o+2]*i;c+=Math.abs((e[u]-e[m])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[m+1]-e[u+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,n=0;n<e.length;n++){for(var a=0;a<e[n].length;a++)for(var s=0;s<t;s++)i.vertices.push(e[n][a][s]);n>0&&(r+=e[n-1].length,i.holes.push(r))}return i},r.earcut=e}(),function(){const e=new THREE.Box3,t=new THREE.Matrix4;function i(e,t){const i=t.position[0].x+t.position[1].x+t.position[0].y+t.position[1].y+t.position[0].z+t.position[1].z;for(let r=e.length-1;r>=0;--r){const n=e[r];if(i>n.position[0].x+n.position[1].x+n.position[0].y+n.position[1].y+n.position[0].z+n.position[1].z)return void e.splice(r+1,0,t)}e.unshift(t)}r.ClippingBorderLineUtil=class{static connectLineSegment(e,t,n){if(e.length<6||e.length%6!=0)return;if(e.length>1e4)return void(e.length=0);const a=new Map;for(let t=0;t<e.length;t+=6){let s={position:[]};for(let i=0;i<6;i+=3)s.position[i/3]=new THREE.Vector3(e[t+i],e[t+i+1],e[t+i+2]),s.position[i/3].applyMatrix4(n);s.direction=(new THREE.Vector3).subVectors(s.position[1],s.position[0]).normalize(),s.negateDirection=s.direction.clone().negate();let o=!1;for(let e of a){const t=e[0];(r.Math.equalsEpsilonVec3(s.direction,t,r.Math.EPSILON3)||r.Math.equalsEpsilonVec3(s.negateDirection,t,r.Math.EPSILON3))&&(i(e[1],s),o=!0)}o||a.set(s.direction.clone(),[s])}let s=[];t||(t=[]);for(const i of a.values()){let n=i[0];for(i.splice(0,1),t.push([n]),e.splice(0,e.length);i.length>0;){const e=n.position[0],t=n.position[1];let a=(o=t,e.distanceTo(o)<1?r.Math.EPSILON5:r.Math.EPSILON4);const l=n.direction,d=n.negateDirection;let h=!1;for(let s=0;s<i.length;++s){const o=i[s],c=o.direction;if(r.Math.equalsEpsilonVec3(c,l,r.Math.EPSILON3)){const l=o.position[0],d=o.position[1];if(r.Math.equalsEpsilonVec3(t,l,a)){n.position[1]=d,i.splice(s,1),h=!0;break}if(r.Math.equalsEpsilonVec3(e,d,a)){n.position[0]=l,i.splice(s,1),h=!0;break}}else if(r.Math.equalsEpsilonVec3(c,d,r.Math.EPSILON3)){const l=o.position[1],d=o.position[0];if(r.Math.equalsEpsilonVec3(t,l,a)){n.position[1]=d,i.splice(s,1),h=!0;break}if(r.Math.equalsEpsilonVec3(e,d,a)){n.position[0]=l,i.splice(s,1),h=!0;break}}}h||(s.push(n),n=i[0],i.splice(0,1))}s.push(n)}var o;for(let t=0;t<s.length;++t){const i=s[t].position[0],r=s[t].position[1];e.push(...i.toArray()),e.push(...r.toArray())}}static tryClosedLineSegment(e,t){function i(t){const n=t[0].position[0],a=t[t.length-1].position[1],s=(new THREE.Vector3).lerpVectors(n,a,.5);let o=!1;for(let i=e.length-1;i>=0;--i){const l=e[i][0].position[0],d=e[i][e[i].length-1].position[1],h=(new THREE.Vector3).lerpVectors(l,d,.5);if(1!==t.length||1!==e[i].length||!r.Math.equalsEpsilonVec3(s,h,r.Math.EPSILON4))if(r.Math.equalsEpsilonVec3(l,a,r.Math.EPSILON4))t.push(...e[i]),e.splice(i,1),o=!0;else if(r.Math.equalsEpsilonVec3(d,n,r.Math.EPSILON4))e[i].push(...t),t=e[i],e.splice(i,1),o=!0;else if(r.Math.equalsEpsilonVec3(d,a,r.Math.EPSILON4)){let r=[];for(let t=0;t<e[i].length;++t){let n=e[i][t];const a=n.position[0];n.position[0]=n.position[1],n.position[1]=a,n.direction.negate(),n.negateDirection.negate(),r.unshift(n)}t.push(...r),e.splice(i,1),o=!0}else if(r.Math.equalsEpsilonVec3(l,n,r.Math.EPSILON4)){let r=[];for(let t=0;t<e[i].length;++t){let n=e[i][t];const a=n.position[0];n.position[0]=n.position[1],n.position[1]=a,n.direction.negate(),n.negateDirection.negate(),r.unshift(n)}r.push(...t),t=r,e.splice(i,1),o=!0}}return o?i(t):t}for(;e.length>0;){let n=e[0];e.splice(0,1),n.isClosed||(n=i(n),n.length>2&&r.Math.equalsEpsilonVec3(n[0].position[0],n[n.length-1].position[1],r.Math.EPSILON4)&&(n.isClosed=!0),t.push(n))}return t}static calculateIntersection(i,n,a,s){let o=[];if(a.box){const e=.5*Math.pow(a.box.min.distanceTo(a.box.max),2);if((a.positionCount?a.positionCount:n.geometry.attributes.position.count)/e>1e3)return o}if(a.isInstance="InstancedBufferGeometry"===n.geometry.type,n.getIntersectionPoints(i,a,o,e),delete a.isInstance,0===o.length)return o;if(t.copy(s.transformMatrix),t.multiply(n.matrix),o.length>300){e.min.applyMatrix4(t),e.max.applyMatrix4(t);const r=new THREE.Vector3,n=new THREE.Vector3;i.projectPoint(e.min,r),i.projectPoint(e.max,n);.5*Math.pow(r.distanceTo(n),2)/o.length/3<.01&&o.splice(6,o.length)}return r.ClippingBorderLineUtil.connectLineSegment(o,[],t),o}static push(e,t,i,r,n){let a;if(e.tilesLoader?(a=e.tilesLoader.tileReader.getUserIdByIndex(n),e.mapClippingIds.set(n,!0)):(a=String(n),e.mapClippingIds.set(a,!0)),t.length>0){const n=i.length;i.push(...t);const s=i.length,o=r.get(e);o.has(a)?o.get(a).push([n,s]):o.set(a,[[n,s]])}}static BoxContainsPoint(e,t){return!(t.x<e.min.x-r.Math.EPSILON5||t.x>e.max.x+r.Math.EPSILON5||t.y<e.min.y-r.Math.EPSILON5||t.y>e.max.y+r.Math.EPSILON5||t.z<e.min.z-r.Math.EPSILON5||t.z>e.max.z+r.Math.EPSILON5)}}}(),(()=>{let e=new Map;r.GeoBoundingSphereUtil={getBoundingSphere:t=>e.has(t)?e.get(t):null,setBoundingSphere(t,i){e.size>5e3&&e.clear(),e.set(t,i)},createGeometryId:(e,t)=>`${e.id}_${t.positionStart}_${t.positionEnd}`}})(),r.ThreeHelper={destroyObject3D(e){e.parent=null,e.children=null,e.up=null,e.matrix=null,e.matrixWorld=null,e.layers=null,e.animations=null,e.userData=null,e.onBeforeRender=null,e.onAfterRender=null},destroyCamera(e){e.matrixWorldInverse=null,e.projectionMatrix=null,e.projectionMatrixInverse=null,r.ThreeHelper.destroyObject3D(e)},destroyOrthographicCamera(e){e.view=null,r.ThreeHelper.destroyCamera(e)},destroyPerspectiveCamera(e){e.view=null,r.ThreeHelper.destroyCamera(e)},destroyFrustum(e){e.planes=null}},r.Math={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,ONE_Megabytes:1048576,ONE_GIGABYTES:1073741824,TWO_PI:2*Math.PI,PI_OVER_TWO:Math.PI/2,RADIANS_PER_DEGREE:Math.PI/180,RADIANS_PER_ARCSECOND:Math.PI/180/3600,mod:function(e,t){return(e%t+t)%t},clamp:function(e,t,i){return e<t?t:e>i?i:e},normalize:function(e,t,i){return 0===(i=Math.max(i-t,0))?0:r.Math.clamp((e-t)/i,0,1)},isolateDigits:function(e,t,i){return parseInt(e*Math.pow(10,t))*Math.pow(10,i)},equalsEpsilon:function(e,t,i,r){r=void 0!==r?r:i;var n=Math.abs(e-t);return n<=r||n<=i*Math.max(Math.abs(e),Math.abs(t))},lessThan:function(e,t,i){return e-t<-i},lessThanOrEquals:function(e,t,i){return e-t<i},greaterThan:function(e,t,i){return e-t>i},greaterThanOrEquals:function(e,t,i){return e-t>-i},equalsEpsilonVec3:function(e,t,i){return r.Math.equalsEpsilon(e.x,t.x,i)&&r.Math.equalsEpsilon(e.y,t.y,i)&&r.Math.equalsEpsilon(e.z,t.z,i)},equalsEpsilonMatrix4:function(e,t,i){i=i||0;const n=e.elements,a=t.elements;for(let e=0;e<16;e++)if(!r.Math.equalsEpsilon(n[e],a[e],i))return!1;return!0},equalsEpsilonQuaternion:function(e,t,i){return i=i||0,r.Math.equalsEpsilon(e._x,t._x,i)&&r.Math.equalsEpsilon(e._y,t._y,i)&&r.Math.equalsEpsilon(e._z,t._z,i)&&r.Math.equalsEpsilon(e._w,t._w,i)},equalsEpsilonFrustum:function(e,t,i){i=i||0;const n=e.planes,a=t.planes;for(let e=0;e<6;e++)if(!r.Math.equalsEpsilonVec3(n[e].normal,a[e].normal,i)||!r.Math.equalsEpsilon(n[e].constant,a[e].constant,i))return!1;return!0},transformFrustum:function(e,t,i){return void 0===i&&(i=new THREE.Frustum),i.copy(e),i.planes.forEach((e=>{e.applyMatrix4(t)})),i},incrementWrap:function(e,t,i){return i=void 0!==i?i:0,++e>t&&(e=i),e},isPowerOfTwo:function(e){return 0!==e&&0==(e&e-1)},nextPowerOfTwo:function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},maxComponent:function(e,t){var i=Math.max(Math.abs(e.x),Math.abs(t.x)),r=Math.max(Math.abs(e.y),Math.abs(t.y)),n=Math.max(Math.abs(e.z),Math.abs(t.z));return Math.max(Math.max(i,r),n)},getMatrix3:function(e){var t=e.elements,i=new THREE.Matrix3;return i.elements[0]=t[0],i.elements[1]=t[1],i.elements[2]=t[2],i.elements[3]=t[4],i.elements[4]=t[5],i.elements[5]=t[6],i.elements[6]=t[8],i.elements[7]=t[9],i.elements[8]=t[10],i},bezierCurveFn:function(e,t,i,r){return r>1&&(r=1),(1-r)*(1-r)*e+2*r*(1-r)*t+r*r*i},tweens:function(e,t,i,r){var n=i%r/r;return n<0&&(n*=-1),n>1&&(n=1),this.linear([e,t],n)},breatheTweens:function(e,t,i,r){var n=i%r/(.5*r)-1;return n<0&&(n*=-1),n>1&&(n=1),this.linear([e,t],n)},linear:function(e,t){var i=this,r=e.length-1,n=r*t,a=Math.floor(n);return t<0?i.linearFn(e[0],e[1],n):t>1?i.linearFn(e[r],e[r-1],r-n):i.linearFn(e[a],e[a+1>r?r:a+1],n-a)},linearFn:function(e,t,i){return(t-e)*i+e},negativePiToPi(e){if(!r.Utils.defined(e))throw new Error("angle is required.");return this.zeroToTwoPi(e+Math.PI)-Math.PI},zeroToTwoPi(e){if(!r.Utils.defined(e))throw new Error("angle is required.");var t=this.mod(e,this.TWO_PI);return Math.abs(t)<this.EPSILON14&&Math.abs(e)>this.EPSILON14?TWO_PI:t},equalsEpsilon(e,t,i,n){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");i=r.Utils.defaultValue(i,0),n=r.Utils.defaultValue(n,i);var a=Math.abs(e-t);return a<=n||a<=i*Math.max(Math.abs(e),Math.abs(t))},equalsEpsilonVector3(e,t,i,n){return e===t||r.Utils.defined(e)&&r.Utils.defined(t)&&this.equalsEpsilon(e.x,t.x,i,n)&&this.equalsEpsilon(e.y,t.y,i,n)&&this.equalsEpsilon(e.z,t.z,i,n)},isMirror(e){const t=r.Utils.scratchVector_1,i=r.Utils.scratchVector_2,n=r.Utils.scratchVector_3,a=e.elements,s=t.set(a[0],a[1],a[2]),o=i.set(a[4],a[5],a[6]),l=n.set(a[8],a[9],a[10]);return s.cross(o).dot(l)<0},isIdentityMatrix4(e){const t=e.elements;for(let e=0;e<16;e++)if(0==e||5==e||10==e||15==e){if(1!==t[e])return!1}else if(0!==t[e])return!1;return!0},signNotZero:e=>e<0?-1:1,toSNorm:(e,t)=>(t=r.Utils.defaultValue(t,255),Math.round((.5*r.Math.clamp(e,-1,1)+.5)*t)),octEncode(e,t){let i=e.lengthSq();if(Math.abs(i-1)>r.Math.EPSILON6)throw"vector must be normalized.";if((t=r.Utils.isDefined(t)?t:new THREE.Vector2).x=e.x/(Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z)),t.y=e.y/(Math.abs(e.x)+Math.abs(e.y)+Math.abs(e.z)),e.z<0){let e=t.x,i=t.y;t.x=(1-Math.abs(i))*r.Math.signNotZero(e),t.y=(1-Math.abs(e))*r.Math.signNotZero(i)}return t.x=r.Math.toSNorm(t.x,255),t.y=r.Math.toSNorm(t.y,255),t},octDecode(e,t){if(t=r.Utils.isDefined(t)?t:new THREE.Vector3,e.x<r.Math.EPSILON10&&e.y<r.Math.EPSILON10)return t.set(0,0,0),t;let i=e.x/255*2-1,n=e.y/255*2-1;if(t.set(i,n,1-Math.abs(i)-Math.abs(n)),t.z<0){let e=i>=0?1:-1,r=n>=0?1:-1;i=(1-Math.abs(t.y))*e,n=(1-Math.abs(t.x))*r,t.x=i,t.y=n}return t.normalize()}},r.Debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,DebugColor:{BLACK:0,WHITE:16777215,RED:16711680,GREEN:65280,BLUE:255,YELLOW:16776960,ORANGE:16753920,GRAY:8421504,GOLD:16766720},DebugColorArray:[16776960,16711680,65280,255],activate:function(){r.Debug.isActive=!0},deactivate:function(){r.Debug.isActive=!1},doLog:function(e,t){if(r.Debug.isActive)switch(e){case r.Debug.INFO:console.info(t);break;case r.Debug.WARNING:console.warn(t);break;case r.Debug.ERROR:console.error(t);break;case r.Debug.EXCEPTION:console.debug(t)}},logInfo:function(e){r.Debug.doLog(r.Debug.INFO,e)},logWarning:function(e){r.Debug.doLog(r.Debug.WARNING,e)},logError:function(e){r.Debug.doLog(r.Debug.ERROR,e)},logException:function(e){r.Debug.doLog(r.Debug.EXCEPTION,e)}},r.Runtime=function(){this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},r.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},r.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},r.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},r.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},r.Runtime.prototype.getFPS=function(){return this.fps},function(){function e(e,t){return t-e}r.Event=class{constructor(){this._listeners=[],this._scopes=[],this._toRemove=[],this._insideFireEvent=!1}addEventListener(e,t){this._listeners.push(e),this._scopes.push(t);var i=this;return function(){i.removeEventListener(e,t)}}removeEventListener(e,t){for(var i=this._listeners,r=this._scopes,n=-1,a=0;a<i.length;a++)if(i[a]===e&&r[a]===t){n=a;break}return-1!==n&&(this._insideFireEvent?(this._toRemove.push(n),i[n]=void 0,r[n]=void 0):(i.splice(n,1),r.splice(n,1)),!0)}fireEvent(){var t;this._insideFireEvent=!0;var i=this._listeners,r=this._scopes,n=i.length;for(t=0;t<n;t++){i[t]&&i[t].apply(r[t],arguments)}var a=this._toRemove;if((n=a.length)>0){for(a.sort(e),t=0;t<n;t++){var s=a[t];i.splice(s,1),r.splice(s,1)}a.length=0}this._insideFireEvent=!1}}}(),I=0,r.EVENTS={ERROR:I++,WEBGL_CONTEXT_LOST:I++,WEBGL_CONTEXT_RESTORED:I++,ON_LOAD_START_NO_PROGRESS:I++,ON_LOAD_START:I++,ON_LOAD_PROGRESS:I++,ON_LOAD_COMPLETE:I++,ON_MODEL_CACHE_COMPLETE:I++,ON_LOAD_EMPTY_SCENE:I++,ON_LOAD_INVALID_SCENE:I++,ON_LOAD_INVALID_MODEL_VERSION:I++,ON_DEMAND_LOAD_START:I++,ON_DEMAND_LOAD_PROGRESS:I++,ON_DEMAND_LOAD_COMPLETE:I++,ON_TILES_LOAD_INITIAL:I++,ON_TILES_LOAD_PROGRESS:I++,ON_TILES_LOAD_COMPLETE:I++,ON_TILES_LOAD_ISOLATE:I++,ON_TILES_LOAD_MODEL_INITIAL:I++,ON_EDITOR_ENTER:I++,ON_EDITOR_EXIST:I++,ON_EDITOR_BEGIN:I++,ON_EDITOR_END:I++,ON_TOOL_END:I++,ON_OVERRIDE_CHANGED:I++,ON_EDITOR_UPDATEUI:I++,ON_EDITOR_ZOOM:I++,ON_EDITOR_PANING:I++,ON_EDITOR_ROTATING:I++,ON_EDITOR_WALKING:I++,ON_VOLUME_MEASURE_END:I++,ON_EDITOR_ZOOM_END:I++,ON_SELECTION_CHANGED:I++,ON_CLICK_PICK:I++,ON_CLICK_MARKER3D_PICK:I++,ON_HOVER_PICK:I++,ON_MOUSE_MOVE_PICK:I++,ON_MEASURE_PICK:I++,ON_MEASURE_RESET:I++,ON_SELECTION_FAILED:I++,ON_CLIP_HOVER:I++,ON_HOVER_SNAP:I++,ON_CLIP_MOUSE_MOVE:I++,ON_CLIP_PLANE_MOUSE_MOVE:I++,ON_CLIP_MOUSE_MOVE_END:I++,ON_MOUSE_DRAGGED:I++,ON_CAMERA_CHANGED_AND_RENDERED:I++,ON_CAMERA_CHANGED:I++,ON_CAMERA_CHANGED_END:I++,ON_VERSION_NO_MATCH:I++,ON_AXIS_GRID_HOVER:I++,ON_VIEWER_RESTORED:I++,ON_EARTH_ANIMATION_COMPLETE:I++,ON_CAMERA_HEIGHT_CHANGED:I++,ON_CAMERA_ANIMATION_UPDATE:I++,ON_FLOOR_EXPLOSION:I++,ON_EXPLOSION:I++,ON_PRE_UPDATE:I++,ON_POST_UPDATE:I++,ON_PRE_RENDER:I++,ON_POST_RENDER:I++,ON_MAP_CREATED:I++,ON_MAP_LOAD_ALL:I++},function(){class e extends THREE.EventDispatcher{constructor(){super()}destroy(){this._listeners=void 0}}r.EventDispatcher=e,r.eventsDispatcher=new r.EventDispatcher}(),function(){var e=0;r.ERRORS={DEVELOPE_EXCEPTION:e++,INVALID_FRAMEBUFFER:e++,WEBGL_NOT_SUPPORTED:e++,WEBGL_CONTEXT_LOST:e++};class t extends Error{constructor(e,t){super(),this.name=this._getName(e),this.message=t||"N/A",this.stack=(new Error).stack}_getName(e){for(const t in r.ERRORS)if(r.ERRORS[t]===e)return t;return null}toString(){let e=this.name+": "+this.message;return this.stack&&(e+="\n"+this.stack.toString()),e}static throwError(e,i){throw new t(e,i)}}r.Error=t}(),function(){class e{constructor(e,t){this.canvasId=e||0,this.domContainer=t;var i=document.createElement("div");this.domContainer.appendChild(i),this.canvas=this._createHTMLCanvas(i)}destroy(){var e=this.canvas.parentNode;e&&(e.removeChild(this.canvas),this.domContainer.removeChild(e),e=null),this.canvas=null,this.domContainer=null}addEventListener(e,t,i){this.canvas.addEventListener(e,t,i)}removeEventListener(e,t,i){this.canvas.removeEventListener(e,t,i)}_createHTMLCanvas(e){var t=document.createElement("canvas");return t.setAttribute("id","cloud-canvas-"+this.canvasId),t.setAttribute("class","cloud-main-canvas"),t.setAttribute("tabindex","0"),e.appendChild(t),t}initWebGL(){for(var t=e.WEBGL_CONTEXT_NAMES,i=0;!this.gl&&i<t.length;i++)try{this.gl=this.canvas.getContext(t[i],this.contextAttr)}catch(e){}if(!this.gl)throw r.Error.fatalError(r.ErrorTypes.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")}loseWebGLContext(){this.canvas.loseContext()}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}}e.WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],r.Canvas=e}(),function(){function e(e,t){t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=void 0,e.tail=t.previous):t.next?(t.next.previous=void 0,e.head=t.next):(e.head=void 0,e.tail=void 0),t.next=void 0,t.previous=void 0}function t(e,t){return e.item.level<t.item.level?-1:e.item.level>t.item.level?1:0}class i{constructor(e,t,i){this.item=e,this.previous=t,this.next=i}}r.DoublyLinkedList=class{constructor(){this.head=void 0,this.tail=void 0,this._length=0}get length(){return this._length}add(e){const t=new i(e,this.tail,void 0);return this.tail?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(t){t&&(e(this,t),--this._length)}splice(t,i){if(t===i)return;e(this,i);const r=t.next;t.next=i,this.tail===t?this.tail=i:r.previous=i,i.next=r,i.previous=t}partialSort(e){e&&e.previous&&this.head&&this.head!==e&&this.head.next!==e&&(this.head=function(e,t,i){if(e===t||e.next===t)return e;let r,n,a=e;for(a=a.next;a!==t;a=a.next){for(n=a,r=a.previous;r!==e.previous&&!(i(r,n)>=0);r=r.previous);r!==e.previous?r.next!==a&&(n.previous.next=n.next,n.next.previous=n.previous,n.next=r.next,r.next.previous=n,n.previous=r,r.next=n):(n.previous.next=n.next,n.next.previous=n.previous,n.next=e,n.previous=e.previous,e.previous=n,e=n)}return e}(this.head,e,t))}}}(),function(){function e(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}r.Heap=class{constructor(e){this._comparator=e.comparator,this._array=[],this._length=0,this._maximumLength=void 0}destroy(){this._comparator=void 0,this._array=void 0}get length(){return this._length}get internalArray(){return this._array}get maximumLength(){return this._maximumLength}set maximumLength(e){var t=this._length;if(e<t){for(var i=this._array,r=e;r<t;++r)i[r]=void 0;this._length=e,i.length=e}this._maximumLength=e}get comparator(){return this._comparator}reserve(e){e=e||this._length,this._array.length=e}heapify(t){t=t||0;for(var i=this._length,r=this._comparator,n=this._array,a=-1,s=!0;s;){var o=2*(t+1),l=o-1;a=l<i&&r(n[l],n[t])<0?l:t,o<i&&r(n[o],n[a])<0&&(a=o),a!==t?(e(n,a,t),t=a):s=!1}}resort(){for(var e=this._length,t=Math.ceil(e/2);t>=0;--t)this.heapify(t)}insert(t){var i,r=this._array,n=this._comparator,a=this._maximumLength,s=this._length++;for(s<r.length?r[s]=t:r.push(t);0!==s;){var o=Math.floor((s-1)/2);if(!(n(r[s],r[o])<0))break;e(r,s,o),s=o}return null!=a&&this._length>a&&(i=r[a],this._length=a),i}pop(t){if(t=t||0,0!==this._length){var i=this._array,r=i[t];return e(i,t,--this._length),this.heapify(t),i[this._length]=void 0,r}}}}(),r.Deferred=class{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=function(t){e(t)},this.reject=function(e){t(e)}})),this.resolver={resolve:this.resolve,reject:this.reject}}destroy(){this.resolver.resolve=void 0,this.resolver.reject=void 0,this.resolver=void 0,this.resolve=void 0,this.reject=void 0,this.promise=void 0}},r.TaskRunner=class{constructor(e){this.limit=e||5,this.store=[],this.active=0}next(){this.store.length&&this.runTask(...this.store.shift())}runTask(e,t,i){this.active++;var r=this;e.call(t.that,t,(function(e){r.active--,i&&i(e),r.next()}))}push(e,t,i){this.active<this.limit?this.runTask(e,t,i):this.store.push([e,t,i])}},r.LoadTaskRunner=class{constructor(e){this.limit=e||6,this.store=[],this.active=0,this.destroyed=!1,this.retryTimes=2,this.retryUrlMap={}}destroy(){this.destroyed=!0,this.store=[],this.retryUrlMap={}}isDestroyed(){return this.destroyed}next(){this.isDestroyed()||this.store.length&&this.runTask(...this.store.shift())}runTask(e,t,i,r){this.isDestroyed()||(this.initRetryCount(t),this.active++,e.load(t,(e=>{this.active--,i&&i(e),this.removeRetryCount(t),this.next()}),void 0,(n=>{this.active--,r&&r(n),this.retryOnError(t)?this.push(e,t,i,r):this.removeRetryCount(t),this.next()})))}push(e,t,i,r){this.isDestroyed()||(this.active<this.limit?this.runTask(e,t,i,r):this.store.push([e,t,i,r]))}initRetryCount(e){this.retryUrlMap[e]||(this.retryUrlMap[e]=0)}removeRetryCount(e){this.retryUrlMap[e]&&delete this.retryUrlMap[e]}retryOnError(e){return!(this.retryUrlMap[e]>=this.retryTimes||(++this.retryUrlMap[e],0))}},THREE.Face3=class{constructor(e,t,i,r,n,a=0){this.a=e,this.b=t,this.c=i,this.normal=r&&r.isVector3?r:new THREE.Vector3,this.vertexNormals=Array.isArray(r)?r:[],this.color=n&&n.isColor?n:new THREE.Color,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=a}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}},(()=>{const e=new THREE.Matrix4,t=new THREE.Object3D,i=new THREE.Vector3;function r(){this.uuid=THREE.MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}r.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:r,isGeometry:!0,applyMatrix4:function(e){const t=(new THREE.Matrix3).getNormalMatrix(e);for(let t=0,i=this.vertices.length;t<i;t++){this.vertices[t].applyMatrix4(e)}for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];i.normal.applyMatrix3(t).normalize();for(let e=0,r=i.vertexNormals.length;e<r;e++)i.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(t){return e.makeRotationX(t),this.applyMatrix4(e),this},rotateY:function(t){return e.makeRotationY(t),this.applyMatrix4(e),this},rotateZ:function(t){return e.makeRotationZ(t),this.applyMatrix4(e),this},translate:function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix4(e),this},scale:function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix4(e),this},lookAt:function(e){return t.lookAt(e),t.updateMatrix(),this.applyMatrix4(t.matrix),this},fromBufferGeometry:function(e){const t=this,i=null!==e.index?e.index:void 0,r=e.attributes;if(void 0===r.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const n=r.position,a=r.normal,s=r.color,o=r.uv,l=r.uv2;void 0!==l&&(this.faceVertexUvs[1]=[]);for(let e=0;e<n.count;e++)t.vertices.push((new THREE.Vector3).fromBufferAttribute(n,e)),void 0!==s&&t.colors.push((new THREE.Color).fromBufferAttribute(s,e));function d(e,i,r,n){const d=void 0===s?[]:[t.colors[e].clone(),t.colors[i].clone(),t.colors[r].clone()],h=void 0===a?[]:[(new THREE.Vector3).fromBufferAttribute(a,e),(new THREE.Vector3).fromBufferAttribute(a,i),(new THREE.Vector3).fromBufferAttribute(a,r)],c=new THREE.Face3(e,i,r,h,d,n);t.faces.push(c),void 0!==o&&t.faceVertexUvs[0].push([(new THREE.Vector2).fromBufferAttribute(o,e),(new THREE.Vector2).fromBufferAttribute(o,i),(new THREE.Vector2).fromBufferAttribute(o,r)]),void 0!==l&&t.faceVertexUvs[1].push([(new THREE.Vector2).fromBufferAttribute(l,e),(new THREE.Vector2).fromBufferAttribute(l,i),(new THREE.Vector2).fromBufferAttribute(l,r)])}const h=e.groups;if(h.length>0)for(let e=0;e<h.length;e++){const t=h[e],r=t.start;for(let e=r,n=r+t.count;e<n;e+=3)void 0!==i?d(i.getX(e),i.getX(e+1),i.getX(e+2),t.materialIndex):d(e,e+1,e+2,t.materialIndex)}else if(void 0!==i)for(let e=0;e<i.count;e+=3)d(i.getX(e),i.getX(e+1),i.getX(e+2));else for(let e=0;e<n.count;e+=3)d(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(i).negate(),this.translate(i.x,i.y,i.z),this},normalize:function(){this.computeBoundingSphere();const e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,r=new THREE.Matrix4;return r.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix4(r),this},computeFaceNormals:function(){const e=new THREE.Vector3,t=new THREE.Vector3;for(let i=0,r=this.faces.length;i<r;i++){const r=this.faces[i],n=this.vertices[r.a],a=this.vertices[r.b],s=this.vertices[r.c];e.subVectors(s,a),t.subVectors(n,a),e.cross(t),e.normalize(),r.normal.copy(e)}},computeVertexNormals:function(e=!0){const t=new Array(this.vertices.length);for(let e=0,i=this.vertices.length;e<i;e++)t[e]=new THREE.Vector3;if(e){const e=new THREE.Vector3,i=new THREE.Vector3;for(let r=0,n=this.faces.length;r<n;r++){const n=this.faces[r],a=this.vertices[n.a],s=this.vertices[n.b],o=this.vertices[n.c];e.subVectors(o,s),i.subVectors(a,s),e.cross(i),t[n.a].add(e),t[n.b].add(e),t[n.c].add(e)}}else{this.computeFaceNormals();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];t[i.a].add(i.normal),t[i.b].add(i.normal),t[i.c].add(i.normal)}}for(let e=0,i=this.vertices.length;e<i;e++)t[e].normalize();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e],r=i.vertexNormals;3===r.length?(r[0].copy(t[i.a]),r[1].copy(t[i.b]),r[2].copy(t[i.c])):(r[0]=t[i.a].clone(),r[1]=t[i.b].clone(),r[2]=t[i.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],i=t.vertexNormals;3===i.length?(i[0].copy(t.normal),i[1].copy(t.normal),i[2].copy(t.normal)):(i[0]=t.normal.clone(),i[1]=t.normal.clone(),i[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,i=t.vertexNormals.length;e<i;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}const e=new r;e.faces=this.faces;for(let t=0,i=this.morphTargets.length;t<i;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];const e=this.morphNormals[t].faceNormals,i=this.morphNormals[t].vertexNormals;for(let t=0,r=this.faces.length;t<r;t++){const t=new THREE.Vector3,r={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3};e.push(t),i.push(r)}}const i=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],r=i.faceNormals[e],n=i.vertexNormals[e];r.copy(t.normal),n.a.copy(t.vertexNormals[0]),n.b.copy(t.vertexNormals[1]),n.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i=0){if(!e||!e.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);let r;const n=this.vertices.length,a=this.vertices,s=e.vertices,o=this.faces,l=e.faces,d=this.colors,h=e.colors;void 0!==t&&(r=(new THREE.Matrix3).getNormalMatrix(t));for(let e=0,i=s.length;e<i;e++){const i=s[e].clone();void 0!==t&&i.applyMatrix4(t),a.push(i)}for(let e=0,t=h.length;e<t;e++)d.push(h[e].clone());for(let e=0,t=l.length;e<t;e++){const t=l[e];let a,s;const d=t.vertexNormals,h=t.vertexColors,c=new THREE.Face3(t.a+n,t.b+n,t.c+n);c.normal.copy(t.normal),void 0!==r&&c.normal.applyMatrix3(r).normalize();for(let e=0,t=d.length;e<t;e++)a=d[e].clone(),void 0!==r&&a.applyMatrix3(r).normalize(),c.vertexNormals.push(a);c.color.copy(t.color);for(let e=0,t=h.length;e<t;e++)s=h[e],c.vertexColors.push(s.clone());c.materialIndex=t.materialIndex+i,o.push(c)}for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=i.length;e<r;e++){const r=i[e],n=[];for(let e=0,t=r.length;e<t;e++)n.push(r[e].clone());this.faceVertexUvs[t].push(n)}}},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(e=4){const t={},i=[],r=[],n=Math.pow(10,e);for(let e=0,a=this.vertices.length;e<a;e++){const a=this.vertices[e],s=Math.round(a.x*n)+"_"+Math.round(a.y*n)+"_"+Math.round(a.z*n);void 0===t[s]?(t[s]=e,i.push(this.vertices[e]),r[e]=i.length-1):r[e]=r[t[s]]}const a=[];for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.a=r[t.a],t.b=r[t.b],t.c=r[t.c];const i=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(i[t]===i[(t+1)%3]){a.push(e);break}}for(let e=a.length-1;e>=0;e--){const t=a[e];this.faces.splice(t,1);for(let e=0,i=this.faceVertexUvs.length;e<i;e++)this.faceVertexUvs[e].splice(t,1)}const s=this.vertices.length-i.length;return this.vertices=i,s},setFromPoints:function(e){this.vertices=[];for(let t=0,i=e.length;t<i;t++){const i=e[t];this.vertices.push(new THREE.Vector3(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){const e=this.faces,t=e.length;for(let i=0;i<t;i++)e[i]._id=i;e.sort((function(e,t){return e.materialIndex-t.materialIndex}));const i=this.faceVertexUvs[0],r=this.faceVertexUvs[1];let n,a;i&&i.length===t&&(n=[]),r&&r.length===t&&(a=[]);for(let s=0;s<t;s++){const t=e[s]._id;n&&n.push(i[t]),a&&a.push(r[t])}n&&(this.faceVertexUvs[0]=n),a&&(this.faceVertexUvs[1]=a)},toJSON:function(){const e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}const t=[];for(let e=0;e<this.vertices.length;e++){const i=this.vertices[e];t.push(i.x,i.y,i.z)}const i=[],r=[],n={},a=[],s={},o=[],l={};for(let e=0;e<this.faces.length;e++){const t=this.faces[e],r=!0,n=!1,a=void 0!==this.faceVertexUvs[0][e],s=t.normal.length()>0,o=t.vertexNormals.length>0,l=1!==t.color.r||1!==t.color.g||1!==t.color.b,p=t.vertexColors.length>0;let m=0;if(m=d(m,0,0),m=d(m,1,r),m=d(m,2,n),m=d(m,3,a),m=d(m,4,s),m=d(m,5,o),m=d(m,6,l),m=d(m,7,p),i.push(m),i.push(t.a,t.b,t.c),i.push(t.materialIndex),a){const t=this.faceVertexUvs[0][e];i.push(u(t[0]),u(t[1]),u(t[2]))}if(s&&i.push(h(t.normal)),o){const e=t.vertexNormals;i.push(h(e[0]),h(e[1]),h(e[2]))}if(l&&i.push(c(t.color)),p){const e=t.vertexColors;i.push(c(e[0]),c(e[1]),c(e[2]))}}function d(e,t,i){return i?e|1<<t:e&~(1<<t)}function h(e){const t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==n[t]||(n[t]=r.length/3,r.push(e.x,e.y,e.z)),n[t]}function c(e){const t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==s[t]||(s[t]=a.length,a.push(e.getHex())),s[t]}function u(e){const t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=o.length/2,o.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=r,a.length>0&&(e.data.colors=a),o.length>0&&(e.data.uvs=[o]),e.data.faces=i,e},clone:function(){return(new r).copy(this)},copy:function(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;const t=e.vertices;for(let e=0,i=t.length;e<i;e++)this.vertices.push(t[e].clone());const i=e.colors;for(let e=0,t=i.length;e<t;e++)this.colors.push(i[e].clone());const r=e.faces;for(let e=0,t=r.length;e<t;e++)this.faces.push(r[e].clone());for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=i.length;e<r;e++){const r=i[e],n=[];for(let e=0,t=r.length;e<t;e++){const t=r[e];n.push(t.clone())}this.faceVertexUvs[t].push(n)}}const n=e.morphTargets;for(let e=0,t=n.length;e<t;e++){const t={};if(t.name=n[e].name,void 0!==n[e].vertices){t.vertices=[];for(let i=0,r=n[e].vertices.length;i<r;i++)t.vertices.push(n[e].vertices[i].clone())}if(void 0!==n[e].normals){t.normals=[];for(let i=0,r=n[e].normals.length;i<r;i++)t.normals.push(n[e].normals[i].clone())}this.morphTargets.push(t)}const a=e.morphNormals;for(let e=0,t=a.length;e<t;e++){const t={};if(void 0!==a[e].vertexNormals){t.vertexNormals=[];for(let i=0,r=a[e].vertexNormals.length;i<r;i++){const r=a[e].vertexNormals[i],n={};n.a=r.a.clone(),n.b=r.b.clone(),n.c=r.c.clone(),t.vertexNormals.push(n)}}if(void 0!==a[e].faceNormals){t.faceNormals=[];for(let i=0,r=a[e].faceNormals.length;i<r;i++)t.faceNormals.push(a[e].faceNormals[i].clone())}this.morphNormals.push(t)}const s=e.skinWeights;for(let e=0,t=s.length;e<t;e++)this.skinWeights.push(s[e].clone());const o=e.skinIndices;for(let e=0,t=o.length;e<t;e++)this.skinIndices.push(o[e].clone());const l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);const d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());const h=e.boundingSphere;return null!==h&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},toBufferGeometry:function(){const e=(new n).fromGeometry(this),t=new THREE.BufferGeometry,i=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new THREE.BufferAttribute(i,3).copyVector3sArray(e.vertices)),e.normals.length>0){const i=new Float32Array(3*e.normals.length);t.setAttribute("normal",new THREE.BufferAttribute(i,3).copyVector3sArray(e.normals))}if(e.colors.length>0){const i=new Float32Array(3*e.colors.length);t.setAttribute("color",new THREE.BufferAttribute(i,3).copyColorsArray(e.colors))}if(e.uvs.length>0){const i=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new THREE.BufferAttribute(i,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){const i=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new THREE.BufferAttribute(i,2).copyVector2sArray(e.uvs2))}t.groups=e.groups;for(const i in e.morphTargets){const r=[],n=e.morphTargets[i];for(let e=0,t=n.length;e<t;e++){const t=n[e],i=new THREE.Float32BufferAttribute(3*t.data.length,3);i.name=t.name,r.push(i.copyVector3sArray(t.data))}t.morphAttributes[i]=r}if(e.skinIndices.length>0){const i=new THREE.Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",i.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){const i=new THREE.Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",i.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t},computeTangents:function(){console.error("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")},applyMatrix:function(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},dispose:function(){this.dispatchEvent({type:"dispose"})}}),r.createBufferGeometryFromObject=function(e){let t=new THREE.BufferGeometry;const i=e.geometry;if(e.isPoints||e.isLine){const e=new THREE.Float32BufferAttribute(3*i.vertices.length,3),r=new THREE.Float32BufferAttribute(3*i.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(i.vertices)),t.setAttribute("color",r.copyColorsArray(i.colors)),i.lineDistances&&i.lineDistances.length===i.vertices.length){const e=new THREE.Float32BufferAttribute(i.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(i.lineDistances))}null!==i.boundingSphere&&(t.boundingSphere=i.boundingSphere.clone()),null!==i.boundingBox&&(t.boundingBox=i.boundingBox.clone())}else e.isMesh&&(t=i.toBufferGeometry());return t};class n{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let i,r,n;const a=e.faces;for(r=0;r<a.length;r++){const e=a[r];e.materialIndex!==n&&(n=e.materialIndex,void 0!==i&&(i.count=3*r-i.start,t.push(i)),i={start:3*r,materialIndex:n})}void 0!==i&&(i.count=3*r-i.start,t.push(i)),this.groups=t}fromGeometry(e){const t=e.faces,i=e.vertices,r=e.faceVertexUvs,n=r[0]&&r[0].length>0,a=r[1]&&r[1].length>0,s=e.morphTargets,o=s.length;let l;if(o>0){l=[];for(let e=0;e<o;e++)l[e]={name:s[e].name,data:[]};this.morphTargets.position=l}const d=e.morphNormals,h=d.length;let c;if(h>0){c=[];for(let e=0;e<h;e++)c[e]={name:d[e].name,data:[]};this.morphTargets.normal=c}const u=e.skinIndices,p=e.skinWeights,m=u.length===i.length,f=p.length===i.length;i.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const g=t[e];this.vertices.push(i[g.a],i[g.b],i[g.c]);const v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{const e=g.normal;this.normals.push(e,e,e)}const y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{const e=g.color;this.colors.push(e,e,e)}if(!0===n){const t=r[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new THREE.Vector2,new THREE.Vector2,new THREE.Vector2))}if(!0===a){const t=r[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new THREE.Vector2,new THREE.Vector2,new THREE.Vector2))}for(let e=0;e<o;e++){const t=s[e].vertices;l[e].data.push(t[g.a],t[g.b],t[g.c])}for(let t=0;t<h;t++){const i=d[t].vertexNormals[e];c[t].data.push(i.a,i.b,i.c)}m&&this.skinIndices.push(u[g.a],u[g.b],u[g.c]),f&&this.skinWeights.push(p[g.a],p[g.b],p[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}THREE.Geometry=r})(),(()=>{var e=new THREE.Box3,t=new THREE.Matrix4,i=new THREE.Ray,n=new THREE.Sphere;class a extends THREE.LineSegments{constructor(e,t){super(e,t),this.type="LineSegmentsEx",this._matrixRoot=void 0,this._normalMatrixRoot=void 0,this.isMeshQuantization=!1,this._uniformsUpdateCallbackMap=null}onUpdateUniform(e,t){this.updateShadowUniform(e,t),this._updateAllUniforms(e,t)}updateShadowUniform(e,t){}_updateAllUniforms(e,t){const i=this._uniformsUpdateCallbackMap;if(!i)return;Object.keys(i).forEach((r=>{const n=i[r];n&&n(e,t)}))}_hasUniformUpdateCallback(e){return!(!this._uniformsUpdateCallbackMap||!this._uniformsUpdateCallbackMap[e])}addUniformUpdateCallback(e,t){t&&(this._uniformsUpdateCallbackMap||(this._uniformsUpdateCallbackMap={}),this._uniformsUpdateCallbackMap[e]||(this._uniformsUpdateCallbackMap[e]=t))}removeUniformUpdateCallback(e){this._hasUniformUpdateCallback(e)&&delete this._uniformsUpdateCallbackMap[e]}removeAllUniformsUpdateCallback(){const e=this._uniformsUpdateCallbackMap;if(!e)return;Object.keys(e).forEach((t=>{e[t]&&delete e[t]})),this._uniformsUpdateCallbackMap=null}init(e){}destroy(){this.removeAllUniformsUpdateCallback()}set matrixRoot(e){e instanceof THREE.Matrix4?this._matrixRoot=e:this._matrixRoot=new THREE.Matrix4,this._normalMatrixRoot=(new THREE.Matrix3).setFromMatrix4(this._matrixRoot.clone().transpose())}get matrixRoot(){return this._matrixRoot}get quantizationNormalMatrix(){return this._normalMatrixRoot}intersectBoxWithDistance(t,i){var r=this.geometry,n=this.matrixWorld;return i&&(n=this.matrixWorld.clone()).multiplyMatrices(this.matrixWorld,i),r.boundingBox||r.computeBoundingBox(),e.copy(r.boundingBox),e.applyMatrix4(n),t.ray.intersectBoxWithDistance(e)}intersectBoxWithDistanceByIndices(e,t){var i=this.geometry.attributes.position.array,n=0,a=i.length;t&&t.indexCount>0&&(n=t.positionStart,a=t.positionStart+t.positionCount);var s=r.Utils.box3FromArrayRange(i,n,a);return s.applyMatrix4(this.matrixWorld),e.ray.intersectBoxWithDistance(s)}intersectByBox(e,t,i,r){return!1}raycastByIndices(e,a,s,o,l){var d=e.linePrecision;e.linePrecision=r.Utils.defined(l)?r.GlobalData.LineSelectRange*l:r.GlobalData.LineSelectRange;var h=e.linePrecision,c=h*h,u=this.matrixWorld.clone();o&&u.multiplyMatrices(this.matrixWorld,o);var p=this.geometry;if(null===p.boundingSphere&&p.computeBoundingSphere(),n.copy(p.boundingSphere),n.applyMatrix4(u),!1===e.ray.intersectsSphere(n))return;let m=null;m=o||this.matrix,m&&u.multiply(m.clone().invert()),t.copy(u).invert(),i.copy(e.ray).applyMatrix4(t);var f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,M=p.attributes.position.array,E=p.index.array,x=0,_=E.length;s&&s.indexCount>0&&(x=s.indexStart,_=s.indexStart+s.indexCount);for(var b=x;b<_-1;b+=2){var I=E[b],T=E[b+1];if(f.fromArray(M,3*I),g.fromArray(M,3*T),m&&(f.applyMatrix4(m),g.applyMatrix4(m)),!(i.distanceSqToSegment(f,g,y,v)>c)){y.applyMatrix4(u);var S=e.ray.origin.distanceTo(y);S<e.near||S>e.far||a.push({distance:S,point:v.clone().applyMatrix4(u),index:b,face:null,faceIndex:null,object:this})}}e.linePrecision=d}onBeforeRender(e,t,i,n,a,s){if(this.isMeshQuantization&&a.uniforms){const e="quantizationNormalMatrix";this._hasUniformUpdateCallback(e)||this.addUniformUpdateCallback(e,((e,t)=>{e.setValue(t,"quantizationNormalMatrix",this.quantizationNormalMatrix)})),r.Utils.defined(a.defines)||(a.defines={}),a.defines.MESHOPTQUANTIZATION="",void 0===a.uniforms.quantizationNormalMatrix&&(a.uniforms.quantizationNormalMatrix={value:new THREE.Matrix3}),a.uniforms.quantizationNormalMatrix.value.copy(this._normalMatrixRoot)}}onAfterRender(e,t,i,r,n,a){this.isMeshQuantization&&n.uniforms&&n.uniforms.quantizationNormalMatrix.value.identity()}}r.LineSegmentsEx=a})(),function(){const e=new THREE.Box3,t=new THREE.Vector3;class i extends THREE.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new THREE.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new THREE.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new THREE.WireframeGeometry(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==t&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(i),this.boundingBox.union(e))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let n=0;for(let a=0,s=e.count;a<s;a++)t.fromBufferAttribute(e,a),n=Math.max(n,r.distanceToSquared(t)),t.fromBufferAttribute(i,a),n=Math.max(n,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}clone(){}copy(e){return this}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}THREE.LineSegmentsGeometry=i}(),function(){class e extends THREE.LineSegmentsGeometry{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let r=0;r<t;r+=3)i[2*r]=e[r],i[2*r+1]=e[r+1],i[2*r+2]=e[r+2],i[2*r+3]=e[r+3],i[2*r+4]=e[r+4],i[2*r+5]=e[r+5];return super.setPositions(i),this}setColors(e){const t=e.length-3,i=new Float32Array(2*t);for(let r=0;r<t;r+=3)i[2*r]=e[r],i[2*r+1]=e[r+1],i[2*r+2]=e[r+2],i[2*r+3]=e[r+3],i[2*r+4]=e[r+4],i[2*r+5]=e[r+5];return super.setColors(i),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}copy(e){return this}}THREE.LineGeometry=e}(),function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector4,r=new THREE.Vector4,n=new THREE.Vector4,a=new THREE.Vector3,s=new THREE.Matrix4,o=new THREE.Line3,l=new THREE.Vector3,d=new THREE.Box3,h=new THREE.Sphere,c=new THREE.Vector4;let u,p,m,f;function g(e,t,i){return c.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),c.multiplyScalar(1/c.w),c.x=f/i.width,c.y=f/i.height,c.applyMatrix4(e.projectionMatrixInverse),c.multiplyScalar(1/c.w),Math.abs(Math.max(c.x,c.y))}class v extends THREE.Mesh{constructor(e=new THREE.LineSegmentsGeometry,t=new THREE.LineMaterial({color:16777215*Math.random()})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})}computeLineDistances(){const i=this.geometry,r=i.attributes.instanceStart,n=i.attributes.instanceEnd,a=new Float32Array(2*r.count);for(let i=0,s=0,o=r.count;i<o;i++,s+=2)e.fromBufferAttribute(r,i),t.fromBufferAttribute(n,i),a[s]=0===s?0:a[s-1],a[s+1]=a[s]+e.distanceTo(t);const s=new THREE.InstancedInterleavedBuffer(a,2,1);return i.setAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(s,1,0)),i.setAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(s,1,1)),this}copy(e){return this}raycast(e,t){const c=this.material.worldUnits,v=e.camera;null!==v||c||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const y=void 0!==e.params.Line2&&e.params.Line2.threshold||0;u=e.ray;const M=this.matrixWorld,E=this.geometry,x=this.material;let _,b;if(f=x.linewidth+y,p=E.attributes.instanceStart,m=E.attributes.instanceEnd,null===E.boundingSphere&&E.computeBoundingSphere(),h.copy(E.boundingSphere).applyMatrix4(M),c)_=.5*f;else{_=g(v,Math.max(v.near,h.distanceToPoint(u.origin)),x.resolution)}if(h.radius+=_,!1!==u.intersectsSphere(h)){if(null===E.boundingBox&&E.computeBoundingBox(),d.copy(E.boundingBox).applyMatrix4(M),c)b=.5*f;else{b=g(v,Math.max(v.near,d.distanceToPoint(u.origin)),x.resolution)}d.expandByScalar(b),!1!==u.intersectsBox(d)&&(c?function(e,t){for(let i=0,r=p.count;i<r;i++){o.start.fromBufferAttribute(p,i),o.end.fromBufferAttribute(m,i);const r=new THREE.Vector3,n=new THREE.Vector3;u.distanceSqToSegment(o.start,o.end,n,r),n.distanceTo(r)<.5*f&&t.push({point:n,pointOnLine:r,distance:u.origin.distanceTo(n),object:e,face:null,faceIndex:i,uv:null,uv2:null})}}(this,t):function(e,t,d){const h=t.projectionMatrix,c=e.material.resolution,p=e.matrixWorld,m=e.geometry,g=m.attributes.instanceStart,v=m.attributes.instanceEnd,y=-t.near;u.at(1,n),n.w=1,n.applyMatrix4(t.matrixWorldInverse),n.applyMatrix4(h),n.multiplyScalar(1/n.w),n.x*=c.x/2,n.y*=c.y/2,n.z=0,a.copy(n),s.multiplyMatrices(t.matrixWorldInverse,p);for(let t=0,n=g.count;t<n;t++){if(i.fromBufferAttribute(g,t),r.fromBufferAttribute(v,t),i.w=1,r.w=1,i.applyMatrix4(s),r.applyMatrix4(s),i.z>y&&r.z>y)continue;if(i.z>y){const e=i.z-r.z,t=(i.z-y)/e;i.lerp(r,t)}else if(r.z>y){const e=r.z-i.z,t=(r.z-y)/e;r.lerp(i,t)}i.applyMatrix4(h),r.applyMatrix4(h),i.multiplyScalar(1/i.w),r.multiplyScalar(1/r.w),i.x*=c.x/2,i.y*=c.y/2,r.x*=c.x/2,r.y*=c.y/2,o.start.copy(i),o.start.z=0,o.end.copy(r),o.end.z=0;const n=o.closestPointToPointParameter(a,!0);o.at(n,l);const m=THREE.MathUtils.lerp(i.z,r.z,n),M=m>=-1&&m<=1,E=a.distanceTo(l)<.5*f;if(M&&E){o.start.fromBufferAttribute(g,t),o.end.fromBufferAttribute(v,t),o.start.applyMatrix4(p),o.end.applyMatrix4(p);const i=new THREE.Vector3,r=new THREE.Vector3;u.distanceSqToSegment(o.start,o.end,r,i),d.push({point:r,pointOnLine:i,distance:u.origin.distanceTo(r),object:e,face:null,faceIndex:t,uv:null,uv2:null})}}}(this,v,t))}}}THREE.LineSegments2=v}(),function(){class e extends THREE.LineSegments2{constructor(e=new THREE.LineGeometry,t=new THREE.LineMaterial({color:16777215*Math.random()})){super(e,t),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==e?e:new THREE.LineGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()}),this.groundCurve=void 0}copy(e){return this}createGroundCurve(e){this.groundCurve=r.GroundPrimitiveManager.getInstance().createGroundCurve(e)}}THREE.Line2=e}(),function(){THREE.UniformsLib.line={linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},totalSize:{value:1},opacity:{value:1},uvTransform:{value:new THREE.Matrix3},clippingTolerance:{value:0},clippingPlanes:{value:new Float32Array(24)},outNormal:{value:new THREE.Vector3}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\t#if defined( USE_MAP )\n            uniform mat3 uvTransform;\n    \t#endif\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\t\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tattribute float instanceDistanceStart;//for quick to change style and map\n\t\tattribute float instanceDistanceEnd;\n\n\t\tvarying vec2 vUv;\n\t\tvarying float rate;\n\t\tuniform float totalSize;//v is depend on nowSize/Totalsize\n\t\t#if defined( USE_MAP )\n\n\t\t\t//uniform vec4 uv;\n\t\t\t//uniform mat3 rotateMatrix;\n\n\t\t\tvarying vec2 vUv2;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\t// attribute float instanceDistanceStart;\n\t\t\t// attribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\t#ifdef USE_OUTNORMAL\n        \tuniform vec3 outNormal;\n\t\t\tvarying float vIsVisible;\n\n    \t#endif\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\trate = instanceDistanceEnd/totalSize;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\t\t\t// rate = instanceDistanceEnd/totalSize;\n\n\t\t\t#if defined( USE_MAP )\n\t\t\t\t//u: uv.x* 0.5 + 0.5, v: instanceDistanceEnd/totalSize\n\t\t\t\tvUv2 = vec2((uv.x* 0.5 + 0.5) - 0.5,instanceDistanceEnd/totalSize - 0.5) + vec2(0.5, 0.5);\n\t\t\t\tvUv2 = ( uvTransform * vec3( vUv2, 1 ) ).xy;\n\t\t\t#endif\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#ifdef USE_OUTNORMAL\n\t\t\t\tvec3 viewNormal = normalMatrix * outNormal;\n            \tvIsVisible = dot(normalize(viewNormal), normalize(mvPosition.xyz)) > 0.0?1.0:-1.0;\n        \t#endif\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float visibility;\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\t#ifdef USE_OUTNORMAL\n\t\t\tvarying float vIsVisible;\n\t\t#endif\n\t\tvarying float vLineDistance;\n\t\tvarying float rate;\n\t\t#include <map_pars_fragment>\n\t\t#include <alphamap_pars_fragment>\n\t\t#if defined( USE_MAP )\n\t\t\tvarying vec2 vUv2;\n\t\t#endif\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t//r142\n\t\t//#include <alphatest_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\t\tuniform float clippingTolerance;\n\n\t\tvoid main() {\n\t\t\t#ifdef USE_OUTNORMAL\n\t\t\t\tif(vIsVisible<0.0) discard;\n\t\t\t#endif\n\t\t\t\n\t\t\t#include <num_clipping_planes_for_clip_fragment>\n\n\t\t\t// if(rate > visibility) discard;\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef ALPHA_TO_COVERAGE\n\n\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\tfloat a = vUv.x;\n\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\tfloat len2 = a * a + b * b;\n\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t}\n\n\t\t\t#else\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#ifdef USE_MAP\n\t\t\t   vec4 texelColor = texture2D( map, vUv2 );\n\t\t\t   //texelColor = mapTexelToLinear( texelColor );\n\t\t\t   diffuseColor = vec4(texelColor.rgb, opacity);\n\t\t\t#endif\n\n\t\t\t#ifdef USE_ALPHAMAP\n\t\t\t\tdiffuseColor.a *= texture2D( alphaMap, vUv2 ).a;\n\t\t\t#endif\n\t\t\t#include <alphatest_fragment>\n\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class e extends THREE.ShaderMaterial{constructor(e){super({type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader,clipping:!1}),this.dashed=!1,this.alphaMap=null,this.visibility=1,this.outNormal=new THREE.Vector3(0),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e,r.MaterialUtil.updateUVMatrix(this.uniforms.map.value),this.uniforms.uvTransform.value=this.uniforms.map.value.matrix}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},clippingTolerance:{enumerable:!0,get:function(){return this.uniforms.clippingTolerance.value},set:function(e){this.uniforms.clippingTolerance.value=e}},alphaToCoverage:{enumerable:!0,get:function(){return Boolean("ALPHA_TO_COVERAGE"in this.defines)},set:function(e){Boolean(e)!==Boolean("ALPHA_TO_COVERAGE"in this.defines)&&(this.needsUpdate=!0),e?(this.defines.ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)},totalSize:{enumerable:!0,get:function(){return this.uniforms.totalSize.value},set:function(e){this.uniforms.totalSize.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},outNormal:{enumerable:!0,get:function(){return this.uniforms.outNormal.value},set:function(e){this.uniforms.outNormal.value=e}}}}),this.setValues(e)}}e.prototype.isLineMaterial=!0,THREE.LineMaterial=e}();var S,C,w,R,B,A,P={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,{linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashArray:{value:0},dashRatio:{value:0},visibility:{value:1},alphaTest:{value:0},glowPower:{value:0},enableColorOverride:{value:!1},sizeAttenuation:{value:!1}}]),vertexShader:"\n    #include <common>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <fog_pars_vertex>\n    attribute vec3 previous;\n    attribute vec3 next;\n    uniform vec2 resolution;\n    uniform float linewidth;\n    uniform vec3 diffuse;\n    uniform float opacity;\n    uniform bool sizeAttenuation;\n\n    varying vec2 vUv;\n    varying vec4 vColor;\n\n    vec3 fix( vec4 i, float aspect ) {\n        vec2 res = i.xy / i.w;\n        res.x *= aspect;\n        return vec3(res,0.0);\n    }\n\n    vec3 getDir(vec3 currentP, vec3 prevP, vec3 nextP){\n        vec3 dir;\n        if( nextP == currentP ) dir = normalize( currentP - prevP );\n        else if( prevP == currentP ) dir = normalize( nextP - currentP );\n        else {\n            vec3 dir1 = normalize( currentP - prevP );\n            vec3 dir2 = normalize( nextP - currentP );\n            dir = normalize( dir1 + dir2 );\n        }\n        return dir;\n    }\n\n    vec4 getNormalWithWidth(float width, vec4 normal, float side){\n        #if defined(SINGLE_EXPAND)\n            if(side > 0.0){//left expand\n                normal *= 2.0 * width;\n            }\n        #else\n            normal *= width;\n        #endif\n\n        return normal;\n    }\n\n    mat4 inverse_mat4(mat4 m)\n    {\n        float Coef00 = m[2][2] * m[3][3] - m[3][2] * m[2][3];\n        float Coef02 = m[1][2] * m[3][3] - m[3][2] * m[1][3];\n        float Coef03 = m[1][2] * m[2][3] - m[2][2] * m[1][3];\n        \n        float Coef04 = m[2][1] * m[3][3] - m[3][1] * m[2][3];\n        float Coef06 = m[1][1] * m[3][3] - m[3][1] * m[1][3];\n        float Coef07 = m[1][1] * m[2][3] - m[2][1] * m[1][3];\n        \n        float Coef08 = m[2][1] * m[3][2] - m[3][1] * m[2][2];\n        float Coef10 = m[1][1] * m[3][2] - m[3][1] * m[1][2];\n        float Coef11 = m[1][1] * m[2][2] - m[2][1] * m[1][2];\n        \n        float Coef12 = m[2][0] * m[3][3] - m[3][0] * m[2][3];\n        float Coef14 = m[1][0] * m[3][3] - m[3][0] * m[1][3];\n        float Coef15 = m[1][0] * m[2][3] - m[2][0] * m[1][3];\n        \n        float Coef16 = m[2][0] * m[3][2] - m[3][0] * m[2][2];\n        float Coef18 = m[1][0] * m[3][2] - m[3][0] * m[1][2];\n        float Coef19 = m[1][0] * m[2][2] - m[2][0] * m[1][2];\n        \n        float Coef20 = m[2][0] * m[3][1] - m[3][0] * m[2][1];\n        float Coef22 = m[1][0] * m[3][1] - m[3][0] * m[1][1];\n        float Coef23 = m[1][0] * m[2][1] - m[2][0] * m[1][1];\n        \n        const vec4 SignA = vec4( 1.0, -1.0,  1.0, -1.0);\n        const vec4 SignB = vec4(-1.0,  1.0, -1.0,  1.0);\n        \n        vec4 Fac0 = vec4(Coef00, Coef00, Coef02, Coef03);\n        vec4 Fac1 = vec4(Coef04, Coef04, Coef06, Coef07);\n        vec4 Fac2 = vec4(Coef08, Coef08, Coef10, Coef11);\n        vec4 Fac3 = vec4(Coef12, Coef12, Coef14, Coef15);\n        vec4 Fac4 = vec4(Coef16, Coef16, Coef18, Coef19);\n        vec4 Fac5 = vec4(Coef20, Coef20, Coef22, Coef23);\n        \n        vec4 Vec0 = vec4(m[1][0], m[0][0], m[0][0], m[0][0]);\n        vec4 Vec1 = vec4(m[1][1], m[0][1], m[0][1], m[0][1]);\n        vec4 Vec2 = vec4(m[1][2], m[0][2], m[0][2], m[0][2]);\n        vec4 Vec3 = vec4(m[1][3], m[0][3], m[0][3], m[0][3]);\n        \n        vec4 Inv0 = SignA * (Vec1 * Fac0 - Vec2 * Fac1 + Vec3 * Fac2);\n        vec4 Inv1 = SignB * (Vec0 * Fac0 - Vec2 * Fac3 + Vec3 * Fac4);\n        vec4 Inv2 = SignA * (Vec0 * Fac1 - Vec1 * Fac3 + Vec3 * Fac5);\n        vec4 Inv3 = SignB * (Vec0 * Fac2 - Vec1 * Fac4 + Vec2 * Fac5);\n        \n        mat4 Inverse = mat4(Inv0, Inv1, Inv2, Inv3);\n        \n        vec4 Row0 = vec4(Inverse[0][0], Inverse[1][0], Inverse[2][0], Inverse[3][0]);\n        \n        float Determinant = dot(m[0], Row0);\n        \n        Inverse /= Determinant;\n        \n        return Inverse;\n    }\n\n    void main() {\n    \n        float aspect = resolution.x / resolution.y;\n    \n        vColor = vec4( diffuse, opacity );\n        vUv = uv;\n    \n        mat4 m = projectionMatrix * modelViewMatrix;\n        vec4 finalPosition;\n\n        float side = (vUv.x - 0.5) * (-2.0);\n        if( sizeAttenuation == false) {\n            finalPosition = m * vec4( position, 1.0 );\n            vec4 prevPos = m * vec4( previous, 1.0 );\n            vec4 nextPos = m * vec4( next, 1.0 );\n\n            vec3 currentP = fix( finalPosition, aspect );\n            vec3 prevP = fix( prevPos, aspect );\n            vec3 nextP = fix( nextPos, aspect );\n            \n            vec3 dir = getDir(currentP, prevP, nextP);\n            vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n            normal = getNormalWithWidth(linewidth, normal, side);\n\n            normal *= projectionMatrix;\n            normal.xy *= finalPosition.w;\n            normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n            finalPosition.xy += (normal.xy * side);\n\n        }else{\n            vec3 dir = getDir(position, previous, next);\n            vec3 cameraDir = normalize((inverse_mat4(modelMatrix) * vec4(cameraPosition,1.0)).xyz - position);\n            vec4 normal =  vec4(normalize(cross( vec3( dir), cameraDir)), 1.0) ;//vec3( 0., 0., 1. )\n            normal = getNormalWithWidth(0.5 * linewidth, normal, side);\n\n            normal = normal * side* (-1.0) ;//frontSide\n            finalPosition = m * vec4( position + normal.xyz, 1.0 );\n        }\n    \n        gl_Position = finalPosition;\n    \n        #include <logdepthbuf_vertex>\n        #if NUM_CLIPPING_PLANES > 0\n            vec3 transformed = vec3( position );\n            vec4 mvPosition = vec4( transformed, 1.0 );\n            mvPosition = modelViewMatrix * mvPosition;\n            vClipPosition = - mvPosition.xyz;;\n\n        #endif\n        // #include <clipping_planes_vertex>\n        #include <fog_vertex>\n    }\n    ",fragmentShader:"\n    #include <fog_pars_fragment>\n    #include <common>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    #ifdef USE_MAP \n        uniform sampler2D map;\n    #endif\n\n    #if defined(USE_MAP)||defined(USE_DASH)\n        uniform mat3 uvTransform;\n    #endif\n\n    #ifdef USE_GLOW\n        uniform float glowPower;\n    #endif\n\n    #ifdef USE_DASH\n        uniform float dashArray;\n        uniform float dashRatio;\n    #endif\n\n    uniform float visibility;\n    uniform float alphaTest;\n    uniform bool enableColorOverride;\n    \n    varying vec2 vUv;\n    varying vec4 vColor;\n    \n    void main() {\n        #include <clipping_planes_fragment>\n        #include <logdepthbuf_fragment>\n        vec4 diffuseColor = vColor;\n\n        if(vUv.y > visibility) discard;\n        \n        vec2 uv = vUv;\n        #if defined(USE_MAP)||defined(USE_DASH)\n            uv = vec2(vUv.x - 0.5, vUv.y - 0.5) + vec2(0.5, 0.5);\n            uv = ( uvTransform * vec3( uv, 1 ) ).xy;\n        #endif\n\n\n        #ifdef USE_DASH\n            float dashoffset = dashArray * dashRatio;\n            if((dashArray * dashRatio) - mod( uv.y, dashArray) < 0.0) discard; //diffuseColor.a = 0.0;\n        #endif\n\n        #ifdef USE_MAP\n            if(!enableColorOverride)\n                diffuseColor.xyz = texture2D( map, uv ).xyz;//*\n            diffuseColor.a = texture2D( map, uv).a * 2.0;\n        #endif\n\n        if( diffuseColor.a < alphaTest ) discard;\n\n        #ifdef USE_GLOW\n            float glow = glowPower / abs(vUv.y - 0.5) - (glowPower / 0.5);\n            // diffuseColor.rgb = max(vec3(glow - 1.0 + diffuseColor.rgb), diffuseColor.rgb);\n            diffuseColor.a = clamp(0.0, 1.0, glow) * diffuseColor.a;\n        #endif\n\n        gl_FragColor = diffuseColor;\n    \n        #include <fog_fragment>\n    }\n    "};!function(){class e extends THREE.ShaderMaterial{constructor(e){super({uniforms:THREE.UniformsUtils.clone(P.uniforms),vertexShader:P.vertexShader,fragmentShader:P.fragmentShader}),this.clipping=!0,this.type="MeshLineMaterial",this.totalSize=0,this.setValues(e)}set linewidth(e){this.uniforms&&this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get linewidth(){return this.uniforms.linewidth.value}set map(e){this.uniforms.map.value=e,e&&(r.MaterialUtil.updateUVMatrix(this.uniforms.map.value),this.uniforms.uvTransform.value=this.uniforms.map.value.matrix)}get map(){return this.uniforms.map.value}set color(e){this.uniforms.diffuse.value=e}get color(){return this.uniforms.diffuse.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get opacity(){return this.uniforms.opacity.value}set resolution(e){this.uniforms.resolution.value=e}get resolution(){return this.uniforms.resolution.value}set dashArray(e){this.uniforms.dashArray.value=e,e>0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashArray(){return this.uniforms.dashArray.value}set dashRatio(e){this.uniforms.dashRatio.value=e}get dashRatio(){return this.uniforms.dashRatio.value}set visibility(e){this.uniforms.visibility.value=e}get visibility(){return this.uniforms.visibility.value}set alphaTest(e){this.uniforms&&(this.uniforms.alphaTest.value=e)}get alphaTest(){return this.uniforms.alphaTest.value}set glowPower(e){this.uniforms.glowPower.value=e,e>0?this.defines.USE_GLOW="":delete this.defines.USE_GLOW}set enableSingleExpand(e){e?this.defines.SINGLE_EXPAND="":delete this.defines.SINGLE_EXPAND}get enableSingleExpand(){return!!this.defines.SINGLE_EXPAND}get glowPower(){return this.uniforms.glowPower.value}set enableColorOverride(e){this.uniforms.enableColorOverride.value=e}get enableColorOverride(){return this.uniforms.enableColorOverride.value}set sizeAttenuation(e){this.uniforms.sizeAttenuation.value=e}get sizeAttenuation(){return this.uniforms.sizeAttenuation.value}copy(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.linewidth=e.linewidth,this.map=e.map,this.alphaMap=e.alphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.dashArray=e.dashArray,this.dashRatio=e.dashRatio,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this}}r.MeshLineMaterial=e}(),function(){class e extends THREE.BufferGeometry{constructor(){super(),this.type="MeshLineGeometry"}setPositions(e){if(!(e instanceof Float32Array||e instanceof Array))return void console.error("ERROR: The BufferArray of points is not instancied correctly.");let t=[];var i=[0];if(e.length&&e[0]instanceof THREE.Vector3)for(var r=0;r<e.length;r++){var n=e[r];if(t.push(n.x,n.y,n.z),t.push(n.x,n.y,n.z),r>0){let t=i[i.length-1]+this._distanceTo(n.x,n.y,n.z,e[r-1].x,e[r-1].y,e[r-1].z);i.push(t)}}else for(r=0;r<e.length;r+=3)if(t.push(e[r],e[r+1],e[r+2]),t.push(e[r],e[r+1],e[r+2]),r>0){let t=i[i.length-1]+this._distanceTo(e[r-3],e[r-2],e[r-1],e[r],e[r+1],e[r+2]);i.push(t)}const a=t.length/6;let s,o=[],l=[],d=[],h=[];s=this.compareV3(t,0,a-1)?this.copyV3(t,a-2):this.copyV3(t,0),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);const c=i[i.length-1];this.totalSize=c;for(let e=0;e<a;e++){let r=i[e]/c;if(h.push(0,r),h.push(1,r),e<a-1){s=this.copyV3(t,e),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);var u=2*e;d.push(u,u+1,u+2),d.push(u+2,u+1,u+3)}e>0&&(s=this.copyV3(t,e),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]))}s=this.compareV3(t,a-1,0)?this.copyV3(t,1):this.copyV3(t,a-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]);const p=new THREE.BufferAttribute(new Float32Array(t),3),m=new THREE.BufferAttribute(new Float32Array(o),3),f=new THREE.BufferAttribute(new Float32Array(l),3),g=new THREE.BufferAttribute(new Float32Array(h),2),v=new THREE.BufferAttribute(new Uint16Array(d),1);this.setAttribute("position",p),this.setAttribute("previous",m),this.setAttribute("next",f),this.setAttribute("uv",g),this.setIndex(v),this.computeBoundingSphere(),this.computeBoundingBox()}setPositions2(e,t){let i=[];for(var r=[0],n=0;n<e.length;n+=3)if(i.push(e[n],e[n+1],e[n+2]),i.push(e[n],e[n+1],e[n+2]),n>0){let t=r[r.length-1]+this._distanceTo(e[n-3],e[n-2],e[n-1],e[n],e[n+1],e[n+2]);r.push(t)}const a=i.length/6;let s,o=[],l=[],d=[],h=[],c=0;s=this.compareV3(i,0,a-1)?this.copyV3(i,a-2):this.copyV3(i,0),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);const u=r[r.length-1];this.totalSize=u;for(let e=0;e<a;e++){let n=r[e]/u;h.push(0,n),h.push(1,n);var p=!0,m=!0;if(e<a-1){if(t&&(c%2==1&&t[c]!=t[c+1]?(p=!1,c++):c%2==1&&t[c]==t[c+1]?c+=2:(c++,m=!1)),p){var f=2*e;d.push(f,f+1,f+2),d.push(f+2,f+1,f+3)}s=p?this.copyV3(i,e):this.copyV3(i,e+1),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2])}e>0&&(s=m?this.copyV3(i,e):this.copyV3(i,e-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]))}s=this.compareV3(i,a-1,0)?this.copyV3(i,1):this.copyV3(i,a-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]);const g=new THREE.BufferAttribute(new Float32Array(i),3),v=new THREE.BufferAttribute(new Float32Array(o),3),y=new THREE.BufferAttribute(new Float32Array(l),3),M=new THREE.BufferAttribute(new Float32Array(h),2),E=new THREE.BufferAttribute(new Uint32Array(d),1);this.setAttribute("position",g),this.setAttribute("previous",v),this.setAttribute("next",y),this.setAttribute("uv",M),this.setIndex(E),this.computeBoundingSphere(),this.computeBoundingBox()}compareV3(e,t,i){const r=6*t,n=6*i;return e[r]===e[n]&&e[r+1]===e[n+1]&&e[r+2]===e[n+2]}copyV3(e,t){const i=6*t;return[e[i],e[i+1],e[i+2]]}_distanceTo(e,t,i,r,n,a){const s=r-e,o=n-t,l=a-i,d=s*s+o*o+l*l;return Math.sqrt(d)}}r.MeshLineGeometry=e}(),function(){let e=new THREE.Matrix4;class t extends THREE.Mesh{constructor(e,t){super(e,t),this.type="MeshLine",this.isMeshLine=!0,this.geometry=void 0!==e?e:new r.MeshLineGeometry,this.material=void 0!==t?t:new r.MeshLineMaterial({color:16777215*Math.random()}),this.groundCurve=void 0}copy(e){return this}raycast(t,i,n){var a=new THREE.Ray,s=new THREE.Sphere,o=new THREE.Vector3,l=this.geometry;if(s.copy(l.boundingSphere),s.applyMatrix4(this.matrixWorld),!1!==t.ray.intersectSphere(s,o)){e.copy(this.matrixWorld).invert(),a.copy(t.ray).applyMatrix4(e);var d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,u=l.index,p=l.attributes;if(null!==u)for(var m=u.array,f=p.position.array,g=0,v=m.length-1;g<v;g+=2){var y=m[g],M=m[g+2];d.fromArray(f,3*y),h.fromArray(f,3*M);var E=r.GlobalData.LineSelectRange+this.material.linewidth/2;n&&n.unitScale&&(E*=n.unitScale);var x=E*E;if(!(a.distanceSqToSegment(d,h,o,c)>x)){o.applyMatrix4(this.matrixWorld);var _=t.ray.origin.distanceTo(o);_<t.near||_>t.far||(i.push({distance:_,point:c.clone().applyMatrix4(this.matrixWorld),index:g,face:null,faceIndex:null,object:this}),g=v)}}}}createGroundCurve(e){this.groundCurve=r.GroundPrimitiveManager.getInstance().createGroundCurve(e)}}r.MeshLine=t}(),function(){class e extends THREE.BufferGeometry{constructor(){super(),this.type="BandGeometry"}setPositions(e,t,i,r,n){if(!(e instanceof Float32Array||e instanceof Array))return void console.error("ERROR: The BufferArray of points is not instancied correctly.");let a=[];var s=[0];let o=[];for(var l=0;l<e.length;l+=3){const d=t[l],h=t[l+1],c=t[l+2];if(a.push(e[l]-d*r,e[l+1]-h*r,e[l+2]-c*r),a.push(e[l]+d*n,e[l+1]+h*n,e[l+2]+c*n),o.push(i[l],i[l+1],i[l+2]),o.push(i[l],i[l+1],i[l+2]),l>0){let t=s[s.length-1]+this._distanceTo(e[l-3],e[l-2],e[l-1],e[l],e[l+1],e[l+2]);s.push(t)}}const d=a.length/6;let h=[],c=[];const u=s[s.length-1];this.totalSize=u;for(let e=0;e<d;e++){let t=s[e]/u;if(c.push(0,t),c.push(1,t),e<d-1){var p=2*e;h.push(p,p+1,p+2),h.push(p+2,p+1,p+3)}}const m=new THREE.BufferAttribute(new Float32Array(a),3),f=new THREE.BufferAttribute(new Float32Array(c),2),g=new THREE.BufferAttribute(new Float32Array(o),3),v=new THREE.BufferAttribute(new Uint16Array(h),1);this.setAttribute("position",m),this.setAttribute("uv",f),this.setAttribute("normal",g),this.setIndex(v),this.computeBoundingSphere(),this.computeBoundingBox(),this.positions=a}getWireframe(){let e=[];const t=this.positions,i=t.length;let r=0;for(r=0;r<i;r+=6)e.push(t[r],t[r+1],t[r+2]);for(r-=1;r>0;r-=6)e.push(t[r-2],t[r-1],t[r]);return e.push(t[0],t[1],t[2]),e}_distanceTo(e,t,i,r,n,a){const s=r-e,o=n-t,l=a-i,d=s*s+o*o+l*l;return Math.sqrt(d)}}r.BandGeometry=e}(),function(){r.GIS=r.GIS||{};class e{constructor(e,t,i,r){this.west=e||0,this.south=t||0,this.east=i||0,this.north=r||0}static computeWidth(e){var t=e.east,i=e.west;return t<i&&(t+=r.Math.TWO_PI),t-i}static computeHeight(e){return e.north-e.south}static contains(e,t){var i=t.longitude,n=t.latitude,a=e.west,s=e.east;return s<a&&(s+=r.Math.TWO_PI,i<0&&(i+=r.Math.TWO_PI)),(i>a||r.Math.equalsEpsilon(i,a,r.Math.EPSILON14))&&(i<s||r.Math.equalsEpsilon(i,s,r.Math.EPSILON14))&&n>=e.south&&n<=e.north}static fromCartographicArray(t,i){for(var n=Number.MAX_VALUE,a=-Number.MAX_VALUE,s=Number.MAX_VALUE,o=-Number.MAX_VALUE,l=Number.MAX_VALUE,d=-Number.MAX_VALUE,h=0,c=t.length;h<c;h++){var u=t[h];n=Math.min(n,u.longitude),a=Math.max(a,u.longitude),l=Math.min(l,u.latitude),d=Math.max(d,u.latitude);var p=u.longitude>=0?u.longitude:u.longitude+r.Math.TWO_PI;s=Math.min(s,p),o=Math.max(o,p)}return a-n>o-s&&(n=s,(a=o)>Math.PI&&(a-=r.Math.TWO_PI),n>Math.PI&&(n-=r.Math.TWO_PI)),i?(i.west=n,i.south=l,i.east=a,i.north=d,i):new e(n,l,a,d)}get width(){return e.computeWidth(this)}get height(){return e.computeHeight(this)}}e.MAX_VALUE=Object.freeze(new e(-Math.PI,-r.Math.PI_OVER_TWO,Math.PI,r.Math.PI_OVER_TWO)),r.GIS.Rectangle=e}(),function(){r.GIS=r.GIS||{};class e{constructor(e,t,i){this.longitude=e||0,this.latitude=t||0,this.height=i||0}static fromRadians(t,i,r,n){return r=r||0,n?(n.longitude=t,n.latitude=i,n.height=r,n):new e(t,i,r)}}r.GIS.Cartographic=e}(),function(){r.GIS=r.GIS||{};var e,t,i={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},n={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},a={},s={east:new THREE.Vector3,north:new THREE.Vector3,up:new THREE.Vector3,west:new THREE.Vector3,south:new THREE.Vector3,down:new THREE.Vector3},o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3;class c{constructor(){}static computeTemeToPseudoFixedMatrix(i,n){if(!r.Utils.defined(i))throw new Error("date is required.");t||(t=new r.JulianDate),e||(e=r.Math.TWO_PI/86400);var a,s=(t=r.JulianDate.addSeconds(i,-r.JulianDate.computeTaiMinusUtc(i),t)).dayNumber,o=t.secondsOfDay,l=s-2451545,d=(24110.54841+(a=o>=43200?(l+.5)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY:(l-.5)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY)*(8640184.812866+a*(.093104+-62e-7*a)))*e%r.Math.TWO_PI+(72921158553e-15+11772758384668e-32*(s-2451545.5))*((o+.5*r.TimeConstants.SECONDS_PER_DAY)%r.TimeConstants.SECONDS_PER_DAY),h=Math.cos(d),c=Math.sin(d);return r.Utils.defined(n)||(n=new THREE.Matrix3),n.set(h,c,0,-c,h,0,0,0,1)}static localFrameToFixedFrameGenerator(e,t){if(!i.hasOwnProperty(e)||!i[e].hasOwnProperty(t))throw new Error("firstAxis and secondAxis must be east, north, up, west, south or down.");var c,u=i[e][t],p=e+t;return r.Utils.defined(a[p])?c=a[p]:(c=function(i,a,c){if(!r.Utils.defined(i))throw new Error("origin is required.");if(r.Utils.defined(c)||(c=new THREE.Matrix4),r.Math.equalsEpsilonVector3(i,h,r.Math.EPSILON14))o.fromArray(n[e],0),l.fromArray(n[t],0),d.fromArray(n[u],0);else if(r.Math.equalsEpsilon(i.x,0,r.Math.EPSILON14)&&r.Math.equalsEpsilon(i.y,0,r.Math.EPSILON14)){var p=Math.sign(i.z);o.fromArray(n[e],0),"east"!==e&&"west"!==e&&o.multiplyScalar(p),l.fromArray(n[t],0),"east"!==t&&"west"!==t&&l.multiplyScalar(p),d.fromArray(n[u],0),"east"!==u&&"west"!==u&&d.multiplyScalar(p)}else{(a=r.Utils.defaultValue(a,r.GIS.Ellipsoid.WGS84)).geodeticSurfaceNormal(i,s.up);var m=s.up,f=s.east;f.x=-i.y,f.y=i.x,f.z=0,s.east.copy(f),s.east.normalize(),s.north.copy(m),s.north.cross(f),s.down.copy(s.up),s.down.multiplyScalar(-1),s.west.copy(s.east),s.west.multiplyScalar(-1),s.south.copy(s.north),s.south.multiplyScalar(-1),o=s[e],l=s[t],d=s[u]}return c.elements[0]=o.x,c.elements[1]=o.y,c.elements[2]=o.z,c.elements[3]=0,c.elements[4]=l.x,c.elements[5]=l.y,c.elements[6]=l.z,c.elements[7]=0,c.elements[8]=d.x,c.elements[9]=d.y,c.elements[10]=d.z,c.elements[11]=0,c.elements[12]=i.x,c.elements[13]=i.y,c.elements[14]=i.z,c.elements[15]=1,c},a[p]=c),c}}c.eastNorthUpToFixedFrame=c.localFrameToFixedFrameGenerator("east","north"),r.GIS.Transforms=c}(),function(){r.GIS=r.GIS||{};var e=new THREE.Vector3;class t{constructor(e,t,i){this._radii=void 0,this._radiiSquared=void 0,this._radiiToTheFourth=void 0,this._oneOverRadii=void 0,this._oneOverRadiiSquared=void 0,this._minimumRadius=void 0,this._maximumRadius=void 0,this._centerToleranceSquared=void 0,this._squaredXOverSquaredZ=void 0,this._squaredFirstEccentricity=void 0,function(e,t,i,n){t=r.Utils.defaultValue(t,0),i=r.Utils.defaultValue(i,0),n=r.Utils.defaultValue(n,0),e._radii=new THREE.Vector3(t,i,n),e._radiiSquared=new THREE.Vector3(t*t,i*i,n*n),e._radiiToTheFourth=new THREE.Vector3(t*t*t*t,i*i*i*i,n*n*n*n),e._oneOverRadii=new THREE.Vector3(0===t?0:1/t,0===i?0:1/i,0===n?0:1/n),e._oneOverRadiiSquared=new THREE.Vector3(0===t?0:1/(t*t),0===i?0:1/(i*i),0===n?0:1/(n*n)),e._minimumRadius=Math.min(t,i,n),e._maximumRadius=Math.max(t,i,n),e._centerToleranceSquared=r.Math.EPSILON1,e._squaredFirstEccentricity=1-n*n/(t*t),0!==e._radiiSquared.z&&(e._squaredXOverSquaredZ=e._radiiSquared.x/e._radiiSquared.z)}(this,e,t,i)}get radii(){return this._radii}get radiiSquared(){return this._radiiSquared}get radiiToTheFourth(){return this._radiiToTheFourth}get oneOverRadii(){return this._oneOverRadii}get oneOverRadiiSquared(){return this._oneOverRadiiSquared}get minimumRadius(){return this._minimumRadius}get maximumRadius(){return this._maximumRadius}getPerimeterByLat(e){const t=Math.sin(e*Math.PI/180),i=this._radii.x*Math.cos(e*Math.PI/180)/Math.sqrt(1-this._squaredFirstEccentricity*t*t);return Math.PI*i*2}geodeticSurfaceNormal(t,i){if(!r.Math.equalsEpsilonVec3(t,e,r.Math.EPSILON14))return r.Utils.defined(i)||(i=new THREE.Vector3),i.copy(t),i.multiply(this._oneOverRadiiSquared),i.normalize()}}t.WGS84=Object.freeze(new t(6378137,6378137,6356752.314245179)),r.GIS.Ellipsoid=t}(),function(){r.GIS=r.GIS||{};r.GIS.GeographicTilingScheme=class{constructor(){this._numberOfLevelZeroTilesX=2,this._numberOfLevelZeroTilesY=1,this._rectangle=r.GIS.Rectangle.MAX_VALUE}getNumberOfXTilesAtLevel(e){return this._numberOfLevelZeroTilesX<<e}getNumberOfYTilesAtLevel(e){return this._numberOfLevelZeroTilesY<<e}positionToTileXY(e,t,i){var n=this._rectangle;if(r.GIS.Rectangle.contains(n,e)){var a=this.getNumberOfXTilesAtLevel(t),s=this.getNumberOfYTilesAtLevel(t),o=n.width/a,l=n.height/s,d=e.longitude;n.east<n.west&&(d+=r.Math.TWO_PI);var h=(d-n.west)/o|0;h>=a&&(h=a-1);var c=(n.north-e.latitude)/l|0;return c>=s&&(c=s-1),i?(i.x=h,i.y=c,i):new THREE.Vector2(h,c)}}}}(),function(){r.GIS=r.GIS||{};var e=[new r.GIS.Cartographic,new r.GIS.Cartographic,new r.GIS.Cartographic,new r.GIS.Cartographic],t=new THREE.Vector2,i=new r.GIS.GeographicTilingScheme;class n{constructor(){}static initialize(){var e=n._initPromise;if(e)return e;var t=new THREE.FileLoader;t.setResponseType("json");var i=`${n._viewer._staticResourcesHost}/Earth/approximateTerrainHeights.json`;return e=new Promise(((e,r)=>{t.load(i,(function(t){n._terrainHeights=t,e()}))})),n._initPromise=e,e}static getMinimumMaximumHeights(e){var t=n.getTileXYLevel(e),i=n._defaultMinTerrainHeight,r=n._defaultMaxTerrainHeight;if(t){var a=t.level+"-"+t.x+"-"+t.y,s=n._terrainHeights[a];s&&(i=s[0],r=s[1])}return{minimumTerrainHeight:i=Math.max(n._defaultMinTerrainHeight,i),maximumTerrainHeight:r}}static getTileXYLevel(a){r.GIS.Cartographic.fromRadians(a.east,a.north,0,e[0]),r.GIS.Cartographic.fromRadians(a.west,a.north,0,e[1]),r.GIS.Cartographic.fromRadians(a.east,a.south,0,e[2]),r.GIS.Cartographic.fromRadians(a.west,a.south,0,e[3]);var s,o=0,l=0,d=0,h=0,c=n._terrainHeightsMaxLevel;for(s=0;s<=c;++s){for(var u=!1,p=0;p<4;++p){var m=e[p];if(i.positionToTileXY(m,s,t),0===p)d=t.x,h=t.y;else if(d!==t.x||h!==t.y){u=!0;break}}if(u)break;o=d,l=h}if(0!==s)return{x:o,y:l,level:s>c?c:s-1}}}n._terrainHeightsMaxLevel=6,n._defaultMaxTerrainHeight=9e3,n._defaultMinTerrainHeight=-1e5,n._terrainHeights=void 0,n._initPromise=void 0,n._viewer=void 0,r.GIS.ApproximateTerrainHeights=n}(),(()=>{new THREE.Matrix4;var e;r.Object3DEx=function(e,t){THREE.Object3D.call(this),this.type="Object3DEx",this.geometry=e||r.GeomUtil.EmptyGeometry,this.material=t||r.MaterialUtil.getDefaultStandardMaterial(),this.matrixAutoUpdate=!1,this.originalId=void 0,this.drawMode=THREE.TrianglesDrawMode},r.Object3DEx.prototype=Object.create(THREE.Mesh.prototype),r.Object3DEx.prototype.constructor=r.Object3DEx,r.Object3DEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},r.Object3DEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},r.Object3DEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),null!=e.meshId?this.meshId=e.meshId:this.meshId="",e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),null!=e.visible&&(this.visible=e.visible),null!=e.isMesh&&(this.isMesh=e.isMesh),null!=e.isLine&&(this.isLine=e.isLine),null!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),null!=e.instanceOrNot?this.instanceOrNot=e.instanceOrNot:this.instanceOrNot=!1,this.renderOrder=e.renderOrder||r.EnumRenderOrder.Component,this.frustumCulled=!1,this.material.visible=!0},r.Object3DEx.prototype.clear=function(){this.geometry=r.GeomUtil.EmptyGeometry,this.material=r.MaterialUtil.DefaultMaterial,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},r.Object3DEx.prototype.isVisible=function(){return this.visible},r.Object3DEx.prototype.intersectBoxWithDistance=(e=new THREE.Box3,function(t,i){var r=this.geometry,n=this.material,a=this.matrixWorld;return i&&(a=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,i),void 0===n?-1:(r.boundingBox||r.computeBoundingBox(),e.copy(r.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e))}),r.Object3DEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),e.ray.intersectBoxWithDistance(r)},r.Object3DEx.prototype.intersectBoxWithClipPlane=function(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),r.intersectsPlane(e)},r.Object3DEx.prototype.raycastByIndices=function(){var e=new THREE.Matrix4,t=new THREE.Ray,i=new THREE.Sphere,r=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector2,o=new THREE.Vector2,l=new THREE.Vector2,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Matrix4;function p(e,t,i,p,m,f,g,v){let y=new THREE.Vector3;r.fromBufferAttribute(p,f),n.fromBufferAttribute(p,g),a.fromBufferAttribute(p,v);var M,E,x,_,b,I,T,S=function(e,t,i,r,n,a,s){var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,n,a,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(a,n,r,!0,s):i.intersectTriangle(r,n,a,o.side!==THREE.DoubleSide,s)))return null;c.copy(s),c.applyMatrix4(u);var l=t.ray.origin.distanceTo(c);return l<t.near||l>t.far?null:{distance:l,point:c.clone(),object:e}}(e,t,i,r,n,a,h);if(S){if(m&&m.array&&m.array.length&&(s.fromBufferAttribute(m,f),o.fromBufferAttribute(m,g),l.fromBufferAttribute(m,v),S.uv=(M=h,E=r,x=n,_=a,b=s,I=o,T=l,THREE.Triangle.barycoordFromPoint(M,E,x,_,d),b.multiplyScalar(d.x),I.multiplyScalar(d.y),T.multiplyScalar(d.z),b.add(I).add(T),b.clone())),p.instanceMatrix){var C=r.clone().applyMatrix4(p.instanceMatrix),w=n.clone().applyMatrix4(p.instanceMatrix),R=a.clone().applyMatrix4(p.instanceMatrix);S.face=new THREE.Face3(f,g,v,THREE.Triangle.getNormal(C,w,R,y))}else S.face=new THREE.Face3(f,g,v,THREE.Triangle.getNormal(r,n,a,y));S.faceIndex=f}return S}return function(r,n,a,s){var o=this.geometry,l=this.material;if(s){o=this.geometry,l=this.material;if((u=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,s),void 0===l)return;if(null===o.boundingSphere&&o.computeBoundingSphere(),i.copy(o.boundingSphere),i.applyMatrix4(u),!1===r.ray.intersectsSphere(i))return;if(e.copy(u).invert(),t.copy(r.ray).applyMatrix4(e),null!==o.boundingBox&&!1===t.intersectsBox(o.boundingBox))return;var d=o.index;(x=o.attributes.position).instanceMatrix=s;var h,c=o.attributes.uv;if(null!==d)for(M=0,h=d.count;M<h;M+=3)f=d.getX(M),g=d.getX(M+1),v=d.getX(M+2),(m=p(this,r,t,x,c,f,g,v))&&(m.faceIndex=Math.floor(M/3),n.push(m));else for(M=0,h=x.count;M<h;M+=3)(m=p(this,r,t,x,c,f=M,g=M+1,v=M+2))&&(m.index=f,n.push(m))}else{if(u=this.matrixWorld,void 0===l)return;if(i.copy(this.computeBoundingSphere(a)),i.applyMatrix4(u),!1===r.ray.intersectsSphere(i))return;e.copy(u).invert(),t.copy(r.ray).applyMatrix4(e);var m,f,g,v,y=this.computeBoundingBox(a);if(!1===t.intersectsBox(y))return;var M,E,x=o.attributes.position,_=(c=o.attributes.uv,a.indexStart),b=a.indexStart+a.indexCount,I=o.getIndex().array;for(M=_,E=b;M<E;M+=3)f=I[M],g=I[M+1],v=I[M+2],(m=p(this,r,t,x,c,f,g,v))&&(m.faceIndex=Math.floor(M/3),n.push(m))}}}(),r.Object3DEx.prototype.minDistanceToTri=function(e,t,i){function r(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function n(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function a(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function s(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function o(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function l(e,t,i,l){var d,h,c,u,p,m,f=s(t,l),g=s(t,t),v=s(l,l),y=r(i,e),M=s(t,y),E=s(l,y);return(d=(M*v-E*f)/(g*v-f*f))<0||isNaN(d)?d=0:d>1&&(d=1),(h=(d*f-E)/v)<=0||isNaN(h)?(u=i,(d=M/g)<=0||isNaN(d)?(c=e,p=r(i,e)):d>=1?p=r(i,c=n(e,t)):(c=a(e,t,d),m=o(y,t),p=o(t,m))):h>=1?(u=n(i,l),(d=(f+M)/g)<=0||isNaN(d)?(c=e,p=r(u,e)):d>=1?p=r(u,c=n(e,t)):(c=a(e,t,d),m=o(y=r(u,e),t),p=o(t,m))):(u=a(i,l,h),d<=0||isNaN(d)?(c=e,m=o(y,l),p=o(l,m)):d>=1?(m=o(y=r(i,c=n(e,t)),l),p=o(l,m)):(c=a(e,t,d),s(p=o(t,l),y)<0&&p.multiplyScalar(-1))),{vec:p,closestP:c,closestQ:u}}function d(e,t){var i,n,d,h,c,u,p=[],m=[];p[0]=r(e[1],e[0]),p[1]=r(e[2],e[1]),p[2]=r(e[0],e[2]),m[0]=r(t[1],t[0]),m[1]=r(t[2],t[1]),m[2]=r(t[0],t[2]);for(var f=0,g=e[0].distanceToSquared(t[0])+1,v=0;v<3;v++)for(var y=0;y<3;y++){var M=l(e[v],p[v],t[y],m[y]);d=M.vec,i=M.closestP;var E=s(h=r(n=M.closestQ,i),h);if(E<=g){c=i.clone(),u=n.clone(),g=E;var x=s(r(e[(v+2)%3],i),d),_=s(r(t[(y+2)%3],n),d);if(x<=0&&_>=0)return{start:i.clone(),end:n.clone(),minDistance:Math.sqrt(E)};x<0&&(x=0),_>0&&(_=0),s(h,d)-x+_>0&&(f=1)}}var b=o(p[0],p[1]),I=s(b,b);if(I>1e-15){var T=[];h=r(e[0],t[0]),T[0]=s(h,b),h=r(e[0],t[1]),T[1]=s(h,b),h=r(e[0],t[2]),T[2]=s(h,b);var S=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(S=T[0]<T[1]?0:1,T[2]<T[S]&&(S=2)):T[0]<0&&T[1]<0&&T[2]<0&&(S=T[0]>T[1]?0:1,T[2]>T[S]&&(S=2)),S>=0&&(f=1,s(h=r(t[S],e[0]),o(b,p[0]))>0&&s(h=r(t[S],e[1]),o(b,p[1]))>0&&s(h=r(t[S],e[2]),o(b,p[2]))>0))return i=a(t[S],b,T[S]/I),n=t[S].clone(),{start:i.clone(),end:n,minDistance:i.distanceTo(n)}}var C=o(m[0],m[1]),w=s(C,C);if(w>1e-15){var R=[];h=r(t[0],e[0]),R[0]=s(h,C),h=r(t[0],e[1]),R[1]=s(h,C),h=r(t[0],e[2]),R[2]=s(h,C);S=-1;if(R[0]>0&&R[1]>0&&R[2]>0?(S=R[0]<R[1]?0:1,R[2]<R[S]&&(S=2)):R[0]<0&&R[1]<0&&R[2]<0&&(S=R[0]>R[1]?0:1,R[2]>R[S]&&(S=2)),S>=0&&(f=1,s(h=r(e[S],t[0]),o(C,m[0]))>0&&s(h=r(e[S],t[1]),o(C,m[1]))>0&&s(h=r(e[S],t[2]),o(C,m[2]))>0))return{start:i=e[S].clone(),end:(n=a(e[S],C,R[S]/w)).clone(),minDistance:i.distanceTo(n)}}return f?(i=c,n=u,{start:c.clone(),end:u.clone(),minDistance:Math.sqrt(g)}):{start:c.clone(),end:u.clone(),minDistance:0}}var h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3;function p(e,t,i,r,n,a){h.fromBufferAttribute(t,i),c.fromBufferAttribute(t,r),u.fromBufferAttribute(t,n),a&&(h.applyMatrix4(a),c.applyMatrix4(a),u.applyMatrix4(a)),e.push(h),e.push(c),e.push(u)}for(var m={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},f=this.geometry,g=f.attributes.position,v=t?t.indexStart:0,y=f.getIndex().array,M=v,E=t?t.indexStart+t.indexCount:y.length;M<E;M+=3){var x=[];p(x,g,y[M],y[M+1],y[M+2],i);var _=d(e,x);if(_.minDistance<=0)return m.minDistance=0,m;m.minDistance>_.minDistance&&(m.minDistance=_.minDistance,m.start=_.start.clone(),m.end=_.end.clone())}return m},r.Object3DEx.prototype.computeBoundingBox=function(e){var t,i,r=new THREE.Box3,n=this.geometry.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=n.length),this.setBoundingBoxFromArray(r,n,t,i),r},r.Object3DEx.prototype.computeBoundingSphere=function(e){var t,i,r=new THREE.Box3,n=new THREE.Vector3,a=this.geometry.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length);var s=new THREE.Sphere,o=s.center;this.setBoundingBoxFromArray(r,a,t,i),r.getCenter(o);for(var l=0,d=t,h=i;d<h;d+=3)n.x=a[d],n.y=a[d+1],n.z=a[d+2],l=Math.max(l,o.distanceToSquared(n));return s.radius=Math.sqrt(l),s},r.Object3DEx.prototype.setBoundingBoxFromArray=function(e,t,i,r){for(var n=1/0,a=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=i,c=r;h<c;h+=3){var u=t[h],p=t[h+1],m=t[h+2];u<n&&(n=u),p<a&&(a=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}e.min.set(n,a,s),e.max.set(o,l,d)}})(),r.MaterialEx=function(){this.materialDefaultParams={color:14540253,opacity:.5,transparent:!0,side:THREE.DoubleSide},this.material=r.MaterialUtil.createStandardMaterial(this.materialDefaultParams)},r.MaterialEx.prototype.destroy=function(){this.material=null},r.MaterialEx.prototype.resetColor=function(){this.material.color.setHex(this.materialDefaultParams.color)},r.MaterialEx.prototype.resetOpacity=function(){this.material.opacity=this.materialDefaultParams.opacity},r.MaterialEx.prototype.reset=function(){this.material.color.setHex(this.materialDefaultParams.color),this.material.opacity=this.materialDefaultParams.opacity,this.material.transparent=this.materialDefaultParams.transparent,this.material.side=this.materialDefaultParams.side,this.material.needsUpdate=!0},(()=>{let e=new THREE.Matrix4,t=new THREE.Ray,i=new THREE.Sphere,n=new THREE.Vector3,a=new THREE.Vector3;class s extends THREE.Points{constructor(e,t){super(e,t),this.pointIds=[],this.size=1,this.initSize={}}calcPositionAfterYOffset(t,i,r,n,a){let s=t.clone();return s.applyMatrix4(a),s.project(n),s.y+=i/r,s.unproject(n),s.applyMatrix4(e),s}raycast(r,a){const s=this.geometry,o=this.matrixWorld,l=this.size,d=r.camera,h=r.viewportSize.height;e.copy(o).invert(),null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere);const c=i.center,u=this.calcPositionAfterYOffset(c,l,h,d,o),p=u.distanceToSquared(c);if(i.radius+=p,i.center.copy(u),i.applyMatrix4(o),!1===r.ray.intersectsSphere(i))return;t.copy(r.ray).applyMatrix4(e);let m=l;if(s.isBufferGeometry){const e=s.index,i=s.attributes,l=i.position.array;let c,u=!1;if(i.attrSize&&(u=!0,c=i.attrSize.array),null!==e){const i=e.array;i.length;for(const e of i)n.fromArray(l,3*e),u&&(m=c[e]),this.testPoint(n,m,e,h,d,o,t,r,a)}else for(var f=0,g=l.length/3;f<g;f++)n.fromArray(l,3*f),u&&(m=c[f]),this.testPoint(n,m,f,h,d,o,t,r,a)}else{const e=s.vertices;for(f=0,g=e.length;f<g;f++)this.testPoint(e[f],m,f,h,d,o,t,r,a)}}testPoint(e,t,i,r,n,s,o,l,d){const h=this.calcPositionAfterYOffset(e,t,r,n,s),c=h.distanceToSquared(e),u=o.distanceSqToPoint(h);if(u<c){o.closestPointToPoint(h,a),a.applyMatrix4(s);const e=l.ray.origin.distanceTo(a);if(e<l.near||e>l.far)return;d.push({id:this.pointIds[i],distance:e,distanceToRay:Math.sqrt(u),point:a.clone(),index:i,face:null,object:this})}}setAttributeSize(e,t){const i=this.geometry.attributes;i.attrSize&&(i.attrSize.array[e]=t,i.attrSize.needsUpdate=!0)}getAttributeSize(e){const t=this.geometry.attributes;let i=this.size;return t.attrSize&&(i=t.attrSize.array[e]),i}getAttributeHoverAnimation(e){const t=this.geometry.attributes;let i=!0;return t.attrHoverAnimation&&(i=t.attrHoverAnimation.array[e]),i}}r.PointsEx=s})(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;const i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3;class s extends THREE.Mesh{constructor(e,t){super(e=e||r.GeomUtil.EmptyGeometry,t=t||r.MaterialUtil.getDefaultStandardMaterial()),this.type="MeshEx",this.matrixAutoUpdate=!1,this.originalId=void 0,this.pickable=!0,this._matrixRoot=void 0,this._normalMatrixRoot=void 0,this.isMeshQuantization=!1,this._uniformsUpdateCallbackMap=null}onUpdateUniform(e,t){this.updateShadowUniform(e,t),this._updateAllUniforms(e,t)}updateShadowUniform(e,t){}_updateAllUniforms(e,t){const i=this._uniformsUpdateCallbackMap;if(!i)return;Object.keys(i).forEach((r=>{const n=i[r];n&&n(e,t)}))}_hasUniformUpdateCallback(e){return!(!this._uniformsUpdateCallbackMap||!this._uniformsUpdateCallbackMap[e])}addUniformUpdateCallback(e,t){t&&(this._uniformsUpdateCallbackMap||(this._uniformsUpdateCallbackMap={}),this._uniformsUpdateCallbackMap[e]||(this._uniformsUpdateCallbackMap[e]=t))}removeUniformUpdateCallback(e){this._hasUniformUpdateCallback(e)&&delete this._uniformsUpdateCallbackMap[e]}removeAllUniformsUpdateCallback(){const e=this._uniformsUpdateCallbackMap;if(!e)return;Object.keys(e).forEach((t=>{e[t]&&delete e[t]})),this._uniformsUpdateCallbackMap=null}init(e){e&&e.parent&&e.parent.add(this)}destroy(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null,this.removeAllUniformsUpdateCallback()}spawn(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),this.databagId=r.Utils.isDefined(e.databagId)?e.databagId:"",this.fileId=r.Utils.isDefined(e.fileId)?e.fileId:"",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),null!=e.visible&&(this.visible=e.visible),null!=e.isMesh&&(this.isMesh=e.isMesh),null!=e.isLine&&(this.isLine=e.isLine),null!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),null!=e.pickable?this.pickable=e.pickable:this.pickable=!0,this.groupOrder=e.groupOrder||r.EnumRenderOrder.Component,this.renderOrder=e.renderOrder||r.EnumRenderOrder.Component,this.frustumCulled=!1,this.material.visible=!0}clear(){this.geometry=r.GeomUtil.EmptyGeometry,this.material=r.MaterialUtil.DefaultMaterial,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1}isVisible(){return this.visible}set matrixRoot(e){e instanceof THREE.Matrix4?this._matrixRoot=e:this._matrixRoot=new THREE.Matrix4,this._normalMatrixRoot=(new THREE.Matrix3).setFromMatrix4(this._matrixRoot.clone().transpose())}get matrixRoot(){return this._matrixRoot}get quantizationNormalMatrix(){return this._normalMatrixRoot}intersectBoxWithDistance(e,t){const i=new THREE.Box3;return((e,t)=>{var r=this.geometry,n=this.material,a=this.matrixWorld;return t&&(a=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,t),void 0===n?-1:(r.boundingBox||r.computeBoundingBox(),i.copy(r.boundingBox),i.applyMatrix4(a),e.ray.intersectBoxWithDistance(i))})(e,t)}intersectBoxWithDistanceByIndices(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),e.ray.intersectBoxWithDistance(r)}intersectBoxWithClipPlane(e,t){var i=this.matrixWorld,r=t.boundingBox.clone();return r.applyMatrix4(i),r.intersectsPlane(e)}intersectBoxWithPlaneMesh(e,t){const i=this.matrixWorld;let n=t.boundingBox.clone();n.applyMatrix4(i);const a=e.matrixWorld,s=e.geometry.attributes.position;let o=[];for(let e=0;e<s.count;e++)o.push((new THREE.Vector3).fromBufferAttribute(s,e));const l=o.map((e=>e.clone().applyMatrix4(a))),d=e.geometry.index.array,h=d.length;for(let e=0;e<h/3;++e){const t=(new THREE.Triangle).setFromPointsAndIndices(l,d[e],d[e+1],d[e+2]);if(r.GeomUtil.boxIntersectsTriangle(n,t))return!0}return!1}_upOrUnderSide(e,t,r,s,o){i.subVectors(r,t),n.subVectors(s,t),a.subVectors(o,t);const l=i.dot(e),d=n.dot(e),h=a.dot(e);return l*d>0&&d*h>0&&l*h>0||l*d<0&&d*h<0&&l*h<0}_traverIntersectionPoints(i,r,n){var a=i.clone();r.isWorldPlane||(e.copy(this.matrixWorld).invert(),a=a.applyMatrix4(e));let s=new THREE.Vector3;function o(e,i,r){t=i.intersectLine(e,t),t?n&&n(t,r):t=new THREE.Vector3}a.coplanarPoint(s);var l=this.geometry.getIndex().array,d=this.geometry.getAttribute("position").array,h=r.isInstance?0:r.indexStart,c=r.isInstance?l.length:r.indexStart+r.indexCount;if(!(h<0))for(var u,p,m,f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Line3,M=new THREE.Line3,E=new THREE.Line3,x=h,_=c;x<_;x+=3){const e=x/3;u=3*l[x],p=3*l[x+1],m=3*l[x+2],f.set(d[u],d[u+1],d[u+2]),g.set(d[p],d[p+1],d[p+2]),v.set(d[m],d[m+1],d[m+2]),r.isInstance&&(f.applyMatrix4(r.matrix),g.applyMatrix4(r.matrix),v.applyMatrix4(r.matrix)),this._upOrUnderSide(a.normal,s,f,g,v)||(y.set(f,g),M.set(g,v),E.set(v,f),o(y,a,e),o(M,a,e),o(E,a,e))}}getIntersectionPoints(e,t,i,r){this._traverIntersectionPoints(e,t,((e,t)=>{i.push(e.x,e.y,e.z)})),r&&r.setFromArray(i)}getIntersectionContours(e,t,i){let n=[];if(this._traverIntersectionPoints(e,t,((e,t)=>{let i=e.clone();i.faceIndex=t,i.checked=!1,n.push(i)})),0===n.length)return;r.ClipPlaneContourManager.getContours(n,[],!0).map((e=>{let t=[];e.map((e=>{t.push(e)})),i.push(t)}))}intersectByBox(t,i,r,n){var a=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3;let l=new THREE.Triangle,d=(e,t,i,r,n)=>(a.fromBufferAttribute(t,i),s.fromBufferAttribute(t,r),o.fromBufferAttribute(t,n),l.set(a,s,o),e.intersectsTriangle(l));var h=this.geometry,c={distance:0};if(void 0===this.material)return!1;if(n){e.copy(this.matrix).invert();let a=t.clone();a.applyMatrix4(e),e.copy(n).invert(),a.applyMatrix4(e);var u=this.computeBoundingBox(r);if(!1===a.intersectsBox(u))return!1;var p,m=h.index;if((v=h.attributes.position).instanceMatrix=n,null!==m){for(f=0,p=m.count;f<p;f+=3)if(d(a,v,m.getX(f),m.getX(f+1),m.getX(f+2)))return i.push(c),!0}else for(f=0,p=v.count;f<p;f+=3)if(d(a,v,f,f+1,f+2))return i.push(c),!0;delete v.instanceMatrix}else{e.copy(this.matrix).invert();let n=t.clone();n.applyMatrix4(e);u=this.computeBoundingBox(r);if(!1===n.intersectsBox(u))return!1;var f,g,v=h.attributes.position,y=r.indexStart,M=r.indexStart+r.indexCount,E=h.getIndex().array;for(f=y,g=M;f<g;f+=3)if(d(n,v,E[f],E[f+1],E[f+2]))return i.push(c),!0}return!1}raycastByIndices(t,i,n,a,s,o){var l=new THREE.Ray,d=new THREE.Sphere,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector2,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,M=new THREE.Matrix4;let E=(e,t,i,r,n,a,s,o,l)=>{let d=new THREE.Vector3;h.fromBufferAttribute(r,a),c.fromBufferAttribute(r,s),u.fromBufferAttribute(r,o);var E,x,_,b,I,T,S,C=((e,t,i,r,n,a,s)=>{var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,n,a,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(a,n,r,!0,s):i.intersectTriangle(r,n,a,o.side!==THREE.DoubleSide,s)))return null;y.copy(s),y.applyMatrix4(M);var l=t.ray.origin.distanceTo(y);return l<t.near||l>t.far?null:{distance:l,point:y.clone(),object:e}})(e,t,i,h,c,u,v);if(C){if(n&&n.array&&n.array.length&&(p.fromBufferAttribute(n,a),m.fromBufferAttribute(n,s),f.fromBufferAttribute(n,o),C.uv=(E=v,x=h,_=c,b=u,I=p,T=m,S=f,THREE.Triangle.getBarycoord(E,x,_,b,g),I.multiplyScalar(g.x),T.multiplyScalar(g.y),S.multiplyScalar(g.z),I.add(T).add(S),I.clone())),r.instanceMatrix){var w=h.clone().applyMatrix4(r.instanceMatrix),R=c.clone().applyMatrix4(r.instanceMatrix),B=u.clone().applyMatrix4(r.instanceMatrix);l&&(w.applyMatrix4(l),R.applyMatrix4(l),B.applyMatrix4(l)),C.face=new THREE.Face3(a,s,o,THREE.Triangle.getNormal(w,R,B,d))}else l&&(h.applyMatrix4(this.matrix.clone()).applyMatrix4(l),c.applyMatrix4(this.matrix.clone()).applyMatrix4(l),u.applyMatrix4(this.matrix.clone()).applyMatrix4(l)),C.face=new THREE.Face3(a,s,o,THREE.Triangle.getNormal(h,c,u,d));C.faceIndex=a}return C};return((t,i,n,a,s,o)=>{var h=this.geometry,c=this.material;if(a){h=this.geometry,c=this.material;if((M=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,a),void 0===c)return;if(null===h.boundingSphere&&h.computeBoundingSphere(),d.copy(h.boundingSphere),d.applyMatrix4(M),!1===t.ray.intersectsSphere(d))return;if(e.copy(M).invert(),l.copy(t.ray).applyMatrix4(e),null!==h.boundingBox&&!1===l.intersectsBox(h.boundingBox))return;var u=h.index;(I=h.attributes.position).instanceMatrix=a;var p,m=h.attributes.uv;if(null!==u)for(_=0,p=u.count;_<p;_+=3)g=u.getX(_),v=u.getX(_+1),y=u.getX(_+2),(f=E(this,t,l,I,m,g,v,y,o))&&(f.faceIndex=Math.floor(_/3),i.push(f));else for(_=0,p=I.count;_<p;_+=3)(f=E(this,t,l,I,m,g=_,v=_+1,y=_+2,o))&&(f.index=g,i.push(f));delete I.instanceMatrix}else{if(M=this.matrixWorld.clone(),void 0===c)return;let a=null;if(n.isExploded)a=this.computeBoundingSphere(n);else{const e=r.GeoBoundingSphereUtil.createGeometryId(this.geometry,n);a=r.GeoBoundingSphereUtil.getBoundingSphere(e),r.Utils.defined(a)||(a=this.computeBoundingSphere(n),r.GeoBoundingSphereUtil.setBoundingSphere(e,a))}if(d.copy(a),d.applyMatrix4(M),!1===t.ray.intersectsSphere(d))return;e.copy(M).invert(),l.copy(t.ray).applyMatrix4(e);var f,g,v,y,x=this.computeBoundingBox(n);if(!1===l.intersectsBox(x))return;var _,b,I=h.attributes.position,T=(m=h.attributes.uv,n.indexStart),S=n.indexStart+n.indexCount,C=h.getIndex().array;for(_=T,b=S;_<b;_+=3)g=C[_],v=C[_+1],y=C[_+2],(f=E(this,t,l,I,m,g,v,y,o))&&(f.faceIndex=Math.floor(_/3),i.push(f))}})(t,i,n,a,0,o)}raycastByIndices2(e,t,i,r){var n=new THREE.Matrix4,a=new THREE.Ray,s=new THREE.Sphere,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector3,m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Matrix4;let v=(e,t,i,r,n,a,s,v)=>{let y=new THREE.Vector3;o.fromBufferAttribute(r,a),l.fromBufferAttribute(r,s),d.fromBufferAttribute(r,v);var M,E,x,_,b,I,T,S=((e,t,i,r,n,a,s)=>{var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,n,a,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(a,n,r,!0,s):i.intersectTriangle(r,n,a,o.side!==THREE.DoubleSide,s)))return null;f.copy(s),f.applyMatrix4(g);var l=t.ray.origin.distanceTo(f);return l<t.near||l>t.far?null:{distance:l,point:f.clone(),object:e}})(e,t,i,o,l,d,m);if(S){if(n&&n.array&&n.array.length&&(h.fromBufferAttribute(n,a),c.fromBufferAttribute(n,s),u.fromBufferAttribute(n,v),S.uv=(M=m,E=o,x=l,_=d,b=h,I=c,T=u,THREE.Triangle.getBarycoord(M,E,x,_,p),b.multiplyScalar(p.x),I.multiplyScalar(p.y),T.multiplyScalar(p.z),b.add(I).add(T),b.clone())),r.instanceMatrix){var C=o.clone().applyMatrix4(r.instanceMatrix),w=l.clone().applyMatrix4(r.instanceMatrix),R=d.clone().applyMatrix4(r.instanceMatrix);S.face=new THREE.Face3(a,s,v,THREE.Triangle.getNormal(C,w,R,y))}else S.face=new THREE.Face3(a,s,v,THREE.Triangle.getNormal(o,l,d,y));S.faceIndex=a}return S};return((e,t,i,r)=>{var o=this.geometry,l=this.material;if(r=!!r,i.isInstanced){if(void 0===i.matrix)return;if(g.multiplyMatrices(this.matrixWorld,i.matrix),void 0===l)return;if(r&&(null===o.boundingSphere&&o.computeBoundingSphere(),s.copy(o.boundingSphere),s.applyMatrix4(g),!1===e.ray.intersectsSphere(s)))return;if(n.copy(g).invert(),a.copy(e.ray).applyMatrix4(n),r&&null!==o.boundingBox&&!1===a.intersectsBox(o.boundingBox))return;var d=o.index;(x=o.attributes.position).instanceMatrix=i.matrix;var h,c=o.attributes.uv;if(null!==d)for(M=0,h=d.count;M<h;M+=3)m=d.getX(M),f=d.getX(M+1),y=d.getX(M+2),(p=v(this,e,a,x,c,m,f,y))&&(p.faceIndex=Math.floor(M/3),t.push(p));else for(M=0,h=x.count;M<h;M+=3)(p=v(this,e,a,x,c,m=M,f=M+1,y=M+2))&&(p.index=m,t.push(p));delete x.instanceMatrix}else if(i.matrix?g.multiplyMatrices(this.matrixWorld,i.matrix):g=this.matrixWorld,void 0!==l&&(!r||(s.copy(this.computeBoundingSphere(i)),s.applyMatrix4(g),!1!==e.ray.intersectsSphere(s)))){if(n.copy(g).invert(),a.copy(e.ray).applyMatrix4(n),r){var u=this.computeBoundingBox(i);if(!1===a.intersectsBox(u))return}var p,m,f,y,M,E,x=o.attributes.position,_=(c=o.attributes.uv,i.indexStart),b=i.indexStart+i.indexCount,I=o.getIndex().array;for(M=_,E=b;M<E;M+=3)m=I[M],f=I[M+1],y=I[M+2],(p=v(this,e,a,x,c,m,f,y))&&(p.faceIndex=Math.floor(M/3),t.push(p))}})(e,t,i,r)}computeBoundingBox(e){var t,i,r=new THREE.Box3,n=this.geometry.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=n.length),this.setBoundingBoxFromArray(r,n,t,i),r}computeBoundingSphere(e){var t,i,r=new THREE.Box3,n=new THREE.Vector3,a=this.geometry.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length);var s=new THREE.Sphere,o=s.center;this.setBoundingBoxFromArray(r,a,t,i),r.getCenter(o);for(var l=0,d=t,h=i;d<h;d+=3)n.x=a[d],n.y=a[d+1],n.z=a[d+2],l=Math.max(l,o.distanceToSquared(n));return s.radius=Math.sqrt(l),s}setBoundingBoxFromArray(e,t,i,r){for(var n=1/0,a=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=i,c=r;h<c;h+=3){var u=t[h],p=t[h+1],m=t[h+2];u<n&&(n=u),p<a&&(a=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}e.min.set(n,a,s),e.max.set(o,l,d)}onBeforeRender(e,t,i,n,a,s){if(this.isMeshQuantization&&a.uniforms){const e="quantizationNormalMatrix";this._hasUniformUpdateCallback(e)||this.addUniformUpdateCallback(e,((e,t)=>{e.setValue(t,"quantizationNormalMatrix",this.quantizationNormalMatrix)})),r.Utils.defined(a.defines)||(a.defines={}),a.defines.MESHOPTQUANTIZATION="",void 0===a.uniforms.quantizationNormalMatrix&&(a.uniforms.quantizationNormalMatrix={value:new THREE.Matrix3}),a.uniforms.quantizationNormalMatrix.value.copy(this._normalMatrixRoot)}r.GroundDrawingManager.onBeforeRenderFunc(a,this)}onAfterRender(e,t,i,r,n,a){this.isMeshQuantization&&n.uniforms&&n.uniforms.quantizationNormalMatrix.value.identity()}}r.MeshEx=s})(),function(){class e extends THREE.LineSegments{constructor(e,t){super(e,t),this.type="SkinnedMesh",this.bindMode="attached",this.isSkinnedMesh=!0,this.bindMatrix=new THREE.Matrix4,this.bindMatrixInverse=new THREE.Matrix4,this.init()}init(){const e=this.initBones(),t=new THREE.Skeleton(e);this.bind(t,this.matrixWorld),this.normalizeSkinWeights()}initBones(){var e,t,i,r,n=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,r=this.geometry.bones.length;i<r;i++)t=this.geometry.bones[i],e=new THREE.Bone,n.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(i=0,r=this.geometry.bones.length;i<r;i++)-1!==(t=this.geometry.bones[i]).parent&&null!==t.parent&&void 0!==n[t.parent]?n[t.parent].add(n[i]):this.add(n[i])}return this.updateMatrixWorld(!0),n}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var i=this.geometry.skinWeights[t];(e=1/i.manhattanLength())!==1/0?i.multiplyScalar(e):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var r=new THREE.Vector4,n=this.geometry.attributes.skinWeight;for(t=0;t<n.count;t++)r.x=n.getX(t),r.y=n.getY(t),r.z=n.getZ(t),r.w=n.getW(t),(e=1/r.manhattanLength())!==1/0?r.multiplyScalar(e):r.set(1,0,0,0),n.setXYZW(t,r.x,r.y,r.z,r.w)}}updateMatrixWorld(e){THREE.LineSegments.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}clone(){return new this.constructor(this.geometry,this.material).copy(this)}}r.SkinnedLine=e,r.SkinnedLineEx=class extends e{constructor(e,t){super(e,t)}init(){this.bindMatrixInverseReal=new THREE.Matrix4;const e=this.initBones(),t=new THREE.SkeletonEx(e);this.bind(t,this.matrixWorld),this.normalizeSkinWeights()}getBindMatrixInverse(){return this.bindMatrixInverseReal}bind(e,t){this.skeleton&&(this.skeleton.associatedSkinnedMesh=null),super.bind(e,t),this.bindMatrixInverseReal.copy(this.bindMatrix).invert(),this.skeleton.associatedSkinnedMesh=this}updateMatrixWorld(e){THREE.LineSegments.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?(this.bindMatrixInverseReal.copy(this.matrixWorld).invert(),this.bindMatrixInverse.identity()):"detached"===this.bindMode?(this.bindMatrixInverse.copy(this.bindMatrix).invert(),this.bindMatrixInverseReal.copy(this.bindMatrix).invert()):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}}}(),function(){const e=new THREE.Vector3,t=new THREE.Vector4,i=new THREE.Vector4,r=new THREE.Vector3,n=new THREE.Matrix4;class a extends THREE.SkinnedMesh{constructor(e,t){super(e,t),this.isSkinnedMeshEx=!0,this.bindMatrixInverseReal=new THREE.Matrix4}getBindMatrixInverse(){return this.bindMatrixInverseReal}copy(e){return super.copy(e),this.isSkinnedMeshEx=e.isSkinnedMeshEx,this.bindMatrixInverseReal.copy(e.bindMatrixInverseReal),this}bind(e,t){this.skeleton&&(this.skeleton.associatedSkinnedMesh=null),super.bind(e,t),this.bindMatrixInverseReal.copy(this.bindMatrix).invert(),this.skeleton.associatedSkinnedMesh=this}updateMatrixWorld(e){THREE.Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?(this.bindMatrixInverseReal.copy(this.matrixWorld).invert(),this.bindMatrixInverse.identity()):"detached"===this.bindMode?(this.bindMatrixInverse.copy(this.bindMatrix).invert(),this.bindMatrixInverseReal.copy(this.bindMatrix).invert()):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}boneTransform(a,s){const o=this.skeleton,l=this.geometry;t.fromBufferAttribute(l.attributes.skinIndex,a),i.fromBufferAttribute(l.attributes.skinWeight,a),e.fromBufferAttribute(l.attributes.position,a).applyMatrix4(this.bindMatrix),s.set(0,0,0);for(let a=0;a<4;a++){const l=i.getComponent(a);if(0!==l){const i=t.getComponent(a);n.multiplyMatrices(o.bones[i].matrixWorld,o.boneInverses[i]),s.addScaledVector(r.copy(e).applyMatrix4(n),l)}}return s.applyMatrix4(this.bindMatrixInverseReal)}}THREE.SkinnedMeshEx=a}(),function(){const e=new THREE.Matrix4,t=new THREE.Matrix4;class i extends THREE.Skeleton{constructor(e=[],t=[]){super(e,t),this.isSkinnedMeshEx=!0,this.associatedSkinnedMesh=null}clone(){return new i(this.bones,this.boneInverses)}getBindMatrixInverse(){return this.associatedSkinnedMesh?this.associatedSkinnedMesh.getBindMatrixInverse():void 0}update(){const i=this.bones,r=this.boneInverses,n=this.boneMatrices,a=this.boneTexture,s=this.getBindMatrixInverse();for(let a=0,o=i.length;a<o;a++){const o=i[a]?i[a].matrixWorld:t;e.multiplyMatrices(o,r[a]),s&&e.premultiply(s),e.toArray(n,16*a)}null!==a&&(a.needsUpdate=!0)}}THREE.SkeletonEx=i}(),THREE.Wireframe=function(e,t){THREE.Mesh.call(this),this.type="Wireframe",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Wireframe.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.Wireframe,isWireframe:!0,computeLineDistances:(S=new THREE.Vector3,C=new THREE.Vector3,function(){for(var e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,r=new Float32Array(2*t.data.count),n=0,a=0,s=t.data.count;n<s;n++,a+=2)S.fromBufferAttribute(t,n),C.fromBufferAttribute(i,n),r[a]=0===a?0:r[a-1],r[a+1]=r[a]+S.distanceTo(C);var o=new THREE.InstancedInterleavedBuffer(r,2,1);return e.setAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(o,1,0)),e.setAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(o,1,1)),this}),copy:function(e){return this}}),THREE.WireframeGeometry2=function(e){THREE.LineSegmentsGeometry.call(this),this.type="WireframeGeometry2",this.fromWireframeGeometry(new THREE.WireframeGeometry(e))},THREE.WireframeGeometry2.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.WireframeGeometry2,isWireframeGeometry2:!0,copy:function(e){return this}}),function(){class e extends THREE.LineSegments{constructor(e,t){super((new THREE.BufferGeometry).setAttribute("position",new THREE.BufferAttribute(new Float32Array(72),3)),new THREE.LineBasicMaterial({color:t})),void 0!==e&&this.updateBBox(e)}unload(){}updateBBox(e){var t=e.min,i=e.max,r=this.geometry.attributes.position.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=t.x,r[4]=i.y,r[5]=i.z,r[6]=t.x,r[7]=i.y,r[8]=i.z,r[9]=t.x,r[10]=t.y,r[11]=i.z,r[12]=t.x,r[13]=t.y,r[14]=i.z,r[15]=i.x,r[16]=t.y,r[17]=i.z,r[18]=i.x,r[19]=t.y,r[20]=i.z,r[21]=i.x,r[22]=i.y,r[23]=i.z,r[24]=i.x,r[25]=i.y,r[26]=t.z,r[27]=t.x,r[28]=i.y,r[29]=t.z,r[30]=t.x,r[31]=i.y,r[32]=t.z,r[33]=t.x,r[34]=t.y,r[35]=t.z,r[36]=t.x,r[37]=t.y,r[38]=t.z,r[39]=i.x,r[40]=t.y,r[41]=t.z,r[42]=i.x,r[43]=t.y,r[44]=t.z,r[45]=i.x,r[46]=i.y,r[47]=t.z,r[48]=i.x,r[49]=i.y,r[50]=i.z,r[51]=i.x,r[52]=i.y,r[53]=t.z,r[54]=t.x,r[55]=i.y,r[56]=i.z,r[57]=t.x,r[58]=i.y,r[59]=t.z,r[60]=t.x,r[61]=t.y,r[62]=i.z,r[63]=t.x,r[64]=t.y,r[65]=t.z,r[66]=i.x,r[67]=t.y,r[68]=i.z,r[69]=i.x,r[70]=t.y,r[71]=t.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.matrixAutoUpdate=!1}}r.BBoxNode=e}(),THREE.PlaneBufferGeometry2=function(e,t,i){THREE.BufferGeometry.call(this),this.type="PlaneBufferGeometry2";let r=e[0],n=e[1],a=e[2],s=n.clone().distanceTo(a),o=r.clone().distanceTo(n),l=a.clone().sub(n).normalize(),d=n.clone().sub(r).normalize();var h,c,u=Math.floor(t)||1,p=Math.floor(i)||1,m=u+1,f=p+1,g=s/u,v=o/p,y=[],M=[],E=[],x=[];let _=e[0].clone(),b=l.clone().cross(d).normalize();for(c=0;c<f;c++){let e=d.clone().multiplyScalar(c*v);for(h=0;h<m;h++){let t=l.clone().multiplyScalar(h*g),i=_.clone().add(t.add(e));M.push(i.x,i.y,i.z),E.push(b),x.push(h/u),x.push(1-c/p)}}for(c=0;c<p;c++)for(h=0;h<u;h++){var I=h+m*c,T=h+m*(c+1),S=h+1+m*(c+1),C=h+1+m*c;y.push(I,T,C),y.push(T,S,C)}this.setIndex(y),this.setAttribute("position",new THREE.Float32BufferAttribute(M,3)),this.setAttribute("normal",new THREE.Float32BufferAttribute(E,3)),this.setAttribute("uv",new THREE.Float32BufferAttribute(x,2))},THREE.PlaneBufferGeometry2.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.PlaneBufferGeometry2.prototype.constructor=THREE.PlaneBufferGeometry2,function(){var e=[0,2,1,0,3,2,0,7,3,0,4,7,0,5,4,0,1,5,5,7,4,5,6,7,5,2,6,5,1,2,3,6,2,3,7,6],t=e.length,i=1e-5,n=Math.cos(THREE.Math.degToRad(30)),a=Math.cos(THREE.Math.degToRad(150)),s=new r.GIS.Cartographic,o=new r.GIS.Cartographic,l=[s,o],d=new r.GIS.Rectangle;class h extends THREE.BufferGeometry{constructor(e){super(),this.type="GroundCurveGeometry",this.curve=void 0,this.viewer=void 0,this.tileManager=void 0,this.curveType=void 0,this.minHeight=-1e3,this.maxHeight=1e3,this.lowest=100,this.localPositions=[],this._initialized=!1,this._options=e;var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=t.createCurve(e),r=t.createGeometry(i),n=t.createAttributes(r);for(var a in t.setIndex(n.index),n.attributes)t.setAttribute(a,new THREE.Float32BufferAttribute(n.attributes[a].array,n.attributes[a].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}createAttributes(r){for(var n=r.bottomPositionsArray,a=r.topPositionsArray,s=r.normalsArray,o=n.length/3-1,l=8*o,d=2*l,c=3*l,u=new Array(36*o),p=new Array(c),m=new Array(c),f=new Array(c),g=new Array(c),v=new Array(c),y=new Array(c),M=new Array(d),E=0,x=new THREE.Vector3,_=new THREE.Vector3,b=a.length/3,I=0,T=0;T<b-1;T++)x.fromArray(a,I),_.fromArray(a,I+3),E+=x.distanceTo(_),I+=3;var S=0,C=new THREE.Vector3,w=new THREE.Vector3,R=new THREE.Vector3,B=new THREE.Vector3,A=new THREE.Vector3,P=new THREE.Vector3,L=0,O=0,D=0,N=0,H=0,U=0,F=i,k=!1;w.fromArray(n,L),B.fromArray(a,L),P.fromArray(s,L),L=3;for(T=0;T<o;T++){C.copy(w),R.copy(B),A.copy(P),k&&A.negate(),w.fromArray(n,L),B.fromArray(a,L),P.fromArray(s,L),k=h._breakMiter(P,C,w,B);var G=R.distanceTo(B),V=new THREE.Vector3;V.subVectors(w,C);var z=new THREE.Vector3;z.copy(V),z.normalize();var j=new THREE.Vector3;j.subVectors(R,C),j.normalize();var W=new THREE.Vector3;W.crossVectors(z,j),W.normalize();var q=new THREE.Vector3;q.crossVectors(j,A),q.normalize();var X=new THREE.Vector3;X.subVectors(B,w),X.normalize();var Y=new THREE.Vector3;Y.crossVectors(P,X),Y.normalize();for(var K=G/E,Z=S/E,Q=0;Q<8;Q++){D=H+3*Q,N=U+2*Q;var J=Q<4?1:-1,$=2===Q||3===Q||6===Q||7===Q?1:-1;C.toArray(m,D),q.toArray(f,D),Y.toArray(g,D),V.toArray(y,D),W.toArray(v,D);var ee=new THREE.Vector2;ee.x=K*J;var te=Z*$;0===te&&$<0&&(te=9),ee.y=te,ee.toArray(M,N)}var ie=new THREE.Vector3,re=new THREE.Vector3,ne=new THREE.Vector3,ae=new THREE.Vector3;ie.copy(C),re.copy(w),ne.copy(R),ae.copy(B);var se=this._getMinMaxHeight(C,w);se&&(ie.y=se.minimumTerrainHeight,re.y=se.minimumTerrainHeight,ne.y=se.maximumTerrainHeight,ae.y=se.maximumTerrainHeight,this.lowest=Math.min(this.lowest,ie.y),this.lowest=Math.min(this.lowest,re.y)),ie.addScaledVector(W,F),re.addScaledVector(W,F),ae.addScaledVector(W,F),ne.addScaledVector(W,F),ie.toArray(p,O),re.toArray(p,O+3),ae.toArray(p,O+6),ne.toArray(p,O+9),ie.addScaledVector(W,-2e-5),re.addScaledVector(W,-2e-5),ae.addScaledVector(W,-2e-5),ne.addScaledVector(W,-2e-5),ie.toArray(p,O+12),re.toArray(p,O+15),ae.toArray(p,O+18),ne.toArray(p,O+21),L+=3,O+=24,U+=16,H+=24,S+=G}L=0;var oe=0;for(T=0;T<o;T++){for(Q=0;Q<t;Q++)u[L+Q]=e[Q]+oe;oe+=8,L+=t}return{index:u,attributes:{position:{array:p,itemSize:3},startPosition:{array:m,itemSize:3},startNormal:{array:f,itemSize:3},endNormal:{array:g,itemSize:3},rightNormal:{array:v,itemSize:3},forwardOffset:{array:y,itemSize:3},texcoordNormalization:{array:M,itemSize:2},textureUV:{array:this._createTextureUVAttribute(p),itemSize:2}}}}_distanceTo(e,t,i,r){const n=i-e,a=r-t,s=n*n+a*a;return Math.sqrt(s)}_createTextureUVAttribute(e){let t=[];var i=[0];if(e.length&&e[0]instanceof THREE.Vector3)for(var r=0;r<e.length;r++){var n=e[r];if(t.push(n.x,n.y,n.z),t.push(n.x,n.y,n.z),r>0){let t=i[i.length-1]+this._distanceTo(n.x,n.y,n.z,e[r-1].x,e[r-1].y,e[r-1].z);i.push(t)}}else for(r=0;r<e.length;r+=3)if(t.push(e[r],e[r+1],e[r+2]),t.push(e[r],e[r+1],e[r+2]),r>0){let t=i[i.length-1]+this._distanceTo(e[r-3],e[r-2],e[r-1],e[r],e[r+1],e[r+2]);i.push(t)}const a=t.length/6;let s=[];const o=i[i.length-1];for(let e=0;e<a;e++){let t=i[e]/o;s.push(0,t),s.push(1,t)}return s}createCurve(e){if(!this.viewer){this.viewer=e.viewer;var t=this.viewer.modelManager.modelCollection,i=this;t.traverse((e=>{e.isDemLayer&&(i.tileManager=e.tileManager)}))}if(e.points){var r=e.points;this.localPositions=[];for(var n=0;n<r.length;n++)this.localPositions.push(this.viewer.worldToDrawing(r[n]));var a=new THREE.CatmullRomCurve3(this.localPositions);this.curve=a}a=this.curve;var s=e.type;this.curveType=s,a.tension=0,a.type="polyline"==s?"catmullrom":"centripetal";var o="polyline"==s?e.points.length:e.divisions,l="polyline"==s?this.localPositions:a.getPoints(o);for(n=0;n<l.length;n++){var d=l[n];this.minHeight=Math.min(this.minHeight,d.y),this.maxHeight=Math.max(this.maxHeight,d.y)}return l}createGeometry(e){for(var t=e.length,i=new Array(3*t),r=new Array(3*t),n=new Array(3*t),a=0,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=this.minHeight,m=this.maxHeight,f=0;f<t;f++)o.copy(e[f]),o.y=p,s.copy(e[f]),s.y=m,0==f?(u.copy(e[f+1]),u.y=p,l=h._computeRightNormal(o,s,u)):f==e.length-1?(d.copy(e[f-1]),d.y=p,c.copy(e[f-1]),c.y=m,l=h._computeRightNormal(d,c,o)):(d.copy(e[f-1]),d.y=p,u.copy(e[f+1]),u.y=p,l=h._computeVertexMiterNormal(d,o,s,u)),s.toArray(r,a),o.toArray(i,a),l.toArray(n,a),a+=3;return{bottomPositionsArray:i,topPositionsArray:r,normalsArray:n}}updateGeometry(e){var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=e||{};i.type=i.curveType||t.curveType,i.points=i.points||t._options.points;var r=t.createCurve(i),n=t.createGeometry(r),a=t.createAttributes(n);for(var s in t.setIndex(a.index),a.attributes)t.deleteAttribute(s),t.setAttribute(s,new THREE.Float32BufferAttribute(a.attributes[s].array,a.attributes[s].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}static _computeRightNormal(e,t,i){var r=h._direction(i,e),n=h._direction(t,e),a=new THREE.Vector3;return a.crossVectors(r,n),a.normalize(),a}static _computeVertexMiterNormal(e,t,r,n){var a=h._direction(r,t),s=h._tangentDirection(e,t,a),o=h._tangentDirection(n,t,a),l=new THREE.Vector3;if(h._equalsEpsilon(s.dot(o),-1,i))return l.crossVectors(a,s),l.normalize(),l;l.addVectors(o,s),l.normalize();var d=new THREE.Vector3;return d.crossVectors(a,l),o.dot(d)<0&&l.negate(),l}static _direction(e,t){var i=new THREE.Vector3;return i.subVectors(e,t),i.normalize(),i}static _tangentDirection(e,t,i){var r=h._direction(e,t);return r.cross(i),r.normalize(),r.crossVectors(i,r),r}static _equalsEpsilon(e,t,i,r){var n=Math.abs(e-t);return n<=r||n<=i*Math.max(Math.abs(e),Math.abs(t))}static _breakMiter(e,t,i,s){var o=h._direction(i,t).dot(e);if(o>n||o<a){var l=h._direction(s,i),d=o<a?r.Math.PI_OVER_TWO:-r.Math.PI_OVER_TWO;return e.applyAxisAngle(l,d),!0}return!1}_getMinMaxHeight(e,t){const i=this.viewer.getSceneHeightRange();var n=this.tileManager;if(!n)return{maximumTerrainHeight:Math.max(1e3,i.max),minimumTerrainHeight:Math.min(-1e3,i.min)};if(!n.isUseTerrain())return{maximumTerrainHeight:Math.max(1e3,i.max),minimumTerrainHeight:Math.min(-1e3,i.min)};var a=this.viewer.drawingToWorld(e),h=this.viewer.drawingToWorld(t),c=n.worldPositionToLngLat(a),u=n.worldPositionToLngLat(h),p=s;p.height=0,p.longitude=THREE.Math.degToRad(c.x),p.latitude=THREE.Math.degToRad(c.y);var m=o;m.height=0,m.longitude=THREE.Math.degToRad(u.x),m.latitude=THREE.Math.degToRad(u.y);var f=r.GIS.Rectangle.fromCartographicArray(l,d),g=r.GIS.ApproximateTerrainHeights.getMinimumMaximumHeights(f);if(g){var v=new THREE.Vector3(0,0,(g.maximumTerrainHeight-n.modelAltitude)*r.Tile.TileMath.unitScale),y=this.viewer.worldToDrawing(v);g.maximumTerrainHeight=y.y,v=new THREE.Vector3(0,0,(g.minimumTerrainHeight-n.modelAltitude)*r.Tile.TileMath.unitScale),y=this.viewer.worldToDrawing(v),g.minimumTerrainHeight=y.y}return g.maximumTerrainHeight=Math.max(g.maximumTerrainHeight,i.max),g.minimumTerrainHeight=Math.min(g.minimumTerrainHeight,i.min),g}}r.GroundCurveGeometry=h}(),function(){class e extends THREE.Mesh{constructor(e,t){super(e,t),this.type="GroundCurveMesh",this.lineType="Continuous",this.visibleModelIdMap=null,this.viewer=null,this._widthType="DisplayWidth",this.inVisibleModelIdMap=null}setColor(e){e.alpha<1||this.material.map?this.material.transparent=!0:this.material.transparent=!1,this.material.color.setRGB(e.red/255,e.green/255,e.blue/255),this.material.opacity=e.alpha,this.renderOrder=r.GlobalData.IncrementRender?r.EnumRenderOrder.Increment:r.EnumRenderOrder.BeforeComponent}setOpacity(e){this.material.opacity=e,this.material.transparent=e<1}setWidthType(e){this._widthType=e,"DisplayWidth"==this._widthType?this.material.widthType=0:this.material.widthType=1,"Meter"==this.viewer.getSceneUnit()?this.material.sceneUnit=0:this.material.sceneUnit=1}setWidth(e){this.material.lineWidth=e}setStyle(e){if(this.lineType!=e.lineType){this.lineType=e.lineType;var t=this.material;"Continuous"==this.lineType?t.dashMode=0:t.dashMode=1}}setType(e){var t=this.geometry;t.curveType=e,t.updateGeometry({curveType:e})}setMap(e,t){this.material.map=e,this.material.uvTransform=e.matrix,e&&(r.MaterialUtil.updateUVMatrix(this.material.map),this.material.transparent=!0,this.material.needsUpdate=!0,this.material.uniforms.uvTransform.value=this.material.map.matrix,this.material.enableColorOverride=null!=t&&t)}setClampMode(e){this.material.clampMode=e}setViewer(e){this.viewer=e}setVisibleModelIdMap(e){this.inVisibleModelIdMap={},e instanceof Array&&0!==e.length?(this.viewer.modelManager.modelCollection.traverse((t=>{if(t instanceof r.ExternalComponentManager||t instanceof r.ExtrudeBodyManager||"TileGroup"==t.id);else{let i=!1;for(let r=0;r<e.length;r++)if(e[r]==t.id){i=!0;break}if(!i){const e=t.id;this.inVisibleModelIdMap[e]=!0}}})),r.GroundPrimitiveManager.getInstance().setInVisibleModelIdMapAboutGroundCurve(this.inVisibleModelIdMap)):r.GroundPrimitiveManager.getInstance().setInVisibleModelIdMapAboutGroundCurve(this.inVisibleModelIdMap)}getVisibleModelIdMap(){return this.visibleModelIdMap}dispose(){this.geometry.dispose(),this.material.dispose(),this.viewer=null,this.inVisibleModelIdMap=null}onRemoved(){r.GroundPrimitiveManager.getInstance().removeGroundCurve(this)}onAdded(){r.GroundPrimitiveManager.getInstance().addGroundCurve(this)}}r.GroundCurveMesh=e}(),function(){var e=new r.GIS.Cartographic,t=new r.GIS.Cartographic,i=[e,t],n=new r.GIS.Rectangle;class a extends THREE.BufferGeometry{constructor(e){if(super(),this.type="GroundPolygonGeometry",this.viewer=void 0,this.tileManager=void 0,this.minHeight=-1e3,this.maxHeight=1e3,this._initialized=!1,!e.points||e.points.length<3)console.warn("ground polygon's points.length must >= 3.");else{var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{t.viewer||(t.viewer=e.viewer,t.viewer.modelManager.modelCollection.traverse((e=>{e.isDemLayer&&(t.tileManager=e.tileManager)})));var i=t.createAttributes(e);for(var r in t.setIndex(i.index),i.attributes)t.setAttribute(r,new THREE.Float32BufferAttribute(i.attributes[r].array,i.attributes[r].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}}createAttributes(e){this._getMinMaxHeight(e);for(var t=e.points,i=t.length,n=new Array(2*i),a=[],s=0;s<i;s++){var o=this.viewer.worldToDrawing(t[s]);a.push(o),n[2*s]=o.x,n[2*s+1]=o.z}var l=0,d=new THREE.Vector3,h=new THREE.Vector3,c=new Array(3*i),u=new Array(3*i);for(s=0;s<i;s++)h.copy(a[s]),h.y=this.minHeight,d.copy(a[s]),d.y=this.maxHeight,d.toArray(u,l),h.toArray(c,l),l+=3;var p=new Array;p=p.concat(c).concat(u);var m=new Array,f=r.earcut(n);m=m.concat(f);var g=[...f].reverse();for(s=0;s<g.length;s++)g[s]+=i;m=m.concat(g);var v=new Array;for(s=0;s<i;s++)v.push(s),v.push((s+1)%i),v.push(i+(s+1)%i),v.push(s),v.push(i+(s+1)%i),v.push(i+s);return r.Utils.isClockWise(t)&&(v=[...v].reverse()),{index:m=m.concat(v),attributes:{position:{array:p,itemSize:3}}}}updateGeometry(e){var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=t.createAttributes(e);for(var r in t.setIndex(i.index),i.attributes)t.deleteAttribute(r),t.setAttribute(r,new THREE.Float32BufferAttribute(i.attributes[r].array,i.attributes[r].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}_getMinMaxHeight(a){const s=this.viewer.getSceneHeightRange();var o=this.tileManager;if(!o)return this.maxHeight=Math.max(this.maxHeight,1e3,s.max),void(this.minHeight=Math.min(this.minHeight,-1e3,s.min));if(!o.isUseTerrain())return this.maxHeight=Math.max(this.maxHeight,1e3,s.max),void(this.minHeight=Math.min(this.minHeight,-1e3,s.min));for(var l=a.points,d=180,h=90,c=-180,u=-90,p=0;p<l.length;p++){var m=l[p],f=o.worldPositionToLngLat(m);d=Math.min(d,f.x),c=Math.max(c,f.x),h=Math.min(h,f.y),u=Math.max(u,f.y)}var g=e;g.height=0,g.longitude=THREE.Math.degToRad(d),g.latitude=THREE.Math.degToRad(h);var v=t;v.height=0,v.longitude=THREE.Math.degToRad(c),v.latitude=THREE.Math.degToRad(u);var y=r.GIS.Rectangle.fromCartographicArray(i,n),M=r.GIS.ApproximateTerrainHeights.getMinimumMaximumHeights(y);if(M){m=new THREE.Vector3(0,0,(M.maximumTerrainHeight-o.modelAltitude)*r.Tile.TileMath.unitScale);var E=this.viewer.worldToDrawing(m);this.maxHeight=E.y,m=new THREE.Vector3(0,0,(M.minimumTerrainHeight-o.modelAltitude)*r.Tile.TileMath.unitScale),E=this.viewer.worldToDrawing(m),this.minHeight=E.y}this.maxHeight=Math.max(this.maxHeight,s.max),this.minHeight=Math.min(this.minHeight,s.min)}}r.GroundPolygonGeometry=a}(),function(){class e extends THREE.Mesh{constructor(e,t){super(e,t),this.type="GroundPolygonMesh",this.viewer=null,this.visibleModelIdMap=null,this.clampMode=0}setColor(e){this.material.color.setRGB(e.red/255,e.green/255,e.blue/255),this.material.opacity=e.alpha,this.material.transparent=e.alpha<1}setOpacity(e){this.material.opacity=e,this.material.transparent=e<1}dispose(){this.geometry.dispose(),this.material.dispose(),this.viewer=null,this.clampMode=0,this.visibleModelIdMap=null}setClampMode(e){this.clampMode=0==e||1==e||2==e?e:0}setViewer(e){this.viewer=e}setVisibleModelIdMap(e){let t={};e instanceof Array&&0!==e.length&&(this.viewer.modelManager.modelCollection.traverse((i=>{if(i instanceof r.ExternalComponentManager||i instanceof r.ExtrudeBodyManager||"TileGroup"==i.id);else{const r=i.id;for(let n=0;n<e.length;n++)if(e[n]==i.id){t[r]=!0;break}}})),this.visibleModelIdMap=t)}getVisibleModelIdMap(){return this.visibleModelIdMap}onRemoved(){r.GroundPrimitiveManager.getInstance().removeGroundPolygon(this)}onAdded(){r.GroundPrimitiveManager.getInstance().addGroundPolygon(this)}}r.GroundPolygonMesh=e}(),function(){const e=new THREE.Matrix4;e.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);const t=new THREE.Matrix4;r.ShadowMapCamera=class{constructor(){this.viewMatrix=new THREE.Matrix4,this.inverseViewMatrix=new THREE.Matrix4,this.orthoCamera=new THREE.OrthographicCamera,this.positionWC=new THREE.Vector3,this.directionWC=new THREE.Vector3(0,0,1),this.upWC=new THREE.Vector3(0,1,0),this.rightWC=new THREE.Vector3(1,0,0),this.viewProjectionMatrix=new THREE.Matrix4}destroy(){this.viewMatrix=null,this.inverseViewMatrix=null,this.orthoCamera=null,this.positionWC=null,this.directionWC=null,this.upWC=null,this.rightWC=null,this.viewProjectionMatrix=null}clone(e){this.viewMatrix.copy(e.viewMatrix),this.inverseViewMatrix.copy(e.inverseViewMatrix),this.orthoCamera.copy(e.orthoCamera),this.positionWC.copy(e.positionWC),this.directionWC.copy(e.directionWC),this.upWC.copy(e.upWC),this.rightWC.copy(e.rightWC)}getViewProjection(){var t=this.viewMatrix;this.orthoCamera.updateProjectionMatrix();var i=this.orthoCamera.projectionMatrix;return this.viewProjectionMatrix.multiplyMatrices(i,t),this.viewProjectionMatrix.multiplyMatrices(e,this.viewProjectionMatrix),this.viewProjectionMatrix}getFrustum(e){t.multiplyMatrices(this.orthoCamera.projectionMatrix,this.orthoCamera.matrixWorldInverse),e.setFromProjectionMatrix(t)}}}(),(()=>{const e=new THREE.Sphere,t=new THREE.Vector2,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Matrix4,s=new THREE.Matrix4,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Matrix4,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Box3,m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3;new THREE.Vector2,new THREE.Vector2,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4(0,0,1,1),new THREE.Vector4(1,0,1,1),new THREE.Vector4(0,1,1,1),new THREE.Vector4(1,1,1,1);new THREE.Frustum;const y=new Array(8);y[0]=new THREE.Vector4(-1,-1,-1,1),y[1]=new THREE.Vector4(1,-1,-1,1),y[2]=new THREE.Vector4(1,1,-1,1),y[3]=new THREE.Vector4(-1,1,-1,1),y[4]=new THREE.Vector4(-1,-1,1,1),y[5]=new THREE.Vector4(1,-1,1,1),y[6]=new THREE.Vector4(1,1,1,1),y[7]=new THREE.Vector4(-1,1,1,1);for(var M=new Array(8),E=0;E<8;++E)M[E]=new THREE.Vector4;var x=new Array(5),_=new Array(8),b=new Array(4),I=new THREE.PerspectiveCamera,T=[],S=[];r.CSM=class{constructor(e){e=e||{},this.viewer=e.viewer,this.camera=e.camera,this.scene=e.scene,this.isGis=this.viewer.isGis,this.maxCascades=4,this.cascades=4,0==this.isGis&&(this.cascades=4),this.shadowMapSize=2048,this.shadowBias=[-.0015,-.0018,-.0022,-.003],this.lights=[],this.extendedBreaks=[new THREE.Vector2(0,.16704173648319734),new THREE.Vector2(.16704173648319734,.34690875474964117),new THREE.Vector2(.34690875474964117,1),new THREE.Vector2(1,1)],this.shadowNear=+Number.MAX_VALUE,this.shadowFar=-Number.MAX_VALUE,this.shadowClosestObjectSize=Number.MAX_VALUE,this.MAXIMUM_DISTANCE=2e4,this.maximumDistance=1e4,this.sceneCamera=new r.Camera(r.CAMERATYPE.PERSPECTIVE),this.shadowMapCamera=new r.ShadowMapCamera,this._maximumCascadeDistances=[40,190,780,Number.MAX_VALUE],this.debug=!1,this._cameraDir=new THREE.Vector3,this._sceneSize=new THREE.Vector3,this.createLights(),this.updateCascadeNum(this.cascades),this._highPerformanceMode=!1,this.blendPercentage=.1,this.materialShadowSide=null,this._enableAvoidShadowPlaneCutting=!1,this.accumulateIndex=0,this.refreshInterval=[0,1,5,8],this.lambda=.65,this.enable=!0,this.frustum=new THREE.Frustum,this.tileIdBufferId=new Uint8Array(this.shadowMapSize*this.shadowMapSize),this.castShadowTileIdSet=new Set;const t=new THREE.ShaderMaterial({uniforms:{sourceTexture:{value:null}},vertexShader:"/* glsl */\n                varying vec2 vUv;\n                void main() {\n                   vUv = uv;\n                   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                }",fragmentShader:"/* glsl */\n                uniform sampler2D sourceTexture;\n                varying vec2 vUv;\n                void main() {\n                    vec4 value = texture2D(sourceTexture,vUv);\n                    gl_FragColor = value;\n                }"}),i=new THREE.PlaneGeometry(2,2),n=new THREE.Mesh(i,t);n.frustumCulled=!1;new THREE.OrthographicCamera(-1,1,1,-1,0,1);this.scene.onUpdateTileIdMap=e=>{},this.cameraChanged=()=>{this._highPerformanceMode=!0},this.cameraChangedEnd=()=>{this._highPerformanceMode=!1,this.viewer.modelManager.setRenderStateChanged(!0)},this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED,this.cameraChanged),this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_END,this.cameraChangedEnd)}destroy(){this.shadowBias=null,this.lights=null,this.extendedBreaks=null,this.sceneCamera=null,this.shadowMapCamera.destroy(),this.shadowMapCamera=null,this._maximumCascadeDistances=null,this.viewer.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED,this.cameraChanged),this.viewer.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED_END,this.cameraChangedEnd),this.cameraChanged=null,this.cameraChangedEnd=null,this.viewer=null,this.camera=null,this.scene=null,this.frustum=null}createLights(){for(let e=0;e<this.cascades;e++){const t=new THREE.DirectionalLight(16777215,1);t.castShadow=!0,t.shadow.mapSize.width=this.shadowMapSize,t.shadow.mapSize.height=this.shadowMapSize,t.shadow.bias=this.shadowBias[e],t.shadow.radius=1/(e+1),t.intensity=.74,this.lights.push(t)}}updateCascadeNum(e){if(!(e>this.maxCascades)){for(let t=0;t<e;t++)this.lights[t].visible=!0;for(let t=e;t<this.cascades;t++)this.lights[t].visible=!1;this.cascades=e}}update(e){this.accumulateIndex++,this.accumulateIndex>2e4&&(this.accumulateIndex=1),this.computeNearFarPlane(this.scene,this.camera),this.shadowMapCamera.directionWC.copy(e),this.shadowMapCamera.directionWC.negate(),this.shadowMapCamera.directionWC.normalize(),this.fitShadowMapToScene(),this.computeCascades();const t=this.camera;this.extendedBreaks[0].set(x[0],x[1]),this.extendedBreaks[1].set(x[1],x[2]),this.extendedBreaks[2].set(x[2],x[3]),this.extendedBreaks[3].set(x[3],x[4]),this.extendedBreaks[0].set(_[0],_[1]),this.extendedBreaks[1].set(_[2],_[3]),this.extendedBreaks[2].set(_[4],_[5]),this.extendedBreaks[3].set(_[6],_[7]),t.csmCascades=this.extendedBreaks,this.viewer.updateShadowMap(),this.updateCascades()}updateCastShadowTileSet(){const e=this.lights[0].shadow.reduxRT;e&&(this.tileIdBufferId=new Uint8Array(this.shadowMapSize*this.shadowMapSize),this.viewer.getRenderer().readRenderTargetPixels(e,0,0,this.shadowMapSize/2,this.shadowMapSize/2,this.tileIdBufferId),this.parseBufferTileIdWorker.postMessage(this.tileIdBufferId.buffer,[this.tileIdBufferId.buffer]),this.parseBufferTileIdWorker.onmessage=e=>{this.castShadowTileIdSet=e.data})}updateReceivingPlane(){const e=this.scene.getBoundingBoxWithoutDEM();if(!e)return;p.copy(e);const t=p.getCenter(m);v.copy(this.scene.sunDirection),v.negate(),v.multiplyScalar(100),g.set(t.x-v.x,t.y-v.y,t.z-v.z);const i=p.getSize(f);p.min.y=p.min.y-.05*i.y;const r=new THREE.Plane(new THREE.Vector3(0,1,0),-p.min.y),n=r.normal.dot(v),a=new THREE.Vector3(p.max.x,p.max.y,p.min.z),s=-(a.dot(r.normal)+r.constant)/n;f.copy(v).multiplyScalar(s).add(a),p.expandByPoint(f);const o=this.scene.lightManager;o.updateShadowBox(p),o.updateReceivingPlane()}updateCascades(){const e=this.viewer.getScene().getObjectGroups();for(var t=0;t<e.length;t++)this._updateCascadesForModel(e[t])}_updateMaterialUniforms(e){e.uniforms.csmCascades.value=this.camera.csmCascades,e.defines.CSM_CASCADES=this.cascades,this.debug?e.defines.USE_SHADOW_CSM_DEBUG="":delete e.defines.USE_SHADOW_CSM_DEBUG,r.Utils.defined(this.materialShadowSide)&&(e.shadowSide=this.materialShadowSide),e.uniforms.isFineShadow&&(1==this._highPerformanceMode?e.uniforms.isFineShadow.value=!1:e.uniforms.isFineShadow.value=!0)}_updateCascadesForModel(e){if(!e.visible)return;const t=e.material;if(t instanceof Array)for(let e=0;e<t.length;e++){const i=t[e];r.Utils.isDefined(i)&&i.useCSM&&this._updateMaterialUniforms(i)}else r.Utils.isDefined(t)&&t.useCSM&&this._updateMaterialUniforms(t);let i=e.children;for(let e=0,t=i.length;e<t;e++)this._updateCascadesForModel(i[e])}practicalSplit(e,t,i,r,n){T.length=0,S.length=0,((e,t,i,r)=>{for(let n=1;n<e;n++)r.push(t*(i/t)**(n/e)/i);r.push(1)})(e,t,i,S),((e,t,i,r)=>{for(let n=1;n<e;n++)r.push((t+(i-t)*n/e)/i);r.push(1)})(e,t,i,T);for(let t=1;t<e;t++)n.push(THREE.MathUtils.lerp(T[t-1],S[t-1],r));n.push(1)}computeCascades(){var e=this.shadowMapCamera,t=this.sceneCamera,i=t.near,r=t.far;i<0&&(i=.1);var n,s=this.cascades,o=!1;this.shadowClosestObjectSize<200&&(o=!0),this._cameraDir.subVectors(t.target,t.position).normalize(),Math.abs(this._cameraDir.y),this.breaks=[],this.practicalSplit(this.cascades,i,r,this.lambda,this.breaks);var l=b,d=x;for(d[0]=i,d[s]=r,n=0;n<s;++n){const e=i+(r-i)*this.breaks[n];d[n+1]=e,l[n]=e-d[n]}if(o){for(n=0;n<s;++n)l[n]=Math.min(l[n],this._maximumCascadeDistances[n]);var p=d[0];for(n=0;n<s-1;++n)p+=l[n],d[n+1]=p}this._highPerformanceMode;var m=e.orthoCamera,f=m.left,g=m.right,v=m.bottom,E=m.top,T=m.near,S=m.far,C=e.positionWC,w=e.directionWC,R=e.upWC,B=I;B.fov=t.fov,B.aspect=t.aspect,B.position.copy(t.position),B.up.copy(t.up),B.lookAt(t.target),B.updateMatrixWorld(!0),B.matrixWorldInverse.copy(B.matrixWorld).invert();var A=e.getViewProjection();for(e.getFrustum(this.frustum),n=0;n<s;++n){let e=d[n],t=d[n+1];const i=.15*l[n-1],r=.15*l[n];0!==n&&(e-=i),n!==s&&(t+=r),B.near=e,B.far=t,_[2*n]=e,_[2*n+1]=t,B.updateProjectionMatrix();for(var P=a.multiplyMatrices(B.projectionMatrix,B.matrixWorldInverse),L=a.copy(P).invert(),O=a.multiplyMatrices(A,L),D=h.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),N=c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),H=0;H<8;++H){var U=M[H].copy(y[H]);U.applyMatrix4(O),U.divideScalar(U.w),D.min(U),N.max(U)}D.x=Math.max(D.x,0),D.y=Math.max(D.y,0),D.z=0,N.x=Math.min(N.x,1),N.y=Math.min(N.y,1),N.z=Math.min(N.z,1),u.copy(C),u.add(w);const o=this.lights[n];o.position.copy(C),o.up.copy(R),o.updateMatrixWorld(!0),o.target.position.copy(u),o.target.updateMatrixWorld(!0),o.cascadeSubFrustumNear=d[n],o.cascadeSubFrustumFar=d[n+1];const p=o.shadow.camera;p.left=f+D.x*(g-f),p.right=f+N.x*(g-f),p.bottom=v+D.y*(E-v),p.top=v+N.y*(E-v),p.near=T+D.z*(S-T),p.far=T+N.z*(S-T),p.updateProjectionMatrix(),p.position.copy(C),p.up.copy(R),p.lookAt(o.target.position),p.updateMatrixWorld(!0);const m=this.lights[n].shadow;n>0&&!0===this._highPerformanceMode&&this.accumulateIndex%this.refreshInterval[n]!=0?(m.autoUpdate=!1,m.needsUpdate=!1):m.needsUpdate=!0;const x=m.camera,b=x.top-x.bottom;o.shadow.bias=-1*(1+m.radius)*b/(2*m.mapSize.height)*.005}}fitShadowMapToScene(){var e=this.shadowMapCamera,t=this.sceneCamera,n=a.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),u=s.copy(n).invert(),p=e.directionWC,m=i;r.Math.equalsEpsilonVector3(p,m,r.Math.EPSILON10)&&(m=t.up),o.copy(p),o.cross(m);var f=o;m.copy(f),m.cross(p),m.normalize(),f.normalize();var g=l;g.set(0,0,0);for(var v=r.Utils.computeView(g,p,m,f,d),E=s.multiplyMatrices(v,u),x=h.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),_=c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),b=0;b<8;++b){var I=M[b].copy(y[b]);I.applyMatrix4(E),I.divideScalar(I.w),x.min(I),_.max(I)}_.z+=1e3,x.z-=10;var T=l;T.x=-.5*(x.x+_.x),T.y=-.5*(x.y+_.y),T.z=-_.z;var S=a.makeTranslation(T.x,T.y,T.z);v=S.multiplyMatrices(S,v);var C=.5*(_.x-x.x),w=.5*(_.y-x.y),R=_.z-x.z,B=e.orthoCamera;B.left=-C,B.right=C,B.bottom=-w,B.top=w,B.near=.01,B.far=R,e.viewMatrix.copy(v),e.inverseViewMatrix.copy(v).invert(),r.Utils.getTranslationFromMatrix4(e.inverseViewMatrix,e.positionWC),e.directionWC.copy(p),e.upWC.copy(m),e.rightWC.copy(f)}computeNearFarPlane(e,t){this.shadowNear=+Number.MAX_VALUE,this.shadowFar=-Number.MAX_VALUE,this.shadowClosestObjectSize=Number.MAX_VALUE;var r=t.position,n=t.target;i.subVectors(n,r),i.normalize(),this._computeNearFarPlane(e,t),this.shadowNear=Math.min(Math.max(this.shadowNear,t.near),t.far),this.shadowFar=Math.max(Math.min(this.shadowFar,t.far),this.shadowNear),this.shadowNear=Math.min(this.shadowNear,this.maximumDistance),this.shadowFar=Math.min(this.shadowFar,this.maximumDistance+1),this.shadowNear===this.shadowFar&&(this.shadowFar=this.shadowNear+1),this.sceneCamera.copy(t),this.sceneCamera.near=this.shadowNear,this.sceneCamera.far=this.shadowFar,this.sceneCamera.updateProjectionMatrix()}_computePlaneDistances(e,t,i,r){var a=e.center;n.subVectors(a,t);var s=i.dot(n);return r.x=s-e.radius,r.y=s+e.radius,r}_computeNearFarPlane(n,a){if(n.visible){if(n.layers.test(a.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.isSkinnedMesh&&n.skeleton.update(),!n.frustumCulled||a.frustum.intersectsObject(n))){var s=n.geometry;null===s.boundingSphere&&s.computeBoundingSphere(),e.copy(s.boundingSphere).applyMatrix4(n.matrixWorld),this._computePlaneDistances(e,a.position,i,t);var o=t.x,l=t.y;m.subVectors(a.target,a.position);const h=n.parent&&n.parent.name===r.ObjectGroupType.RECEIVESHADOWPLANE&&1==this._enableAvoidShadowPlaneCutting;if((n.castShadow||n.receiveShadow)&&o<this.MAXIMUM_DISTANCE||h){var d=l-o;o<100&&(this.shadowClosestObjectSize=Math.min(this.shadowClosestObjectSize,d)),this.shadowNear=Math.min(this.shadowNear,o),this.shadowFar=Math.max(this.shadowFar,l)}}for(var h=n.children,c=0,u=h.length;c<u;c++)this._computeNearFarPlane(h[c],a)}}get debug(){return this._debug}set debug(e){this._debug=e,this.updateCascades()}get maxShadowZ(){return this.maximumDistance}set maxShadowZ(e){this.maximumDistance=e}setMaterialShadowSide(e){this.materialShadowSide=e}set enableAvoidShadowPlaneCutting(e){this._enableAvoidShadowPlaneCutting=e}get enableAvoidShadowPlaneCutting(){return this._enableAvoidShadowPlaneCutting}setLightIntensity(e){for(let t=0;t<this.lights.length;t++)this.lights[t].intensity=e}getLightIntensity(){return this.lights.length>0?this.lights[0].intensity:.74}}})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;var i=new THREE.Box3;r.LightManager=class{constructor(e){this.scene=e,this.lightHelper=!1,this.shadowLightNum=0,this.shadowBox=new THREE.Box3,this.defaultLightsGroup=new r.ObjectGroup(r.ObjectGroupType.DEFAULTLIGHTS),this.externalDirLightsGroup=new r.ObjectGroup(r.ObjectGroupType.EXTERNALDIRLIGHTS),this.scene.add(this.defaultLightsGroup),this.scene.add(this.externalDirLightsGroup),this.externalSpotLightsGroup=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.EXTERNALSPOTLIGHTS,{globalSpace:!0}),this.lightHelperGroup=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.LIGHTHELPER),this.receivingPlane=null,this.cameraHelper=null,this.csm=null,this.useCSM=!1,this.defaultLightArray=[],this.lastBias=0,this.initDefaultLights(),this.lightPreset()}initCSM(e){this.csm||(this.csm=new r.CSM({viewer:e,camera:e.camera,scene:this.scene}))}enableCSM(e){if(this.useCSM=e,r.GlobalData.EnableCSM=e,this.adjustLightsForCSM(),this.scene.useMergeShadowMap=e,this.csm&&(this.csm.viewer.modelManager.updateMaterialsValue("useCSM",e),this.csm.viewer.modelManager.enableCSM(e),6!==r.GlobalData.LightPreset))if(e)this.light04.intensity=0;else{let e=this.csm.getLightIntensity();this.light04.intensity=e}}adjustLightsForCSM(){for(var e=!(!this.useCSM||!this.csm),t=0;t<this.defaultLightArray.length;t++)this.defaultLightsGroup.remove(this.defaultLightArray[t]);for(t=0;t<this.csm.lights.length;t++)this.defaultLightsGroup.remove(this.csm.lights[t]);if(e)for(t=0;t<this.csm.lights.length;t++)this.defaultLightsGroup.add(this.csm.lights[t]);for(t=0;t<this.defaultLightArray.length;t++){var i=this.defaultLightArray[t];this.defaultLightsGroup.add(i),i instanceof THREE.DirectionalLight&&e&&(i.castShadow=!1)}for(t=0;t<this.externalDirLightsGroup.children.length;t++){(i=this.externalDirLightsGroup[t])instanceof THREE.DirectionalLight&&e&&(i.castShadow=!1)}}destroy(){this.scene.remove(this.defaultLightsGroup),this.defaultLightsGroup=null,this.defaultLightArray=null,this.hemisphereLight=null,this.dirLight=null,this.ambientLight=null,this.sunLight=null,this.fillLight01=null,this.fillLight02=null,this.fillLight03=null,this.light04=null,this.shadowBox=null,this.externalSpotLightsGroup.clear(),this.scene.remove(this.externalSpotLightsGroup),this.externalSpotLightsGroup=null,this.externalDirLightsGroup.clear(),this.scene.remove(this.externalDirLightsGroup),this.externalDirLightsGroup=null,this.lightHelperGroup.clear(),this.scene.remove(this.lightHelperGroup),this.lightHelperGroup=null,this.cameraHelper=null,this.receivingPlane&&(this.scene.objectGroups.remove(this.receivingPlane),this.receivingPlane=null),this.csm&&(r.GlobalData.EnableCSM=!1,this.csm.destroy(),this.csm=null),this.scene=null}initDefaultLights(){var e=.2;this.hemisphereLight||(this.hemisphereLight=new THREE.HemisphereLight(16777215,5723991,e*r.GlobalData.LightIntensityFactor),this.hemisphereLight.name="hemisphereLight",this.hemisphereLight.position.set(-100,48,-100),this.defaultLightsGroup.add(this.hemisphereLight),this.defaultLightArray.push(this.hemisphereLight)),e=.7,this.dirLight||(this.dirLight=new THREE.DirectionalLight(16777215,e*r.GlobalData.LightIntensityFactor),this.dirLight.name="dirLight",this.dirLight.initIntensity=e,this.defaultLightsGroup.add(this.dirLight),this.defaultLightArray.push(this.dirLight)),this.ambientLight||(this.ambientLight=new THREE.AmbientLight(16777215,.12),this.ambientLight.name="ambientLight",this.defaultLightsGroup.add(this.ambientLight),this.defaultLightArray.push(this.ambientLight)),this.sunLight||(this.sunLight=new THREE.DirectionalLight(16777215,1),this.sunLight.name="sunLight",this.defaultLightsGroup.add(this.sunLight),this.defaultLightArray.push(this.sunLight)),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1),this.fillLight01.name="fillLight01",this.defaultLightsGroup.add(this.fillLight01),this.defaultLightArray.push(this.fillLight01)),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1),this.fillLight02.name="fillLight02",this.defaultLightsGroup.add(this.fillLight02),this.defaultLightArray.push(this.fillLight02)),this.fillLight03||(this.fillLight03=new THREE.DirectionalLight(16777215,1),this.fillLight03.name="fillLight03",this.defaultLightsGroup.add(this.fillLight03),this.defaultLightArray.push(this.fillLight03)),this.light04||(this.light04=new THREE.DirectionalLight(16777215,.15),this.light04.name="light04",this.light04.castShadow=!1,this.light04.intensity=.74,this.light04.shadow.mapSize.width=1024,this.light04.shadow.mapSize.height=1024,this.defaultLightsGroup.add(this.light04),this.defaultLightArray.push(this.light04),this.lightCastShadow=this.light04,this.calAutoBias())}calAutoBias(){this.lastBias!=this.lightCastShadow.shadow.bias&&(this.lastBias=this.lightCastShadow.shadow.bias);let e=this.lightCastShadow.shadow.camera.top-this.lightCastShadow.shadow.camera.bottom;this.lightCastShadow.shadow.bias=-1*(1+this.lightCastShadow.shadow.radius)*e/(2*this.lightCastShadow.shadow.mapSize.height)*.005}hideDefaultLights(){for(var e=0;e<this.defaultLightsGroup.children.length;e++){this.defaultLightsGroup.children[e].visible=!1}if(this.useCSM&&this.csm)for(e=0;e<this.csm.lights.length;e++)this.csm.lights[e].visible=!0}defaultLightPreset(){this.hideDefaultLights(),this.hemisphereLight.visible=!0,this.hemisphereLight.position.set(0,100,0),this.hemisphereLight.updateMatrixWorld(!0),this.dirLight.visible=!0,this.dirLight.color.setHSL(.1,1,.95),this.dirLight.position.set(-1,.75,1),this.dirLight.position.multiplyScalar(50)}updateDefaultLight(e){var t=this.dirLight;t.intensity=t.initIntensity*r.GlobalData.LightIntensityFactor,t.position.set(e.x,e.y,e.z),t.updateMatrixWorld(!0);var i=this.hemisphereLight;i.intensity=i.initIntensity*r.GlobalData.LightIntensityFactor}setupCommonLight(){this.hideDefaultLights(),this.hemisphereLight.visible=!0,this.hemisphereLight.intensity=0,this.hemisphereLight.position.set(0,100,0),this.hemisphereLight.updateMatrixWorld(),this.ambientLight.visible=!0,this.ambientLight.intensity=.12,this.sunLight.visible=!1,this.sunLight.color.setHex(14800580),this.sunLight.position.set(-100,160,100),this.sunLight.intensity=.3,this.sunLight.distance=300,this.sunLight.updateMatrixWorld()}setupCommonLightOrigin(){this.hideDefaultLights(),this.ambientLight.visible=!0,this.ambientLight.intensity=.6,this.sunLight.visible=!0,this.sunLight.color.setHex(14800580),this.sunLight.position.set(-100,160,100),this.sunLight.intensity=.72,this.sunLight.distance=300,this.sunLight.updateMatrixWorld()}lightPreset01(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=1,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.24,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.6,this.sunLight.intensity=.9}lightPreset02(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.position.set(60,80,130),this.fillLight01.intensity=.28,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(8100788),this.fillLight02.position.set(100,80,-100),this.fillLight02.intensity=.22,this.fillLight02.updateMatrixWorld(),this.fillLight03.visible=!0,this.fillLight03.color.setHex(8100788),this.fillLight03.position.set(-140,80,-50),this.fillLight03.intensity=.18,this.fillLight03.updateMatrixWorld()}lightPreset03(){this.setupCommonLightOrigin(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.75,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.21,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.4,this.sunLight.intensity=.56}lightPreset04(){this.setupCommonLight(),this.fillLight01.visible=!1,this.fillLight03.visible=!1,this.dirLight.visible=!1,this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.11,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.1,this.sunLight.visible=!0,this.sunLight.intensity=.1,this.light04.intensity=.74,this.light04.visible=!0,this.hemisphereLight.intensity=.2,this.hemisphereLight.groundColor.r=.34,this.hemisphereLight.groundColor.g=.34,this.hemisphereLight.groundColor.b=.34,this.hemisphereLight.color.r=1,this.hemisphereLight.color.g=1,this.hemisphereLight.color.b=1,this.hemisphereLight.position.x=0,this.hemisphereLight.position.y=100,this.hemisphereLight.position.z=0,this.hemisphereLight.updateMatrixWorld(),this.csm&&this.csm.setLightIntensity(.74),this.updateShadowLight()}lightPreset05(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.75,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.05,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.4,this.sunLight.intensity=.56,this.fillLight03.visible=!0,this.fillLight03.color.setHex(15658734),this.fillLight03.position.set(-140,80,-50),this.fillLight03.intensity=.05,this.fillLight03.updateMatrixWorld()}lightPreset06(){this.setupCommonLightOrigin(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.3,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.1,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.3,this.sunLight.intensity=.3,this.light04.intensity=.2,this.light04.visible=!0,this.updateShadowLight(),this.csm&&this.csm.setLightIntensity(.4)}lightPreset(){switch(r.GlobalData.LightPreset){case 0:this.defaultLightPreset();break;case 1:this.lightPreset01();break;case 2:this.lightPreset02();break;case 3:this.lightPreset03();break;case 4:this.lightPreset04();break;case 5:this.lightPreset05();break;case 6:this.lightPreset06();break;default:this.setupCommonLight(),this.sunLight.color.setHex(16777215),this.ambientLight.intensity=.72}this.scene.gisMode||(this.getReceivingPlane(),this.receivingPlane.visible=!!r.GlobalData.EnableShadowMap),this.lightHelper&&this.addLightHelper()}addExternalSpotLight(e){this.externalSpotLightsGroup.add(e)}addExternalDirLight(e){this.externalDirLightsGroup.add(e),this.adjustLightsForCSM()}updateLights(e){var t=new THREE.Vector3(0,1,0),i=new THREE.Vector3(1,0,0),n=(new THREE.Vector3(0,0,1),Math.PI/4),a=1e3,s=600,o=e.position.clone();switch(o.sub(e.target),o.normalize(),r.GlobalData.LightPreset){case 0:this.updateDefaultLight(o);break;case 1:case 3:case 6:var l=o.clone().applyAxisAngle(t,-1.2*n);this.fillLight01.position.copy(l).normalize(),this.fillLight01.position.multiplyScalar(a),this.fillLight01.position.y=s,this.fillLight01.updateMatrixWorld(),l=o.clone().applyAxisAngle(t,1*n),this.fillLight02.position.copy(l).normalize(),this.fillLight02.position.multiplyScalar(a),this.fillLight02.position.y=s,this.fillLight02.updateMatrixWorld(),this.updateShadowLight();break;case 4:(l=o.clone().applyAxisAngle(t,1*n)).y*=-1.1,this.fillLight02.position.copy(l).normalize(),this.fillLight02.position.multiplyScalar(a),this.fillLight02.updateMatrixWorld(),(l=o.clone()).y*=-1.1,this.fillLight01.position.copy(l).normalize(),this.fillLight01.position.multiplyScalar(a),this.fillLight01.updateMatrixWorld(),this.updateShadowLight();break;case 2:break;case 5:l=o.clone().applyAxisAngle(i,-1.2*n);this.fillLight01.position.copy(l).normalize(),this.fillLight01.position.multiplyScalar(a),this.fillLight01.position.y=s,this.fillLight01.updateMatrixWorld(),(l=o.clone()).x*=-1,this.fillLight02.position.copy(l).normalize(),this.fillLight02.position.multiplyScalar(a),this.fillLight02.position.y=s,this.fillLight02.updateMatrixWorld(),(l=o.clone()).y*=-1,this.fillLight03.position.copy(l).normalize(),this.fillLight03.position.multiplyScalar(a),this.fillLight01.position.y=s,this.fillLight03.updateMatrixWorld(),this.updateShadowLight();break;default:l=o.clone().applyAxisAngle(t,-2*n);this.sunLight.position.copy(l).normalize(),this.sunLight.position.multiplyScalar(a),this.sunLight.position.y=s,this.sunLight.updateMatrixWorld()}this.lightHelper&&this.updateLightHelper()}updateShadowLight(){const n=6===r.GlobalData.LightPreset?this.scene.originSunDirection:this.scene.sunDirection;if(this.useCSM&&this.csm)this.csm.update(n);else if(this.scene.getBoundingBoxWithoutDEM()){i.copy(this.scene.getBoundingBoxWithoutDEM());var a=i,s=a.getCenter(e),o=new THREE.Vector3,l=new THREE.Vector3;l.copy(n),l.negate(),l.multiplyScalar(100),o.set(s.x-l.x,s.y-l.y,s.z-l.z);var d=a.getSize(t);a.min.y=a.min.y-.05*d.y;var h=new THREE.Plane(new THREE.Vector3(0,1,0),-a.min.y),c=h.normal.dot(l),u=new THREE.Vector3(a.max.x,a.max.y,a.min.z),p=-(u.dot(h.normal)+h.constant)/c,m=new THREE.Vector3;m.copy(l).multiplyScalar(p).add(u),a.expandByPoint(m),this.shadowBox.copy(a),this.lightCastShadow.position.set(o.x,o.y,o.z),this.lightCastShadow.target.position.set(s.x,s.y,s.z),this.lightCastShadow.target.updateMatrixWorld(!0),this.lightCastShadow.updateMatrixWorld(!0);var f=this.lightCastShadow.shadow.camera;f.position.set(o.x,o.y,o.z);var g=s;f.lookAt(g),f.updateMatrixWorld(),f.matrixWorldInverse.copy(f.matrixWorld).invert(),a.applyMatrix4(f.matrixWorldInverse),f.left=a.min.x,f.right=a.max.x,f.top=a.max.y,f.bottom=a.min.y,f.far=-a.min.z,f.near=-a.max.z,f.updateProjectionMatrix(),this.calAutoBias()}}getReceivingPlane(){if(!this.receivingPlane){this.receivingPlane=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.RECEIVESHADOWPLANE);var e=new THREE.ShadowMaterial;e.isShaderMaterial=!1,e.transparent=!0,e.opacity=.2,e.side=THREE.DoubleSide,e.defines={USE_CSM:""};var t=new THREE.PlaneBufferGeometry(1,1),i=new THREE.Mesh(t,e);i.receiveShadow=!0,i.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI/2),this.receivingPlane.add(i),this.receivingPlane.matrixAutoUpdate=!1}return this.receivingPlane}updateReceivingPlane(){var t=this.shadowBox;if(t&&this.receivingPlane&&this.receivingPlane.visible){var i=t.getCenter(e),r=this.receivingPlane.children[0];r.position.y=t.min.y,r.position.x=i.x,r.position.z=i.z;var n=t.getSize(e);r.scale.x=n.x,r.scale.y=n.z,this.receivingPlane.updateMatrixWorld(!0)}}clearLightHelper(){for(var e=this.lightHelperGroup.children.length-1;e>=0;e--){var t=this.lightHelperGroup.children[e];this.lightHelperGroup.remove(t)}this.cameraHelper=null}addLightHelper(){this.clearLightHelper();for(var e=0;e<this.defaultLightsGroup.children.length;++e){if((i=this.defaultLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){var t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}for(e=0;e<this.externalSpotLightsGroup.children.length;++e){if((i=this.externalSpotLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}for(e=0;e<this.externalDirLightsGroup.children.length;++e){var i;if((i=this.externalDirLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}if(this.lightCastShadow&&this.lightCastShadow.visible&&(this.cameraHelper=new THREE.CameraHelper(this.lightCastShadow.shadow.camera),this.lightHelperGroup.add(this.cameraHelper)),this.useCSM&&this.csm)for(e=0;e<this.csm.lights.length;e++){var r=new THREE.CameraHelper(this.csm.lights[e].shadow.camera);this.lightHelperGroup.add(r)}}updateLightHelper(){for(var e=0;e<this.lightHelperGroup.children.length;++e){var t=this.lightHelperGroup.children[e];t.update(),t.updateMatrixWorld(!0)}}updateShadowBox(e){this.shadowBox&&this.shadowBox.copy(e)}getShadowBoxWorld(){if(this.shadowBox){var e=new THREE.Box3;e.copy(this.shadowBox);var t=this.scene.geometryGroup.matrix.clone();return t.invert(),e.applyMatrix4(t),e}return null}removeLight(e){e&&e.parent&&e.parent.remove(e)}}})(),r.ObjectPool=function(e,t){this.cls=e,this.size=t,this._pool=[],this.counter=0},r.ObjectPool.prototype.init=function(e){for(var t=0,i=this.size;t<i;++t){var n=new this.cls;n.init(e),this._pool[t]=n,r.GlobalData.EnableShadowMap&&(n.castShadow=!0,n.receiveShadow=!0)}},r.ObjectPool.prototype.resize=function(e,t){this.size=e,this.collect(),this.init(t)},r.ObjectPool.prototype.get=function(e){if(this.counter>=this.size)return null;var t=this._pool[this.counter];return t.spawn(e),++this.counter,t},r.ObjectPool.prototype.clear=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].clear();this.counter=0},r.ObjectPool.prototype.destroy=function(){this.collect()},r.ObjectPool.prototype.collect=function(){this._pool=[],this.counter=0},r.ObjectPool.prototype.getObjects=function(){return this._pool},r.ExpandableObjectPool=function(){this.size=0,this.counter=0,this.expansion=1,this._pool=null},r.ExpandableObjectPool.prototype.init=function(e,t){this.classType=e,this._pool=[],this._expand(t)},r.ExpandableObjectPool.prototype._expand=function(e){this.size+=e;for(var t=0;t<e;t++)this._pool.push(new this.classType)},r.ExpandableObjectPool.prototype.acquire=function(){return this.counter>=this.size&&(this.expansion=Math.round(1.2*this.expansion)+1,this._expand(this.expansion),console.log("_expand")),this._pool[this.counter++]},r.ExpandableObjectPool.prototype.clear=function(){this.counter=0},r.ExpandableObjectPool.prototype.destroy=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].destroy();this.counter=0,this.size=0,this.expansion=1,this._pool=null},r.ExpandableObjectPool.prototype.getObjects=function(){return this._pool},function(){class e extends THREE.Group{constructor(e,t={}){super(),this.name=e,this.priority=t&&t.priority?t.priority:5,this.pickableType=t&&t.pickableType?t.pickableType:r.PICKABLETYPE.UnPickable,this.globalSpace=!(!t||!t.globalSpace)&&t.globalSpace,this.boundingBox=null,this.hoverEnabled=!(!t||!t.hoverEnabled)&&t.hoverEnabled}clear(){this.children.length=0}removeByName(e){for(var t=this.children,i=0,r=t.length;i<r;++i)if(t[i].name===e){t.splice(i,1);break}}isGlobalSpace(){return this.globalSpace}hasChild(e){for(var t=0,i=this.children.length;t<i;t++)if(this.children[t].name==e)return!0;return!1}isPickable(){return this.pickableType!==r.PICKABLETYPE.UnPickable}raycast(e,t,i){let n=t=>{("Line"==t.type||"LineSegments"==t.type)&&t instanceof THREE.Line&&e.params.Line&&i&&i.unitScale&&(e.params.Line.threshold=i.unitScale)};for(var a=0,s=this.children.length;a<s;a++){var o=this.children[a];if(r.Utils.isGroupObject(o)){var l=o.name;o.traverseVisible((function(a){r.Utils.isMeshObject(a)&&(void 0===a.userId&&(a.userId=l),n(a),a.raycast(e,t,i))}))}else o.visible&&(n(o),o.raycast(e,t,i))}t.forEach((e=>{e.userId=e.object.userId}))}}r.ObjectGroup=e}(),(()=>{let e=new THREE.Matrix4;r.ObjectGroupType={MODEL:"Model",GEOMETRY:"Geometry",LINESEGMENTS:"LineSegments",INSTANCEGEOMETRY:"InstanceGeometry",INSTANCEWIREFRAMEGEOMETRY:"InstanceWireframeGeometry",WIREFRAME:"Wireframe",MARKER3D:"Marker3D",CLIPPLANE:"ClipPlane",FILLCLIPPLANE:"FillClipPlane",CLIPREGION:"ClipRegion",CAPSWIREFRAME:"CapsWireframe",IBLCUBE:"IBLCube",CUSTOMPLANE:"CustomPlane",PIVOTBALL:"PivotBall",MEASUREPICKPOINT:"MeasurePickPoint",MEASUREPICKLINE:"MeasurePickLine",MEASUREPLANE:"MeasurePlane",MEASURELINE:"MeasureLine",OCTREENODE:"OctreeNode",BOUNDARYEDGEMANAGER:"BoundaryEdgeManager",AXISGRIDMANAGER:"AxisGridManager",EXTRUDEBODYMANAGER:"ExtrudeBodyManager",EXTRUDEBODYMANAGERTEST:"EXTRUDEBODYMANAGERTEST",EXTERNALCOMPONENTMANAGER:"ExternalComponentManager",BIMTILESGROUP:"BimTilesGroup",BIMTILESWIREFRAMEGROUP:"BimTilesWireframeGroup",TILEGROUP:"TileGroup",ROADNETWORK:"RoadNetworkGroup",GEOJSONGROUP:"GEOJSONGROUP",RECEIVESHADOWPLANE:"ReceiveShadowPlane",CONTACTSHADOW:"ContactShadow",VIEWSHED:"Viewshed",DEFAULTLIGHTS:"DefaultLights",EXTERNALSPOTLIGHTS:"ExternalSpotLights",EXTERNALDIRLIGHTS:"ExternalDirLights",LIGHTHELPER:"LightHelper",GLOBALEARTH:"GlobelEarth"};var t=new THREE.Box3;class i extends THREE.Scene{constructor(e){super();var t=r.Utils.defaultValue(e,{});this.gisMode=t.gisMode,this.type="Scene",this.autoUpdate=!1,this.objectGroups=new r.ObjectGroup,this.add(this.objectGroups),this.fog=new r.PostProcess(16777215),this.geometryGroup=new r.ObjectGroup(r.ObjectGroupType.GEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroups.add(this.geometryGroup),this.pool=new r.ObjectPool(r.MeshEx,0),this.expandScalar=1.02,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.customPlaneManager=null,this.axisGridManager=null,this.IBLMaps=new H.IBLMaps,this.transformMatrix=new THREE.Matrix4,this.lightManager=new r.LightManager(this),this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedInstanceMeshes=[],this.nonSelectedInstanceMeshes=[],this.originSunDirection=new THREE.Vector3(-1,1.6,1),this.sunDirection=new THREE.Vector3(-19,54,53),this._planIntersect=new THREE.Vector3,this._renderedObjects=[]}changeToWorkSpaceScene(){for(var e=this.getObjectGroups(),t=0;t<e.length;t++){var i=e[t];i.preVisible=i.visible,i.visible=!0}const n=this.getObjectGroup(r.ObjectGroupType.GLOBALEARTH);void 0!==n&&(n.visible=!1)}destroy(){this.lightManager.destroy(),this.lightManager=null,this.clearAll(),this.pool.destroy(),this.pool=null,this.geometryGroup=null,this.objectGroups=null,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.axisGridManager=null,this.IBLMaps=null,this.transformMatrix=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedInstanceMeshes=null,this.nonSelectedInstanceMeshes=null,this._renderedObjects=null}resizePool(e){r.GlobalData.BatchMergeEnabled||(this.geometryGroup.clear(),this.pool.resize(e,{parent:this.geometryGroup}))}clearAll(){this.pool.clear(),this.autoUpdate=!1}getRootNode(){return this.geometryGroup}hasBoundingBox(){return!!this.geometryGroup.boundingBox}getBoundingBox(){if(this.geometryGroup.boundingBox)return t.copy(this.geometryGroup.boundingBox),t.applyMatrix4(this.geometryGroup.matrix),t}getOriginalBoundingBoxWorld(){return this.originalBoundingBoxWorld}getBoundingBoxWorld(){return this.geometryGroup.boundingBox.clone()}getMatrixGlobal(){return this.geometryGroup.matrix.clone()}getRawMatrixGlobal(){return this.geometryGroup.matrix}getInverseMatrixGlobal(){return this.geometryGroup.inverseMatrixGlobal||(this.geometryGroup.inverseMatrixGlobal=new THREE.Matrix4),this.geometryGroup.inverseMatrixGlobal.copy(this.geometryGroup.matrix).invert(),this.geometryGroup.inverseMatrixGlobal}getGlobalScaleFactor(){return this.geometryGroup.matrix.elements[0]}getMatrixWorldGlobal(){return this.geometryGroup.matrixWorld}getRotationGlobal(){if(this.geometryGroup.matrix){var e=new THREE.Matrix4;e.extractRotation(this.geometryGroup.matrix);var t=new THREE.Euler;return t.setFromRotationMatrix(e),t}return null}getNearDepthByRect(e,i){var n=1/0,a=new THREE.Matrix4,s=new THREE.Vector3;function o(e){s.setFromMatrixPosition(e.matrixWorld),s.applyProjection(a);var t=s.z;t<n&&t>=0&&t<=1&&(n=t)}function l(e,i){if(i instanceof r.MeshEx){if(!function(e,i){if(!i.boundingBox||i instanceof THREE.Mesh){var r=i.geometry;null===r.boundingBox&&r.computeBoundingBox(),t.copy(r.boundingBox),t.applyMatrix4(i.matrixWorld)}else t.copy(i.boundingBox),t.applyMatrix4(i.matrixWorld);return e.intersectsBox(t)}(e,i))return;o(i)}else if(i.worldBoundingBox){if(!e.intersectsBox(i.worldBoundingBox))return;o(i)}var n=i.children;if(n)for(var a=0,s=n.length;a<s;a++){var d=n[a];d.visible&&l(e,d)}}a.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);for(var d=this.geometryGroup.children,h=0,c=d.length;h<c;h++){var u=d[h];u.visible&&l(e,u)}return n}getExpandScalar(){return this.expandScalar}hasClipPlanes(){return null!=this.clipPlanes}hasFillClipPlanes(){return null!=this.fillClipPlane}shrinkScopeByClipPlane(e,t){if(this.clipPlanes&&this.clipPlanes.isEnabled()){var i=this.clipPlanes.hitTest(e);if(null==i.distance)return;i.sign?i.distance>t.near&&(t.near=i.distance):i.distance<t.far&&(t.far=i.distance)}}updateWorldMatrixByMatrix(e){for(var t=this.objectGroups.children,i=0,r=t.length;i<r;i++)if(t[i].globalSpace){let r=t[i].transformMatrix||new THREE.Matrix4;t[i].matrix.copy(r),t[i].matrix.multiplyMatrices(e,t[i].matrix),t[i].matrixAutoUpdate=!1,t[i].updateMatrixWorld(!0)}}getShadowBoxWorld(){return this.lightManager.getShadowBoxWorld()}lightPreset(){this.lightManager.lightPreset()}updateLights(e,t){this.lightManager.updateLights(e)}updateCSMParameter(){this.lightManager.useCSM&&this.lightManager.csm&&this.lightManager.csm.updateCascades()}getOrCreateObjectGroup(e,t){for(var i=this.objectGroups.children,n=0,a=i.length;n<a;n++)if(i[n].name==e)return i[n];var s=new r.ObjectGroup(e,t);return s.isGlobalSpace()&&(s.matrix.copy(this.geometryGroup.matrix),s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0)),this.objectGroups.add(s),s}getObjectGroup(e){for(var t=this.objectGroups.children,i=0,r=t.length;i<r;i++)if(t[i].name==e)return t[i];return null}getObjectGroupType(e){var t=e.split("|");return{groupType:t[0],databagId:t.length>1?t[1]:void 0}}getObjectGroups(){return this.objectGroups.children}getExternalCompObjectGroups(){let e=[];return this.objectGroups.children.forEach((t=>{t.pickableType===r.PICKABLETYPE.ExternalComponent&&e.push(t)})),e}removeObjectGroup(e){this.objectGroups.remove(e)}removeObjectGroupByName(e){this.objectGroups.removeByName(e)}hasObjectGroup(e){return this.objectGroups.hasChild(e)}intersectToWorld(e,t){const i=this.getRawMatrixGlobal();e.worldPosition=r.GeomUtil.getWorldPositionOfMesh(e.point,i);const n=e.databagId;let a=[e.userId];const s=t.getBoundingBoxByIds(a,n),o=t.drawingToWorld(s.min.clone()),l=t.drawingToWorld(s.max.clone()),d=new THREE.Vector3(o.x,o.y,o.z),h=new THREE.Vector3(l.x,l.y,l.z);e.worldBoundingBox=(new THREE.Box3).setFromPoints([d,h]),e.unit=t.getModelManager().getSceneUnit()}worldToDrawing(e){var t=this.getRawMatrixGlobal(),i=new THREE.Vector3(e.x,e.y,e.z);return i.applyMatrix4(t),i}drawingToWorld(t){var i=this.getRawMatrixGlobal();e.copy(i).invert();var r=new THREE.Vector3(t.x,t.y,t.z);return r.applyMatrix4(e),r}getBoundingBoxWorldByMesh(t){var i=this.getRawMatrixGlobal(),r=t.boundingBox;r||(t.geometry.boundingBox||t.geometry.computeBoundingBox(),r=t.geometry.boundingBox);var n=r.clone();return n.applyMatrix4(t.matrixWorld),e.copy(i).invert(),n.applyMatrix4(e),n}getObjectPool(){return this.pool}setBoundingBoxWorld(e){this.geometryGroup.boundingBox?this.geometryGroup.boundingBox.copy(e):this.geometryGroup.boundingBox=e,this.originalBoundingBoxWorld=e.clone()}updateBoundingBoxWorld(e){this.geometryGroup.boundingBox=this.geometryGroup.boundingBox||new THREE.Box3,this.originalBoundingBoxWorld=this.originalBoundingBoxWorld||new THREE.Box3,this.geometryGroup.boundingBox.expandByPoint(e.min),this.geometryGroup.boundingBox.expandByPoint(e.max),this.originalBoundingBoxWorld.expandByPoint(e.min),this.originalBoundingBoxWorld.expandByPoint(e.max)}setBoundingBoxWorldWithoutDEM(e){this.boundingBoxWorldWithoutDEM=this.boundingBoxWorldWithoutDEM||new THREE.Box3,this.boundingBoxWorldWithoutDEM.copy(e)}updateBoundingBoxWorldWithoutDEM(e){this.boundingBoxWorldWithoutDEM=this.boundingBoxWorldWithoutDEM||new THREE.Box3,this.boundingBoxWorldWithoutDEM.expandByPoint(e.min),this.boundingBoxWorldWithoutDEM.expandByPoint(e.max)}getBoundingBoxWithoutDEM(){if(this.boundingBoxWorldWithoutDEM)return t.copy(this.boundingBoxWorldWithoutDEM),t.applyMatrix4(this.geometryGroup.matrix),t}getBoundingBoxOfGeometries(e){for(var t=!e,i=new THREE.Box3,n=this.pool._pool,a=0,s=this.pool.counter;a<s;++a){var o=n[a];if(o.isVisible()){var l=o.geometry;if(l){if(t||void 0!==e[o.name]){l.boundingBox||l.computeBoundingBox();var d=l.boundingBox;if(d){var h=d.clone();o.matrixWorld&&h.applyMatrix4(o.matrixWorld),i.expandByPoint(h.min),i.expandByPoint(h.max)}}}else r.Logger.log("empty geometry!")}}return i}getTransformMatrixGlobal(){return this.transformMatrix}setTransformMatrixGlobal(e){this.transformMatrix.copy(e)}adjustInstanceVisibility(e){this.traverse((function(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&t.geometry instanceof THREE.InstancedBufferGeometry){var i=t.visible;if(i==e)return;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}))}adjustVisibility(e){this.traverse((function(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&!(t.geometry instanceof THREE.InstancedBufferGeometry)){var i=t.visible;if(i==e)return;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}))}changeVisibilityOfSelectedObjects(e){var t=this;e||(t.selectedMeshes.length=0,t.selectedInstanceMeshes.length=0);var i=t.selectedMeshes,n=t.selectedInstanceMeshes;this.traverse((function(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?function(e){for(var i=0,n=t.selectedInstanceMeshes.length;i<n;i++)if(e===t.selectedInstanceMeshes[i].object){var a=t.selectedInstanceMeshes[i].indices,s=e.geometry.getAttribute("vState").array;for(let e=0,t=a.length;e<t;e++)s[a[e]]=r.EnumElementState.SELECTED;e.geometry.getAttribute("vState").needsUpdate=!0}}(a):function(e){if(e.visible){var t=[];let i=e.geometry.getAttribute("vState").array;for(let e=0;e<i.length;e+=4)i[e]===r.EnumElementState.SELECTED&&(t.push(e),i[e]=r.EnumElementState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,n.push({object:e,indices:t}))}}(a):e?function(e){for(var i=0,r=t.selectedMeshes.length;i<r;i++)if(e===t.selectedMeshes[i].object)for(var n=t.selectedMeshes[i].indices,a=0,s=n.length;a<s;a++){var o=n[a],l=e.geometry.groups[o.idx];l.start=o.start,l.count=o.count}}(a):function(e){if(e._indicesGroup&&e.visible){var t=[],n=e.geometry.groups;if(n&&n.length){for(var a=0,s=n.length;a<s;a++){var o=n[a];o.materialIndex===r.EnumElementState.SELECTED&&(t.push({idx:a,start:o.start,count:o.count}),o.start=0,o.count=0)}t.length&&i.push({object:e,indices:t})}}}(a))}))}changeVisibilityOfNonSelectedObjects(e){var t=this;e||(t.nonSelectedMeshes.length=0,t.nonSelectedInstanceMeshes.length=0);var i=t.nonSelectedMeshes,n=t.nonSelectedInstanceMeshes;this.traverse((function(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?function(e){for(var i=0,r=t.nonSelectedInstanceMeshes.length;i<r;i++)if(e===t.nonSelectedInstanceMeshes[i].object){for(var n=t.nonSelectedInstanceMeshes[i].indices,a=e.geometry.getAttribute("vState").array,s=0,o=n.length;s<o;s++)a[n[s].idx]=n[s].state;e.geometry.getAttribute("vState").needsUpdate=!0}}(a):function(e){if(e.visible){var t=[],i=e.geometry.getAttribute("vState").array;for(let e=0,n=i.length;e<n;e+=4)i[e]!==r.EnumElementState.SELECTED&&i[e]!==r.EnumElementState.HIDDEN&&(t.push({idx:e,state:i[e]}),i[e]=r.EnumElementState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,n.push({object:e,indices:t}))}}(a):e?function(e){for(var i=0,r=t.nonSelectedMeshes.length;i<r;i++)if(e===t.nonSelectedMeshes[i].object){var n=t.nonSelectedMeshes[i].indices;if(null===n)e.visible=!0;else for(var a=0,s=n.length;a<s;a++){var o=n[a],l=e.geometry.groups[o.idx];l.start=o.start,l.count=o.count}}}(a):function(e){if(e._indicesGroup&&e.visible){var t=[],n=e.geometry.groups;if(n&&n.length){for(var a=0,s=n.length;a<s;a++){var o=n[a];o.materialIndex!==r.EnumElementState.SELECTED&&(t.push({idx:a,start:o.start,count:o.count}),o.start=0,o.count=0)}t.length?i.push({object:e,indices:t}):(e.visible=!1,i.push({object:e,indices:null}))}else e.visible=!1,i.push({object:e,indices:null})}}(a))}))}clearSelectedAndNonSelectedMeshes(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0,this.selectedInstanceMeshes.length=0,this.nonSelectedInstanceMeshes.length=0}drawBoundingBox(e){if(e){var t=this.getOrCreateObjectGroup("BoundingBox",{pickable:0,priority:2}),i=this.getBoundingBox();void 0===this.boudingBoxNode?(this.boudingBoxNode=new r.BBoxNode(i,16711680),t.add(this.boudingBoxNode)):this.boudingBoxNode.updateBBox(i),this.boudingBoxNode.updateMatrixWorld(!0)}else this.removeObjectGroupByName("BoundingBox")}calculateGisMapBox(t){var i=this.getObjectGroup(r.GlobalData.TileGlobalGroupName)||this.getObjectGroup(r.GlobalData.TilePlaneGroupName),n=this.getBoundingBoxWorld(),a=new THREE.Sphere;n.getBoundingSphere(a);var s=n.clone();if(i){var o=t.position.clone(),l=1,d=1,h=this.getMatrixWorldGlobal();if(e.copy(h).invert(),o.applyMatrix4(e),a.containsPoint(o))d=o.clone().distanceTo(a.center)/a.radius,l=t.realUp.y;var c=r.Tile.TileMath.earthRadius*r.Tile.TileMath.unitScale,u=o.z-n.min.z;u=Math.abs(u);var p=c*Math.acos(c/(c+u))*(l*d),m=void 0!==i.altitudeOffset?i.altitudeOffset*r.Tile.TileMath.unitScale:void 0;s.min.x=o.x-p,s.max.x=o.x+p,s.min.y=o.y-p,s.max.y=o.y+p,s.min.z=void 0!==m&&m>0?Math.min(n.min.z,-m):n.min.z,s.max.z=void 0!==m&&m<0?Math.max(n.max.z,-m):n.max.z;var f=i.heightRange;void 0!==f&&f.max>f.min&&(s.min.z=Math.min(s.min.z,f.min),s.max.z=Math.max(s.max.z,f.max))}return s}getTerrainHeightRange(){const e=this.getObjectGroup(r.GlobalData.TileGlobalGroupName)||this.getObjectGroup(r.GlobalData.TilePlaneGroupName);if(e){const t=e.heightRange;if(void 0!==t&&t.max>t.min)return{max:t.max,min:t.min}}}}r.Scene=i})(),(()=>{let e=new THREE.Vector3;r.Raycaster=function(e,t,i,r){this.ray=new THREE.Ray(e,t),this.near=i||0,this.far=r||1/0,this.params={Sprite:{},Mesh:{},Points:{threshold:1},LOD:{},Line:{threshold:1}}},r.Raycaster.prototype={constructor:r.Raycaster,precision:1e-4,linePrecision:1,descSort:function(e,t){return e.distance-t.distance},set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t instanceof r.CombinedCamera?t.isPerspective?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):t instanceof THREE.PerspectiveCamera?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):t instanceof THREE.OrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("CLOUD.Raycaster: Unsupported camera type.")},intersectOctantForNode:function(t,i){var r=this,n=new THREE.Box3;!function t(a){var s,o;if(n.set(a.min,a.max),r.ray.intersectBox(n,e)&&(i.push(a),a.childOctants))for(s=0,o=a.childOctants.length;s<o;s++)t(a.childOctants[s])}(t)}},THREE.Ray.prototype.intersectBoxWithDistance=function(t){var i,r,n,a,s,o,l=1/this.direction.x,d=1/this.direction.y,h=1/this.direction.z,c=this.origin;if(l>=0?(i=(t.min.x-c.x)*l,r=(t.max.x-c.x)*l):(i=(t.max.x-c.x)*l,r=(t.min.x-c.x)*l),d>=0?(n=(t.min.y-c.y)*d,a=(t.max.y-c.y)*d):(n=(t.max.y-c.y)*d,a=(t.min.y-c.y)*d),i>a||n>r)return-1;if((n>i||i!=i)&&(i=n),(a<r||r!=r)&&(r=a),h>=0?(s=(t.min.z-c.z)*h,o=(t.max.z-c.z)*h):(s=(t.max.z-c.z)*h,o=(t.min.z-c.z)*h),i>o||s>r)return-1;if((s>i||i!=i)&&(i=s),(o<r||r!=r)&&(r=o),r<0)return-1;if(i<0)return 0;var u=this.at(i>=0?i:r,e),p=u.x-c.x,m=u.y-c.y,f=u.z-c.z;return Math.sqrt(p*p+m*m+f*f)}})(),r.CapsuleObject=class{constructor(e,t){this.id=e,this.object=t}destroy(){this.object=null}_inDistanceRange(e,t){return e>=t.near&&e<=t.far}raycast(e,t,i,r,n){}},function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,n,a,s,o){var l=[];if(this.object.raycast(e,l),l.length>0){l.sort((function(e,t){return e.distance-t.distance}));for(var d=0,h=l.length;d<h;d++){var c=l[d];const e=t.userId,h=c.point,u=o.size>0;if(!(u&&o.get(e)&&n.clipConditionPoint(h))&&((u||!n.clipPoint(h))&&!(u&&o.get(e)&&n.clipPoint(h))&&this._inDistanceRange(c.distance,i))){s||(i.far=c.distance-r.Utils.MinusEpsilon),a.push(c);break}}}}intersectByBox(e,t,i){const r=this.object.geometry;if(!r.isBufferGeometry)return null;const n=r.index,a=r.attributes.position,s={indexStart:Math.max(0,r.drawRange.start),indexCount:Math.min(n?n.count:a.count,r.drawRange.count),positionStart:0,positionCount:3*a.count};return this.object.intersectByBox(e,t,s)}}class t extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,n,a){var s=this.object,o=[],l=s.geometry,d={indexStart:l.drawRange.start,indexCount:l.drawRange.count};if(s.raycastByIndices2(e,o,d,!1),o.length>0){o.sort((function(e,t){return e.distance-t.distance}));for(var h=0,c=o.length;h<c;h++){var u=o[h];if(this._inDistanceRange(u.distance,i)&&!n.clipPoint(u.point)){i.far=u.distance-r.Utils.MinusEpsilon,u.userId=t.userId,u.indexInfo=d,a.push(u);break}}}}intersectByBox(e,t,i){const r=this.object.geometry;if(!r.isBufferGeometry)return null;const n=r.attributes.position,a={indexStart:r.drawRange.start,indexCount:r.drawRange.count,positionStart:0,positionCount:3*n.count};return this.object.intersectByBox(e,t,a)}}r.SingleCapsuleObject=e,r.SingleCapsuleObjectWithDrawRange=t}(),function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}_getIndexInfo(e){var t=this.object._indicesGroup;if(!t)return null;var i=t[e.userId];if(!i)return null;for(var r,n=!1,a=0,s=i.length;a<s;a++)if(i[a].nodeId===e.nodeId){r=i[a],n=!0;break}return n?(r.isExploded=e.isExploded,r):null}raycast(e,t,i,n,a,s,o,l){var d=this.object;let h=this._getIndexInfo(t);if(h){var c=[];if(d.raycastByIndices(e,c,h,null,null,l),c.length>0){c.sort((function(e,t){return e.distance-t.distance}));for(var u=0,p=c.length;u<p;u++){var m=c[u];const e=h.userId,t=m.point,l=o.size>0;if(!(l&&o.get(e)&&n.clipConditionPoint(t))&&((l||!n.clipPoint(t))&&!(l&&o.get(e)&&n.clipPoint(t))&&this._inDistanceRange(m.distance,i))){s||(i.far=m.distance-r.Utils.MinusEpsilon),m.userId=e,m.indexInfo=h,a.push(m);break}}}}}intersectByBox(e,t,i){var r=this.object;let n=this._getIndexInfo(i);return!!n&&r.intersectByBox(e,t,n)}}r.BatchedCapsuleObject=e}(),function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,n,a,s,o,l){var d=[];if(this.object.raycastByIndices(e,d,null,t.matrix,null,l),d.length>0){d.sort((function(e,t){return e.distance-t.distance}));for(var h=0,c=d.length;h<c;h++){var u=d[h];const e=t.userId,l=u.point,c=o.size>0;if(!(c&&o.get(e)&&n.clipConditionPoint(l))&&((c||!n.clipPoint(l))&&!(c&&o.get(e)&&n.clipPoint(l))&&this._inDistanceRange(u.distance,i))){s||(i.far=u.distance-r.Utils.MinusEpsilon),u.userId=t.userId,u.matrix=t.matrix,a.push(u);break}}}}intersectByBox(e,t,i){return this.object.intersectByBox(e,t,null,i.matrix)}}r.InstancedCapsuleObject=e}(),function(){class e extends THREE.Camera{constructor(e,t={}){super(),this.cameraType=e||r.CAMERATYPE.PERSPECTIVE,this.target=new THREE.Vector3,this.name=t.name||"",this.near=t.near||.1,this.far=t.far||2e3,this.fov=t.fov||45,this.cameraType===r.CAMERATYPE.PERSPECTIVE?(t.width&&t.height&&(this.aspect=t.width/t.height,this.left=-t.width/2,this.right=t.width/2,this.top=t.height/2,this.bottom=-t.height/2),this.perspectiveCamera=new r.CloudPerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.orthoCamera=null,this.toPerspective()):(this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,void 0!==t.left&&void 0!==t.right&&void 0!==t.top&&void 0!==t.bottom&&(this.aspect=(this.right-this.left)/(this.top-this.bottom)),this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=null,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1),this.zoom=t.zoom||1,this.updateProjectionMatrixByFrustum=!1}destroy(){this.target=null,this.projectionMatrixInverse=null,this.perspectiveCamera&&(r.ThreeHelper.destroyPerspectiveCamera(this.perspectiveCamera),this.perspectiveCamera=null),this.orthoCamera&&(r.ThreeHelper.destroyOrthographicCamera(this.orthoCamera),this.orthoCamera=null),r.ThreeHelper.destroyCamera(this)}toPerspective(){null!==this.perspectiveCamera?this.updateProjectionMatrixByFrustum||(this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse=this.perspectiveCamera.projectionMatrixInverse,this.isPerspective=!0,this.dirty=!0):console.log("Can not convert to perspective camera because the camera original type is orthographic.")}toOrthographic(){null===this.orthoCamera&&(this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far));var e=this.fov,t=this.target.clone().sub(this.position).length(),i=Math.tan(e*Math.PI/180/2)*t,r=i*this.aspect;i/=this.zoom,r/=this.zoom,this.left=this.orthoCamera.left=-r,this.right=this.orthoCamera.right=r,this.top=this.orthoCamera.top=i,this.bottom=this.orthoCamera.bottom=-i,this.orthoCamera.near=this.near,this.orthoCamera.far=this.far,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.projectionMatrixInverse=this.orthoCamera.projectionMatrixInverse,this.isPerspective=!1,this.dirty=!0}setSize(e,t){this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.aspect=e/t,this.dirty=!0}setSizeByFrustum(e,t){var i,r=2*this.right,n=2*this.top;this.aspect=r/n,r/n<e/t?(i=n/r,this.perspectiveCamera.setProjectOnWidth(!0)):(i=r/n,this.perspectiveCamera.setProjectOnWidth(!1)),this.dirty=!0,this.isPerspective&&(this.perspectiveCamera.aspect=i,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrixByFrustum(e,t),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0,this.dirty=!0)}setFov(e){this.fov=e,this.dirty=!0,this.updateProjectionMatrix()}setNearFar(e,t){this.near=e,this.far=t,this.dirty=!0,this.updateProjectionMatrix()}updateProjectionMatrix(){this.isPerspective?this.toPerspective():this.toOrthographic()}setLens(e,t){void 0===t&&(t=24);var i=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(i),this.dirty=!0,i}setZoom(e){this.zoom=e,this.dirty=!0,this.updateProjectionMatrix()}setViewOffset(e,t,i,r,n,a){this.isPerspective?(this.perspectiveCamera.setViewOffset(e,t,i,r,n,a),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse=this.perspectiveCamera.projectionMatrixInverse):(this.orthoCamera.setViewOffset(e,t,i,r,n,a),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.projectionMatrixInverse=this.orthoCamera.projectionMatrixInverse)}clearViewOffset(){this.isPerspective?(this.perspectiveCamera.clearViewOffset(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse=this.perspectiveCamera.projectionMatrixInverse):(this.orthoCamera.clearViewOffset(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.projectionMatrixInverse=this.orthoCamera.projectionMatrixInverse)}copy(e){return super.copy(e),this.cameraType=e.cameraType,this.target.copy(e.target),this.aspect=e.aspect,this.fov=e.fov,this.near=e.near,this.far=e.far,this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.zoom=e.zoom,this.isPerspective=e.isPerspective,this.updateProjectionMatrixByFrustum=e.updateProjectionMatrixByFrustum,this.orthoCamera&&e.orthoCamera&&this.orthoCamera.copy(e.orthoCamera),this.perspectiveCamera&&e.perspectiveCamera&&this.perspectiveCamera.copy(e.perspectiveCamera),this}clone(){return new this.constructor(this.cameraType).copy(this)}isDirty(){return this.dirty}}r.CombinedCamera=e}();class L extends THREE.PerspectiveCamera{constructor(e,t,i,r){super(e,t,i,r),this.projectOnWidth=!1}updateProjectionMatrixByFrustum(e,t){var i,r,n,a,s=this.near;this.projectOnWidth?(r=-.5*(n=e),i=.5*(a=this.aspect*n)):(i=.5*(a=t),r=-.5*(n=this.aspect*a));var o=this.view;if(null!==o){var l=o.fullWidth,d=o.fullHeight;r+=o.offsetX*n/l,i-=o.offsetY*a/d,n*=o.width/l,a*=o.height/d}var h=this.filmOffset;0!==h&&(r+=s*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,i,i-a,s,this.far)}setProjectOnWidth(e){this.projectOnWidth=e}}r.CloudPerspectiveCamera=L,(()=>{class e extends r.CombinedCamera{constructor(e,t){super(e,t),this.realUp=this.up.clone(),this.dirty=!1,this.orthoScale=1,this.positionPlane=new THREE.Plane,this.projScreenMatrix=new THREE.Matrix4,this.viewProjInverse=new THREE.Matrix4,this.frustum=new THREE.Frustum,this.frustumHeightFactor=this.computeFrustumHeightFactor(),this.minimumElevation=null,this._statusInitialized=!1,this._direction=null,this.statusChange=!1,this._inverseMatrix=new THREE.Matrix4,this.scratchVector=new THREE.Vector3,this.scratchVector_2=new THREE.Vector3,this.scratchVector_3=new THREE.Vector3,this.userDefinedNearFar=!1}destroy(){this.realUp=null,this.positionPlane=null,this.projScreenMatrix=null,this.viewProjInverse=null,this.minimumElevation=null,this._direction=null,this._inverseMatrix=null,this.scratchVector=null,this.scratchVector_2=null,this.scratchVector_3=null,r.ThreeHelper.destroyFrustum(this.frustum),this.frustum=null,super.destroy()}get statusInitialized(){return this._statusInitialized}direction(e){return this._direction||(this._direction=new THREE.Vector3),this._direction.subVectors(this.target,this.position),r.Utils.isDefined(e)||(e=new THREE.Vector3),e.copy(this._direction)}_updatePositionPlane(){this.positionPlane.setFromNormalAndCoplanarPoint(this.getWorldDirection(this.scratchVector),this.position)}_updateFrustum(){this.frustum.setFromProjectionMatrix(this.projScreenMatrix)}updateMVP(){this.dirty&&(this._statusInitialized||(this._statusInitialized=!0),null===this.parent&&this.updateMatrixWorld(),this.matrixWorldInverse.copy(this.matrixWorld).invert(),this.projScreenMatrix.multiplyMatrices(this.projectionMatrix,this.matrixWorldInverse),this.viewProjInverse.copy(this.projScreenMatrix).invert(),this._updateFrustum(),this._updatePositionPlane(),this.frustumHeightFactor=this.computeFrustumHeightFactor())}computeFrustumHeightFactor(){return 2*Math.tan(.5*THREE.Math.degToRad(this.fov))}getFrustum(){return this.dirty&&this.updateMVP(),this.frustum}LookAt(e,t,i,r){let n=new THREE.Vector3;n.copy(t),void 0!==r&&n.setLength(r),this.position.subVectors(e,n),this.up.copy(i),this.lookAt(e),this.realUp=i.clone(),this.target=e.clone(),this.dirty=!0}copy(e){return super.copy(e),this.realUp.copy(e.realUp),this.orthoScale=e.orthoScale,this.dirty=e.dirty,this.positionPlane.copy(e.positionPlane),this.projScreenMatrix.copy(e.projScreenMatrix),this.viewProjInverse.copy(e.viewProjInverse),this.frustum.copy(e.frustum),this}setStandardView(e,t){var i;i=t?t.getCenter(this.scratchVector):new THREE.Vector3(0,0,0);var n=r.GlobalData.SceneSize,a=n/2;switch(e){case r.EnumStandardView.ISO:var s=new THREE.Vector3(-n,n,n),o=new THREE.Vector3,l=new THREE.Vector3(0,0,0);o.subVectors(l,s),this.LookAt(i,o,THREE.Object3D.DefaultUp);break;case r.EnumStandardView.Top:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1),a);break;case r.EnumStandardView.Bottom:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),a);break;case r.EnumStandardView.Front:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.Back:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.Right:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.Left:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.SouthEast:this.LookAt(i,new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.SouthWest:this.LookAt(i,new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.NorthWest:this.LookAt(i,new THREE.Vector3(1,0,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.NorthEast:this.LookAt(i,new THREE.Vector3(-1,0,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomFront:this.LookAt(i,new THREE.Vector3(0,1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomBack:this.LookAt(i,new THREE.Vector3(0,1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomRight:this.LookAt(i,new THREE.Vector3(-1,1,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomLeft:this.LookAt(i,new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomSouthEast:this.LookAt(i,new THREE.Vector3(-1,1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomSouthWest:this.LookAt(i,new THREE.Vector3(1,1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomNorthWest:this.LookAt(i,new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.BottomNorthEast:this.LookAt(i,new THREE.Vector3(-1,1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofFront:this.LookAt(i,new THREE.Vector3(0,-1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofBack:this.LookAt(i,new THREE.Vector3(0,-1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofRight:this.LookAt(i,new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofLeft:this.LookAt(i,new THREE.Vector3(1,-1,0),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofSouthEast:this.LookAt(i,new THREE.Vector3(-1,-1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofSouthWest:this.LookAt(i,new THREE.Vector3(1,-1,-1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofNorthWest:this.LookAt(i,new THREE.Vector3(1,-1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.RoofNorthEast:this.LookAt(i,new THREE.Vector3(-1,-1,1),new THREE.Vector3(0,1,0),a);break;case r.EnumStandardView.TopTurnRight:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(-1,0,0),a);break;case r.EnumStandardView.TopTurnBack:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),a);break;case r.EnumStandardView.TopTurnLeft:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(1,0,0),a);break;case r.EnumStandardView.BottomTurnRight:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(-1,0,0),a);break;case r.EnumStandardView.BottomTurnBack:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,-1),a);break;case r.EnumStandardView.BottomTurnLeft:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(1,0,0),a);break;case r.EnumStandardView.FrontTurnTop:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),a);break;case r.EnumStandardView.FrontTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(1,0,0),a);break;case r.EnumStandardView.FrontTurnRight:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),a);break;case r.EnumStandardView.RightTurnTop:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),a);break;case r.EnumStandardView.RightTurnFront:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1),a);break;case r.EnumStandardView.RightTurnBack:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1),a);break;case r.EnumStandardView.BackTurnTop:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,-1,0),a);break;case r.EnumStandardView.BackTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),a);break;case r.EnumStandardView.BackTurnRight:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),a);break;case r.EnumStandardView.LeftTurnTop:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0),a);break;case r.EnumStandardView.LeftTurnBack:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),a);break;case r.EnumStandardView.LeftTurnFront:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),a)}return this.updateProjectionMatrix(),i}zoomToBBoxByWithDirection(e,t,i,r){i=i||1,t=(t=t||0)<-1?-1:t;let n=new THREE.Box3;if(n.copy(e),0!==t){const i=.5*e.getSize(this.scratchVector).length();let r=new THREE.Vector3;r.subVectors(n.max,n.min).normalize(),r.multiplyScalar(i*t),n.expandByVector(r)}const a=r;a.normalize();const s=n.getSize(this.scratchVector_2),o=n.getCenter(this.scratchVector_3),l=.5*s.length()*i,d=new THREE.Vector3;d.copy(a),d.setLength(l);const h=new THREE.Vector3;return h.subVectors(o,d),{position:h,distance:l,center:o}}zoomToBBox(e,t,i,r){i=i||1,t=(t=t||0)<-1?-1:t;var n=new THREE.Box3;if(n.copy(e),0!==t){var a=.5*e.getSize(this.scratchVector).length(),s=new THREE.Vector3;s.subVectors(n.max,n.min).normalize(),s.multiplyScalar(a*t),n.expandByVector(s)}var o=r||this.getWorldDirection(this.scratchVector),l=this.up,d=this.aspect,h=THREE.Math.degToRad(.5*this.fov),c=n.getSize(this.scratchVector_2),u=n.getCenter(this.scratchVector_3),p=.5*c.length()/Math.sin(h)*i,m=new THREE.Vector3;m.copy(o),m.setLength(p);var f=new THREE.Vector3;f.subVectors(u,m);var g=new THREE.Vector3;g.crossVectors(o,l),g.normalize();var v=new THREE.Vector3;v.crossVectors(o,g),v.normalize();var y=new THREE.Plane;y.setFromNormalAndCoplanarPoint(g,f);var M=new THREE.Plane;M.setFromNormalAndCoplanarPoint(v,f);var E=0,x=0,_=0,b=0,I=0,T=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];T[0].set(n.min.x,n.min.y,n.min.z),T[1].set(n.min.x,n.min.y,n.max.z),T[2].set(n.min.x,n.max.y,n.min.z),T[3].set(n.min.x,n.max.y,n.max.z),T[4].set(n.max.x,n.min.y,n.min.z),T[5].set(n.max.x,n.min.y,n.max.z),T[6].set(n.max.x,n.max.y,n.min.z),T[7].set(n.max.x,n.max.y,n.max.z);for(var S=0;S<8;S++){var C=new THREE.Vector3;C.subVectors(T[S],f);var w=Math.abs(C.dot(o)),R=Math.abs(M.distanceToPoint(T[S])),B=R*d,A=Math.abs(y.distanceToPoint(T[S])),P=A/d,L=Math.max(R,P),O=Math.max(B,A);E<L&&(E=L),(!x||!_||L>x*w/_)&&(x=L,_=w),(!b||!I||O>b*w/I)&&(b=O,I=w)}var D,N=b/Math.tan(h)+(p-I),H=x/Math.tan(h)+(p-_);if((D=d<1?Math.max(N,H):Math.min(N,H))<this.near){this.near=(D*D+.001*D)/16777.216}if(m.copy(o).normalize().setLength(D),f.subVectors(u,m),this.position.copy(f),this.lookAt(u),this.target.copy(u),!this.isPerspective){var U=Math.tan(this.fov*Math.PI/180/2)*D;this.orthoScale=U/E,this.zoom=this.orthoScale}return this.updateProjectionMatrix(),this.dirty=!0,u}calculateNearFar(e,t){const i=e,r=[new THREE.Vector3(i.min.x,i.min.y,i.min.z),new THREE.Vector3(i.min.x,i.min.y,i.max.z),new THREE.Vector3(i.min.x,i.max.y,i.min.z),new THREE.Vector3(i.min.x,i.max.y,i.max.z),new THREE.Vector3(i.max.x,i.min.y,i.min.z),new THREE.Vector3(i.max.x,i.min.y,i.max.z),new THREE.Vector3(i.max.x,i.max.y,i.min.z),new THREE.Vector3(i.max.x,i.max.y,i.max.z)],n=this.getWorldDirection(this.scratchVector),a=(new THREE.Plane).setFromNormalAndCoplanarPoint(n,this.position);let s=-1/0,o=1/0;r.forEach((e=>{const t=a.distanceToPoint(e);o>t-10&&(o=t-10),s<t+10&&(s=t+10)}));let l=o>0?o:.1,d=s>0?s:2e3;this.isPerspective?void 0!==t&&(l=t):l=-d,this.setNearFar(l,d)}calculateNearFar2(e,t,i){const r=e,n=r.getCenter(this.scratchVector),a=this.position.clone().sub(n).length(),s=r.getSize(this.scratchVector_2).length();let o,l;if(t){const e=.5*s;if(l=a+e,this.isPerspective){const t=.001;o=(a*a+a*t)/((1<<24)*t),a<e||i?o=.1:o+e>a&&(o=a-e)}else o=-l}else l=a,o=this.isPerspective?.1:-l;this.setNearFar(o,l)}computeRay(e,t,i){var r=new THREE.Vector2;if(void 0===i)r.x=window.innerWidth,r.y=window.innerHeight;else{var n=i===document?i.body:i;r.x=n.offsetWidth,r.y=n.offsetHeight}var a=new THREE.Vector2;a.x=e/r.x*2-1,a.y=-t/r.y*2+1;var s=new THREE.Ray;return this.isPerspective?(s.origin.copy(this.position),s.direction.set(a.x,a.y,.5).unproject(this).sub(this.position).normalize()):(s.origin.set(a.x,a.y,-1).unproject(this),s.direction.set(0,0,-1).transformDirection(this.matrixWorld)),s}screenToWorld(e,t,i,r){var n=this.computeRay(e,t,i),a=this.getWorldDirection(this.scratchVector).normalize(),s=new THREE.Plane(a);return s.setFromNormalAndCoplanarPoint(a,r),n.intersectPlane(s,r)}getWorldFrustum(e){var t=new THREE.Frustum,i=this.clone(),r=this.target,n=r.clone().sub(this.position).length();this._inverseMatrix.copy(e).invert();var a=new THREE.Matrix4;a.extractRotation(e);var s=new THREE.Quaternion;s.setFromRotationMatrix(a),s.inverse(),i.position.applyMatrix4(this._inverseMatrix);var o=r.clone();o.applyMatrix4(this._inverseMatrix);var l=o.clone().sub(i.position),d=l.length();l.normalize();var h=d/n;return i.far=camera.far*h,i.up.applyQuaternion(s).normalize(),i.realUp.applyQuaternion(s).normalize(),i.updateProjectionMatrix(),i.updateMatrixWorld(),this._inverseMatrix.copy(i.matrixWorld).invert(),t.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,this._inverseMatrix)),i=null,t}distanceFromWorldToDrawing(e,t){var i=this.position.clone(),r=this.target.clone();return r.subVectors(this.target,this.position),r.normalize(),this._inverseMatrix.copy(e).invert(),r.add(i).applyMatrix4(this._inverseMatrix),i.applyMatrix4(this._inverseMatrix),r.sub(i),r.normalize().multiplyScalar(t),r.add(i).applyMatrix4(e),r.sub(this.position),r.length()}getPositionByDis(e,t,i,r){var n=i||this.position,a=r||this.target;n=n.clone(),a=a.clone(),this._inverseMatrix.copy(t).invert(),n.applyMatrix4(this._inverseMatrix),a.applyMatrix4(this._inverseMatrix);var s=e/n.distanceTo(a),o=new THREE.Vector3;return o.subVectors(n,a),o.multiplyScalar(s),o.subVectors(n,o),o}getDistanceByPos(e,t){var i=this.position.clone();return this._inverseMatrix.copy(t).invert(),i.applyMatrix4(this._inverseMatrix),i.distanceTo(e)}updatePositionByMatrix(e,t){let i={position:this.position,target:this.target,up:this.up};i=r.Camera.drawingToWorld(i,e),i=r.Camera.worldToDrawing(i,t),this.position.copy(i.position),this.target.copy(i.target),this.up.copy(i.up)}static nearFarDrawingToWorld(e,t){let i=e.position.clone(),r=e.target.clone().sub(i);r.normalize();let n=new THREE.Matrix4;n.copy(t).invert();let a=(e,t,i,r)=>{let n=i.clone().multiplyScalar(e);n.add(t).applyMatrix4(r);let a=t.clone().applyMatrix4(r);n.sub(a);return e>0?n.length():-n.length()};return e.near&&e.far&&(e.near=a(e.near,i,r,n),e.far=a(e.far,i,r,n)),e.left&&e.right&&e.top&&e.bottom&&(e.left=a(e.left,i,r,n),e.right=a(e.right,i,r,n),e.top=a(e.top,i,r,n),e.bottom=a(e.bottom,i,r,n)),e}static drawingToWorld(e,t){let i=e.position.clone(),r=e.target.clone(),n=e.up.clone(),a=new THREE.Matrix4;return a.copy(t).invert(),n.add(i),n.applyMatrix4(a),i.applyMatrix4(a),r.applyMatrix4(a),n.sub(i),n.normalize(),{position:i,target:r,up:n}}static worldToDrawing(e,t){var i=e.position.clone(),r=e.target.clone(),n=e.up.clone();return n.add(i),n.applyMatrix4(t),i.applyMatrix4(t),r.applyMatrix4(t),n.sub(i),n.normalize(),{position:i,target:r,up:n}}}r.Camera=e})(),r.Animation=function(){var e=this,t=null,i={},r={},n=1e3,a=null,s=null,o=null,l=!1,d=null,h=null,c=null;this.from=function(e){for(var r in t=e)i[r]=t[r];return this},this.to=function(e,t){return void 0!==t&&(n=t),r=e,this},this.onStart=function(e){return d=e,this},this.onUpdate=function(e){return h=e,this},this.onComplete=function(e){return c=e,this},this.start=function(e){l=!1,s&&cancelAnimationFrame(s),a=Date.now(),o=this.interpolate,s=requestAnimationFrame((function u(){var p,m=i,f=r,g=Date.now();!1===l&&(null!==d&&d.call(t),l=!0),t=o(m,f,p=(p=(g-a)/n)>1?1:p),1===p?(cancelAnimationFrame(s),null!==c&&c.call(t)):(requestAnimationFrame(u,e),null!==h&&h.call(t,p))}),e)},this.isAngleGreaterThanPi=function(e,t,i){var r=new THREE.Vector3;return r.crossVectors(e,t),!(r.dot(i)>=0)},this.conicInterpolate=function(e,t,i,r){var n=-t.angleTo(e)*r,a=new THREE.Vector3;a.crossVectors(t,e).normalize();var s=new THREE.Quaternion;s.setFromAxisAngle(a,n),i.copy(e),i.applyQuaternion(s)},this.quaternionInterpolate=function(e,t,i,r,n){var a=new THREE.Quaternion(e.x,e.y,e.z,1).normalize(),s=new THREE.Quaternion(t.x,t.y,t.z,1).normalize(),o=new THREE.Quaternion(0,0,0,1),l=new THREE.Quaternion(0,0,0,1),d=new THREE.Vector3;d.crossVectors(e,i).normalize(),o.set(d.x,d.y,d.z,1).normalize();var h=0;n<.5?(h=2*n,THREE.Quaternion.slerp(a,o,l,h),r.set(l.x,l.y,l.z)):(h=2*(n-.5),THREE.Quaternion.slerp(o,s,l,h),r.set(l.x,l.y,l.z))},this.slerpInterpolate=function(e,t,i,r,n,a){var s=e.dot(t);a<s?r.copy(t):a<Math.abs(s)?this.quaternionInterpolate(e,t,i,r,n):this.conicInterpolate(e,t,r,n),r.normalize()},this.linearInterpolate=function(e,t,i,r,n){if(e.equals(t))i.copy(t);else{var a=new THREE.Vector3(1,0,0),s=new THREE.Vector3(0,0,1),o=new THREE.Vector3,l=0,d=e.dot(t);n<d?i.copy(t):n<-d?(n>Math.abs(e.dot(s))?o.crossVectors(e,s).normalize():o.crossVectors(e,a).normalize(),r<.5?(l=2*r,i.lerpVectors(e,o,l)):(l=2*(r-.5),i.lerpVectors(o,t,l))):i.lerpVectors(e,t,r),i.normalize()}},this.linearInterpolatePosition=function(e,t,i,r){i.lerpVectors(e,t,r)},this.sphericalInterpolate=function(e,t,i,r,n,a){var s=e.clone().sub(t),o=i.clone().sub(r),l=new THREE.Spherical;l.setFromVector3(s);var d=new THREE.Spherical;d.setFromVector3(o);let h=d.theta-l.theta;Math.abs(h)>Math.PI&&(h=h>0?-(2*Math.PI-Math.abs(h)):2*Math.PI-Math.abs(h));var c=l.theta+h*a,u=l.phi+(d.phi-l.phi)*a,p=s.length(),m=new THREE.Spherical;m.set(p,u,c);var f=new THREE.Vector3;f.setFromSpherical(m),n.copy(f).multiplyScalar(-1)},this.interpolate=function(t,i,r){var n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=t.animPos,h=t.animTarget,c=(t.animDir,t.animUp),u=t.animFocal,p=t.zoom,m=i.animPos,f=i.animTarget,g=(i.animDir,i.animUp),v=i.animFocal,y=i.zoom;return e.sphericalInterpolate(d,h,m,f,n,r),e.linearInterpolate(c,g,a,r,.9995),e.linearInterpolatePosition(h,f,s,r),e.linearInterpolatePosition(u,v,o,r),e.linearInterpolatePosition(p,y,l,r),{animDir:n,animUp:a,animTarget:s,animFocal:o,zoomScale:l}}},(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;r.CameraAnimator=class{constructor(){this._duration=500,this._frameTime=13,this._animation=new r.Animation,this.lastPosition=new THREE.Vector3,this.lastBox=new THREE.Box3,this.lastMargin=void 0}setDuration(e){this._duration=e}getDuration(){return this._duration}setFrameTime(e){this._frameTime=e}setStandardView(i){const{stdView:n,viewer:a,box:s,margin:o,direction:l,callbackProcess:d,callbackFinished:h}=i;var c=a.camera,u=c.position.clone(),p=c.target.clone(),m=c.getWorldDirection(e);m.normalize();var f=new THREE.Vector3;f.copy(c.realUp||c.up),f.normalize();var g=new THREE.Vector3(c.position.clone().sub(p).length(),0,0);const v=a.camera.clone();v.setStandardView(n,s);let y=v.zoomToBBox(s,o,void 0,l),M=v.position.clone(),E=new THREE.Vector3;E.copy(v.realUp||v.up),E.normalize();let x=l;if(r.Utils.isDefined(x)){const e=M.distanceTo(y);x.normalize(),M=y.clone().sub(x.clone().multiplyScalar(e)),x.y<-.9999?E.set(0,0,-1):x.y>.9999?E.set(0,0,1):E.set(0,1,0)}else x=v.getWorldDirection(t),x.normalize();const _=new THREE.Vector3(M.clone().sub(y).length(),0,0);0!=(()=>{const e=.01,t=this.lastPosition.clone().sub(u).length()<e,i=x.clone().sub(m).length()<e,r=E.clone().sub(f).length()<e,n=this.lastBox.equals(s),a=this.lastMargin===o;return!(t&&i&&r&&n&&a)})()?(this.lastPosition.copy(M),this.lastBox.copy(s),this.lastMargin=o,a.getEditorManager().setInteractiveState(!1),this._animation.from({animPos:u,animDir:m,animUp:f,animTarget:p,animFocal:g,zoom:1}).to({animPos:M,animDir:x,animUp:E,animTarget:y,animFocal:_,zoom:1},this._duration).onUpdate((function(){if(a.camera){var e=this.animTarget,t=this.animDir,i=this.animUp,n=this.animFocal.x;a.camera.LookAt(e,t,i,n),r.Utils.isDefined(l),a.cameraControl.update(!0,!0),a.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),d&&d()}})).onComplete((function(){a.camera&&(a.camera.setZoom(1),a.camera.LookAt(y,x,E,_.x),r.Utils.isDefined(l),a.cameraControl.update(!0,!0),setTimeout((()=>{h&&h()}),500),a.getEditorManager().setInteractiveState(!0))})).start(this._frameTime)):h&&h()}active(e,t,i,n,a){var s=i.camera,o=new THREE.Vector3(e.position.x,e.position.y,e.position.z),l=new THREE.Vector3(e.target.x,e.target.y,e.target.z),d=new THREE.Vector3(l.distanceTo(o),0,0),h=l.clone().sub(o).normalize(),c=new THREE.Vector3(e.up.x,e.up.y,e.up.z);c.normalize();var u=new THREE.Vector3(e.zoom),p=new THREE.Vector3(t.position.x,t.position.y,t.position.z),m=new THREE.Vector3(t.target.x,t.target.y,t.target.z),f=new THREE.Vector3(m.distanceTo(p),0,0),g=m.clone().sub(p).normalize(),v=new THREE.Vector3(t.up.x,t.up.y,t.up.z);v.normalize();var y=new THREE.Vector3(t.zoom,0,0);if(0==function(){let e=.01,t=p.clone().sub(o).length()<e,i=g.clone().sub(h).length()<e,r=v.clone().sub(c).length()<e;return!(t&&i&&r)}())return console.log("Current camera status is equal with before."),void(a&&a());i.getEditorManager().setInteractiveState(!1),this._animation.from({animPos:o,animDir:h,animUp:c,animTarget:l,animFocal:d,zoom:u}).to({animPos:p,animDir:g,animUp:v,animTarget:m,animFocal:f,zoom:y},this._duration).onUpdate((function(){var e=this.animTarget,t=this.animDir,a=this.animUp,o=this.animFocal.x,l=this.zoomScale.x;s.setZoom(l),s.LookAt(e,t,a,o),i.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),n&&n(e)})).onComplete((function(){s.setZoom(y.x),s.LookAt(m,g,v,f.x),n&&n(m),setTimeout((()=>{a&&a()}),500),i.getEditorManager().setInteractiveState(!0)})).start(this._frameTime)}}})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Matrix4;var n;r.CameraInfo=function(e,t,i,r,n,a,s,o,l,d){this.name=e,this.position=t,this.target=i,this.up=r,this.near=n,this.far=a,this.zoom=s,this.frustumWidth=l,this.frustumHeight=d,this.version=void 0===o?1:o},r.PerspectiveCameraInfo=function(e,t,i,n,a,s,o,l,d,h,c){r.CameraInfo.call(this,"persp",e,t,i,s,o,l,d,h,c),this.fov=n,this.aspect=a},r.OrthographicCameraInfo=function(e,t,i,n,a,s,o,l,d,h,c,u,p){r.CameraInfo.call(this,"orth",e,t,i,l,d,h,c,u,p),this.left=n,this.right=a,this.top=s,this.bottom=o},r.CameraUtil={createCameraInfo:function(e){var t=e.camera,i=new CameraInfo(e.getCameraName(),t.position,t.target,t.up);return JSON.stringify(i)},transformCamera:function(e,t){var i=new THREE.Vector3,n=function(e){return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])]};i.fromArray(n(e.position.split(",")));var a=new THREE.Vector3;a.fromArray(n(e.direction.split(",")));var s=new THREE.Vector3;s.fromArray(n(e.up.split(",")));var o=new THREE.Vector3;o.addVectors(i,a),i.applyMatrix4(t.rootNode.matrix),o.applyMatrix4(t.rootNode.matrix);var l=new THREE.Matrix4;return l.makeRotationFromEuler(t.rootNode.rotation),s.applyMatrix4(l),s.normalize(),new r.CameraInfo(e.name,i,o,s)},parseCameraInfo:function(e){if(!e)return null;var t;if("[object Object]"===Object.prototype.toString.call(e))t=e;else{if("[object String]"!==Object.prototype.toString.call(e))return null;t=JSON.parse(e)}if(!t.hasOwnProperty("position")||!t.hasOwnProperty("target")||!t.hasOwnProperty("up"))return null;var i=t.name||"persp",n=new THREE.Vector3;n.x=t.position.x,n.y=t.position.y,n.z=t.position.z;var a=new THREE.Vector3;a.x=t.target.x,a.y=t.target.y,a.z=t.target.z;var s=new THREE.Vector3;s.x=t.up.x,s.y=t.up.y,s.z=t.up.z;var o=void 0===t.version?0:t.version,l=t.frustumWidth,d=t.frustumHeight;return"persp"===i?new r.PerspectiveCameraInfo(n,a,s,t.fov,t.aspect,t.near,t.far,t.zoom,o,l,d):new r.OrthographicCameraInfo(n,a,s,t.left,t.right,t.top,t.bottom,t.near,t.far,t.zoom,o,l,d)},canvasToNormalized:function(e,t,i){var r={x:0,y:0,z:0};return r.x=e.x/t*2-1,r.y=-e.y/i*2+1,r.z=e.z||0,r},normalizedToCanvas:function(e,t,i){var r={x:0,y:0,z:0};return r.x=Math.floor(.5*(e.x+1)*t+.5),r.y=Math.floor(-.5*(e.y-1)*i+.5),r.z=e.z||0,r},drawingToCanvas:function(e,t,i,r){var n=new THREE.Vector3(t.x,t.y,t.z);return n.project(e),this.normalizedToCanvas(n,i,r)},drawingPointsToCanvas:function(e,t,r,n,a){var s={};i.copy(e.matrixWorld).invert();var o=new THREE.Vector3(t.x,t.y,t.z);o.applyMatrix4(i);var l=new THREE.Vector3(r.x,r.y,r.z);if(l.applyMatrix4(i),e.isPerspective&&o.z>0&&l.z>0)return null;if(!e.isPerspective&&o.z>e.far&&l.z>e.far)return null;var d=o.clone().sub(l);if(d.normalize(),e.isPerspective){if(o.z>0){const t=(o.z+e.near)/d.z;o.sub(d.multiplyScalar(t))}else if(l.z>0){const t=(l.z+e.near)/d.z;l.sub(d.multiplyScalar(t))}}else if(o.z>e.far){const t=(o.z-e.far)/d.z;o.sub(d.multiplyScalar(t))}else if(l.z>e.far){const t=(l.z-e.far)/d.z;l.sub(d.multiplyScalar(t))}return o.applyMatrix4(e.projectionMatrix),l.applyMatrix4(e.projectionMatrix),s.start=this.normalizedToCanvas(o,n,a),s.end=this.normalizedToCanvas(l,n,a),s},lineIntersectWithRect:function(e,t){if(e&&e.start.x==e.end.x&&e.start.y==e.end.y)return console.log("Invalid line."),null;var i,r=0;e.start.x!=e.end.x&&(r=(e.start.y-e.end.y)/(e.start.x-e.end.x)),i=e.start.y-r*e.start.x;var n=[],a=t.min,s=t.max;return r*a.x+i>=a.y&&r*a.x+i<=s.y&&n.push(new THREE.Vector2(a.x,r*a.x+i)),r*s.x+i>=a.y&&r*s.x+i<=s.y&&n.push(new THREE.Vector2(s.x,r*s.x+i)),0==r&&(n.push(new THREE.Vector2(e.start.x,a.y)),n.push(new THREE.Vector2(e.start.x,s.y))),(a.y-i)/r>a.x&&(a.y-i)/r<s.x&&n.push(new THREE.Vector2((a.y-i)/r,a.y)),(s.y-i)/r>a.x&&(s.y-i)/r<s.x&&n.push(new THREE.Vector2((s.y-i)/r,s.y)),n},canvasToDrawing:function(e,t,i,r){var n=this.canvasToNormalized(t,i,r),a=new THREE.Vector3(n.x,n.y,n.z);return a.unproject(e),{x:a.x,y:a.y,z:a.z}},intersectBoxByRay:function(e,t){var i,r,n,a,s,o,l=1/e.direction.x,d=1/e.direction.y,h=1/e.direction.z,c=e.origin;return l>=0?(i=(t.min.x-c.x)*l,r=(t.max.x-c.x)*l):(i=(t.max.x-c.x)*l,r=(t.min.x-c.x)*l),d>=0?(n=(t.min.y-c.y)*d,a=(t.max.y-c.y)*d):(n=(t.max.y-c.y)*d,a=(t.min.y-c.y)*d),i>a||n>r?null:((n>i||i!=i)&&(i=n),(a<r||r!=r)&&(r=a),h>=0?(s=(t.min.z-c.z)*h,o=(t.max.z-c.z)*h):(s=(t.max.z-c.z)*h,o=(t.min.z-c.z)*h),i>o||s>r?null:((s>i||i!=i)&&(i=s),(o<r||r!=r)&&(r=o),r<0?null:i>=0?i:r))},intersectObjectWithFrustum:(n=new THREE.Box3,function(e,t){if(!e.boundingBox||e instanceof THREE.Mesh){var i=e.geometry;null===i.boundingBox&&i.computeBoundingBox(),n.copy(i.boundingBox)}else n.copy(e.boundingBox);return n.applyMatrix4(e.matrixWorld),t.intersectsBox(n)}),equalsCamera:function(i,n){const a=r.Math.EPSILON15;return r.Math.equalsEpsilonVec3(i.position,n.position,a)&&r.Math.equalsEpsilonVec3(i.up,n.up,a)&&r.Math.equalsEpsilonVec3(i.realUp,n.realUp,a)&&r.Math.equalsEpsilonVec3(i.getWorldDirection(e),n.getWorldDirection(t),a)&&r.Math.equalsEpsilonFrustum(i.frustum,n.frustum,r.Math.EPSILON1)},onlyFrustumChanged:function(i,n){const a=r.Math.EPSILON15;return r.Math.equalsEpsilonVec3(i.position,n.position,a)&&r.Math.equalsEpsilonVec3(i.up,n.up,a)&&r.Math.equalsEpsilonVec3(i.realUp,n.realUp,a)&&r.Math.equalsEpsilonVec3(i.getWorldDirection(e),n.getWorldDirection(t),a)}}})(),function(){class e extends THREE.Fog{constructor(){super();var e=this;e.postProcessMap=null,e.postProcessAdditiveMap=null,e.postProcessSSAOMap=null,e.postProcessSSRMap=null,e.viewport={w:0,h:0},e.isPostOnly=!0,THREE.ShaderChunk.fog_pars_vertex="\n            #ifdef USE_FOG\n            #endif\n            ",THREE.ShaderChunk.fog_vertex="\n            #ifdef USE_FOG\n            #endif\n            ",THREE.ShaderChunk.fog_pars_fragment="\n                #ifdef USE_FOG\n                    uniform vec3 fogColor;\n                    uniform sampler2D postProcessMap;\n                    uniform sampler2D postProcessAdditiveMap;\n                    uniform sampler2D postProcessSSAOMap;\n                    uniform sampler2D postProcessSSRMap;\n                    uniform float postProcessMixRate;\n                    uniform float postProcessAdditiveRate;\n                    uniform float postProcessSSAORate;\n                    uniform float postProcessSSRRate;\n                    uniform float viewportWidth;\n                    uniform float viewportHeight;\n                    varying float fogDepth;\n\n                    #ifdef FOG_EXP2\n                        uniform float fogDensity;\n                    #else\n                        uniform float fogNear;\n                        uniform float fogFar;\n                    #endif\n\n                    #include <postprocess_mix_minus_color>\n                #endif\n                ",THREE.ShaderChunk.fog_fragment="\n                #ifdef USE_FOG\n                    // #if ! defined( USE_POST_ONLY )\n                    //     #ifdef FOG_EXP2\n                    //         float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n                    //     #else\n                    //         float fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n                    //     #endif\n                    //     gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n                    // #endif\n                    vec2 postUV = vec2(gl_FragCoord.x/viewportWidth,gl_FragCoord.y/viewportHeight);\n\n                    if(postProcessAdditiveRate> 0.0){\n                        vec4 postAdditiveColor = texture2D( postProcessAdditiveMap, postUV );\n//                      gl_FragColor.rgba = postAdditiveColor.rgba;\n//                      gl_FragColor.rgb = postprocess_mix_minus_color(postAdditiveColor, vec3(1.0));\n                        gl_FragColor.rgb = postprocess_mix_minus_color(postAdditiveColor, gl_FragColor.rgb);\n                    }\n                    #if !(defined( USE_NO_SSAO ) || defined( USE_COLORWITHOUTLIGHT ))\n                        if(postProcessSSAORate > 0.0){\n                            vec4 postSSAOColor = texture2D( postProcessSSAOMap, postUV );\n                            gl_FragColor.rgb = postprocess_mix_minus_color(postSSAOColor, gl_FragColor.rgb);\n                        }\n                    #endif\n\n                    #ifndef USE_NO_SSR\n                        if(postProcessSSRRate > 0.0){\n                            vec4 postSSRColor = texture2D( postProcessSSRMap, postUV );\n                            gl_FragColor.rgb += postSSRColor.rgb * postSSRColor.a;\n\n                        }\n                    #endif\n\n                    if ( postProcessMixRate > 0.0 ) {\n                        vec4 postColor = texture2D( postProcessMap, postUV );\n//                      gl_FragColor.rgba = postColor.rgba;\n//                      gl_FragColor.rgb = vec3(postColor.a);\n//                      gl_FragColor.rgb = vec3(0.0);\n                        if ( postColor.a>0.0) {\n                            gl_FragColor.rgb = mix( gl_FragColor.rgb, postColor.rgb, postColor.a);\n                        }\n                    }\n                #endif\n                ",THREE.ShaderChunk.postprocess_mix_color="\n                vec4 mix_color(vec4 originalColor, vec3 mixColor, float mixNum){\n                    float _mixNum = 1.0-(1.0-mixNum)*(1.0-originalColor.a);\n                    if ( _mixNum==0.0 ) {\n                        return originalColor;\n                    }\n                   vec3 _color = mix(originalColor.rgb*originalColor.a,mixColor, mixNum)/_mixNum;\n                   return vec4(_color,_mixNum);\n                }\n                ",THREE.ShaderChunk.postprocess_original_color="\n                vec4 get_original_color(sampler2D tDiffuse, vec2 v_textureCoordinates, float firstFlg){\n                   vec4 color = texture2D(tDiffuse, v_textureCoordinates);\n                    if(firstFlg==0.0) {\n                       color = vec4(0.0);\n                    }\n                    return color;\n                }\n                ",THREE.ShaderChunk.postprocess_minus_color="\n                vec4 postprocess_minus_color(vec3 originalColor, vec3 texColor){\n                    float fragColor_a = 0.0;\n                    float fragColor_r = originalColor.r-texColor.r;\n                    float fragColor_g = originalColor.g-texColor.g;\n                    float fragColor_b = originalColor.b-texColor.b;\n                    if(fragColor_r <0.0){\n                        fragColor_a+=0.1;\n                    }\n                    if(fragColor_g <0.0){\n                        fragColor_a+=0.2;\n                    }\n                    if(fragColor_b <0.0){\n                        fragColor_a+=0.4;\n                    }\n                    return vec4(abs(fragColor_r), abs(fragColor_g), abs(fragColor_b),fragColor_a);\n                }\n                ",THREE.ShaderChunk.postprocess_mix_minus_color="\n                vec3 postprocess_mix_minus_color(vec4 originalColor, vec3 addColor){\n                    float fragColor_r = originalColor.r;\n                    float fragColor_g = originalColor.g;\n                    float fragColor_b = originalColor.b;\n                    float fragColor_a = originalColor.a;\n\n                    if(fragColor_a>0.35){\n                        fragColor_b=addColor.b-fragColor_b;\n                        fragColor_a=fragColor_a - 0.4;\n                    }else{\n                        fragColor_b +=addColor.b;\n                    }\n                    if(fragColor_b<0.0){\n                        fragColor_b=0.0;\n                    }\n\n                    if(fragColor_a>0.15){\n                        fragColor_g=addColor.g-fragColor_g;\n                        fragColor_a=fragColor_a-0.2;\n                    }else{\n                        fragColor_g +=addColor.g;\n                    }\n                   if(fragColor_g<0.0){\n                        fragColor_g=0.0;\n                    }\n\n                    if(fragColor_a > 0.05){\n                        fragColor_r=addColor.r-fragColor_r;\n                    }else{\n                        fragColor_r +=addColor.r;\n                    }\n                    if(fragColor_r<0.0){\n                        fragColor_r=0.0;\n                    }\n\n                    return vec3(fragColor_r,fragColor_g,fragColor_b);\n                }\n                "}setPostProcessMap(e){this.postProcessMap=e}setPostProcessAdditiveMap(e){this.postProcessAdditiveMap=e}setPostProcessSSAOMap(e){this.postProcessSSAOMap=e}setPostProcessSSRMap(e){this.postProcessSSRMap=e}setViewport(e,t){this.viewport.w=e,this.viewport.h=t}destroy(){var e=this;e.postProcessMap=null,e.postProcessAdditiveMap=null,e.postProcessSSAOMap=null,e.postProcessSSRMap=null,e.isPostOnly=null,e.viewport=null}}r.PostProcess=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="LineSegmentsHighLightMaterial",this.cameraNear=.1,this.cameraFar=10,this.pixelRatio=1,this.frustumPlanes=new THREE.Vector4,this.viewport=new THREE.Vector4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{cameraNear:{value:this.cameraNear},cameraFar:{value:this.cameraFar},pixelRatio:{value:this.pixelRatio},frustumPlanes:{value:this.frustumPlanes.clone()},viewport:{value:this.viewport.clone()}}]),this.vertexShader=THREE.ShaderChunk.meshbasic_vert,this.vertexShader=this.vertexShader.replace("void main() {","\n                attribute vec3 offsetNormal;\n                uniform float cameraNear;\n                uniform float cameraFar;\n                uniform float pixelRatio;\n                uniform vec4 frustumPlanes;\n                uniform vec4 viewport;\n\n                float metersPerPixel(vec4 positionEC) {\n                    float width = viewport.z;\n                    float height = viewport.w;\n                    float pixelWidth;\n                    float pixelHeight;\n                    float top = frustumPlanes.x;\n                    float bottom = frustumPlanes.y;\n                    float left = frustumPlanes.z;\n                    float right = frustumPlanes.w;\n            \n                    float distanceToPixel = -positionEC.z;\n                    float inverseNear = 1.0 / cameraNear;\n                    float tanTheta = top * inverseNear;\n                    pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n                    tanTheta = right * inverseNear;\n                    pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n            \n                    return max(pixelWidth, pixelHeight) * pixelRatio;\n                }\n\n                void main() {\n                \n            ").replace("#include <begin_vertex>","\n                vec3 transformed = vec3( position );\n                vec4 positionEC = vec4(transformed, 1.0);\n                positionEC = modelViewMatrix * positionEC;\n                float width = metersPerPixel(positionEC);\n                positionEC.xyz += offsetNormal * width;           \n                transformed = positionEC.xyz;\n            ").replace("#include <project_vertex>","\n                vec4 mvPosition = vec4( transformed, 1.0 );\n                #ifdef USE_INSTANCING           \n                    mvPosition = instanceMatrix * mvPosition;             \n                #endif             \n                gl_Position = projectionMatrix * mvPosition;\n            "),this.fragmentShader=THREE.ShaderChunk.meshbasic_frag}refreshUniforms(){this.uniforms.cameraNear.value=this.cameraNear,this.uniforms.cameraFar.value=this.cameraFar,this.uniforms.pixelRatio.value=this.pixelRatio,this.uniforms.frustumPlanes.value.copy(this.frustumPlanes),this.uniforms.viewport.value.copy(this.viewport)}}class t extends THREE.Mesh{constructor(e,t){super(e,t),this.type="LineSegmentsPickMesh"}onBeforeRender(e,t,i,r,n,a){let s=n.frustumPlanes;s.x=i.near*Math.tan(.5*THREE.Math.degToRad(i.fov)),s.y=-s.x,s.w=i.aspect*s.x,s.z=-s.w,n.cameraNear=i.near,n.cameraFar=i.far,n.pixelRatio=1*e.getPixelRatio(),n.viewport.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight),n.refreshUniforms(),n.needsUpdate=!0}}r.LineSegmentsHighLightMaterial=e,r.LineSegmentsPickGeometryCreaetor=class{constructor(e,t){let i=this._getPoints(e,t),r=[];for(let e of i)r.push(this._create(e));let n=0,a=0,s=0;for(let e=0;e<r.length;++e)n+=r[e].position.array.length,a+=r[e].offsetNormal.array.length,s+=r[e].index.array.length;let o=new Float32Array(n),l=new Float32Array(a),d=new Uint32Array(s),h=0,c=0,u=0,p=0;for(let e=0;e<r.length;++e){for(let t=0;t<r[e].position.array.length;++t)o[h+t]=r[e].position.array[t];h+=r[e].position.array.length;for(let t=0;t<r[e].offsetNormal.array.length;++t)l[c+t]=r[e].offsetNormal.array[t];c+=r[e].offsetNormal.array.length;for(let t=0;t<r[e].index.array.length;++t)d[u+t]=r[e].index.array[t]+p;u+=r[e].index.array.length,p+=r[e].position.count}this.mergeGeometry=new THREE.BufferGeometry,this.mergeGeometry.setAttribute("position",new THREE.BufferAttribute(o,3)),this.mergeGeometry.setAttribute("offsetNormal",new THREE.BufferAttribute(l,3)),this.mergeGeometry.setIndex(new THREE.BufferAttribute(d,1))}getGeometry(){return this.mergeGeometry}_getPoints(e,t){let i=e.attributes.position.array,r=e.index.array,n=[];for(let e=0;e<t.length;++e){let a=[],s=t[e].indexStart,o=t[e].indexCount,l=-1;for(let e=s;e<o+s;e+=2){let t=new THREE.Vector3(i[3*r[e]],i[3*r[e]+1],i[3*r[e]+2]),s=new THREE.Vector3(i[3*r[e+1]],i[3*r[e+1]+1],i[3*r[e+1]+2]);r[e]!==l&&(a.length>0&&(n.push(a),a=[],l=-1),a.push(t)),a.push(s),l=r[e+1]}n.push(a)}return n}_create(e){let t=this._createBoxByLinePt(e),i=new Float64Array(3*t.position.length),r=new Float64Array(3*t.offsetNormal.length);for(let e=0;e<t.position.length;++e)i[3*e]=t.position[e].x,i[3*e+1]=t.position[e].y,i[3*e+2]=t.position[e].z;for(let e=0;e<t.offsetNormal.length;++e)r[3*e]=t.offsetNormal[e].x,r[3*e+1]=t.offsetNormal[e].y,r[3*e+2]=t.offsetNormal[e].z;let n=new Uint32Array(t.index.length);for(let e=0;e<t.index.length;++e)n[e]=t.index[e];return{position:new THREE.BufferAttribute(i,3),offsetNormal:new THREE.BufferAttribute(r,3),index:new THREE.BufferAttribute(n,1)}}_getRotationAxis(e){const t=e;t.normalize();const i=Math.abs(t.x),r=Math.abs(t.y),n=Math.abs(t.z);let a=Number.MAX_VALUE;const s=new THREE.Vector3,o=new THREE.Vector3;return i<=a&&(a=i,s.set(1,0,0)),r<=a&&(a=r,s.set(0,1,0)),n<=a&&s.set(0,0,1),o.crossVectors(t,s).normalize(),o}_createBoxByLinePt(e){let t=[],i=[],r=[];for(let n=0;n<e.length-1;++n){let a=e[n],s=e[n+1],o=(new THREE.Vector3).subVectors(s,a);if(0===o.x&&0===o.y&&0===o.z)continue;let l=this._getRotationAxis(o);o.applyAxisAngle(l,90*Math.PI/180),o.normalize();let d=(new THREE.Vector3).add(o),h=(new THREE.Vector3).add(o),c=(new THREE.Vector3).sub(o),u=(new THREE.Vector3).sub(o),p=l,m=a,f=d.clone().add(p).normalize(),g=a,v=d.clone().sub(p).normalize(),y=s,M=h.clone().add(p).normalize(),E=s,x=h.clone().sub(p).normalize(),_=a,b=c.clone().add(p).normalize(),I=a,T=c.clone().sub(p).normalize(),S=s,C=u.clone().add(p).normalize(),w=s,R=u.clone().sub(p).normalize(),B=i.length;t.push(B,B+5,B+4),t.push(B,B+1,B+5),t.push(B+2,B+7,B+3),t.push(B+2,B+6,B+7),t.push(B,B+4,B+2),t.push(B,B+6,B+4),t.push(B+5,B+3,B+1),t.push(B+5,B+7,B+3),t.push(B+1,B,B+2),t.push(B+1,B+2,B+3),t.push(B+6,B+4,B+5),t.push(B+6,B+5,B+7),i.push(m,g,y,E,_,I,S,w),r.push(f,v,M,x,b,T,C,R)}return{position:i,offsetNormal:r,index:t}}},r.LineSegmentsPickMesh=t}(),function(){class e extends THREE.WebGLRenderer{constructor(e){super(e),this._renderBufferDirect=this.renderBufferDirect,this.renderBufferDirect=this._renderBufferDirectEx,this._render=this.render,this.render=this._renderEx,this._timeStart=0,this._timeEnd=0,this._timeElapse=0,this._frameNumber=0,this._newFrame=!0,this._renderBreaking=!1,this._renderInteracting=!1,this._forceRenderStateInit=!1,this._limitFrameTimeWithInteracting=30,this._frameTimeThreshold=0,this.disableRenderBreaking=!1}destroy(){this.dispose()}set renderInteracting(e){this._renderInteracting=e}get renderInteracting(){return this._renderInteracting}set forceRenderStateInit(e){this._forceRenderStateInit=e}get forceRenderStateInit(){return this._forceRenderStateInit}_renderBufferDirectEx(e,t,i,r,n,a){if(t){if(!this.disableRenderBreaking){if(!this._checkIfRender())return;if(this._isObjectRendered(n,a))return}this._renderBufferDirect(e,t,i,r,n,a),this._setStateOfObject(t,n,a),t._renderFinished=!1}else this._renderBufferDirect(e,t,i,r,n,a)}_renderEx(e,t){return this._resetState(),this._updateSceneState(e),this._render(e,t),e._renderFinished&&this._resetStateOfObjects(e),e._renderFinished}_resetState(){this._timeStart=0,this._timeEnd=0,this._renderBreaking=!1,this._newFrame=!1,this._frameTimeThreshold=this._renderInteracting?this._limitFrameTimeWithInteracting:r.GlobalData.LimitFrameTime,this.autoClear&&(this._frameNumber=r.Math.incrementWrap(this._frameNumber,15e6,1),this._newFrame=!0)}_updateSceneState(e){void 0===e._renderedObjects&&(e._renderedObjects=[]),e._renderFinished=!0,this._forceRenderStateInit?e.renderStateInitSkipped=!1:e.renderStateInitSkipped=!this._newFrame||!!this._renderInteracting,this._newFrame&&this._resetStateOfObjects(e)}_setStateOfObject(e,t,i){t._frameNumber=this._frameNumber,t._rendered=!0,i&&(i._rendered=!0),e._renderedObjects.push({object:t,group:i})}_resetStateOfObjects(e){e._renderedObjects.forEach((e=>{e.object._rendered=void 0,e.group&&(e.group._rendered=void 0)})),e._renderedObjects.length=0}_checkIfRender(){return!this._renderBreaking&&(this._timeStart||(this._timeStart=Date.now()),this._timeEnd=Date.now(),this._timeElapse=this._timeEnd-this._timeStart,!(this._timeElapse>this._frameTimeThreshold)||(this._renderBreaking=!0,!1))}_isObjectRendered(e,t){return t?e._rendered&&t._rendered:e._rendered}}r.WebGLRenderer=e}(),r.IncrementedRenderer=class{constructor(e,t){this.manager=e,this.viewer=e.viewer,this.countRenderRequest=0,this.maxCountRenderRequest=1e4,this.rendering=!1,this.incrementRenderHandle=0,this.renderer=new r.WebGLRenderer(t),this._renderSize=new THREE.Vector2,this.depthPass=new r.DepthRenderPass(this.viewer.modelManager),r.GlobalData.EnableShadowMap&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0,this.viewer.getScene().lightManager.shadowLightNum++),this._renderingCamera=void 0}destroy(){this.incrementRenderHandle>0&&cancelAnimationFrame(this.incrementRenderHandle),this.renderer&&(this.renderer.destroy&&this.renderer.destroy(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.depthPass.destroy(),this.depthPass=null,this._renderSize=null,this.manager=null,this.viewer=null,this._renderingCamera=void 0}forceRenderOneFrame(){const e=this.viewer,t=e.camera,i=e.modelManager.getScene();this.renderer.render(i,t,null,!0)}_render(){if(!this.manager.prepareRender())return;if(++this.countRenderRequest,this.countRenderRequest>this.maxCountRenderRequest&&(this.countRenderRequest=0),this.rendering||this.pickingEffectRendering)return;this.rendering=!0;const e=this,t=this.viewer,i=t.camera,n=t.modelManager,a=t.editorManager,s=t.getScene(),o=this.renderer;n.calculateCameraModelRelation(i.position),t.calculateNearFar(),t.cameraControl.updateCamera(),s.updateLights(i,t),void 0===this._renderingCamera?this._renderingCamera=i.clone():this._renderingCamera.copy(i);const l=a.isUpdateRenderList,d=o.autoClear;o.renderInteracting=!l,l&&(n.prepareScene(i),r.GlobalData.EnableCSM&&s.updateLights(i,t)),t.onCallbacks(r.EnumRenderCallbackType.PRE_RENDER),t.getIBLManager().renderWithOrthCamera(t,o,this._renderingCamera,l),this.incrementRenderHandle=requestAnimationFrame(function i(r,h,c){let u=h,p=r;return function(){o.autoClear=c,a.cameraChange?(o.autoClear=!0,a.cameraChange=!1,t.getIBLManager().renderWithOrthCamera(t,o,u,l)):o.autoClear=c,-1!==e.incrementRenderHandle?o.render(s,u)||p!==e.countRenderRequest?(e.rendering=!1,p!==e.countRenderRequest?(o.autoClear=d,t.render()):(e._renderPickingObjects(),t.onRenderFinishedCallback(),n.disposeBufferAfterVbo(),o.autoClear=d)):e.incrementRenderHandle=requestAnimationFrame(i(p,u,!1)):e.rendering=!1}}(e.countRenderRequest,this._renderingCamera,o.autoClear)),t.onRenderCallback(),t.cameraControl.setCameraChanging(!1)}render(e){this._render(e)}renderDepth(e,t,i,r){this.depthPass.renderDepth(e,t,i,r)}renderCustomDepth(e,t,i,r,n){this.depthPass.renderCustomDepth(e,t,i,r,n)}renderCustomDepthWithoutDEM(e,t,i,r){this.depthPass.renderCustomDepthWithoutDEM(e,t,i,r)}renderCustomDepthByVisibleModels(e,t,i,r,n,a){this.depthPass.renderCustomDepthByVisibleModels(e,t,i,r,n,a)}_applyPickingEffect(){const e=this.manager.getPickingEffecter();if(!e)return;const t=this.viewer.modelManager.isFilterApplied();e.apply(t)}_renderPickingObjects(){const e=this.renderer,t=e.forceRenderStateInit;e.forceRenderStateInit=!0,e.disableRenderBreaking=!0,this.pickingEffectRendering=!0,this._applyPickingEffect(),this.viewer.modelManager.setFilterApplied(!1),this.pickingEffectRendering=!1,e.forceRenderStateInit=t,e.disableRenderBreaking=!1}setSize(e,t){this.renderer.setSize(e,t)}getSize(){return this.renderer.getSize(this._renderSize)}canceRenderAnimation(){this.incrementRenderHandle>0&&(cancelAnimationFrame(this.incrementRenderHandle),this.incrementRenderHandle=-1,this.rendering=!1)}},function(){function e(e,t){return e.material.priorityOrderId!==t.material.priorityOrderId?(e.material.priorityOrderId||0)-(t.material.priorityOrderId||0):e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?void 0===e.material.priorityOrderId?e.material.id-t.material.id:t.material.id-e.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}r.BatchedRenderer=class{constructor(t,i){this.manager=t,this.viewer=t.viewer,this.composer=null,this.isBatched=!0,this.renderer=new THREE.WebGLRenderer(i),this.renderer.setOpaqueSort(e);var n=this.viewer;if(this.viewportWidth=n.domElement.offsetWidth,this.viewportHeight=n.domElement.offsetHeight,this.depthPass=new r.DepthRenderPass(this.viewer.modelManager),r.GlobalData.EnableShadowMap){this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0,this.viewer.getScene().lightManager.shadowLightNum++}this._renderSize=new THREE.Vector2,this.oit=new r.OIT({renderer:this.renderer,webgl2Support:this.viewer.webgl2Support})}destroy(){this.composer&&(this.composer.destroy(),this.composer=null),this.oit&&(this.oit.destroy(),this.oit=void 0),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.depthPass.destroy(),this.depthPass=null,this._renderSize=null,this.viewer=null,this.manager=null,this.lastCamera&&(this.lastCamera.destroy&&this.lastCamera.destroy(),this.lastCamera=null)}_createComposer(){this.oldAutoClear=this.renderer.autoClear;var e=this.viewer;this.renderer.shadowMap.enabled=!0,this.composer=new r.RenderEffectComposer(this.renderer),this.composer.init(e,this.viewportWidth,this.viewportHeight)}_checkPostProcess(){return r.GlobalData.EnableSnowPass||r.GlobalData.EnableFogPass||r.GlobalData.EnableRainPass||r.GlobalData.EnableSkylinePass||r.GlobalData.ScanRingCount>0||r.GlobalData.FanScanCount>0||r.GlobalData.EnableGlow&&r.GlobalData.GlowCount>0||r.GlobalData.EnableGlow&&r.GlobalData.HighLightOutlineCount>0||r.GlobalData.BloomCount>0||r.GlobalData.SSAO||r.GlobalData.GTAO||r.GlobalData.SSR}_render(e){var t=this.viewer,i=t.getScene();if(!this.manager.prepareRender())return;var n=this,a=t.camera,s=t.modelManager,o=this.renderer,l=this.manager;this._isNonInteracting();var d=t.getInteractionScene();function h(){var e;t.globalRendering?function(){var e=i.getObjectGroup(r.ObjectGroupType.GLOBALEARTH);if(e&&e.visible){for(var t=i.getObjectGroups(),n=0;n<t.length;n++){var s=t[n];s.preVisible=s.visible,s.visible=!1}e.visible=!0,o.shadowMap.needsUpdate=!1,o.render(i,a)}}():(r.ContactShadow.getInstance()&&r.ContactShadow.getInstance().render(o,i,a),t.clipCapsManager&&t.clipCapsManager.render(o),t.growthAnimationManager&&t.growthAnimationManager.needsUpdate()&&t.growthAnimationManager._update(),t.treeAnimationManager&&t.treeAnimationManager.update(),r.ClipRegionManager.update(t),r.GroundDrawingManager.getInstance().update(o,a),null!=t.scissorViewportManager&&t.scissorViewportManager.isEmbeddedView()?t.scissorViewportManager.setViewRegionRender(o,i,a):(r.GroundPrimitiveManager.getInstance().setGroundCurve(!1),l.useOIT()?n.oit.render(i,a,t.modelManager):r.GlobalData.GTAO?n.renderGTAO(o,t,i,a):o.render(i,a),r.GroundPrimitiveManager.getInstance().setGroundCurve(!0)),i.background=null,r.GroundPrimitiveManager.getInstance().render(o,a),e=o.autoClear,o.autoClear=!1,o.render(d,a),o.autoClear=e)}function c(){var e=o.autoClear;const l=a.near,d=a.far,c=r.ExtrudeBodyManager.getInstance(t)._getNodeGroupVisible();i.fillClipPlane&&i.fillClipPlane.updateCamera(t),t.getIBLManager().renderWithOrthCamera(t,o),r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(!1),h(),o.autoClear=e,r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(c),r.ExtrudeBodyManager.getInstance(t).applyFrontEffect(o,i,a),n._applyPickingEffect(),a.setNearFar(l,d),t.cameraControl.updateCamera(),s.setFilterApplied(!1)}!function(){let e=t.camera.lastDirty;s.prepareScene(a,(function(){s.setRenderStateChanged(!0),t.render()})),i.updateLights(a,t),s.blinkManager.getBlinkEnabled()&&s.blinkManager.updateBlinkMaterial(),t.onCallbacks(r.EnumRenderCallbackType.PRE_RENDER),t.terrainOperationManager.render(o),t.holesManager.render(o),t.heightLimitManager&&t.heightLimitManager.render(o),t.refleRefraManager&&t.refleRefraManager.render(o),n._checkPostProcess()?(null==n.composer&&n._createComposer(),n.composer.updateEnabled(),n.composer.conventionFn=function(){i.updateLights(a,t),c(),s.disposeBufferAfterVbo()},n.composer.checkRender()):(null!=n.composer&&(n.renderer.autoClear=n.oldAutoClear,n.composer.destroy(),n.composer=null),c()),t.onRenderCallback(),t.onRenderFinishedCallback(),(t.cameraControl.isCameraChanging()||e)&&s.dispatchEvent({type:r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED}),t.cameraControl.setCameraChanging(!1),n.composer||s.disposeBufferAfterVbo()}()}render(e){this.adjustNearFar(),this._render(e)}renderDepth(e,t,i,r){this.depthPass.renderDepth(e,t,i,r)}renderCustomDepth(e,t,i,r,n,a){this.depthPass.renderCustomDepth(e,t,i,r,n,a)}renderCustomDepthByOpacity(e,t,i,r,n,a){this.depthPass.renderCustomDepthByOpacity(e,t,i,r,n,a)}renderCustomDepthWithoutDEM(e,t,i,r,n){this.depthPass.renderCustomDepthWithoutDEM(e,t,i,r,n)}renderCustomDepthByVisibleModels(e,t,i,r,n,a){this.depthPass.renderCustomDepthByVisibleModels(e,t,i,r,n,a)}setSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(this.viewportWidth,this.viewportHeight),this.manager.useOIT()&&this.oit.setSize(this.viewportWidth,this.viewportHeight),this.composer&&this.composer.setSize(this.viewportWidth,this.viewportHeight)}getSize(){return this.renderer.getSize(this._renderSize)}_applyPickingEffect(){var e=this.manager.getPickingEffecter();if(!e)return;const t=this.viewer.getFilter().isVisibleStateChanged();e.apply(t),this.viewer.getFilter().disableVisibleStateChanged(),this.viewer.getFilter().disableColorStateChanged()}forceRenderOneFrame(){const e=this.viewer,t=e.camera,i=e.modelManager.getScene();this.renderer.render(i,t,null,!0)}adjustNearFar(){const e=this.viewer;e.getModelManager().calculateCameraModelRelation(e.camera.position),e.camera.lastDirty=e.camera.dirty,e.calculateNearFar(),e.cameraControl.updateCamera()}_isNonInteracting(){return this.viewer.editorManager.isUpdateRenderList}_isCameraChanged(){const e=this.viewer.camera;let t=this.lastCamera;return this.onlyFrustumChanged=!1,void 0===t?(this.lastCamera=e.clone(),!0):!r.CameraUtil.equalsCamera(e,t)&&(r.CameraUtil.onlyFrustumChanged(e,t)&&!this._checkPostProcess()&&(this.onlyFrustumChanged=!0),t.copy(e),!0)}renderGTAO(e,t,i,r){const n=i.renderTransparentObjectsSkipped;i.renderTransparentObjectsSkipped=!0,this._renderGTAO(e,t,i,r);const a=i.renderOpaqueObjectsSkipped;i.renderOpaqueObjectsSkipped=!0,i.renderTransparentObjectsSkipped=!1,this._renderGTAO(e,t,i,r),i.renderTransparentObjectsSkipped=n,i.renderOpaqueObjectsSkipped=a}_renderGTAO(e,t,i,n){const a=t.modelManager;let s=new Map;const o=i.getExternalCompObjectGroups();o.forEach((e=>{e.name.indexOf("Heatmap")>-1||(s.set(e.name,e.visible),e.visible=!1)}));let l=!1;const d=i.getObjectGroup(r.GlobalData.TilePlaneGroupName);d&&(l=d.visible);let h=!1;const c=i.clipPlanes;c&&(h=c.visible,c.visible=!1);let u=!1;const p=i.fillClipPlane;p&&(u=p.visible,p.visible=!1);let m=!1;const f=i.getObjectGroup(r.ObjectGroupType.RECEIVESHADOWPLANE);f&&(m=f.visible,f.visible=!1);const g=r.ExtrudeBodyManager.getInstance(t)._getNodeGroupVisible();r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(!1);const[v,y]=a.classifyGISModels();let M={};v.forEach((e=>{M[e.id]=e.getObjectGroup().visible,e.getObjectGroup().visible=!1})),e.render(i,n),o.forEach((e=>{s.has(e.name)&&(e.visible=s.get(e.name))})),r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(g),v.forEach((e=>{e.getObjectGroup().visible=M[e.id]})),y.forEach((e=>{M[e.id]=e.getObjectGroup().visible,e.getObjectGroup().visible=!1})),c&&(c.visible=h),p&&(p.visible=u),f&&(f.visible=m);const E=i.fog.postProcessSSAOMap,x=i.fog.postProcessSSRMap;i.fog.setPostProcessSSAOMap(null),i.fog.setPostProcessSSRMap(null),e.render(i,n),y.forEach((e=>{e.getObjectGroup().visible=M[e.id]})),i.fog.setPostProcessSSAOMap(E),i.fog.setPostProcessSSRMap(x)}forceUpdateGTAOPass(){this.composer&&r.GlobalData.GTAO&&this.composer.ssaoPass.updateRenderState()}}}(),function(){class e extends r.BatchedRenderer{constructor(e,t){super(e,t),this.fps=t.fps||0,this._running=!1,this._paused=!1,this._destroyed=!1,this._showRenderErrors=!0,this._renderRequested=!0,this._frameState=new r.FrameState,this._preRenderLoopType=void 0,this._renderLoopHandel=null,this._firstRender=!0,this._currentRenderLoop=void 0,this._enableFrameCount=!1,this._currentFrameCameraChanged=!1,this._timeHandle=null}destroy(){this._destroyed=!0,this._frameState=this._frameState.destroy(),this._performanceStats&&(this._performanceStats.destroy(),this._performanceStats=void 0),this._currentRenderLoop=void 0,this.stop(),this._clearRequestScheduler(),this.viewer.isMeshCreateLimitEnabled()&&r.Workers.LimitedMeshCreator.clear(),super.destroy()}_batchModelRenderLop(){this._beginPerformanceStats(),this.viewer.editorManager.update();this._shouldRender()&&(this._renderRequested=!1,this.viewer.editorManager.onRender(),this.adjustNearFar(),this._render(!0)),this._endPerformanceStats()}_oocRenderLoop(){this._beginPerformanceStats(),this.viewer.editorManager.update();const e=new Date,t=this._frameState;this.updateFrameState(t);const i=this._shouldRender();if(i){this._renderRequested=!1;const i=r.Math.incrementWrap(t.frameNumber,15e6,1);this.updateFrameNumber(i,e),t.newFrame=!0}this.preUpdate(t),i&&this.update(t),this.postUpdate(t),this._callForAfterRender(),this._endPerformanceStats()}render(e){this.requestRender(),this._checkIfForceRender()&&this._currentRenderLoop&&(this._currentRenderLoop(),this.viewer.cameraControl.dirtyCamera(!0))}preUpdate(e){r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_PRE_UPDATE,params:{}});var t=this.viewer.getModelManager();t.traverseValidModels((function(t){t.preUpdate(e)})),t.tilesCacheScheduler.resetTilesCache(e)}update(e){const t=this.viewer.getModelManager();t.tilesCacheScheduler.clearStatistics(),this.viewer.editorManager.onRender(),this.adjustNearFar(),t.calculateModelRequestSequencesByCameraDistance(e),t.traverseValidModels((function(t){t.update(e)})),this.viewer.isEnableSchedulingSort()&&t.tilesCacheScheduler.partialSort(),this.createPotentiallyVisibleSet(),this._render()}postUpdate(e){r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_POST_UPDATE,params:{}});var t=this.viewer.getModelManager();t.traverseValidModels((function(t){t.postUpdate(e)})),t.fireTilesLoadEvent(e),t.tilesCacheScheduler.update(),this._updateRequestScheduler(),this.viewer.isMeshCreateLimitEnabled()&&r.Workers.LimitedMeshCreator.update()}createPotentiallyVisibleSet(){}updateFrameNumber(e,t){var i=this._frameState;i.frameNumber=e,i.time=t}updateFrameState(){const e=this.viewer,t=this._frameState;t.globalMatrixUpdated=!1,void 0!==t.globalMatrix&&t.globalMatrix.equals(e.getScene().getRawMatrixGlobal())||(t.globalMatrixUpdated=!0,void 0===t.globalMatrix?t.globalMatrix=e.getScene().getRawMatrixGlobal().clone():t.globalMatrix.copy(e.getScene().getRawMatrixGlobal())),t.newFrame=!1,t.globalInverseMatrix=e.getScene().getInverseMatrixGlobal(),t.camera=e.camera,t.cameraPositionWc.copy(t.camera.position).applyMatrix4(t.globalInverseMatrix),t.camera.direction(t.cameraDirectionWc),t.cameraDirectionWc.transformDirection(t.globalInverseMatrix),t.frustum=t.camera.getFrustum(),t.frustumWc=r.Math.transformFrustum(t.frustum,t.globalInverseMatrix,t.frustumWc),t.cameraPreSSE=e.domElement.offsetHeight/t.camera.frustumHeightFactor,t.viewer=this.viewer}_callForAfterRender(){for(var e=this._frameState.afterRenderFns,t=0,i=e.length;t<i;++t)e[t](),this.requestRender();e.length=0}requestRender(){this._renderRequested=!0}get frameState(){return this._frameState}start(e){if(!this._running){this._running=!0,this._paused=!1;var t=this,i=0;this._renderLoopHandel=requestAnimationFrame((function r(n){if(!t.isDestroyed()&&(t._running||t._paused))try{var a=t.fps;if(a>0){var s=1e3/a,o=n-i;o>s&&(t.resize(),t._running&&!t._paused&&e.call(t),i=n-o%s),t._renderLoopHandel=requestAnimationFrame(r)}else t.resize(),t._running&&!t._paused&&e.call(t),t._renderLoopHandel=requestAnimationFrame(r)}catch(e){t._running=!1,t._showRenderErrors&&(console.error("An error occurred while rendering. Rendering has stopped."),console.error(e))}}))}}pause(e){this._paused=e}stop(){this._running&&(this._running=!1,this._paused=!1),r.Utils.isDefined(this._renderLoopHandel)&&cancelAnimationFrame(this._renderLoopHandel)}get currentFrameCameraChanged(){return this._currentFrameCameraChanged}set currentFrameCameraChanged(e){this._currentFrameCameraChanged=e}_shouldRender(){const e=this._isCameraChanged();return(e||!0===this.currentFrameCameraChanged)&&(this.currentFrameCameraChanged=!1,this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_CHANGED,camera:this.viewer.camera,onlyFrustumChanged:this.onlyFrustumChanged}),r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._timeHandle=setTimeout((()=>{this.viewer&&this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_CHANGED_END,onlyFrustumChanged:this.onlyFrustumChanged})}),r.GlobalData.InputDelayTimeInterval)),this._renderRequested||e||this.viewer.cameraControl.isCameraChanging()||this.viewer.getModelManager().isSceneChanged()||this.viewer.getModelManager().blinkManager.getBlinkEnabled()||this.viewer.inputStatusMonitor.forceShouldRender()||this.viewer.treeAnimationManager&&this.viewer.treeAnimationManager.isEnable()||this.viewer.growthAnimationManager&&this.viewer.growthAnimationManager.needsUpdate()}resize(){}isDestroyed(){return this._destroyed}setRenderLoop(e){e!==this._preRenderLoopType&&(this._preRenderLoopType=e,this.stop(),this.requestRender(!0),this._currentRenderLoop=e?this._oocRenderLoop:this._batchModelRenderLop,this.start(this._currentRenderLoop))}_checkIfForceRender(){const e=this._firstRender&&this.viewer.getModelManager().hasLoadedModel();return e&&(this._firstRender=!1),e}_clearRequestScheduler(){r.RequestScheduler.clear(),r.GlobeTileRequestScheduler.clear()}_updateRequestScheduler(){r.RequestScheduler.update(),r.GlobeTileRequestScheduler.update()}enableRecordFPS(e){this._enableFrameCount=r.Utils.defaultValue(e,!1),this._enableFrameCount?(this._performanceStats||(this._performanceStats=new r.FpsStats),this._performanceStats.enable()):this._performanceStats&&this._performanceStats.disable()}_beginPerformanceStats(){const e=this._performanceStats;e&&e.isEnabled()&&e.begin()}_endPerformanceStats(){const e=this._performanceStats;e&&e.isEnabled()&&e.end()}getFPS(){const e=this._performanceStats;return e&&e.isEnabled()?e.getFPS():{}}}r.OoCRenderer=e}(),r.RenderGroup=function(){var e=[],t=[],i=-1,n=-1,a=0,s=!1,o=!1,l=0,d=0;function h(e,t){return e.material.id!==t.material.id?e.material.id-t.material.id:e.id-t.id}function c(e,t){return e.z!==t.z?t.z-e.z:e.id-t.id}function u(e,t,i,n,s,o,h){l=Date.now();for(var c=t.length,u=a;u<c;u++){var p=t[u],m=p.object,f=p.material,g=p.group,v=p.geometry;if(m.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,m.matrixWorld),m.normalMatrix.getNormalMatrix(m.modelViewMatrix),v=e.updateObject(m),e.renderBufferDirect(i,s,v,f,m,g),!h&&(d=Date.now(),d-l>r.GlobalData.LimitFrameTime))return a=u+1,!1}return a=0,!0}this.getOpaqueObjects=function(){return e},this.getTransparentObjects=function(){return t},this.destroy=function(){e=[],t=[]},this.restart=function(){a=0,s=!1,o=!1},this.prepare=function(){this.restart(),i=-1,n=-1},this.renderableCount=function(){return i+n},this.pushRenderItem=function(r,a,s,o,l){var d,h;s.transparent?(d=t,h=++n):(d=e,h=++i);var c=d[h];void 0!==c?(c.id=r.id,c.object=r,c.geometry=a,c.material=s,c.z=o,c.group=l||null):(c={id:r.id,object:r,geometry:a,material:s,z:o,group:l||null},d[h]=c)},this.sortRenderList=function(r){e.length=i+1,t.length=n+1,r&&(e.sort(h),t.sort(c))},this.renderOpaqueObjects=function(t,i,r,n,a,o){return s||(s=u(t,e,i,0,n,0,o)),s},this.renderTransparentObjects=function(e,i,r,n,a,s){return o||(o=u(e,t,i,0,n,0,s)),o}},r.OrderedRenderer=function(){var e=0,t=!1,i=!1,n=0,a=0,s=[],o=null,l=null,d=new THREE.Vector3,h=!0,c=!0;this.updateObjectList=function(e){h=e};var u=!1;function p(e,t,i,n,a){var o=s[e.renderOrder];void 0===o&&(o=new r.RenderGroup,s[e.renderOrder]=o),o.pushRenderItem(e,t,i,n,a)}function m(t,i){if(!1===t.visible)return!0;if(t._cullTicket!=e){if(!u)if(Date.now()-n>30)return!1;if(t._cullTicket=e,(t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.update(),!1===t.frustumCulled||!0===o.intersectsObject(t))){var r=t.material,a=t.geometry;if(d.setFromMatrixPosition(t.matrixWorld),d.applyMatrix4(l),Array.isArray(r))for(var s=a.groups,h=0,c=s.length;h<c;h++){var f=s[h],g=r[f.materialIndex];g.transparent?p(t,a,g,d.z,f):p(t,a,g,0,f)}else r.transparent?p(t,a,r,d.z):p(t,a,r,0)}}var v=t.children;if(v)for(h=0,c=v.length;h<c;h++)if(!m(v[h],i))return!1;return!0}this.setNonBreakingRender=function(e){u=e},this.destroy=function(){for(var e=0,t=s.length;e<t;++e){var i=s[e];void 0!==i&&i.destroy()}},this.restart=function(){for(var e=0,i=s.length;e<i;++e){var r=s[e];void 0!==r&&r.restart()}c=!0,t=!0},this.setFilter=function(e){},this.projectLights=function(e,t){t.length=0,e.traverseVisible((function(e){e.isLight&&t.push(e)}))};var f=this;function g(i,r,a){h?(t&&(!function(){++e>1e5&&(e=0);for(var t=0,i=s.length;t<i;++t){var r=s[t];void 0!==r&&r.prepare()}}(),f.projectLights(i,a)),n=Date.now(),t=m(i,r),function(){for(var e=0,i=s.length;e<i;++e){var r=s[e];void 0!==r&&r.sortRenderList(t)}}()):t=!0}this.update=function(e,t){l=t,o=e},this.render=function(e,n,o,l,d,p,m){if(h&&!c||++a,a>1e4&&(a=0),c){if(r.Logger.time("build object list"),g(n,o,l),r.Logger.timeEnd("build object list"),!t)return!1;p=this.forceClear||e.autoClear,c=!1,this.forceClear=!1,e.setupLights(l,o),e.setRenderTarget(d)}r.Logger.time("increment render object"),(e.autoClear||p)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil,h);var f=n.fog;e.setRenderTicket(a),m.setBlending(THREE.NoBlending);for(var v=s.length-1;v>=0;--v){if(void 0!==(y=s[v])&&!(i=y.renderOpaqueObjects(e,o,l,f,h,u)))break}if(i)for(v=s.length-1;v>=0;--v){var y;if(void 0!==(y=s[v])&&!(i=y.renderTransparentObjects(e,o,l,f,void 0,u)))break}return 0==s.length&&(i=!0),m.buffers.depth.setTest(!0),m.buffers.depth.setMask(!0),m.buffers.color.setMask(!0),r.Logger.timeEnd("increment render object"),i}},r.RendererManager=class{constructor(e){this.viewer=e,this.renderer=null,this.pickingEffecter=null,this._renderSize={x:0,y:0},this._useOIT=!1}destroy(){this.renderer&&(this.renderer.destroy(),this.renderer=null),this.pickingEffecter&&(this.pickingEffecter.destroy(),this.pickingEffecter=null),this._renderSize=null,this.viewer=null}setupRenderer(e){if(!this.renderer){var t=this.viewer;r.GlobalData.BatchMergeEnabled?(console.log("renderer: BatchedRenderer"),this.renderer=new r.OoCRenderer(this,e)):(t.modelManager.blinkManager.permitBlink(!0),r.GlobalData.InstanceSharedMeshEnabled=!1,console.log("renderer: IncrementedRenderer"),this.renderer=new r.IncrementedRenderer(this,e)),this._initRenderer()}}prepareRender(){var e=this.renderer;if(!e)return!1;var t=this.viewer,i=t.modelManager;if(!i.isDrawable())return!1;if(!i.hasModel())return r.Logger.log("model not loaded!"),e.forceRenderOneFrame(),!1;if(r.GlobalData.IBL&&0==t.getIBLManager().textureLoad)return!1;if(t.globalRendering){if(!t.globeEarth)return!1;if(!t.globeEarth.modelLoaded)return!1}return!i.checkLayerDataLoading()&&(t.getScene().fillClipPlane&&r.GlobalData.ClippingCaps&&r.GlobalData.BatchMergeEnabled&&t.setRenderStateChanged(!0),!0)}render(e){this.renderer&&this.renderer.render(e)}getRenderer(){if(this.renderer)return this.renderer.renderer}setSize(e,t){this.renderer&&this.renderer.setSize(e,t)}getRendererSize(){if(this.renderer){const e=this.renderer.getSize();this._renderSize.width=e.x,this._renderSize.height=e.y}else this._renderSize.width=0,this._renderSize.height=0;return this._renderSize}getPickingEffecter(){return r.GlobalData.PickingEffect?(this.pickingEffecter||(this.pickingEffecter=new r.PickingEffecter(this.viewer)),this.pickingEffecter):null}_initRenderer(){var e=this.viewer,t=e.domElement,i=t.offsetWidth,n=t.offsetHeight,a=this.renderer.renderer;a.setClearColor(0,0),a.setPixelRatio(window.devicePixelRatio||1),a.setSize(i,n),a.toneMapping=r.GlobalData.ToneMapping,a.gammaFactor=2.2,a.outputEncoding=THREE.sRGBEncoding,a.domElement.setAttribute("tabindex","0"),a.domElement.setAttribute("id","cloud-main-canvas"),e.domElement.appendChild(a.domElement)}enableVR(e){this.renderer.renderer.xr.enabled=e}enableOIT(e){this._useOIT=e}useOIT(){return this._useOIT}_isSupportOIT(){return this._useOIT&&this.renderer&&this.renderer.oit}setOITAntialiasMode(e){this._isSupportOIT()&&this.renderer.oit.setAntialiasMode(e)}forceRenderClearScreen(){const e=this.getRenderer();e&&(e.clear(!0,!0,!0),this.renderer.canceRenderAnimation&&this.renderer.canceRenderAnimation())}},THREE.SimplexNoise=function(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]},THREE.SimplexNoise.prototype.dot=function(e,t,i){return e[0]*t+e[1]*i},THREE.SimplexNoise.prototype.dot3=function(e,t,i,r){return e[0]*t+e[1]*i+e[2]*r},THREE.SimplexNoise.prototype.dot4=function(e,t,i,r,n){return e[0]*t+e[1]*i+e[2]*r+e[3]*n},THREE.SimplexNoise.prototype.noise=function(e,t){var i,r,n=(e+t)*(.5*(Math.sqrt(3)-1)),a=Math.floor(e+n),s=Math.floor(t+n),o=(3-Math.sqrt(3))/6,l=(a+s)*o,d=e-(a-l),h=t-(s-l);d>h?(i=1,r=0):(i=0,r=1);var c=d-i+o,u=h-r+o,p=d-1+2*o,m=h-1+2*o,f=255&a,g=255&s,v=this.perm[f+this.perm[g]]%12,y=this.perm[f+i+this.perm[g+r]]%12,M=this.perm[f+1+this.perm[g+1]]%12,E=.5-d*d-h*h,x=.5-c*c-u*u,_=.5-p*p-m*m;return 70*((E<0?0:(E*=E)*E*this.dot(this.grad3[v],d,h))+(x<0?0:(x*=x)*x*this.dot(this.grad3[y],c,u))+(_<0?0:(_*=_)*_*this.dot(this.grad3[M],p,m)))},THREE.SimplexNoise.prototype.noise3d=function(e,t,i){var r,n,a,s,o,l,d=(e+t+i)*(1/3),h=Math.floor(e+d),c=Math.floor(t+d),u=Math.floor(i+d),p=1/6,m=(h+c+u)*p,f=e-(h-m),g=t-(c-m),v=i-(u-m);f>=g?g>=v?(r=1,n=0,a=0,s=1,o=1,l=0):f>=v?(r=1,n=0,a=0,s=1,o=0,l=1):(r=0,n=0,a=1,s=1,o=0,l=1):g<v?(r=0,n=0,a=1,s=0,o=1,l=1):f<v?(r=0,n=1,a=0,s=0,o=1,l=1):(r=0,n=1,a=0,s=1,o=1,l=0);var y=f-r+p,M=g-n+p,E=v-a+p,x=f-s+2*p,_=g-o+2*p,b=v-l+2*p,I=f-1+.5,T=g-1+.5,S=v-1+.5,C=255&h,w=255&c,R=255&u,B=this.perm[C+this.perm[w+this.perm[R]]]%12,A=this.perm[C+r+this.perm[w+n+this.perm[R+a]]]%12,P=this.perm[C+s+this.perm[w+o+this.perm[R+l]]]%12,L=this.perm[C+1+this.perm[w+1+this.perm[R+1]]]%12,O=.6-f*f-g*g-v*v,D=.6-y*y-M*M-E*E,N=.6-x*x-_*_-b*b,H=.6-I*I-T*T-S*S;return 32*((O<0?0:(O*=O)*O*this.dot3(this.grad3[B],f,g,v))+(D<0?0:(D*=D)*D*this.dot3(this.grad3[A],y,M,E))+(N<0?0:(N*=N)*N*this.dot3(this.grad3[P],x,_,b))+(H<0?0:(H*=H)*H*this.dot3(this.grad3[L],I,T,S)))},THREE.SimplexNoise.prototype.noise4d=function(e,t,i,r){var n,a,s,o,l,d,h,c,u,p,m,f,g=this.grad4,v=this.simplex,y=this.perm,M=(Math.sqrt(5)-1)/4,E=(5-Math.sqrt(5))/20,x=(e+t+i+r)*M,_=Math.floor(e+x),b=Math.floor(t+x),I=Math.floor(i+x),T=Math.floor(r+x),S=(_+b+I+T)*E,C=e-(_-S),w=t-(b-S),R=i-(I-S),B=r-(T-S),A=(C>w?32:0)+(C>R?16:0)+(w>R?8:0)+(C>B?4:0)+(w>B?2:0)+(R>B?1:0),P=C-(n=v[A][0]>=3?1:0)+E,L=w-(a=v[A][1]>=3?1:0)+E,O=R-(s=v[A][2]>=3?1:0)+E,D=B-(o=v[A][3]>=3?1:0)+E,N=C-(l=v[A][0]>=2?1:0)+2*E,H=w-(d=v[A][1]>=2?1:0)+2*E,U=R-(h=v[A][2]>=2?1:0)+2*E,F=B-(c=v[A][3]>=2?1:0)+2*E,k=C-(u=v[A][0]>=1?1:0)+3*E,G=w-(p=v[A][1]>=1?1:0)+3*E,V=R-(m=v[A][2]>=1?1:0)+3*E,z=B-(f=v[A][3]>=1?1:0)+3*E,j=C-1+4*E,W=w-1+4*E,q=R-1+4*E,X=B-1+4*E,Y=255&_,K=255&b,Z=255&I,Q=255&T,J=y[Y+y[K+y[Z+y[Q]]]]%32,$=y[Y+n+y[K+a+y[Z+s+y[Q+o]]]]%32,ee=y[Y+l+y[K+d+y[Z+h+y[Q+c]]]]%32,te=y[Y+u+y[K+p+y[Z+m+y[Q+f]]]]%32,ie=y[Y+1+y[K+1+y[Z+1+y[Q+1]]]]%32,re=.6-C*C-w*w-R*R-B*B,ne=.6-P*P-L*L-O*O-D*D,ae=.6-N*N-H*H-U*U-F*F,se=.6-k*k-G*G-V*V-z*z,oe=.6-j*j-W*W-q*q-X*X;return 27*((re<0?0:(re*=re)*re*this.dot4(g[J],C,w,R,B))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[$],P,L,O,D))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[ee],N,H,U,F))+(se<0?0:(se*=se)*se*this.dot4(g[te],k,G,V,z))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[ie],j,W,q,X)))},function(){let e=new THREE.OrthographicCamera(-1,1,1,-1,0,1),t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),t.setAttribute("uv",new THREE.Float32BufferAttribute([0,2,0,0,2,0],2));let i=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1};Object.assign(i.prototype,{setSize:function(e,t){},render:function(e,t,i,r,n){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),i.FullScreenQuad=class{constructor(e){this._mesh=new THREE.Mesh(t,e)}dispose(){this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material&&(this._mesh.material.dispose(),this._mesh.material=null),this._mesh=null}render(t){t.render(this._mesh,e)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}getCamera(){return e}},THREE.Pass=i,a.Pass=i}(),function(){class e extends a.Pass{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new a.Pass.FullScreenQuad(this.material)}dispose(){this.fsQuad.dispose(),this.fsQuad=null,this.material.dispose(),this.material=null,this.uniforms=null}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}}a.ShaderPass=e}(),function(){class e extends THREE.Pass{constructor(e,t){super(),this.textureID="tDiffuse";const i=THREE.FXAAShader;this.uniforms=THREE.UniformsUtils.clone(i.uniforms),this.material=new THREE.ShaderMaterial({defines:Object.assign({},i.defines),uniforms:this.uniforms,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader}),this.material.uniforms.resolution.value.x=1/e,this.material.uniforms.resolution.value.y=1/t,this.needsSwap=!1,this.fsQuad=new THREE.Pass.FullScreenQuad(this.material)}dispose(){this.fsQuad.dispose(),this.fsQuad=null,this.material.dispose(),this.material=null,this.uniforms=null}setSize(e,t){this.material.uniforms.resolution.value.set(1/e,1/t)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}}a.FXAAPass=e}(),(w=function(e,t){THREE.Pass.call(this),this.edgesRT=new THREE.WebGLRenderTarget(e,t,{depthBuffer:!1,generateMipmaps:!1,minFilter:THREE.LinearFilter,format:THREE.RGBFormat}),this.edgesRT.texture.name="SMAAPass.edges",this.weightsRT=new THREE.WebGLRenderTarget(e,t,{depthBuffer:!1,generateMipmaps:!1,minFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.weightsRT.texture.name="SMAAPass.weights";var i=this,r=new Image;r.src=this.getAreaTexture(),r.onload=function(){i.areaTexture.needsUpdate=!0},this.areaTexture=new THREE.Texture,this.areaTexture.name="SMAAPass.area",this.areaTexture.image=r,this.areaTexture.format=THREE.RGBFormat,this.areaTexture.minFilter=THREE.LinearFilter,this.areaTexture.generateMipmaps=!1,this.areaTexture.flipY=!1;var n=new Image;n.src=this.getSearchTexture(),n.onload=function(){i.searchTexture.needsUpdate=!0},this.searchTexture=new THREE.Texture,this.searchTexture.name="SMAAPass.search",this.searchTexture.image=n,this.searchTexture.magFilter=THREE.NearestFilter,this.searchTexture.minFilter=THREE.NearestFilter,this.searchTexture.generateMipmaps=!1,this.searchTexture.flipY=!1,void 0===THREE.SMAAEdgesShader&&console.error("THREE.SMAAPass relies on SMAAShader"),this.uniformsEdges=THREE.UniformsUtils.clone(THREE.SMAAEdgesShader.uniforms),this.uniformsEdges.resolution.value.set(1/e,1/t),this.materialEdges=new THREE.ShaderMaterial({defines:Object.assign({},THREE.SMAAEdgesShader.defines),uniforms:this.uniformsEdges,vertexShader:THREE.SMAAEdgesShader.vertexShader,fragmentShader:THREE.SMAAEdgesShader.fragmentShader}),this.uniformsWeights=THREE.UniformsUtils.clone(THREE.SMAAWeightsShader.uniforms),this.uniformsWeights.resolution.value.set(1/e,1/t),this.uniformsWeights.tDiffuse.value=this.edgesRT.texture,this.uniformsWeights.tArea.value=this.areaTexture,this.uniformsWeights.tSearch.value=this.searchTexture,this.materialWeights=new THREE.ShaderMaterial({defines:Object.assign({},THREE.SMAAWeightsShader.defines),uniforms:this.uniformsWeights,vertexShader:THREE.SMAAWeightsShader.vertexShader,fragmentShader:THREE.SMAAWeightsShader.fragmentShader}),this.uniformsBlend=THREE.UniformsUtils.clone(THREE.SMAABlendShader.uniforms),this.uniformsBlend.resolution.value.set(1/e,1/t),this.uniformsBlend.tDiffuse.value=this.weightsRT.texture,this.materialBlend=new THREE.ShaderMaterial({uniforms:this.uniformsBlend,vertexShader:THREE.SMAABlendShader.vertexShader,fragmentShader:THREE.SMAABlendShader.fragmentShader}),this.needsSwap=!1,this.fsQuad=new THREE.Pass.FullScreenQuad(null)}).prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:w,dispose:function(){this.edgesRT.dispose(),this.edgesRT=void 0,this.weightsRT.dispose(),this.weightsRT=void 0,this.areaTexture.image=void 0,this.areaTexture=void 0,this.searchTexture.image=void 0,this.searchTexture=void 0,this.uniformsEdges=void 0,this.materialEdges=void 0,this.uniformsWeights=void 0,this.materialWeights=void 0,this.uniformsBlend=void 0,this.materialBlend=void 0,this.fsQuad.dispose(),this.fsQuad=void 0},render:function(e,t,i){this.uniformsEdges.tDiffuse.value=i.texture,this.fsQuad.material=this.materialEdges,e.setRenderTarget(this.edgesRT),this.clear&&e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.materialWeights,e.setRenderTarget(this.weightsRT),this.clear&&e.clear(),this.fsQuad.render(e),this.uniformsBlend.tColor.value=i.texture,this.fsQuad.material=this.materialBlend,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))},setSize:function(e,t){this.edgesRT.setSize(e,t),this.weightsRT.setSize(e,t),this.materialEdges.uniforms.resolution.value.set(1/e,1/t),this.materialWeights.uniforms.resolution.value.set(1/e,1/t),this.materialBlend.uniforms.resolution.value.set(1/e,1/t)},getAreaTexture:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAIAAACOVPcQAACBeklEQVR42u39W4xlWXrnh/3WWvuciIzMrKxrV8/0rWbY0+SQFKcb4owIkSIFCjY9AC1BT/LYBozRi+EX+cV+8IMsYAaCwRcBwjzMiw2jAWtgwC8WR5Q8mDFHZLNHTarZGrLJJllt1W2qKrsumZWZcTvn7L3W54e1vrXX3vuciLPPORFR1XE2EomorB0nVuz//r71re/y/1eMvb4Cb3N11xV/PP/2v4UBAwJG/7H8urx6/25/Gf8O5hypMQ0EEEQwAqLfoN/Z+97f/SW+/NvcgQk4sGBJK6H7N4PFVL+K+e0N11yNfkKvwUdwdlUAXPHHL38oa15f/i/46Ih6SuMSPmLAYAwyRKn7dfMGH97jaMFBYCJUgotIC2YAdu+LyW9vvubxAP8kAL8H/koAuOKP3+q6+xGnd5kdYCeECnGIJViwGJMAkQKfDvB3WZxjLKGh8VSCCzhwEWBpMc5/kBbjawT4HnwJfhr+pPBIu7uu+OOTo9vsmtQcniMBGkKFd4jDWMSCRUpLjJYNJkM+IRzQ+PQvIeAMTrBS2LEiaiR9b/5PuT6Ap/AcfAFO4Y3dA3DFH7/VS+M8k4baEAQfMI4QfbVDDGIRg7GKaIY52qAjTAgTvGBAPGIIghOCYAUrGFNgzA7Q3QhgCwfwAnwe5vDejgG44o/fbm1C5ZlYQvQDARPAIQGxCWBM+wWl37ZQESb4gImexGMDouhGLx1Cst0Saa4b4AqO4Hk4gxo+3DHAV/nx27p3JziPM2pVgoiia5MdEzCGULprIN7gEEeQ5IQxEBBBQnxhsDb5auGmAAYcHMA9eAAz8PBol8/xij9+C4Djlim4gJjWcwZBhCBgMIIYxGAVIkH3ZtcBuLdtRFMWsPGoY9rN+HoBji9VBYdwD2ZQg4cnO7OSq/z4rU5KKdwVbFAjNojCQzTlCLPFSxtamwh2jMUcEgg2Wm/6XgErIBhBckQtGN3CzbVacERgCnfgLswhnvqf7QyAq/z4rRZm1YglYE3affGITaZsdIe2FmMIpnOCap25I6jt2kCwCW0D1uAD9sZctNGXcQIHCkINDQgc78aCr+zjtw3BU/ijdpw3zhCwcaONwBvdeS2YZKkJNJsMPf2JKEvC28RXxxI0ASJyzQCjCEQrO4Q7sFArEzjZhaFc4cdv+/JFdKULM4px0DfUBI2hIsy06BqLhGTQEVdbfAIZXYMPesq6VoCHICzUyjwInO4Y411//LYLs6TDa9wvg2CC2rElgAnpTBziThxaL22MYhzfkghz6GAs2VHbbdM91VZu1MEEpupMMwKyVTb5ij9+u4VJG/5EgEMMmFF01cFai3isRbKbzb+YaU/MQbAm2XSMoUPAmvZzbuKYRIFApbtlrfFuUGd6vq2hXNnH78ZLh/iFhsQG3T4D1ib7k5CC6vY0DCbtrohgLEIClXiGtl10zc0CnEGIhhatLBva7NP58Tvw0qE8yWhARLQ8h4+AhQSP+I4F5xoU+VilGRJs6wnS7ruti/4KvAY/CfdgqjsMy4pf8fodQO8/gnuX3f/3xi3om1/h7THr+co3x93PP9+FBUfbNUjcjEmhcrkT+8K7ml7V10Jo05mpIEFy1NmCJWx9SIKKt+EjAL4Ez8EBVOB6havuT/rByPvHXK+9zUcfcbb254+9fydJknYnRr1oGfdaiAgpxu1Rx/Rek8KISftx3L+DfsLWAANn8Hvw0/AFeAGO9DFV3c6D+CcWbL8Dj9e7f+T1k8AZv/d7+PXWM/Z+VvdCrIvuAKO09RpEEQJM0Ci6+B4xhTWr4cZNOvhktabw0ta0rSJmqz3Yw5/AKXwenod7cAhTmBSPKf6JBdvH8IP17h95pXqw50/+BFnj88fev4NchyaK47OPhhtI8RFSvAfDSNh0Ck0p2gLxGkib5NJj/JWCr90EWQJvwBzO4AHcgztwAFN1evHPUVGwfXON+0debT1YeGON9Yy9/63X+OguiwmhIhQhD7l4sMqlG3D86Suc3qWZ4rWjI1X7u0Ytw6x3rIMeIOPDprfe2XzNgyj6PahhBjO4C3e6puDgXrdg+/5l948vF3bqwZetZ+z9Rx9zdIY5pInPK4Nk0t+l52xdK2B45Qd87nM8fsD5EfUhIcJcERw4RdqqH7Yde5V7m1vhNmtedkz6EDzUMF/2jJYWbC+4fzzA/Y+/8PPH3j9dcBAPIRP8JLXd5BpAu03aziOL3VVHZzz3CXWDPWd+SH2AnxIqQoTZpo9Ckc6HIrFbAbzNmlcg8Ag8NFDDAhbJvTBZXbC94P7t68EXfv6o+21gUtPETU7bbkLxvNKRFG2+KXzvtObonPP4rBvsgmaKj404DlshFole1Glfh02fE7bYR7dZ82oTewIBGn1Md6CG6YUF26X376oevOLzx95vhUmgblI6LBZwTCDY7vMq0op5WVXgsObOXJ+1x3qaBl9j1FeLxbhU9w1F+Wiba6s1X/TBz1LnUfuYDi4r2C69f1f14BWfP+p+W2GFKuC9phcELMYRRLur9DEZTUdEH+iEqWdaM7X4WOoPGI+ZYD2+wcQ+y+ioHUZ9dTDbArzxmi/bJI9BND0Ynd6lBdve/butBw8+f/T9D3ABa3AG8W3VPX4hBin+bj8dMMmSpp5pg7fJ6xrBFE2WQQEWnV8Qg3FbAWzYfM1rREEnmvkN2o1+acG2d/9u68GDzx91v3mAjb1zkpqT21OipPKO0b9TO5W0nTdOmAQm0TObts3aBKgwARtoPDiCT0gHgwnbArzxmtcLc08HgF1asN0C4Ms/fvD5I+7PhfqyXE/b7RbbrGyRQRT9ARZcwAUmgdoz0ehJ9Fn7QAhUjhDAQSw0bV3T3WbNa59jzmiP6GsWbGXDX2ytjy8+f9T97fiBPq9YeLdBmyuizZHaqXITnXiMUEEVcJ7K4j3BFPurtB4bixW8wTpweL8DC95szWMOqucFYGsWbGU7p3TxxxefP+r+oTVktxY0v5hbq3KiOKYnY8ddJVSBxuMMVffNbxwIOERShst73HZ78DZrHpmJmH3K6sGz0fe3UUj0eyRrSCGTTc+rjVNoGzNSv05srAxUBh8IhqChiQgVNIIBH3AVPnrsnXQZbLTm8ammv8eVXn/vWpaTem5IXRlt+U/LA21zhSb9cye6jcOfCnOwhIAYXAMVTUNV0QhVha9xjgA27ODJbLbmitt3tRN80lqG6N/khgot4ZVlOyO4WNg3OIMzhIZQpUEHieg2im6F91hB3I2tubql6BYNN9Hj5S7G0G2tahslBWKDnOiIvuAEDzakDQKDNFQT6gbn8E2y4BBubM230YIpBnDbMa+y3dx0n1S0BtuG62lCCXwcY0F72T1VRR3t2ONcsmDjbmzNt9RFs2LO2hQNyb022JisaI8rAWuw4HI3FuAIhZdOGIcdjLJvvObqlpqvWTJnnQbyi/1M9O8UxWhBs//H42I0q1Yb/XPGONzcmm+ri172mHKvZBpHkJaNJz6v9jxqiklDj3U4CA2ugpAaYMWqNXsdXbmJNd9egCnJEsphXNM+MnK3m0FCJ5S1kmJpa3DgPVbnQnPGWIDspW9ozbcO4K/9LkfaQO2KHuqlfFXSbdNzcEcwoqNEFE9zcIXu9/6n/ym/BC/C3aJLzEKPuYVlbFnfhZ8kcWxV3dbv4bKl28566wD+8C53aw49lTABp9PWbsB+knfc/Li3eVizf5vv/xmvnPKg5ihwKEwlrcHqucuVcVOxEv8aH37E3ZqpZypUulrHEtIWKUr+txHg+ojZDGlwnqmkGlzcVi1dLiNSJiHjfbRNOPwKpx9TVdTn3K05DBx4psIk4Ei8aCkJahRgffk4YnEXe07T4H2RR1u27E6wfQsBDofUgjFUFnwC2AiVtA+05J2zpiDK2Oa0c5fmAecN1iJzmpqFZxqYBCYhFTCsUNEmUnIcZ6aEA5rQVhEywG6w7HSW02XfOoBlQmjwulOFQAg66SvJblrTEX1YtJ3uG15T/BH1OfOQeuR8g/c0gdpT5fx2SKbs9EfHTKdM8A1GaJRHLVIwhcGyydZsbifAFVKl5EMKNU2Hryo+06BeTgqnxzYjThVySDikbtJPieco75lYfKAJOMEZBTjoITuWHXXZVhcUDIS2hpiXHV9Ku4u44bN5OYLDOkJo8w+xJSMbhBRHEdEs9JZUCkQrPMAvaHyLkxgkEHxiNkx/x2YB0mGsQ8EUWj/stW5YLhtS5SMu+/YBbNPDCkGTUybN8krRLBGPlZkVOA0j+a1+rkyQKWGaPHPLZOkJhioQYnVZ2hS3zVxMtgC46KuRwbJNd9nV2PHgb36F194ecf/Yeu2vAFe5nm/bRBFrnY4BauE8ERmZRFUn0k8hbftiVYSKMEme2dJCJSCGYAlNqh87bXOPdUkGy24P6d1ll21MBqqx48Fvv8ZHH8HZFY7j/uAq1xMJUFqCSUlJPmNbIiNsmwuMs/q9CMtsZsFO6SprzCS1Z7QL8xCQClEelpjTduDMsmWD8S1PT152BtvmIGvUeDA/yRn83u/x0/4qxoPHjx+PXY9pqX9bgMvh/Nz9kpP4pOe1/fYf3axUiMdHLlPpZCNjgtNFAhcHEDxTumNONhHrBduW+vOyY++70WWnPXj98eA4kOt/mj/5E05l9+O4o8ePx67HFqyC+qSSnyselqjZGaVK2TadbFLPWAQ4NBhHqDCCV7OTpo34AlSSylPtIdd2AJZlyzYQrDJ5lcWGNceD80CunPLGGzsfD+7wRb95NevJI5docQ3tgCyr5bGnyaPRlmwNsFELViOOx9loebGNq2moDOKpHLVP5al2cymWHbkfzGXL7kfRl44H9wZy33tvt+PB/Xnf93e+nh5ZlU18wCiRUa9m7kib9LYuOk+hudQNbxwm0AQqbfloimaB2lM5fChex+ylMwuTbfmXQtmWlenZljbdXTLuOxjI/fDDHY4Hjx8/Hrse0zXfPFxbUN1kKqSCCSk50m0Ajtx3ub9XHBKHXESb8iO6E+qGytF4nO0OG3SXzbJlhxBnKtKyl0NwybjvYCD30aMdjgePHz8eu56SVTBbgxJMliQ3Oauwg0QHxXE2Ez/EIReLdQj42Gzb4CLS0YJD9xUx7bsi0vJi5mUbW1QzL0h0PFk17rtiIPfJk52MB48fPx67npJJwyrBa2RCCQRTbGZSPCxTPOiND4G2pYyOQ4h4jINIJh5wFU1NFZt+IsZ59LSnDqBjZ2awbOku+yInunLcd8VA7rNnOxkPHj9+PGY9B0MWJJNozOJmlglvDMXDEozdhQWbgs/U6oBanGzLrdSNNnZFjOkmbi5bNt1lX7JLLhn3vXAg9/h4y/Hg8ePHI9dzQMEkWCgdRfYykYKnkP7D4rIujsujaKPBsB54vE2TS00ccvFY/Tth7JXeq1hz+qgVy04sAJawTsvOknHfCwdyT062HA8eP348Zj0vdoXF4pilKa2BROed+9fyw9rWRXeTFXESMOanvDZfJuJaSXouQdMdDJZtekZcLLvEeK04d8m474UDuaenW44Hjx8/Xns9YYqZpszGWB3AN/4VHw+k7WSFtJ3Qicuqb/NlVmgXWsxh570xg2UwxUw3WfO6B5nOuO8aA7lnZxuPB48fPx6znm1i4bsfcbaptF3zNT78eFPtwi1OaCNOqp1x3zUGcs/PN++AGD1+fMXrSVm2baTtPhPahbPhA71wIHd2bXzRa69nG+3CraTtPivahV/55tXWg8fyRY/9AdsY8VbSdp8V7cKrrgdfM//z6ILQFtJ2nxHtwmuoB4/kf74+gLeRtvvMaBdeSz34+vifx0YG20jbfTa0C6+tHrwe//NmOG0L8EbSdp8R7cLrrQe/996O+ai3ujQOskpTNULa7jOjXXj99eCd8lHvoFiwsbTdZ0a78PrrwTvlo966pLuRtB2fFe3Cm6oHP9kNH/W2FryxtN1nTLvwRurBO+Kj3pWXHidtx2dFu/Bm68Fb81HvykuPlrb7LGkX3mw9eGs+6h1Y8MbSdjegXcguQLjmevDpTQLMxtJ2N6NdyBZu9AbrwVvwUW+LbteULUpCdqm0HTelXbhNPe8G68Gb8lFvVfYfSNuxvrTdTWoXbozAzdaDZzfkorOj1oxVxlIMlpSIlpLrt8D4hrQL17z+c3h6hU/wv4Q/utps4+bm+6P/hIcf0JwQ5oQGPBL0eKPTYEXTW+eL/2DKn73J9BTXYANG57hz1cEMviVf/4tf5b/6C5pTQkMIWoAq7hTpOJjtAM4pxKu5vg5vXeUrtI09/Mo/5H+4z+Mp5xULh7cEm2QbRP2tFIKR7WM3fPf/jZ3SWCqLM2l4NxID5zB72HQXv3jj/8mLR5xXNA5v8EbFQEz7PpRfl1+MB/hlAN65qgDn3wTgH13hK7T59bmP+NIx1SHHU84nLOITt3iVz8mNO+lPrjGAnBFqmioNn1mTyk1ta47R6d4MrX7tjrnjYUpdUbv2rVr6YpVfsGG58AG8Ah9eyUN8CX4WfgV+G8LVWPDGb+Zd4cU584CtqSbMKxauxTg+dyn/LkVgA+IR8KHtejeFKRtTmLLpxN6mYVLjYxwXf5x2VofiZcp/lwKk4wGOpYDnoIZPdg/AAbwMfx0+ge9dgZvYjuqKe4HnGnykYo5TvJbG0Vj12JagRhwKa44H95ShkZa5RyLGGdfYvG7aw1TsF6iapPAS29mNS3NmsTQZCmgTzFwgL3upCTgtBTRwvGMAKrgLn4evwin8+afJRcff+8izUGUM63GOOuAs3tJkw7J4kyoNreqrpO6cYLQeFUd7TTpr5YOTLc9RUUogUOVJQ1GYJaFLAW0oTmKyYS46ZooP4S4EON3xQ5zC8/CX4CnM4c1PE8ApexpoYuzqlP3d4S3OJP8ZDK7cKWNaTlqmgDiiHwl1YsE41w1zT4iRTm3DBqxvOUsbMKKDa/EHxagtnta072ejc3DOIh5ojvh8l3tk1JF/AV6FU6jh3U8HwEazLgdCLYSQ+MYiAI2ltomkzttUb0gGHdSUUgsIYjTzLG3mObX4FBRaYtpDVNZrih9TgTeYOBxsEnN1gOCTM8Bsw/ieMc75w9kuAT6A+/AiHGvN/+Gn4KRkiuzpNNDYhDGFndWRpE6SVfm8U5bxnSgVV2jrg6JCKmneqey8VMFgq2+AM/i4L4RUbfSi27lNXZ7R7W9RTcq/q9fk4Xw3AMQd4I5ifAZz8FcVtm9SAom/dyN4lczJQW/kC42ZrHgcCoIf1oVMKkVItmMBi9cOeNHGLqOZk+QqQmrbc5YmYgxELUUN35z2iohstgfLIFmcMV7s4CFmI74L9+EFmGsi+tGnAOD4Yk9gIpo01Y4cA43BWGygMdr4YZekG3OBIUXXNukvJS8tqa06e+lSDCtnqqMFu6hWHXCF+WaYt64m9QBmNxi7Ioy7D+fa1yHw+FMAcPt7SysFLtoG4PXAk7JOA3aAxBRqUiAdU9Yp5lK3HLSRFtOim0sa8euEt08xvKjYjzeJ2GU7YawexrnKI9tmobInjFXCewpwriY9+RR4aaezFhMhGCppKwom0ChrgFlKzyPKkGlTW1YQrE9HJqu8hKGgMc6hVi5QRq0PZxNfrYNgE64utmRv6KKHRpxf6VDUaOvNP5jCEx5q185My/7RKz69UQu2im5k4/eownpxZxNLwiZ1AZTO2ZjWjkU9uaB2HFn6Q3u0JcsSx/qV9hTEApRzeBLDJQXxYmTnq7bdLa3+uqFrxLJ5w1TehnNHx5ECvCh2g2c3hHH5YsfdaSKddztfjQ6imKFGSyFwlLzxEGPp6r5IevVjk1AMx3wMqi1NxDVjLBiPs9tbsCkIY5we5/ML22zrCScFxnNtzsr9Wcc3CnD+pYO+4VXXiDE0oc/vQQ/fDK3oPESJMYXNmJa/DuloJZkcTpcYE8lIH8Dz8DJMiynNC86Mb2lNaaqP/+L7f2fcE/yP7/Lde8xfgSOdMxvOixZf/9p3+M4hT1+F+zApxg9XfUvYjc8qX2lfOOpK2gNRtB4flpFu9FTKCp2XJRgXnX6olp1zyYjTKJSkGmLE2NjUr1bxFM4AeAAHBUFIeSLqXR+NvH/M9fOnfHzOD2vCSyQJKzfgsCh+yi/Mmc35F2fUrw7miW33W9hBD1vpuUojFphIyvg7aTeoymDkIkeW3XLHmguMzbIAJejN6B5MDrhipE2y6SoFRO/AK/AcHHZHNIfiWrEe/C6cr3f/yOvrQKB+zMM55/GQdLDsR+ifr5Fiuu+/y+M78LzOE5dsNuXC3PYvYWd8NXvphLSkJIasrlD2/HOqQ+RjcRdjKTGWYhhVUm4yxlyiGPuMsZR7sMCHUBeTuNWA7if+ifXgc/hovftHXs/DV+Fvwe+f8shzMiMcweFgBly3//vwJfg5AN4450fn1Hd1Rm1aBLu22Dy3y3H2+OqMemkbGZ4jozcDjJf6596xOLpC0eMTHbKnxLxH27uZ/bMTGs2jOaMOY4m87CfQwF0dw53oa1k80JRuz/XgS+8fX3N9Af4qPIMfzKgCp4H5TDGe9GGeFPzSsZz80SlPTxXjgwJmC45njzgt2vbQ4b4OAdUK4/vWhO8d8v6EE8fMUsfakXbPpFJeLs2ubM/qdm/la3WP91uWhxXHjoWhyRUq2iJ/+5mA73zwIIo+LoZ/SgvIRjAd1IMvvn98PfgOvAJfhhm8scAKVWDuaRaK8aQ9f7vuPDH6Bj47ZXau7rqYJ66mTDwEDU6lLbCjCK0qTXyl5mnDoeNRxanj3FJbaksTk0faXxHxLrssgPkWB9LnA/MFleXcJozzjwsUvUG0X/QCve51qkMDXp9mtcyOy3rwBfdvVJK7D6/ACSzg3RoruIq5UDeESfEmVclDxnniU82vxMLtceD0hGZWzBNPMM/jSPne2OVatiTKUpY5vY7gc0LdUAWeWM5tH+O2I66AOWw9xT2BuyRVLGdoDHUsVRXOo/c+ZdRXvFfnxWyIV4upFLCl9eAL7h8Zv0QH8Ry8pA2cHzQpGesctVA37ZtklBTgHjyvdSeKY/RZw/kJMk0Y25cSNRWSigQtlULPTw+kzuJPeYEkXjQRpoGZobYsLF79pyd1dMRHInbgFTZqNLhDqiIsTNpoex2WLcy0/X6rHcdMMQvFSd5dWA++4P7xv89deACnmr36uGlL69bRCL6BSZsS6c0TU2TKK5gtWCzgAOOwQcurqk9j8whvziZSMLcq5hbuwBEsYjopUBkqw1yYBGpLA97SRElEmx5MCInBY5vgLk94iKqSWmhIGmkJ4Bi9m4L645J68LyY4wsFYBfUg5feP/6gWWm58IEmKQM89hq7KsZNaKtP5TxxrUZZVkNmMJtjbKrGxLNEbHPJxhqy7lAmbC32ZqeF6lTaknRWcYaFpfLUBh/rwaQycCCJmW15Kstv6jRHyJFry2C1ahkkIW0LO75s61+owxK1y3XqweX9m5YLM2DPFeOjn/iiqCKJ+yKXF8t5Yl/kNsqaSCryxPq5xWTFIaP8KSW0RYxqupaUf0RcTNSSdJZGcKYdYA6kdtrtmyBckfKXwqk0pHpUHlwWaffjNRBYFPUDWa8e3Lt/o0R0CdisKDM89cX0pvRHEfM8ca4t0s2Xx4kgo91MPQJ/0c9MQYq0co8MBh7bz1fio0UUHLR4aAIOvOmoYO6kwlEVODSSTliWtOtH6sPkrtctF9ZtJ9GIerBskvhdVS5cFNv9s1BU0AbdUgdK4FG+dRnjFmDTzniRMdZO1QhzMK355vigbdkpz9P6qjUGE5J2qAcXmwJ20cZUiAD0z+pGMx6xkzJkmEf40Hr4qZfVg2XzF9YOyoV5BjzVkUJngKf8lgNYwKECEHrCNDrWZzMlflS3yBhr/InyoUgBc/lKT4pxVrrC6g1YwcceK3BmNxZcAtz3j5EIpqguh9H6wc011YN75cKDLpFDxuwkrPQmUwW4KTbj9mZTwBwLq4aQMUZbHm1rylJ46dzR0dua2n3RYCWZsiHROeywyJGR7mXKlpryyCiouY56sFkBWEnkEB/raeh/Sw4162KeuAxMQpEkzy5alMY5wamMsWKKrtW2WpEWNnReZWONKWjrdsKZarpFjqCslq773PLmEhM448Pc3+FKr1+94vv/rfw4tEcu+lKTBe4kZSdijBrykwv9vbCMPcLQTygBjzVckSLPRVGslqdunwJ4oegtFOYb4SwxNgWLCmD7T9kVjTv5YDgpo0XBmN34Z/rEHp0sgyz7lngsrm4lvMm2Mr1zNOJYJ5cuxuQxwMGJq/TP5emlb8fsQBZviK4t8hFL+zbhtlpwaRSxQRWfeETjuauPsdGxsBVdO7nmP4xvzSoT29pRl7kGqz+k26B3Oy0YNV+SXbbQas1ctC/GarskRdFpKczVAF1ZXnLcpaMuzVe6lZ2g/1ndcvOVgRG3sdUAY1bKD6achijMPdMxV4muKVorSpiDHituH7rSTs7n/4y5DhRXo4FVBN4vO/zbAcxhENzGbHCzU/98Mcx5e7a31kWjw9FCe/zNeYyQjZsWb1uc7U33pN4Mji6hCLhivqfa9Ss6xLg031AgfesA/l99m9fgvnaF9JoE6bYKmkGNK3aPbHB96w3+DnxFm4hs0drLsk7U8kf/N/CvwQNtllna0rjq61sH8L80HAuvwH1tvBy2ChqWSCaYTaGN19sTvlfzFD6n+iKTbvtayfrfe9ueWh6GJFoxLdr7V72a5ZpvHcCPDzma0wTO4EgbLyedxstO81n57LYBOBzyfsOhUKsW1J1BB5vr/tz8RyqOFylQP9Tvst2JALsC5lsH8PyQ40DV4ANzYa4dedNiKNR1s+x2wwbR7q4/4cTxqEk4LWDebfisuo36JXLiWFjOtLrlNWh3K1rRS4xvHcDNlFnNmWBBAl5SWaL3oPOfnvbr5pdjVnEaeBJSYjuLEkyLLsWhKccadmOphZkOPgVdalj2QpSmfOsADhMWE2ZBu4+EEJI4wKTAuCoC4xwQbWXBltpxbjkXJtKxxabo9e7tyhlgb6gNlSbUpMh+l/FaqzVwewGu8BW1Zx7pTpQDJUjb8tsUTW6+GDXbMn3mLbXlXJiGdggxFAoUrtPS3wE4Nk02UZG2OOzlk7fRs7i95QCLo3E0jtrjnM7SR3uS1p4qtS2nJ5OwtQVHgOvArLBFijZUV9QtSl8dAY5d0E0hM0w3HS2DpIeB6m/A1+HfhJcGUq4sOxH+x3f5+VO+Ds9rYNI7zPXOYWPrtf8bYMx6fuOAX5jzNR0PdsuON+X1f7EERxMJJoU6GkTEWBvVolVlb5lh3tKCg6Wx1IbaMDdJ+9sUCc5KC46hKGCk3IVOS4TCqdBNfUs7Kd4iXf2RjnT/LLysJy3XDcHLh/vde3x8DoGvwgsa67vBk91G5Pe/HbOe7xwym0NXbtiuuDkGO2IJDh9oQvJ4cY4vdoqLDuoH9Zl2F/ofsekn8lkuhIlhQcffUtSjytFyp++p6NiE7Rqx/lodgKVoceEp/CP4FfjrquZaTtj2AvH5K/ywpn7M34K/SsoYDAdIN448I1/0/wveW289T1/lX5xBzc8N5IaHr0XMOQdHsIkDuJFifj20pBm5jzwUv9e2FhwRsvhAbalCIuIw3bhJihY3p6nTFFIZgiSYjfTf3aXuOjmeGn4bPoGvwl+CFzTRczBIuHBEeImHc37/lGfwZR0cXzVDOvaKfNHvwe+suZ771K/y/XcBlsoN996JpBhoE2toYxOznNEOS5TJc6Id5GEXLjrWo+LEWGNpPDU4WAwsIRROu+1vM+0oW37z/MBN9kqHnSArwPfgFJ7Cq/Ai3Ie7g7ncmI09v8sjzw9mzOAEXoIHxURueaAce5V80f/DOuuZwHM8vsMb5wBzOFWM7wymTXPAEvm4vcFpZ2ut0VZRjkiP2MlmLd6DIpbGSiHOjdnUHN90hRYmhTnmvhzp1iKDNj+b7t5hi79lWGwQ+HN9RsfFMy0FXbEwhfuczKgCbyxYwBmcFhhvo/7a44v+i3XWcwDP86PzpGQYdWh7csP5dBvZ1jNzdxC8pBGuxqSW5vw40nBpj5JhMwvOzN0RWqERHMr4Lv1kWX84xLR830G3j6yqZ1a8UstTlW+qJPOZ+sZ7xZPKTJLhiNOAFd6tk+jrTH31ncLOxid8+nzRb128HhUcru/y0Wn6iT254YPC6FtVSIMoW2sk727AhvTtrWKZTvgsmckfXYZWeNRXx/3YQ2OUxLDrbHtN11IwrgXT6c8dATDwLniYwxzO4RzuQqTKSC5gAofMZ1QBK3zQ4JWobFbcvJm87FK+6JXrKahLn54m3p+McXzzYtP8VF/QpJuh1OwieElEoI1pRxPS09FBrkq2tWCU59+HdhNtTIqKm8EBrw2RTOEDpG3IKo2Y7mFdLm3ZeVjYwVw11o/oznceMve4CgMfNym/utA/d/ILMR7gpXzRy9eDsgLcgbs8O2Va1L0zzIdwGGemTBuwROHeoMShkUc7P+ISY3KH5ZZeWqO8mFTxQYeXTNuzvvK5FGPdQfuu00DwYFY9dyhctEt+OJDdnucfpmyhzUJzfsJjr29l8S0bXBfwRS9ZT26tmMIdZucch5ZboMz3Nio3nIOsYHCGoDT4kUA9MiXEp9Xsui1S8th/kbWIrMBxDGLodWUQIWcvnXy+9M23xPiSMOiRPqM+YMXkUN3gXFrZJwXGzUaMpJfyRS9ZT0lPe8TpScuRlbMHeUmlaKDoNuy62iWNTWNFYjoxFzuJs8oR+RhRx7O4SVNSXpa0ZJQ0K1LAHDQ+D9IepkMXpcsq5EVCvClBUIzDhDoyKwDw1Lc59GbTeORivugw1IcuaEOaGWdNm+Ps5fQ7/tm0DjMegq3yM3vb5j12qUId5UZD2oxDSEWOZMSqFl/W+5oynWDa/aI04tJRQ2eTXusg86SQVu/nwSYwpW6wLjlqIzwLuxGIvoAvul0PS+ZNz0/akp/pniO/8JDnGyaCkzbhl6YcqmK/69prxPqtpx2+Km9al9sjL+rwMgHw4jE/C8/HQ3m1vBuL1fldbzd8mOueVJ92syqdEY4KJjSCde3mcRw2TA6szxedn+zwhZMps0XrqEsiUjnC1hw0TELC2Ek7uAAdzcheXv1BYLagspxpzSAoZZUsIzIq35MnFQ9DOrlNB30jq3L4pkhccKUAA8/ocvN1Rzx9QyOtERs4CVsJRK/DF71kPYrxYsGsm6RMh4cps5g1DOmM54Ly1ii0Hd3Y/BMk8VWFgBVmhqrkJCPBHAolwZaWzLR9Vb7bcWdX9NyUYE+uB2BKfuaeBUcjDljbYVY4DdtsVWvzRZdWnyUzDpjNl1Du3aloAjVJTNDpcIOVVhrHFF66lLfJL1zJr9PQ2nFJSBaKoDe+sAvLufZVHVzYh7W0h/c6AAZ+7Tvj6q9j68G/cTCS/3n1vLKHZwNi+P+pS0WkZNMBMUl+LDLuiE4omZy71r3UFMwNJV+VJ/GC5ixVUkBStsT4gGKh0Gm4Oy3qvq7Lbmq24nPdDuDR9deR11XzP4vFu3TYzfnIyiSVmgizUYGqkIXNdKTY9pgb9D2Ix5t0+NHkVzCdU03suWkkVZAoCONCn0T35gAeW38de43mf97sMOpSvj4aa1KYUm58USI7Wxxes03bAZdRzk6UtbzMaCQ6IxO0dy7X+XsjoD16hpsBeGz9dfzHj+R/Hp8nCxZRqkEDTaCKCSywjiaoMJ1TITE9eg7Jqnq8HL6gDwiZb0u0V0Rr/rmvqjxKuaLCX7ZWXTvAY+uvm3z8CP7nzVpngqrJpZKwWnCUjIviYVlirlGOzPLI3SMVyp/elvBUjjDkNhrtufFFErQ8pmdSlbK16toBHlt/HV8uHMX/vEGALkV3RJREiSlopxwdMXOZPLZ+ix+kAHpMKIk8UtE1ygtquttwxNhphrIZ1IBzjGF3IIGxGcBj6q8bHJBG8T9vdsoWrTFEuebEZuVxhhClH6P5Zo89OG9fwHNjtNQTpD0TG9PJLEYqvEY6Rlxy+ZZGfL0Aj62/bnQCXp//eeM4KzfQVJbgMQbUjlMFIm6TpcfWlZje7NBSV6IsEVmumWIbjiloUzQX9OzYdo8L1wjw2PrrpimONfmfNyzKklrgnEkSzT5QWYQW40YShyzqsRmMXbvVxKtGuYyMKaU1ugenLDm5Ily4iT14fP11Mx+xJv+zZ3MvnfdFqxU3a1W/FTB4m3Qfsyc1XUcdVhDeUDZXSFHHLQj/Y5jtC7ZqM0CXGwB4bP11i3LhOvzPGygYtiUBiwQV/4wFO0majijGsafHyRLu0yG6q35cL1rOpVxr2s5cM2jJYMCdc10Aj6q/blRpWJ//+dmm5psMl0KA2+AFRx9jMe2WbC4jQxnikd4DU8TwUjRVacgdlhmr3bpddzuJ9zXqr2xnxJfzP29RexdtjDVZqzkqa6PyvcojGrfkXiJ8SEtml/nYskicv0ivlxbqjemwUjMw5evdg8fUX9nOiC/lf94Q2i7MURk9nW1MSj5j8eAyV6y5CN2S6qbnw3vdA1Iwq+XOSCl663udN3IzLnrt+us25cI1+Z83SXQUldqQq0b5XOT17bGpLd6ssN1VMPf8c+jG8L3NeCnMdF+Ra3fRa9dft39/LuZ/3vwHoHrqGmQFafmiQw6eyzMxS05K4bL9uA+SKUQzCnSDkqOGokXyJvbgJ/BHI+qvY69//4rl20NsmK2ou2dTsyIALv/91/8n3P2Aao71WFGi8KKv1fRC5+J67Q/507/E/SOshqN5TsmYIjVt+kcjAx98iz/4SaojbIV1rexE7/C29HcYD/DX4a0rBOF5VTu7omsb11L/AWcVlcVZHSsqGuXLLp9ha8I//w3Mv+T4Ew7nTBsmgapoCrNFObIcN4pf/Ob/mrvHTGqqgAupL8qWjWPS9m/31jAe4DjA+4+uCoQoT/zOzlrNd3qd4SdphFxsUvYwGWbTWtISc3wNOWH+kHBMfc6kpmpwPgHWwqaSUG2ZWWheYOGQGaHB+eQ/kn6b3pOgLV+ODSn94wDvr8Bvb70/LLuiPPEr8OGVWfDmr45PZyccEmsVXZGe1pRNX9SU5+AVQkNTIVPCHF/jGmyDC9j4R9LfWcQvfiETmgMMUCMN1uNCakkweZsowdYobiMSlnKA93u7NzTXlSfe+SVbfnPQXmg9LpYAQxpwEtONyEyaueWM4FPjjyjG3uOaFmBTWDNgBXGEiQpsaWhnAqIijB07Dlsy3fUGeP989xbWkyf+FF2SNEtT1E0f4DYYVlxFlbaSMPIRMk/3iMU5pME2SIWJvjckciebkQuIRRyhUvkHg/iUljG5kzVog5hV7vIlCuBrmlhvgPfNHQM8lCf+FEGsYbMIBC0qC9a0uuy2wLXVbLBaP5kjHokCRxapkQyzI4QEcwgYHRZBp+XEFTqXFuNVzMtjXLJgX4gAid24Hjwc4N3dtVSe+NNiwTrzH4WVUOlDobUqr1FuAgYllc8pmzoVrELRHSIW8ViPxNy4xwjBpyR55I6J220qQTZYR4guvUICJiSpr9gFFle4RcF/OMB7BRiX8sSfhpNSO3lvEZCQfLUVTKT78Ek1LRLhWN+yLyTnp8qWUZ46b6vxdRGXfHVqx3eI75YaLa4iNNiK4NOW7wPW6lhbSOF9/M9qw8e/aoB3d156qTzxp8pXx5BKAsYSTOIIiPkp68GmTq7sZtvyzBQaRLNxIZ+paozHWoLFeExIhRBrWitHCAHrCF7/thhD8JhYz84wg93QRV88wLuLY8zF8sQ36qF1J455bOlgnELfshKVxYOXKVuKx0jaj22sczTQqPqtV/XDgpswmGTWWMSDw3ssyUunLLrVPGjYRsH5ggHeHSWiV8kT33ycFSfMgkoOK8apCye0J6VW6GOYvffgU9RWsukEi2kUV2nl4dOYUzRik9p7bcA4ggdJ53LxKcEe17B1R8eqAd7dOepV8sTXf5lhejoL85hUdhDdknPtKHFhljOT+bdq0hxbm35p2nc8+Ja1Iw+tJykgp0EWuAAZYwMVwac5KzYMslhvgHdHRrxKnvhTYcfKsxTxtTETkjHO7rr3zjoV25lAQHrqpV7bTiy2aXMmUhTBnKS91jhtR3GEoF0oLnWhWNnYgtcc4N0FxlcgT7yz3TgNIKkscx9jtV1ZKpWW+Ub1tc1eOv5ucdgpx+FJy9pgbLE7xDyXb/f+hLHVGeitHOi6A7ybo3sF8sS7w7cgdk0nJaOn3hLj3uyD0Zp5pazFIUXUpuTTU18d1EPkDoX8SkmWTnVIozEdbTcZjoqxhNHf1JrSS/AcvHjZ/SMHhL/7i5z+POsTUh/8BvNfYMTA8n+yU/MlTZxSJDRStqvEuLQKWwDctMTQogUDyQRoTQG5Kc6oQRE1yV1jCA7ri7jdZyK0sYTRjCR0Hnnd+y7nHxNgTULqw+8wj0mQKxpYvhjm9uSUxg+TTy7s2GtLUGcywhXSKZN275GsqlclX90J6bRI1aouxmgL7Q0Nen5ziM80SqMIo8cSOo+8XplT/5DHNWsSUr/6lLN/QQ3rDyzLruEW5enpf7KqZoShEduuSFOV7DLX7Ye+GmXb6/hnNNqKsVXuMDFpb9Y9eH3C6NGEzuOuI3gpMH/I6e+zDiH1fXi15t3vA1czsLws0TGEtmPEJdiiFPwlwKbgLHAFk4P6ZyPdymYYHGE0dutsChQBl2JcBFlrEkY/N5bQeXQ18gjunuMfMfsBlxJSx3niO485fwO4fGD5T/+3fPQqkneWVdwnw/3bMPkW9Wbqg+iC765Zk+xcT98ibKZc2EdgHcLoF8cSOo/Oc8fS+OyEULF4g4sJqXVcmfMfsc7A8v1/yfGXmL9I6Fn5pRwZhsPv0TxFNlAfZCvG+Oohi82UC5f/2IsJo0cTOm9YrDoKhFPEUr/LBYTUNht9zelHXDqwfPCIw4owp3mOcIQcLttWXFe3VZ/j5H3cIc0G6oPbCR+6Y2xF2EC5cGUm6wKC5tGEzhsWqw5hNidUiKX5gFWE1GXh4/Qplw4sVzOmx9QxU78g3EF6wnZlEN4FzJ1QPSLEZz1KfXC7vd8ssGdIbNUYpVx4UapyFUHzJoTOo1McSkeNn1M5MDQfs4qQuhhX5vQZFw8suwWTcyYTgioISk2YdmkhehG4PkE7w51inyAGGaU+uCXADabGzJR1fn3lwkty0asIo8cROm9Vy1g0yDxxtPvHDAmpu+PKnM8Ix1wwsGw91YJqhteaWgjYBmmQiebmSpwKKzE19hx7jkzSWOm66oPbzZ8Yj6kxVSpYjVAuvLzYMCRo3oTQecOOjjgi3NQ4l9K5/hOGhNTdcWVOTrlgYNkEXINbpCkBRyqhp+LdRB3g0OU6rMfW2HPCFFMV9nSp+uB2woepdbLBuJQyaw/ZFysXrlXwHxI0b0LovEkiOpXGA1Ijagf+KUNC6rKNa9bQnLFqYNkEnMc1uJrg2u64ELPBHpkgWbmwKpJoDhMwNbbGzAp7Yg31wS2T5rGtzit59PrKhesWG550CZpHEzpv2NGRaxlNjbMqpmEIzygJqQfjypycs2pg2cS2RY9r8HUqkqdEgKTWtWTKoRvOBPDYBltja2SO0RGjy9UHtxwRjA11ujbKF+ti5cIR9eCnxUg6owidtyoU5tK4NLji5Q3HCtiyF2IqLGYsHViOXTXOYxucDqG0HyttqYAKqYo3KTY1ekyDXRAm2AWh9JmsVh/ccg9WJ2E8YjG201sPq5ULxxX8n3XLXuMInbft2mk80rRGjCGctJ8/GFdmEQ9Ug4FlE1ll1Y7jtiraqm5Fe04VV8lvSVBL8hiPrfFVd8+7QH3Qbu2ipTVi8cvSGivc9cj8yvH11YMHdNSERtuOslM97feYFOPKzGcsI4zW0YGAbTAOaxCnxdfiYUmVWslxiIblCeAYr9VYR1gM7GmoPrilunSxxeT3DN/2eBQ9H11+nk1adn6VK71+5+Jfct4/el10/7KBZfNryUunWSCPxPECk1rdOv1WVSrQmpC+Tl46YD3ikQYcpunSQgzVB2VHFhxHVGKDgMEY5GLlQnP7FMDzw7IacAWnO6sBr12u+XanW2AO0wQ8pknnFhsL7KYIqhkEPmEXFkwaN5KQphbkUmG72wgw7WSm9RiL9QT925hkjiVIIhphFS9HKI6/8QAjlpXqg9W2C0apyaVDwKQwrwLY3j6ADR13ZyUNByQXHQu6RY09Hu6zMqXRaNZGS/KEJs0cJEe9VH1QdvBSJv9h09eiRmy0V2uJcqHcShcdvbSNg5fxkenkVprXM9rDVnX24/y9MVtncvbKY706anNl3ASll9a43UiacVquXGhvq4s2FP62NGKfQLIQYu9q1WmdMfmUrDGt8eDS0cXozH/fjmUH6Jruvm50hBDSaEU/2Ru2LEN/dl006TSc/g7tfJERxGMsgDUEr104pfWH9lQaN+M4KWQjwZbVc2rZVNHsyHal23wZtIs2JJqtIc/WLXXRFCpJkfE9jvWlfFbsNQ9pP5ZBS0zKh4R0aMFj1IjTcTnvi0Zz2rt7NdvQb2mgbju1plsH8MmbnEk7KbK0b+wC2iy3aX3szW8xeZvDwET6hWZYwqTXSSG+wMETKum0Dq/q+x62gt2ua2ppAo309TRk9TPazfV3qL9H8z7uhGqGqxNVg/FKx0HBl9OVUORn8Q8Jx9gFttGQUDr3tzcXX9xGgN0EpzN9mdZ3GATtPhL+CjxFDmkeEU6x56kqZRusLzALXVqkCN7zMEcqwjmywDQ6OhyUe0Xao1Qpyncrg6wKp9XfWDsaZplElvQ/b3sdweeghorwBDlHzgk1JmMc/wiERICVy2VJFdMjFuLQSp3S0W3+sngt2njwNgLssFGVQdJ0tu0KH4ky1LW4yrbkuaA6Iy9oz/qEMMXMMDWyIHhsAyFZc2peV9hc7kiKvfULxCl9iddfRK1f8kk9qvbdOoBtOg7ZkOZ5MsGrSHsokgLXUp9y88smniwWyuFSIRVmjplga3yD8Uij5QS1ZiM4U3Qw5QlSm2bXjFe6jzzBFtpg+/YBbLAWG7OPynNjlCw65fukGNdkJRf7yM1fOxVzbxOJVocFoYIaGwH22mIQkrvu1E2nGuebxIgW9U9TSiukPGU+Lt++c3DJPKhyhEEbXCQLUpae2exiKy6tMPe9mDRBFCEMTWrtwxN8qvuGnt6MoihKWS5NSyBhbH8StXoAz8PLOrRgLtOT/+4vcu+7vDLnqNvztOq7fmd8sMmY9Xzn1zj8Dq8+XVdu2Nv0IIySgEdQo3xVHps3Q5i3fLFsV4aiqzAiBhbgMDEd1uh8qZZ+lwhjkgokkOIv4xNJmyncdfUUzgB4oFMBtiu71Xumpz/P+cfUP+SlwFExwWW62r7b+LSPxqxn/gvMZ5z9C16t15UbNlq+jbGJtco7p8wbYlL4alSyfWdeuu0j7JA3JFNuVAwtst7F7FhWBbPFNKIUORndWtLraFLmMu7KFVDDOzqkeaiN33YAW/r76wR4XDN/yN1z7hejPau06EddkS/6XThfcz1fI/4K736fO48vlxt2PXJYFaeUkFS8U15XE3428xdtn2kc8GQlf1vkIaNRRnOMvLTWrZbElEHeLWi1o0dlKPAh1MVgbbVquPJ5+Cr8LU5/H/+I2QlHIU2ClXM9G8v7Rr7oc/hozfUUgsPnb3D+I+7WF8kNO92GY0SNvuxiE+2Bt8prVJTkzE64sfOstxuwfxUUoyk8VjcTlsqe2qITSFoSj6Epd4KsT6BZOWmtgE3hBfir8IzZDwgV4ZTZvD8VvPHERo8v+vL1DASHTz/i9OlKueHDjK5Rnx/JB1Vb1ioXdBra16dmt7dgik10yA/FwJSVY6XjA3oy4SqM2frqDPPSRMex9qs3XQtoWxMj7/Er8GWYsXgjaVz4OYumP2+9kbxvny/6kvWsEBw+fcb5bInc8APdhpOSs01tEqIkoiZjbAqKMruLbJYddHuHFRIyJcbdEdbl2sVLaySygunutBg96Y2/JjKRCdyHV+AEFtTvIpbKIXOamknYSiB6KV/0JetZITgcjjk5ZdaskBtWO86UF0ap6ozGXJk2WNiRUlCPFir66lzdm/SLSuK7EUdPz8f1z29Skq6F1fXg8+5UVR6bszncP4Tn4KUkkdJ8UFCY1zR1i8RmL/qQL3rlei4THG7OODlnKko4oI01kd3CaM08Ia18kC3GNoVaO9iDh+hWxSyTXFABXoau7Q6q9OxYg/OVEMw6jdbtSrJ9cBcewGmaZmg+bvkUnUUaGr+ZfnMH45Ivevl61hMcXsxYLFTu1hTm2zViCp7u0o5l+2PSUh9bDj6FgYypufBDhqK2+oXkiuHFHR3zfj+9PtA8oR0xnqX8qn+sx3bFODSbbF0X8EUvWQ8jBIcjo5bRmLOljDNtcqNtOe756h3l0VhKa9hDd2l1eqmsnh0MNMT/Cqnx6BInumhLT8luljzQ53RiJeA/0dxe5NK0o2fA1+GLXr6eNQWHNUOJssQaTRlGpLHKL9fD+IrQzTOMZS9fNQD4AnRNVxvTdjC+fJdcDDWQcyB00B0t9BDwTxXgaAfzDZ/DBXzRnfWMFRwuNqocOmX6OKNkY63h5n/fFcB28McVHqnXZVI27K0i4rDLNE9lDKV/rT+udVbD8dFFu2GGZ8mOt0kAXcoX3ZkIWVtw+MNf5NjR2FbivROHmhV1/pj2egv/fMGIOWTIWrV3Av8N9imV9IWml36H6cUjqEWNv9aNc+veb2sH46PRaHSuMBxvtW+twxctq0z+QsHhux8Q7rCY4Ct8lqsx7c6Sy0dl5T89rIeEuZKoVctIk1hNpfavER6yyH1Vvm3MbsUHy4ab4hWr/OZPcsRBphnaV65/ZcdYPNNwsjN/djlf9NqCw9U5ExCPcdhKxUgLSmfROpLp4WSUr8ojdwbncbvCf+a/YzRaEc6QOvXcGO256TXc5Lab9POvB+AWY7PigWYjzhifbovuunzRawsO24ZqQQAqguBtmpmPB7ysXJfyDDaV/aPGillgz1MdQg4u5MYaEtBNNHFjkRlSpd65lp4hd2AVPTfbV7FGpyIOfmNc/XVsPfg7vzaS/3nkvLL593ANLvMuRMGpQIhiF7kUEW9QDpAUbTWYBcbp4WpacHHY1aacqQyjGZS9HI3yCBT9kUZJhVOD+zUDvEH9ddR11fzPcTDQ5TlgB0KwqdXSavk9BC0pKp0WmcuowSw07VXmXC5guzSa4p0UvRw2lbDiYUx0ExJJRzWzi6Gm8cnEkfXXsdcG/M/jAJa0+bmCgdmQ9CYlNlSYZOKixmRsgiFxkrmW4l3KdFKv1DM8tk6WxPYJZhUUzcd8Kdtgrw/gkfXXDT7+avmfVak32qhtkg6NVdUS5wgkru1YzIkSduTW1FDwVWV3JQVJVuieTc0y4iDpFwc7/BvSalvKdQM8sv662cevz/+8sQVnjVAT0W2wLllw1JiMhJRxgDjCjLQsOzSFSgZqx7lAW1JW0e03yAD3asC+GD3NbQhbe+mN5GXH1F83KDOM4n/e5JIuH4NpdQARrFPBVptUNcjj4cVMcFSRTE2NpR1LEYbYMmfWpXgP9KejaPsLUhuvLCsVXznAG9dfx9SR1ud/3hZdCLHb1GMdPqRJgqDmm76mHbvOXDtiO2QPUcKo/TWkQ0i2JFXpBoo7vij1i1Lp3ADAo+qvG3V0rM//vFnnTE4hxd5Ka/Cor5YEdsLVJyKtDgVoHgtW11pWSjolPNMnrlrVj9Fv2Qn60twMwKPqr+N/wvr8z5tZcDsDrv06tkqyzESM85Ycv6XBWA2birlNCXrI6VbD2lx2L0vQO0QVTVVLH4SE67fgsfVXv8n7sz7/85Z7cMtbE6f088wSaR4kCkCm10s6pKbJhfqiUNGLq+0gLWC6eUAZFPnLjwqtKd8EwGvWX59t7iPW4X/eAN1svgRVSY990YZg06BD1ohLMtyFTI4pKTJsS9xREq9EOaPWiO2gpms7397x6nQJkbh+Fz2q/rqRROX6/M8bJrqlVW4l6JEptKeUFuMYUbtCQ7CIttpGc6MY93x1r1vgAnRXvY5cvwWPqb9uWQm+lP95QxdNMeWhOq1x0Db55C7GcUv2ZUuN6n8iKzsvOxibC//Yfs9Na8r2Rlz02vXXDT57FP/zJi66/EJSmsJKa8QxnoqW3VLQ+jZVUtJwJ8PNX1NQCwfNgdhhHD9on7PdRdrdGPF28rJr1F+3LBdeyv+8yYfLoMYet1vX4upNAjVvwOUWnlNXJXlkzk5Il6kqeoiL0C07qno+/CYBXq/+utlnsz7/Mzvy0tmI4zm4ag23PRN3t/CWryoUVJGm+5+K8RJ0V8Hc88/XHUX/HfiAq7t+BH+x6v8t438enWmdJwFA6ZINriLGKv/95f8lT9/FnyA1NMVEvQyaXuu+gz36f/DD73E4pwqpLcvm/o0Vle78n//+L/NPvoefp1pTJye6e4A/D082FERa5/opeH9zpvh13cNm19/4v/LDe5xMWTi8I0Ta0qKlK27AS/v3/r+/x/2GO9K2c7kVMonDpq7//jc5PKCxeNPpFVzaRr01wF8C4Pu76hXuX18H4LduTr79guuFD3n5BHfI+ZRFhY8w29TYhbbLi/bvBdqKE4fUgg1pBKnV3FEaCWOWyA+m3WpORZr/j+9TKJtW8yBTF2/ZEODI9/QavHkVdGFp/Pjn4Q+u5hXapsP5sOH+OXXA1LiKuqJxiMNbhTkbdJTCy4llEt6NnqRT4dhg1V3nbdrm6dYMecA1yTOL4PWTE9L5VzPFlLBCvlG58AhehnN4uHsAYinyJ+AZ/NkVvELbfOBUuOO5syBIEtiqHU1k9XeISX5bsimrkUUhnGDxourN8SgUsCZVtKyGbyGzHXdjOhsAvOAswSRyIBddRdEZWP6GZhNK/yjwew9ehBo+3jEADu7Ay2n8mDc+TS7awUHg0OMzR0LABhqLD4hJEh/BEGyBdGlSJoXYXtr+3HS4ijzVpgi0paWXtdruGTknXBz+11qT1Q2inxaTzQCO46P3lfLpyS4fou2PH/PupwZgCxNhGlj4IvUuWEsTkqMWm6i4xCSMc9N1RDQoCVcuGItJ/MRWefais+3synowi/dESgJjkilnWnBTGvRWmaw8oR15257t7CHmCf8HOn7cwI8+NQBXMBEmAa8PMRemrNCEhLGEhDQKcGZWS319BX9PFBEwGTbRBhLbDcaV3drFcDqk5kCTd2JF1Wp0HraqBx8U0wwBTnbpCadwBA/gTH/CDrcCs93LV8E0YlmmcyQRQnjBa8JESmGUfIjK/7fkaDJpmD2QptFNVJU1bbtIAjjWQizepOKptRjbzR9Kag6xZmMLLjHOtcLT3Tx9o/0EcTT1XN3E45u24AiwEypDJXihKjQxjLprEwcmRKclaDNZCVqr/V8mYWyFADbusiY5hvgFoU2vio49RgJLn5OsReRFN6tabeetiiy0V7KFHT3HyZLx491u95sn4K1QQSPKM9hNT0wMVvAWbzDSVdrKw4zRjZMyJIHkfq1VAVCDl/bUhNKlGq0zGr05+YAceXVPCttVk0oqjVwMPt+BBefx4yPtGVkUsqY3CHDPiCM5ngupUwCdbkpd8kbPrCWHhkmtIKLEetF2499eS1jZlIPGYnlcPXeM2KD9vLS0bW3ktYNqUllpKLn5ZrsxlIzxvDu5eHxzGLctkZLEY4PgSOg2IUVVcUONzUDBEpRaMoXNmUc0tFZrTZquiLyKxrSm3DvIW9Fil+AkhXu5PhEPx9mUNwqypDvZWdKlhIJQY7vn2OsnmBeOWnYZ0m1iwbbw1U60by5om47iHRV6fOgzjMf/DAZrlP40Z7syxpLK0lJ0gqaAK1c2KQKu7tabTXkLFz0sCftuwX++MyNeNn68k5Buq23YQhUh0SNTJa1ioQ0p4nUG2y0XilF1JqODqdImloPS4Bp111DEWT0jJjVv95uX9BBV7eB3bUWcu0acSVM23YZdd8R8UbQUxJ9wdu3oMuhdt929ME+mh6JXJ8di2RxbTi6TbrDquqV4aUKR2iwT6aZbyOwEXN3DUsWr8Hn4EhwNyHuXHh7/pdaUjtR7vnDh/d8c9xD/s5f501eQ1+CuDiCvGhk1AN/4Tf74RfxPwD3toLarR0zNtsnPzmS64KIRk861dMWCU8ArasG9T9H0ZBpsDGnjtAOM2+/LuIb2iIUGXNgl5ZmKD/Tw8TlaAuihaFP5yrw18v4x1898zIdP+DDAX1bM3GAMvPgRP/cJn3zCW013nrhHkrITyvYuwOUkcHuKlRSW5C6rzIdY4ppnF7J8aAJbQepgbJYBjCY9usGXDKQxq7RZfh9eg5d1UHMVATRaD/4BHK93/1iAgYZ/+jqPn8Dn4UExmWrpa3+ZOK6MvM3bjwfzxNWA2dhs8+51XHSPJiaAhGSpWevEs5xHLXcEGFXYiCONySH3fPWq93JIsBiSWvWyc3CAN+EcXoT7rCSANloPPoa31rt/5PUA/gp8Q/jDD3hyrjzlR8VkanfOvB1XPubt17vzxAfdSVbD1pzAnfgyF3ycadOTOTXhpEUoLC1HZyNGW3dtmjeXgr2r56JNmRwdNNWaQVBddd6rh4MhviEB9EFRD/7RGvePvCbwAL4Mx/D6M541hHO4D3e7g6PafdcZVw689z7NGTwo5om7A8sPhccT6qKcl9NJl9aM/9kX+e59Hh1yPqGuCCZxuITcsmNaJ5F7d0q6J3H48TO1/+M57085q2icdu2U+W36Ldllz9Agiv4YGljoEN908EzvDOrBF98/vtJwCC/BF2AG75xxEmjmMIcjxbjoaxqOK3/4hPOZzhMPBpYPG44CM0dTVm1LjLtUWWVz1Bcf8tEx0zs8O2A2YVHRxKYOiy/aOVoAaMu0i7ubu43njjmd4ibMHU1sIDHaQNKrZND/FZYdk54oCXetjq7E7IVl9eAL7t+oHnwXXtLx44czzoRFHBztYVwtH1d+NOMkupZ5MTM+gUmq90X+Bh9zjRlmaQ+m7YMqUL/veemcecAtOJ0yq1JnVlN27di2E0+Klp1tAJ4KRw1eMI7aJjsO3R8kPSI3fUFXnIOfdQe86sIIVtWDL7h//Ok6vj8vwDk08NEcI8zz7OhBy+WwalzZeZ4+0XniRfst9pAJqQHDGLzVQ2pheZnnv1OWhwO43/AgcvAEXEVVpa4db9sGvNK8wjaENHkfFQ4Ci5i7dqnQlPoLQrHXZDvO3BIXZbJOBrOaEbML6sFL798I4FhKihjHMsPjBUZYCMFr6nvaArxqXPn4lCa+cHfSa2cP27g3Z3ziYTRrcbQNGLQmGF3F3cBdzzzX7AILx0IB9rbwn9kx2G1FW3Inic+ZLIsVvKR8Zwfj0l1fkqo8LWY1M3IX14OX3r9RKTIO+d9XzAI8qRPGPn/4NC2n6o4rN8XJ82TOIvuVA8zLKUHRFgBCetlDZlqR1gLKjS39xoE7Bt8UvA6BxuEDjU3tFsEijgA+615tmZkXKqiEENrh41iLDDZNq4pKTWR3LZfnos81LOuNa15cD956vLMsJd1rqYp51gDUQqMYm2XsxnUhD2jg1DM7SeuJxxgrmpfISSXVIJIS5qJJSvJPEQ49DQTVIbYWJ9QWa/E2+c/oPK1drmC7WSfJRNKBO5Yjvcp7Gc3dmmI/Xh1kDTEuiSnWqQf37h+fTMhGnDf6dsS8SQfQWlqqwXXGlc/PEZ/SC5mtzIV0nAshlQdM/LvUtYutrEZ/Y+EAFtq1k28zQhOwLr1AIeANzhF8t9qzTdZf2qRKO6MWE9ohBYwibbOmrFtNmg3mcS+tB28xv2uKd/agYCvOP+GkSc+0lr7RXzyufL7QbkUpjLjEWFLqOIkAGu2B0tNlO9Eau2W1qcOUvVRgKzypKIQZ5KI3q0MLzqTNRYqiZOqmtqloIRlmkBHVpHmRYV6/HixbO6UC47KOFJnoMrVyr7wYz+SlW6GUaghYbY1I6kkxA2W1fSJokUdSh2LQ1GAimRGm0MT+uu57H5l7QgOWxERpO9moLRPgTtquWCfFlGlIjQaRly9odmzMOWY+IBO5tB4sW/0+VWGUh32qYk79EidWKrjWuiLpiVNGFWFRJVktyeXWmbgBBzVl8anPuXyNJlBJOlKLTgAbi/EYHVHxWiDaVR06GnHQNpJcWcK2jJtiCfG2sEHLzuI66sGrMK47nPIInPnu799935aOK2cvmvubrE38ZzZjrELCmXM2hM7UcpXD2oC3+ECVp7xtIuxptJ0jUr3sBmBS47TVxlvJ1Sqb/E0uLdvLj0lLr29ypdd/eMX3f6lrxGlKwKQxEGvw0qHbkbwrF3uHKwVENbIV2wZ13kNEF6zD+x24aLNMfDTCbDPnEikZFyTNttxWBXDaBuM8KtI2rmaMdUY7cXcUPstqTGvBGSrFWIpNMfbdea990bvAOC1YX0qbc6smDS1mPxSJoW4fwEXvjMmhlijDRq6qale6aJEuFGoppYDoBELQzLBuh/mZNx7jkinv0EtnUp50lO9hbNK57lZaMAWuWR5Yo9/kYwcYI0t4gWM47Umnl3YmpeBPqSyNp3K7s2DSAS/39KRuEN2bS4xvowV3dFRMx/VFcp2Yp8w2nTO9hCXtHG1kF1L4KlrJr2wKfyq77R7MKpFKzWlY9UkhYxyHWW6nBWPaudvEAl3CGcNpSXPZ6R9BbBtIl6cHL3gIBi+42CYXqCx1gfGWe7Ap0h3luyXdt1MKy4YUT9xSF01G16YEdWsouW9mgDHd3veyA97H+Ya47ZmEbqMY72oPztCGvK0onL44AvgC49saZKkWRz4veWljE1FHjbRJaWv6ZKKtl875h4CziFCZhG5rx7tefsl0aRT1bMHZjm8dwL/6u7wCRysaQblQoG5yAQN5zpatMNY/+yf8z+GLcH/Qn0iX2W2oEfXP4GvwQHuIL9AYGnaO3zqAX6946nkgqZNnUhx43DIdQtMFeOPrgy/y3Yd85HlJWwjLFkU3kFwq28xPnuPhMWeS+tDLV9Otllq7pQCf3uXJDN9wFDiUTgefHaiYbdfi3b3u8+iY6TnzhgehI1LTe8lcd7s1wJSzKbahCRxKKztTLXstGAiu3a6rPuQs5pk9TWAan5f0BZmGf7Ylxzzk/A7PAs4QPPPAHeFQ2hbFHszlgZuKZsJcUmbDC40sEU403cEjczstOEypa+YxevL4QBC8oRYqWdK6b7sK25tfE+oDZgtOQ2Jg8T41HGcBE6fTWHn4JtHcu9S7uYgU5KSCkl/mcnq+5/YBXOEr6lCUCwOTOM1taOI8mSxx1NsCXBEmLKbMAg5MkwbLmpBaFOPrNSlO2HnLiEqW3tHEwd8AeiQLmn+2gxjC3k6AxREqvKcJbTEzlpLiw4rNZK6oJdidbMMGX9FULKr0AkW+2qDEPBNNm5QAt2Ik2nftNWHetubosHLo2nG4vQA7GkcVCgVCgaDixHqo9UUn1A6OshapaNR/LPRYFV8siT1cCtJE0k/3WtaNSuUZYKPnsVIW0xXWnMUxq5+En4Kvw/MqQmVXnAXj9Z+9zM98zM/Agy7F/qqj2Nh67b8HjFnPP3iBn/tkpdzwEJX/whIcQUXOaikeliCRGUk7tiwF0rItwMEhjkZ309hikFoRAmLTpEXWuHS6y+am/KB/fM50aLEhGnSMwkpxzOov4H0AvgovwJ1iGzDLtJn/9BU+fAINfwUe6FHSLhu83viV/+/HrOePX+STT2B9uWGbrMHHLldRBlhS/CJQmcRxJFqZica01XixAZsYiH1uolZxLrR/SgxVIJjkpQP4PE9sE59LKLr7kltSBogS5tyszzH8Fvw8/AS8rNOg0xUS9fIaHwb+6et8Q/gyvKRjf5OusOzGx8evA/BP4IP11uN/grca5O0lcsPLJ5YjwI4QkJBOHa0WdMZYGxPbh2W2nR9v3WxEWqgp/G3+6VZbRLSAAZ3BhdhAaUL33VUSw9yjEsvbaQ9u4A/gGXwZXoEHOuU1GSj2chf+Mo+f8IcfcAxfIKVmyunRbYQVnoevwgfw3TXXcw++xNuP4fhyueEUNttEduRVaDttddoP0eSxLe2LENk6itYxlrxBNBYrNNKSQmeaLcm9c8UsaB5WyO6675yyQIAWSDpBVoA/gxmcwEvwoDv0m58UE7gHn+fJOa8/Ywan8EKRfjsopF83eCglX/Sfr7OeaRoQfvt1CGvIDccH5BCvw1sWIzRGC/66t0VTcLZQZtm6PlAasbOJ9iwWtUo7biktTSIPxnR24jxP1ZKaqq+2RcXM9OrBAm/AAs7hDJ5bNmGb+KIfwCs8a3jnjBrOFeMjHSCdbKr+2uOLfnOd9eiA8Hvvwwq54VbP2OqwkB48Ytc4YEOiH2vTXqodabfWEOzso4qxdbqD5L6tbtNPECqbhnA708DZH4QOJUXqScmUlks7Ot6FBuZw3n2mEbaUX7kDzxHOOQk8nKWMzAzu6ZZ8sOFw4RK+6PcuXo9tB4SbMz58ApfKDXf3szjNIIbGpD5TKTRxGkEMLjLl+K3wlWXBsCUxIDU+jbOiysESqAy1MGUJpXgwbTWzNOVEziIXZrJ+VIztl1PUBxTSo0dwn2bOmfDRPD3TRTGlfbCJvO9KvuhL1hMHhB9wPuPRLGHcdOWG2xc0U+5bQtAJT0nRTewXL1pgk2+rZAdeWmz3jxAqfNQQdzTlbF8uJ5ecEIWvTkevAHpwz7w78QujlD/Lr491bD8/1vhM2yrUQRrWXNQY4fGilfctMWYjL72UL/qS9eiA8EmN88nbNdour+PBbbAjOjIa4iBhfFg6rxeKdEGcL6p3EWR1Qq2Qkhs2DrnkRnmN9tG2EAqmgPw6hoL7Oza7B+3SCrR9tRftko+Lsf2F/mkTndN2LmzuMcKTuj/mX2+4Va3ki16+nnJY+S7MefpkidxwnV+4wkXH8TKnX0tsYzYp29DOOoSW1nf7nTh2akYiWmcJOuTidSaqESrTYpwjJJNVGQr+rLI7WsqerHW6Kp/oM2pKuV7T1QY9gjqlZp41/WfKpl56FV/0kvXQFRyeQ83xaTu5E8p5dNP3dUF34ihyI3GSpeCsywSh22ZJdWto9winhqifb7VRvgktxp13vyjrS0EjvrRfZ62uyqddSWaWYlwTPAtJZ2oZ3j/Sgi/mi+6vpzesfAcWNA0n8xVyw90GVFGuZjTXEQy+6GfLGLMLL523f5E0OmxVjDoOuRiH91RKU+vtoCtH7TgmvBLvtFXWLW15H9GTdVw8ow4IlRLeHECN9ym1e9K0I+Cbnhgv4Yu+aD2HaQJ80XDqOzSGAV4+4yCqBxrsJAX6ZTIoX36QnvzhhzzMfFW2dZVLOJfo0zbce5OvwXMFaZ81mOnlTVXpDZsQNuoYWveketKb5+6JOOsgX+NTm7H49fUTlx+WLuWL7qxnOFh4BxpmJx0p2gDzA/BUARuS6phR+pUsY7MMboAHx5xNsSVfVZcYSwqCKrqon7zM+8ecCkeS4nm3rINuaWvVNnMRI1IRpxTqx8PZUZ0Br/UEduo3B3hNvmgZfs9gQPj8vIOxd2kndir3awvJ6BLvoUuOfFWNYB0LR1OQJoUySKb9IlOBx74q1+ADC2G6rOdmFdJcD8BkfualA+BdjOOzP9uUhGUEX/TwhZsUduwRr8wNuXKurCixLBgpQI0mDbJr9dIqUuV+92ngkJZ7xduCk2yZKbfWrH1VBiTg9VdzsgRjW3CVXCvAwDd+c1z9dWw9+B+8MJL/eY15ZQ/HqvTwVdsZn5WQsgRRnMaWaecu3jFvMBEmgg+FJFZsnSl0zjB9OqPYaBD7qmoVyImFvzi41usesV0julaAR9dfR15Xzv9sEruRDyk1nb+QaLU67T885GTls6YgcY+UiMa25M/pwGrbCfzkvR3e0jjtuaFtnwuagHTSb5y7boBH119HXhvwP487jJLsLJ4XnUkHX5sLbS61dpiAXRoZSCrFJ+EjpeU3puVfitngYNo6PJrAigKktmwjyQdZpfq30mmtulaAx9Zfx15Xzv+cyeuiBFUs9zq8Kq+XB9a4PVvph3GV4E3y8HENJrN55H1X2p8VyqSKwVusJDKzXOZzplWdzBUFK9e+B4+uv468xvI/b5xtSAkBHQaPvtqWzllVvEOxPbuiE6+j2pvjcKsbvI7txnRErgfH7LdXqjq0IokKzga14GzQ23SSbCQvO6r+Or7SMIr/efOkkqSdMnj9mBx2DRsiY29Uj6+qK9ZrssCKaptR6HKURdwUYeUWA2kPzVKQO8ku2nU3Anhs/XWkBx3F/7wJtCTTTIKftthue1ty9xvNYLY/zo5KSbIuKbXpbEdSyeRyYdAIwKY2neyoc3+k1XUaufYga3T9daMUx/r8z1s10ITknIO0kuoMt+TB8jK0lpayqqjsJ2qtXAYwBU932zinimgmd6mTRDnQfr88q36NAI+tv24E8Pr8zxtasBqx0+xHH9HhlrwsxxNUfKOHQaZBITNf0uccj8GXiVmXAuPEAKSdN/4GLHhs/XWj92dN/uetNuBMnVR+XWDc25JLjo5Mg5IZIq226tmCsip2zZliL213YrTlL2hcFjpCduyim3M7/eB16q/blQsv5X/esDRbtJeabLIosWy3ycavwLhtxdWzbMmHiBTiVjJo6lCLjXZsi7p9PEPnsq6X6wd4bP11i0rD5fzPm/0A6brrIsllenZs0lCJlU4abakR59enZKrKe3BZihbTxlyZ2zl1+g0wvgmA166/bhwDrcn/7Ddz0eWZuJvfSESug6NzZsox3Z04FIxz0mUjMwVOOVTq1CQ0AhdbBGVdjG/CgsfUX7esJl3K/7ytWHRv683praW/8iDOCqWLLhpljDY1ZpzK75QiaZoOTpLKl60auHS/97oBXrv+umU9+FL+5+NtLFgjqVLCdbmj7pY5zPCPLOHNCwXGOcLquOhi8CmCWvbcuO73XmMUPab+ug3A6/A/78Bwe0bcS2+tgHn4J5pyS2WbOck0F51Vq3LcjhLvZ67p1ABbaL2H67bg78BfjKi/jr3+T/ABV3ilLmNXTI2SpvxWBtt6/Z//D0z/FXaGbSBgylzlsEGp+5//xrd4/ae4d8DUUjlslfIYS3t06HZpvfQtvv0N7AHWqtjP2pW08QD/FLy//da38vo8PNlKHf5y37Dxdfe/oj4kVIgFq3koLReSR76W/bx//n9k8jonZxzWTANVwEniDsg87sOSd/z7//PvMp3jQiptGVWFX2caezzAXwfgtzYUvbr0iozs32c3Uge7varH+CNE6cvEYmzbPZ9hMaYDdjK4V2iecf6EcEbdUDVUARda2KzO/JtCuDbNQB/iTeL0EG1JSO1jbXS+nLxtPMDPw1fh5+EPrgSEKE/8Gry5A73ui87AmxwdatyMEBCPNOCSKUeRZ2P6Myb5MRvgCHmA9ywsMifU+AYXcB6Xa5GibUC5TSyerxyh0j6QgLVpdyhfArRTTLqQjwe4HOD9s92D4Ap54odXAPBWLAwB02igG5Kkc+piN4lvODIFGAZgT+EO4Si1s7fjSR7vcQETUkRm9O+MXyo9OYhfe4xt9STQ2pcZRLayCV90b4D3jR0DYAfyxJ+eywg2IL7NTMXna7S/RpQ63JhWEM8U41ZyQGjwsVS0QBrEKLu8xwZsbi4wLcCT+OGidPIOCe1PiSc9Qt+go+vYqB7cG+B9d8cAD+WJPz0Am2gxXgU9IneOqDpAAXOsOltVuMzpdakJXrdPCzXiNVUpCeOos5cxnpQT39G+XVLhs1osQVvJKPZyNq8HDwd4d7pNDuWJPxVX7MSzqUDU6gfadKiNlUFTzLeFHHDlzO4kpa7aiKhBPGKwOqxsBAmYkOIpipyXcQSPlRTf+Tii0U3EJGaZsDER2qoB3h2hu0qe+NNwUooYU8y5mILbJe6OuX+2FTKy7bieTDAemaQyQ0CPthljSWO+xmFDIYiESjM5xKd6Ik5lvLq5GrQ3aCMLvmCA9wowLuWJb9xF59hVVP6O0CrBi3ZjZSNOvRy+I6klNVRJYRBaEzdN+imiUXQ8iVF8fsp+W4JXw7WISW7fDh7lptWkCwZ4d7QTXyBPfJMYK7SijjFppGnlIVJBJBYj7eUwtiP1IBXGI1XCsjNpbjENVpSAJ2hq2LTywEly3hUYazt31J8w2+aiLx3g3fohXixPfOMYm6zCGs9LVo9MoW3MCJE7R5u/WsOIjrqBoHUO0bJE9vxBpbhsd3+Nb4/vtPCZ4oZYCitNeYuC/8UDvDvy0qvkiW/cgqNqRyzqSZa/s0mqNGjtKOoTm14zZpUauiQgVfqtQiZjq7Q27JNaSK5ExRcrGCXO1FJYh6jR6CFqK7bZdQZ4t8g0rSlPfP1RdBtqaa9diqtzJkQ9duSryi2brQXbxDwbRUpFMBHjRj8+Nt7GDKgvph9okW7LX47gu0SpGnnFQ1S1lYldOsC7hYteR574ZuKs7Ei1lBsfdz7IZoxzzCVmmVqaSySzQbBVAWDek+N4jh9E/4VqZrJjPwiv9BC1XcvOWgO8275CVyBPvAtTVlDJfZkaZGU7NpqBogAj/xEHkeAuJihWYCxGN6e8+9JtSegFXF1TrhhLGP1fak3pebgPz192/8gB4d/6WT7+GdYnpH7hH/DJzzFiYPn/vjW0SgNpTNuPIZoAEZv8tlGw4+RLxy+ZjnKa5NdFoC7UaW0aduoYse6+bXg1DLg6UfRYwmhGEjqPvF75U558SANrElK/+MdpXvmqBpaXOa/MTZaa1DOcSiLaw9j0NNNst3c+63c7EKTpkvKHzu6bPbP0RkuHAVcbRY8ijP46MIbQeeT1mhA+5PV/inyDdQipf8LTvMXbwvoDy7IruDNVZKTfV4CTSRUYdybUCnGU7KUTDxLgCknqUm5aAW6/1p6eMsOYsphLzsHrE0Y/P5bQedx1F/4yPHnMB3/IOoTU9+BL8PhtjuFKBpZXnYNJxTuv+2XqolKR2UQgHhS5novuxVySJhBNRF3SoKK1XZbbXjVwWNyOjlqWJjrWJIy+P5bQedyldNScP+HZ61xKSK3jyrz+NiHG1hcOLL/+P+PDF2gOkekKGiNWKgJ+8Z/x8Iv4DdQHzcpZyF4v19I27w9/yPGDFQvmEpKtqv/TLiWMfn4sofMm9eAH8Ao0zzh7h4sJqYtxZd5/D7hkYPneDzl5idlzNHcIB0jVlQ+8ULzw/nc5/ojzl2juE0apD7LRnJxe04dMz2iOCFNtGFpTuXA5AhcTRo8mdN4kz30nVjEC4YTZQy4gpC7GlTlrePKhGsKKgeXpCYeO0MAd/GH7yKQUlXPLOasOH3FnSphjHuDvEu4gB8g66oNbtr6eMbFIA4fIBJkgayoXriw2XEDQPJrQeROAlY6aeYOcMf+IVYTU3XFlZufMHinGywaW3YLpObVBAsbjF4QJMsVUSayjk4voPsHJOQfPWDhCgDnmDl6XIRerD24HsGtw86RMHOLvVSHrKBdeVE26gKB5NKHzaIwLOmrqBWJYZDLhASG16c0Tn+CdRhWDgWXnqRZUTnPIHuMJTfLVpkoYy5CzylHVTGZMTwkGAo2HBlkQplrJX6U+uF1wZz2uwS1SQ12IqWaPuO4baZaEFBdukksJmkcTOm+YJSvoqPFzxFA/YUhIvWxcmSdPWTWwbAKVp6rxTtPFUZfKIwpzm4IoMfaYQLWgmlG5FME2gdBgm+J7J+rtS/XBbaVLsR7bpPQnpMFlo2doWaVceHk9+MkyguZNCJ1He+kuHTWyQAzNM5YSUg/GlTk9ZunAsg1qELVOhUSAK0LABIJHLKbqaEbHZLL1VA3VgqoiOKXYiS+HRyaEKgsfIqX64HYWbLRXy/qWoylIV9gudL1OWBNgBgTNmxA6b4txDT4gi3Ri7xFSLxtXpmmYnzAcWDZgY8d503LFogz5sbonDgkKcxGsWsE1OI+rcQtlgBBCSOKD1mtqYpIU8cTvBmAT0yZe+zUzeY92fYjTtGipXLhuR0ePoHk0ofNWBX+lo8Z7pAZDk8mEw5L7dVyZZoE/pTewbI6SNbiAL5xeygW4xPRuLCGbhcO4RIeTMFYHEJkYyEO9HmJfXMDEj/LaH781wHHZEtqSQ/69UnGpzH7LKIAZEDSPJnTesJTUa+rwTepI9dLJEawYV+ZkRn9g+QirD8vF8Mq0jFQ29js6kCS3E1+jZIhgPNanHdHFqFvPJLHqFwQqbIA4jhDxcNsOCCQLDomaL/dr5lyJaJU6FxPFjO3JOh3kVMcROo8u+C+jo05GjMF3P3/FuDLn5x2M04xXULPwaS6hBYki+MrMdZJSgPHlcB7nCR5bJ9Kr5ACUn9jk5kivdd8tk95SOGrtqu9lr2IhK65ZtEl7ZKrp7DrqwZfRUSN1el7+7NJxZbywOC8neNKTch5vsTEMNsoCCqHBCqIPRjIPkm0BjvFODGtto99rCl+d3wmHkW0FPdpZtC7MMcVtGFQjJLX5bdQ2+x9ypdc313uj8xlsrfuLgWXz1cRhZvJYX0iNVBRcVcmCXZs6aEf3RQF2WI/TcCbKmGU3IOoDJGDdDub0+hYckt6PlGu2BcxmhbTdj/klhccLGJMcqRjMJP1jW2ETqLSWJ/29MAoORluJ+6LPffBZbi5gqi5h6catQpmOT7/OFf5UorRpLzCqcMltBLhwd1are3kztrSzXO0LUbXRQcdLh/RdSZ+swRm819REDrtqzC4es6Gw4JCKlSnjYVpo0xeq33PrADbFLL3RuCmObVmPN+24kfa+AojDuM4umKe2QwCf6EN906HwjujaitDs5o0s1y+k3lgbT2W2i7FJdnwbLXhJUBq/9liTctSmFC/0OqUinb0QddTWamtjbHRFuWJJ6NpqZ8vO3fZJ37Db+2GkaPYLGHs7XTTdiFQJ68SkVJFVmY6McR5UycflNCsccHFaV9FNbR4NttLxw4pQ7wJd066Z0ohVbzihaxHVExd/ay04oxUKWt+AsdiQ9OUyZ2krzN19IZIwafSTFgIBnMV73ADj7V/K8u1MaY2sJp2HWm0f41tqwajEvdHWOJs510MaAqN4aoSiPCXtN2KSi46dUxHdaMquar82O1x5jqhDGvqmoE9LfxcY3zqA7/x3HA67r9ZG4O6Cuxu12/+TP+eLP+I+HErqDDCDVmBDO4larujNe7x8om2rMug0MX0rL1+IWwdwfR+p1TNTyNmVJ85ljWzbWuGv8/C7HD/izjkHNZNYlhZcUOKVzKFUxsxxN/kax+8zPWPSFKw80rJr9Tizyj3o1gEsdwgWGoxPezDdZ1TSENE1dLdNvuKL+I84nxKesZgxXVA1VA1OcL49dFlpFV5yJMhzyCmNQ+a4BqusPJ2bB+xo8V9u3x48VVIEPS/mc3DvAbXyoYr6VgDfh5do5hhHOCXMqBZUPhWYbWZECwVJljLgMUWOCB4MUuMaxGNUQDVI50TQ+S3kFgIcu2qKkNSHVoM0SHsgoZxP2d5HH8B9woOk4x5bPkKtAHucZsdykjxuIpbUrSILgrT8G7G5oCW+K0990o7E3T6AdW4TilH5kDjds+H64kS0mz24grtwlzDHBJqI8YJQExotPvoC4JBq0lEjjQkyBZ8oH2LnRsQ4Hu1QsgDTJbO8fQDnllitkxuVskoiKbRF9VwzMDvxHAdwB7mD9yCplhHFEyUWHx3WtwCbSMMTCUCcEmSGlg4gTXkHpZXWQ7kpznK3EmCHiXInqndkQjunG5kxTKEeGye7jWz9cyMR2mGiFQ15ENRBTbCp+Gh86vAyASdgmJq2MC6hoADQ3GosP0QHbnMHjyBQvQqfhy/BUbeHd5WY/G/9LK/8Ka8Jd7UFeNWEZvzPb458Dn8DGLOe3/wGL/4xP+HXlRt+M1PE2iLhR8t+lfgxsuh7AfO2AOf+owWhSZRYQbd622hbpKWKuU+XuvNzP0OseRDa+mObgDHJUSc/pKx31QdKffQ5OIJpt8GWjlgTwMc/w5MPCR/yl1XC2a2Yut54SvOtMev55Of45BOat9aWG27p2ZVORRvnEk1hqWMVUmqa7S2YtvlIpspuF1pt0syuZS2NV14mUidCSfzQzg+KqvIYCMljIx2YK2AO34fX4GWdu5xcIAb8MzTw+j/lyWM+Dw/gjs4GD6ehNgA48kX/AI7XXM/XAN4WHr+9ntywqoCakCqmKP0rmQrJJEErG2Upg1JObr01lKQy4jskWalKYfJ/EDLMpjNSHFEUAde2fltaDgmrNaWQ9+AAb8I5vKjz3L1n1LriB/BXkG/wwR9y/oRX4LlioHA4LzP2inzRx/DWmutRweFjeP3tNeSGlaE1Fde0OS11yOpmbIp2u/jF1n2RRZviJM0yBT3IZl2HWImKjQOxIyeU325b/qWyU9Moj1o07tS0G7qJDoGHg5m8yeCxMoEH8GU45tnrNM84D2l297DQ9t1YP7jki/7RmutRweEA77/HWXOh3HCxkRgldDQkAjNTMl2Iloc1qN5JfJeeTlyTRzxURTdn1Ixv2uKjs12AbdEWlBtmVdk2k7FFwj07PCZ9XAwW3dG+8xKzNFr4EnwBZpy9Qzhh3jDXebBpYcpuo4fQ44u+fD1dweEnHzI7v0xuuOALRUV8rXpFyfSTQYkhd7IHm07jpyhlkCmI0ALYqPTpUxXS+z4jgDj1Pflvmz5ecuItpIBxyTHpSTGWd9g1ApfD/bvwUhL4nT1EzqgX7cxfCcNmb3mPL/qi9SwTHJ49oj5ZLjccbTG3pRmlYi6JCG0mQrAt1+i2UXTZ2dv9IlQpN5naMYtviaXlTrFpoMsl3bOAFEa8sqPj2WCMrx3Yjx99qFwO59Aw/wgx+HlqNz8oZvA3exRDvuhL1jMQHPaOJ0+XyA3fp1OfM3qObEVdhxjvynxNMXQV4+GJyvOEFqeQBaIbbO7i63rpxCltdZShPFxkjM2FPVkn3TG+Rp9pO3l2RzFegGfxGDHIAh8SteR0C4HopXzRF61nheDw6TFN05Ebvq8M3VKKpGjjO6r7nhudTEGMtYM92HTDaR1FDMXJ1eThsbKfywyoWwrzRSXkc51flG3vIid62h29bIcFbTGhfV+faaB+ohj7dPN0C2e2lC96+XouFByen9AsunLDJZ9z7NExiUc0OuoYW6UZkIyx2YUR2z6/TiRjyKMx5GbbjLHvHuf7YmtKghf34LJfx63Yg8vrvN2zC7lY0x0tvKezo4HmGYDU+Gab6dFL+KI761lDcNifcjLrrr9LWZJctG1FfU1uwhoQE22ObjdfkSzY63CbU5hzs21WeTddH2BaL11Gi7lVdlxP1nkxqhnKhVY6knS3EPgVGg1JpN5cP/hivujOelhXcPj8HC/LyI6MkteVjlolBdMmF3a3DbsuAYhL44dxzthWSN065xxUd55Lmf0wRbOYOqH09/o9WbO2VtFdaMb4qBgtFJoT1SqoN8wPXMoXLb3p1PUEhxfnnLzGzBI0Ku7FxrKsNJj/8bn/H8fPIVOd3rfrklUB/DOeO+nkghgSPzrlPxluCMtOnDL4Yml6dK1r3vsgMxgtPOrMFUZbEUbTdIzii5beq72G4PD0DKnwjmBULUVFmy8t+k7fZ3pKc0Q4UC6jpVRqS9Umv8bxw35flZVOU1X7qkjnhZlsMbk24qQ6Hz7QcuL6sDC0iHHki96Uh2UdvmgZnjIvExy2TeJdMDZNSbdZyAHe/Yd1xsQhHiKzjh7GxQ4yqMPaywPkjMamvqrYpmO7Knad+ZQC5msCuAPWUoxrxVhrGv7a+KLXFhyONdTMrZ7ke23qiO40ZJUyzgYyX5XyL0mV7NiUzEs9mjtbMN0dERqwyAJpigad0B3/zRV7s4PIfXSu6YV/MK7+OrYe/JvfGMn/PHJe2fyUdtnFrKRNpXV0Y2559aWPt/G4BlvjTMtXlVIWCnNyA3YQBDmYIodFz41PvXPSa6rq9lWZawZ4dP115HXV/M/tnFkkrBOdzg6aP4pID+MZnTJ1SuuB6iZlyiox4HT2y3YBtkUKWooacBQUDTpjwaDt5poBHl1/HXltwP887lKKXxNUEyPqpGTyA699UqY/lt9yGdlUKra0fFWS+36iylVWrAyd7Uw0CZM0z7xKTOduznLIjG2Hx8cDPLb+OvK6Bv7n1DYci4CxUuRxrjBc0bb4vD3rN5Zz36ntLb83eVJIB8LiIzCmn6SMPjlX+yNlTjvIGjs+QzHPf60Aj62/jrzG8j9vYMFtm1VoRWCJdmw7z9N0t+c8cxZpPeK4aTRicS25QhrVtUp7U578chk4q04Wx4YoQSjFryUlpcQ1AbxZ/XVMknIU//OGl7Q6z9Zpxi0+3yFhSkjUDpnCIUhLWVX23KQ+L9vKvFKI0ZWFQgkDLvBoylrHNVmaw10zwCPrr5tlodfnf94EWnQ0lFRWy8pW9LbkLsyUVDc2NSTHGDtnD1uMtchjbCeb1mpxFP0YbcClhzdLu6lfO8Bj6q+bdT2sz/+8SZCV7VIxtt0DUn9L7r4cLYWDSXnseEpOGFuty0qbOVlS7NNzs5FOGJUqQpl2Q64/yBpZf90sxbE+//PGdZ02HSipCbmD6NItmQ4Lk5XUrGpDMkhbMm2ZVheNYV+VbUWTcv99+2NyX1VoafSuC+AN6q9bFIMv5X/eagNWXZxEa9JjlMwNWb00akGUkSoepp1/yRuuqHGbUn3UdBSTxBU6SEVklzWRUkPndVvw2PrrpjvxOvzPmwHc0hpmq82npi7GRro8dXp0KXnUQmhZbRL7NEVp1uuZmO45vuzKsHrktS3GLWXODVjw+vXXLYx4Hf7njRPd0i3aoAGX6W29GnaV5YdyDj9TFkakje7GHYzDoObfddHtOSpoi2SmzJHrB3hM/XUDDEbxP2/oosszcRlehWXUvzHv4TpBVktHqwenFo8uLVmy4DKLa5d3RtLrmrM3aMFr1183E4sewf+85VWeg1c5ag276NZrM9IJVNcmLEvDNaV62aq+14IAOGFsBt973Ra8Xv11YzXwNfmft7Jg2oS+XOyoC8/cwzi66Dhmgk38kUmP1CUiYWOX1bpD2zWXt2FCp7uq8703APAa9dfNdscR/M/bZLIyouVxqJfeWvG9Je+JVckHQ9+CI9NWxz+blX/KYYvO5n2tAP/vrlZ7+8/h9y+9qeB/Hnt967e5mevX10rALDWK//FaAT5MXdBXdP0C/BAes792c40H+AiAp1e1oH8HgH94g/Lttx1gp63op1eyoM/Bvw5/G/7xFbqJPcCXnmBiwDPb/YKO4FX4OjyCb289db2/Noqicw4i7N6TVtoz8tNwDH+8x/i6Ae7lmaQVENzJFb3Di/BFeAwz+Is9SjeQySpPqbLFlNmyz47z5a/AF+AYFvDmHqibSXTEzoT4Gc3OALaqAP4KPFUJ6n+1x+rGAM6Zd78bgJ0a8QN4GU614vxwD9e1Amy6CcskNrczLx1JIp6HE5UZD/DBHrFr2oNlgG4Odv226BodoryjGJ9q2T/AR3vQrsOCS0ctXZi3ruLlhpFDJYl4HmYtjQCP9rhdn4suySLKDt6wLcC52h8xPlcjju1fn+yhuw4LZsAGUuo2b4Fx2UwQu77uqRHXGtg92aN3tQCbFexc0uk93vhTXbct6y7MulLycoUljx8ngDMBg1tvJjAazpEmOtxlzclvj1vQf1Tx7QlPDpGpqgtdSKz/d9/hdy1vTfFHSmC9dGDZbLiezz7Ac801HirGZsWjydfZyPvHXL/Y8Mjzg8BxTZiuwKz4Eb8sBE9zznszmjvFwHKPIWUnwhqfVRcd4Ck0K6ate48m1oOfrX3/yOtvAsJ8zsPAM89sjnddmuLuDPjX9Bu/L7x7xpMzFk6nWtyQfPg278Gn4Aekz2ZgOmU9eJ37R14vwE/BL8G3aibCiWMWWDQ0ZtkPMnlcGeAu/Ag+8ZyecU5BPuy2ILD+sQqyZhAKmn7XZd+jIMTN9eBL7x95xVLSX4On8EcNlXDqmBlqS13jG4LpmGbkF/0CnOi3H8ETOIXzmnmtb0a16Tzxj1sUvQCBiXZGDtmB3KAefPH94xcUa/6vwRn80GOFyjEXFpba4A1e8KQfFF+259tx5XS4egYn8fQsLGrqGrHbztr+uByTahWuL1NUGbDpsnrwBfePPwHHIf9X4RnM4Z2ABWdxUBlqQ2PwhuDxoS0vvqB1JzS0P4h2nA/QgTrsJFn+Y3AOjs9JFC07CGWX1oNX3T/yHOzgDjwPn1PM3g9Jk9lZrMEpxnlPmBbjyo2+KFXRU52TJM/2ALcY57RUzjObbjqxVw++4P6RAOf58pcVsw9Daje3htriYrpDOonre3CudSe6bfkTEgHBHuDiyu5MCsc7BHhYDx7ePxLjqigXZsw+ijMHFhuwBmtoTPtOxOrTvYJDnC75dnUbhfwu/ZW9AgYd+peL68HD+0emKquiXHhWjJg/UrkJYzuiaL3E9aI/ytrCvAd4GcYZMCkSQxfUg3v3j8c4e90j5ZTPdvmJJGHnOCI2nHS8081X013pHuBlV1gB2MX1YNmWLHqqGN/TWmG0y6clJWthxNUl48q38Bi8vtMKyzzpFdSDhxZ5WBA5ZLt8Jv3895DduBlgbPYAj8C4B8hO68FDkoh5lydC4FiWvBOVqjYdqjiLv92t8yPDjrDaiHdUD15qkSURSGmXJwOMSxWAXYwr3zaAufJ66l+94vv3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/wHuD9tQd4f+0B3l97gPfXHuD9tQd4f+0B3l97gG8LwP8G/AL8O/A5OCq0Ys2KIdv/qOIXG/4mvFAMF16gZD+2Xvu/B8as5+8bfllWyg0zaNO5bfXj6vfhhwD86/Aq3NfRS9t9WPnhfnvCIw/CT8GLcFTMnpntdF/z9V+PWc/vWoIH+FL3Znv57PitcdGP4R/C34avw5fgRVUInCwbsn1yyA8C8zm/BH8NXoXnVE6wVPjdeCI38kX/3+Ct9dbz1pTmHFRu+Hm4O9Ch3clr99negxfwj+ER/DR8EV6B5+DuQOnTgUw5rnkY+FbNU3gNXh0o/JYTuWOvyBf9FvzX663HH/HejO8LwAl8Hl5YLTd8q7sqA3wbjuExfAFegQdwfyDoSkWY8swzEf6o4Qyewefg+cHNbqMQruSL/u/WWc+E5g7vnnEXgDmcDeSGb/F4cBcCgT+GGRzDU3hZYburAt9TEtHgbM6JoxJ+6NMzzTcf6c2bycv2+KK/f+l6LBzw5IwfqZJhA3M472pWT/ajKxnjv4AFnMEpnBTPND6s2J7qHbPAqcMK74T2mZ4VGB9uJA465It+/eL1WKhYOD7xHOkr1ajK7d0C4+ke4Hy9qXZwpgLr+Znm/uNFw8xQOSy8H9IzjUrd9+BIfenYaylf9FsXr8fBAadnPIEDna8IBcwlxnuA0/Wv6GAWPd7dDIKjMdSWueAsBj4M7TOd06qBbwDwKr7oleuxMOEcTuEZTHWvDYUO7aHqAe0Bbq+HEFRzOz7WVoTDQkVds7A4sIIxfCQdCefFRoIOF/NFL1mPab/nvOakSL/Q1aFtNpUb/nFOVX6gzyg/1nISyDfUhsokIzaBR9Kxm80s5mK+6P56il1jXic7nhQxsxSm3OwBHl4fFdLqi64nDQZvqE2at7cWAp/IVvrN6/BFL1mPhYrGMBfOi4PyjuSGf6wBBh7p/FZTghCNWGgMzlBbrNJoPJX2mW5mwZfyRffXo7OFi5pZcS4qZUrlViptrXtw+GQoyhDPS+ANjcGBNRiLCQDPZPMHuiZfdFpPSTcQwwKYdRNqpkjm7AFeeT0pJzALgo7g8YYGrMHS0iocy+YTm2vyRUvvpXCIpQ5pe666TJrcygnScUf/p0NDs/iAI/nqDHC8TmQT8x3NF91l76oDdQGwu61Z6E0ABv7uO1dbf/37Zlv+Zw/Pbh8f1s4Avur6657/+YYBvur6657/+YYBvur6657/+YYBvur6657/+aYBvuL6657/+VMA8FXWX/f8zzcN8BXXX/f8zzcNMFdbf93zP38KLPiK6697/uebtuArrr/u+Z9vGmCusP6653/+1FjwVdZf9/zPN7oHX339dc//fNMu+irrr3v+50+Bi+Zq6697/uebA/jz8Pudf9ht/fWv517J/XUzAP8C/BAeX9WCDrUpZ3/dEMBxgPcfbtTVvsYV5Yn32u03B3Ac4P3b8I+vxNBKeeL9dRMAlwO83959qGO78sT769oB7g3w/vGVYFzKE++v6wV4OMD7F7tckFkmT7y/rhHgpQO8b+4Y46XyxPvrugBeNcB7BRiX8sT767oAvmCA9woAHsoT76+rBJjLBnh3txOvkifeX1dswZcO8G6N7sXyxPvr6i340gHe3TnqVfLE++uKAb50gHcXLnrX8sR7gNdPRqwzwLu7Y/FO5Yn3AK9jXCMGeHdgxDuVJ75VAI8ljP7PAb3/RfjcZfePHBB+79dpfpH1CanN30d+mT1h9GqAxxJGM5LQeeQ1+Tb+EQJrElLb38VHQ94TRq900aMIo8cSOo+8Dp8QfsB8zpqE1NO3OI9Zrj1h9EV78PqE0WMJnUdeU6E+Jjyk/hbrEFIfeWbvId8H9oTRFwdZaxJGvziW0Hn0gqYB/wyZ0PwRlxJST+BOw9m77Amj14ii1yGM/txYQudN0qDzGe4EqfA/5GJCagsHcPaEPWH0esekSwmjRxM6b5JEcZ4ww50ilvAOFxBSx4yLW+A/YU8YvfY5+ALC6NGEzhtmyZoFZoarwBLeZxUhtY4rc3bKnjB6TKJjFUHzJoTOozF2YBpsjcyxDgzhQ1YRUse8+J4wenwmaylB82hC5w0zoRXUNXaRBmSMQUqiWSWkLsaVqc/ZE0aPTFUuJWgeTei8SfLZQeMxNaZSIzbII4aE1Nmr13P2hNHjc9E9guYNCZ032YlNwESMLcZiLQHkE4aE1BFg0yAR4z1h9AiAGRA0jyZ03tyIxWMajMPWBIsxYJCnlITU5ShiHYdZ94TR4wCmSxg9jtB5KyPGYzymAYexWEMwAPIsAdYdV6aObmNPGD0aYLoEzaMJnTc0Ygs+YDw0GAtqxBjkuP38bMRWCHn73xNGjz75P73WenCEJnhwyVe3AEe8TtKdJcYhBl97wuhNAObK66lvD/9J9NS75v17wuitAN5fe4D31x7g/bUHeH/tAd5fe4D3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/w/toDvAd4f/24ABzZ8o+KLsSLS+Pv/TqTb3P4hKlQrTGh+fbIBT0Axqznnb+L/V2mb3HkN5Mb/nEHeK7d4IcDld6lmDW/iH9E+AH1MdOw/Jlu2T1xNmY98sv4wHnD7D3uNHu54WUuOsBTbQuvBsPT/UfzNxGYzwkP8c+Yz3C+r/i6DcyRL/rZ+utRwWH5PmfvcvYEt9jLDS/bg0/B64DWKrQM8AL8FPwS9beQCe6EMKNZYJol37jBMy35otdaz0Bw2H/C2Smc7+WGB0HWDELBmOByA3r5QONo4V+DpzR/hFS4U8wMW1PXNB4TOqYz9urxRV++ntWCw/U59Ty9ebdWbrgfRS9AYKKN63ZokZVygr8GZ/gfIhZXIXPsAlNjPOLBby5c1eOLvmQ9lwkOy5x6QV1j5TYqpS05JtUgUHUp5toHGsVfn4NX4RnMCe+AxTpwmApTYxqMxwfCeJGjpXzRF61nbcHhUBPqWze9svwcHJ+S6NPscKrEjug78Dx8Lj3T8D4YxGIdxmJcwhi34fzZUr7olevZCw5vkOhoClq5zBPZAnygD/Tl9EzDh6kl3VhsHYcDEb+hCtJSvuiV69kLDm+WycrOTArHmB5/VYyP6jOVjwgGawk2zQOaTcc1L+aLXrKeveDwZqlKrw8U9Y1p66uK8dEzdYwBeUQAY7DbyYNezBfdWQ97weEtAKYQg2xJIkuveAT3dYeLGH+ShrWNwZgN0b2YL7qznr3g8JYAo5bQBziPjx7BPZ0d9RCQp4UZbnFdzBddor4XHN4KYMrB2qHFRIzzcLAHQZ5the5ovui94PCWAPefaYnxIdzRwdHCbuR4B+tbiy96Lzi8E4D7z7S0mEPd+eqO3cT53Z0Y8SV80XvB4Z0ADJi/f7X113f+7p7/+UYBvur6657/+YYBvur6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+VMA8FXWX/f8z58OgK+y/rrnf75RgLna+uue//lTA/CV1V/3/M837aKvvv6653++UQvmauuve/7nTwfAV1N/3fM/fzr24Cuuv+75nz8FFnxl9dc9//MOr/8/glixwRuUfM4AAAAASUVORK5CYII="},getSearchTexture:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}}),a.SMAAPass=w,function(){class e extends THREE.Pass{constructor(e,t,i,r){super(),this.sampleRenderTarget=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.sampleRenderTarget.texture.name="SSAARenderPass.sample",this.clearColor=void 0!==i?i:0,this.clearAlpha=void 0!==r?r:0,this.oldClearColor=new THREE.Color,this.sampleLevel=4,this.unbiased=!0,void 0===THREE.CopyShader&&console.error("THREE.SSAARenderPass relies on CopyShader");const n=THREE.CopyShader;this.uniformsCopy=THREE.UniformsUtils.clone(n.uniforms),this.materialCopy=new THREE.ShaderMaterial({uniforms:this.uniformsCopy,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,premultipliedAlpha:!0,transparent:!0,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1}),this.uniforms=THREE.UniformsUtils.clone(n.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1}),this.fsQuad=new THREE.Pass.FullScreenQuad(null)}dispose(){this.sampleRenderTarget&&(this.sampleRenderTarget.dispose(),this.sampleRenderTarget=null),this.fsQuad.dispose(),this.fsQuad=null,this.material.dispose(),this.material=null,this.uniforms=null,this.materialCopy.dispose(),this.materialCopy=null,this.uniformsCopy=null}setSize(e,t){this.sampleRenderTarget&&this.sampleRenderTarget.setSize(e,t)}render(e,t,i){this._sampleRender(e,t,i),this.uniforms.tDiffuse.value=this.sampleRenderTarget.texture,this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}_sampleRender(t,i,r){const n=e.JitterVectors[Math.max(0,Math.min(this.sampleLevel,5))],a=1/n.length,s=this.fsQuad.getCamera(),o=this.sampleRenderTarget.width,l=this.sampleRenderTarget.height;this.fsQuad.material=this.materialCopy,this.uniformsCopy.tDiffuse.value=r.texture;const d=t.autoClear;t.autoClear=!1,t.getClearColor(this.oldClearColor);const h=t.getClearAlpha();t.setRenderTarget(this.sampleRenderTarget);for(let e=0;e<n.length;e++){const i=n[e];s.setViewOffset&&s.setViewOffset(o,l,.0625*i[0],.0625*i[1],o,l);let r=a;if(this.unbiased){r+=.03125*((e+.5)/n.length-.5)}this.uniformsCopy.opacity.value=r,0===e&&(t.setClearColor(0,0),t.clear()),this.fsQuad.render(t)}s.clearViewOffset&&s.clearViewOffset(),t.autoClear=d,t.setClearColor(this.oldClearColor,h)}}e.JitterVectors=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]],a.SSAAPass=e}(),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n    varying vec2 vUv;\n\n    void main() {\n\n      vUv = uv;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n    }",fragmentShader:"\n\n    uniform float opacity;\n\n    uniform sampler2D tDiffuse;\n\n    varying vec2 vUv;\n\n    void main() {\n\n      vec4 texel = texture2D( tDiffuse, vUv );\n      gl_FragColor = opacity * texel;\n\n    }"},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!0};let r=new THREE.Vector2;r=e.getSize(r),(t=new THREE.WebGLRenderTarget(r.width,r.height,i)).texture.name="EffectComposer.rt1",t.texture.encoding=THREE.GammaEncoding}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.renderTarget2.texture.encoding=THREE.sRGBEncoding,this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader),this.renderFirst=!0},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);let t=new THREE.Vector2;t=this.renderer.getSize(t),e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,i,r=!1,n=this.passes.length;for(this.renderFirst=!0,i=0;i<n;i++)if((t=this.passes[i]).renderIndex=i,!1!==t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r,this.renderFirst),this.renderFirst=!1,t.needsSwap){if(r){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?r=!0:t instanceof THREE.ClearMaskPass&&(r=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}}),function(){class e{constructor(e){this.renderer=e,this.composerMix=null,this.composerAdditive=null,this.composerSSAO=null,this.composerSSR=null,this.highlightoutlinePass=null,this.snowPass=null,this.rainPass=null,this.fogPass=null,this.skylinePass=null,this.ssaoPass=null,this.ssrPass=null,this.glowPass=[],this.scanRingPassAry=[],this.fanScanPassAry=[],this.conventionFn=null,this.depthTextureFlg=!1,this.normalTextureFlg=!1,this.metalnessTextureFlg=!1,this.useCompressedNormal=!1,this.useCompressedNormalLast=null}destroy(){this.snowPass.enabled=!1,this.rainPass.enabled=!1,this.fogPass.enabled=!1,this.skylinePass.enabled=!1,this.ssaoPass.enabled=!1,this.ssrPass.enabled=!1,this.highlightoutlinePass.enabled=!1,this.renderer=null,this.composerMix=null,this.composerAdditive=null,this.composerSSAO=null,this.composerSSR=null,this.highlightoutlinePass.dispose(),this.highlightoutlinePass=null,this.snowPass.dispose(),this.snowPass=null,this.rainPass.dispose(),this.rainPass=null,this.ssaoPass.destroy(),this.ssaoPass=null,this.ssrPass.destroy(),this.ssrPass=null;for(var e=0;e<this.scanRingPassAry.length;e++)this.scanRingPassAry[e].dispose();this.scanRingPassAry.length=0;for(let e=0,t=this.fanScanPassAry.length;e<t;e++)this.fanScanPassAry[e].dispose();this.fanScanPassAry.length=0;for(e=0;e<this.glowPass.length;e++)this.glowPass[e].dispose();this.glowPass.length=0,this.fogPass.dispose(),this.fogPass=null,this.skylinePass.dispose(),this.skylinePass=null,this.conventionFn=null,this.autoRenderFlg=!1,null!=this.depthRenderTarget&&this.depthRenderTarget.dispose(),null!=this.transparentDepthRenderTarget&&this.transparentDepthRenderTarget.dispose(),null!=this.normalRenderTarget&&this.normalRenderTarget.dispose(),null!=this.metalnessRenderTarget&&this.metalnessRenderTarget.dispose(),null!=this.normalDepthRenderTarget&&this.normalDepthRenderTarget.dispose(),null!=this.requestAnimationFrameID&&window.cancelAnimationFrame(this.requestAnimationFrameID),null!=this.scene.fog&&(this.scene.fog.setPostProcessMap(null),this.scene.fog.setPostProcessAdditiveMap(null),this.scene.fog.setPostProcessSSAOMap(null)),this.normalDepthMaterial&&(this.normalDepthMaterial.dispose(),this.normalDepthMaterial=null),this.instancedNormalDepthMaterial&&(this.instancedNormalDepthMaterial.dispose(),this.instancedNormalDepthMaterial=null),this.useCompressedNormalLast=null}init(e,t,i){var n=this;n.viewer=e,n.modelManager=e.modelManager,n.scene=e.getScene(),n.camera=e.camera,n.autoRenderFlg=!1,n.selectedGlow={},n.composerMix=new THREE.EffectComposer(n.renderer),n.highlightoutlinePass=new r.OutlineHighLightPass(n),n.composerMix.addPass(n.highlightoutlinePass),n.snowPass=new r.SnowPass(n,n.viewer,t,i),n.composerMix.addPass(n.snowPass),n.rainPass=new r.RainPass(n,n.viewer,t,i),n.composerMix.addPass(n.rainPass),n.fogPass=new r.FogPass(n,n.scene,n.camera,t,i),n.composerMix.addPass(n.fogPass),n.skylinePass=new r.SkylinePass(n,n.scene,n.camera,t,i),n.composerMix.addPass(n.skylinePass),n.composerAdditive=new THREE.EffectComposer(n.renderer),n.composerSSAO=new THREE.EffectComposer(n.renderer),n.composerSSR=new THREE.EffectComposer(n.renderer),n.ssaoPass=new r.GTAOPass(n,n.scene,n.camera,t,i,n.modelManager),n.composerSSAO.addPass(n.ssaoPass),n.ssrPass=new THREE.SSRPass(n,n.scene,n.camera,t,i,n.modelManager),n.composerSSR.addPass(n.ssrPass),n.composerBackground=new THREE.EffectComposer(n.renderer),n.backgroundPass=new r.BackgroundPass(n,n.viewer,n.width,n.height),n.composerBackground.addPass(n.backgroundPass),n.setSize(t,i),n.viewer.shouldUseCompressedNormal()&&(this.useCompressedNormal=!0)}render(){var e=this;if(e.scene.background=null,null!=e.scene.fog){e.scene.fog.setPostProcessAdditiveMap(null),e.scene.fog.setPostProcessSSAOMap(null),e.scene.fog.setPostProcessMap(null),e.normalTextureFlg=!1,e.metalnessTextureFlg=!1,e.depthTextureFlg=!1,e.transparentDepthTextureFlg=!1;var t=e.composerMix.renderer.getRenderTarget();e.composerMix.renderer.setRenderTarget(e.composerMix.readBuffer),e.composerMix.renderer.clear(),e.composerAdditive.renderer.setRenderTarget(e.composerAdditive.readBuffer),e.composerAdditive.renderer.clear(),e.composerSSAO.renderer.setRenderTarget(e.composerSSAO.readBuffer),e.composerSSAO.renderer.clear(),e.composerSSR.renderer.setRenderTarget(e.composerSSR.readBuffer),e.composerSSR.renderer.clear(),e.composerMix.renderer.setRenderTarget(t),e.isAdditiveRoad()&&e.composerAdditive.render(),e.isMixRoad()&&e.composerMix.render(),e.composerSSAO.render(),e.composerSSR.render(),e.composerBackground.render(),e.scene.fog.setViewport(e.composerMix.readBuffer.viewport.z,e.composerMix.readBuffer.viewport.w),e.isAdditiveRoad()&&e.scene.fog.setPostProcessAdditiveMap(e.composerAdditive.readBuffer.texture),e.isMixRoad()&&e.scene.fog.setPostProcessMap(e.composerMix.readBuffer.texture),e.scene.fog.setPostProcessSSAOMap(e.composerSSAO.readBuffer.texture),e.scene.fog.setPostProcessSSRMap(e.composerSSR.readBuffer.texture)}}isMixRoad(){var e=this;return e.rainPass.enabled||e.snowPass.enabled||e.fogPass.enabled||e.skylinePass.enabled||e.highlightoutlinePass.enabled||e.scanRingPassAry.length>0||e.fanScanPassAry.length>0}isAdditiveRoad(){return this.glowPass.length>0}setSize(e,t){var i=this,r=window.devicePixelRatio||1;i.width=e*r,i.height=t*r,null!=i.normalRenderTarget&&i.normalRenderTarget.setSize(i.width,i.height),null!=i.metalnessRenderTarget&&i.metalnessRenderTarget.setSize(i.width,i.height),null!=i.normalDepthRenderTarget&&i.normalDepthRenderTarget.setSize(i.width,i.height),null!=i.depthRenderTarget&&i.depthRenderTarget.setSize(i.width,i.height),null!=i.transparentDepthRenderTarget&&i.transparentDepthRenderTarget.setSize(i.width,i.height),i.composerMix.setSize(i.width,i.height),i.composerAdditive.setSize(i.width,i.height),i.composerBackground.setSize(i.width,i.height),i.composerSSAO.setSize(i.width,i.height)}updateEnabled(){var e=this;e.snowPass.enabled=r.GlobalData.EnableSnowPass,e.fogPass.enabled=r.GlobalData.EnableFogPass,e.rainPass.enabled=r.GlobalData.EnableRainPass,e.skylinePass.enabled=r.GlobalData.EnableSkylinePass,e.ssaoPass.enabled=r.GlobalData.SSAO||r.GlobalData.GTAO,e.ssrPass.enabled=r.GlobalData.SSR,e.highlightoutlinePass.enabled=r.GlobalData.EnableGlow&&r.GlobalData.HighLightOutlineCount>0;for(var t=0;t<e.glowPass.length;t++)e.glowPass[t].enabled=r.GlobalData.EnableGlow||e.glowPass[t].useDiffuse}setHoleTexture(e){var t=this;if(!e)return void(this.normalMaterial.uniforms.isDEM&&(this.normalMaterial.uniforms.isDEM.value=!1));let i=0;t.viewer.holesManager._imageLayerScene.forEach((e=>{if(t.viewer.holesManager.excavationInfo&&t.viewer.holesManager.excavationInfo.length>0){let e=t.viewer.holesManager.excavationInfo[i];i++,e.isExcavation?(this.normalMaterial.uniforms.u_SamplerExcavation&&(this.normalMaterial.uniforms.u_SamplerExcavation.value=e.samplerExcavation),this.normalMaterial.uniforms.u_CullOrthoMatrix&&(this.normalMaterial.uniforms.u_CullOrthoMatrix.value=e.cullOrthoMatrix),this.normalMaterial.uniforms.isDEM&&(this.normalMaterial.uniforms.isDEM.value=!0)):(this.normalMaterial.uniforms.u_SamplerExcavation&&(this.normalMaterial.uniforms.u_SamplerExcavation.value=null),this.normalMaterial.uniforms.u_CullOrthoMatrix&&(this.normalMaterial.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix.identity()),this.normalMaterial.uniforms.isDEM&&(this.normalMaterial.uniforms.isDEM.value=!0))}}))}getNormalTexture(){var e=this;if(null==e.normalMaterial&&(e.normalMaterial=new r.NormalMaterial,e.normalMaterial.blending=THREE.NoBlending,e.normalMaterial.updateCNormalDefines(this.useCompressedNormal)),null==e.normalStandardMaterial&&(e.normalStandardMaterial=new r.InstancedNormalMaterial,e.normalStandardMaterial.blending=THREE.NoBlending,e.normalStandardMaterial.updateCNormalDefines(this.useCompressedNormal)),null==e.normalRenderTarget&&(e.normalRenderTarget=new THREE.WebGLRenderTarget(e.width,e.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})),0==e.normalTextureFlg){var t=e.renderer.autoClear;e.renderer.autoClear=!1;var i=e.renderer.getRenderTarget(),n=!1,a=e.scene.getObjectGroup(r.GlobalData.TilePlaneGroupName);a&&(n=a.visible),this.setHoleTexture(!0);const s=e.modelManager.adjustDemOthersVisibility(!1);e.scene.overrideMaterial=this.normalMaterial,e.renderer.setRenderTarget(e.normalRenderTarget),e.renderer.clear(),e.renderer.render(e.scene,e.camera),e.modelManager.restoreVisibilityByModelIdMap(s),this.setHoleTexture(!1),e.modelManager.adjustDemVisibility(!1),e.modelManager.adjustVisibility(!1),e.modelManager.adjustInstanceVisibility(!1),e.modelManager.changeVisibilityOfSelectedObjects(!1),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.normalMaterial,e.renderer.render(e.scene,e.camera);let o={};const l=e.scene.getExternalCompObjectGroups();l.forEach((e=>{o[e.name]=e.visible,e.visible=!1})),e.modelManager.adjustVisibility(!0),e.modelManager.adjustInstanceVisibility(!1),e.modelManager.changeVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.normalMaterial,e.renderer.render(e.scene,e.camera),e.modelManager.adjustInstanceVisibility(!0),e.modelManager.changeVisibilityOfSelectedObjects(!0),e.modelManager.adjustVisibility(!1),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.normalStandardMaterial,e.renderer.render(e.scene,e.camera),e.scene.overrideMaterial=null,e.renderer.setRenderTarget(i),e.renderer.autoClear=t,e.normalTextureFlg=!0,e.modelManager.adjustVisibility(!0),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!0),e.modelManager.adjustDemVisibility(n),l.forEach((e=>{e.visible=o[e.name]}))}return e.normalRenderTarget.texture}getMetalnessTexture(){var e=this;if(null==e.MetalnessMaterial&&(e.MetalnessMaterial=new r.MetalnessMaterial,e.MetalnessMaterial.blending=THREE.NoBlending,e.MetalnessMaterial.updateCNormalDefines(this.useCompressedNormal),e.MetalnessMaterial.updatePackingMaterialTexture(this.viewer.packingMatTexture)),null==e.metalnessInstancedMaterial&&(e.metalnessInstancedMaterial=new r.InstancedMetalnessMaterial,e.metalnessInstancedMaterial.blending=THREE.NoBlending,e.metalnessInstancedMaterial.updateCNormalDefines(this.useCompressedNormal),e.metalnessInstancedMaterial.updatePackingMaterialTexture(this.viewer.packingMatTexture)),null==e.metalnessRenderTarget&&(e.metalnessRenderTarget=new THREE.WebGLRenderTarget(e.width,e.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})),0==e.metalnessTextureFlg){var t=e.renderer.autoClear;e.renderer.autoClear=!1;var i=e.renderer.getRenderTarget(),n=!1,a=e.scene.getObjectGroup(r.GlobalData.TilePlaneGroupName);a&&(n=a.visible);const s=e.modelManager.adjustDemOthersVisibility(!1);e.scene.overrideMaterial=this.MetalnessMaterial,e.renderer.setRenderTarget(e.metalnessRenderTarget),e.renderer.clear(),e.renderer.render(e.scene,e.camera),e.modelManager.restoreVisibilityByModelIdMap(s),e.modelManager.adjustDemVisibility(!1),e.modelManager.adjustVisibility(!1),e.modelManager.adjustInstanceVisibility(!1),e.modelManager.changeVisibilityOfSelectedObjects(!1),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.MetalnessMaterial,e.renderer.render(e.scene,e.camera);let o={};const l=e.scene.getExternalCompObjectGroups();l.forEach((e=>{o[e.name]=e.visible,e.visible=!1})),e.modelManager.adjustVisibility(!0),e.modelManager.adjustInstanceVisibility(!1),e.modelManager.changeVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.MetalnessMaterial,e.renderer.render(e.scene,e.camera),e.modelManager.adjustInstanceVisibility(!0),e.modelManager.changeVisibilityOfSelectedObjects(!0),e.modelManager.adjustVisibility(!1),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!1),e.scene.overrideMaterial=this.metalnessInstancedMaterial,e.renderer.render(e.scene,e.camera),e.scene.overrideMaterial=null,e.renderer.setRenderTarget(i),e.renderer.autoClear=t,e.metalnessTextureFlg=!0,e.modelManager.adjustVisibility(!0),e.modelManager.changeInstanceVisibilityOfSelectedObjects(!0),e.modelManager.adjustDemVisibility(n),l.forEach((e=>{e.visible=o[e.name]}))}return e.metalnessRenderTarget.texture}getNormalDepthTexture(){var t=this;if(null==t.normalDepthMaterial&&(t.normalDepthMaterial=new r.NormalDepthMaterial,t.normalDepthMaterial.blending=THREE.NoBlending,t.normalDepthMaterial.side=THREE.DoubleSide,t.normalDepthMaterial.updateCNormalDefines(this.useCompressedNormal)),null==t.instancedNormalDepthMaterial&&(t.instancedNormalDepthMaterial=new r.InstancedNormalDepthMaterial,t.instancedNormalDepthMaterial.blending=THREE.NoBlending,t.instancedNormalDepthMaterial.side=THREE.DoubleSide,t.instancedNormalDepthMaterial.updateCNormalDefines(this.useCompressedNormal)),this.useCompressedNormal=t.viewer.shouldUseCompressedNormal(),t.normalDepthMaterial.updateCNormalDefines(this.useCompressedNormal),t.instancedNormalDepthMaterial.updateCNormalDefines(this.useCompressedNormal),t.useCompressedNormalLast!==t.useCompressedNormal&&(t.normalDepthMaterial.needsUpdate=!0,t.instancedNormalDepthMaterial.needsUpdate=!0),t.useCompressedNormalLast=t.useCompressedNormal,null==t.normalDepthRenderTarget){const e=null===t.renderer.extensions.get("OES_texture_float_linear")?THREE.HalfFloatType:THREE.FloatType;t.normalDepthRenderTarget=new THREE.WebGLRenderTarget(t.width,t.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:e,samples:4})}if(0==t.normalTextureFlg){var i=t.renderer.autoClear;t.renderer.autoClear=!1;var n=t.renderer.getRenderTarget();let r=e.storeClipPlanes(t.scene),a=e.storeFillClipPlane(t.scene),s=e.storeClipRegion(t.scene);e.hideClipPlanes(t.scene,r),e.hideFillClipPlane(t.scene,a),e.hideClipRegion(t.scene,s),t.modelManager.holdAllNodeGroupVisibility(),this.normalDepthMaterial.uniforms.viewMatrix.value=t.camera.matrixWorldInverse,this.instancedNormalDepthMaterial.uniforms.viewMatrix.value=t.camera.matrixWorldInverse;const o=2/(Math.log(t.camera.far+1)/Math.LN2);this.normalDepthMaterial.uniforms.logDepthBufFC.value=o,this.instancedNormalDepthMaterial.uniforms.logDepthBufFC.value=o,t.modelManager.adjustVisibility(!0),t.modelManager.adjustInstanceVisibility(!1),t.modelManager.changeVisibilityOfSelectedObjects(!1),t.modelManager.hideAllWireframes(),t.scene.overrideMaterial=this.normalDepthMaterial,t.renderer.setRenderTarget(t.normalDepthRenderTarget),t.renderer.clear(),t.renderer.render(t.scene,t.camera),t.modelManager.adjustInstanceVisibility(!0),t.modelManager.changeVisibilityOfSelectedObjects(!0),t.modelManager.adjustVisibility(!1),t.modelManager.changeInstanceVisibilityOfSelectedObjects(!1),t.modelManager.hideAllWireframes(),t.scene.overrideMaterial=this.instancedNormalDepthMaterial,t.renderer.render(t.scene,t.camera),t.scene.overrideMaterial=null,t.renderer.setRenderTarget(n),t.renderer.autoClear=i,t.normalTextureFlg=!0,t.modelManager.adjustVisibility(!0),t.modelManager.changeInstanceVisibilityOfSelectedObjects(!0),t.modelManager.showAllWireframes(),e.restoreClipPlanes(t.scene,r),e.restoreFillClipPlane(t.scene,a),e.restoreClipRegion(t.scene,s)}return t.normalDepthRenderTarget.texture}getDepthTexture(){var e=this;if(null==e.depthMaterial&&(e.depthMaterial=new r.CustomMeshDepthMaterial,e.depthMaterial.side=THREE.DoubleSide,e.depthMaterial.depthPacking=THREE.RGBADepthPacking,e.depthMaterial.blending=THREE.NoBlending),null==e.InstancedDepthMaterial&&(e.InstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,e.InstancedDepthMaterial.side=THREE.DoubleSide,e.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,e.InstancedDepthMaterial.blending=THREE.NoBlending),null==e.depthRenderTarget&&(e.depthRenderTarget=new THREE.WebGLRenderTarget(e.width,e.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter})),0==e.depthTextureFlg){var t=e.renderer.autoClear;e.renderer.autoClear=!1;let n=!1;const a=e.scene.getObjectGroup(r.ObjectGroupType.RECEIVESHADOWPLANE);a&&(n=a.visible),a&&(a.visible=!1),e.scene.overrideMaterial=e.depthMaterial,e.modelManager.adjustVisibility(!0),e.modelManager.adjustInstanceVisibility(!1),r.DepthRenderPass.adjustClippingPlaneVisibility(e.scene,!1);const s=r.DepthRenderPass.hideInVisibleGroup(e.scene);var i=e.renderer.getRenderTarget();e.renderer.setRenderTarget(e.depthRenderTarget),e.renderer.clear(),e.renderer.render(e.scene,e.camera),e.scene.overrideMaterial=e.InstancedDepthMaterial,e.modelManager.adjustVisibility(!1),e.modelManager.adjustInstanceVisibility(!0),r.DepthRenderPass.restoreInVisibleGroup(e.scene,s),e.renderer.render(e.scene,e.camera),e.renderer.setRenderTarget(i),e.scene.overrideMaterial=null,e.modelManager.adjustVisibility(!0),a&&(a.visible=n),r.DepthRenderPass.adjustClippingPlaneVisibility(e.scene,!0),e.depthTextureFlg=!0,e.renderer.autoClear=t}return e.depthRenderTarget.texture}getTransparentDepthTexture(t=.95){var i=this;if(null==i.transparentDepthMaterial&&(i.transparentDepthMaterial=new r.BatchedDepthMaterial,i.transparentDepthMaterial.side=THREE.DoubleSide,i.transparentDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.transparentDepthMaterial.blending=THREE.NoBlending),null==i.transparentInstancedDepthMaterial&&(i.transparentInstancedDepthMaterial=new r.InstancedDepthMaterial,i.transparentInstancedDepthMaterial.side=THREE.DoubleSide,i.transparentInstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.transparentInstancedDepthMaterial.blending=THREE.NoBlending,i.transparentInstancedDepthMaterial.uniforms.discardAlpha.value=t),null==i.transparentDepthRenderTarget){var n=new THREE.DepthTexture;n.format=THREE.DepthStencilFormat,n.type=THREE.UnsignedInt248Type,n.minFilter=THREE.NearestFilter,n.maxFilter=THREE.NearestFilter,i.transparentDepthRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,depthTexture:n,depthBuffer:!0,stencilBuffer:!1})}if(0==i.transparentDepthTextureFlg){var a=i.renderer.autoClear;i.transparentObjectTemp={},i.transparentObjectVisibleListTemp={},i.transparentCloneObjectTemp=[],e.setTransparentCloneObjectVisible(i.scene,i.camera,!1,i.transparentCloneObjectTemp),e.setTransparentObjectVisible(i.scene,i.camera,t,!1,i.transparentObjectTemp,i.transparentObjectVisibleListTemp);let n=e.storeClipPlanes(i.scene),o=e.storeFillClipPlane(i.scene),l=e.storeClipRegion(i.scene);e.hideClipPlanes(i.scene,n),e.hideFillClipPlane(i.scene,o),e.hideClipRegion(i.scene,l);const d=r.DepthRenderPass.hideInVisibleGroup(i.scene);i.scene.overrideMaterial=i.transparentDepthMaterial,i.modelManager.adjustVisibility(!0),i.modelManager.adjustInstanceVisibility(!1);var s=i.renderer.getRenderTarget();i.renderer.setRenderTarget(i.transparentDepthRenderTarget),i.renderer.clear(),i.renderer.render(i.scene,i.camera),i.scene.overrideMaterial=i.transparentInstancedDepthMaterial,i.modelManager.adjustVisibility(!1),i.modelManager.adjustInstanceVisibility(!0),i.renderer.setRenderTarget(i.transparentDepthRenderTarget),i.renderer.render(i.scene,i.camera),i.renderer.setRenderTarget(s),e.setTransparentCloneObjectVisible(i.scene,i.camera,!0,i.transparentCloneObjectTemp),e.setTransparentObjectVisible(i.scene,i.camera,t,!0,i.transparentObjectTemp,i.transparentObjectVisibleListTemp),e.restoreClipPlanes(i.scene,n),e.restoreFillClipPlane(i.scene,o),e.restoreClipRegion(i.scene,l),i.modelManager.adjustVisibility(!0),r.DepthRenderPass.restoreInVisibleGroup(i.scene,d),i.scene.overrideMaterial=null,i.transparentDepthTextureFlg=!0,i.renderer.autoClear=a}return i.transparentDepthRenderTarget.depthTexture}addRingScanEffect(e){var t=this,i=new r.ScanRingPass(e.id,t,t.viewer,t.width,t.height);return i.setOpts(e),t.composerMix.insertPass(i,t.composerMix.passes.length-1),t.scanRingPassAry.push(i),i}removeRingScanEffect(e){for(var t=this,i=0;i<t.scanRingPassAry.length;i++)if(t.scanRingPassAry[i].id==e){t.scanRingPassAry.splice(i,1);for(var r=0;r<t.composerMix.passes.length;r++)t.composerMix.passes[r].id==e&&(t.composerMix.passes[r].dispose(),t.composerMix.passes.splice(r,1));return!0}return!1}addFanScanEffect(e){const t=this,i=new r.FanScanPass(e.id,t,t.viewer,t.width,t.height);return i.setOpts(e),t.composerMix.insertPass(i,t.composerMix.passes.length-1),t.fanScanPassAry.push(i),i}removeFanScanEffect(e){const t=this;for(let i=0,r=t.fanScanPassAry.length;i<r;i++)if(t.fanScanPassAry[i].id==e){t.fanScanPassAry.splice(i,1);for(let i=0;i<t.composerMix.passes.length;i++)t.composerMix.passes[i].id==e&&(t.composerMix.passes[i].dispose(),t.composerMix.passes.splice(i,1));return!0}return!1}checkRender(e){var t=this;let i=t.viewer.rendererManager.renderer;var r=function(){i._isCameraChanged()&&(i.currentFrameCameraChanged=!0,i.adjustNearFar()),t.render(),t.conventionFn(),t.requestAnimationFrameID=window.requestAnimationFrame(r)};t.snowPass.enabled||t.scanRingPassAry.length>0||t.fanScanPassAry.length>0||t.rainPass.enabled?0==t.autoRenderFlg&&(r(),t.autoRenderFlg=!0):(t.autoRenderFlg=!1,window.cancelAnimationFrame(t.requestAnimationFrameID),t.render(),t.conventionFn())}rainEffectOpt(e){if(null!=this.rainPass)return null==e?this.rainPass.getOpts():void this.rainPass.setOpts(e)}snowEffectOpt(e){if(null!=this.snowPass)return null==e?this.snowPass.getOpts():void this.snowPass.setOpts(e)}ssaoEffectOpt(e){if(null!=this.ssaoPass)return null==e?this.ssaoPass.getOpts():void this.ssaoPass.setOpts(e)}ssrEffectOpt(e){if(null!=this.ssrPass)return null==e?this.ssrPass.getOpts():void this.ssrPass.setOpts(e)}fogEffectOpt(e){if(null!=this.fogPass)return null==e?this.fogPass.getOpts():void this.fogPass.setOpts(e)}skylineOpt(e){if(null!=this.skylinePass)return null==e?this.skylinePass.getOpts():void this.skylinePass.setOpts(e)}addGlowEffect(e){var t=this,i=new r.GlowPass(t,e.useDiffuse);return t.composerAdditive.insertPass(i,t.composerAdditive.passes.length-1),t.glowPass.push(i),i.fillColor=e.fillColor,i.intensity=e.intensity,i.spread=e.spread,i.luminosityThreshold=e.threshold,i}updateGlowEffect(e,t){var i=this;for(var r in i.selectedGlow)if(null!=i.selectedGlow[r][e]&&null!=i.selectedGlow[r][e][t])for(var n=0;n<i.glowPass.length;n++)if(i.glowPass[n].key==r){i.glowPass[n].updateSelectedObjectIds=!0;break}i.highlightoutlinePass&&i.highlightoutlinePass.updateHighLightOutlineById(e,t)}setGlowEffectById(e,t,i){var n=this,a=i.color||new THREE.Color(1,1,1),s=Math.max(Math.min(i.intensity,1),0),o=Math.max(Math.min(i.spread,5),1);let l=null==i.threshold?0:i.threshold;l=Math.max(Math.min(l,1),0);var d,h=a.r+"_"+a.g+"_"+a.b+"_"+s+"_"+o+"_"+l;if(n.removeGlowEffectById(e,t,i.useDiffuse),null==n.selectedGlow[h])n.selectedGlow[h]={},(d=n.addGlowEffect({fillColor:a,intensity:s,spread:o,useDiffuse:null!=i.useDiffuse&&i.useDiffuse,threshold:l})).key=h;else for(var c=0;c<n.glowPass.length;c++)if(n.glowPass[c].key==h){d=n.glowPass[c];break}n.selectedGlow[h][e]||(n.selectedGlow[h][e]=new Map);c=0;for(var u=t.length;c<u;c++)i.useDiffuse?r.GlobalData.BloomCount++:r.GlobalData.GlowCount++,n.selectedGlow[h][e].set(t[c],!0);d.selectedObjectIds=n.selectedGlow[h],d.updateSelectedObjectIds=!0}_removeGlowPassByKey(e){for(var t=this,i=0;i<t.glowPass.length;i++)if(t.glowPass[i].key==e){t.glowPass.splice(i,1);for(var r=0;r<t.composerAdditive.passes.length;r++)t.composerAdditive.passes[r].key==e&&(t.composerAdditive.passes[r].dispose(),t.composerAdditive.passes.splice(r,1));return!0}return!1}removeGlowEffectById(e,t){var i=this;for(var n in i.selectedGlow)if(null!=i.selectedGlow[n][e]){for(var a,s=0;s<i.glowPass.length;s++)if(i.glowPass[s].key==n){a=i.glowPass[s];break}var o=i.selectedGlow[n][e];let h=a.useDiffuse;if(null==t){var l=o.size;h?r.GlobalData.BloomCount-=l:r.GlobalData.GlowCount-=l,o=new Map}else for(var d=0;d<t.length;d++)o.has(t[d])&&(h?r.GlobalData.BloomCount--:r.GlobalData.GlowCount--,o.delete(t[d]),null!=a&&(a.updateSelectedObjectIds=!0));0==o.size&&delete i.selectedGlow[n][e],0==Object.keys(i.selectedGlow[n]).length&&(i._removeGlowPassByKey(n),delete i.selectedGlow[n])}}applyGlowEffectByModel(e,t){if(0!==this.glowPass.length)for(let i=0;i<this.glowPass.length;i++){const r=this.glowPass[i].selectedObjectIds[e.id];if(!r)return;for(const n of r.keys()){const r=e.tilesLoader.tileReader.getIndexByUserId(n);if(t.userIndexMap.has(r)){this.glowPass[i].updateSelectedObjectIds=!0;break}}}}}e.setTransparentObjectVisible=(t,i,r,n,a,s)=>{if(t.layers.test(i.layers))if(t.isImmediateRenderObject){const e=t.material;e.transparent&&e.opacity<r&&(t.visible=n)}else if(t.isMesh||t.isLine||t.isPoints){const e=t.material,i=t.databagId+"_"+t.uuid;if(Array.isArray(e)&&null!=t.geometry&&null!=t.geometry.groups){const s=t.geometry.groups;if(0==n&&s.length>0)for(let n=s.length-1;n>=0;n--){let o=s[n].materialIndex;o<0&&(o=Math.abs(2+o)),(e[o]&&e[o].transparent&&e[o].opacity<r||0==t.visible)&&(null==a[i]&&(a[i]=[]),a[i].push(s[n]),s.splice(n,1))}else if(n&&null!=a[i]&&a[i].length>0)for(let e=a[i].length-1;e>=0;e--)s.push(a[i][e]),a[i].splice(e,1)}}for(var o=t.children,l=0,d=o.length;l<d;l++)e.setTransparentObjectVisible(o[l],i,r,n,a,s)},e.hideClipPlanes=(e,t)=>{null!=e.clipPlanes&&!1!==t.enable&&e.clipPlanes.enable(t.enable,!1)},e.storeClipPlanes=e=>null!=e.clipPlanes?e.clipPlanes.store():null,e.restoreClipPlanes=(e,t)=>{null!=e.clipPlanes&&!1!==t.enable&&e.clipPlanes.enable(t.enable,t.visible)},e.hideFillClipPlane=(e,t)=>{null!=e.fillClipPlane&&!1!==t.isEnable&&e.fillClipPlane.enable(t.enable,!1)},e.storeFillClipPlane=e=>{if(null!=e.fillClipPlane){return{enable:e.fillClipPlane.isEnabled(),visible:e.fillClipPlane.visible}}return null},e.restoreFillClipPlane=(e,t)=>{null!=e.fillClipPlane&&!1!==t.isEnable&&e.fillClipPlane.enable(t.enable,t.visible)},e.hideClipRegion=e=>{e.clipRegion&&(e.clipRegion.visible=!1)},e.storeClipRegion=e=>{if(e.clipRegion){return{visible:e.clipRegion.visible}}return null},e.restoreClipRegion=(e,t)=>{e.clipRegion&&(e.clipRegion.visible=t.visible)},e.setTransparentCloneObjectVisible=(t,i,r,n)=>{if(t.layers.test(i.layers)&&(t.isMesh||t.isLine||t.isPoints)){t.material,t.databagId,t.uuid;if(0==r)null!=t.sourceMesh&&(t.visible&&n.push(t),t.sourceMesh.visible&&n.push(t.sourceMesh),t.visible=!1,t.sourceMesh.visible=!1);else for(let e=n.length-1;e>=0;e--)n[e].visible=!0,n.splice(e,1)}for(var a=t.children,s=0,o=a.length;s<o;s++)e.setTransparentCloneObjectVisible(a[s],i,r,n)},e.SetLineObjectVisible=(t,i,r,n)=>{t.layers.test(i.layers)&&t.isLine&&(n[t.id]=t.visible,t.visible=r);for(var a=t.children,s=0,o=a.length;s<o;s++)e.SetLineObjectVisible(a[s],i,r,n)},e.RestoreLineObjectVisible=(t,i,r)=>{t.layers.test(i.layers)&&t.isLine&&(t.visible=r[t.id]);for(var n=t.children,a=0,s=n.length;a<s;a++)e.RestoreLineObjectVisible(n[a],i,r)},r.RenderEffectComposer=e}(),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,i,r,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.SSAOPass=function(e,t,i,n,a,s){var o=this;THREE.Pass.call(o),o.KERNEL_SIZE=32,o.shader=THREE.SSAOShader,o.uniforms=THREE.UniformsUtils.clone(o.shader.uniforms),o.material=new THREE.ShaderMaterial({defines:o.shader.defines||{},uniforms:o.uniforms,vertexShader:o.shader.vertexShader,fragmentShader:o.shader.fragmentShader}),o.renderComposer=e,o.sceneCamera=i,o.mainScene=t,o.modelManager=s,o.width=n,o.height=a,o.oldClearColor=new THREE.Color,o.oldClearAlpha=1,o.minDistance=3e-4,o.maxDistance=8e-4,o.kernelRadius=.5,o.blurKernelRadius=4,o.blurMaxRadius=10,o.blurDirectionX=new THREE.Vector2(1,0),o.blurDirectionY=new THREE.Vector2(0,1),o.blurDirectionXY=new THREE.Vector2(1,1),o.blurDirectionXY2=new THREE.Vector2(-1,-1),o.createOverlayMaterial(),o.renderTarget=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!0}),o.renderTarget.texture.name="SSAO.renderpass",o.enabled=!1,o.uniforms.tNoise.value=o.generateRandomKernelRotations(),o.uniforms.kernel.value=o.generateSampleKernel(),o.uniforms.minDistance.value=o.minDistance,o.uniforms.maxDistance.value=o.maxDistance,o.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),o.scene=new THREE.Scene,o.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),o.quad.frustumCulled=!1,o.scene.add(o.quad),o.renderTargetSSAOBuffer=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetSSAOBuffer.texture.name="SSAOPass.edge",o.renderTargetSSAOBuffer.texture.generateMipmaps=!1,o.separableBlurMaterial=new THREE.ShaderMaterial(r.SeperableBlurShader),o.blurMaterial=new THREE.ShaderMaterial({defines:Object.assign({},r.SSAOBlurShader.defines),uniforms:THREE.UniformsUtils.clone(r.SSAOBlurShader.uniforms),vertexShader:r.SSAOBlurShader.vertexShader,fragmentShader:r.SSAOBlurShader.fragmentShader}),o.renderTargetBlurBuffer=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer.texture.name="SSAOPass.blur",o.renderTargetBlurBuffer.texture.generateMipmaps=!1,o.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer1.texture.name="SSAOPass.blur1",o.renderTargetBlurBuffer1.texture.generateMipmaps=!1,o.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer2.texture.name="SSAOPass.blur2",o.renderTargetBlurBuffer2.texture.generateMipmaps=!1,o.renderTargetBlurBuffer3=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer3.texture.name="SSAOPass.blur3",o.renderTargetBlurBuffer3.texture.generateMipmaps=!1,o.renderTargetBlurBuffer4=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer4.texture.name="SSAOPass.blur4",o.renderTargetBlurBuffer4.texture.generateMipmaps=!1},THREE.SSAOPass.prototype=Object.create(THREE.ShaderPass.prototype),THREE.SSAOPass.prototype.generateSampleKernel=function(){for(var e,t=[],i=0;i<this.KERNEL_SIZE;i++){var r=new THREE.Vector3;r.x=2*Math.random()-1,r.y=2*Math.random()-1,r.z=Math.random()/4,r.normalize();var n=i/this.KERNEL_SIZE;n=(1-(e=n*n))*.15+e*1,r.multiplyScalar(n),t.push(r)}return t},THREE.SSAOPass.prototype.setOpts=function(e){var t=this;e&&(void 0!==e.minDistance&&null!==e.minDistance&&(t.minDistance=e.minDistance),void 0!==e.maxDistance&&null!==e.maxDistance&&(t.maxDistance=e.maxDistance),void 0!==e.kernelRadius&&null!==e.kernelRadius&&(t.kernelRadius=e.kernelRadius),void 0!==e.blurKernelRadius&&null!==e.blurKernelRadius&&(t.blurKernelRadius=e.blurKernelRadius),void 0!==e.blurMaxRadius&&null!==e.blurMaxRadius&&(t.blurMaxRadius=e.blurMaxRadius))},THREE.SSAOPass.prototype.generateRandomKernelRotations=function(){for(var e=new Float32Array(64),t=0;t<16;t++){var i=4*t;e[i]=2*Math.random()-1,e[i+1]=2*Math.random()-1,e[i+2]=2*Math.random()-1,e[i+3]=1}var r=new THREE.DataTexture(e,4,4,THREE.RGBAFormat,THREE.FloatType);return r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.needsUpdate=!0,r},THREE.SSAOPass.prototype.render=function(e,t,i,r,n){var a=this,s=e.getRenderTarget();e.setRenderTarget(a.renderTarget),e.clear(),e.render(a.mainScene,a.sceneCamera),e.getClearColor(a.oldClearColor),a.oldClearAlpha=e.getClearAlpha();var o=e.autoClear;e.setClearColor(0,0),e.autoClear=!1,a.uniforms.minDistance.value=a.minDistance,a.uniforms.maxDistance.value=a.maxDistance,a.uniforms.kernelRadius.value=a.kernelRadius,a.uniforms.tDepth.value=a.renderComposer.getDepthTexture(),a.uniforms.tNormal.value=a.renderComposer.getNormalTexture(),a.setCameraUniforms(a.sceneCamera),a.uniforms.logDepthBufFC.value=2/(Math.log(a.sceneCamera.far+1)/Math.LN2),a.uniforms.viewport.value.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight),a.quad.material=a.material,e.setRenderTarget(a.renderTargetSSAOBuffer),e.clear(),e.render(a.scene,a.camera),a.quad.material=a.blurMaterial,a.blurMaterial.uniforms.tDiffuse.value=a.renderTargetSSAOBuffer.texture,e.setRenderTarget(a.renderTargetBlurBuffer),e.clear(),e.render(a.scene,a.camera),a.quad.material=a.separableBlurMaterial,a.separableBlurMaterial.uniforms.kernelRadius.value=a.blurKernelRadius,a.separableBlurMaterial.defines.MAX_RADIUS=a.blurMaxRadius,a.separableBlurMaterial.uniforms.colorTexture.value=a.renderTargetSSAOBuffer.texture,a.separableBlurMaterial.uniforms.direction.value=a.blurDirectionX,e.setRenderTarget(a.renderTargetBlurBuffer1),e.clear(),e.render(a.scene,a.camera),a.separableBlurMaterial.uniforms.colorTexture.value=a.renderTargetBlurBuffer1.texture,a.separableBlurMaterial.uniforms.direction.value=a.blurDirectionY,e.setRenderTarget(a.renderTargetBlurBuffer2),e.clear(),e.render(a.scene,a.camera),a.separableBlurMaterial.uniforms.colorTexture.value=a.renderTargetBlurBuffer2.texture,a.separableBlurMaterial.uniforms.direction.value=a.blurDirectionXY,e.setRenderTarget(a.renderTargetBlurBuffer3),e.clear(),e.render(a.scene,a.camera),a.separableBlurMaterial.uniforms.colorTexture.value=a.renderTargetBlurBuffer3.texture,a.separableBlurMaterial.uniforms.direction.value=a.blurDirectionXY2,e.setRenderTarget(a.renderTargetBlurBuffer4),e.clear(),e.render(a.scene,a.camera),a.scene.overrideMaterial=a.overlayMaterial,a.overlayMaterial.uniforms.edgeTexture1.value=a.renderTargetBlurBuffer.texture,a.overlayMaterial.uniforms.edgeTexture2.value=a.renderTargetBlurBuffer4.texture,a.overlayMaterial.uniforms.maskTexture.value=a.renderTarget.texture,e.setRenderTarget(t),e.clear(),e.render(a.scene,a.camera),a.scene.overrideMaterial=null,e.setClearColor(a.oldClearColor,a.oldClearAlpha),e.autoClear=o,e.setRenderTarget(s)},THREE.SSAOPass.prototype.setCameraUniforms=function(e){var t=this;t.sceneCamera=e,t.uniforms.cameraNear.value=t.sceneCamera.near,t.uniforms.cameraFar.value=t.sceneCamera.far,t.uniforms.cameraProjection.value.copy(t.sceneCamera.projectionMatrix),t.uniforms.inverseProjection.value.copy(t.sceneCamera.projectionMatrix).invert()},THREE.SSAOPass.prototype.setSize=function(e,t){var i=this;i.width=e,i.height=t,i.renderTarget.setSize(i.width,i.height),i.renderTargetSSAOBuffer.setSize(i.width,i.height),i.renderTargetBlurBuffer.setSize(i.width,i.height),i.renderTargetBlurBuffer1.setSize(i.width,i.height),i.renderTargetBlurBuffer2.setSize(i.width,i.height),i.renderTargetBlurBuffer3.setSize(i.width,i.height),i.renderTargetBlurBuffer4.setSize(i.width,i.height),i.uniforms.resolution.value.set(i.width,i.height),i.separableBlurMaterial.uniforms.texSize.value.set(i.width,i.height),i.blurMaterial.uniforms.resolution.value.set(i.width,i.height)},THREE.SSAOPass.prototype.createOverlayMaterial=function(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},edgeTexture3:{value:null}},vertexShader:"\n            varying vec2 vUv;\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t}\n\t\t",fragmentShader:"\n            varying vec2 vUv;\n            uniform sampler2D maskTexture;\n            uniform sampler2D edgeTexture1;\n            uniform sampler2D edgeTexture2;\n            #include <postprocess_minus_color>\n            void main() {\n                vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n                vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n                vec4 maskColor = texture2D(maskTexture, vUv);\n\n                vec4 color = maskColor;\n                color *= vec4(vec3(1.0 - edgeValue1.r),1.0);\n                color *= vec4(vec3(1.0 - edgeValue2.r),1.0);\n                gl_FragColor = postprocess_minus_color(color.rgb, maskColor.rgb);\n\t\t\t}\n\t\t"})},function(){class e extends THREE.Pass{constructor(e,t,i,r,n,a){super();var s=this;s.width=void 0!==r?r:512,s.height=void 0!==n?n:512,s.clear=!0,s.scene=t,s.camera=i,s.renderComposer=e,s.sceneCamera=i,s.mainScene=t,s.modelManager=a,s.addedRMStep=THREE.SSRShader.uniforms.addedRMStep.value,s.opacity=THREE.SSRShader.uniforms.opacity.value,s.maxDistance=THREE.SSRShader.uniforms.maxDistance.value,s.thickness=THREE.SSRShader.uniforms.thickness.value,s.tempColor=new THREE.Color,s._bouncing=!1,this.blur=!0,this._distanceAttenuation=THREE.SSRShader.defines.DISTANCE_ATTENUATION,Object.defineProperty(this,"distanceAttenuation",{get(){return this._distanceAttenuation},set(e){this._distanceAttenuation!==e&&(this._distanceAttenuation=e,this.ssrMaterial.defines.DISTANCE_ATTENUATION=e,this.ssrMaterial.needsUpdate=!0)}}),this._fresnel=THREE.SSRShader.defines.FRESNEL,Object.defineProperty(this,"fresnel",{get(){return this._fresnel},set(e){this._fresnel!==e&&(this._fresnel=e,this.ssrMaterial.defines.FRESNEL=e,this.ssrMaterial.needsUpdate=!0)}}),this._infiniteThick=THREE.SSRShader.defines.INFINITE_THICK,Object.defineProperty(this,"infiniteThick",{get(){return this._infiniteThick},set(e){this._infiniteThick!==e&&(this._infiniteThick=e,this.ssrMaterial.defines.INFINITE_THICK=e,this.ssrMaterial.needsUpdate=!0)}}),this.createOverlayMaterial();const o=new THREE.DepthTexture;o.type=THREE.FloatType,o.minFilter=THREE.NearestFilter,o.magFilter=THREE.NearestFilter,this.beautyRenderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,depthTexture:o,depthBuffer:!0}),s.beautyRenderTarget.texture.name="SSR.renderpass",this.enabled=!1,this.ssrRenderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter}),this.blurRenderTarget=this.ssrRenderTarget.clone(),this.blurRenderTarget2=this.ssrRenderTarget.clone(),void 0===THREE.SSRShader&&console.error("THREE.SSRPass: The pass relies on THREE.SSRShader."),this.ssrMaterial=new THREE.ShaderMaterial({defines:Object.assign({},THREE.SSRShader.defines,{MAX_STEP:Math.sqrt(this.width*this.width+this.height*this.height)}),uniforms:THREE.UniformsUtils.clone(THREE.SSRShader.uniforms),vertexShader:THREE.SSRShader.vertexShader,fragmentShader:THREE.SSRShader.fragmentShader,blending:THREE.NoBlending}),this.blurMaterial=new THREE.ShaderMaterial({defines:Object.assign({},THREE.SSRBlurShader.defines),uniforms:THREE.UniformsUtils.clone(THREE.SSRBlurShader.uniforms),vertexShader:THREE.SSRBlurShader.vertexShader,fragmentShader:THREE.SSRBlurShader.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.blurMaterial2=new THREE.ShaderMaterial({defines:Object.assign({},THREE.SSRBlurShader.defines),uniforms:THREE.UniformsUtils.clone(THREE.SSRBlurShader.uniforms),vertexShader:THREE.SSRBlurShader.vertexShader,fragmentShader:THREE.SSRBlurShader.fragmentShader}),this.blurMaterial2.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.blurMaterial2.uniforms.resolution.value.set(this.width,this.height),this.fsQuad=new THREE.Pass.FullScreenQuad(null),this.originalClearColor=new THREE.Color}destroy(){this.beautyRenderTarget.dispose(),this.ssrRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.blurRenderTarget2.dispose(),this.blurMaterial.dispose(),this.blurMaterial2.dispose(),this.fsQuad.dispose()}setOpts(e){var t=this;e&&(void 0!==e.distanceAttenuation&&null!==e.distanceAttenuation&&(t.distanceAttenuation=e.distanceAttenuation),void 0!==e.maxDistance&&null!==e.maxDistance&&(t.maxDistance=e.maxDistance),void 0!==e.fresnel&&null!==e.fresnel&&(t.fresnel=e.fresnel),void 0!==e.infiniteThick&&null!==e.infiniteThick&&(t.infiniteThick=e.infiniteThick),void 0!==e.thickness&&null!==e.thickness&&(t.thickness=e.thickness),null!=e.opacity&&null!=e.opacity&&(t.opacity=e.opacity),null!=e.addedRMStep&&null!=e.addedRMStep&&(t.addedRMStep=e.addedRMStep),t.maxDistance<0&&(maxDistance=0),t.thickness<0&&(t.thickness=0),t.addedRMStep<0&&(t.addedRMStep=0),t.addedRMStep>2&&(t.addedRMStep=2),t.opacity<0&&(t.opacity=0))}getOpts(){var e=this;return{distanceAttenuation:e.distanceAttenuation,maxDistance:e.maxDistance,fresnel:e.fresnel,infiniteThick:e.infiniteThick,thickness:e.thickness,opacity:e.opacity,addedRMStep:e.addedRMStep}}setUniforms(){this.ssrMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssrMaterial.uniforms.tNormal.value=this.renderComposer.getMetalnessTexture(),this.ssrMaterial.needsUpdate=!0,this.ssrMaterial.uniforms.tMetalness.value=this.renderComposer.getMetalnessTexture(),this.ssrMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.ssrMaterial.uniforms.cameraNear.value=this.camera.near,this.ssrMaterial.uniforms.cameraFar.value=this.camera.far,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.ssrMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.ssrMaterial.uniforms.opacity.value=this.opacity,this.ssrMaterial.uniforms.maxDistance.value=this.maxDistance,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.ssrMaterial.uniforms.opacity.value=this.opacity,this.ssrMaterial.uniforms.addedRMStep.value=this.addedRMStep}updateDefines(){var e=this;e._distanceAttenuation?this.ssrMaterial.defines.DISTANCE_ATTENUATION="":delete this.ssrMaterial.defines.DISTANCE_ATTENUATION,e._infiniteThick?this.ssrMaterial.defines.INFINITE_THICK="":delete this.ssrMaterial.defines.INFINITE_THICK,e._fresnel?this.ssrMaterial.defines.FRESNEL="":delete this.ssrMaterial.defines.FRESNEL}render(e,t){var i=this;let n=!1;const a=this.mainScene.getObjectGroup(r.GlobalData.TilePlaneGroupName);a&&(n=a.visible);let s=!1,o=this.mainScene.getOrCreateObjectGroup(r.ObjectGroupType.CONTACTSHADOW);o&&(s=o.visible);let l={};const d=this.mainScene.getExternalCompObjectGroups();d.forEach((e=>{l[e.name]=e.visible,e.visible=!1})),this.modelManager.adjustDemVisibility(!1),o&&(o.visible=!1);const h=r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._getNodeGroupVisible();r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setNodeGroupVisible(!1);const c=r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._getAlphaTestNodeGroupVisible();r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setAlphaTestNodeGroupVisible(!1);const[u,p]=this.modelManager.classifyGISModels();let m={};u.forEach((e=>{m[e.id]=e.getObjectGroup().visible,e.getObjectGroup().visible=!1}));e.autoClear;var f=e.getRenderTarget();e.setRenderTarget(i.beautyRenderTarget),e.clear();var g=r.GlobalData.DrawingStyle;this.modelManager.viewer.setDrawingStyle(r.DrawingStyle.SHADING),e.render(i.scene,i.camera),this.modelManager.viewer.setDrawingStyle(g),i.setUniforms(),i.updateDefines(),this.renderPass(e,this.ssrMaterial,this.ssrRenderTarget),this.blur&&(this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.renderPass(e,this.blurMaterial2,this.blurRenderTarget2)),this.scene.overrideMaterial=this.overlayMaterial,this.overlayMaterial.uniforms.ssrTexture.value=i.blurRenderTarget2.texture,e.setRenderTarget(t),e.clear(),this.fsQuad.material=this.overlayMaterial,this.fsQuad.render(e),this.scene.overrideMaterial=null,e.setRenderTarget(f),this.modelManager.adjustDemVisibility(n),o&&(o.visible=s),r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setNodeGroupVisible(h),r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setAlphaTestNodeGroupVisible(c),u.forEach((e=>{e.getObjectGroup().visible=m[e.id]})),d.forEach((e=>{e.visible=l[e.name]}))}renderPass(e,t,i,r,n){this.originalClearColor.copy(e.getClearColor(this.tempColor));const a=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(i),e.autoClear=!1,null!=r&&(e.setClearColor(r),e.setClearAlpha(n||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}setSize(e,t){this.width=e,this.height=t,this.ssrMaterial.defines.MAX_STEP=Math.sqrt(e*e+t*t),this.ssrMaterial.needsUpdate=!0,this.beautyRenderTarget.setSize(e,t),this.ssrRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.blurRenderTarget2.setSize(e,t),this.ssrMaterial.uniforms.resolution.value.set(e,t),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t),this.blurMaterial2.uniforms.resolution.value.set(e,t)}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{ssrTexture:{value:null}},vertexShader:"\n            varying vec2 vUv;\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t}\n\t\t",fragmentShader:"\n            varying vec2 vUv;\n\t\t\tuniform sampler2D ssrTexture;\n\t\t\t#include <packing>\n\t\t\t#include <logdepthbuf_pars_fragment>\n\t\t\t#include <depth_parse_fragment>\n            #include <postprocess_minus_color>\n            void main() {\n                vec4 ssrColor = texture2D(ssrTexture, vUv);\n\t\t\t\t\n                gl_FragColor = ssrColor;//vec4(color.xyz, 1.0);\n\t\t\t\tgl_FragColor.rgb =  ssrColor.rgb;// * ssrColor.a;\n\t\t\t\t// float fDepth = unpackRGBAToDepth(color);\n\t\t\t\t// gl_FragColor.rgb = vec3(fDepth);\n\t\t\t}\n\t\t"})}}THREE.SSRPass=e}(),function(){const e=0,t=1,i=2;class n extends THREE.Pass{constructor(e,n,a,s,o,l){super(),this.shader=r.GTAOShader,this.uniforms=THREE.UniformsUtils.clone(this.shader.uniforms),this.material=new THREE.ShaderMaterial({defines:this.shader.defines||{},uniforms:this.uniforms,vertexShader:this.shader.vertexShader,fragmentShader:this.shader.fragmentShader}),this.renderComposer=e,this.sceneCamera=a,this.mainScene=n,this.modelManager=l,this.width=s,this.height=o,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this._8x8_2D_LIST=[],this._4x4=[9/16,9/16,.125,.75,.75,7/16,.5,1/16,.8125,.6875,1/16,0,.6875,3/16,5/16,.625,.375,.875,.25,.125,0,.5,.875,.9375,3/16,.375,.9375,.25,7/16,5/16,.625,.8125],this.kernelRadius=17;let d=(e,t)=>{let i,r,n;for(i=0,r=1/e,n=t;n>0;n=Math.floor(n/e))i+=r*(n%e),r/=e;return i};for(let e=0;e<64;++e){let t=d(2,e)*Math.PI,i=d(3,e);this._8x8_2D_LIST[e]=[];for(let r=Math.cos(t),n=Math.sin(t),a=0;a<8;++a){let t=(a+i+.125*Math.random())/8;this._8x8_2D_LIST[e][a]=new THREE.Vector2(r*t,n*t)}}this.swapRenderTargets=[new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat})],this.swapRenderTargets[0].texture.name="pipeline-AO1",this.swapRenderTargets[0].texture.generateMipmaps=!1,this.swapRenderTargets[1].texture.name="pipeline-AO1",this.swapRenderTargets[1].texture.generateMipmaps=!1,this.createOverlayMaterial(),this.renderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!0}),this.renderTarget.texture.name="GTAO.RenderPass",this.enabled=!1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.renderTargetGTAOBuffer=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.renderTargetGTAOBuffer.texture.name="GTAOPass.edge",this.renderTargetGTAOBuffer.texture.generateMipmaps=!1,this.blurMaterialX=new THREE.ShaderMaterial({defines:Object.assign({},r.GTAOBlurShaderX.defines),uniforms:THREE.UniformsUtils.clone(r.GTAOBlurShaderX.uniforms),vertexShader:r.GTAOBlurShaderX.vertexShader,fragmentShader:r.GTAOBlurShaderX.fragmentShader}),this.blurMaterialY=new THREE.ShaderMaterial({defines:Object.assign({},r.GTAOBlurShaderY.defines),uniforms:THREE.UniformsUtils.clone(r.GTAOBlurShaderY.uniforms),vertexShader:r.GTAOBlurShaderY.vertexShader,fragmentShader:r.GTAOBlurShaderY.fragmentShader}),this.accumulateMaterial=new THREE.ShaderMaterial({defines:Object.assign({},r.GTAOAccumulate.defines),uniforms:THREE.UniformsUtils.clone(r.GTAOAccumulate.uniforms),vertexShader:r.GTAOAccumulate.vertexShader,fragmentShader:r.GTAOAccumulate.fragmentShader}),this.renderTargetBlurBuffer=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.renderTargetBlurBuffer.texture.name="GTAOPass.blur",this.renderTargetBlurBuffer.texture.generateMipmaps=!1,this.renderState=t,this.updateRenderState=e=>{e&&!0===e.onlyFrustumChanged||(this.renderState=t,l.setRenderStateChanged(!0))},this.stopUpdateRenderState=e=>{e&&!0===e.onlyFrustumChanged||(this.renderState=i)};const h=l.viewer;h.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED,this.stopUpdateRenderState),h.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_END,this.updateRenderState),h.registerEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.updateRenderState),h.registerEventListener(r.EVENTS.ON_CLIP_PLANE_MOUSE_MOVE,this.stopUpdateRenderState),h.registerEventListener(r.EVENTS.ON_CLIP_MOUSE_MOVE,this.stopUpdateRenderState),h.registerEventListener(r.EVENTS.ON_CLIP_MOUSE_MOVE_END,this.updateRenderState)}destroy(){const e=this.modelManager.viewer;e.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED,this.stopUpdateRenderState),e.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED_END,this.updateRenderState),e.unregisterEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.updateRenderState),e.unregisterEventListener(r.EVENTS.ON_CLIP_PLANE_MOUSE_MOVE,this.stopUpdateRenderState),e.unregisterEventListener(r.EVENTS.ON_CLIP_MOUSE_MOVE,this.stopUpdateRenderState),e.unregisterEventListener(r.EVENTS.ON_CLIP_MOUSE_MOVE_END,this.updateRenderState),this.updateRenderState=null,this.stopUpdateRenderState=null,this.shader=null,this.uniforms=null,this.material.dispose(),this.material=null,this.renderComposer=null,this.sceneCamera=null,this.mainScene=null,this.oldClearColor=null,this._8x8_2D_LIST=null,this.swapRenderTargets[0].dispose(),this.swapRenderTargets[1].dispose(),this.swapRenderTargets=null,this.overlayMaterial.dispose(),this.overlayMaterial=null,this.renderTarget.dispose(),this.renderTarget=null,this.blurMaterialX.dispose(),this.blurMaterialX=null,this.blurMaterialY.dispose(),this.blurMaterialY=null,this.accumulateMaterial.dispose(),this.accumulateMaterial=null,this.renderTargetBlurBuffer.dispose(),this.renderTargetBlurBuffer=null,this.camera=null,this.scene=null,this.renderTargetGTAOBuffer.dispose(),this.renderTargetGTAOBuffer=null,this.modelManager=null}setOpts(e){e&&(void 0!==e.minDistance&&null!==e.minDistance&&(this.minDistance=e.minDistance),void 0!==e.maxDistance&&null!==e.maxDistance&&(this.maxDistance=e.maxDistance),void 0!==e.kernelRadius&&null!==e.kernelRadius&&(this.kernelRadius=e.kernelRadius),void 0!==e.blurKernelRadius&&null!==e.blurKernelRadius&&(this.blurKernelRadius=e.blurKernelRadius),void 0!==e.blurMaxRadius&&null!==e.blurMaxRadius&&(this.blurMaxRadius=e.blurMaxRadius))}render(t,n,a,s,o,l){if(this.renderState===i)return;if(this.renderState===e){const e=t.getRenderTarget(),i=t.autoClear,r=16;return this.scene.overrideMaterial=this.overlayMaterial,this.overlayMaterial.uniforms.edgeTexture1.value=this.swapRenderTargets[1-r%2].texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.swapRenderTargets[1-r%2].texture,this.overlayMaterial.uniforms.maskTexture.value=this.renderTarget.texture,t.setRenderTarget(n),t.clear(),t.render(this.scene,this.camera),this.scene.overrideMaterial=null,t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=i,void t.setRenderTarget(e)}let d=!1;const h=this.mainScene.getObjectGroup(r.GlobalData.TilePlaneGroupName);h&&(d=h.visible);let c=!1;const u=this.mainScene.getObjectGroup(r.ObjectGroupType.CAPSWIREFRAME);u&&(c=u.visible);let p=!1;const m=this.mainScene.getObjectGroup(r.ObjectGroupType.RECEIVESHADOWPLANE);m&&(p=m.visible);let f=!1;const g=this.mainScene.getObjectGroup(r.ObjectGroupType.IBLCUBE);g&&(f=g.visible);let v=!1,y=this.mainScene.getObjectGroup(r.ObjectGroupType.CONTACTSHADOW);y&&(v=y.visible);let M=!1,E=this.mainScene.getObjectGroup(r.ObjectGroupType.AXISGRIDMANAGER);E&&(M=E.visible);let x=!1,_=this.mainScene.customPlaneManager;_&&(x=_.visible);let b={};const I=this.mainScene.getExternalCompObjectGroups();I.forEach((e=>{b[e.name]=e.visible,e.visible=!1})),h&&(h.visible=!1),y&&(y.visible=!1),u&&(u.visible=!1),m&&(m.visible=!1),g&&(g.visible=!1),E&&(E.visible=!1),_&&(_.visible=!1);const T=r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._getNodeGroupVisible();r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setNodeGroupVisible(!1);const S=r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._getAlphaTestNodeGroupVisible();r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setAlphaTestNodeGroupVisible(!1);const[C,w]=this.modelManager.classifyGISModels();let R={};C.forEach((e=>{R[e.id]=e.getObjectGroup().visible,e.getObjectGroup().visible=!1}));let B={};w.forEach((e=>{r.RenderEffectComposer.SetLineObjectVisible(e.getObjectGroup(),this.camera,!1,B)}));const A=t.getContext().drawingBufferWidth,P=t.getContext().drawingBufferHeight,L=t.getRenderTarget();t.setRenderTarget(this.renderTarget),t.clear(),t.render(this.mainScene,this.sceneCamera),t.getClearColor(this.oldClearColor),this.oldClearAlpha=t.getClearAlpha();const O=t.autoClear;t.setClearColor(0,0),t.autoClear=!1;for(let e=1;e<=16;e++){const i=this.getJitterValuesOfFrame(e,A,P);this.sceneCamera.setViewOffset(A,P,i[0],i[1],A,P),this.renderComposer.normalTextureFlg=!1,this.uniforms.tNormal.value=this.renderComposer.getNormalDepthTexture(),this.setCameraUniforms(this.sceneCamera);const r=this.sceneCamera.isPerspective,n=Math.tan(.017453293*this.sceneCamera.fov*.5)*this.sceneCamera.near;if(this.uniforms.nearPlaneSize.value.set(n*this.sceneCamera.aspect,n,-this.sceneCamera.near),!r){const e=this.sceneCamera.projectionMatrix.elements;this.uniforms.nearPlaneSize.value.set(1/e[0],1/e[5],1)}this.uniforms.viewport.value.set(0,0,A,P),this.uniforms.viewportInv.value.set(A,P,1/A,1/P),this.uniforms.radius.value=this.kernelRadius,this.uniforms.uIsPerspective.value=r,this.uniforms.SAMPLES.value=this._8x8_2D_LIST[e-1],this.uniforms.accumulateIndex.value=e-1,this.quad.material=this.material,t.setRenderTarget(this.renderTargetGTAOBuffer),t.clear(),t.render(this.scene,this.camera),this.quad.material=this.blurMaterialX,this.blurMaterialX.uniforms.tDiffuse.value=this.renderTargetGTAOBuffer.texture,t.setRenderTarget(this.renderTargetBlurBuffer),t.clear(),t.render(this.scene,this.camera),this.quad.material=this.blurMaterialY,this.blurMaterialY.uniforms.tDiffuse.value=this.renderTargetBlurBuffer.texture,t.setRenderTarget(this.renderTargetGTAOBuffer),t.clear(),t.render(this.scene,this.camera),this.quad.material=this.accumulateMaterial,this.accumulateMaterial.uniforms.accumulateTexture.value=this.swapRenderTargets[e%2].texture,this.accumulateMaterial.uniforms.mainTexture.value=this.renderTargetGTAOBuffer.texture,this.accumulateMaterial.uniforms.accumulateIndex.value=e,t.setRenderTarget(this.swapRenderTargets[1-e%2]),t.clear(),t.render(this.scene,this.camera),t.autoClear=!1,this.sceneCamera.setViewOffset(A,P,-i[0],-i[1],A,P)}this.scene.overrideMaterial=this.overlayMaterial,this.overlayMaterial.uniforms.edgeTexture1.value=this.swapRenderTargets[1].texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.swapRenderTargets[1].texture,this.overlayMaterial.uniforms.maskTexture.value=this.renderTarget.texture,t.setRenderTarget(n),t.clear(),t.render(this.scene,this.camera),this.scene.overrideMaterial=null,t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=O,t.setRenderTarget(L),this.renderState=e,this.modelManager.setRenderStateChanged(!1),h&&(h.visible=d),y&&(y.visible=v),u&&(u.visible=c),m&&(m.visible=p),g&&(g.visible=f),E&&(E.visible=M),_&&(_.visible=x),r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setNodeGroupVisible(T),r.ExtrudeBodyManager.getInstance(this.modelManager.viewer)._setAlphaTestNodeGroupVisible(S),C.forEach((e=>{e.getObjectGroup().visible=R[e.id]})),w.forEach((e=>{r.RenderEffectComposer.RestoreLineObjectVisible(e.getObjectGroup(),this.camera,B)})),I.forEach((e=>{e.visible=b[e.name]}))}setCameraUniforms(e){this.sceneCamera=e,this.uniforms.cameraNear.value=this.sceneCamera.near,this.uniforms.cameraFar.value=this.sceneCamera.far,this.uniforms.cameraProjection.value.copy(this.sceneCamera.projectionMatrix),this.uniforms.inverseProjection.value.copy(this.sceneCamera.projectionMatrix).invert()}getJitterValuesOfFrame(e,t,i){return[this._4x4[2*(e-1)]-.5,this._4x4[2*(e-1)+1]-.5]}jitterCamera(e,t){this.sceneCamera.isPerspective?(this.sceneCamera.projectionMatrix.elements[8]+=2*e,this.sceneCamera.projectionMatrix.elements[9]+=2*t):(this.sceneCamera.projectionMatrix.elements[12]+=2*e,this.sceneCamera.projectionMatrix.elements[13]+=2*t),this.sceneCamera.projectionMatrixInverse.copy(this.sceneCamera.projectionMatrix).invert()}setSize(e,t){this.width=e,this.height=t,this.renderTarget.setSize(this.width,this.height),this.renderTargetGTAOBuffer.setSize(this.width,this.height),this.renderTargetBlurBuffer.setSize(this.width,this.height),this.swapRenderTargets[0].setSize(this.width,this.height),this.swapRenderTargets[1].setSize(this.width,this.height),this.uniforms.resolution.value.set(this.width,this.height),this.blurMaterialX.uniforms.resolution.value.set(this.width,this.height),this.blurMaterialY.uniforms.resolution.value.set(this.width,this.height),this.accumulateMaterial.uniforms.resolution.value.set(this.width,this.height)}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},edgeTexture3:{value:null}},vertexShader:"\n            varying vec2 vUv;\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t}\n\t\t",fragmentShader:"\n            varying vec2 vUv;\n            uniform sampler2D maskTexture;\n            uniform sampler2D edgeTexture1;\n            uniform sampler2D edgeTexture2;\n            #include <postprocess_minus_color>\n            void main() {\n                vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n                vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n                vec4 maskColor = texture2D(maskTexture, vUv);\n\n                vec4 color = maskColor;\n                color *= vec4(vec3(1.0 - edgeValue1.r),1.0);\n                //color *= vec4(vec3(1.0 - edgeValue2.r),1.0);\n                gl_FragColor = vec4(color.xyz, 1.0);\n\t\t\t}\n\t\t"})}}r.GTAOPass=n}(),function(){class e extends THREE.Pass{constructor(e){super();var t=this;t.renderComposer=e,t.width=t.renderComposer.width,t.height=t.renderComposer.height,t.modelManager=t.renderComposer.modelManager,t.renderScene=t.renderComposer.scene,t.renderCamera=t.renderComposer.camera,t.selectedObjectIds={},r.GlobalData.HighLightOutlineCount=0,t.edgeStrength=10,t.visibleEdgeColor=new THREE.Color(0,1,0),t.hiddenEdgeColor=new THREE.Color(.1,.04,.02),t.intensity=.5,t.spread=1,t.defaultEdgeColor=(new THREE.Color).setHex(7733223),t.edgeColor=new THREE.Vector4(t.defaultEdgeColor.r,t.defaultEdgeColor.g,t.defaultEdgeColor.b,.95),t.edgeLength=2,t.blurDirectionX=new THREE.Vector2(1,0),t.blurDirectionY=new THREE.Vector2(0,1);var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};t.renderTargetMaskBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetMaskBuffer1.texture.name="OutlinePass.mask1",t.renderTargetMaskBuffer1.texture.generateMipmaps=!1,t.renderTargetMaskBuffer2=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetMaskBuffer2.texture.name="OutlinePass.mask2",t.renderTargetMaskBuffer2.texture.generateMipmaps=!1,t.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",t.renderTargetBlurBuffer1.texture.generateMipmaps=!1,t.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(Math.round(t.width/2),Math.round(t.height/2),i),t.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",t.renderTargetBlurBuffer2.texture.generateMipmaps=!1,t.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",t.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,t.renderTargetEdgeBuffer2=new THREE.WebGLRenderTarget(Math.round(t.width/2),Math.round(t.height/2),i),t.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",t.renderTargetEdgeBuffer2.texture.generateMipmaps=!1,t.setEdgeDetectionMaterial(),t.separableBlurMaterial=new THREE.ShaderMaterial({defines:r.SeperableBlurShader.defines||{MAX_RADIUS:5},uniforms:THREE.UniformsUtils.clone(r.SeperableBlurShader.uniforms),vertexShader:r.SeperableBlurShader.vertexShader,fragmentShader:r.SeperableBlurShader.fragmentShader}),t.createOverlayMaterial(),t.oldClearColor=new THREE.Color,t.oldClearAlpha=1,t.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),t.scene=new THREE.Scene,t.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),t.quad.frustumCulled=!1,t.scene.add(t.quad),t.prepareMaskMaterial=t.getPrepareMaskMaterial(),t.prepareMaskMaterial.side=THREE.DoubleSide,t.prepareMaskInstancedMaterial=t.getPrepareMaskInstancedMaterial(),t.prepareMaskInstancedMaterial.side=THREE.DoubleSide,t.initSelectedObjectSceneAndMaterial(),t.enabled=!1,t.setSize(),t.meshGeneratorId="outlineHighLight",t.modelUserIdTileMapVisibility={}}dispose(){var e=this;e.renderTargetMaskBuffer1.dispose(),e.renderTargetMaskBuffer2.dispose(),e.renderTargetEdgeBuffer1.dispose(),e.renderTargetEdgeBuffer2.dispose(),e.renderTargetBlurBuffer1.dispose(),e.renderTargetBlurBuffer2.dispose(),e.modelUserIdTileMapVisibility=null}setSize(e,t){var i=this;null!=e&&(i.width=e),null!=t&&(i.height=t),i.renderTargetMaskBuffer1.setSize(i.width,i.height),i.renderTargetMaskBuffer2.setSize(i.width,i.height);var r=Math.round(i.width/2),n=Math.round(i.height/2);i.renderTargetEdgeBuffer1.setSize(i.width,i.height),i.renderTargetEdgeBuffer2.setSize(r,n),i.renderTargetBlurBuffer1.setSize(i.width,i.height),i.renderTargetBlurBuffer2.setSize(r,n),i.edgeDetectionMaterial.uniforms.texSize.value.set(i.width,i.height),i.separableBlurMaterial.uniforms.texSize.value.set(i.width,i.height)}initSelectedObjectSceneAndMaterial(){var e=this;e.selectedObjectScene=new THREE.Scene,e.selectedObjectScene.autoUpdate=!1,e.selectedObjectGroup=new r.ObjectGroup,e.selectedObjectGroup.name="OutlineHighLightMeshGroup",e.selectedObjectGroup.matrixAutoUpdate=!1,e.selectedObjectScene.add(e.selectedObjectGroup)}_ClearSelectedObjectScene(){this.selectedObjectGroup.clear()}_AddSelectedObjectToScene(e){let t=Object.keys(e);for(const i of t)this.selectedObjectGroup.add(e[i])}_GetSelectedObjectMeshes(e){var t=this,i={};return t.modelManager.traverseModels((function(r){var n=e[r.id];if(!n)return;const a=[...n.keys()];r.getPickingMeshes({skinningWireframeMaterial:t.prepareMaskMaterial,skinningSelectedMaterial:t.prepareMaskMaterial,selectedLineMaterial:t.prepareMaskMaterial,selectedMaterial:t.prepareMaskMaterial,wireframeMaterial:t.prepareMaskMaterial,instancedSelectedMaterial:t.prepareMaskInstancedMaterial,instancedWireFrameMaterial:t.prepareMaskInstancedMaterial},i,a,n,t.meshGeneratorId)})),i}_UpdateSelectedObjectSceneWorldMatrix(){this.selectedObjectGroup.matrix.copy(this.renderScene.getRawMatrixGlobal()),this.selectedObjectGroup.updateMatrixWorld(!0)}_UpdateSelectedObjectScene(e){var t=this;(1==t.updateSelectedObjectIds||t.modelManager.isFilterApplied()||t._isTilesVisibleChanged(e))&&(t._ClearSelectedObjectScene(),t._AddSelectedObjectToScene(t._GetSelectedObjectMeshes(e)),t.updateSelectedObjectIds=!1),this._UpdateSelectedObjectSceneWorldMatrix()}_isTilesVisibleChanged(e){let t=!1;return this.modelManager.traverseModels((i=>{if(!i.tilesLoader)return;let r=e[i.id];if(!r)return;const n=Object.keys(r),a=i.getUserIdTileMap(n);if(i.getUserIdTileMapVisibility(a),this.modelUserIdTileMapVisibility[i.id]){const e=this.modelUserIdTileMapVisibility[i.id];for(const i in a)for(const r in a[i])e[i]&&e[i][r]===a[i][r]||(t=!0)}else this.modelUserIdTileMapVisibility[i.id]=a,t=!0;this.modelUserIdTileMapVisibility[i.id]=a})),t}render(e,t,i,n,a,s){var o=this;if(0!==r.GlobalData.HighLightOutlineCount){o._UpdateSelectedObjectScene(o.selectedObjectIds),e.getClearColor(o.oldClearColor),o.oldClearAlpha=e.getClearAlpha();var l=e.autoClear;e.autoClear=!1,a&&e.getContext().disable(e.getContext().STENCIL_TEST),e.setClearColor(16777215,1);var d=e.getRenderTarget();e.setRenderTarget(o.renderTargetMaskBuffer1),e.clear(),e.render(o.selectedObjectScene,o.renderCamera),o.quad.material=o.edgeDetectionMaterial,o.edgeDetectionMaterial.uniforms.maskTexture.value=o.renderTargetMaskBuffer1.texture,o.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=o.visibleEdgeColor,o.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=o.hiddenEdgeColor,e.setRenderTarget(o.renderTargetMaskBuffer2),e.clear(),e.render(o.scene,o.camera),o.quad.material=o.separableBlurMaterial,o.separableBlurMaterial.uniforms.kernelRadius.value=Math.sqrt(o.spread),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetMaskBuffer2.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionX,e.setRenderTarget(o.renderTargetBlurBuffer1),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetBlurBuffer1.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionY,e.setRenderTarget(o.renderTargetEdgeBuffer1),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.kernelRadius.value=2*o.spread,o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetEdgeBuffer1.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionX,e.setRenderTarget(o.renderTargetBlurBuffer2),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetBlurBuffer2.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionY,e.setRenderTarget(o.renderTargetEdgeBuffer2),e.clear(),e.render(o.scene,o.camera),o.quad.material=o.overlayMaterial,o.overlayMaterial.uniforms.maskTexture.value=o.renderTargetMaskBuffer1.texture,o.overlayMaterial.uniforms.edgeTexture1.value=o.renderTargetEdgeBuffer1.texture,o.overlayMaterial.uniforms.edgeTexture2.value=o.renderTargetEdgeBuffer2.texture,o.overlayMaterial.uniforms.edgeStrength.value=o.edgeStrength*o.intensity,o.overlayMaterial.uniforms.edgeGlow.value=o.spread/5,o.overlayMaterial.uniforms.firstFlg&&(o.overlayMaterial.uniforms.firstFlg.value=s?0:1),e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.scene,o.camera),a&&e.state.buffers.stencil.setTest(!0),e.setClearColor(o.oldClearColor,o.oldClearAlpha),e.autoClear=l,e.setRenderTarget(d)}}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{tDiffuse:{value:null},maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},firstFlg:{value:0}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    uniform sampler2D tDiffuse;\n                    varying vec2 vUv;\n                    uniform sampler2D maskTexture;\n                    uniform sampler2D edgeTexture1;\n                    uniform sampler2D edgeTexture2;\n                    uniform float edgeStrength;\n                    uniform float edgeGlow;\n                    uniform float firstFlg;\n\n                    #include <postprocess_mix_color>\n                    #include <postprocess_original_color>\n                    void main() {\n                        vec4 color = get_original_color(tDiffuse, vUv, firstFlg);\n                        vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n                        vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n                        vec4 maskColor = texture2D(maskTexture, vUv);\n\n                        vec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\n                        vec4 finalColor = edgeStrength * maskColor.r * edgeValue;\n                        gl_FragColor = mix_color(color, finalColor.rgb, finalColor.a);\n                        //fix BIMFACE-22520:edge.a > 0\n                        if(gl_FragColor.a < 0.1)  gl_FragColor.a = 0.0;\n                    }\n                "})}getPrepareMaskMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                    varying vec2 vUv;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tvarying vec4 vPosition;\n    \t\t\t\tuniform mat4 textureMatrix;\n    \t\t\t\tvoid main() {\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n    \t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n    \t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t}\n\t\t\t\t",fragmentShader:"\n                    #include <packing>\n                    varying vec4 vPosition;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tuniform sampler2D depthTexture;\n    \t\t\t\tuniform vec2 cameraNearFar;\n\n                    void main()\n                    {\n                        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\n                    }\n                "})}getPrepareMaskInstancedMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                    attribute vec4 vState;\n                    attribute vec4 aColor;\n                    attribute vec3 mcol0;\n                    attribute vec3 mcol1;\n                    attribute vec3 mcol2;\n                    attribute vec3 mcol3;\n                    #if defined(USE_MAP)\n                        attribute vec4 muvCol0;\n                        attribute vec2 muvCol1;\n                        // attribute vec2 muvCol2;\n                    #endif\n\n                    varying float vfState;\n                    varying vec2 vUv;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tvarying vec4 vPosition;\n    \t\t\t\tuniform mat4 textureMatrix;\n\n    \t\t\t\t#include <get_instance_position_pars_vertex>\n\n                    vec2 getInstanceUV(vec2 uv) {\n                        #if defined(USE_MAP)\n                            return vec2(mat3(vec3(muvCol0.xy, 0.0),\n                                             vec3(muvCol0.zw, 0.0),\n                                             vec3(muvCol1, 1.0)) * vec3(uv, 1.0));\n                        #else\n                            return uv;\n                        #endif\n                    }\n\n    \t\t\t\tvoid main() {\n    \t\t\t\t    vfState = vState.r;\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n    \t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n    \t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n                        gl_Position = projectionMatrix * modelViewMatrix * vPosition;\n                        vPosition = modelViewMatrix * vPosition;\n\t\t\t\t    }\n    \t\t\t",fragmentShader:"\n                    #include <packing>\n                    varying float vfState;\n                    varying vec2 vUv;\n                    varying vec4 vPosition;\n                    varying vec4 projTexCoord;\n                    uniform sampler2D depthTexture;\n                    uniform vec2 cameraNearFar;\n\n                    float linearDepth(float depth)\n                    {\n                        float far = cameraNearFar.y;\n                        float near = cameraNearFar.x;\n                        return (2.0 * near) / (far + near - depth * (far - near));\n                    }\n\n                    void main() {\n                        if (vfState <= -0.99 && vfState >= -1.01) discard;\n                        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\n                    }\n                "})}setEdgeDetectionMaterial(){this.edgeDetectionMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},visibleEdgeColor:{value:new THREE.Vector3(1,1,1)},hiddenEdgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"\n                    varying vec2 vUv;\n    \t\t\t\tvoid main() {\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t}\n\t\t\t\t",fragmentShader:"\n                    varying vec2 vUv;\n                    uniform sampler2D maskTexture;\n                    uniform vec2 texSize;\n                    uniform vec3 visibleEdgeColor;\n                    uniform vec3 hiddenEdgeColor;\n                    void main() {\n                        vec2 invSize = 1.0 / texSize;\n                        vec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\n                        vec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\n                        vec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\n                        vec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\n                        vec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\n                        float diff1 = (c1.r - c2.r)*0.5;\n                        float diff2 = (c3.r - c4.r)*0.5;\n                        float d = length( vec2(diff1, diff2) );\n                        float a1 = min(c1.g, c2.g);\n                        float a2 = min(c3.g, c4.g);\n                        float visibilityFactor = min(a1, a2);\n                        vec3 edgeColor =  visibleEdgeColor;\n                        gl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\n                    }\n                "})}setHighLightOutlineById(e,t,i){var n=this;n.selectedObjectIds[e]||(n.selectedObjectIds[e]=new Map);for(var a=n.selectedObjectIds[e],s=0,o=t.length;s<o;s++)a.has(t[s])||r.GlobalData.HighLightOutlineCount++,a.set(t[s],!0);n.visibleEdgeColor=i.color,n.intensity=Math.max(Math.min(i.intensity,1),0),n.spread=Math.max(Math.min(i.spread,5),1),n.updateSelectedObjectIds=!0}removeHighLightOutlineById(e,t){var i=this;i.selectedObjectIds[e]||(i.selectedObjectIds[e]=new Map);var n=i.selectedObjectIds[e];if(null==t){var a=Object.keys(n).length;r.GlobalData.HighLightOutlineCount-=a,i.selectedObjectIds[e]=new Map}else for(var s=0;s<t.length;s++)n.has(t[s])&&(r.GlobalData.HighLightOutlineCount--,n.delete(t[s]));i.updateSelectedObjectIds=!0}updateHighLightOutlineById(e,t){var i=this.selectedObjectIds;i[e]&&i[e].has(t)&&(this.updateSelectedObjectIds=!0)}}r.OutlineHighLightPass=e}(),function(){class e extends THREE.Pass{constructor(e,t){super();var i=this;i.renderComposer=e,i.width=i.renderComposer.width,i.height=i.renderComposer.height,i.modelManager=i.renderComposer.modelManager,i.renderScene=i.renderComposer.scene,i.renderCamera=i.renderComposer.camera,i.intensity=.5,i.spread=1,i.depthMaterial=new THREE.MeshDepthMaterial,i.depthMaterial.side=THREE.DoubleSide,i.depthMaterial.depthPacking=THREE.RGBADepthPacking,i.depthMaterial.blending=THREE.NoBlending,i.instancedDepthMaterial=new r.InstancedDepthMaterial,i.instancedDepthMaterial.side=THREE.DoubleSide,i.instancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.instancedDepthMaterial.blending=THREE.NoBlending;var n=new THREE.DepthTexture;n.format=THREE.DepthStencilFormat,n.type=THREE.UnsignedInt248Type,n.minFilter=THREE.NearestFilter,n.maxFilter=THREE.NearestFilter,i.selectDepthRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,depthTexture:n,depthBuffer:!0,stencilBuffer:!1}),i.setFillColorMaterial(),i.fillColorMaterial.uniforms.SelectObjDepthTexture.value=i.selectDepthRenderTarget.depthTexture,i.fillColorMaterial.uniforms.diffuseMap.value=i.selectDepthRenderTarget.texture,t&&(i.fillColorMaterial.defines.USE_DIFFUSEMAP=""),i.QuadCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),i.ScreenQuad=new THREE.Scene,i.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),i.quad.frustumCulled=!1,i.ScreenQuad.add(i.quad),i.GlowRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),i.GlowRenderTarget.texture.generateMipmaps=!1,i.fillColor=new THREE.Color(1,0,0),i.selectedObjectIds={},i.blurDirectionX=new THREE.Vector2(1,0),i.blurDirectionY=new THREE.Vector2(0,1);var a={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},s=Math.round(i.width/2),o=Math.round(i.height/2);this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var l=[3,5,7,9,11];this.separableBlurMaterials=[];for(var d=0;d<this.nMips;d++){var h=new THREE.WebGLRenderTarget(s,o,a);h.texture.name="UnrealBloomPass.h"+d,h.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(h);var c=new THREE.WebGLRenderTarget(s,o,a);c.texture.name="UnrealBloomPass.v"+d,c.texture.generateMipmaps=!1,this.renderTargetsVertical.push(c),this.separableBlurMaterials.push(this.getSeperableBlurMaterial(l[d])),this.separableBlurMaterials[d].uniforms.texSize.value=new THREE.Vector2(s,o),s=Math.round(s/2),o=Math.round(o/2)}i.createOverlayMaterial(),i.overlayMaterial.uniforms.blurTexture0.value=this.renderTargetsVertical[0].texture,i.overlayMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[1].texture,i.overlayMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[2].texture,i.overlayMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[3].texture,i.overlayMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[4].texture,i.enabled=!1,i.oldClearColor=new THREE.Color,i.oldClearAlpha=1,i.initSelectedObjectSceneAndMaterial(),i.meshGeneratorId="glow",i._renderIndex=-1,i.useDiffuse=t,i.luminosityThreshold=0,i.modelUserIdTileMapVisibility={}}dispose(){this.GlowRenderTarget.dispose(),this.selectDepthRenderTarget.dispose();for(var e=0;e<this.nMips;e++)this.renderTargetsHorizontal[e].dispose(),this.renderTargetsVertical[e].dispose();this.modelUserIdTileMapVisibility=null}setSize(e,t){var i=this;i.width=e,i.height=t,i.GlowRenderTarget.setSize(e,t),i.selectDepthRenderTarget.setSize(e,t);for(var r=Math.round(i.width/2),n=Math.round(i.height/2),a=0;a<this.nMips;a++)this.renderTargetsHorizontal[a].setSize(r,n),this.renderTargetsVertical[a].setSize(r,n),this.separableBlurMaterials[a].uniforms.texSize.value=new THREE.Vector2(r,n),r=Math.round(r/2),n=Math.round(n/2)}initSelectedObjectSceneAndMaterial(){var e=this;e.selectedObjectScene=new THREE.Scene,e.selectedObjectScene.autoUpdate=!1,e.selectedObjectGroup=new r.ObjectGroup,e.selectedObjectGroup.name="GlowMeshGroup",e.selectedObjectGroup.matrixAutoUpdate=!1,e.selectedObjectScene.add(e.selectedObjectGroup)}_ClearSelectedObjectScene(){this.selectedObjectGroup.clear()}_AddSelectedObjectToScene(e){let t=Object.keys(e);for(const i of t)this.selectedObjectGroup.add(e[i])}_isTilesVisibleChanged(e){let t=!1;return this.modelManager.traverseModels((i=>{if(!i.tilesLoader)return;let r=e[i.id];if(!r)return;const n=Object.keys(r),a=i.getUserIdTileMap(n);if(i.getUserIdTileMapVisibility(a),this.modelUserIdTileMapVisibility[i.id]){const e=this.modelUserIdTileMapVisibility[i.id];for(const i in a)for(const r in a[i])e[i]&&e[i][r]===a[i][r]||(t=!0)}else this.modelUserIdTileMapVisibility[i.id]=a,t=!0;this.modelUserIdTileMapVisibility[i.id]=a})),t}_GetSelectedObjectMeshes(e){var t=this,i={};return t.modelManager.traverseModels((function(r){let n=e[r.id];if(!n)return;var a=[...n.keys()];let s=t.useDiffuse?{}:{skinningWireframeMaterial:t.depthMaterial,skinningSelectedMaterial:t.depthMaterial,selectedLineMaterial:t.depthMaterial,selectedMaterial:t.depthMaterial,wireframeMaterial:t.depthMaterial,instancedSelectedMaterial:t.instancedDepthMaterial,instancedWireFrameMaterial:t.instancedDepthMaterial};r.getPickingMeshes(s,i,a,n,t.meshGeneratorId+t.renderIndex)})),i}_fixSelectedMeshMaterial(e){for(const t in e){e[t].traverse((e=>{(e instanceof THREE.Mesh||e instanceof THREE.LineSegments)&&e.material&&e.material.color&&e.material.color.r<.1&&e.material.color.g<.1&&e.material.color.b<.1&&(e.material=e.material.clone(),e.material.color.r=.4,e.material.color.g=.4,e.material.color.b=.4,e.material.needsUpdate=!0)}))}}_UpdateSelectedObjectSceneWorldMatrix(){this.selectedObjectGroup.matrix.copy(this.renderScene.getRawMatrixGlobal()),this.selectedObjectGroup.updateMatrixWorld(!0)}_UpdateSelectedObjectScene(e){var t=this;(1==t.updateSelectedObjectIds||t._renderIndex!=t.renderIndex||t.modelManager.isFilterApplied()||t._isTilesVisibleChanged(e))&&(t._renderIndex=t.renderIndex,t._ClearSelectedObjectScene(),t._AddSelectedObjectToScene(t._GetSelectedObjectMeshes(e)),t.updateSelectedObjectIds=!1),t._UpdateSelectedObjectSceneWorldMatrix()}_SetSelectedObjectOutline(e,t){this.modelManager.traverseModels((function(i){e[i.id]&&i instanceof r.BimTilesModel&&i.setBorderLineVisible(t)}))}render(e,t,i,n,a,s){var o=this;o._UpdateSelectedObjectScene(o.selectedObjectIds),e.autoClear=!1;let l=r.GlobalData.DrawingStyle==r.DrawingStyle.SHADINGWITHLINE;o._SetSelectedObjectOutline(o.selectedObjectIds,!1);var d=e.getRenderTarget();e.setRenderTarget(o.selectDepthRenderTarget),e.clear(),o._dealDepthWrite(),e.render(o.selectedObjectScene,o.renderCamera),o._rescoverDepthWrite(),o._SetSelectedObjectOutline(o.selectedObjectIds,l),o.fillColorMaterial.uniforms.cameraNear.value=o.renderCamera.near,o.fillColorMaterial.uniforms.cameraFar.value=o.renderCamera.far,o.fillColorMaterial.uniforms.fillColor.value=o.fillColor,o.fillColorMaterial.uniforms.luminosityThreshold.value=o.luminosityThreshold,o.fillColorMaterial.uniforms.scenDepthTexture.value=o.renderComposer.getTransparentDepthTexture(),o.quad.material=o.fillColorMaterial,e.setRenderTarget(o.GlowRenderTarget),e.clear(),e.render(o.ScreenQuad,o.QuadCamera);for(var h=this.GlowRenderTarget,c=0;c<this.nMips;c++)this.quad.material=this.separableBlurMaterials[c],this.separableBlurMaterials[c].uniforms.colorTexture.value=h.texture,this.separableBlurMaterials[c].uniforms.direction.value=o.blurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[c]),e.clear(),e.render(o.ScreenQuad,o.QuadCamera),this.separableBlurMaterials[c].uniforms.colorTexture.value=this.renderTargetsHorizontal[c].texture,this.separableBlurMaterials[c].uniforms.direction.value=o.blurDirectionY,e.setRenderTarget(this.renderTargetsVertical[c]),e.clear(),e.render(o.ScreenQuad,o.QuadCamera),h=this.renderTargetsVertical[c];o.overlayMaterial.uniforms.firstFlg.value=s?0:1,o.overlayMaterial.uniforms.sceneTexture.value=i.texture,o.overlayMaterial.uniforms.bloomStrength.value=o.useDiffuse?2*o.intensity:o.intensity,o.overlayMaterial.uniforms.bloomRadius.value=o.spread/5,o.quad.material=o.overlayMaterial,e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.ScreenQuad,o.QuadCamera),e.setRenderTarget(d)}_dealDepthWrite(){let e=this.selectedObjectScene.getObjectByName("PickingExternalMeshGroup");if(e){var t=e.children;for(let e=0;e<t.length;e++)t[e].material&&0==t[e].material.depthWrite&&(t[e].material.depthWrite=!0,t[e].material.originDepthWrite=!1)}}_rescoverDepthWrite(){let e=this.selectedObjectScene.getObjectByName("PickingExternalMeshGroup");if(e){var t=e.children;for(let e=0;e<t.length;e++)t[e].material&&0==t[e].material.originDepthWrite&&(t[e].material.depthWrite=!1)}}setFillColorMaterial(){this.fillColorMaterial=new THREE.ShaderMaterial({defines:{},uniforms:{scenDepthTexture:{value:null},SelectObjDepthTexture:{value:null},cameraNear:{value:1},cameraFar:{value:100},fillColor:{value:new THREE.Vector3(1,1,1)},diffuseMap:{value:null},luminosityThreshold:{value:0}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    varying vec2 vUv;\n                    #include <common>\n                    #include <packing>\n                    uniform sampler2D scenDepthTexture;\n                    uniform sampler2D SelectObjDepthTexture;\n                    #ifdef USE_DIFFUSEMAP\n                        uniform sampler2D diffuseMap;\n                    #endif\n                    uniform vec3 fillColor;\n                    uniform float cameraNear;\n                    uniform float cameraFar;\n\n                    uniform float luminosityThreshold;\n                    float smoothWidth = 0.01;\n                    const vec4 defaultColor = vec4(0.0, 0.0, 0.0, 0.0);\n                    float getViewZ( const in float depth )\n                    {\n                        return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n                    }\n                    void main() {\n                        float sceneDepthNDC = texture2D(scenDepthTexture, vUv).x;\n                        float selectObjDepthNDC = texture2D(SelectObjDepthTexture, vUv).x;\n                        float sceneDepth = getViewZ(sceneDepthNDC);\n                        float selectObjDepth = getViewZ(selectObjDepthNDC);\n                        if((sceneDepthNDC == 1.0 && selectObjDepthNDC != 1.0) ||\n                            (sceneDepth - selectObjDepth < 0.0001 && selectObjDepthNDC != 1.0) )\n                        {\n                            #ifdef USE_DIFFUSEMAP\n                                vec4 color = texture2D(diffuseMap, vUv);\n                                vec3 luma = vec3( 0.299, 0.587, 0.114 );\n                                float v = dot( color.xyz, luma );\n                                float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n                                gl_FragColor = mix( defaultColor, color * 2.0, alpha );\n                            #else\n                                gl_FragColor = vec4(fillColor.xyz, 1.0);\n                            #endif\n    \n                        }\n                        else\n                        {\n                            gl_FragColor = vec4(0.0,0.0,0.0,0.0);\n                        }\n                    }\n                ",depthTest:!1,depthWrite:!1,transparent:!0})}getSeperableBlurMaterial(e){return new THREE.ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }",fragmentShader:"#include <common>\n                    varying vec2 vUv;\n                    uniform sampler2D colorTexture;\n                    uniform vec2 texSize;\n                    uniform vec2 direction;\n                    \n                    float gaussianPdf(in float x, in float sigma) {\n                        return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n                    }\n                    void main() {\n                        vec2 invSize = 1.0 / texSize;\n                        float fSigma = float(SIGMA);\n                        float weightSum = gaussianPdf(0.0, fSigma);\n                        vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\n                        for( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n                            float x = float(i);\n                            float w = gaussianPdf(x, fSigma);\n                            vec2 uvOffset = direction * invSize * x;\n                            vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\n                            vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\n                            diffuseSum += (sample1 + sample2) * w;\n                            weightSum += 2.0 * w;\n                        }\n                        gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n                    }"})}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({defines:{NUM_MIPS:5},uniforms:{sceneTexture:{value:null},firstFlg:{value:0},blurTexture0:{value:null},blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},bloomStrength:{value:.5},bloomRadius:{value:1}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    varying vec2 vUv;\n                    uniform float firstFlg;\n                    uniform sampler2D sceneTexture;\n\n                    uniform sampler2D blurTexture0;\n                    uniform sampler2D blurTexture1;\n                    uniform sampler2D blurTexture2;\n                    uniform sampler2D blurTexture3;\n                    uniform sampler2D blurTexture4;\n\n                    uniform float bloomStrength;\n                    uniform float bloomRadius;\n                    const vec3 bloomTintColor = vec3(1.0,1.0,1.0);\n                    \n                    float lerpBloomFactor(const in float factor) { \n                        float mirrorFactor = 1.2 - factor;\n                        return mix(factor, mirrorFactor, bloomRadius);\n                    }\n\n                    #include <postprocess_original_color>\n                    #include <postprocess_mix_minus_color>\n                    #include <postprocess_minus_color>\n                    void main() {\n                        vec4 sceneColor = get_original_color(sceneTexture, vUv, firstFlg);\n\n                        vec4 finalColor = bloomStrength * ( lerpBloomFactor(1.0) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture0, vUv)  \n                        +lerpBloomFactor(0.8) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture1, vUv)  \n                        +lerpBloomFactor(0.6) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture2, vUv) \n                        +lerpBloomFactor(0.4) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture3, vUv) \n                        +lerpBloomFactor(0.2) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture4, vUv));\n                        \n                        if(finalColor.r==0.0 && finalColor.g==0.0 && finalColor.b==0.0){\n                            gl_FragColor = sceneColor;\n                        }else{\n                            vec3 rgb = postprocess_mix_minus_color(sceneColor, finalColor.rgb);\n                            gl_FragColor.rgba = postprocess_minus_color(rgb,vec3(0.0));\n                        }\n                    }\n                "})}}r.GlowPass=e}(),THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")},R={defines:{SMAA_THRESHOLD:"0.1"},uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","void SMAAEdgeDetectionVS( vec2 texcoord ) {","\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );","\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );","\tvOffset[ 2 ] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );","}","void main() {","\tvUv = uv;","\tSMAAEdgeDetectionVS( vUv );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {","\tvec2 threshold = vec2( SMAA_THRESHOLD, SMAA_THRESHOLD );","\tvec4 delta;","\tvec3 C = texture2D( colorTex, texcoord ).rgb;","\tvec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;","\tvec3 t = abs( C - Cleft );","\tdelta.x = max( max( t.r, t.g ), t.b );","\tvec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;","\tt = abs( C - Ctop );","\tdelta.y = max( max( t.r, t.g ), t.b );","\tvec2 edges = step( threshold, delta.xy );","\tif ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )","\t\tdiscard;","\tvec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;","\tt = abs( C - Cright );","\tdelta.z = max( max( t.r, t.g ), t.b );","\tvec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;","\tt = abs( C - Cbottom );","\tdelta.w = max( max( t.r, t.g ), t.b );","\tfloat maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );","\tvec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;","\tt = abs( C - Cleftleft );","\tdelta.z = max( max( t.r, t.g ), t.b );","\tvec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;","\tt = abs( C - Ctoptop );","\tdelta.w = max( max( t.r, t.g ), t.b );","\tmaxDelta = max( max( maxDelta, delta.z ), delta.w );","\tedges.xy *= step( 0.5 * maxDelta, delta.xy );","\treturn vec4( edges, 0.0, 0.0 );","}","void main() {","\tgl_FragColor = SMAAColorEdgeDetectionPS( vUv, vOffset, tDiffuse );","}"].join("\n")},B={defines:{SMAA_MAX_SEARCH_STEPS:"8",SMAA_AREATEX_MAX_DISTANCE:"16",SMAA_AREATEX_PIXEL_SIZE:"( 1.0 / vec2( 160.0, 560.0 ) )",SMAA_AREATEX_SUBTEX_SIZE:"( 1.0 / 7.0 )"},uniforms:{tDiffuse:{value:null},tArea:{value:null},tSearch:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","varying vec2 vPixcoord;","void SMAABlendingWeightCalculationVS( vec2 texcoord ) {","\tvPixcoord = texcoord / resolution;","\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );","\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );","\tvOffset[ 2 ] = vec4( vOffset[ 0 ].xz, vOffset[ 1 ].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( SMAA_MAX_SEARCH_STEPS );","}","void main() {","\tvUv = uv;","\tSMAABlendingWeightCalculationVS( vUv );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define SMAASampleLevelZeroOffset( tex, coord, offset ) texture2D( tex, coord + float( offset ) * resolution, 0.0 )","uniform sampler2D tDiffuse;","uniform sampler2D tArea;","uniform sampler2D tSearch;","uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[3];","varying vec2 vPixcoord;","#if __VERSION__ == 100","vec2 round( vec2 x ) {","\treturn sign( x ) * floor( abs( x ) + 0.5 );","}","#endif","float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {","\te.r = bias + e.r * scale;","\treturn 255.0 * texture2D( searchTex, e, 0.0 ).r;","}","float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","\tvec2 e = vec2( 0.0, 1.0 );","\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;","\t\ttexcoord -= vec2( 2.0, 0.0 ) * resolution;","\t\tif ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;","\t}","\ttexcoord.x += 0.25 * resolution.x;","\ttexcoord.x += resolution.x;","\ttexcoord.x += 2.0 * resolution.x;","\ttexcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);","\treturn texcoord.x;","}","float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","\tvec2 e = vec2( 0.0, 1.0 );","\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;","\t\ttexcoord += vec2( 2.0, 0.0 ) * resolution;","\t\tif ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;","\t}","\ttexcoord.x -= 0.25 * resolution.x;","\ttexcoord.x -= resolution.x;","\ttexcoord.x -= 2.0 * resolution.x;","\ttexcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );","\treturn texcoord.x;","}","float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","\tvec2 e = vec2( 1.0, 0.0 );","\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;","\t\ttexcoord += vec2( 0.0, 2.0 ) * resolution;","\t\tif ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;","\t}","\ttexcoord.y -= 0.25 * resolution.y;","\ttexcoord.y -= resolution.y;","\ttexcoord.y -= 2.0 * resolution.y;","\ttexcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );","\treturn texcoord.y;","}","float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","\tvec2 e = vec2( 1.0, 0.0 );","\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;","\t\ttexcoord -= vec2( 0.0, 2.0 ) * resolution;","\t\tif ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;","\t}","\ttexcoord.y += 0.25 * resolution.y;","\ttexcoord.y += resolution.y;","\ttexcoord.y += 2.0 * resolution.y;","\ttexcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );","\treturn texcoord.y;","}","vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {","\tvec2 texcoord = float( SMAA_AREATEX_MAX_DISTANCE ) * round( 4.0 * vec2( e1, e2 ) ) + dist;","\ttexcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );","\ttexcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;","\treturn texture2D( areaTex, texcoord, 0.0 ).rg;","}","vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {","\tvec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );","\tvec2 e = texture2D( edgesTex, texcoord ).rg;","\tif ( e.g > 0.0 ) {","\t\tvec2 d;","\t\tvec2 coords;","\t\tcoords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );","\t\tcoords.y = offset[ 1 ].y;","\t\td.x = coords.x;","\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).r;","\t\tcoords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );","\t\td.y = coords.x;","\t\td = d / resolution.x - pixcoord.x;","\t\tvec2 sqrt_d = sqrt( abs( d ) );","\t\tcoords.y -= 1.0 * resolution.y;","\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 1, 0 ) ).r;","\t\tweights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );","\t}","\tif ( e.r > 0.0 ) {","\t\tvec2 d;","\t\tvec2 coords;","\t\tcoords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );","\t\tcoords.x = offset[ 0 ].x;","\t\td.x = coords.y;","\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).g;","\t\tcoords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );","\t\td.y = coords.y;","\t\td = d / resolution.y - pixcoord.y;","\t\tvec2 sqrt_d = sqrt( abs( d ) );","\t\tcoords.y -= 1.0 * resolution.y;","\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 0, 1 ) ).g;","\t\tweights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );","\t}","\treturn weights;","}","void main() {","\tgl_FragColor = SMAABlendingWeightCalculationPS( vUv, vPixcoord, vOffset, tDiffuse, tArea, tSearch, ivec4( 0.0 ) );","}"].join("\n")},A={uniforms:{tDiffuse:{value:null},tColor:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 2 ];","void SMAANeighborhoodBlendingVS( vec2 texcoord ) {","\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );","\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );","}","void main() {","\tvUv = uv;","\tSMAANeighborhoodBlendingVS( vUv );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tColor;","uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 2 ];","vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {","\tvec4 a;","\ta.xz = texture2D( blendTex, texcoord ).xz;","\ta.y = texture2D( blendTex, offset[ 1 ].zw ).g;","\ta.w = texture2D( blendTex, offset[ 1 ].xy ).a;","\tif ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {","\t\treturn texture2D( colorTex, texcoord, 0.0 );","\t} else {","\t\tvec2 offset;","\t\toffset.x = a.a > a.b ? a.a : -a.b;","\t\toffset.y = a.g > a.r ? -a.g : a.r;","\t\tif ( abs( offset.x ) > abs( offset.y )) {","\t\t\toffset.y = 0.0;","\t\t} else {","\t\t\toffset.x = 0.0;","\t\t}","\t\tvec4 C = texture2D( colorTex, texcoord, 0.0 );","\t\ttexcoord += sign( offset ) * resolution;","\t\tvec4 Cop = texture2D( colorTex, texcoord, 0.0 );","\t\tfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );","\t\tC.xyz = pow(C.xyz, vec3(2.2));","\t\tCop.xyz = pow(Cop.xyz, vec3(2.2));","\t\tvec4 mixed = mix(C, Cop, s);","\t\tmixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));","\t\treturn mixed;","\t}","}","void main() {","\tgl_FragColor = SMAANeighborhoodBlendingPS( vUv, vOffset, tColor, tDiffuse );","}"].join("\n")},THREE.SMAAEdgesShader=R,THREE.SMAAWeightsShader=B,THREE.SMAABlendShader=A,r.SSAOBlurShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n           vUv = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform vec2 resolution;\n        varying vec2 vUv;\n        void main() {\n           vec2 texelSize = ( 1.0 / resolution );\n           float result = 0.0;\n           for ( int i = - 2; i <= 2; i ++ ) {\n               for ( int j = - 2; j <= 2; j ++ ) {\n                   vec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;\n                   result += texture2D( tDiffuse, vUv + offset ).r;\n               }\n           }\n           gl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );\n        }"},r.GTAOBlurShaderX={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n           vUv = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform vec2 resolution;\n        varying vec2 vUv;\n        void main() {\n            vec4 value = vec4(0);\n            float kernels[3];\n            kernels[0] = 0.12422904287683972;\n            kernels[1] = 0.7515419142463207;\n            kernels[2] = 0.12422904287683972;\n            for (int i = -1; i <= 1; i++){\n                value += texture2D(tDiffuse, (gl_FragCoord.xy + vec2(float(i), 0.0)) / resolution) * kernels[i + 1];\n            }\n            gl_FragColor = value;\n        }"},r.GTAOBlurShaderY={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n           vUv = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform vec2 resolution;\n        varying vec2 vUv;\n        void main() { \n            vec4 value = vec4(0);\n            float kernels[3];\n            kernels[0] = 0.12422904287683972;\n            kernels[1] = 0.7515419142463207;\n            kernels[2] = 0.12422904287683972;\n            for (int i = -1; i <= 1; i++){\n                value += texture2D(tDiffuse, (gl_FragCoord.xy + vec2(0.0, float(i))) / resolution) * kernels[i + 1];\n            }\n            gl_FragColor = value;\n        }"},r.GTAOAccumulate={uniforms:{mainTexture:{value:null},accumulateTexture:{value:null},accumulateIndex:{value:0},resolution:{value:new THREE.Vector2}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n           vUv = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D accumulateTexture;\n        uniform sampler2D mainTexture;\n        uniform float accumulateIndex;\n        uniform vec2 resolution;\n        varying vec2 vUv;\n        float random( vec2 p )\n        {\n            return fract(sin(dot(p.xy, vec2(12.9898, 78.233))) * (43758.5453 + accumulateIndex * 1231.3));\n        }\n        void main() {\n            vec2 invResolution = ( 1.0 / resolution );     \n            vec4 value = vec4(0);\n            vec4 accumulateColor = texture2D(accumulateTexture, vUv);\n            vec4 sampleColor = texture2D(mainTexture, vUv); \n            vec4 result = (sampleColor + (accumulateIndex - 1.0) * accumulateColor) / accumulateIndex;\n            float randAcc = 1.0/255.0 * (random(vUv - 0.5) - 0.5);\n            result += vec4(randAcc, randAcc, randAcc, 0.0);\n            gl_FragColor = result;\n        }\n    "},r.BackgroundShader={uniforms:{mbTexture:{value:null},abTexture:{value:null},isAdditive:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D mbTexture;\n        uniform sampler2D abTexture;\n        uniform float isAdditive;\n        varying vec2 v_textureCoordinates;\n\n        void main(void){\n            vec4 abcolor = texture2D( abTexture, v_textureCoordinates );\n            vec4 mbcolor = texture2D( mbTexture, v_textureCoordinates );\n            vec4 color=vec4(0.0);\n            color = mix(\n                mix(abcolor, vec4(abcolor.rgb, 1.0), \n                    step(\n                        dot(step(abcolor.rgb, vec3(0.0)), vec3(1.0)) + abcolor.a,\n                        0.0\n                    )), \n                color,\n                step(isAdditive, 0.0)\n            );\n\n            if(mbcolor.a >0.0){\n                color = vec4(color.rgb / mbcolor.a + mbcolor.rgb * mbcolor.a, mbcolor.a);\n            }else{\n                color = vec4(color.rgb, color.a * (1.0 - step(1.0 - color.a, 0.0)));\n            }\n            gl_FragColor = color;\n        }\n    "},r.FogShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},darkness:{value:0},fogColor:{value:new THREE.Vector3},visualDistance:{value:0},visibleDistanceSet:{value:!1},visibleDistance:{value:0},startDistance:{value:0},cameraNear:{value:0},cameraFar:{value:0},lightAttenuation:{value:0},firstFlg:{value:0},logDepthBufFC:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform sampler2D depthTexture;\n        uniform float firstFlg;\n\n        uniform float lightAttenuation;\n        uniform float darkness;\n        uniform vec3 fogColor;\n        uniform float visualDistance;\n        uniform float startDistance;\n        uniform bool visibleDistanceSet;\n        uniform float visibleDistance;\n        varying vec2 v_textureCoordinates;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n        #include <depth_parse_fragment>\n\n        #include <postprocess_mix_color>\n        #include <postprocess_original_color>\n        void main(void){\n        //原始颜色获取\n            vec4 color = get_original_color(tDiffuse, v_textureCoordinates, firstFlg);\n            vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);\n            float depth = unpackRGBAToDepth(depthColor);\n            if (depth == 0.0) {depth = 1.0;}\n            float viewZ = getViewZ(depth);\n            float sceneDistacne;\n            if(visibleDistanceSet){\n                sceneDistacne = visibleDistance;\n            } else{\n                sceneDistacne = visualDistance;\n            }\n\n            if(depth>0.0) {\n                if(-viewZ<startDistance){\n                    color = mix_color(color, fogColor, 0.0) ;\n                }\n                else\n                {\n                    float param = 1.0- exp(-lightAttenuation*(-viewZ-startDistance)/(sceneDistacne ));\n                    color = mix_color(color, fogColor, param) ;\n                }\n            }\n            gl_FragColor = mix_color(color, vec3(0), darkness); \n\n        }"},r.RainShader={uniforms:{tDiffuse:{value:null},darkness:{value:.5},density:{value:1},frameNumber:{value:0},viewport:{value:new THREE.Vector4(1,1,1,1)},firstFlg:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform vec4 viewport;\n        varying vec2 v_textureCoordinates;\n        uniform sampler2D tDiffuse;\n        uniform float firstFlg;\n        uniform float frameNumber;\n        uniform float darkness;\n        uniform float density;\n\n        float hash(float x) {\n            return fract(sin(x * 133.3) * 13.13);\n        }\n\n        vec3 rain(vec2 uv, float d){\n           float time = frameNumber / (100.*(1.+0.3*d));\n           vec3 c = vec3(.6, .7, .8);\n           float a = .05; //雨角度\n           float si = sin(a), co = cos(a);\n           uv *= mat2(co, -si, si, co);\n           uv *= length(uv + vec2(0, 4.9)) * .3 + 0.5;\n           float v = 1.0 - sin(hash(floor(uv.x * 150.)) * 2.);\n           float b = clamp(abs(sin(20. * time * v + uv.y * ((10.-d*2.) / (2. + v)))) - .95, 0., 1.) * (8.+d/2.);\n           c *= v * b;\n           if(d==2.0 && (v<0.3||v>0.7)){\n               c=vec3(0.0);\n           }\n           if(d==1.0 && (v<0.33||v>0.4)){\n               c=vec3(0.0);\n           }\n           return c;\n        }\n\n        #include <postprocess_mix_color>\n        #include <postprocess_original_color>\n\n        void main(void){\n        //原始颜色获取\n           vec4 color = get_original_color(tDiffuse, v_textureCoordinates, firstFlg);\n           vec2 resolution = viewport.zw;\n           vec2 uv=(gl_FragCoord.xy*2.-resolution.xy)/min(resolution.x,resolution.y);\n           vec3 rColor = vec3(0.0);\n           if(density>0.0) {\n               rColor = rain(uv,density); \n           }\n           gl_FragColor = mix_color(color, rColor, darkness); \n        }"},THREE.SSAOShader={uniforms:{tDepth:{value:null},tNoise:{value:null},resolution:{value:new THREE.Vector2},cameraNear:{value:1},cameraFar:{value:100},cameraProjection:{value:new THREE.Matrix4},inverseProjection:{value:new THREE.Matrix4},kernelRadius:{value:8},tNormal:{value:null},kernel:{value:null},minDistance:{value:.005},maxDistance:{value:.05},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0}},vertexShader:"\n\n        varying vec2 vUv;\n\n        void main() {\n\n        vUv = uv;\n\n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n        }\n    ",fragmentShader:"\n        //      #include <common>\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n        #include <depth_parse_fragment>\n        #define KERNEL_SIZE 32\n        varying vec2 vUv;\n        uniform sampler2D tNormal;\n        uniform sampler2D tDepth;\n        uniform sampler2D tNoise;\n        uniform vec2 resolution;\n        uniform float kernelRadius;\n        uniform float minDistance; // avoid artifacts caused by neighbour fragments with minimal depth difference\n        uniform float maxDistance; // avoid the influence of fragments which are too far away\n        uniform vec3 kernel[ KERNEL_SIZE ];\n        float getDepth( const in vec2 screenPosition ) {\n           vec4 depthColor = texture2D(tDepth, screenPosition);\n           return unpackRGBAToDepth(depthColor);\n        }\n        \n        vec3 getViewNormal( const in vec2 screenPosition ) {\n        \treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n        }\n        float getLinearDepth( const in vec2 screenPosition ) {\n               float fragCoordZ = getDepth( screenPosition );\n               float viewZ = getViewZ( fragCoordZ );\n               return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n        }\n\n        void main() {\n        \tfloat depth = getDepth( vUv );\n           if(depth == 0.0) {\n               gl_FragColor = vec4( 0.0 );\n               return;\n           }\n           vec3 viewPosition = getViewPosition(depth);\n        \tvec3 viewNormal = getViewNormal( vUv );\n        //    viewNormal = viewNormal.rgb * vec3(1.0,1.0,1.0) ;\n\n        //      \tvec3 tangent = normalize(vec3(0.0, 1.0, 0.0)) ;\n        //      \tvec3 bitangent = cross( viewNormal, tangent );\n        //      \ttangent = cross( viewNormal, bitangent );\n        //         gl_FragColor = vec4( tangent, 1.0 );\n        //      \tmat3 kernelMatrix = mat3(  normalize(tangent), normalize(viewNormal),  normalize(bitangent) );\n\n           vec2 noiseScale = vec2( resolution.x/4.0 , resolution.y/4.0 );\n           vec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;\n           vec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );\n           vec3 bitangent = cross( viewNormal, tangent );\n           mat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );\n\n        //         gl_FragColor = vec4( bitangent, 1.0 );\n           float occlusion = 0.0;\n\n        //         float numTemp = dot(vec3(0.0,0.0,-1.0),viewNormal);\n        //         if(numTemp < 0.001)\n        //         {\n        //             occlusion = -2.0;\n        //         }\n\n           for ( int i = 0; i < KERNEL_SIZE; i ++ ) {\n        //  在视图空间中重新定位样本向量\n        \t\tvec3 sampleVector = (kernelMatrix * kernel[ i ]);\n        // 计算样本点坐标\n        \t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );\n        // 转换NDC\n        \t\tvec4 samplePointNDC = cameraProjection * vec4( samplePoint, 1.0 );\n        \t\tsamplePointNDC /= samplePointNDC.w;\n\n        // 计算uv坐标\n        \t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;\n               float _depth = getDepth( samplePointUv );\n        // 深度缓冲中的默认值为1.0, 表示采样到背景\n               if(_depth == 0.0 )\n               {\n                   continue;\n               }\n\n        //             vec3 viewNormalPoint = getViewNormal(samplePointUv);\n        //             viewNormalPoint = viewNormalPoint.rgb * vec3(-1.0,-1.0,-1.0) ;\n        //             float numTemp = dot(viewNormalPoint, viewNormal);\n        //             if(numTemp < 0.01)\n        //             {\n        //                 continue;\n        //             }\n\n        \t\tfloat realDepth = getLinearDepth( samplePointUv );\n               float sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar ); // compute linear depth of the sample view Z value\n\n        //      \t\tfloat realDepth = -getViewZ( _depth );\n        //      \t\tfloat sampleDepth = -samplePoint.z; // compute linear depth of the sample view Z value\n\n        \t\tfloat delta = sampleDepth - realDepth;\n               float delta2 = realDepth - sampleDepth;\n        \t\tif (delta > minDistance && delta < maxDistance)\n        \t\t{\n        \t\t\tocclusion += 1.0;\n        \t\t}\n\n               if (delta2 > minDistance && delta2 < 1.0)\n               {\n                   occlusion -= 0.5;\n               }\n           }\n           occlusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );\n           if(occlusion > 0.04)\n           {\n               occlusion = 0.04 + occlusion/3.0;\n           }\n           gl_FragColor = vec4( vec3( occlusion ), 1.0 );\n        }"},function(){const e={defines:{MAX_STEP:0,PERSPECTIVE_CAMERA:!0,DISTANCE_ATTENUATION:!0,FRESNEL:!0,USE_METALNESS:!0,INFINITE_THICK:!1},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tMetalness:{value:null},tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new THREE.Vector2},cameraProjectionMatrix:{value:new THREE.Matrix4},cameraInverseProjectionMatrix:{value:new THREE.Matrix4},opacity:{value:.5},maxDistance:{value:180},cameraRange:{value:0},thickness:{value:.018},addedRMStep:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}\n\n\t",fragmentShader:'\n\t\t// precision highp float;\n\t\tprecision highp sampler2D;\n\t\tvarying vec2 vUv;\n\t\tuniform sampler2D tDepth;\n\t\tuniform sampler2D tNormal;\n\t\tuniform sampler2D tMetalness;\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float cameraRange;\n\t\tuniform vec2 resolution;\n\t\tuniform float opacity;\n\t\tuniform float addedRMStep;\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\t\tuniform float maxDistance;\n\t\tuniform float thickness;\n\t\tuniform mat4 cameraProjectionMatrix;\n\t\tuniform mat4 cameraInverseProjectionMatrix;\n\t\t#include <packing>\n\t\t// #include <logdepthbuf_pars_fragment>\n\t\t// #include <depth_parse_fragment>\n\n\t\tfloat pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {\n\t\t\t//x0: point, x1: linePointA, x2: linePointB\n\t\t\t//https://mathworld.wolfram.com/Point-LineDistance3-Dimensional.html\n\t\t\treturn length(cross(x0-x1,x0-x2))/length(x2-x1);\n\t\t}\n\t\tfloat pointPlaneDistance(vec3 point,vec3 planePoint,vec3 planeNormal){\n\t\t\t// https://mathworld.wolfram.com/Point-PlaneDistance.html\n\t\t\t//// https://en.wikipedia.org/wiki/Plane_(geometry)\n\t\t\t//// http://paulbourke.net/geometry/pointlineplane/\n\t\t\tfloat a=planeNormal.x,b=planeNormal.y,c=planeNormal.z;\n\t\t\tfloat x0=point.x,y0=point.y,z0=point.z;\n\t\t\tfloat x=planePoint.x,y=planePoint.y,z=planePoint.z;\n\t\t\tfloat d=-(a*x+b*y+c*z);\n\t\t\tfloat distance=(a*x0+b*y0+c*z0+d)/sqrt(a*a+b*b+c*c);\n\t\t\treturn distance;\n\t\t}\n\t\tfloat getDepth( const in vec2 uv ) {\n\t\t\treturn texture2D( tDepth, uv ).x;\n\t\t\t// vec4 depthColor = texture2D(tNormal, uv);\n            // return depthColor.w;\n\t\t\treturn unpackRGBAToDepth(texture2D( tDepth, uv ));\n\t\t\treturn texture2D( tDepth, uv ).x;\n\t\t}\n\t\tfloat getViewZ( const in float depth ) {\n\t\t\t#ifdef PERSPECTIVE_CAMERA\n\t\t\t\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n\t\t\t#else\n\t\t\t\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n\t\t\t#endif\n\t\t}\n\t\tvec3 getViewPosition( const in vec2 uv, const in float depth/*clip space*/, const in float clipW ) {\n\t\t\tvec4 clipPosition = vec4( ( vec3( uv, depth ) - 0.5 ) * 2.0, 1.0 );//ndc\n\t\t\tclipPosition *= clipW; //clip\n\t\t\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;//view\n\t\t}\n\t\tvec3 getViewNormal( const in vec2 uv ) {\n\t\t\t//return texture2D( tNormal, uv ).xyz;\n\t\t\treturn unpackRGBToNormal( texture2D( tNormal, uv ).xyz );\n\t\t}\n\t\tvec2 viewPositionToXY(vec3 viewPosition){\n\t\t\tvec2 xy;\n\t\t\tvec4 clip=cameraProjectionMatrix*vec4(viewPosition,1);\n\t\t\txy=clip.xy;//clip\n\t\t\tfloat clipW=clip.w;\n\t\t\txy/=clipW;//NDC\n\t\t\txy=(xy+1.)/2.;//uv\n\t\t\txy*=resolution;//screen\n\t\t\treturn xy;\n\t\t}\n\t\tvoid main(){\n\n\t\t\tfloat metalness=texture2D(tMetalness,vUv).a;\n\t\t\tif(metalness <= 0.2 ) return;\n\n\n\t\t\tfloat depth = getDepth( vUv );\n\t\t\tfloat viewZ = getViewZ( depth );\n\t\t\tif(-viewZ>=cameraFar) return;\n\n\t\t\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ+cameraProjectionMatrix[3][3];\n\t\t\tvec3 viewPosition=getViewPosition( vUv, depth, clipW );\n\n\t\t\tvec2 d0=gl_FragCoord.xy;\n\t\t\tvec2 d1;\n\n\t\t\tvec3 viewNormal=getViewNormal( vUv );\n\n\t\t\t#ifdef PERSPECTIVE_CAMERA\n\t\t\t\tvec3 viewIncidentDir=normalize(viewPosition);\n\t\t\t\tvec3 viewReflectDir=reflect(viewIncidentDir,viewNormal);\n\t\t\t#else\n\t\t\t\tvec3 viewIncidentDir=vec3(0,0,-1);\n\t\t\t\tvec3 viewReflectDir=reflect(viewIncidentDir,viewNormal);\n\t\t\t#endif\n\n\t\t\tfloat maxReflectRayLen=maxDistance/dot(-viewIncidentDir,viewNormal);\n\t\t\t// dot(a,b)==length(a)*length(b)*cos(theta) // https://www.mathsisfun.com/algebra/vectors-dot-product.html\n\t\t\t// if(a.isNormalized&&b.isNormalized) dot(a,b)==cos(theta)\n\t\t\t// maxDistance/maxReflectRayLen=cos(theta)\n\t\t\t// maxDistance/maxReflectRayLen==dot(a,b)\n\t\t\t// maxReflectRayLen==maxDistance/dot(a,b)\n\n\t\t\tvec3 d1viewPosition=viewPosition+viewReflectDir*maxReflectRayLen;\n\t\t\t#ifdef PERSPECTIVE_CAMERA\n\t\t\t\tif(d1viewPosition.z>-cameraNear){\n\t\t\t\t\t//https://tutorial.math.lamar.edu/Classes/CalcIII/EqnsOfLines.aspx\n\t\t\t\t\tfloat t=(-cameraNear-viewPosition.z)/viewReflectDir.z;\n\t\t\t\t\td1viewPosition=viewPosition+viewReflectDir*t;\n\t\t\t\t}\n\t\t\t#endif\n\t\t\td1=viewPositionToXY(d1viewPosition);\n\n\t\t\tfloat totalLen=length(d1-d0);\n\t\t\tfloat xLen=d1.x-d0.x;\n\t\t\tfloat yLen=d1.y-d0.y;\n\t\t\tfloat totalStep=max(abs(xLen),abs(yLen));\n\t\t\tfloat xSpan=xLen/totalStep;\n\t\t\tfloat ySpan=yLen/totalStep;\n\t\t\tfor(float i=0.;i<float(MAX_STEP);i++){\n\t\t\t\ti += addedRMStep;//0.500;\n\n\t\t\t\tif(i>=totalStep) break;\n\t\t\t\tvec2 xy=vec2(d0.x+i*xSpan,d0.y+i*ySpan);\n\t\t\t\tif(xy.x<0.||xy.x>resolution.x||xy.y<0.||xy.y>resolution.y) break;\n\t\t\t\tfloat s=length(xy-d0)/totalLen;\n\t\t\t\tvec2 uv=xy/resolution;\n\n\t\t\t\tfloat d = getDepth(uv);\n\t\t\t\tfloat vZ = getViewZ( d );\n\t\t\t\tif(-vZ>=cameraFar) continue;\n\t\t\t\tfloat cW = cameraProjectionMatrix[2][3] * vZ+cameraProjectionMatrix[3][3];\n\t\t\t\tvec3 vP=getViewPosition( uv, d, cW );\n\n\t\t\t\t#ifdef PERSPECTIVE_CAMERA\n\t\t\t\t\t// https://comp.nus.edu.sg/~lowkl/publications/lowk_persp_interp_techrep.pdf\n\t\t\t\t\tfloat recipVPZ=1./viewPosition.z;\n\t\t\t\t\tfloat viewReflectRayZ=1./(recipVPZ+s*(1./d1viewPosition.z-recipVPZ));\n\t\t\t\t#else\n\t\t\t\t\tfloat viewReflectRayZ=viewPosition.z+s*(d1viewPosition.z-viewPosition.z);\n\t\t\t\t#endif\n\n\t\t\t\t// if(viewReflectRayZ>vZ) continue; // will cause "npm run make-screenshot webgl_postprocessing_ssr" high probability hang.\n\t\t\t\t// https://github.com/mrdoob/three.js/pull/21539#issuecomment-821061164\n\t\t\t\tif(viewReflectRayZ<=vZ){\n\n\t\t\t\t\tbool hit;\n\t\t\t\t\t#ifdef INFINITE_THICK\n\t\t\t\t\t\thit=true;\n\t\t\t\t\t#else\n\t\t\t\t\t\tfloat away=pointToLineDistance(vP,viewPosition,d1viewPosition);\n\n\t\t\t\t\t\tfloat minThickness;\n\t\t\t\t\t\tvec2 xyNeighbor=xy;\n\t\t\t\t\t\txyNeighbor.x+=1.;\n\t\t\t\t\t\tvec2 uvNeighbor=xyNeighbor/resolution;\n\t\t\t\t\t\tvec3 vPNeighbor=getViewPosition(uvNeighbor,d,cW);\n\t\t\t\t\t\tminThickness=vPNeighbor.x-vP.x;\n\t\t\t\t\t\tminThickness*=3.;\n\t\t\t\t\t\tfloat tk=max(minThickness,thickness);\n\n\t\t\t\t\t\thit=away<=tk;\n\t\t\t\t\t#endif\n\n\t\t\t\t\tif(hit){\n\t\t\t\t\t\tvec3 vN=getViewNormal( uv );\n\t\t\t\t\t\tif(dot(viewReflectDir,vN)>=0.) continue;\n\n\t\t\t\t\t\tfloat op=opacity;\n\t\t\t\t\t\t\n\t\t\t\t\t\tfloat distance=pointPlaneDistance(vP,viewPosition,viewNormal);\n\t\t\t\t\t\tif(distance>maxDistance) break;\n\t\t\t\t\t\t#ifdef DISTANCE_ATTENUATION\n\t\t\t\t\t\t\tfloat ratio=1.-(distance/maxDistance);\n\t\t\t\t\t\t\tfloat attenuation=ratio*ratio;\n\t\t\t\t\t\t\top=opacity*attenuation;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\n\t\t\t\t\t\t#ifdef FRESNEL\n\t\t\t\t\t\t\tfloat fresnelCoe=(dot(viewIncidentDir,viewReflectDir)+1.)/2.;\n\t\t\t\t\t\t\top*=fresnelCoe;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tvec4 reflectColor=texture2D(tDiffuse,uv);\n\t\t\t\t\t\tgl_FragColor.xyz=reflectColor.xyz;\n\n\t\t\t\t\t\tgl_FragColor.a=op*metalness; \n\t\t\t\t\t\tclamp(gl_FragColor.a, 0.1, 1.0);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t'},t={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}\n\n\t",fragmentShader:"\n\n\t\tuniform sampler2D tDepth;\n\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\n\t\tvarying vec2 vUv;\n\n\t\t#include <packing>\n\n\t\tfloat getLinearDepth( const in vec2 uv ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\tfloat fragCoordZ = texture2D( tDepth, uv ).x;\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn texture2D( tDepth, uv ).x;\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tfloat depth = getLinearDepth( vUv );\n\t\t\tfloat d = 1.0 - depth;\n\t\t\t// d=(d-.999)*1000.;\n\t\t\tgl_FragColor = vec4( vec3( d ), 1.0 );\n\n\t\t}\n\n\t"},i={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2},opacity:{value:.5}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}\n\n\t",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec2 resolution;\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\t//reverse engineering from PhotoShop blur filter, then change coefficient\n\n\t\t\tvec2 texelSize = ( 1.0 / resolution );\n\n\t\t\tvec4 c=texture2D(tDiffuse,vUv);\n\n\t\t\tvec2 offset;\n\n\t\t\toffset=(vec2(-1,0))*texelSize;\n\t\t\tvec4 cl=texture2D(tDiffuse,vUv+offset);\n\n\t\t\toffset=(vec2(1,0))*texelSize;\n\t\t\tvec4 cr=texture2D(tDiffuse,vUv+offset);\n\n\t\t\toffset=(vec2(0,-1))*texelSize;\n\t\t\tvec4 cb=texture2D(tDiffuse,vUv+offset);\n\n\t\t\toffset=(vec2(0,1))*texelSize;\n\t\t\tvec4 ct=texture2D(tDiffuse,vUv+offset);\n\n\t\t\t// float coeCenter=.5;\n\t\t\t// float coeSide=.125;\n\t\t\tfloat coeCenter=.2;\n\t\t\tfloat coeSide=.2;\n\t\t\tfloat a=c.a*coeCenter+cl.a*coeSide+cr.a*coeSide+cb.a*coeSide+ct.a*coeSide;\n\t\t\tvec3 rgb=(c.rgb*c.a*coeCenter+cl.rgb*cl.a*coeSide+cr.rgb*cr.a*coeSide+cb.rgb*cb.a*coeSide+ct.rgb*ct.a*coeSide)/a;\n\t\t\tgl_FragColor=vec4(rgb,a);\n\n\t\t}\n\t"};THREE.SSRBlurShader=i,THREE.SSRDepthShader=t,THREE.SSRShader=e}(),r.GTAOShader={uniforms:{resolution:{value:new THREE.Vector2},cameraNear:{value:1},cameraFar:{value:100},cameraProjection:{value:new THREE.Matrix4},inverseProjection:{value:new THREE.Matrix4},tNormal:{value:null},accumulateIndex:{value:0},radius:{value:0},viewport:{value:new THREE.Vector4},nearPlaneSize:{value:new THREE.Vector3},viewportInv:{value:new THREE.Vector4},SAMPLES:{value:[]},uIsPerspective:{value:!0}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",fragmentShader:"\n        //#include <common>\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n        #include <depth_parse_fragment>\n\n        varying vec2 vUv;\n        uniform sampler2D tNormal;\n        uniform vec2 resolution;\n        uniform vec3 nearPlaneSize;\n        uniform float radius;\n        uniform float accumulateIndex;\n        uniform vec4 viewportInv;\n        uniform bool uIsPerspective;\n        const int MAX_SAMPLE_COUNT = 8;\n        uniform vec2 SAMPLES[MAX_SAMPLE_COUNT];\n\n        float getViewZ( const in vec2 screenPosition ) {\n            vec4 depthColor = texture2D(tNormal, screenPosition);\n            return depthColor.w;\n        }\n         \n        vec3 getViewNormal( const in vec2 screenPosition ) {\n            return texture2D( tNormal, screenPosition ).xyz;\n        }\n\n        vec4 getViewNormalDepth(sampler2D tex, vec2 fragCoord) {\n            vec2 texcoord = fragCoord * 0.5 + vec2(0.5);\n            float depth = getViewZ(texcoord);\n            vec3 vNormal = getViewNormal(texcoord);\n            return vec4(vNormal,depth);\n        }\n\n        vec3 getViewPosition(vec2 fragCoord, float depth) {\n            vec3 eyeDirection = nearPlaneSize * vec3(fragCoord, 1.0);\n            vec3 viewPosition;\n            viewPosition.z = depth;\n            if(uIsPerspective)\n            {\n                viewPosition.xy = eyeDirection.xy * depth / eyeDirection.z;\n            }\n            else\n            {\n                viewPosition.xy = eyeDirection.xy;\n            }\n            return viewPosition;\n            // float clipW = cameraProjection[2][3] * viewZ + cameraProjection[3][3];\n            //     vec4 clipPosition = vec4( ( vec3( gl_FragCoord.xy / viewport.zw, depth ) - 0.5 ) * 2.0, 1.0 );\n            //     clipPosition *= clipW; //unprojection\n            //     vec4 viewPosition = inverseProjection * clipPosition;\n        }\n\n        vec3 getScreenPosition(vec3 viewPos) {\n            if(uIsPerspective)\n            {\n                return vec3(viewPos.xy * nearPlaneSize.z / nearPlaneSize.xy / viewPos.z, viewPos.z);\n            }\n            return vec3(viewPos.xy / nearPlaneSize.xy, viewPos.z);      \n        }\n\n        vec3 getOffsetViewPosition(sampler2D tNormal, vec3 viewPos, vec2 offset) {\n            vec2 screenPosition = getScreenPosition(viewPos).xy;\n            vec2 screenOffset = getScreenPosition(vec3(offset, viewPos.z)).xy;\n            vec2 pixOffset = screenOffset * viewportInv.xy * 0.5;\n            screenOffset = mix(\n                (floor(pixOffset + 0.5) ) * viewportInv.zw * 2.0,\n                screenOffset,\n                step(length(pixOffset), 2.0)\n            );\n            // if(length(pixOffset) > 2.0) {\n            //     screenOffset = (floor(pixOffset + 0.5) ) * viewportInv.zw * 2.0;\n            // }\n            float sampDepth = getViewNormalDepth(tNormal, screenPosition + screenOffset).w;\n            return getViewPosition(screenPosition + screenOffset, sampDepth);\n        }\n\n        vec3 GTAOMultiBounce(float x, vec3 albedo) {\n            vec3 a = 2.0404 * albedo - 0.3324;\n            vec3 b = -4.7951 * albedo + 0.6417;\n            vec3 c = 2.7552 * albedo + 0.6903;\n            return max( vec3(x, x, x), ( ( x * a + b ) * x + c ) * x );\n        }\n\n        //pseudorandom-looking\n        float random(vec2 p) {\n            return fract(sin(dot(p.xy, vec2(12.9898, 78.233))) * (43758.5453 + (accumulateIndex) * 1231.3));\n        }\n\n        void main() {\n            const float maxScreenSampleRadius = 0.4;\n            const float FallOffDistance = 0.0;\n            const float randScale = 0.4;\n            const float aoStrength = 1.2;\n            const float PI = 3.1415926535898;\n            const float HalfPI = 1.570796326794895;\n            vec2 coord = vUv * 2.0 - vec2(1.0);\n\n            vec4 normalDepth = getViewNormalDepth(tNormal, coord);\n            vec3 viewPosition = getViewPosition(coord, normalDepth.w);\n            vec3 vNormal = normalDepth.xyz;\n\n            if (length(vNormal) < 0.98) {\n                gl_FragColor = vec4(1.0);\n                return;\n            }\n\n            vec2 projectScreenRadius = getViewPosition(vec2(1.0, 1.0) * maxScreenSampleRadius, normalDepth.w).xy;\n            vec3 viewDir = vec3(0.0, 0.0, 1.0);\n            float radiusScale = 1.0 + randScale * (random(coord * 0.5 - 0.5) - 0.5);\n            float stepRadius = radiusScale * min(radius, min(projectScreenRadius.x, projectScreenRadius.y));\n\n            if(uIsPerspective)\n            {\n                viewDir = normalize(-nearPlaneSize * vec3(coord, 1.0));\n            }\n\n            vec3 sliceDir = normalize(vec3(SAMPLES[7], 0.0));\n            //得到Slice平面的法线向量\n            vec3 normalSlicePlane = normalize(cross(viewDir, sliceDir));\n            vec3 normalSliceProj = normalize(vNormal - normalSlicePlane * dot(vNormal, normalSlicePlane));\n            float gamma = acos(dot(normalSliceProj, viewDir)) * sign(dot(cross(normalSlicePlane, viewDir), normalSliceProj));\n            float weightH1 = gamma + HalfPI;\n\n            for (int dirCnt = 0; dirCnt < MAX_SAMPLE_COUNT; ++dirCnt) {\n                vec2 sampleDir = SAMPLES[dirCnt];\n                vec3 offsetPosition = getOffsetViewPosition(tNormal, viewPosition, sampleDir * stepRadius);\n                vec3 viewDis = offsetPosition - viewPosition;\n                float h1 = min(acos(dot(normalize(viewDis), viewDir)), HalfPI + gamma);\n                float weight = 1.0 - clamp((length(viewDis) / stepRadius - FallOffDistance), 0.0, 1.0);\n                weightH1 = mix(weightH1, min(weightH1, h1), weight);\n            }\n\n            float weightH2 = -gamma + HalfPI;\n            for(int dirCnt = 0; dirCnt < MAX_SAMPLE_COUNT; ++dirCnt) {\n                vec2 sampleDir = -SAMPLES[dirCnt];\n                vec3 offsetPosition = getOffsetViewPosition(tNormal, viewPosition, sampleDir * stepRadius);\n                vec3 viewDis = offsetPosition - viewPosition;\n                float h2 = min(acos(dot(normalize(viewDis), viewDir)), HalfPI - gamma);\n                float weight = 1.0 - clamp((length(viewDis) / stepRadius - FallOffDistance), 0.0, 1.0);\n                weightH2 = mix(weightH2, min(weightH2, h2), weight);\n            }\n            \n            float visibilityAcc = 1.0 - (cos(weightH1) + cos(weightH2)) * 0.5 * aoStrength;\n            vec3 ao = GTAOMultiBounce(visibilityAcc, vec3(1.0, 1.0, 1.0));\n            gl_FragColor = vec4(ao, 1.0);\n        }"},r.SeperableBlurShader={defines:{MAX_RADIUS:1},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"\n            varying vec2 vUv;\n            void main() {\n                vUv = uv;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            #include <common>\n            varying vec2 vUv;\n            uniform sampler2D colorTexture;\n            uniform vec2 texSize;\n            uniform vec2 direction;\n            uniform float kernelRadius;\n\n            float gaussianPdf(in float x, in float sigma) {\n                return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n            }\n            void main() {\n                vec4 orginColor = texture2D( colorTexture, vUv);\n                vec2 invSize = 1.0 / texSize;\n                float weightSum = gaussianPdf(0.0, kernelRadius);\n                vec4 diffuseSum = orginColor * weightSum;\n                vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\n                vec2 uvOffset = delta;\n                for( int i = 1; i <= MAX_RADIUS; i ++ ) {\n                    float w = gaussianPdf(uvOffset.x, kernelRadius);\n                    vec4 sample1 = texture2D( colorTexture, vUv + uvOffset);\n                    vec4 sample2 = texture2D( colorTexture, vUv - uvOffset);\n                    diffuseSum += ((sample1 + sample2) * w);\n                    weightSum += (2.0 * w);\n                    uvOffset += delta;\n                }\n                gl_FragColor = diffuseSum/weightSum;\n            }\n        "},r.FogPass=function(e,t,i,n,a){var s=this;THREE.Pass.call(s),s.renderComposer=e,s.shader=r.FogShader,s.darkness=.1,s.lightAttenuation=.5,s.visualDistance=5e4,s.startDistance=0,s.visibleDistance=5e4,s.visibleDistanceSet=!1,s.fogColor=new THREE.Vector3(1,1,1),s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.camera=i,s.scene=t,s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad),s.enabled=!1},r.FogPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.FogPass,setOpts:function(e){var t=this;e&&(void 0!==e.darkness&&null!==e.darkness&&(t.darkness=e.darkness),void 0!==e.visualDistance&&null!==e.visualDistance&&(t.visualDistance=e.visualDistance),void 0!==e.startDistance&&null!==e.startDistance&&(t.startDistance=e.startDistance),void 0!==e.visibleDistance&&null!==e.visibleDistance&&(t.visibleDistance=e.visibleDistance),void 0!==e.visibleDistanceSet&&null!==e.visibleDistanceSet&&(t.visibleDistanceSet=e.visibleDistanceSet),void 0!==e.lightAttenuation&&null!==e.lightAttenuation&&(t.lightAttenuation=e.lightAttenuation),void 0!==e.fogColor&&null!==e.fogColor&&(t.fogColor=new THREE.Vector3(e.fogColor.r,e.fogColor.g,e.fogColor.b)))},getOpts:function(){var e=this;return{darkness:e.darkness,visualDistance:e.visualDistance,startDistance:e.startDistance,visibleDistance:e.visibleDistance,visibleDistanceSet:e.visibleDistanceSet,lightAttenuation:e.lightAttenuation,fogColor:new THREE.Color(e.fogColor.x,e.fogColor.y,e.fogColor.z)}},render:function(e,t,i,r,n,a){var s=this;null!=s.camera&&null!=s.scene&&(s.uniforms.cameraNear.value=s.camera.near,s.uniforms.cameraFar.value=s.camera.far,s.uniforms.depthTexture.value=s.renderComposer.getDepthTexture(),s.uniforms.logDepthBufFC.value=2/(Math.log(s.camera.far+1)/Math.LN2)),s.uniforms.fogColor.value=s.fogColor,s.uniforms.visualDistance.value=s.visualDistance,s.uniforms.startDistance.value=s.startDistance,s.uniforms.visibleDistance.value=s.visibleDistance,s.uniforms.visibleDistanceSet.value=s.visibleDistanceSet,s.uniforms.darkness.value=s.darkness,s.uniforms.lightAttenuation.value=s.lightAttenuation,s.uniforms.tDiffuse&&(s.uniforms.tDiffuse.value=i.texture),s.uniforms.firstFlg&&(s.uniforms.firstFlg.value=a?0:1),s.quad.material=s.material;var o=e.getRenderTarget();e.setRenderTarget(t),s.clear&&e.clear(),e.render(s.postScene,s.postCamera),e.setRenderTarget(o)},dispose:function(){},setSize(e,t){}}),r.SkylinePass=function(e,t,i,n,a){var s=this;THREE.Pass.call(s),s.renderComposer=e,s.shader=r.SkylineShader,s.skylineColor=new THREE.Vector3(1,0,0),s.skylineWidth=1,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.camera=i,s.scene=t,s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad),s.copyMaterial=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(THREE.CopyShader.uniforms),vertexShader:THREE.CopyShader.vertexShader,fragmentShader:THREE.CopyShader.fragmentShader,transparent:!0}),s.enabled=!1},r.SkylinePass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.SkylinePass,setOpts:function(e){e&&(void 0!==e.skylineColor&&null!==e.skylineColor&&(this.skylineColor=new THREE.Vector3(e.skylineColor.r,e.skylineColor.g,e.skylineColor.b)),void 0!==e.skylineWidth&&null!==e.skylineWidth&&(this.skylineWidth=e.skylineWidth))},getOpts:function(){var e=this;return{skylineColor:new THREE.Color(e.skylineColor.x,e.skylineColor.y,e.skylineColor.z),skylineWidth:e.skylineWidth}},render:function(e,t,i,r,n,a){var s=this;let o=e.autoClear;e.autoClear=!1,null!=s.camera&&null!=s.scene&&(s.uniforms.cameraNear.value=s.camera.near,s.uniforms.cameraFar.value=s.camera.far,s.uniforms.depthTexture.value=s.renderComposer.getDepthTexture(),s.uniforms.logDepthBufFC.value=2/(Math.log(s.camera.far+1)/Math.LN2)),s.uniforms.skylineColor.value.set(s.skylineColor.x,s.skylineColor.y,s.skylineColor.z),s.uniforms.skylineWidth.value=s.skylineWidth,s.uniforms.viewport.value.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight);var l=e.getRenderTarget();e.setRenderTarget(t),s.clear&&e.clear(),s.quad.material=s.material,e.render(s.postScene,s.postCamera),s.copyMaterial.uniforms.tDiffuse.value=i.texture,s.quad.material=s.copyMaterial,e.render(s.postScene,s.postCamera),e.setRenderTarget(l),e.autoClear=o},dispose:function(){},setSize(e,t){}}),r.SkylineShader={uniforms:{depthTexture:{value:null},skylineColor:{value:new THREE.Vector3},skylineWidth:{value:1},cameraNear:{value:0},cameraFar:{value:0},logDepthBufFC:{value:0},viewport:{value:new THREE.Vector4}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",fragmentShader:" \n        uniform sampler2D depthTexture;\n        uniform vec3 skylineColor;\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform vec4 viewport;\n        uniform float skylineWidth;\n        varying vec2 v_textureCoordinates;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n\n        float getDepth(in vec4 depthColor){\n            float result = unpackRGBAToDepth(depthColor);\n            if (result == 0.0) {\n                return 1.0;\n            }\n\n            return result;\n        }\n        bool isSkyline(vec2 uv,float pixelWidth){\n            vec2 pixelSize = pixelWidth / viewport.zw;\n            float dx0 = -pixelSize.x;\n            float dy0 = -pixelSize.y;\n            float dx1 = pixelSize.x;\n            float dy1 = pixelSize.y;\n\n            vec2 currUV = uv + vec2(dx0, dy0);\n            vec4 depthColor = texture2D(depthTexture, currUV);\n            float depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(0.0, dy0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, dy0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx0, 0.0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, 0.0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx0, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(0.0, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            return false;\n        }\n\n        void main(void){\n            vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);\n            float depth = getDepth(depthColor);\n            if (depth >= 1.0) {\n                gl_FragColor = vec4(0.0); \n                return;\n            }\n            bool skyline = isSkyline(v_textureCoordinates, skylineWidth);\n            if(skyline){\n                gl_FragColor = vec4(skylineColor, 1.0);\n                return;\n            }\n            gl_FragColor = vec4(0.0);\n            // gl_FragColor = vec4(vec3(depth), 1.0);\n        }\n    "},r.SnowShader={uniforms:{tDiffuse:{value:null},tNormal:{value:null},darkness:{value:.5},density:{value:1},thickness:{value:.5},frameNumber:{value:0},viewport:{value:new THREE.Vector4(1,1,1,1)},cameraNear:{value:1},cameraFar:{value:100},inverseViewRotation:{value:new THREE.Matrix3},firstFlg:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n        uniform float cameraNear;\n        uniform float cameraFar;\n\n        uniform mat3 inverseViewRotation;\n        uniform vec4 viewport;\n        uniform float frameNumber;\n        uniform float darkness;\n        uniform float density;\n        uniform sampler2D tDiffuse;\n        uniform sampler2D tNormal;\n        uniform float thickness;\n        varying vec2 v_textureCoordinates;\n        uniform float firstFlg;\n\n        float snow(vec2 uv,float scale){\n            float time = frameNumber / 60.0;\n            float w=smoothstep(1.,0.,-uv.y*(scale/10.));if(w<.1)return 0.;\n            uv+=time/scale;uv.y+=time*2./scale;uv.x+=sin(uv.y+time*.5)/scale;\n            uv*=scale;vec2 s=floor(uv),f=fract(uv),p;float k=3.,d;\n            p=.5+.35*sin(11.*fract(sin((s+p+scale)*mat2(7,3,6,5))*5.))-f;d=length(p);k=min(d,k);\n            k=smoothstep(0.,k,sin(f.x+f.y)*0.01);\n            return k*w;\n        }\n\n        #include <packing>\n\n        vec3 getViewNormal(in sampler2D tn,const in vec2 screenPosition){\n           return unpackRGBToNormal(texture2D(tn,screenPosition).xyz);\n        }\n\n        float getDotNumWC(vec3 nor, mat3 rotation){\n            vec3 normalWC = normalize(rotation * nor);\n            return dot(vec3(0.0,1.0,0.0),normalWC);\n        }\n\n        #include <postprocess_mix_color>\n        #include <postprocess_original_color>\n\n        void main(void){\n        //原始颜色获取\n           vec4 color = get_original_color(tDiffuse, v_textureCoordinates,firstFlg);\n           if(thickness>0.0) {\n               vec3 tNor = getViewNormal(tNormal, v_textureCoordinates);\n        //通过镜头坐标系中坐标计算面法线向量\n               float dotNumWC = getDotNumWC(tNor, inverseViewRotation);//unpackRGBToNormal has been changed in new version threejs\n\n               if(dotNumWC<0.3){\n                   dotNumWC=0.3;\n               } else if(dotNumWC>1.0){\n                   dotNumWC=1.0;\n               }\n               color = mix_color(color, vec3(1.0), dotNumWC*thickness); \n           }\n\n           vec2 resolution = viewport.zw;\n           vec2 uv=(gl_FragCoord.xy*2.-resolution.xy)/min(resolution.x,resolution.y);\n           vec3 finalColor=vec3(0);\n           float c = 0.0;\n           if(density>2.0){\n               c+=snow(uv,35.);\n               c+=snow(uv,20.);\n               c+=snow(uv,8.);\n           }\n           if(density>1.0){\n               c+=snow(uv,30.);\n               c+=snow(uv,15.);\n               c+=snow(uv,6.);\n           }\n           if(density>0.0){\n               c+=snow(uv,25.);\n               c+=snow(uv,10.);\n               c+=snow(uv,5.);\n               finalColor=(vec3(c)); \n           }\n           gl_FragColor = mix_color(color, finalColor, darkness); \n        }"},r.ScanRingShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},color:{value:new THREE.Vector4},radius:{value:0},time:{value:0},cameraNear:{value:1},cameraFar:{value:100},progressive:{value:2},scanCenterEC:{value:new THREE.Vector4},scanPlaneNormalEC:{value:new THREE.Vector3},inverseProjection:{value:new THREE.Matrix4},cameraProjection:{value:new THREE.Matrix4},firstFlg:{value:0},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0},matrixWorld:{value:new THREE.Vector4},minHeight:{value:0},maxHeight:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",fragmentShader:"\n\n        uniform float firstFlg;\n        uniform float minHeight;\n        uniform float maxHeight;\n\n        uniform float radius;\n        uniform float time;\n        uniform vec4 color;\n        uniform float progressive;\n\n        uniform vec3 scanPlaneNormalEC;\n        uniform vec4 scanCenterEC;\n        uniform mat4 matrixWorld;\n\n        uniform sampler2D tDiffuse;\n        uniform sampler2D depthTexture;\n        varying vec2 v_textureCoordinates;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n        #include <depth_parse_fragment>\n\n        vec3 pointProjectOnPlane(in vec3 planeNormal, in vec3 planeOrigin, in vec3 point)\n        {\n           vec3 v01 = point-planeOrigin;\n           float d = dot(planeNormal, v01) ;\n           return (point - planeNormal * d);\n        }\n        #include <postprocess_mix_color>\n        #include <postprocess_original_color>\n\n        void main(void){\n        //原始颜色获取\n           vec4 originalColor = get_original_color(tDiffuse, v_textureCoordinates,firstFlg);\n           vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);\n           float depth = unpackRGBAToDepth(depthColor);\n           vec3 viewPos = getViewOriginPosition(depth);\n\n           if(dot(scanPlaneNormalEC, viewPos)>0.0){\n               gl_FragColor = originalColor;\n               return;\n           }\n\n           vec3 prjOnPlane = pointProjectOnPlane(scanPlaneNormalEC.xyz, scanCenterEC.xyz, viewPos.xyz);\n           float dis = length(prjOnPlane.xyz - scanCenterEC.xyz);\n\n           float _radius = time * radius;\n           float _time = (1.0-time) * 0.75 + 0.25;\n           float f = dis/ _radius;\n           f = min(f, 1.0);\n           f = max(f, 0.0);\n\n           f = mix(\n                max(pow(f, progressive), 0.1),\n                0.0,\n                step(1.0, f)\n           );\n\n            //    if(f == 1.0){    // 0.0 <= f <= 1.0     f == 1.0 => !(f < 1.0)\n            //        f = 0.0;\n            //    }else{\n            //        f = pow(f, progressive);\n            //        f = max(f, 0.1);\n            //    }\n\n           vec4 wpos = matrixWorld * vec4( viewPos, 1.0 );\n\n           if(minHeight != maxHeight && (wpos.y < minHeight || wpos.y > maxHeight)) {\n               gl_FragColor = originalColor;\n               return;\n           };\n\n           gl_FragColor = mix(\n                mix_color(originalColor, color.xyz*pow(f,0.1), f * color.w * _time),\n                originalColor,\n                step(depth, 0.0)\n           );\n\n        //    if(depth == 0.0){    // 0 <= depth <=1   depth == 0.0 => !(depth > 0.0)  \n        //        gl_FragColor = originalColor;\n        //    }else{\n        //        gl_FragColor = mix_color(originalColor, color.xyz*pow(f,0.1), f * color.w * _time); \n        //    }\n        //         vec4 a =cameraProjection * vec4(viewPos,1.0);\n        //         a= a /a.w ;\n        //         gl_FragColor =  a*0.5+0.5;\n        //         gl_FragColor.ba = vec2(0.0, 1.0) ;\n        //         gl_FragColor = vec4(vec3(viewPos.z/(cameraNear-cameraFar)),1.0);\n        //         if(length(viewPos) < 100.0){\n        //             gl_FragColor = originalColor;\n        //             return;\n        //         }\n        //         vec4 bb =viewMatrix1*vec4(0.0,0.0,0.0,1.0);\n        //             float dis1 = length(viewPos.xyz - bb.xyz);\n        //             if(dis1 <500.0){\n        //                 gl_FragColor= vec4(1.0,0.0,0.0,1.0);\n        //             }else{\n        //                 gl_FragColor = originalColor;\n        //         }\n        //         vec4 posWC = inverseView * vec4(viewPos,1.0);\n        //         if(depth == 1.0){\n        //             gl_FragColor = originalColor;\n        //         }else{\n        //             if(posWC.x > 10.0){\n        //                 gl_FragColor = vec4(1.0,0.0,0.0,1.0);\n        //             }else{\n        //                 gl_FragColor = originalColor;\n        //             }\n        //         }\n        }\n    "},r.RingScanShader={uniforms:{backGroundColor:{value:new THREE.Vector3},radius:{value:0},time:{value:0},progressive:{value:2},scanCenter:{value:new THREE.Vector4}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n\n        varying vec2 vCoordinates;\n        \n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n\n            #ifdef USE_ENVMAP\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n            #endif\n            \n            vCoordinates = vec2(position.x, position.y);\n            \n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform vec3 backGroundColor;\n        uniform float radius;\n        uniform float progressive;\n        uniform float time;\n        uniform vec4 scanCenter;\n        uniform vec3 diffuse;\n        uniform float opacity;\n\n        varying vec2 vCoordinates;\n\n        #include <flat_shaded_pars_fragment>\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        \n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            float dis = length(vCoordinates.xy - scanCenter.xy);\n\n            float _radius = time * radius;\n            float _time = (1.0-time) * 0.75 + 0.25;\n            float f = dis/ _radius;\n            if(f > 1.0 || f < 0.0){\n                discard;\n            }\n            f = pow(f, progressive);\n            f = max(f, 0.1);\n            gl_FragColor = vec4(backGroundColor*pow(f,0.1), f * opacity * _time);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.FanScanPassShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},cameraNear:{value:1},cameraFar:{value:100},scanCenter:{value:new THREE.Vector4},scanPlaneNormalEC:{value:new THREE.Vector3},inverseProjection:{value:new THREE.Matrix4},cameraProjection:{value:new THREE.Matrix4},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0},matrixWorld:{value:new THREE.Vector4},radius:{value:0},fanAngle:{value:0},time:{value:0},backgroundColor:{value:new THREE.Vector3(1,1,1)},backgroundOpacity:{value:0},color:{value:new THREE.Vector3(1,1,1)},opacity:{value:0}},vertexShader:"\n        varying vec2 v_textureCoordinates;\n        varying vec2 vCoordinates;\n        void main() {\n           v_textureCoordinates = uv;\n           vCoordinates = vec2(position.x, position.y);\n           gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"\n\n        uniform float fanAngle;\n        uniform float time;\n        uniform vec3 backgroundColor;\n        uniform float backgroundOpacity;\n\n        uniform float radius;\n        uniform vec3 color;\n        uniform float opacity;\n\n        uniform vec3 scanPlaneNormalEC;\n        uniform vec4 scanCenter;\n        uniform mat4 matrixWorld;\n\n        uniform sampler2D tDiffuse;\n        uniform sampler2D depthTexture;\n        varying vec2 v_textureCoordinates;\n        varying vec2 vCoordinates;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n        #include <depth_parse_fragment>\n\n        vec3 pointProjectOnPlane(in vec3 planeNormal, in vec3 planeOrigin, in vec3 point)\n        {\n           vec3 v01 = point-planeOrigin;\n           float d = dot(planeNormal, v01) ;\n           return (point - planeNormal * d);\n        }\n        #include <postprocess_mix_color>\n        #include <postprocess_original_color>\n\n        void main(void){\n        //原始颜色获取\n           vec4 originalColor = get_original_color(tDiffuse, v_textureCoordinates,1.0);\n           vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);\n           float depth = unpackRGBAToDepth(depthColor);\n           vec3 viewPos = getViewOriginPosition(depth);\n\n        //    if(dot(scanPlaneNormalEC, viewPos)>0.0){\n        //        gl_FragColor = originalColor;\n        //        return;\n        //    }\n\n        //   vec3 prjOnPlane = pointProjectOnPlane(scanPlaneNormalEC.xyz, scanCenterEC.xyz, viewPos.xyz);\n           vec4 wPosCenter = scanCenter;\n           vec4 wPos = matrixWorld * vec4( viewPos, 1.0 );\n           vec3 dis = wPos.xyz - wPosCenter.xyz;\n           float disLen = length(dis.xz);\n\n           if(dis.z==0.0 && dis.x==0.0){\n               discard;\n           }\n\n           if(disLen > radius){\n               gl_FragColor = originalColor;\n               return;\n           }\n\n\n           float scanAngle = 0.0;\n           float PI = 3.141592653589793;\n           float fanOpacity = backgroundOpacity;\n\n           float _angle = atan(dis.z, dis.x);\n\n\n           _angle = mix(\n                _angle + PI * 2.0,\n                _angle,\n                step(0.0, dis.z)\n           );\n\n        //    if(dis.z < 0.0){\n        //        _angle = _angle + PI*2.0;\n        //    }\n           _angle = _angle/(PI*2.0);\n\n\n\n           if( (_angle>=time && _angle <= (fanAngle+time)) ||\n               ((fanAngle+time)>1.0 && _angle<=fract(fanAngle+time))){\n               if(_angle-time<0.0) {\n                   scanAngle = _angle+(1.0-time);\n               }else{\n                   scanAngle = _angle-time;\n               }\n\n               scanAngle = pow(scanAngle/fanAngle,2.0);\n               fanOpacity = fanOpacity + (1.0 - fanOpacity) * scanAngle * opacity;\n           }\n\n\n           gl_FragColor = mix(\n                vec4(mix_color(originalColor,mix(backgroundColor, color, scanAngle), fanOpacity)),\n                originalColor,\n                step(depth, 0.0)\n           );\n\n        //    if(depth == 0.0){ // depth <=0.0  !(depth > 0.0)\n        //        gl_FragColor = originalColor;\n        //    }else{\n        // //        gl_FragColor = vec4(mix(backgroundColor, color, scanAngle), fanOpacity);\n\t\t// \t\tgl_FragColor = vec4(mix_color(originalColor,mix(backgroundColor, color, scanAngle), fanOpacity));\n        //    }\n\n        //         vec4 a =cameraProjection * vec4(viewPos,1.0);\n        //         a= a /a.w ;\n        //         gl_FragColor =  a*0.5+0.5;\n        //         gl_FragColor.ba = vec2(0.0, 1.0) ;\n        //         gl_FragColor = vec4(vec3(viewPos.z/(cameraNear-cameraFar)),1.0);\n        //         if(length(viewPos) < 100.0){\n        //             gl_FragColor = originalColor;\n        //             return;\n        //         }\n        //         vec4 bb =viewMatrix1*vec4(0.0,0.0,0.0,1.0);\n        //             float dis1 = length(viewPos.xyz - bb.xyz);\n        //             if(dis1 <500.0){\n        //                 gl_FragColor= vec4(1.0,0.0,0.0,1.0);\n        //             }else{\n        //                 gl_FragColor = originalColor;\n        //         }\n        //         vec4 posWC = inverseView * vec4(viewPos,1.0);\n        //         if(depth == 1.0){\n        //             gl_FragColor = originalColor;\n        //         }else{\n        //             if(posWC.x > 10.0){\n        //                 gl_FragColor = vec4(1.0,0.0,0.0,1.0);\n        //             }else{\n        //                 gl_FragColor = originalColor;\n        //             }\n        //         }\n        }"},r.SnowPass=function(e,t,i,n){var a=this;THREE.Pass.call(a),a.viewer=t,a.shader=r.SnowShader,a.density=2,a.thickness=.8,a.darkness=.5,a.renderComposer=e,a.uniforms=THREE.UniformsUtils.clone(a.shader.uniforms),a.material=new THREE.ShaderMaterial({defines:a.shader.defines||{},uniforms:a.uniforms,vertexShader:a.shader.vertexShader,fragmentShader:a.shader.fragmentShader}),a._frameState=new r.FrameState,a._frameState.camera=a.viewer.camera,a._frameState.scene=a.viewer.getScene(),a.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),a.postScene=new THREE.Scene,a.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),a.material),a.quad.frustumCulled=!1,a.postScene.add(a.quad),a.enabled=!1},r.SnowPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.SnowPass,setOpts:function(e){var t=this;e&&(void 0!==e.darkness&&null!==e.darkness&&(t.darkness=e.darkness),void 0!==e.thickness&&null!==e.thickness&&(t.thickness=e.thickness),void 0!==e.density&&null!==e.density&&(t.density=e.density))},getOpts:function(){var e=this;return{darkness:e.darkness,thickness:e.thickness,density:e.density}},render:function(e,t,i,n,a,s){var o=this;null!=o._frameState.camera&&(o.uniforms.inverseViewRotation.value=r.Math.getMatrix3(o._frameState.camera.matrixWorld),o.uniforms.cameraNear.value=o._frameState.camera.near,o.uniforms.cameraFar.value=o._frameState.camera.far),o._frameState.frameNumber=r.Math.incrementWrap(o._frameState.frameNumber,15e6,1),o.uniforms.frameNumber.value=o._frameState.frameNumber,o.uniforms.density.value=o.density,o.uniforms.thickness.value=o.thickness,o.uniforms.darkness.value=o.darkness,o.uniforms.viewport&&null!=i&&(o.uniforms.viewport.value=new THREE.Vector4(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w)),o.uniforms.firstFlg&&(o.uniforms.firstFlg.value=s?0:1),o.uniforms.tDiffuse&&(o.uniforms.tDiffuse.value=i.texture),o.uniforms.tNormal&&(o.uniforms.tNormal.value=o.renderComposer.getNormalTexture()),o.quad.material=o.material;var l=e.getRenderTarget();e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.postScene,o.postCamera),e.setRenderTarget(l)},dispose:function(){this._frameState=this._frameState.destroy()},setSize(e,t){}}),r.RainPass=class{constructor(e,t,i,n){var a=this;THREE.Pass.call(a),a.viewer=t,a.shader=r.RainShader,a.density=2,a.darkness=.5,a.renderComposer=e,a.uniforms=THREE.UniformsUtils.clone(a.shader.uniforms),a.camera=a.viewer.camera,a.scene=a.viewer.getScene(),a.modelManager=a.viewer.modelManager,a.material=new THREE.ShaderMaterial({defines:a.shader.defines||{},uniforms:a.uniforms,vertexShader:a.shader.vertexShader,fragmentShader:a.replaceDepthToViewZ(a.shader.fragmentShader,a.camera)}),a._frameState=new r.FrameState,a._frameState.camera=a.viewer.camera,a._frameState.scene=a.viewer.getScene(),a._frameState.frameNumber=Math.floor(1e3*Math.random()),a.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),a.postScene=new THREE.Scene,a.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),a.material),a.quad.frustumCulled=!1,a.postScene.add(a.quad)}replaceDepthToViewZ(e,t){var i=t.isPerspective?"perspective":"orthographic";return e.replace(/DEPTH_TO_VIEW_Z/g,i+"DepthToViewZ")}setOpts(e){e&&(void 0!==e.darkness&&null!==e.darkness&&(this.darkness=e.darkness),void 0!==e.density&&null!==e.density&&(this.density=e.density))}getOpts(){return{darkness:this.darkness,density:this.density}}render(e,t,i,n,a,s){var o=this;o._frameState.frameNumber=r.Math.incrementWrap(o._frameState.frameNumber,15e6,1),o.uniforms.frameNumber.value=o._frameState.frameNumber,o.uniforms.density.value=o.density,o.uniforms.darkness.value=o.darkness,o.uniforms.viewport&&null!=i&&(o.uniforms.viewport.value=new THREE.Vector4(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w)),o.uniforms.firstFlg&&(o.uniforms.firstFlg.value=s?0:1),o.uniforms.tDiffuse&&(o.uniforms.tDiffuse.value=i.texture),o.quad.material=o.material;var l=e.getRenderTarget();e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.postScene,o.postCamera),e.setRenderTarget(l)}dispose(){}setSize(e,t){}},function(){class e extends THREE.Pass{constructor(e,t,i,n,a){super(),this.modelManager=t,this.renderScene=i,this.renderCamera=n,this.selectedObjectIds=void 0!==a?a:[],this.defaultEdgeColor=(new THREE.Color).setHex(7733223),this.defaultEdgeAlpha=.95,this.edgeColor=new THREE.Vector4(this.defaultEdgeColor.r,this.defaultEdgeColor.g,this.defaultEdgeColor.b,this.defaultEdgeAlpha),this.edgeLength=2,this.resolution=void 0!==e?new THREE.Vector2(e.x,e.y):new THREE.Vector2(256,256);var s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};this.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetEdgeBuffer.texture.name="OutlinePass.edge",this.renderTargetEdgeBuffer.texture.generateMipmaps=!1,this.renderTargetColorBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetColorBuffer.texture.name="OutlinePass.color",this.renderTargetColorBuffer.texture.generateMipmaps=!1,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.InstancedDepthMaterial=new r.InstancedDepthMaterial,this.InstancedDepthMaterial.side=THREE.DoubleSide,this.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.InstancedDepthMaterial.blending=THREE.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=THREE.DoubleSide,this.prepareMaskInstancedMaterial=this.getPrepareMaskInstancedMaterial(),this.prepareMaskInstancedMaterial.side=THREE.DoubleSide,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.overlayMaterial=this.getOverlayMaterial(),void 0===THREE.CopyShader&&console.error("CLOUD.OutlinePass relies on THREE.CopyShader");var o=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(o.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.textureMatrix=new THREE.Matrix4}dispose(){this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetEdgeBuffer.dispose(),this.renderTargetColorBuffer.dispose()}setSize(e,t){this.renderTargetDepthBuffer.setSize(e,t),this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer.setSize(e,t),this.renderTargetEdgeBuffer.setSize(e,t),this.renderTargetColorBuffer.setSize(e,t)}adjustVisibility(e){this.modelManager.adjustVisibility(e)}changeVisibilityOfSelectedObjects(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}changeVisibilityOfNonSelectedObjects(e){this.modelManager.changeVisibilityOfNonSelectedObjects(e)}adjustInstanceVisibility(e){this.modelManager.adjustInstanceVisibility(e)}changeInstanceVisibilityOfSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfNonSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfNonSelectedObjects(e)}restoreVisibilityOfObjects(){this.modelManager.restoreVisibilityOfObjects()}updateTextureMatrix(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}render(e,t,i,r,n){if(0!==this.selectedObjectIds.length){e.getClearColor(this.oldClearColor),this.oldClearAlpha=e.getClearAlpha();var a=e.autoClear;e.autoClear=!1,n&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(0,0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.InstancedDepthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!1),this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.adjustInstanceVisibility(!1),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfNonSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskInstancedMaterial,this.prepareMaskInstancedMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskInstancedMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskInstancedMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!1),this.renderScene.overrideMaterial=null,this.adjustVisibility(!0),this.changeInstanceVisibilityOfNonSelectedObjects(!0),this.restoreVisibilityOfObjects(),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.edgeColor,this.edgeDetectionMaterial.uniforms.edgeLength.value=this.edgeLength,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.colorTexture.value=i.texture,this.overlayMaterial.uniforms.outlineTexture.value=this.renderTargetEdgeBuffer.texture,e.render(this.scene,this.camera,this.renderTargetColorBuffer,!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetColorBuffer.texture,n&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,i,!0),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=a}}getPrepareMaskMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                #include <packing>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tuniform sampler2D depthTexture;\n\t\t\t\tuniform vec2 cameraNearFar;\n\t\t\t\t\n\t\t\t\tfloat linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = vec4(depth);\n\t\t\t\t}"})}getPrepareMaskInstancedMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                attribute vec4 vState;            \n                attribute vec4 aColor;            \n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec4 muvCol0;\n                    attribute vec2 muvCol1;\n                    // attribute vec2 muvCol2;\n                #endif\n                \n                varying float vfState;\n                varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\t\n\t\t\t\tvec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                     vec4(mcol1, 0.0),\n                                     vec4(mcol2, 0.0),\n                                     vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n                \n                vec2 getInstanceUV(vec2 uv) {\n                \n                    #if defined(USE_MAP)\n                        return vec2(mat3(vec3(muvCol0.xy, 0.0),\n                                         vec3(muvCol0.zw, 0.0), \n                                         vec3(muvCol1, 1.0)) * vec3(uv, 1.0));\n                    #else\n                        return uv;\n                    #endif                    \n                    \n                }\n            \n\t\t\t\tvoid main() {\n\t\t\t\t    vfState = vState.r;\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vPosition;\n\t\t\t\t}",fragmentShader:"#include <packing>\n                varying float vfState;\n                varying vec2 vUv;\n                varying vec4 vPosition;\n                varying vec4 projTexCoord;\n                uniform sampler2D depthTexture;\n                uniform vec2 cameraNearFar;\n                \n                float linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n                \n                void main() {\n                    if (vfState <= -0.99 && vfState >= -1.01) discard;\n                    float depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\n                    gl_FragColor = vec4(depth);\n                }"})}getEdgeDetectionMaterial(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector4(1,1,1,1)},edgeLength:{value:2}},vertexShader:"\n                varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                varying vec2 vUv;\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec4 edgeColor;\n                uniform float edgeLength; \n                \n                void main(void)\n                {\n                    float directions[3];\n                    directions[0] = -1.0;\n                    directions[1] = 0.0;\n                    directions[2] = 1.0;\n                \n                    float scalars[3];\n                    scalars[0] = 3.0;\n                    scalars[1] = 10.0;\n                    scalars[2] = 3.0;\n                \n                    float padx = 1.0 / texSize.x;\n                    float pady = 1.0 / texSize.y ; \n                \n                    float edgeSize  = 0.0; \n                    float horizEdge = 0.0;\n                    float vertEdge = 0.0;                    \n                \n                    for (int i = 0; i < 3; ++i)\n                    {\n                        float dir = directions[i];\n                        float scale = scalars[i];\n                \n                        horizEdge -= texture2D(maskTexture, vUv + vec2(-padx, dir * pady)).x * scale;\n                        horizEdge += texture2D(maskTexture, vUv + vec2(padx, dir * pady)).x * scale;\n                \n                        vertEdge -= texture2D(maskTexture, vUv + vec2(dir * padx, -pady)).x * scale;\n                        vertEdge += texture2D(maskTexture, vUv + vec2(dir * padx, pady)).x * scale;\n                    }                    \n                  \n                    float len = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);    \n                    float alpha = len > edgeLength ? edgeColor.a : (texture2D(maskTexture, vUv).w > 0.1 ? 0.1 : 0.0);\n                    gl_FragColor = vec4(edgeColor.rgb, alpha);\n                }"})}getOverlayMaterial(){return new THREE.ShaderMaterial({uniforms:{colorTexture:{value:null},outlineTexture:{value:null}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform sampler2D outlineTexture;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 outlineColor = texture2D(outlineTexture, vUv);\t\t\t\t\t\n                    gl_FragColor = mix(texture2D(colorTexture, vUv), outlineColor, outlineColor.a);\n\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}setOutlineEdgeColor(e){var t=r.Utils.hexToRgb(e.color);this.edgeColor.fromArray([t.r,t.g,t.b,e.opacity?e.opacity:1])}}r.OutlinePass=e}(),function(){class e{constructor(e){this.modelManager=e,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.instancedDepthMaterial=new r.InstancedDepthMaterial,this.instancedDepthMaterial.side=THREE.DoubleSide,this.instancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.instancedDepthMaterial.blending=THREE.NoBlending,this.customDepthMaterial=new r.CustomMeshDepthMaterial,this.customDepthMaterial.side=THREE.DoubleSide,this.customDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.customDepthMaterial.blending=THREE.NoBlending,this.customInstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,this.customInstancedDepthMaterial.side=THREE.DoubleSide,this.customInstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.customInstancedDepthMaterial.blending=THREE.NoBlending}destroy(){this.modelManager=null,this.depthMaterial.dispose(),this.depthMaterial=null,this.instancedDepthMaterial.dispose(),this.instancedDepthMaterial=null,this.customDepthMaterial.dispose(),this.customDepthMaterial=null,this.customInstancedDepthMaterial.dispose(),this.customInstancedDepthMaterial=null}adjustVisibility(e){this.modelManager.adjustVisibility(e)}adjustInstanceVisibility(e){this.modelManager.adjustInstanceVisibility(e)}adjustVisibilityByModelIdMap(e,t){return this.modelManager.adjustVisibilityByModelIdMap(e,t)}restoreVisibilityByModelIdMap(e){this.modelManager.restoreVisibilityByModelIdMap(e)}adjustDemVisibility(e,t){this.modelManager.adjustDemVisibility(e,t)}adjustDemOthersVisibility(e){return this.modelManager.adjustDemOthersVisibility(e)}changeVisibilityOfSelectedObjects(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}renderDepth(e,t,i,r){var n=e.getRenderTarget(),a=t.overrideMaterial,s=e.autoClear;e.autoClear=!1,this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),t.overrideMaterial=this.depthMaterial,e.setRenderTarget(r),e.clear(),e.render(t,i),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),t.overrideMaterial=this.instancedDepthMaterial,e.render(t,i),t.overrideMaterial=a,e.setRenderTarget(n),e.autoClear=s,this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0)}_showExternalObjectGroups(e){let t={};return e.forEach((e=>{t[e.name]=e.visible,e._oriVisible&&(e.visible=!0)})),t}_hideExternalObjectGroups(e){let t={};return e.forEach((e=>{t[e.name]=e.visible,e._oriVisible||(e._oriVisible=e.visible),e.visible=!1})),t}_restoreVisibilityForExternalObjectGroups(e,t){e.forEach((e=>{e.visible=t[e.name]}))}renderCustomDepth(t,i,n,a,s){const o=!!r.Utils.isDefined(s)&&s,l=2/(Math.log(n.far+1)/Math.LN2),d=t.getRenderTarget(),h=i.overrideMaterial,c=t.autoClear;t.autoClear=!1;const u=e.hideInVisibleGroup(i);this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustInstanceVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),this.customDepthMaterial.uniforms.forceLogDepth.value=o,this.customDepthMaterial.uniforms.forceCustomDepth.value=!1,this.customDepthMaterial.uniforms.forceLogDepthBufFC.value=l,i.overrideMaterial=this.customDepthMaterial,t.setRenderTarget(a),t.clear(),t.render(i,n);const p=i.getExternalCompObjectGroups(),m=this._hideExternalObjectGroups(p);this.adjustVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.adjustInstanceVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.customInstancedDepthMaterial.uniforms.forceLogDepth.value=o,this.customInstancedDepthMaterial.uniforms.forceCustomDepth.value=!1,this.customInstancedDepthMaterial.uniforms.forceLogDepthBufFC.value=l,i.overrideMaterial=this.customInstancedDepthMaterial,t.render(i,n),i.overrideMaterial=h,t.setRenderTarget(d),t.autoClear=c,this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this._restoreVisibilityForExternalObjectGroups(p,m),e.restoreInVisibleGroup(i,u)}renderCustomDepthByOpacity(e,t,i,n,a,s){let o={},l={};r.RenderEffectComposer.setTransparentObjectVisible(t,i,a,!1,o,l),this.customInstancedDepthMaterial.uniforms.discardAlpha.value=a,this.renderCustomDepth(e,t,i,n,s),r.RenderEffectComposer.setTransparentObjectVisible(t,i,a,!0,o,l),this.customInstancedDepthMaterial.uniforms.discardAlpha.value=0}renderCustomDepthWithoutDEM(t,i,n,a){const s=.2,o=.5,l=1,d=t.getRenderTarget(),h=i.overrideMaterial,c=t.autoClear,u=i.getObjectGroup(r.GlobalData.TilePlaneGroupName),p=!!u&&u.visible,m=i.getExternalCompObjectGroups();let f=this._hideExternalObjectGroups(m);this._restoreVisibilityForExternalObjectGroups(m,f);const g=this.adjustDemOthersVisibility(!1);let v=this.customDepthMaterial;v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=s,i.overrideMaterial=v,t.autoClear=!1,t.setRenderTarget(a),t.clear(),t.render(i,n),this.adjustDemVisibility(!1,!0);const y=e.hideInVisibleGroup(i);f=this._showExternalObjectGroups(m),this.adjustVisibility(!1),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),v=this.customDepthMaterial,v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=l,i.overrideMaterial=v,t.render(i,n),this._restoreVisibilityForExternalObjectGroups(m,f),this.restoreVisibilityByModelIdMap(g),f=this._hideExternalObjectGroups(m),this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustInstanceVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),v=this.customDepthMaterial,v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=o,i.overrideMaterial=v,t.render(i,n),this.adjustVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.adjustInstanceVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),v=this.customInstancedDepthMaterial,v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=o,i.overrideMaterial=v,t.render(i,n),i.overrideMaterial=h,t.setRenderTarget(d),t.autoClear=c,this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this._restoreVisibilityForExternalObjectGroups(m,f),this.adjustDemVisibility(p,!0),e.restoreInVisibleGroup(i,y)}renderCustomDepthByVisibleModels(t,i,n,a,s,o){if(!r.Utils.defined(s))return;const l=o?.5:.8,d=t.getRenderTarget(),h=i.overrideMaterial,c=t.autoClear,u=i.getObjectGroup(r.GlobalData.TilePlaneGroupName),p=!!u&&u.visible,m=e.hideInVisibleGroup(i),f=this.adjustDemOthersVisibility(!1);this.adjustDemVisibility(!1,!0);let g=this.adjustVisibilityByModelIdMap(!0,s);this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1);let v=this.customDepthMaterial;v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=l,i.overrideMaterial=v,t.autoClear=!1,t.setRenderTarget(a),t.render(i,n),this.adjustVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),v=this.customInstancedDepthMaterial,v.uniforms.forceLogDepth.value=!1,v.uniforms.forceCustomDepth.value=!0,v.uniforms.customDepth.value=l,i.overrideMaterial=v,t.render(i,n),i.overrideMaterial=h,t.setRenderTarget(d),t.autoClear=c,this.adjustVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.restoreVisibilityByModelIdMap(g),this.restoreVisibilityByModelIdMap(f),this.adjustDemVisibility(p,!0),e.restoreInVisibleGroup(i,m)}}e.inVisibleGroupList=[r.ObjectGroupType.IBLCUBE],e.hideInVisibleGroup=t=>{const i=e.inVisibleGroupList.length;let r=new Array(i);for(let n=0;n<i;++n){const i=t.getObjectGroup(e.inVisibleGroupList[n]);i&&(r[n]=i.visible,i.visible=!1)}return r},e.restoreInVisibleGroup=(t,i)=>{const r=e.inVisibleGroupList.length;for(let n=0;n<r;++n){const r=t.getObjectGroup(e.inVisibleGroupList[n]);r&&(r.visible=i[n])}},e.adjustClippingPlaneVisibility=(e,t)=>{const i=e.getObjectByName(r.ObjectGroupType.FILLCLIPPLANE),n=e.getObjectByName(r.ObjectGroupType.CLIPPLANE),a=e.getObjectByName(r.ObjectGroupType.CLIPREGION);i&&i.isEnabled()&&(i.visible=t),n&&n.isEnabled()&&(n.visible=t),a&&(a.visible=t)},r.DepthRenderPass=e}(),function(){let e=new THREE.Matrix4,t=new THREE.Matrix4;r.ScanRingPass=class{constructor(e,t,i,n,a){var s=this;THREE.Pass.call(s),s._running=!0,s._paused=!1,s._tickTimeLast=void 0,s._first=!0,s.viewer=i,s.shader=r.ScanRingShader,s.id=e,s.radius=500,s.emitPosition=new THREE.Vector3(0,1,0),s.originPosition=new THREE.Vector3(0,0,0),s.progressive=10,s.duration=3e3,s.color=new THREE.Vector3(1,1,1),s.range=[],s.renderComposer=t,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.camera=s.viewer.camera,s.scene=s.viewer.getScene(),s.modelManager=s.viewer.modelManager,s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad)}setOpts(e){var t=this;e&&(null!=e.originPosition&&(t.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.emitPosition&&(t.emitPosition=new THREE.Vector3(e.emitPosition.x,e.emitPosition.y,e.emitPosition.z)),null!=e.progressive&&(t.progressive=e.progressive),null!=e.radius&&(t.radius=e.radius),null!=e.duration&&(t.duration=e.duration),null!=e.color&&null!=e.alpha&&(t.color=new THREE.Vector4(e.color.r,e.color.g,e.color.b,e.alpha)),null!=e.range&&(t.range=e.range))}getOpts(){var e=this;return{emitPosition:e.emitPosition,originPosition:e.originPosition,radius:e.radius,duration:e.duration,color:e.color,progressive:e.progressive}}render(e,t,i,r,n,a){const s=this;if(s._updateCameraUniforms(e),null==s.startTime&&(s.startTime=(new Date).getTime(),s._tickTimeLast=s.startTime),!s._running)return s._updateTimeUniform(),s._updatePartUniforms(a),void s._renderToTarget(e,t,i);if(s._paused)return s._updateTimeUniform(s._tickTimeLast),s._updatePartUniforms(a),void s._renderToTarget(e,t,i);const o=s._tickTimeLast;s._tickTimeLast=(new Date).getTime(),s._updateTimeUniform(o),s._updatePartUniforms(a),s._renderToTarget(e,t,i)}_updateCameraUniforms(i){const r=this;if(r.camera){r.uniforms.cameraProjection.value=r.camera.projectionMatrix,e.copy(r.camera.projectionMatrix).invert(),r.uniforms.inverseProjection.value=e,t.copy(r.camera.matrixWorld).invert(),r.uniforms.matrixWorld.value=r.camera.matrixWorld;var n=new THREE.Vector4(r.emitPosition.x,r.emitPosition.y,r.emitPosition.z,1);n.applyMatrix4(t);var a=new THREE.Vector4(r.originPosition.x,r.originPosition.y,r.originPosition.z,1);a.applyMatrix4(t);var s=new THREE.Vector3;s.set(n.x,n.y,n.z),s.sub(a),r.uniforms.scanPlaneNormalEC.value=s.normalize(),r.uniforms.scanCenterEC.value=a,r.uniforms.cameraNear.value=r.camera.near,r.uniforms.cameraFar.value=r.camera.far,r.uniforms.progressive.value=r.progressive,r.uniforms.viewport.value.set(0,0,i.getContext().drawingBufferWidth,i.getContext().drawingBufferHeight),r.uniforms.logDepthBufFC.value=2/(Math.log(r.camera.far+1)/Math.LN2)}}_updateTimeUniform(e){const t=this;t.uniforms.time&&(0==t.duration?t.uniforms.time.value=1:t.uniforms.time.value=void 0===e?1:(e-t.startTime)%t.duration/t.duration)}_updatePartUniforms(e){const t=this;2==t.range.length?(t.uniforms.minHeight.value=t.range[0],t.uniforms.maxHeight.value=t.range[1]):(t.uniforms.minHeight.value=0,t.uniforms.maxHeight.value=0),t.uniforms.radius&&(t.uniforms.radius.value=t.radius),t.uniforms.color&&(t.uniforms.color.value=t.color),t.uniforms.firstFlg&&(t.uniforms.firstFlg.value=e?0:1),t.quad.material=t.material}_renderToTarget(e,t,i){const r=this;r.uniforms.tDiffuse&&(r.uniforms.tDiffuse.value=i.texture),r.uniforms.depthTexture&&(r.uniforms.depthTexture.value=r.renderComposer.getDepthTexture());const n=e.getRenderTarget();e.setRenderTarget(t),r.clear&&e.clear(),e.render(r.postScene,r.postCamera),e.setRenderTarget(n)}dispose(){var e=this;e.emitPosition=null,e.originPosition=null,e.uniforms=null}setSize(e,t){}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Matrix4;r.FanScanPass=class{constructor(e,t,i,n,a){const s=this;THREE.Pass.call(s),s._running=!0,s._paused=!1,s._tickTimeLast=void 0,s.viewer=i,s.shader=r.FanScanPassShader,s.id=e,s.radius=500,s.fanAngle=Math.PI/3,s.originPosition=new THREE.Vector3(0,0,0),s.backgroundColor=new THREE.Vector3(1,1,1),s.backgroundAlpha=1,s.duration=3e3,s.color=new THREE.Vector3(1,1,1),s.alpha=1,s.renderComposer=t,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.camera=s.viewer.camera,s.scene=s.viewer.getScene(),s.modelManager=s.viewer.modelManager,s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad)}setOpts(e){const t=this;e&&(null!=e.originPosition&&(t.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.backgroundColor&&(t.backgroundColor=new THREE.Vector3(e.backgroundColor.r,e.backgroundColor.g,e.backgroundColor.b)),null!=e.alpha&&(t.alpha=e.alpha),null!=e.backgroundAlpha&&(t.backgroundAlpha=e.backgroundAlpha),null!=e.radius&&(t.radius=e.radius),null!=e.duration&&(t.duration=e.duration),null!=e.fanAngle&&(t.fanAngle=e.fanAngle),null!=e.color&&(t.color=new THREE.Vector3(e.color.r,e.color.g,e.color.b)))}getOpts(){const e=this;return{radius:e.radius,fanAngle:e.fanAngle,originPosition:e.originPosition,backgroundColor:e.backgroundColor,backgroundAlpha:e.backgroundAlpha,duration:e.duration,color:e.color,alpha:e.alpha}}render(e,t,i,r,n,a){const s=this;if(s._updateCameraUniforms(e),null==s.startTime&&(s.startTime=(new Date).getTime(),s._tickTimeLast=s.startTime),!s._running)return s._updateTimeUniform(s.startTime),s._updatePartUniforms(),void s._renderToTarget(e,t,i);if(s._paused)return s._updateTimeUniform(s._tickTimeLast),s._updatePartUniforms(),void s._renderToTarget(e,t,i);const o=s._tickTimeLast;s._tickTimeLast=(new Date).getTime(),s._updateTimeUniform(o),s._updatePartUniforms(),s._renderToTarget(e,t,i)}_updateCameraUniforms(i){const r=this;if(!r.camera)return;r.uniforms.cameraProjection.value=r.camera.projectionMatrix,e.copy(r.camera.projectionMatrix).invert(),r.uniforms.inverseProjection.value=e,t.copy(r.camera.matrixWorld).invert(),r.uniforms.matrixWorld.value=r.camera.matrixWorld;let n=new THREE.Vector4(r.originPosition.x,r.originPosition.y,r.originPosition.z,1),a=new THREE.Vector4(r.originPosition.x,r.originPosition.y+1,r.originPosition.z,1);a.applyMatrix4(t);let s=new THREE.Vector3;s.set(a.x,a.y,a.z),s.sub(n),r.uniforms.scanPlaneNormalEC.value=s.normalize(),r.uniforms.scanCenter.value=n,r.uniforms.cameraNear.value=r.camera.near,r.uniforms.cameraFar.value=r.camera.far,r.uniforms.viewport.value.set(0,0,i.getContext().drawingBufferWidth,i.getContext().drawingBufferHeight),r.uniforms.logDepthBufFC.value=2/(Math.log(r.camera.far+1)/Math.LN2)}_updateTimeUniform(e){const t=this;t.uniforms.time&&(0==t.duration?t.uniforms.time.value=1:t.uniforms.time.value=void 0===e?1:(e-t.startTime)%t.duration/t.duration)}_updatePartUniforms(){const e=this;e.uniforms.radius&&(e.uniforms.radius.value=e.radius),e.uniforms.color&&(e.uniforms.color.value=e.color),e.uniforms.opacity&&(e.uniforms.opacity.value=e.alpha),e.uniforms.fanAngle&&(e.uniforms.fanAngle.value=e.fanAngle/(2*Math.PI)),e.uniforms.backgroundColor&&(e.uniforms.backgroundColor.value=e.backgroundColor),e.uniforms.backgroundOpacity&&(e.uniforms.backgroundOpacity.value=e.backgroundAlpha),e.quad.material=e.material}_renderToTarget(e,t,i){const r=this;r.uniforms.tDiffuse&&(r.uniforms.tDiffuse.value=i.texture),r.uniforms.depthTexture&&(r.uniforms.depthTexture.value=r.renderComposer.getDepthTexture());const n=e.getRenderTarget();e.setRenderTarget(t),r.clear&&e.clear(),e.render(r.postScene,r.postCamera),e.setRenderTarget(n)}dispose(){var e=this;e.emitPosition=null,e.originPosition=null,e.uniforms=null}setSize(e,t){}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}}(),function(){class e extends THREE.Pass{constructor(e,t,i,n){super();var a=this;a.viewer=t,a.renderComposer=e,a.shader=r.BackgroundShader,a.uniforms=THREE.UniformsUtils.clone(a.shader.uniforms),a.camera=a.viewer.camera,a.scene=a.viewer.getScene(),a.modelManager=a.viewer.modelManager,a.material=new THREE.ShaderMaterial({defines:a.shader.defines||{},uniforms:a.uniforms,vertexShader:a.shader.vertexShader,fragmentShader:a.shader.fragmentShader,depthTest:!1,depthWrite:!1}),a.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),a.postScene=new THREE.Scene,a.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),a.material),a.quad.frustumCulled=!1,a.postScene.add(a.quad)}render(e,t,i,r,n){var a=this;a.uniforms.abTexture&&(a.uniforms.abTexture.value=a.renderComposer.composerAdditive.readBuffer.texture),a.uniforms.mbTexture&&(a.uniforms.mbTexture.value=a.renderComposer.composerMix.readBuffer.texture),a.uniforms.isAdditive&&(a.uniforms.isAdditive.value=a.renderComposer.isAdditiveRoad()?1:0),a.quad.material=a.material;var s=e.getRenderTarget();e.autoClear=!1,e.setRenderTarget(null),e.clear(),e.render(a.postScene,a.postCamera),e.setRenderTarget(s)}destroy(){this.material.dispose()}setSize(e,t){}}r.BackgroundPass=e}(),r.FanScanShader={uniforms:{fanAngle:{value:0},time:{value:0},backgroundColor:{value:new THREE.Vector3(1,1,1)},backgroundOpacity:{value:0}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n\n        varying vec2 vCoordinates;\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #endif\n            vCoordinates = vec2(position.x, position.y);\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform float fanAngle;\n        uniform float time;\n        uniform vec3 backgroundColor;\n        uniform float backgroundOpacity;\n        varying vec2 vCoordinates;\n\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #include <flat_shaded_pars_fragment>\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            float scanAngle = 0.0;\n            float fanOpacity = backgroundOpacity;\n            if(vCoordinates.y==0.0 && vCoordinates.x==0.0){\n                discard;\n            }\n\n            float _angle = atan(vCoordinates.y, vCoordinates.x);\n\n            _angle = mix(\n                _angle + PI * 2.0,\n                _angle,\n                step(0.0, vCoordinates.y)\n            );\n\n            // if(vCoordinates.y < 0.0){\n            //     _angle = _angle + PI*2.0;\n            // }\n            _angle = _angle/(PI*2.0);\n\n            if( (_angle>=time &&_angle <= (fanAngle+time)) ||\n                ((fanAngle+time)>1.0 && _angle<=fract(fanAngle+time))){\n\n                scanAngle = mix(\n                    _angle + (1.0 - time),\n                    _angle - time,\n                    step(time, _angle)\n                );\n                // if(_angle-time<0.0) {\n                //     scanAngle = _angle+(1.0-time);\n                // }else{\n                //     scanAngle = _angle-time;\n                // }\n                //提高融合感\n                scanAngle = pow(1.0 - scanAngle/fanAngle,2.0);\n                fanOpacity = fanOpacity + (1.0 - fanOpacity) * scanAngle * opacity;\n            }\n\n            gl_FragColor = vec4(mix(backgroundColor, diffuse, scanAngle), fanOpacity);\n//          gl_FragColor = vec4(vec3(fanOpacity), fanOpacity);\n//          gl_FragColor = vec4(vec3(scanAngle), scanAngle);\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\t\tuniform float h;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"},r.VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:"varying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\t\tuniform float v;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"},r.PostDepthShader={uniforms:{cameraNear:{value:0},cameraFar:{value:0},tDiffuse:{value:null},tDepth:{value:null},isDepthMode:{value:!1}},vertexShader:"\n    varying vec2 vUv;\n\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n    ",fragmentShader:"\n    #include <packing>\n\n    varying vec2 vUv;\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tDepth;\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform bool isDepthMode;\n\n\n    float readDepth( sampler2D depthSampler, vec2 coord ) {\n        float fragCoordZ = texture2D( depthSampler, coord ).x;\n        float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n        return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n    }\n\n    void main() {\n        if(isDepthMode){\n            float depth = readDepth( tDepth, vUv );\n\n            gl_FragColor.rgb = vec3( depth );//1.0 - \n            gl_FragColor.a = 1.0;\n        }else{\n            gl_FragColor = texture2D( tDiffuse, vUv );\n\n        }\n        \n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n    }\n    "},r.ColorWithoutLightFrag={color_without_light_frag:"\n    bool useColorWithoutLight = false;\n    #ifdef USE_COLORWITHOUTLIGHT  \n       useColorWithoutLight = true;\n    #endif\n    if (useColorWithoutLight || (ambientLightColor == vec3(0.0)))\n    {\n        vec4 originColor = sRGBToLinear(withoutLightColor);\n        #ifdef USE_MAP\n            originColor = diffuseColor;\n        #endif\n        gl_FragColor = originColor;     \n    }    \n        \n    "},r.CloudStateShader={cloud_state_defines:"\n\n    #define ElementState_HIDDEN -1.\n    #define ElementState_NONE 0.\n    #define ElementState_SELECTED 1.\n    #define ElementState_BLINK 2.\n    #define ElementState_HOVER 4.\n    #define ElementState_TRANSPARENT 8.\n    #define ElementState_LOCALCLIPPING 16.\n    #define ElementState_CLIPPING 32.\n    #define ElementState_OVERRIDED 64.\n    #define ElementState_DEACTIVATE 128.\n    #define ElementState_MODIFYOPACITY 256.\n\n    #define WireframeState_HIDDEN -1.\n    #define WireframeState_NONE 0.\n    #define WireframeState_OVERRIDED 1.\n\n    #define ShaderColorState_NONE 0.\n    #define ShaderColorState_BLINK 1.\n    #define ShaderColorState_SELECT 2.\n    \n",cloud_state_pars_vertex:"\n        #ifndef USE_INSTANCE\n            attribute vec4 vState;\n        #endif\n        attribute vec4 pointColorState;\n        varying vec4 vIdState;\n        varying float componentState;\n        varying float wireFrameState;\n        varying vec4 vColorState;\n",cloud_state_pars_fragment:"\n    varying vec4 vIdState;\n    varying float componentState;\n    varying float wireFrameState;\n    varying vec4 vColorState;\n\n    uniform bool usePreShadow;\n\n    #include <cloud_global_opacity_pars_fragment>\n",cloud_state_vertex:"\n    vIdState = vState;\n    componentState = vState.x;\n    wireFrameState = vState.y;\n    vColorState = pointColorState;\n",cloud_state_instance_color_v3_fragment:"\n    // 顶点颜色 = 属性颜色 > 材质颜色 \n    if (floatEqual(componentState, ElementState_HIDDEN)) \n        discard;\n\n    #ifndef USE_COLOR\n        diffuseColor = mix(\n            diffuseColor,\n            vec4(vaColor.xyz, opacity),\n            clamp(\n                4.0 - (\n                    step(0.01, abs(componentState - ElementState_NONE))     +\n                    step(0.01, abs(componentState - ElementState_SELECTED)) +\n                    step(0.01, abs(componentState - ElementState_DEACTIVATE)) +\n                    step(0.01, abs(componentState - ElementState_BLINK))), \n                0.0, 1.0)\n        );\n    // 对应上面的赋值语句\n    //    if (floatEqual(componentState, ElementState_NONE) || \n    //        floatEqual(componentState, ElementState_SELECTED)|| \n    //        floatEqual(componentState, ElementState_BLINK)\n    //     ) \n    //        diffuseColor = vec4(vaColor.xyz,opacity);\n    #endif\n\n    #include <cloud_global_opacity_fragment>\n",cloud_state_instance_color_fragment:"\n    #ifdef USE_INSTANCE\n        if (floatEqual(componentState, ElementState_HIDDEN)) \n            discard;\n\n        diffuseColor = mix(diffuseColor, vaColor, step(0.01, abs(componentState - ElementState_NONE)));\n        // if (!floatEqual(componentState, ElementState_NONE)) \n        //    diffuseColor = vaColor;\n    #endif\n",cloud_state_fragment:"\n\n    bool useTransparentColorWithoutLight = false;\n    //if (floatEqual(componentState,ElementState_TRANSPARENT))  useTransparentColorWithoutLight = true;\n    //useTransparentColorWithoutLight = bool(mix(1.0, 0.0, step(0.01, abs(componentState - ElementState_TRANSPARENT))));\n    \n    if (floatEqual(componentState, ElementState_HIDDEN))\n    {\n        discard;\n    }\n    else if (floatEqual(componentState, ElementState_HOVER))\n    {\n        diffuseColor.a = vColorState.a;\n    }\n    else if (floatEqual(componentState,ElementState_TRANSPARENT)) //TRANSPARENT\n    {\n        diffuseColor = vColorState;\n    }\n    else if (floatEqual(componentState,ElementState_OVERRIDED))\n    {   \n        diffuseColor = vColorState;\n        diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n        withoutLightColor.rgb = diffuseColor.rgb;\n        #ifdef USE_PACKINGMAT\n            metalness = 0.0;\n            roughness = 1.0;\n        #endif\n        //if(floatEqual(vColorState.a,0.0)) discard;\n    }\n",cloud_state_instance_fragment:"\n    bool useTransparentColorWithoutLight = false;\n    // float componentState = vIdState.r;\n    // float wireFrameState = vIdState.g;\n    if (floatEqual(componentState, ElementState_HIDDEN))\n    {\n        discard;\n    }\n    else if (floatEqual(componentState, ElementState_HOVER))\n    {\n        diffuseColor.a = vColorState.a;\n    }\n    else if (floatEqual(componentState,ElementState_TRANSPARENT)) //TRANSPARENT\n    {\n        useTransparentColorWithoutLight = true;\n        diffuseColor = vColorState;\n    }\n    else if (floatEqual(componentState,ElementState_OVERRIDED))\n    {\n        diffuseColor = vColorState;\n        withoutLightColor.rgb = diffuseColor.rgb;\n        diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n        //if(floatEqual(vColorState.a,0.0)) discard;\n    }\n    else if (floatEqual(componentState,ElementState_DEACTIVATE) && !floatEqual(vColorState.a,0.0))\n    {\n        diffuseColor = vColorState;\n        diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n    }\n",cloud_transparent_state_fragment:"\n    // gl_FragColor = mix(gl_FragColor, vColorState, clamp(float(useTransparentColorWithoutLight), 0.0, 1.0));\n    if(useTransparentColorWithoutLight)\n    {\n        gl_FragColor = vColorState;   \n    }\n",cloud_wire_frame_state_fragment:"\n    vec3 finWireFrameColor =  outLineColor;\n    finWireFrameColor = mix(vColorState.rgb, finWireFrameColor, step(0.01, abs(wireFrameState - WireframeState_OVERRIDED)));\n    // if (floatEqual(wireFrameState,WireframeState_OVERRIDED))\n    // {\n    //     finWireFrameColor = vColorState.rgb;\n    // }\n",cloud_global_opacity_pars_fragment:"\n    uniform bool useGlobalOpacity;\n    uniform float globalOpacity;\n",cloud_global_opacity_fragment:"\n        // bool型转float  true=>1.0 false=>0.0\n    diffuseColor.a = mix(diffuseColor.a, globalOpacity, clamp(float(useGlobalOpacity), 0.0, 1.0));\n    // if( useGlobalOpacity == true) {\n    //     diffuseColor.a = globalOpacity;\n    // }\n"};r.ShaderChunk||(r.ShaderChunk={});let O=function(e,t,i,r="",n=null){let a="",s="";return n&&(a=`if (${n}) {`,s="}"),`\n    #if NUM_CLIPPING_PLANES > 0\n        ${r}\n        ${a}\n        vec4 plane;\n        #pragma unroll_loop_start\n        for (int i = 0; i < UNION_CLIPPING_PLANES; i++)\n        {\n            plane = clippingPlanes[ i ];\n            if (dot(${e=e||"vViewPosition"}, plane.xyz) > ${t=t||"plane.w"}) discard;\n        }\n        #pragma unroll_loop_end\n        #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\n            bool clipped = true;\n            #pragma unroll_loop_start\n            for (int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i++)\n            {\n                plane = clippingPlanes[ i ];\n                clipped = (dot( ${e}, plane.xyz) > ${i=i||"plane.w"}) && clipped;\n            }\n            #pragma unroll_loop_end\n            if (clipped) discard;\n        #endif\n        ${s}\n    #endif\n    `};r.ShaderChunk.ClippingPlanesShader={num_clipping_planes_fragment:O(),num_clipping_planes_for_clip_fragment:O("vClipPosition","plane.w + clippingTolerance","plane.w"),num_clipping_planes_for_particle_fragment:O("vClipPosition","(plane.w - clipSize * 0.5)","(plane.w - clipSize * 0.5)"),num_clipping_planes_for_bimtilepick_fragment:O("vViewPosition","plane.w","plane.w","vec3 cameraPosInViewSpace = vec3(0.0);","floatEqual(componentState, ElementState_LOCALCLIPPING)"),num_clipping_planes_for_bimtilepick_instance_fragment:O("vViewPosition","plane.w","plane.w","vec3 cameraPosInViewSpace = vec3(0.0);","floatEqual(fClipping, ElementState_LOCALCLIPPING)"),num_clipping_planes_for_batched_fragment:O("vViewPosition","plane.w &&(!useForCap ||(useForCap&&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))","plane.w","vec3 cameraPosInViewSpace = vec3(0.0);",null),num_clipping_planes_for_instance_fragment:O("vViewPosition","plane.w &&(!useForCap ||(useForCap &&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))","plane.w","vec3 cameraPosInViewSpace = vec3(0.0);","(localClipping == 1 && floatEqual(fClipping, ElementState_LOCALCLIPPING)) || localClipping < 0"),num_clipping_planes_for_stencil_fragment:O("vClipPosition","plane.w","plane.w"),innerClipping_fragment:"\n        vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n        clipPosition.xyz *= (1.0 / clipPosition.w);\n        if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n            clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n        {\n            discard;\n        }\n    ",num_clipping_planes_pars_vertex:"\n        attribute float vClipping;\n        #if NUM_CLIPPING_PLANES > 0 \n            varying float fClipping;\n        #endif\n    ",num_clipping_planes_vertex:"\n        #if NUM_CLIPPING_PLANES > 0\n            fClipping = vClipping;\n        #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.ComponentStateShader={state_hidden_fragment:"\n        if (floatEqual(componentState, ElementState_HIDDEN)) {\n            discard;\n        }\n\n    ",state_override_rough_n_metal_fragment:"\n        if (floatEqual(componentState, ElementState_OVERRIDED)){\n            roughnessFactor = 1.0;\n            metalnessFactor = 0.0;\n        }\n    ",state_override_emissive_fragment:"\n        //after transparented, its map should not be kept on\n        if (floatEqual(componentState, ElementState_OVERRIDED)) {\n            totalEmissiveRadiance = vec3(0.0);   // default value\n        }\n\n    ",state_override_diffuseColor:"\n        //override color, its map should not be kept on\n        if (floatEqual(componentState, ElementState_OVERRIDED)) {\n            diffuseColor = gamaColor;\n        }\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.CompressUV={compress_uv_pars_vertex:"\n        #ifdef USE_COMPRESS_UV\n            uniform vec2 uvCenter;\n            uniform vec2 uvHalfExtent;\n            vec2 uvDecode(vec2 myuv) {\n                // myuv = (myuv + 32768.0)* 2.0 / 65535.0 - 1.0;\n                myuv = (2.0 * myuv + 1.0) * (1.0 / 65535.0);\n                return myuv * uvHalfExtent + uvCenter;\n            }\n        #endif\n        #ifdef USE_BUMPMAP\n            varying vec2 vBumpMapUv;\n            uniform mat3 bumpUvTransform;\n        #endif\n    ",compress_uv_vertex:"\n        #ifdef USE_COMPRESS_UV\n            vUv = uvDecode(uv);\n            vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;\n            #ifdef USE_BUMPMAP\n                vBumpMapUv = ( bumpUvTransform * vec3( vUv, 1 ) ).xy;\n            #endif\n        #else\n            vUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n            #ifdef USE_BUMPMAP\n                vBumpMapUv = ( bumpUvTransform * vec3( uv, 1 ) ).xy;\n            #endif\n        #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.ComputeCapability={inverse_mat3:"\n        mat3 inverseMat3(in mat3 m)\n        {\n        float determinant =\n            m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])\n            - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])\n            + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n            mat3 inverse;\n            inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);\n            inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);\n            inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);\n            inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);\n            inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);\n            inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);\n            inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n            inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);\n            inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);\n            inverse /= determinant;\n            return inverse;\n        }\n    ",get_instance_position_function:"\n        vec3 getInstancePosition(vec3 position) {\n            return vec3(mat4(vec4(mcol0, 0.0),\n                    vec4(mcol1, 0.0),\n                    vec4(mcol2, 0.0),\n                    vec4(mcol3, 1.0)) * vec4(position, 1.0));\n        }\n    ",transpose_mat3:"\n        mat3 transpose_mat3( const in mat3 v ) {\n            mat3 tmp;\n            tmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n            tmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n            tmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n            return tmp;\n        }\n    ",compare_function:"\n        // bool bitEqual(int elementState,int state)\n        // {\n        //     if(state <= 0)\n        //     {\n        //         return state == elementState;\n        //     }\n        //     int k = int(log2(float(state)));\n        //     float a = float(elementState >> k);\n        //     float b = float(state >> k);\n        //     a = mod(a,2.);\n        //     b = mod(b,2.);\n        //     return abs(a-b) < 0.01;\n        // }\n\n        bool intEqual(int elementState,int state)\n        {\n            return elementState == state;\n        }\n\n        bool floatEqual(float elementState,float state)\n        {\n            return abs(elementState-state) < 0.01;\n        }\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.FillPatternShader={use_fillpattern_pars_fragment:"\n        #ifdef USE_FILLPATTERN\n            uniform sampler2D fillMap;\n        #endif\n    ",use_fillpattern_fragment:"\n        #ifdef USE_FILLPATTERN\n            vec2 screenPosition = vec2(gl_FragCoord.x,gl_FragCoord.y);\n            float flag = texture2D(fillMap, screenPosition.xy / 32.0).r;\n            if(flag == 0.0)\n            {\n                discard;\n            }\n        #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.LightsShader={direction_light_fragment:"\n        #if NUM_DIR_LIGHTS > 0\n            vec3 dirColor = vec3(0.0);\n            #if defined(USE_CSM)\n                DirectionalLight directionalLight;\n                vec3 debugColor = vec3(0.,0.,0.);\n                float shadowValue = calcShadowFactor(normalVector,debugColor);\n                for (int i = 4; i < NUM_DIR_LIGHTS; ++i)\n                {\n                    directionalLight = directionalLights[i];\n                    vec3 dirVector = normalize(directionalLight.direction);\n                    vec3 halfVector = normalize(dirVector + viewVector);\n\n                    float NdotL = max(dot(normalVector, dirVector), 0.0);\n                    float NdotH = max(dot(normalVector, halfVector), 0.0);\n                    float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                    vec3 F = F_Schlick(HdotV, F0);\n                    vec3 kS = F;\n                    vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                    float D = D_GGX(NdotH, roughnessFactor);\n                    float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                    vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                    #ifdef USE_SHADOWMAP\n                        directionalLight.color = mix(\n                            directionalLight.color * shadowValue,\n                            directionalLight.color,\n                            step(realOpacity, 0.9)\n                        );\n                    // if(realOpacity > 0.9)\n                    //     directionalLight.color *= shadowValue;\n                    #endif\n                    dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n                }\n            #else\n                #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                    DirectionalLightShadow directionalLightShadow;\n                #endif\n\n                DirectionalLight directionalLight;\n                vec3 dirVector;\n                vec3 halfVector;\n                float NdotL;\n                float NdotH;\n                float HdotV;\n\n                vec3 F;\n                vec3 kS;\n                vec3 kD;\n\n                float D;\n                float G;\n                vec3 specular;\n\n                #pragma unroll_loop_start\n                for (int i = 0; i < NUM_DIR_LIGHTS; i++)\n                {\n                    directionalLight = directionalLights[i];\n                    \n                    dirVector = normalize(directionalLight.direction);\n                    halfVector = normalize(dirVector + viewVector);\n\n                    NdotL = max(dot(normalVector, dirVector), 0.0);\n                    NdotH = max(dot(normalVector, halfVector), 0.0);\n                    HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                    F = F_Schlick(HdotV, F0);\n                    kS = F;\n                    kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                    D = D_GGX(NdotH, roughnessFactor);\n                    G = G_Smith(NdotV, NdotL, roughnessFactor);\n                    specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                    #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && (UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                        directionalLightShadow = directionalLightShadows[ i ];\n\n                        directionalLight.color = mix(\n                            mix(\n                                directionalLight.color,\n                                directionalLight.color * getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ),\n                                clamp(float(receiveShadow), 0.0, 1.0)\n                            ),\n                            directionalLight.color,\n                            step(realOpacity, 0.9)\n                        );\n\n                        // if(realOpacity > 0.9)\n                        //     directionalLight.color *= all( bvec2(receiveShadow, true ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                    #endif\n\n                    dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n                }\n                #pragma unroll_loop_end\n            #endif\n            totalLightColor += dirColor;\n        #endif\n    ",point_light_fragment:"\n        #if NUM_POINT_LIGHTS > 0\n            vec3 pointColor  = vec3(0.0);\n            #pragma unroll_loop_start\n            for (int i = 0; i < NUM_POINT_LIGHTS; i++)\n            {\n                PointLight pointLight = pointLights[i];\n                vec3 dirVector = pointLight.position - mvPosition;\n                float distance = length(dirVector);\n                dirVector = normalize(dirVector);\n                vec3 halfVector = normalize(dirVector + viewVector);\n\n                float NdotL = max(dot(normalVector, dirVector), 0.0);\n                float NdotH = max(dot(normalVector, halfVector), 0.0);\n                float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                vec3 F = F_Schlick(HdotV, F0);\n                vec3 kS = F;\n                vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                float D = D_GGX(NdotH, roughnessFactor);\n                float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n                pointColor += (kD * baseColor / PI + specular) * pointLight.color * NdotL * punctualLightIntensityToIrradianceFactor(distance, pointLight.distance, pointLight.decay);\n            }\n            #pragma unroll_loop_end\n            totalLightColor += pointColor;\n        #endif\n    ",spot_light_fragment:"\n        #if NUM_SPOT_LIGHTS > 0\n            vec3 spotColor  = vec3(0.0);\n\n            for (int i = 0; i < NUM_SPOT_LIGHTS; i++)\n            {\n                SpotLight spotLight = spotLights[i];\n                vec3 dirVector = spotLight.position - mvPosition;\n                float distance = length(dirVector);\n                dirVector = normalize(dirVector);\n                vec3 halfVector = normalize(dirVector + viewVector);\n\n                float angleCos = dot(dirVector, spotLight.direction);\n                if (angleCos > spotLight.coneCos)\n                {\n                    float spotEffect = smoothstep(spotLight.coneCos, spotLight.penumbraCos, angleCos);\n                    float NdotL = max(dot(normalVector, dirVector), 0.0);\n                    float NdotH = max(dot(normalVector, halfVector), 0.0);\n                    float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                    vec3 F = F_Schlick(HdotV, F0);\n                    vec3 kS = F;\n                    vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                    float D = D_GGX(NdotH, roughnessFactor);\n                    float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                    vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                    spotColor += (kD * baseColor / PI + specular) * spotLights[i].color * spotEffect * NdotL * punctualLightIntensityToIrradianceFactor(distance, spotLight.distance, spotLight.decay);\n                \n                    totalLightColor += spotColor;\n                }\n            }\n        #endif\n    ",incident_light_fragment:"\n        GeometricContext geometry;\n        geometry.position = - vViewPosition;\n        geometry.normal = normal;\n        geometry.viewDir = normalize( vViewPosition );\n        IncidentLight directLight;\n\n        #if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n            PointLight pointLight;\n\n            #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)\n                PointLightShadow pointLightShadow;\n            #endif\n            \n            #pragma unroll_loop_start\n            for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n                pointLight = pointLights[ i ];\n                getPointDirectLightIrradiance( pointLight, geometry, directLight );\n                //r142\n                //getPointLightInfo( pointLight, geometry, directLight );\n                #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n                    pointLightShadow = pointLightShadows[ i ];\n                    // directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n                    directLight.color =  mix(\n                            directLight.color * getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ),\n                            directLight.color * 1.0,\n                            clamp(2.0 - (float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                        );\n                #endif\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n            }\n            #pragma unroll_loop_end\n        \n        #endif\n\n        #if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n            SpotLight spotLight;\n\n            #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n                SpotLightShadow spotLightShadow;\n            #endif\n\n            #pragma unroll_loop_start\n            for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n                spotLight = spotLights[ i ];\n                getSpotDirectLightIrradiance( spotLight, geometry, directLight );\n                //r142\n                // getSpotLightInfo( spotLight, geometry, directLight );\n                #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n                    spotLightShadow = spotLightShadows[ i ];\n\n                    directLight.color = mix(\n                        mix(\n                            directLight.color * getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ),\n                            directLight.color * 1.0,\n                            clamp(2.0 - (float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                        ),\n                        directLight.color,\n                        step(opacity, 0.8)\n                    );\n\n\n                    // if(opacity > 0.8)\n                    //     directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n                #endif\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n            }\n            #pragma unroll_loop_end\n        #endif\n\n        //back\n        ///*\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )\n           \n            DirectionalLight directionalLight =  directionalLights[ 0 ];\n            getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n            \n            float shadowFactor = getCSMShadowFactor();\n                //delete csm 不接受阴影 === 不参加光照计算\n            directLight.color *= ( directLight.visible && receiveShadow ) ? shadowFactor : 1.0;\n\n            //BIMFACE-35834\n            // if(skipShadowCal == true){\n            //     directLight.color *= 0.0;\n            // } else{\n            //     float shadowFactor = getCSMShadowFactor();\n            //     directLight.color *= ( directLight.visible && receiveShadow ) ? shadowFactor : 1.0;\n            // }\n            // if(usePreShadow == true)\n            // {\n            //     float shadowFactor = getCSMShadowFactor();\n            //     //delete csm 不接受阴影 === 不参加光照计算\n            //     directLight.color *= ( directLight.visible && receiveShadow ) ? shadowFactor : 1.0;\n            // }\n            // else\n            // {\n            //     directLight.color *= 0.0;\n            // }\n\n            RE_Direct( directLight, geometry, material, reflectedLight );\n          \n\n            #if ( NUM_DIR_LIGHTS > NUM_DIR_LIGHT_SHADOWS)\n                // compute the lights not casting shadows (if any)\n                #pragma unroll_loop_start\n                for ( int i = NUM_DIR_LIGHT_SHADOWS; i < NUM_DIR_LIGHTS; i ++ ) {\n        \n                    directionalLight = directionalLights[ i ];\n        \n                    //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                    getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n        \n                    RE_Direct( directLight, geometry, material, reflectedLight );\n        \n                }\n                #pragma unroll_loop_end\n            #endif\n        #endif\n\n        //*/\n\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n            DirectionalLight directionalLight;\n\n            #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                DirectionalLightShadow directionalLightShadow;\n            #endif\n\n            #pragma unroll_loop_start\n            for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                directionalLight = directionalLights[ i ];\n                getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                //r142\n                //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                    directionalLightShadow = directionalLightShadows[ i ];\n                    // if(opacity > 0.8)\n                    // {\n                    //     // auto depth bias\n                    //     vec4 positionWS = vDirectionalShadowCoord[ i ];\n                    //     float cos = dot(normal, directionalLight.direction);\n                    //     float sin = sqrt(1.0 - cos*cos);\n                    //     float tan = min(1.0, sin/cos);\n                    //     float bias = directionalLightShadow.shadowBias * tan;\n                    //     //directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                    //     directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, bias, directionalLightShadow.shadowRadius, positionWS ) : 1.0;\n                    \n                    // }\n                    {   // 加大括号给每次循环中positionWS单独的作用域\n                        vec4 positionWS = vDirectionalShadowCoord[ i ];\n                        float cos = dot(normal, directionalLight.direction);\n                        float sin = sqrt(1.0 - cos*cos);\n                        float tan = min(1.0, sin/cos);\n                        float bias = directionalLightShadow.shadowBias * tan;\n                        directLight.color = mix(\n                            mix(\n                                directLight.color * getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, bias, directionalLightShadow.shadowRadius, positionWS ),\n                                directLight.color * 1.0,\n                                clamp(2.0 - (float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                            ),\n                            directLight.color,\n                            step(opacity, 0.8)\n                        );\n                    }\n                    \n                #endif\n                RE_Direct( directLight, geometry, material, reflectedLight );\n            }\n            #pragma unroll_loop_end\n        #endif\n    ",rect_area_light_fragment:"\n        #if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n            RectAreaLight rectAreaLight;\n            for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n                rectAreaLight = rectAreaLights[ i ];\n                RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n            }\n        #endif\n    ",re_indirect_diffuse_fragment:"\n\n  \n        #if defined( RE_IndirectDiffuse )\n            vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n            #ifndef DISABLE_HEMI_LIGHT\n                #if ( NUM_HEMI_LIGHTS > 0 )\n                    #pragma unroll_loop_start\n                    for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n                        irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n                    }\n                    #pragma unroll_loop_end\n                #endif\n            #endif\n            #if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n                irradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n            #endif\n            \n            RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n        #endif\n    ",re_indirect_specular_fragment:"\n        #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n            vec3 radiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, 8 ) * metalness * 0.2;\n            #ifndef STANDARD\n                vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );\n            #else\n                vec3 clearCoatRadiance = vec3( 0.0 );\n            #endif\n            RE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); \n        #endif\n    ",diffuse_specular_emissive_IBL_fragment:"\n        vec3 diffuseSpecularEmissive = vec3(0.0);\n\n        #ifdef USE_LIGHTMAP\n            #include <USE_LIGHTMAP_pars_Fragment>\n            \n            vec3 diffuseSpecular =  clamp(baseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;\n            diffuseSpecularEmissive = diffuseSpecular + baseColor.rgb * 0.0;\n        #endif\n    ",diffuse_specular_emissive_fragment:"\n        vec3 diffuseSpecularEmissive = vec3(0.0);\n\n        #ifdef USE_LIGHTMAP\n            #include <USE_LIGHTMAP_pars_Fragment>\n            \n            vec3 diffuseSpecular =  clamp(diffuseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;\n            diffuseSpecularEmissive = diffuseSpecular + diffuseColor.rgb * 0.0;\n        #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.shadowmask_pars_fragment="\nfloat getShadowMask() {\n\n\tfloat shadow = 1.0;\n\n\t#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t\tDirectionalLightShadow directionalLight;\n\t\tvec4 shadowCoord = vec4(0.0);\n\t\tvec2 shadowMapSize = vec2(0,0);\n\t\tbool frustumTest = false;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowCoord = vDirectionalShadowCoord[ i ];\n\t\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\t\tshadowMapSize = directionalLight.shadowMapSize;\n\t\t\t#ifdef USE_CSM\n\t\t\t\tif(UNROLLED_LOOP_INDEX == 0){\n\t\t\t\t\tfrustumTest = getFrustumTest(shadowCoord, directionalLight.shadowBias);\n\t\t\t\t\tshadowCoord.x = shadowCoord.x * 0.5;\n\t\t\t\t\tshadowCoord.y = shadowCoord.y * 0.5;\n\t\t\t\t}else if(UNROLLED_LOOP_INDEX == 1){\n\t\t\t\t\tfrustumTest = getFrustumTest(shadowCoord, directionalLight.shadowBias);\n\t\t\t\t\tshadowCoord.x = shadowCoord.x * 0.5 + 0.5;\n                \tshadowCoord.y = shadowCoord.y * 0.5;\n\t\t\t\t}else if(UNROLLED_LOOP_INDEX == 2){\n\t\t\t\t\tfrustumTest = getFrustumTest(shadowCoord, directionalLight.shadowBias);\n\t\t\t\t\tshadowCoord.x = shadowCoord.x * 0.5;\n\t\t\t\t\tshadowCoord.y = shadowCoord.y * 0.5 + 0.5;\n\t\t\t\t}else if(UNROLLED_LOOP_INDEX == 3){\n\t\t\t\t\tfrustumTest = getFrustumTest(shadowCoord, directionalLight.shadowBias);\n\t\t\t\t\tshadowCoord.x = shadowCoord.x * 0.5 + 0.5;\n\t\t\t\t\tshadowCoord.y = shadowCoord.y * 0.5 + 0.5;\n\t\t\t\t}\n\t\t\t\tshadowMapSize = directionalLightShadows[0].shadowMapSize;\n\t\t\t\t//shadow *= receiveShadow ? getShadow( directionalShadowMap[0], shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, shadowCoord ) : 1.0;\n\t\t\t\tshadow *= receiveShadow ? getRandomShadow2( directionalShadowMap[ 0 ], shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, shadowCoord, frustumTest, true) : 1.0;\n\t\t\t#else\n\t\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[i], shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, shadowCoord ) : 1.0;\n\t\t\t#endif\n\t\t\t\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\tSpotLightShadow spotLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\tPointLightShadow pointLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): update shadow for Area light\n\n\t#endif\n\t*/\n\n\t#endif\n\n\treturn shadow;\n}\n",r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.OutlineShader={outline_pars_vertex:"\n    #ifdef USE_BC_OUTLINE \n        attribute vec3 barycentric;\n        varying vec3 vBarycentric;\n    #endif\n    ",outine_vertex:"\n    #if defined(USE_BC_OUTLINE)\n        vBarycentric = barycentric;\n    #endif\n    ",outline_pars_fragment:"\n    #if defined(USE_BC_OUTLINE)\n        varying vec3 vBarycentric;\n        uniform vec3 outLineColor;\n        uniform sampler2D uLineTexture;\n    #endif\n    ",outline_function_pars_fragment:"\n        #if defined(USE_BC_OUTLINE)\n            float edgeFactor3(){\n                vec3 d = fwidth(vBarycentric);\n                float minValue = 0.0000001;\n                // make sure d is not 0\n                d = clamp(d, vec3(minValue), vec3(10.0));\n                vec3 a3 = smoothstep(vec3(0.0), d*0.8, vBarycentric);\n                return min(min(a3.x, a3.y), a3.z);\n            }\n        #endif\n    ",outline_function_pars_fragment_10:"\n        #if defined(USE_BC_OUTLINE)\n            float edgeFactor3(){\n                vec3 d = fwidth(vBarycentric);\n                float minValue = 0.0000001;\n                // make sure d is not 0\n                d = clamp(d, vec3(minValue), vec3(10.0));\n                vec3 a3 = smoothstep(vec3(0.0), d*1.0, vBarycentric);\n                return min(min(a3.x, a3.y), a3.z);\n            }\n        #endif\n    ",outline_function_fragment_get_line_tickness:"\n    #if defined(USE_BC_OUTLINE)\n        float getLineTickness(){\n            float tcx = min(min(vBarycentric.x, vBarycentric.y), vBarycentric.z);\n            vec2 tc = vec2(tcx, 0.0);\n            float line_tickness = texture2D(uLineTexture, tc, -0.001).r; //值越大，线条越粗\n            float line_tickness_old = 1.0 - edgeFactor3();  \n\n            // fix断线\n            float flag_break = step(line_tickness, 0.01) * step(0.2, line_tickness_old);\n            line_tickness = mix(line_tickness, line_tickness_old, flag_break); \n            // 线条边缘变细\n            float flag_edge = step(line_tickness_old, line_tickness);\n            line_tickness = mix(line_tickness, max(line_tickness_old, line_tickness * 0.65), flag_edge); \n            // fix magfliter 线条变粗\n            float deltaMax = max(length(dFdx(tcx)), length(dFdy(tcx)));\n            float flag_mag = step(deltaMax, 0.000061) * step(line_tickness_old, line_tickness);\n            float magLevel = deltaMax / 0.000061;\n            float newThickness = max(line_tickness_old, line_tickness * magLevel - 0.05);\n            line_tickness = mix(line_tickness, newThickness, flag_mag);\n            \n\n            /*\n            if(line_tickness < 0.01 && line_tickness_old > 0.2)     // fix断线 \n                line_tickness = line_tickness_old;\n            if(line_tickness_old < line_tickness)\n                line_tickness = max(line_tickness_old, line_tickness * 0.65); // 线条边缘变细\n            \n            // fix magfliter 线条变粗\n            float deltaMax = max(length(dFdx(tcx)), length(dFdy(tcx)));\n            if(deltaMax < 0.000061)\n            {\n                float magLevel = deltaMax / 0.000061;\n                if(line_tickness_old < line_tickness)\n                    line_tickness = max(line_tickness_old, line_tickness * magLevel - 0.05);\n            }*/\n            return line_tickness;\n        }\n\n        float getLineDistFactor(){\n            float dist = length(fwidth(vViewPosition));\n            float distFactor = 1.0 - clamp(dist * 0.5, 0.0, 0.8);\n            return distFactor;\n        }\n    #endif\n    ",outline_fragment:"\n    #if defined(USE_BC_OUTLINE) \n        #include <cloud_wire_frame_state_fragment>\n        \n        float line_tickness = getLineTickness();\n        line_tickness *= getLineDistFactor();// 远处线条渐隐\n\n        gl_FragColor.rgb = mix(gl_FragColor.rgb, finWireFrameColor, line_tickness);\n        // 全透明的构件不进行线框显示加强\n        float transparentFlag = step(gl_FragColor.a, 0.6) * step(0.01, gl_FragColor.a);\n        gl_FragColor.a = mix(gl_FragColor.a, 0.6, line_tickness * transparentFlag);\n        \n        //if( gl_FragColor.a < 0.6 && gl_FragColor.a > 0.01 )\n\t\t//   gl_FragColor.a = mix(gl_FragColor.a, 0.6, line_tickness);\n        \n    #endif\n    ",cloudstandard_bc_outline_v3_fragment:"\n        #if defined(USE_BC_OUTLINE)\n            #include <cloud_wire_frame_state_fragment>\n            vec3 _tempColor = gl_FragColor.rgb;\n            float line_tickness = getLineTickness();\n            line_tickness *= getLineDistFactor();// 远处线条渐隐\n\t\t    gl_FragColor.rgb = mix(gl_FragColor.rgb, finWireFrameColor, line_tickness);\n\n            // if(!floatEqual(wireFrameState, WireframeState_HIDDEN))\n            // {\n            //     gl_FragColor.rgb = mix(finWireFrameColor, _tempColor, edgeFactor3());\n            // }\n        #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.PackingMaterialShader={packing_material_pars_vertex:"\n    #if defined(USE_PACKINGMAT)\n        attribute vec2 uv3;\n        varying vec2 vUv3;\n    #endif\n    ",packing_material_vertex:"\n    #if defined(USE_PACKINGMAT)\n        vUv3 = uv3;\n    #endif\n    ",packing_material_pars_fragment:"\n    #if defined(USE_PACKINGMAT)\n        varying vec2 vUv3;\n        uniform sampler2D packingMatMap;\n    #endif\n    ",packing_material_fragment:"\n     float noise_type = 0.0;\n    #ifdef USE_PACKINGMAT\n       \n        const float fUVStep = 0.0009765625;\n        float uvx = vUv3.x;\n        vec4 packing_pixel0 = texture2D(packingMatMap, vec2(uvx  , vUv3.y) );\n        \n        #ifdef USE_PACKING_PIXEL1\n            vec4 packing_pixel1 = texture2D(packingMatMap, vec2(uvx + 1.0*fUVStep , vUv3.y));\n        #endif\n        vec4 packing_pixel2 = texture2D(packingMatMap, vec2(uvx + 2.0*fUVStep , vUv3.y));\n        vec4 packing_pixel3 = texture2D(packingMatMap, vec2(uvx + 3.0*fUVStep , vUv3.y));\n        vec4 packing_pixel4 = texture2D(packingMatMap, vec2(uvx + 4.0*fUVStep , vUv3.y));\n        vec4 packing_pixel5 = texture2D(packingMatMap, vec2(uvx + 5.0*fUVStep , vUv3.y));\n        \n        vec3 diffuse        = packing_pixel0.xyz  ;\n        \n        #ifdef USE_PACKING_PIXEL0_W\n            float opacity        = packing_pixel0.w;\n        #endif\n        #ifdef USE_PACKING_PIXEL1\n            vec3 specular        = packing_pixel1.xyz;\n            float shininess      = packing_pixel1.w;\n        #endif\n        float bumpScale          = packing_pixel2.x;\n        float roughness          = packing_pixel2.y;\n        float metalness          = packing_pixel2.z;\n        vec3 emissive            = packing_pixel3.xyz;\n        float reflectivity       = packing_pixel3.w;\n        vec3 enviroment          = packing_pixel4.xyz;\n        float refractionRatio    = packing_pixel4.w;\n        noise_type               = packing_pixel5.x;\n        vec3 tintColor           = packing_pixel5.yzw;\n        float checkTintColor = tintColor.x + tintColor.y + tintColor.z;\n        if( checkTintColor < 0.01 )\n            tintColor = vec3(1.0,1.0,1.0);\n    #endif\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.UVShader={uv_transform_vertex:"\n        vUv = vec2(mat3(\n                vec3(muvCol0.xy, 0.0),\n                vec3(muvCol0.zw, 0.0),\n                vec3(muvCol1, 1.0)) * vec3(uv, 1.0)\n            );\n        vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;\n    ",uv2_decode_vertex:"\n        vUv2 = uvDecode(vUv2);\n    ",uv2_offsetrepeat_vertex:"\n        vUv2.x = uv2OffsetRepeat.x * vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;\n        vUv2.y = uv2OffsetRepeat.y * vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;\n    "},r.ShaderChunk||(r.ShaderChunk={}),r.ShaderChunk.FlatShadedShader={flat_shaded_pars_vertex:"\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n    ",flat_shaded_vertex:"\n        #ifndef FLAT_SHADED\n            vNormal = normalize( transformedNormal );\n        #endif\n    ",flat_shaded_pars_fragment:"\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n    ",flat_shaded_tangent_pars_fragment:"\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n            #ifdef USE_TANGENT\n                varying vec3 vTangent;\n                varying vec3 vBitangent;\n            #endif\n        #endif\n    ",flat_shaded_fragment:"\n        #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n            vViewPosition = - mvPosition.xyz;\n        #endif\n    "},r.ClippingStencilShader={uniforms:{},vertexShader:"\n        #include <clipping_planes_pars_vertex>\n        #include <cloud_state_pars_vertex>\n        #ifdef USE_INSTANCE\n            attribute vec4 vState;\n            attribute float vClipping;\n            varying float fClipping;\n            attribute vec4 aColor;\n            varying vec4 vaColor;\n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)||defined(USE_BUMPMAP) \n                attribute vec4 muvCol0;\n                attribute vec2 muvCol1;\n                // attribute vec2 muvCol2;\n            #endif\n            #if defined(USE_LIGHTMAP)\n                attribute vec4 uv2OffsetRepeat;\n            #endif\n        #endif\n\n        void main() {\n            #include <cloud_state_vertex>\n            #include <begin_vertex>\n            #ifdef USE_INSTANCE\n                // vaColor = aColor;\n                // fClipping = vClipping;\n                componentState = vState.x;\n                #include <Transform_pars_vertex>\n            #endif\n            #include <project_vertex>\n            #include <clipping_planes_vertex>\n        }",fragmentShader:"\n        #include <clipping_planes_pars_fragment>\n        #include <cloud_state_defines>\n        #include <cloud_state_pars_fragment>\n\n        #include <compare_function>\n        \n        void main(void){\n            #ifdef USE_INSTANCE\n               if (!floatEqual(componentState, ElementState_CLIPPING) || floatEqual(componentState, ElementState_HIDDEN)) \n                   discard;\n            #endif\n            #include <num_clipping_planes_for_stencil_fragment>\n            gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n        }\n    "},r.ShadowMapShader={shadowmap_pars_fragment:" \n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): create uniforms for area light shadows\n\n\t#endif\n\t*/\n\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\n\t}\n\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\n\t}\n\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\n\t\tfloat occlusion = 1.0;\n\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\n\t\tfloat hard_shadow = step( compare , distribution.x ); // Hard Shadow\n\n\t\tif (hard_shadow != 1.0 ) {\n\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality\n\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed\n\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\n\t\t}\n\t\treturn occlusion;\n\n\t}\n\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n        const vec2 offset = vec2( 0.0, 1.0 );\n        vec2 texelSize = vec2( 1.0 ) / size;\n        vec2 centroidUV = floor( uv * size + 0.5 ) / size;\n        float lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n        float lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n        float rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n        float rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n        vec2 f = fract( uv * size + 0.5 );\n        float a = mix( lb, lt, f.y );\n        float b = mix( rb, rt, f.y );\n        float c = mix( a, b, f.x );\n        return c;\n\t}\n\n\t#define LIGHT_WORLD_SIZE 0.005\n\t#define LIGHT_FRUSTUM_WIDTH 3.75\n\t#define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH)\n\t#define NEAR_PLANE 9.5\n\n\t#define NUM_SAMPLES 17\n\t#define NUM_RINGS 11\n\t#define BLOCKER_SEARCH_NUM_SAMPLES NUM_SAMPLES\n\n\tvec2 poissonDisk[NUM_SAMPLES];\n\n\tvoid initPoissonSamples( const in vec2 randomSeed ) {\n\t\tfloat ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n\t\tfloat INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n\t\t// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n\t\tfloat angle = rand( randomSeed ) * PI2;\n\t\tfloat radius = INV_NUM_SAMPLES;\n\t\tfloat radiusStep = radius;\n\n\t\tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n\t\t\tpoissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );\n\t\t\tradius += radiusStep;\n\t\t\tangle += ANGLE_STEP;\n\t\t}\n\t}\n\n\tfloat penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n\t\treturn (zReceiver - zBlocker) / zBlocker;\n\t}\n\n\tfloat findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver ) {\n\t\t// This uses similar triangles to compute what\n\t\t// area of the shadow map we should search\n\t\tfloat searchRadius = LIGHT_SIZE_UV * ( zReceiver - NEAR_PLANE ) / zReceiver;\n\t\tfloat blockerDepthSum = 0.0;\n\t\tint numBlockers = 0;\n\n\t\tfor( int i = 0; i < BLOCKER_SEARCH_NUM_SAMPLES; i++ ) {\n\t\t\tfloat shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));\n\t\t\tif ( shadowMapDepth < zReceiver ) {\n\t\t\t\tblockerDepthSum += shadowMapDepth;\n\t\t\t\tnumBlockers ++;\n\t\t\t}\n\t\t}\n\n\t\tif( numBlockers == 0 ) return -1.0;\n\n\t\treturn blockerDepthSum / float( numBlockers );\n\t}\n\n\tfloat PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {\n\t\tfloat sum = 0.0;\n\t\tfloat depth;\n\t\t#pragma unroll_loop_start\n\t\tfor( int i = 0; i < 17; i ++ ) {\n\t\t\tdepth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n\t\t\tif( zReceiver <= depth ) sum += 1.0;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#pragma unroll_loop_start\n\t\tfor( int i = 0; i < 17; i ++ ) {\n\t\t\tdepth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n\t\t\tif( zReceiver <= depth ) sum += 1.0;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\treturn sum / ( 2.0 * float( 17 ) );\n\t}\n\n\tfloat PCSS ( sampler2D shadowMap, vec4 coords ) {\n\t\tvec2 uv = coords.xy;\n\t\tfloat zReceiver = coords.z; // Assumed to be eye-space z in this code\n\n\t\tinitPoissonSamples( uv );\n\t\t// STEP 1: blocker search\n\t\tfloat avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver );\n\n\t\t//There are no occluders so early out (this saves filtering)\n\t\tif( avgBlockerDepth == -1.0 ) return 1.0;\n\n\t\t// STEP 2: penumbra size\n\t\tfloat penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );\n\t\tfloat filterRadius = penumbraRatio * LIGHT_SIZE_UV * NEAR_PLANE / zReceiver;\n\n\t\t// STEP 3: filtering\n\t\t//return avgBlockerDepth;\n\t\treturn PCF_Filter( shadowMap, uv, zReceiver, filterRadius );\n\t}\n\n\tfloat getRandomShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\t// if ( something && something ) breaks ATI OpenGL shader compiler\n\t\t// if ( all( something, something ) ) using this instead\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\n\t\tif ( frustumTest ) {\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\n\t\t\tfloat theta = rand( shadowCoord.xy ) * PI2; ;\n            mat2 randomRotationMatrix = mat2(vec2(cos(theta), -sin(theta)),vec2(sin(theta), cos(theta)));\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t}\n\t\treturn shadow;\n\t}\n\n\tbool getFrustumTest(inout vec4 shadowCoord, float shadowBias){\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\t\treturn frustumTest;\n\t}\n\n\n\tfloat getRandomShadow2( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, bool frustumTest, bool isFineShadow) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tif ( frustumTest ) {\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\n\n\t\t\tfloat theta = rand( shadowCoord.xy ) * PI2; ;\n            mat2 randomRotationMatrix = mat2(vec2(cos(theta), -sin(theta)),vec2(sin(theta), cos(theta)));\n\t\t\tif(isFineShadow){\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t\t) * ( 1.0 / 17.0 );\n\t\t\t} else {\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + randomRotationMatrix * vec2( 0.0, dy1 ), shadowCoord.z )\n\t\t\t\t) * ( 1.0 / 5.0 );\n\t\t\t}\n\n\t\t\t//shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t}\n\t\treturn shadow;\n\t}\n\t\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\t// if ( something && something ) breaks ATI OpenGL shader compiler\n\t\t// if ( all( something, something ) ) using this instead\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\n\t\tif ( frustumTest ) {\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\t//return PCSS( shadowMap, shadowCoord );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t\t/*\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t*/\n\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#else // no percentage-closer filtering:\n\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#endif\n\n\t\t}\n\n\t\treturn shadow;\n\n\t}\n\n\t// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D\n\t// vector suitable for 2D texture mapping. This code uses the following layout for the\n\t// 2D texture:\n\t//\n\t// xzXZ\n\t//  y Y\n\t//\n\t// Y - Positive y direction\n\t// y - Negative y direction\n\t// X - Positive x direction\n\t// x - Negative x direction\n\t// Z - Positive z direction\n\t// z - Negative z direction\n\t//\n\t// Source and test bed:\n\t// https://gist.github.com/tschw/da10c43c467ce8afd0c4\n\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n\t\t// Number of texels to avoid at the edge of each square\n\n\t\tvec3 absV = abs( v );\n\n\t\t// Intersect unit cube\n\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\n\t\t// Apply scale to avoid seams\n\n\t\t// two texels less per square (one texel will do for NEAREST)\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n\t\t// Unwrap\n\n\t\t// space: -1 ... 1 range for each square\n\t\t//\n\t\t// #X##\t\tdim    := ( 4 , 2 )\n\t\t//  # #\t\tcenter := ( 1 , 1 )\n\n\t\tvec2 planar = v.xy;\n\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\n\t\tif ( absV.z >= almostOne ) {\n\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\n\t\t} else if ( absV.x >= almostOne ) {\n\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\n\t\t} else if ( absV.y >= almostOne ) {\n\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\n\t\t}\n\n\t\t// Transform to UV space\n\n\t\t// scale := 0.5 / dim\n\t\t// translate := ( center + 0.5 ) / dim\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n\t}\n\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\n\t\t// for point lights, the uniform @vShadowCoord is re-purposed to hold\n\t\t// the vector from the light to the world-space position of the fragment.\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\n\t\t// dp = normalized distance from light to fragment position\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\n\t\tdp += shadowBias;\n\n\t\t// bd3D = base direction 3D\n\t\tvec3 bd3D = normalize( lightToPosition );\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#else // no percentage-closer filtering\n\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\n\t\t#endif\n\n\t}\n\n#endif\n"},r.DepthFragShader={depth_frag:" \n    #if DEPTH_PACKING == 3200\n\n\tuniform float opacity;\n\n#endif\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n//r142\n//#include <alphatest_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvarying vec2 vHighPrecisionZW;\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tdiffuseColor.a = opacity;\n\n\t#endif\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\t#include <logdepthbuf_fragment>\n\n\t// Higher precision equivalent of gl_FragCoord.z. This assumes depthRange has been left to its default values.\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\n\t#elif DEPTH_PACKING == 3201\n\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\n\t#endif\n\n}\n"},r.CSMShader={csm_fragment:"\n        uniform vec2 csmCascades[4];\n        uniform bool isFineShadow;\n        uniform bool skipShadowCal;\n        float calcShadowFactor(vec3 normal, inout vec3 debugColor)\n        {\n            float shadowFactor = 1.0;\n            #ifdef USE_CSM\n                #if ( NUM_DIR_LIGHTS > 0 )\n                    #ifdef USE_SHADOWMAP\n                        float viewDepth = vViewPosition.z;\n                        DirectionalLight directionalLight;\n                        directionalLight = directionalLights[ 0 ];\n                        #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                            DirectionalLightShadow directionalLightShadow;\n                        #endif\n                        directionalLightShadow = directionalLightShadows[ 0 ];\n\n                        float bias = cos(80.0);\n                        float biasFactor = 0.8;\n\t\t\t\t\t    float csmx1;\n\t\t\t\t\t    float csmy1;\n                        float csmx2;\n\t\t\t\t\t    float csmy2;\n                        float baseShadow = 0.0;\n                        #pragma unroll_loop_start\n                        for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                            #if ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS && UNROLLED_LOOP_INDEX < 4)\n                                csmx1 = csmCascades[UNROLLED_LOOP_INDEX].x;\n                                csmy1 = csmCascades[UNROLLED_LOOP_INDEX].y;\n                                csmx2 = csmCascades[UNROLLED_LOOP_INDEX].x;\n                                csmy2 = csmCascades[UNROLLED_LOOP_INDEX].y;\n                                #if (UNROLLED_LOOP_INDEX > 0)\n                                    csmx1 = csmCascades[UNROLLED_LOOP_INDEX - 1].y;\n                                #endif\n                                #if (UNROLLED_LOOP_INDEX < 3)\n                                    csmy1 = csmCascades[UNROLLED_LOOP_INDEX + 1].x;\n                                    csmx2 = csmCascades[UNROLLED_LOOP_INDEX + 1].x;\n                                    csmy2 = csmCascades[UNROLLED_LOOP_INDEX].y;\n                                #endif\n\n                                directionalLight = directionalLights[ i ];\n                                directionalLightShadow = directionalLightShadows[ i ];\n                                if(viewDepth >= csmx1 && ( viewDepth < csmy2 || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 )) \n                                {\n                                    float cos = dot(normal, directionalLight.direction);\n                                    float sin = sqrt(1.0 - cos*cos);\n                                    float tan = min(1.0, sin/cos);\n                                    float calBias = directionalLightShadow.shadowBias; // *tan;\n                                    shadowFactor = baseShadow + getRandomShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, calBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) ;\n                                    float dotNL = dot( normal, directionalLight.direction );\n                                    if (dotNL < bias) {\n                                        //shadowFactor = biasFactor;\n                                    }\n                                }\n\n\n                                #if (UNROLLED_LOOP_INDEX < 3)\n                                {\n                                    if(viewDepth >= csmx2 && viewDepth < csmy2)\n                                    {\n                                        float ratio = (viewDepth - csmx2) / ( csmy2 - csmx2);\n                                        directionalLightShadow = directionalLightShadows[ UNROLLED_LOOP_INDEX + 1 ];\n                                        float calBias = directionalLightShadow.shadowBias;\n                                        float nextShadowFactor = baseShadow + getRandomShadow( directionalShadowMap[ UNROLLED_LOOP_INDEX + 1 ], directionalLightShadow.shadowMapSize, calBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ UNROLLED_LOOP_INDEX + 1] ) ;\n                                        shadowFactor = mix(shadowFactor, nextShadowFactor, ratio);\n                                        //shadowFactor = mix(nextShadowFactor, shadowFactor , ratio);\n                                        //shadowFactor = nextShadowFactor;\n                                    }\n                                }\n                                #endif\n                            #endif\n                        \n                        }\n                        #pragma unroll_loop_end\n                    #endif\n                #endif\n            #endif\n            shadowFactor = clamp(shadowFactor, 0.0, 1.0);\n            return shadowFactor;\n        }\n\n        float getCSMShadowFactor() {\n            #if !defined(USE_CSM) || !defined( USE_SHADOWMAP ) || NUM_DIR_LIGHT_SHADOWS == 0\n                return 1.0;\n            #else\n            float viewDepth = vViewPosition.z;\n            int mapIndex = -1;\n            int mapNextIndex = -1;\n            vec2 weight = vec2(0.0,0.0);\n            weight.x = step(csmCascades[0].x,viewDepth) \n                + step(csmCascades[1].x,viewDepth) \n                + step(csmCascades[2].x,viewDepth) \n                + step(csmCascades[3].x,viewDepth);\n            weight.y = step(csmCascades[0].y,viewDepth) \n                + step(csmCascades[1].y,viewDepth) \n                + step(csmCascades[2].y,viewDepth) \n                + step(csmCascades[3].y,viewDepth);\n\n\n            if(weight.x >= 1.0 && weight.x - 1.0 == weight.y){\n                mapIndex = int(weight.x) - 1; \n            }else if(weight.x >= 1.0 && weight.x - 2.0 == weight.y){\n                mapIndex = int(weight.x) - 2;\n                mapNextIndex = mapIndex + 1;\n            }else{\n                return 1.0;\n            }\n    \n            DirectionalLightShadow directionalLightShadow = directionalLightShadows[ 0 ];\n\n            float ratio = 0.0;\n            vec4 shadowCoord = vec4(0.0);\n            bool frustumTest = false;\n            float shadowBias = 0.0;\n            float shadowRadius = 0.0;\n            \n            vec4 shadowCoordNext = vec4(0.0);\n            bool frustumTestNext = false;\n            float shadowBiasNext = 0.0;\n            float shadowRadiusNext = 0.0;\n            if(mapIndex == 0){\n                shadowBias =  directionalLightShadows[0].shadowBias;\n                shadowRadius = directionalLightShadows[0].shadowRadius;\n                shadowCoord = vDirectionalShadowCoord[ 0 ];\n                frustumTest = getFrustumTest(shadowCoord, shadowBias);\n                shadowCoord.x = shadowCoord.x * 0.5;\n                shadowCoord.y = shadowCoord.y * 0.5;\n\n                if(mapNextIndex == 1){\n                    shadowBiasNext =  directionalLightShadows[1].shadowBias;\n                    shadowRadiusNext =  directionalLightShadows[1].shadowRadius;\n                    shadowCoordNext = vDirectionalShadowCoord[ 1 ];\n                    frustumTestNext = getFrustumTest(shadowCoordNext, shadowBiasNext);\n                    shadowCoordNext.x = shadowCoordNext.x * 0.5 + 0.5;\n                    shadowCoordNext.y = shadowCoordNext.y * 0.5;\n                    ratio = (viewDepth - csmCascades[1].x) / ( csmCascades[0].y - csmCascades[1].x);\n                }\n            }else if(mapIndex == 1){\n                shadowBias =  directionalLightShadows[1].shadowBias;\n                shadowRadius = directionalLightShadows[1].shadowRadius;\n                shadowCoord = vDirectionalShadowCoord[ 1 ];\n                frustumTest = getFrustumTest(shadowCoord, shadowBias);\n                shadowCoord.x = shadowCoord.x * 0.5 + 0.5;\n                shadowCoord.y = shadowCoord.y * 0.5;\n                if(mapNextIndex == 2){\n                    shadowBiasNext =  directionalLightShadows[2].shadowBias;\n                    shadowRadiusNext =  directionalLightShadows[2].shadowRadius;\n                    shadowCoordNext = vDirectionalShadowCoord[ 2 ];\n                    frustumTestNext = getFrustumTest(shadowCoordNext, shadowBiasNext);\n                    shadowCoordNext.x = shadowCoordNext.x * 0.5;\n                    shadowCoordNext.y = shadowCoordNext.y * 0.5 + 0.5;\n                    ratio = (viewDepth - csmCascades[2].x) / ( csmCascades[1].y - csmCascades[2].x);\n                }\n            }else if(mapIndex == 2){\n                shadowBias =  directionalLightShadows[2].shadowBias;\n                shadowRadius = directionalLightShadows[2].shadowRadius;\n                shadowCoord = vDirectionalShadowCoord[ 2 ];\n                frustumTest = getFrustumTest(shadowCoord, shadowBias);\n                shadowCoord.x = shadowCoord.x * 0.5;\n                shadowCoord.y = shadowCoord.y * 0.5 + 0.5;    \n                if(mapNextIndex == 3){\n                    shadowBiasNext =  directionalLightShadows[3].shadowBias;\n                    shadowRadiusNext =  directionalLightShadows[3].shadowRadius;\n                    shadowCoordNext = vDirectionalShadowCoord[ 3 ];\n                    frustumTestNext = getFrustumTest(shadowCoordNext, shadowBiasNext);\n                    shadowCoordNext.x = shadowCoordNext.x * 0.5 + 0.5;\n                    shadowCoordNext.y = shadowCoordNext.y * 0.5 + 0.5;\n                    ratio = (viewDepth - csmCascades[3].x) / ( csmCascades[2].y - csmCascades[3].x);\n                }\n            }else if(mapIndex == 3){\n                shadowBias =  directionalLightShadows[3].shadowBias;\n                shadowRadius = directionalLightShadows[3].shadowRadius;\n                shadowCoord = vDirectionalShadowCoord[ 3 ];\n                frustumTest = getFrustumTest(shadowCoord, shadowBias);\n                shadowCoord.x = shadowCoord.x * 0.5 + 0.5;\n                shadowCoord.y = shadowCoord.y * 0.5 + 0.5;\n            }\n            float shadowFactor = getRandomShadow2( directionalShadowMap[ 0 ], directionalLightShadow.shadowMapSize, shadowBias, shadowRadius, shadowCoord, frustumTest,isFineShadow) ;\n            if(mapNextIndex>-1){\n                float nextShadowFactor = getRandomShadow2( directionalShadowMap[ 0 ], directionalLightShadow.shadowMapSize, shadowBiasNext, shadowRadiusNext, shadowCoordNext, frustumTestNext,isFineShadow) ;\n                shadowFactor = mix(shadowFactor,nextShadowFactor, ratio);\n            }\n            return shadowFactor;\n            #endif\n        }\n        \n    "},r.GroundDrawingShader={uniforms:{groundDrawingCascadeCount:{value:0},multiSample:{value:!1},viewportSize:{value:new THREE.Vector2},worldCoordTranslate:{value:new THREE.Vector3},groundDrawingTexture:{value:[null,null,null,null,null,null,null,null]},groundDrawingOrthMVP:{value:[new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4]}},groundDrawing_pars_vertex:"\n            #if defined ACCEPT_DRAWING\n                varying vec2 drawingTextureCoord[8];\n                uniform vec3 worldCoordTranslate;\n                uniform mat4 groundDrawingOrthMVP[8];\n            #endif\n        ",groundDrawing_vertex:"\n            #if defined ACCEPT_DRAWING\n                //vec3 worldCoord = position;\n                vec3 worldCoord = (modelMatrix * vec4(position,1.0)).xyz;             \n                worldCoord = worldCoord - worldCoordTranslate;\n\n                for(int i = 0;i < 8;++i)\n                {\n                    vec4 frag_coord  = (groundDrawingOrthMVP[i] * vec4(worldCoord,1.0));\n\n                    frag_coord.xyz /= frag_coord.w;\n                    frag_coord.w = 1.0 / frag_coord.w;\n    \n                    frag_coord.xyz *= vec3 (0.5);\n                    frag_coord.xy += vec2 (0.5); \n                    drawingTextureCoord[i] = frag_coord.xy;\n                }\n                \n            #endif\n        ",groundDrawing_pars_fragment:"\n            #if defined ACCEPT_DRAWING\n                uniform int groundDrawingCascadeCount;\n                uniform vec2 viewportSize;\n                uniform bool multiSample;\n                uniform sampler2D groundDrawingTexture[8];\n                varying vec2 drawingTextureCoord[8];\n            #endif\n        ",groundDrawing_fragment:"\n        #if defined ACCEPT_DRAWING\n            //int count = 0;\n            vec4 groundDrawingColor;\n\n            //while(count < groundDrawingCascadeCount)\n            for(int count = 0; count < 8; ++count)\n            {\n                if(count == 0)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[0],groundDrawingTexture[0]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 1)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[1],groundDrawingTexture[1]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 2)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[2],groundDrawingTexture[2]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 3)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[3],groundDrawingTexture[3]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 4)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[4],groundDrawingTexture[4]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 5)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[5],groundDrawingTexture[5]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 6)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[6],groundDrawingTexture[6]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                else if(count == 7)\n                {\n                    vec4 groundDrawingColor = getGroundDrawingColor(drawingTextureCoord[7],groundDrawingTexture[7]);\n                    if(groundDrawingColor.w > 0.0 && count >= 0)\n                    {\n                        resultColor = groundDrawingColor;\n                        break;\n                    }\n                }\n                //++count;\n            }  \n        #endif\n        ",groundDrawing_fragment_getColor:"\n        #if defined ACCEPT_DRAWING\n            \n            \n\n            vec4 getGroundDrawingColor(vec2 coord,sampler2D drawingTexture)\n            {\n                if(coord.x < 0. ||coord.y < 0.||\n                coord.x > 1. ||coord.y > 1.)\n                {\n                    return vec4(0.,0.,0.,0.);\n                }\n                vec4 color = texture2D(drawingTexture, coord);\n                if(color.w > 0. || !multiSample)\n                    return color;\n                \n                float pixelX = viewportSize.x;\n                float pixelY = viewportSize.y;\n\n                vec2 coords[8];\n                coords[0] = vec2((coord.x*pixelX + 1.) / pixelX,(coord.y*pixelY + 1.) / pixelY);\n                coords[1] = vec2((coord.x*pixelX - 1.) / pixelX,(coord.y*pixelY - 1.) / pixelY);\n                coords[2] = vec2((coord.x*pixelX - 1.) / pixelX,(coord.y*pixelY + 1.) / pixelY);\n                coords[3] = vec2((coord.x*pixelX + 1.) / pixelX,(coord.y*pixelY - 1.) / pixelY);\n\n                coords[4] = vec2(coord.x,(coord.y * pixelY + 1.) / pixelY);\n                coords[5] = vec2(coord.x,(coord.y * pixelY - 1.) / pixelY);\n                coords[6] = vec2((coord.x * pixelX - 1.) / pixelX, coord.y);\n                coords[7] = vec2((coord.x * pixelX + 1.) / pixelX, coord.y);\n\n                vec4 _color;\n                #pragma unroll_loop_start\n                for(int i = 0;i < 8;++i){\n                    _color = texture2D(drawingTexture, coords[i]);\n                    if(_color.w > 0.)\n                        break;\n                }\n                #pragma unroll_loop_end\n\n                return _color;\n            }\n        #endif\n    "},r.GrowthAnimationShader={growthAnimation_pars_vertex:"\n      #if defined(CLOUDSTANDARDBATCHEDV3) || defined(CLOUDSTANDARDINSTANCEDV3)\n        attribute vec4 id;\n        varying vec4 vId;\n      #elif defined(GROWTH_ANIMATION)\n        attribute float growthPlaneIndex;\n        flat varying int _growthPlaneIndex;\n        varying vec3 vGrowthClipPosition;\n      #endif\n    ",growthAnimation_vertex:"\n      #if defined(CLOUDSTANDARDINSTANCEDV3)\n        vId = vec4(id.r, id.g, id.b, id.a);\n      #elif defined(CLOUDSTANDARDBATCHEDV3)\n        vId = vec4(id.a, id.b, id.g, id.r);\n      #elif defined(GROWTH_ANIMATION)\n        _growthPlaneIndex = int(growthPlaneIndex);\n      #endif\n    ",growthAnimation_pars_fragment:"\n      #if defined(CLOUDSTANDARDBATCHEDV3) || defined(CLOUDSTANDARDINSTANCEDV3)\n        uniform sampler2D growthAnimationMap;\n        uniform sampler2D growthAnimationPlanes;\n        uniform float growthAnimationMapSizeWidth;\n        uniform float growthAnimationMapSizeHeight;\n        varying vec4 vId;\n          // #if defined GROWTH_ANIMATION\n          //     uniform sampler2D growthAnimationPlanes;\n          //     flat varying int _growthPlaneIndex;\n          // #endif\n      #elif defined(GROWTH_ANIMATION)\n        uniform sampler2D growthAnimationPlanes;\n        flat varying int _growthPlaneIndex;\n      #endif\n    ",growthAnimation_fragment:"\n      // V3版本\n      #if defined(CLOUDSTANDARDBATCHEDV3) || defined(CLOUDSTANDARDINSTANCEDV3)\n        // 通过id attribute计算userIdIndex\n        \n\n        float index = vId.y * 256.0 * 256.0 + vId.z * 256.0 + vId.w * 1.0;\n\n        index = floor(index * 255. + .5);\n        \n        // 从userId纹理图中找到对应的planeIndex\n        float row = floor(index / growthAnimationMapSizeWidth);\n        float col = mod(index, growthAnimationMapSizeWidth);\n        vec4 planeIndexVec = texture2D(growthAnimationMap,\n          vec2(col / (growthAnimationMapSizeWidth - 1.), row / (growthAnimationMapSizeHeight - 1.)));\n        // planeIndex保存在前两位\n        float planeIndex = planeIndexVec.r * 1. + planeIndexVec.g * 256.;\n        planeIndex = floor(planeIndex * 255. + .5);\n\n        // 如果有对应的生长动画,则进行生长动画逻辑\n        if (planeIndex > 0.0) {\n          float realIndex = float(planeIndex - 1.);\n          float planeRow = floor(realIndex / 256.);\n          float planeCol = mod(realIndex, 256.);\n          vec4 growthPlane = texture2D(growthAnimationPlanes, vec2(planeCol / 255., planeRow / 255.));\n          // 进度为0的状态,隐藏整个构件\n          if ((abs(growthPlane.x - .0) < .01)\n           && (abs(growthPlane.y - .0) < .01)\n           && (abs(growthPlane.z - .0) < .01)\n           && (abs(growthPlane.w - .0) < .01)) {\n            discard;\n          }\n\n          if (dot(vViewPosition, growthPlane.xyz) > growthPlane.w + 0.01)\n            discard;\n        }\n      // 其他版本\n      #elif defined(GROWTH_ANIMATION)\n      \n        if(_growthPlaneIndex > 0){\n          float index = float(_growthPlaneIndex - 1);\n          float row = floor(index / 256.);\n          float col = mod(index, 256.);\n          vec4 growthPlane =  texture2D(growthAnimationPlanes, vec2(col / 255.,row / 255.));\n          if ((abs(growthPlane.x - .0) < .01)\n           && (abs(growthPlane.y - .0) < .01)\n           && (abs(growthPlane.z - .0) < .01)\n           && (abs(growthPlane.w - .0) < .01)) {\n            discard;\n          }\n\n          if (dot(vViewPosition, growthPlane.xyz) > growthPlane.w + 0.01)\n            discard;\n        }\n      #endif\n    "},r.TreeTrunkAnimationShader={treeTrunkAnimation_instance_pars_vertex:"\n        #if defined TREE_TRUNK_ANIMATION\n            uniform float runTime;\n            uniform float minZ;\n            uniform float maxZ;\n            uniform float localMinZ;\n            uniform float localMaxZ;\n            uniform float scaleX;\n            uniform float scaleY;\n        #endif\n        ",treeTrunkAnimation_instance_vertex:"\n        #if defined TREE_TRUNK_ANIMATION\n            float vOffset = 0.5 * sin(runTime); // 映射到-0.5~0.5\n            float scaleZ = (maxZ - minZ)/(localMaxZ - localMinZ);\n            float localZ = localMinZ + (transformed.z - minZ)/scaleZ;\n\n            float tmp = 1.0 + localZ * 0.05;\n            float weight = tmp * tmp  - tmp;\n            transformed = vec3(transformed.x + vOffset * weight * scaleX, transformed.y  + vOffset * weight * scaleY, transformed.z);\n        #endif\n        "},r.TreeLeavesAnimationShader={treeLeavesAnimation_instance_pars_vertex:"\n        #if defined TREE_LEAVES_ANIMATION\n            uniform float runTime;\n            uniform float minZ;\n            uniform float maxZ;\n            uniform float localMinZ;\n            uniform float localMaxZ;\n            uniform float scaleX;\n            uniform float scaleY;\n        #endif\n        ",treeLeavesAnimation_instance_vertex:"\n        #if defined TREE_LEAVES_ANIMATION\n            float vOffset = 0.5 * sin(runTime); // 映射到-0.5~0.5\n            float scaleZ = (maxZ - minZ)/(localMaxZ - localMinZ);\n            float localZ = localMinZ + (transformed.z - minZ)/scaleZ;\n\n            float tmp = 1.0 + localZ * 0.05;\n            float weight = tmp * tmp  - tmp;\n            transformed = vec3(transformed.x + vOffset * weight * scaleX, transformed.y  + vOffset * weight * scaleY, transformed.z);\n        #endif\n        "},r.CompressNormalShader={CompressNormal_pars_vertex:"\n        #ifdef CNORMAL\n            attribute vec2 cNormal;\n\n            float signNotZero(float value)\n            {\n                return value >= 0.0 ? 1.0 : -1.0;\n            }\n\n            vec2 signNotZero(vec2 value)\n            {\n                return vec2(signNotZero(value.x), signNotZero(value.y));\n            }\n\n            vec3 octDecode(){\n                vec2 encoded = cNormal;\n                if (encoded.x == 0.0 && encoded.y == 0.0) {\n                    return vec3(0.0, 0.0, 0.0);\n                }\n\n                encoded = encoded / 255.0 * 2.0 - 1.0;\n                vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n                \n                v.xy = mix(\n                    (1.0 - abs(v.yx)) * signNotZero(v.xy),\n                    v.xy,\n                    step(0.0, v.z)\n                );\n                // if (v.z < 0.0)\n                // {\n                //     v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n                // }\n                return normalize(v);\n            }\n        #endif\n    ",CompressNormal_vertex:"\n        #ifdef CNORMAL\n            vertexNormal = octDecode();\n        #endif\n    "},r.CompressColorShader={CompressColor_pars_vertex:"\n        #ifdef CCOLOR\n            attribute uint cColor;\n            varying vec4 ocColor;\n            vec4 decodeColor(){\n                uint ucColor = uint(cColor);\n                float ca = float(ucColor >> 24) / 255.0;\n                uint cri = ucColor << 8;\n                float cr = float(cri >> 24) / 255.0;\n                uint cgi = ucColor << 16;\n                float cg = float(cgi >> 24) / 255.0;\n                uint cgb = ucColor << 24;\n                float cb = float(cgb >> 24) / 255.0;\n                vec4 vcColor = vec4(cr, cg, cb, 1.0);\n                return vcColor;\n            }\n        #endif\n    ",CompressColor_vertex:"\n        #ifdef CCOLOR \n            ocColor = decodeColor();\n        #endif\n    ",CompressColor_pars_fragment:"\n        #ifdef CCOLOR\n            varying vec4 ocColor;\n        #endif\n    ",CompressColor_fragment:"\n        #ifdef CCOLOR \n            diffuseColor = vec4(ocColor.rgb, opacity ) ;\n        #endif\n    "},r.VertexColorFrag={vertex_color_frag:"\n    #if defined( USE_COLOR_ALPHA )\n        diffuseColor = vec4(vColor.bgr, opacity);\n    #elif defined( USE_COLOR )\n        diffuseColor.rgb = vColor.rgb;\n    #endif\n    "},r.HeightLimitShader={heightLimit_pars_vertex:"\n    #ifdef HEIGHT_LIMIT_READ\n        uniform mat4 heightLimitOrthoMatrix;\n        varying vec3 v_HeightLimitOrthoPosition;\n        varying float heightWorld;\n    #endif\n",heightLimit_vertex:"\n    #ifdef HEIGHT_LIMIT_READ\n        vec4 othPostion = heightLimitOrthoMatrix * modelMatrix * vec4( transformed, 1.0 );//???\n        othPostion /= othPostion.w;\n        v_HeightLimitOrthoPosition = othPostion.xyz;\n        heightWorld = (modelMatrix * vec4( transformed, 1.0 )).y;\n    #endif\n",heightLimit_pars_fragment:"\n    #ifdef HEIGHT_LIMIT_READ\n        varying vec3 v_HeightLimitOrthoPosition;\n        uniform sampler2D  heightLimitSampler;\n        uniform sampler2D  heightColorSampler;\n        varying float heightWorld;\n\n        vec2 postProjToScreen(vec2 position)\n        {\n            vec2 screenPos = position;\n            \n            return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n        }\n\n        float decode_float(vec4 v) {\n            vec4 bits = v * 255.0;\n            float sign = mix(-1.0, 1.0, step(bits[3], 128.0));\n            float expo = floor(mod(bits[3] + 0.1, 128.0)) * 2.0 + floor((bits[2] + 0.1) / 128.0) - 127.0;\n            float sig = bits[0] + bits[1] * 256.0 + floor(mod(bits[2] + 0.1, 128.0)) * 256.0 * 256.0;\n            return sign * (1.0 + sig / 8388607.0) * pow(2.0, expo);\n        }\n\n    #endif\n\n    #ifdef HEIGHT_LIMIT_WRITE\n        uniform float heightLimit;\n        uniform bool useHeightLimit;\n\n        #define FLOAT_MAX  1.70141184e38\n        #define FLOAT_MIN  1.17549435e-38\n        lowp vec4 encode_float(highp float v) {\n            highp float av = abs(v);\n        \n            //Handle special cases\n            if(av < FLOAT_MIN) {\n            return vec4(0.0, 0.0, 0.0, 0.0);\n            } else if(v > FLOAT_MAX) {\n            return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n            } else if(v < -FLOAT_MAX) {\n            return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n            }\n        \n            highp vec4 c = vec4(0,0,0,0);\n        \n            //Compute exponent and mantissa\n            highp float e = floor(log2(av));\n            highp float m = av * pow(2.0, -e) - 1.0;\n            \n            //Unpack mantissa\n            c[1] = floor(128.0 * m);\n            m -= c[1] / 128.0;\n            c[2] = floor(32768.0 * m);\n            m -= c[2] / 32768.0;\n            c[3] = floor(8388608.0 * m);\n            \n            //Unpack exponent\n            highp float ebias = e + 127.0;\n            c[0] = floor(ebias / 2.0);\n            ebias -= c[0] * 2.0;\n            c[1] += floor(ebias) * 128.0; \n        \n            //Unpack sign bit\n            c[0] += 128.0 * step(0.0, -v);\n        \n            //Scale back to range\n            return c / 255.0;\n        }\n      #endif\n",heightLimit_fragment:"\n    #ifdef HEIGHT_LIMIT_READ\n        vec2 heightLimitUV = postProjToScreen(v_HeightLimitOrthoPosition.xy);\n        if(heightLimitUV.x >= 0.0 && heightLimitUV.x <= 1.0 && heightLimitUV.y >= 0.0 && heightLimitUV.y <= 1.0)\n        {\n            vec4 color = texture2D(heightColorSampler, heightLimitUV);\n            \n            vec4 heightColor = texture2D(heightLimitSampler, heightLimitUV);\n            float heightLimit0 = decode_float(heightColor);//unpackRGBAToDepth\n            if(color.a > 0.01 &&heightWorld > heightLimit0 && (heightColor != vec4(0.0,0.0,0.0,0.0))) // edge\n            {\n                gl_FragColor = color;//a?\n            }\n        }\n    #endif\n    #ifdef HEIGHT_LIMIT_WRITE\n        if(useHeightLimit){\n            gl_FragColor = encode_float(heightLimit).abgr;//packDepthToRGBA(heightLimit);//(0-1)\n        }\n    #endif   \n\n"},r.WallShader={uniforms:{blendingRatio:{value:0},directionType:{value:0},directionReverse:{value:0},time:{value:0},unitLength:{value:0},repeat:{value:1}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n            #endif\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform float blendingRatio;\n        uniform float directionType;\n        uniform float directionReverse;\n        uniform float time;\n        uniform float unitLength;\n        uniform float repeat;\n        uniform vec3 diffuse;\n        uniform float opacity;\n\n        #include <flat_shaded_pars_fragment>\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n//          #include <map_fragment>\n//          #include <color_fragment>\n//          #include <alphamap_fragment>\n//          #include <alphatest_fragment>\n//          #include <specularmap_fragment>\n//          ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n//          #ifdef USE_LIGHTMAP\n//              reflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n//          #else\n//              reflectedLight.indirectDiffuse += vec3( 1.0 );\n//          #endif\n//          #include <aomap_fragment>\n//          reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n//          vec3 outgoingLight = reflectedLight.indirectDiffuse;\n//          #include <normal_flip>\n//          #include <envmap_fragment>\n//          gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n            vec2 vUvDirection;\n            float uvReverse;\n            \n            if(directionType > 0.0){\n                uvReverse = vUv.y;\n                vUvDirection.y =vUv.x;\n            }else{\n                uvReverse = vUv.x;\n                vUvDirection.y =vUv.y;\n            }\n\n            float _unitLength = 1.0/unitLength;\n            float _orginLength = 0.0;\n\n            uvReverse = mix(\n                1.0 - uvReverse,\n                uvReverse,\n                step(directionReverse, 0.0)\n            );\n            _orginLength = uvReverse;\n\n            float signReverse = mix(\n                1.0,\n                -1.0,\n                step(directionReverse, 0.0)\n            );\n\n            uvReverse = mix(\n                uvReverse/_unitLength + time * unitLength * signReverse,\n                uvReverse/_unitLength + time * signReverse,\n                step(unitLength, 1.0)\n            );\n\n\n            // if(directionReverse>0.0){\n            //     uvReverse = 1.0 - uvReverse;\n            //     _orginLength = uvReverse;\n            //     if(unitLength>1.0){\n            //         uvReverse =uvReverse/_unitLength + time*unitLength;\n            //     }else{\n            //         uvReverse =uvReverse/_unitLength + time;\n            //     }\n            // }else{\n            //     _orginLength = uvReverse;\n            //     if(unitLength>1.0){\n            //         uvReverse =uvReverse/_unitLength - time*unitLength;\n            //     }else{\n            //         uvReverse =uvReverse/_unitLength - time;\n            //     }\n            // }\n\n            vUvDirection.x =fract(uvReverse);\n            //重复场合\n            if(unitLength > 1.0 && repeat<1.0){\n                float _time = time + _unitLength;\n                if(_orginLength < time ||_orginLength>_time){\n                    if(_time>1.0 && _orginLength< fract(_time)){\n                        //闭合场合\n                    }\n                    else{\n                        gl_FragColor = vec4(0.0);\n                        return;\n                    }\n                }\n            }\n            vec4 colorImage;\n\n            //临时解决方案,原因很奇怪,有时候会出现虚线\n            if(vUvDirection.x>0.99) {\n                colorImage = texture2D(map, vec2(0.99,vUvDirection.y));\n            } else if(vUvDirection.x<0.01) {\n                colorImage = texture2D(map, vec2(0.01,vUvDirection.y));\n            }else{\n                colorImage = texture2D(map, vUvDirection);\n            }\n            vec3 diffuseColor = mix(diffuse, colorImage.rgb, blendingRatio);\n\n            gl_FragColor = vec4(diffuseColor, colorImage.a * opacity);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.PlaneScanShader={uniforms:{blendingRatio:{value:0},angle:{value:0},time:{value:0}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n\n            #ifdef USE_ENVMAP\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n            #endif\n            \n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        \n        uniform float blendingRatio;\n        uniform float angle;\n        uniform float time;\n        uniform vec3 diffuse;\n        uniform float opacity;\n\n        #include <flat_shaded_pars_fragment>\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        mat2 rotate(float rad) {\n            float c = cos(rad);\n            float s = sin(rad);\n            return mat2(\n                c, s,\n                -s, c\n            );\n        }\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            vec2 vUvDirection = rotate(-angle) * vec2(vUv.x, vUv.y);\n            vUvDirection.x = fract(vUvDirection.x - time);\n            vUvDirection.y = fract(vUvDirection.y);\n\n            //临时解决方案,原因很奇怪,有时候会出现虚线\n            vec4 colorImage;\n            float _max = 0.99;\n            float _min = 0.01;\n            if(vUvDirection.y>_max && vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_max, _max));\n            } else if(vUvDirection.y>_max && vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, _max));\n            } else if(vUvDirection.y<_min && vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_min, _max));\n            }else if(vUvDirection.y<_min && vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, _min));\n            }else if(vUvDirection.y>_max) {\n                colorImage = texture2D(map, vec2(vUvDirection.x,_max));\n            } else if(vUvDirection.y<_min) {\n                colorImage = texture2D(map, vec2(vUvDirection.x,_min));\n            } else if(vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_max, vUvDirection.y));\n            }else if(vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, vUvDirection.y));\n            } else {\n                colorImage = texture2D(map, vUvDirection);\n            }\n\n            vec3 diffuseColor = mix(diffuse, colorImage.rgb, blendingRatio);\n            gl_FragColor = vec4(diffuseColor, colorImage.a * opacity);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.ViewshedShader={view_shed_pars_vertex:"\n    #ifdef VIEW_SHED_MODE\n        const int MAX_VIEWSHED_COUNT = 4;\n        uniform int viewshedCount;\n        struct ViewshedContent {\n            mat4 viewshedViewProjMatrix;\n            mat4 viewshedViewMatrix;\n            vec4 viewshedVisibleColor;\n            vec4 viewshedHiddenColor;\n            vec2 viewshedMinMax;\n            float viewshedLogDepthBufFC;\n\t\t};\n\n        uniform ViewshedContent viewshedContents[ MAX_VIEWSHED_COUNT ];\n        varying float viewshedFragDepth[MAX_VIEWSHED_COUNT];\n        varying vec3 viewshedWorldPosition;\n    #endif\n",view_shed_pars_fragment:"\n    #ifdef VIEW_SHED_MODE\n        const int MAX_VIEWSHED_COUNT = 4;\n        uniform int viewshedCount;\n        uniform sampler2D viewshedDepthMaps[ MAX_VIEWSHED_COUNT ];\n\n        struct ViewshedContent {\n            mat4 viewshedViewProjMatrix;\n            mat4 viewshedViewMatrix;\n            vec4 viewshedVisibleColor;\n            vec4 viewshedHiddenColor;\n            vec2 viewshedMinMax;\n            float viewshedLogDepthBufFC;\n\t\t};\n\n        uniform ViewshedContent viewshedContents[ MAX_VIEWSHED_COUNT ];\n        varying float viewshedFragDepth[MAX_VIEWSHED_COUNT];\n        varying vec3 viewshedWorldPosition;\n        \n        float toLinearDepth(float fragCoordZ, float near, float far)\n        {\n            float viewZ = perspectiveDepthToViewZ( fragCoordZ, near, far );\n\t\t\treturn viewZToOrthographicDepth( viewZ, near, far );\n        }\n\n        float sampleDepthMap(sampler2D depthMap, vec2 uv){\n            vec4 depthColor = texture2D(depthMap, uv);\n            return unpackRGBAToDepth(depthColor);\n        }\n\n        float viewshedDepthCompare(sampler2D depthMap, vec2 uv, float depth){\n            return step(depth, sampleDepthMap(depthMap, uv));\n        }\n\n        float viewshedVisibility(sampler2D depthMap, vec2 uv, float depth, float depthBias){\n            depth -= depthBias;\n            vec2 texelStepSize = 1.0 / vec2(1024.0, 1024.0);\n            float radius = 1.0;\n            float dx0 = -texelStepSize.x * radius;\n            float dy0 = -texelStepSize.y * radius;\n            float dx1 = texelStepSize.x * radius;\n            float dy1 = texelStepSize.y * radius;\n            float visibility = \n            (\n                viewshedDepthCompare(depthMap, uv, depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(0.0, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, 0.0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, 0.0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, dy1), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(0.0, dy1), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, dy1), depth)\n            ) * (1.0 / 9.0)\n            ;\n            return visibility;\n        }\n    #endif\n",view_shed_vertex:"\n    #ifdef VIEW_SHED_MODE\n        for (int i=0; i<MAX_VIEWSHED_COUNT; i++)\n        {\n            if (i >= viewshedCount) \n            {\n                break;\n            }\n            vec4 viewshedProjPosition = viewshedContents[i].viewshedViewProjMatrix * vec4(vsWorldPosition.xyz, 1.0);\n            float fragDepth = 1.0 + viewshedProjPosition.w;\n            viewshedFragDepth[i] = fragDepth;\n        }\n        viewshedWorldPosition = vsWorldPosition.xyz;\n    #endif\n",view_shed_fragment:"\n    #ifdef VIEW_SHED_MODE\n        vec3 resultColor = gl_FragColor.rgb;\n        #pragma unroll_loop_start\n        for (int i=0; i<4; i++)\n        {\n            if(UNROLLED_LOOP_INDEX < viewshedCount) {\n                vec4 visibleColor = viewshedContents[i].viewshedVisibleColor;\n                vec4 hiddenColor = viewshedContents[i].viewshedHiddenColor;\n                vec4 viewshedViewPosition = viewshedContents[i].viewshedViewMatrix * vec4(viewshedWorldPosition, 1.0);\n                vec4 viewshedClipPosition = viewshedContents[i].viewshedViewProjMatrix * vec4(viewshedWorldPosition, 1.0);\n                viewshedClipPosition = viewshedClipPosition / viewshedClipPosition.w;\n                vec3 viewshedUV = viewshedClipPosition.xyz * 0.5 + 0.5;\n    \n                vec2 minMax = viewshedContents[i].viewshedMinMax;\n                float fragDistance = length(viewshedViewPosition.xyz);\n                if(fragDistance <= minMax.y &&\n                    viewshedUV.x >= 0.0 && viewshedUV.x <= 1.0 &&\n                    viewshedUV.y >=0.0 && viewshedUV.y <= 1.0 &&\n                    viewshedUV.z >=0.0 && viewshedUV.z <= 1.0)\n                {\n                    float fragZ = log2( viewshedFragDepth[i] ) * viewshedContents[i].viewshedLogDepthBufFC * 0.5;\n                    vec4 depthColor = texture2D(viewshedDepthMaps[i], viewshedUV.xy);\n                    float closetDepth = unpackRGBAToDepth(depthColor);\n                    float depthBias = 0.002 + smoothstep(100.0, 1000.0, fragDistance) * 0.058;\n                    \n                    // float visibility = viewshedVisibility(viewshedDepthMaps[i], viewshedUV.xy, fragZ, depthBias); \n                    // if (visibility == 1.0)\n                    if (fragZ - depthBias < closetDepth || closetDepth < depthBias)\n                    {\n                        resultColor = mix(visibleColor.rgb, resultColor, 1.0 - visibleColor.a);\n                    }\n                    else\n                    {\n                        resultColor = mix(hiddenColor.rgb, resultColor, 1.0 - hiddenColor.a);\n                    }\n                }\n            }\n        }\n        #pragma unroll_loop_end\n        gl_FragColor.rgb = resultColor;\n    #endif\n"},r.VideoCastShader={video_cast_pars_vertex:"\n    #ifdef VIDEO_CAST_NUM\n        struct VideoCastContent {\n            mat4 viewProjMatrix;\n            mat4 viewMatrix;\n            float logDepthBufFC;\n\t\t};\n\n        uniform VideoCastContent videoCastContents[ VIDEO_CAST_NUM ];\n        varying float videoCastFragDepth[VIDEO_CAST_NUM];\n        varying vec3 videoCastWorldPosition;\n    #endif\n",video_cast_pars_fragment:"\n    #ifdef VIDEO_CAST_NUM\n        uniform sampler2D videoCastDepthMaps[ VIDEO_CAST_NUM ];\n        uniform sampler2D videoCastProjectorMaps[ VIDEO_CAST_NUM];\n\n        struct VideoCastContent {\n            mat4 viewProjMatrix;\n            mat4 viewMatrix;\n            float logDepthBufFC;\n\t\t};\n\n        uniform VideoCastContent videoCastContents[ VIDEO_CAST_NUM ];\n        varying float videoCastFragDepth[VIDEO_CAST_NUM];\n        varying vec3 videoCastWorldPosition;\n        \n        float toLinearDepth(float fragCoordZ, float near, float far)\n        {\n            float viewZ = perspectiveDepthToViewZ( fragCoordZ, near, far );\n\t\t\treturn viewZToOrthographicDepth( viewZ, near, far );\n        }\n\n        float sampleDepthMap(sampler2D depthMap, vec2 uv){\n            vec4 depthColor = texture2D(depthMap, uv);\n            return unpackRGBAToDepth(depthColor);\n        }\n\n        float videoCastDepthCompare(sampler2D depthMap, vec2 uv, float depth){\n            return step(depth, sampleDepthMap(depthMap, uv));\n        }\n\n        float videoCastVisibility(sampler2D depthMap, vec2 uv, float depth, float depthBias){\n            depth -= depthBias;\n            vec2 texelStepSize = 1.0 / vec2(1024.0, 1024.0);\n            float radius = 1.0;\n            float dx0 = -texelStepSize.x * radius;\n            float dy0 = -texelStepSize.y * radius;\n            float dx1 = texelStepSize.x * radius;\n            float dy1 = texelStepSize.y * radius;\n            float visibility = \n            (\n                videoCastDepthCompare(depthMap, uv, depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(0.0, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, 0.0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, 0.0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, dy1), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(0.0, dy1), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, dy1), depth)\n            ) * (1.0 / 9.0)\n            ;\n            return visibility;\n        }\n    #endif\n",video_cast_vertex:"\n    #ifdef VIDEO_CAST_NUM\n        // BIMFACE-32898: mac上出现错误：Loop index cannot be compared with non-constant expression\n        for (int i = 0; i< VIDEO_CAST_NUM; i++)\n        {\n            vec4 videoCastProjPosition = videoCastContents[i].viewProjMatrix * vec4(vsWorldPosition.xyz, 1.0);\n            float fragDepth = 1.0 + videoCastProjPosition.w;\n            videoCastFragDepth[i] = fragDepth;\n        }\n        videoCastWorldPosition = vsWorldPosition.xyz;\n    #endif\n",video_cast_fragment:"\n    #ifdef VIDEO_CAST_NUM\n        vec3 resultColor = gl_FragColor.rgb;\n        #pragma unroll_loop_start\n        for (int i=0; i<4; i++)\n        {\n            #if(UNROLLED_LOOP_INDEX < VIDEO_CAST_NUM) \n            {\n                vec4 videoCastViewPosition = videoCastContents[i].viewMatrix * vec4(videoCastWorldPosition, 1.0);\n                vec4 videoCastClipPosition = videoCastContents[i].viewProjMatrix * vec4(videoCastWorldPosition, 1.0);\n                videoCastClipPosition = videoCastClipPosition / videoCastClipPosition.w;\n                vec3 videoCastUV = videoCastClipPosition.xyz * 0.5 + 0.5;\n    \n                vec4 textureColor = texture2D(videoCastProjectorMaps[i], videoCastUV.xy);\n            \n                float fragDistance = length(videoCastViewPosition.xyz);\n                if(videoCastUV.x >= 0.0 && videoCastUV.x <= 1.0 &&\n                    videoCastUV.y >=0.0 && videoCastUV.y <= 1.0 &&\n                    videoCastUV.z >=0.0 && videoCastUV.z <= 1.0)\n                {\n                    float fragZ = log2( videoCastFragDepth[i] ) * videoCastContents[i].logDepthBufFC * 0.5;\n                    vec4 depthColor = texture2D(videoCastDepthMaps[i], videoCastUV.xy);\n                    float closetDepth = unpackRGBAToDepth(depthColor);\n                    float depthBias = 0.002 + smoothstep(100.0, 1000.0, fragDistance) * 0.058;\n                    \n                    if (fragZ - depthBias < closetDepth)\n                    {\n                        resultColor = textureColor.rgb;\n                    }\n                }\n            }\n            #endif\n        }\n        #pragma unroll_loop_end\n\n        gl_FragColor.rgb = resultColor;\n    #endif\n"},function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="GroundCurveMaterial",this.cameraNear=.1,this.cameraFar=10,this.pixelRatio=1,this.frustumPlanes=new THREE.Vector4,this.viewport=new THREE.Vector4,this.geometricToleranceOverMeter=1,this.lineWidth=1,this.globeDepthTexture=null,this.customDepthTexture=null,this.cameraProjection=new THREE.Matrix4,this.inverseProjection=new THREE.Matrix4,this.dashMode=0,this.dashSize=16,this.clampMode=0,this.map=null,this.uvTransform=null,this.visibility=1,this.enableColorOverride=!1,this.enableAnimation=!1,this.isTrail=!1,this.widthType=0,this.sceneUnit=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{cameraNear:{value:this.cameraNear},cameraFar:{value:this.cameraFar},pixelRatio:{value:this.pixelRatio},frustumPlanes:{value:this.frustumPlanes.clone()},viewport:{value:this.viewport.clone()},geometricToleranceOverMeter:{value:this.geometricToleranceOverMeter},lineWidth:{value:this.lineWidth},widthType:{value:this.widthType},sceneUnit:{value:this.sceneUnit},globeDepthTexture:{value:this.globeDepthTexture},customDepthTexture:{value:this.customDepthTexture},cameraProjection:{value:this.cameraProjection},inverseProjection:{value:this.inverseProjection},dashMode:{value:this.dashMode},dashSize:{value:this.dashSize},clampMode:{value:this.clampMode},map:{value:this.map},uvTransform:{value:this.uvTransform},visibility:{value:this.visibility},enableColorOverride:{value:this.enableColorOverride},enableAnimation:{value:this.enableAnimation},isTrail:{value:this.isTrail}}]),this.vertexShader=r.GroundCurveShader.vertexShader,this.fragmentShader=r.GroundCurveShader.fragmentShader}refreshUniforms(){this.uniforms.cameraNear.value=this.cameraNear,this.uniforms.cameraFar.value=this.cameraFar,this.uniforms.pixelRatio.value=this.pixelRatio,this.uniforms.frustumPlanes.value.copy(this.frustumPlanes),this.uniforms.viewport.value.copy(this.viewport),this.uniforms.geometricToleranceOverMeter.value=this.geometricToleranceOverMeter,this.uniforms.lineWidth.value=this.lineWidth,this.uniforms.widthType.value=this.widthType,this.uniforms.sceneUnit.value=this.sceneUnit,this.uniforms.globeDepthTexture.value=this.globeDepthTexture,this.uniforms.customDepthTexture.value=this.customDepthTexture,this.uniforms.cameraProjection.value=this.cameraProjection,this.uniforms.inverseProjection.value=this.inverseProjection,this.uniforms.dashMode.value=this.dashMode,this.uniforms.dashSize.value=this.dashSize,this.uniforms.clampMode.value=this.clampMode,this.uniforms.map.value=this.map,this.uniforms.visibility.value=this.visibility,this.uniforms.enableColorOverride.value=this.enableColorOverride,this.uniforms.enableAnimation.value=this.enableAnimation,this.uniforms.isTrail.value=this.isTrail}}r.GroundCurveMaterial=e}(),r.GroundCurveShader={vertexShader:"\n    precision highp float;\n    precision highp int;\n    #include <common>\n    #include <fog_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    const float GLOBE_MINIMUM_ALTITUDE = 6356752.3;\n    const float pi = 3.141592653589793;\n    const float piOverTwo = 1.5707963267948966;\n    attribute vec3 startPosition;\n    attribute vec3 startNormal;\n    attribute vec3 endNormal;\n    attribute vec3 rightNormal;\n    attribute vec3 forwardOffset;\n    attribute vec2 texcoordNormalization;\n\n    attribute vec2 textureUV;\n    varying vec2 vUUv;\n\n    varying vec4 v_startPlaneNormalEcAndHalfWidth;\n    varying vec3 v_endPlaneNormalEc;\n    varying vec4 v_rightPlaneEC;\n    varying vec4 v_endEcAndStartEcX;\n    varying vec4 v_texcoordNormalizationAndStartEcYZ;\n    varying float v_polylineAngle;\n\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform float pixelRatio;\n    uniform vec4 frustumPlanes;\n    uniform vec4 viewport;\n    uniform float geometricToleranceOverMeter;\n    uniform float lineWidth;\n    uniform int widthType;\n    uniform int sceneUnit;\n\n    float planeDistance(vec4 plane, vec3 point) {\n        return (dot(plane.xyz, point) + plane.w);\n    }\n    float planeDistance(vec3 planeNormal, float planeDistance, vec3 point) {\n        return (dot(planeNormal, point) + planeDistance);\n    }\n    float branchFreeTernary(bool comparison, float a, float b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec2 branchFreeTernary(bool comparison, vec2 a, vec2 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec3 branchFreeTernary(bool comparison, vec3 a, vec3 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec4 branchFreeTernary(bool comparison, vec4 a, vec4 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    float metersPerPixel(vec4 positionEC, float pixelRatio) {\n        float width = viewport.z;\n        float height = viewport.w;\n        float pixelWidth;\n        float pixelHeight;\n        float top = frustumPlanes.x;\n        float bottom = frustumPlanes.y;\n        float left = frustumPlanes.z;\n        float right = frustumPlanes.w;\n\n        float distanceToPixel = -positionEC.z;\n        float inverseNear = 1.0 / cameraNear;\n        float tanTheta = top * inverseNear;\n        pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n        tanTheta = right * inverseNear;\n        pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n\n        return max(pixelWidth, pixelHeight) * pixelRatio;\n    }\n    float metersPerPixel(vec4 positionEC) {\n        return metersPerPixel(positionEC, pixelRatio);\n    }\n    float fastApproximateAtan(float x) {\n        return x * (-0.1784 * x - 0.0663 * x * x + 1.0301);\n    }\n    float fastApproximateAtan(float x, float y) {\n        float t = abs(x);\n        float opposite = abs(y);\n        float adjacent = max(t, opposite);\n        opposite = min(t, opposite);\n        t = fastApproximateAtan(opposite / adjacent);\n        t = branchFreeTernary(abs(y) > abs(x), piOverTwo - t, t);\n        t = branchFreeTernary(x < 0.0, pi - t, t);\n        t = branchFreeTernary(y < 0.0, -t, t);\n        return t;\n    }\n\n    void main() {\n        vUUv = textureUV;\n        vec3 ecStart = (viewMatrix * vec4(startPosition, 1.0)).xyz;\n        vec3 offset = normalMatrix * forwardOffset;\n        vec3 ecEnd = ecStart + offset;\n        vec3 forwardDirectionEC = normalize(offset);\n        vec4 startPlaneEC;\n        startPlaneEC.xyz = normalMatrix * startNormal;\n        startPlaneEC.w = -dot(startPlaneEC.xyz, ecStart);\n        vec4 endPlaneEC;\n        endPlaneEC.xyz = normalMatrix * endNormal;\n        endPlaneEC.w = -dot(endPlaneEC.xyz, ecEnd);\n        v_rightPlaneEC.xyz = normalMatrix * rightNormal;\n        v_rightPlaneEC.w = -dot(v_rightPlaneEC.xyz, ecStart);\n        v_texcoordNormalizationAndStartEcYZ.x = abs(texcoordNormalization.x);\n        v_texcoordNormalizationAndStartEcYZ.y = texcoordNormalization.y;\n\n        v_endEcAndStartEcX.xyz = ecEnd;\n        v_endEcAndStartEcX.w = ecStart.x;\n        v_texcoordNormalizationAndStartEcYZ.zw = ecStart.yz;\n\n        vec4 positionEC = viewMatrix * vec4(position, 1.0);\n        float absStartPlaneDistance = abs(planeDistance(startPlaneEC, positionEC.xyz));\n        float absEndPlaneDistance = abs(planeDistance(endPlaneEC, positionEC.xyz));\n        vec3 planeDirection = branchFreeTernary(absStartPlaneDistance < absEndPlaneDistance, startPlaneEC.xyz, endPlaneEC.xyz);\n        vec3 upOrDown = normalize(cross(v_rightPlaneEC.xyz, planeDirection));\n        vec3 normalEC = normalize(cross(planeDirection, upOrDown));    \n        upOrDown = cross(forwardDirectionEC, normalEC);\n        upOrDown = float(v_texcoordNormalizationAndStartEcYZ.y > 1.0 || v_texcoordNormalizationAndStartEcYZ.y < 0.0) * upOrDown;\n        upOrDown = min(GLOBE_MINIMUM_ALTITUDE, geometricToleranceOverMeter * length(positionEC.xyz)) * upOrDown;\n        positionEC.xyz += upOrDown;\n        v_texcoordNormalizationAndStartEcYZ.y = branchFreeTernary(v_texcoordNormalizationAndStartEcYZ.y > 1.0, 0.0, abs(v_texcoordNormalizationAndStartEcYZ.y));\n        float width = lineWidth;\n\n        if(widthType == 1 && sceneUnit == 1) {\n            width = width*0.004;\n        }\n        v_startPlaneNormalEcAndHalfWidth.xyz = startPlaneEC.xyz;\n        v_startPlaneNormalEcAndHalfWidth.w = width * 0.5;\n        v_endPlaneNormalEc = endPlaneEC.xyz;\n        if(widthType == 0) {\n            width = width * max(0.0, metersPerPixel(positionEC));\n            width = width / dot(normalEC, v_rightPlaneEC.xyz);\n        }\n        //width = width * max(0.0, metersPerPixel(positionEC));\n        //width = width / dot(normalEC, v_rightPlaneEC.xyz);\n        normalEC *= sign(texcoordNormalization.x);\n\n        positionEC.xyz += width * normalEC;\n        vec4 mvPosition = positionEC;\n        gl_Position = projectionMatrix * mvPosition;\n\n        vec2 approxLineDirection = normalize(vec2(forwardDirectionEC.x, -forwardDirectionEC.y));\n        approxLineDirection.y = branchFreeTernary(approxLineDirection.x == 0.0 && approxLineDirection.y == 0.0, -1.0, approxLineDirection.y);\n        v_polylineAngle = fastApproximateAtan(approxLineDirection.x, approxLineDirection.y);\n\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <fog_vertex>\n    }\n\n    ",fragmentShader:"\n    precision highp float;\n    precision highp int;\n\n    #include <common>\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n\n    #include <clipping_planes_pars_fragment>\n    #include <packing>\n    #include <depth_parse_fragment>\n\n    const float maskLength = 16.0;\n    uniform vec3 diffuse;\n    uniform float opacity;\n    uniform float pixelRatio;\n    uniform sampler2D globeDepthTexture;\n    uniform sampler2D customDepthTexture;\n    uniform int dashMode;\n    uniform float dashSize;\n    uniform vec4 frustumPlanes;\n    uniform int clampMode;\n\n    #ifdef USE_MAP\n    uniform sampler2D map;\n    uniform mat3 uvTransform;\n#endif\n    uniform float visibility;\n    uniform bool enableColorOverride;\n    uniform bool enableAnimation;\n    uniform bool isTrail;\n\n    uniform int widthType;\n    varying vec2 vUUv;\n    const float uvXOffset = 0.06;\n\n    varying vec4 v_startPlaneNormalEcAndHalfWidth;\n    varying vec3 v_endPlaneNormalEc;\n    varying vec4 v_rightPlaneEC;\n    varying vec4 v_endEcAndStartEcX;\n    varying vec4 v_texcoordNormalizationAndStartEcYZ;\n    varying float v_polylineAngle;\n\n    float metersPerPixel(vec4 positionEC, float pixelRatio) {\n        float width = viewport.z;\n        float height = viewport.w;\n        float pixelWidth;\n        float pixelHeight;\n        float top = frustumPlanes.x;\n        float bottom = frustumPlanes.y;\n        float left = frustumPlanes.z;\n        float right = frustumPlanes.w;\n\n        float distanceToPixel = -positionEC.z;\n        float inverseNear = 1.0 / cameraNear;\n        float tanTheta = top * inverseNear;\n        pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n        tanTheta = right * inverseNear;\n        pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n\n        return max(pixelWidth, pixelHeight) * pixelRatio;\n    }\n    float metersPerPixel(vec4 positionEC) {\n        return metersPerPixel(positionEC, pixelRatio);\n    }\n    float planeDistance(vec4 plane, vec3 point) {\n        return (dot(plane.xyz, point) + plane.w);\n    }\n    float planeDistance(vec3 planeNormal, float planeDistance, vec3 point) {\n        return (dot(planeNormal, point) + planeDistance);\n    }\n    mat2 rotate(float rad) {\n        float c = cos(rad);\n        float s = sin(rad);\n        return mat2(\n        c, s, -s, c\n        );\n    }\n\n    void main() {\n        #include <clipping_planes_fragment>\n        if(isTrail){\n            if(vUUv.y*2.0 > visibility) discard;\n        }\n\n        vec2 uv = gl_FragCoord.xy / viewport.zw;\n        vec4 depthColor = texture2D(globeDepthTexture, uv);\n        float depth = unpackRGBAToDepth(depthColor);\n        if (depth == 0.0) {\n            discard;\n        }\n        vec4 customColor = texture2D(customDepthTexture, uv);\n        float customDepth = unpackRGBAToDepth(customColor);\n        if (clampMode == 0) { //discard external components\n            if (customDepth > 0.6) {\n                discard;\n            }\n        }\n        else if (clampMode == 1) { //only clamp to ground\n            if (customDepth > 0.4) {\n                discard;\n            }\n        } else if (clampMode == 2) { //only clamp to model\n            if (customDepth < 0.3 || customDepth > 0.6) {\n                discard;\n            }\n        }\n        vec3 viewPosition = getViewPosition(depth);\n        vec3 ecStart = vec3(v_endEcAndStartEcX.w, v_texcoordNormalizationAndStartEcYZ.zw);\n        //float halfMaxWidth = v_startPlaneNormalEcAndHalfWidth.w * metersPerPixel(vec4(viewPosition.xyz, 1.0)) ;\n        //float halfMaxWidth = v_startPlaneNormalEcAndHalfWidth.w ;\n        float halfMaxWidth = 0.0;\n        if(widthType == 0) {\n            halfMaxWidth = v_startPlaneNormalEcAndHalfWidth.w * metersPerPixel(vec4(viewPosition.xyz, 1.0));\n        }else{\n            halfMaxWidth = v_startPlaneNormalEcAndHalfWidth.w;\n        }\n        float widthwiseDistance = planeDistance(v_rightPlaneEC, viewPosition.xyz);\n        float distanceFromStart = planeDistance(v_startPlaneNormalEcAndHalfWidth.xyz, -dot(ecStart, v_startPlaneNormalEcAndHalfWidth.xyz), viewPosition.xyz);\n        float distanceFromEnd = planeDistance(v_endPlaneNormalEc.xyz, -dot(v_endEcAndStartEcX.xyz, v_endPlaneNormalEc.xyz), viewPosition.xyz);\n        if (abs(widthwiseDistance) > halfMaxWidth || distanceFromStart < 0.0 || distanceFromEnd < 0.0) {\n            discard;\n        }\n        \n        vec4 diffuseColor = vec4( diffuse, opacity );\n        vec4 fragColor = diffuseColor;\n\n        if (dashMode > 0){\n            vec2 pos = rotate(v_polylineAngle) * gl_FragCoord.xy;\n            float dashPosition = fract(pos.x / (max(1.0, dashSize) * pixelRatio));\n            float maskIndex = floor(dashPosition * maskLength);\n            float maskTest = floor(255.0 / pow(2.0, maskIndex));\n            fragColor = (mod(maskTest, 2.0) < 1.0) ? vec4(1.0, 1.0, 1.0, 0.0) : diffuseColor;\n            if (fragColor.a < 0.005) {\n                discard;\n            }\n        }\n\n        #ifdef USE_MAP\n            vec2 usv = vUUv;\n            usv = ( uvTransform * vec3( usv, 1 ) ).xy;\n            vec2 centerUVPos;\n            if(enableAnimation && !isTrail){\n                centerUVPos = vec2(usv.x + uvXOffset , usv.y*1.0);\n            }else{\n                centerUVPos = vec2(usv.x + uvXOffset , usv.y*2.0);\n            }\n            vec4 textureColor;\n            if(!enableColorOverride){\n                textureColor = texture2D( map,centerUVPos ).rgba;\n            }else{\n                float pAlpha = texture2D( map,centerUVPos ).a;\n                textureColor = fragColor;\n                textureColor.a = pAlpha;\n            }\n            gl_FragColor = textureColor;\n\n        #else\n            #include <logdepthbuf_fragment>\n            gl_FragColor = fragColor;\n            #include <premultiplied_alpha_fragment>\n            #if defined( TONE_MAPPING )\n                gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n            #endif\n            #ifdef USE_FOG\n                #ifdef FOG_EXP2\n                    float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n                #else\n                    float fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n                #endif\n                gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n            #endif\n        #endif\n\n    }\n\n    "},r.GroundPolygonShader={vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n            #endif\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n\t    uniform vec3 diffuse;\n        uniform float opacity;\n\n        #include <flat_shaded_pars_fragment>\n        #include <common>\n        #include <dithering_pars_fragment>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_common_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <cube_uv_reflection_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        #include <packing>\n\n        void main()\n        {\n            //vec2 uv = gl_FragCoord.xy / viewport.zw;\n            #include <clipping_planes_fragment>\n            \n            vec4 diffuseColor = vec4( diffuse, opacity );\n            \n            #include <logdepthbuf_fragment>\n            #include <map_fragment>\n            #include <color_fragment>\n            #include <alphamap_fragment_override>\n            // vec4 depthColor = texture2D(globeDepthTexture, uv);\n            // float depth = unpackRGBAToDepth(depthColor);\n            // if (depth == 0.0) {\n            //     discard;\n            // }\n            // vec4 customColor = texture2D(customDepthTexture, uv);\n            // float customDepth = unpackRGBAToDepth(customColor);\n            // if (clampMode == 0) { //discard external components\n            //     if (customDepth > 0.6) {\n            //         discard;\n            //     }\n            // }\n            // else if (clampMode == 1) { //only clamp to ground\n            //     if (customDepth > 0.4) {\n            //         discard;\n            //     }\n            // } else if (clampMode == 2) { //only clamp to model\n            //     if (customDepth < 0.1 || customDepth > 0.6) {\n            //         discard;\n            //     }\n            // }\n            #include <alphatest_fragment>\n            #include <specularmap_fragment>\n\n            ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n            #ifdef USE_LIGHTMAP\n                vec4 lightMapTexel= texture2D( lightMap, vUv2 );\n                reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n            #else\n                reflectedLight.indirectDiffuse += vec3( 1.0 );\n            #endif\n\n            #include <aomap_fragment>\n            \n            reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n            vec3 outgoingLight = reflectedLight.indirectDiffuse;\n            \n            #include <envmap_fragment>\n            \n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n            \n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n            #include <premultiplied_alpha_fragment>\n            #include <dithering_fragment>\n        }\n    "},r.ShaderPass2=function(e,t){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.textureID=void 0!==t?t:"tDiffuse",e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},r.ShaderPass2.prototype={constructor:r.ShaderPass2,render:function(e,t,i,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}};new THREE.Vector3(0,0,0);(()=>{class e extends THREE.ShaderMaterial{constructor(e){super(),this.type="PhongLightingMaterial",this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.isShaderMaterial=!0,this.map=null,this.defines={},this.backSceneTexture=null,this.viewportSize=new THREE.Vector2(0,0),this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)},backSceneTexture:{value:null},viewportSize:{value:new THREE.Vector2(0,0)}}]),this.vertexShader="\n                varying vec3 vViewPosition;\n                varying vec3 vNormal;\n\n                #include <uv_pars_vertex>\n                #include <common>\n                #include <logdepthbuf_pars_vertex>//log depth buffer\n                #include <shadowmap_pars_vertex>\n\n                void main() {\n                    #include <uv_vertex>\n                    #include <begin_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>//must be after gl_position's computing\n                    #include <beginnormal_vertex>\n                    #include <defaultnormal_vertex>\n\n                    vNormal = normalize( transformedNormal );\n                    vViewPosition = - mvPosition.xyz;\n                }\n           ",this.fragmentShader="\n                uniform vec3 diffuse;\n                uniform float opacity;\n                uniform vec3 specular;\n                uniform float shininess;\n                uniform vec3 emissive;\n                #include <common>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                #include <packing>\n                #include <bsdfs>\n                //r142\n                //#include <normal_pars_fragment>,\n                #include <lights_pars_begin>\n                #include <lights_phong_pars_fragment>\n                #include <specularmap_pars_fragment>\n                #include <shadowmap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n\n                #ifdef USE_CAP\n                    uniform sampler2D backSceneTexture;\n                    uniform vec2 viewportSize;\n                #endif\n                #define DISABLE_HEMI_LIGHT\n                void main() {\n                    #include <logdepthbuf_fragment>\n                    vec4 diffuseColor = vec4( diffuse, opacity );\n\n                    #ifdef USE_MAP\n                        vec4 texelColor = texture2D( map, vUv );\n                        texelColor = mapTexelToLinear( texelColor );\n                        diffuseColor = vec4(texelColor.rgb, opacity);\n                    #endif\n                    #ifdef DISABLE_LIGHT\n                        vec4 unlight_color = diffuseColor;\n                    #endif\n                    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n                    vec3 totalEmissiveRadiance = emissive;\n                    float specularStrength = 1.0;\n\n                    #include <normal_fragment_begin>\n                    #include <normal_fragment_maps>\n                    #include <lights_phong_fragment>\n                    #include <lights_template>\n\n                    vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n                    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n                    #if defined( TONE_MAPPING )\n                        gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n                    #endif\n                    \n                    gl_FragColor = linearToOutputTexel( gl_FragColor );\n                    \n                    #ifdef USE_CAP\n                        vec2 screenUV = vec2(gl_FragCoord.x/viewportSize.x,gl_FragCoord.y/viewportSize.y);\n                        vec4 backColor = texture2D(backSceneTexture, screenUV);\n                        gl_FragColor = texture2D(backSceneTexture, screenUV);\n                    #endif\n                    #ifdef DISABLE_LIGHT\n                        gl_FragColor = unlight_color;\n                    #endif\n                }\n            ",this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhongLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),null!=e.unlight&&(this.unlight=!0,this.unlight?this.defines.DISABLE_LIGHT="":delete this.defines.DISABLE_LIGHT),this.setValues(e)),this.refreshUniforms()}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this.unlight=e.unlight,this}refreshUniforms(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map,this.uniforms.backSceneTexture.value=this.backSceneTexture,this.uniforms.viewportSize.value=this.viewportSize,this.unlight?this.defines.DISABLE_LIGHT="":delete this.defines.DISABLE_LIGHT}setUnLight(e){this.unlight=e,this.unlight?this.defines.DISABLE_LIGHT="":delete this.defines.DISABLE_LIGHT}}r.PhongLightingMaterial=e})();r.LightsTemplateShader="\n    GeometricContext geometry;\n\n    geometry.position = - vViewPosition;\n    geometry.normal = normal;\n    geometry.viewDir = normalize( vViewPosition );\n    \n    IncidentLight directLight;\n    \n    #if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tPointLight pointLight;\n\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)\n\t\t\tPointLightShadow pointLightShadow;\n\t\t#endif\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n    \n    \t\tpointLight = pointLights[ i ];\n    \t\tgetPointLightInfo( pointLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\t\tpointLightShadow = pointLightShadows[ i ];;\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tSpotLight spotLight;\n\n\t    #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n            SpotLightShadow spotLightShadow;\n\t\t#endif\n\t\t\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n    \n    \t\tspotLight = spotLights[ i ];\n    \t\tgetSpotLightInfo( spotLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tspotLightShadow = spotLightShadows[ i ];\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tDirectionalLight directionalLight;\n\t\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\t\t    DirectionalLightShadow directionalLightShadow;\n\t\t#endif\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n    \n    \t\tdirectionalLight = directionalLights[ i ];\n\t\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n    \t\t//r142\n\t\t\t//getDirectionalLightInfo( directionalLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP )  && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n    \n    \tRectAreaLight rectAreaLight;\n    \n    \tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n    \n    \t\trectAreaLight = rectAreaLights[ i ];\n    \t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n    \n    \t}\n    \n    #endif\n    \n    #if defined( RE_IndirectDiffuse )\n    \n    \tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n    \n    \t#ifdef USE_LIGHTMAP\n    \n    \t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n    \n    \t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n    \n    \t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage\n    \n    \t\t#endif\n    \n    \t\tirradiance += lightMapIrradiance;\n    \n    \t#endif\n\t\t#ifndef DISABLE_HEMI_LIGHT\n\t\t\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t\n\t\t\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\n\t\t\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t\n\t\t\t\t}\n\t\t\n\t\t\t#endif\n\t\t#endif\n    \t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n    \n    \t\t// TODO, replace 8 with the real maxMIPLevel\n    \t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );\n    \n    \t#endif\n    \n    \tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n    \n    #endif\n    \n    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\n    \t// TODO, replace 8 with the real maxMIPLevel\n    \tvec3 radiance = getLightProbeIndirectRadiance(  geometry.viewDir, geometry.normal, material.specularRoughness, 8 );\n    \n    \t#ifndef STANDARD\n    \t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );\n    \t#else\n    \t\tvec3 clearCoatRadiance = vec3( 0.0 );\n    \t#endif\n    \n    \tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight );\n    \n    #endif\n    ";r.MapTileShader={vertex:"\n            #define PHONG\n            varying vec3 vViewPosition;\n            #include <flat_shaded_pars_vertex>\n            #include <common>\n            #include <uv_pars_vertex>\n            #include <uv2_pars_vertex>\n            #include <displacementmap_pars_vertex>\n            //#include <envmap_pars_vertex>\n            #include <color_pars_vertex>\n            #include <fog_pars_vertex>\n            #include <morphtarget_pars_vertex>\n            #include <skinning_pars_vertex>\n            #include <shadowmap_pars_vertex>\n            #include <logdepthbuf_pars_vertex>\n\n            #ifdef USE_CLIPPING\n                #include <clipping_planes_pars_vertex>\n            #endif\n\n            uniform mat4 u_CullOrthoMatrix;\n            varying vec3 v_CullOrthoPosition;\n\n            #include <groundDrawing_pars_vertex>\n            void main()\n            {\n                #include <groundDrawing_vertex>\n                vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                othPos /= othPos.w;\n                v_CullOrthoPosition = othPos.xyz;\n\n                #include <uv_vertex>\n                #include <uv2_vertex>\n                #include <color_vertex>\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinbase_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n                #include <flat_shaded_vertex>\n                #include <begin_vertex>\n                #include <displacementmap_vertex>\n                #include <morphtarget_vertex>\n                #include <skinning_vertex>\n\n                #ifdef USE_SKINNING\n                    vec4 wPosition = modelMatrix * skinned;\n                #else\n                    vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n                #endif\n\n                vec4 mvPosition = viewMatrix * wPosition;\n                gl_Position = projectionMatrix * mvPosition;\n\n                #include <logdepthbuf_vertex>\n                vViewPosition = - mvPosition.xyz;\n                #ifdef USE_CLIPPING\n                    #include <clipping_planes_vertex>\n                #endif\n                #include <worldpos_vertex>\n                //#include <envmap_vertex>\n                #include <shadowmap_vertex>\n                #include <fog_vertex>\n            }",fragment:"\n            #define PHONG\n            uniform vec3 diffuse;\n            uniform vec3 emissive;\n            uniform vec3 specular;\n            uniform float shininess;\n            uniform float opacity;\n\n            #include <common>\n            #include <packing>\n            #include <dithering_pars_fragment>\n            #include <color_pars_fragment>\n            #include <uv_pars_fragment>\n            #include <uv2_pars_fragment>\n            #include <map_pars_fragment>\n            #include <alphamap_pars_fragment>\n            #include <aomap_pars_fragment>\n            #include <lightmap_pars_fragment>\n            #include <emissivemap_pars_fragment>\n            //#include <envmap_pars_fragment>\n            //#include <envmap_common_pars_fragment>\n            #include <gradientmap_pars_fragment>\n            #include <fog_pars_fragment>\n            #include <bsdfs>\n            //r142\n            //#include <alphatest_pars_fragment>\n            //#include <normal_pars_fragment>\n            #include <lights_pars_begin>\n            #include <lights_phong_pars_fragment>\n            #include <shadowmap_pars_fragment>\n            #include <bumpmap_pars_fragment>\n            #include <normalmap_pars_fragment>\n            #include <specularmap_pars_fragment>\n            #include <logdepthbuf_pars_fragment>\n            #include <csm_fragment>\n\n            #ifdef USE_CLIPPING\n                #include <clipping_planes_pars_fragment>\n            #endif\n\n            #include <polygonclimpground_pars_fragment_ground>\n\n            uniform float brightness;\n            uniform float contrast;\n            uniform float saturation;\n            uniform float hue;\n            uniform float gamma;\n            uniform vec4 customColor;\n            uniform float useCustomColor;\n            varying vec3 v_CullOrthoPosition;\n            uniform sampler2D  u_SamplerExcavation;\n            \n            #include <groundDrawing_pars_fragment>\n\n            vec2 postProjToScreen(vec2 position)\n            {\n                vec2 screenPos = position;\n                \n                return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n            }\n\n            vec4 depthColor(vec4 color) \n            {\n                color.r = color.r * color.r * color.r;\n                color.g = color.g * color.g * color.g;\n                color.b = color.b * color.b;\n                return color;\n            }\n\n            vec3 computeContrast(vec3 rgb, float contrast) \n            {\n                vec3 color = mix(vec3(0.5), rgb, contrast);\n                color = clamp(color, 0.0, 1.0);\n                return color;\n            }\n\n            vec3 computeHue(vec3 rgb, float adjustment) \n            {\n                const mat3 toYIQ = mat3(0.299, 0.587, 0.114, 0.595716, -0.274453, -0.321263, 0.211456, -0.522591, 0.311135);\n                const mat3 toRGB = mat3(1.0, 0.9563, 0.6210, 1.0, -0.2721, -0.6474, 1.0, -1.107, 1.7046);\n                vec3 yiq = toYIQ * rgb;\n                float hue = atan(yiq.z, yiq.y) + adjustment;\n                float chroma = sqrt(yiq.z * yiq.z + yiq.y * yiq.y);\n                vec3 color = vec3(yiq.x, chroma * cos(hue), chroma * sin(hue));\n                vec3 final = toRGB * color;\n                final = clamp(final, 0.0, 1.0);\n                return final;\n            }\n\n            vec3 computeSaturation(vec3 rgb, float adjustment) \n            {\n                const vec3 W = vec3(0.2125, 0.7154, 0.0721);\n                vec3 intensity = vec3(dot(rgb, W));\n                vec3 color = mix(intensity, rgb, adjustment);\n                color = clamp(color, 0.0, 1.0);\n                return color;\n            }\n\n            vec4 sampleAndBlend(float useCustom, vec4 customColor, vec4 earthColor, float brightness, float contrast, float hue, float saturation, float gamma)\n            {\n                vec4 value = earthColor;\n                if (useCustom == 1.0) {\n                    value = depthColor(value);\n                    value.rgb *= customColor.rgb;\n                }\n                vec3 color = value.rgb;\n                float alpha = value.a;\n                \n                //brightness\n                color = mix(vec3(0.0, 0.0, 0.0), color, brightness);\n                //contrast\n                color = computeContrast(color, contrast);\n                //hue\n                color = computeHue(color, hue);\n                //saturation\n                color = computeSaturation(color, saturation);\n                //gamma\n                color = pow(color, vec3(gamma));\n\n                return vec4(color, alpha);\n            }\n\n            #include <groundDrawing_fragment_getColor>\n\n            void main()\n            {   \n                vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n                if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                {\n                    vec4 color = texture2D(u_SamplerExcavation, uv);\n                    if(color.r > 0.0001)\n                    {\n                        discard;\n                    }\n                } \n                \n                #ifdef USE_CLIPPING\n                    #include <clipping_planes_fragment>\n                #endif\n\n                vec4 diffuseColor = vec4( diffuse, opacity );\n                ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n                vec3 totalEmissiveRadiance = emissive;\n\n                #include <logdepthbuf_fragment>\n                #include <map_fragment>\n                #include <color_fragment>\n                #include <alphamap_fragment>\n                #include <alphatest_fragment>\n                #include <specularmap_fragment>\n                #include <normal_fragment_maps>\n                #include <normal_fragment_begin>\n                #include <emissivemap_fragment>\n                #include <lights_phong_fragment>\n                \n                GeometricContext geometry;\n                geometry.position = - vViewPosition;\n                geometry.normal = normal;\n                geometry.viewDir = normalize( vViewPosition );\n                IncidentLight directLight;\n                #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )  \n                    DirectionalLight directionalLight =  directionalLights[ 0 ];\n                    getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                    //r142\n                    //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                    float shadowFactor = getCSMShadowFactor();\n                    shadowFactor = max(shadowFactor, 0.1);\n                    diffuseColor.rgb = mix(\n                        mix(\n                            diffuseColor.rgb *shadowFactor,\n                            diffuseColor.rgb,\n                            clamp(2.0-(float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                        ),\n                        diffuseColor.rgb,\n                        step(opacity, 0.9)\n                    );\n                #endif\n\n                #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n                    DirectionalLight directionalLight;\n\n                    #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                        DirectionalLightShadow directionalLightShadow;\n                    #endif\n                    \n                    #pragma unroll_loop_start\n                    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                        directionalLight = directionalLights[ i ];\n                        getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                        //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                        #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                        directionalLightShadow = directionalLightShadows[ i ];\n\n                        diffuseColor.rgb = mix(\n                            mix(\n                                diffuseColor.rgb * getShadow( directionalShadowMap[ i - 4 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i - 4 ] ),\n                                diffuseColor.rgb,\n                                clamp(2.0-(float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                            ),\n                            diffuseColor.rgb,\n                            step(opacity, 0.9)\n                        );\n\n\n                        // if(opacity > 0.9)\n                        //     diffuseColor.rgb *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                        #endif\n                    }\n                    #pragma unroll_loop_end\n                #endif\n                \n                vec3 outgoingLight = diffuseColor.rgb;\n                //#include <envmap_fragment>\n                vec4 resultColor = vec4( outgoingLight, diffuseColor.a );\n                \n                #include <groundDrawing_fragment>\n                \n                gl_FragColor = sampleAndBlend(useCustomColor, customColor, resultColor, brightness, contrast, hue, saturation, gamma);\n                \n                #include <tonemapping_fragment>\n                #include <encodings_fragment>\n                #include <fog_fragment>\n                #include <premultiplied_alpha_fragment>\n                #include <dithering_fragment>\n                \n                #ifdef DEMMODEL\n                    #include <polygonclimpground_fragment_ground>\n                #endif\n                //#include <polygonclimpground_fragment>\n            }"},r.ObliquePhotographyShader={vertex:"\n            #define PHONG\n            varying vec3 vViewPosition;\n\n            #include <flat_shaded_pars_vertex>\n            #include <common>\n            #include <uv_pars_vertex>\n            #include <uv2_pars_vertex>\n            #include <displacementmap_pars_vertex>\n            #include <envmap_pars_vertex>\n            #include <color_pars_vertex>\n            #include <fog_pars_vertex>\n            #include <morphtarget_pars_vertex>\n            #include <skinning_pars_vertex>\n            #include <shadowmap_pars_vertex>\n            #include <logdepthbuf_pars_vertex>\n            #include <clipping_planes_pars_vertex>\n            #include <excavation_pars_vertex>\n\n            #include <groundDrawing_pars_vertex>\n\n            void main()\n            {\n                #include <groundDrawing_vertex>\n                #include <uv_vertex>\n                #include <uv2_vertex>\n                #include <color_vertex>\n                #include <beginnormal_vertex>\n                #include <morphnormal_vertex>\n                #include <skinbase_vertex>\n                #include <skinnormal_vertex>\n                #include <defaultnormal_vertex>\n                #include <flat_shaded_vertex>\n                #include <begin_vertex>\n                #include <displacementmap_vertex>\n                #include <morphtarget_vertex>\n                #include <skinning_vertex>\n\n                #ifdef USE_SKINNING\n                    vec4 wPosition = modelMatrix * skinned;\n                #else\n                    vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n                #endif\n\n                vec4 mvPosition = viewMatrix * wPosition;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( transformed, 1.0 );\n        \n                #include <logdepthbuf_vertex>\n                \n                vViewPosition = - mvPosition.xyz;        \n                \n                #include <clipping_planes_vertex>\n                #include <worldpos_vertex>\n                #include <envmap_vertex>\n                #include <shadowmap_vertex>\n                #include <fog_vertex>\n\n                vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n                \n                #include <excavation_vertex>\n            }\n        ",fragment:"\n            #define PHONG\n\n            uniform vec3 diffuse;\n            uniform vec3 emissive;\n            uniform vec3 specular;\n            uniform float shininess;\n            uniform float opacity;\n            \n            #include <common>\n            #include <packing>\n            #include <dithering_pars_fragment>\n            #include <color_pars_fragment>\n            #include <uv_pars_fragment>\n            #include <uv2_pars_fragment>\n            #include <map_pars_fragment>\n            #include <alphamap_pars_fragment>\n            #include <aomap_pars_fragment>\n            #include <lightmap_pars_fragment>\n            #include <emissivemap_pars_fragment>\n            #include <envmap_pars_fragment>\n            #include <gradientmap_pars_fragment>\n            #include <fog_pars_fragment>\n            #include <bsdfs>\n            //r142\n            //#include <alphatest_pars_fragment>\n            //#include <normal_pars_fragment>\n            #include <lights_pars_begin>\n            #include <lights_phong_pars_fragment>\n            #include <shadowmap_pars_fragment>\n            #include <bumpmap_pars_fragment>\n            #include <normalmap_pars_fragment>\n            #include <specularmap_pars_fragment>\n            #include <logdepthbuf_pars_fragment>\n            #include <csm_fragment>\n            #include <clipping_planes_pars_fragment>\n            #include <excavation_pars_fragment>\n            #include <polygonclimpground_pars_fragment>\n\n            uniform float brightness;\n            uniform float contrast;\n            uniform float saturation;\n            uniform float hue;\n            uniform float gamma;\n            uniform vec4 customColor;\n            uniform float useCustomColor;\n\n            #include <groundDrawing_pars_fragment>\n            #include <groundDrawing_fragment_getColor>\n            \n            void main()\n            {   \n                #include <excavation_fragment>      \n                #include <clipping_planes_fragment>\n\n                vec4 diffuseColor = vec4( diffuse, opacity );\n                \n                #include <logdepthbuf_fragment>\n                #ifdef USE_MAP\n                    vec4 texelColor = texture2D( map, vUv );\n                    texelColor = mapTexelToLinear( texelColor );\n                    diffuseColor *= texelColor;\n                    if(diffuseColor.a < 0.4)  discard;\n                #endif\n                #include <color_fragment>\n                #include <alphamap_fragment>\n                #include <alphatest_fragment>\n                #include <specularmap_fragment>\n                #include <normal_fragment_maps>\n                #include <normal_fragment_begin>\n                #include <emissivemap_fragment>\n                #include <lights_phong_fragment>\n                \n                //#include <envmap_fragment>\n\n                vec4 resultColor = diffuseColor;\n                \n                #include <groundDrawing_fragment>\n                \n                gl_FragColor = resultColor;\n                \n                #include <tonemapping_fragment>\n                #include <encodings_fragment>\n                #include <fog_fragment>\n                #include <premultiplied_alpha_fragment>\n                #include <dithering_fragment>\n                #include <polygonclimpground_fragment>\n            }\n        "},r.DepthParseShader={depth_parse_fragment:"\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform mat4 cameraProjection;\n        uniform mat4 inverseProjection;\n        uniform vec4 viewport;\n\n        float getViewZ( const in float depth ) {\n            #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n                float near = cameraNear;\n                float far = cameraFar;\n                float log2Depth = depth * 2.0 / logDepthBufFC;\n                float depthFromCamera = pow(2.0, log2Depth) - 1.0;\n                float a = far * (1.0 - near / depthFromCamera) / (far - near);\n                float viewZ = perspectiveDepthToViewZ( a, cameraNear, cameraFar );\n\n                viewZ = mix(\n                    viewZ,\n                    perspectiveDepthToViewZ( 1.0, cameraNear, cameraFar ),\n                    step(depth, 0.0)\n                ); \n\n                // if (depth == 0.0) // !(depth > 0.0) 深度非负\n                // {\n                //     viewZ = perspectiveDepthToViewZ( 1.0, cameraNear, cameraFar );\n                // }\n            #else\n                float viewZ = perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n            #endif\n            return viewZ;\n        }\n\n        vec3 getViewPosition( const in float depth ) {\n            #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n                float near = cameraNear;\n                float far = cameraFar;\n                float log2Depth = depth * 2.0 / logDepthBufFC;\n                float depthFromCamera = pow(2.0, log2Depth) - 1.0;\n                float x = 2.0 * (gl_FragCoord.x - viewport.x) / viewport.z - 1.0;\n                float y = 2.0 * (gl_FragCoord.y - viewport.y) / viewport.w - 1.0;\n                float z = 2.0 * (depthFromCamera - near) / (far-near) - 1.0;\n                vec4 viewPosition = vec4(x, y, z, 1.0);\n                viewPosition *= depthFromCamera;\n                viewPosition = inverseProjection * viewPosition;\n            #else\n                float viewZ = getViewZ(depth);\n                float clipW = cameraProjection[2][3] * viewZ + cameraProjection[3][3];\n                vec4 clipPosition = vec4( ( vec3( gl_FragCoord.xy / viewport.zw, depth ) - 0.5 ) * 2.0, 1.0 );\n                clipPosition *= clipW; //unprojection\n                vec4 viewPosition = inverseProjection * clipPosition;\n            #endif\n\n            return viewPosition.xyz;\n        }\n\n        vec3 getViewOriginPosition( const in float depth ) {\n            float viewZ = getViewZ(depth);\n            float clipW = cameraProjection[2][3] * viewZ + cameraProjection[3][3];\n            vec4 clipPosition = vec4( ( vec3( gl_FragCoord.xy / viewport.zw, depth ) - 0.5 ) * 2.0, 1.0 );\n            clipPosition *= clipW; //unprojection\n            vec4 viewPosition = inverseProjection * clipPosition;\n            return viewPosition.xyz;\n        }\n    "},r.PointsShader={vertex:"\n        #ifdef USE_ATTRIBUTE_SIZE\n            attribute float attrSize;\n        #endif\n        uniform float size;\n        uniform float scale;\n        #include <common>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <color_vertex>\n            #include <begin_vertex>\n            #include <project_vertex>\n            #ifdef USE_ATTRIBUTE_SIZE\n                gl_PointSize = attrSize;\n            #else\n                #ifdef USE_SIZEATTENUATION\n                    gl_PointSize = size * ( scale / - mvPosition.z );\n                #else\n                    gl_PointSize = size;\n                #endif\n            #endif\n            #ifdef USE_POSITION_OFFSET\n                float yPos = gl_Position.y;\n                float w = gl_Position.w;\n                yPos /= w;\n                yPos += 0.5 * gl_PointSize / scale;\n                yPos *= w;\n                gl_Position.y = yPos;\n            #endif\n            #include <logdepthbuf_vertex>\n            #include <clipping_planes_vertex>\n            #include <worldpos_vertex>\n            #include <fog_vertex>\n        }",fragment:"\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #include <common>\n        #include <packing>\n        //r142\n        //#include <alphatest_pars_fragment>\n        #include <color_pars_fragment>\n        #include <map_particle_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <shadowmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <clipping_planes_fragment>\n            vec3 outgoingLight = vec3( 0.0 );\n            vec4 diffuseColor = vec4( diffuse, opacity );\n            #include <logdepthbuf_fragment>\n            #include <map_particle_fragment>\n            #include <color_fragment>\n            #include <alphatest_fragment>\n            outgoingLight = diffuseColor.rgb;\n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }"},r.ExcavationShader={excavation_pars_vertex:"\n    #ifdef EXCAVATION_MODE\n        uniform mat4 u_CullOrthoMatrix;\n        varying vec3 v_CullOrthoPosition;\n    #endif\n",excavation_pars_fragment:"\n    #ifdef EXCAVATION_MODE\n        varying vec3 v_CullOrthoPosition;\n        uniform sampler2D u_SamplerExcavation;\n        \n        vec2 postProjToScreen(vec2 position)\n        {\n            vec2 screenPos = position;\n            \n            return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n        }\n    #endif\n",excavation_vertex:"\n    #ifdef EXCAVATION_MODE\n        vec4 othPos = u_CullOrthoMatrix *  vec4(vsWorldPosition.xyz, 1.0);\n        othPos /= othPos.w;\n        v_CullOrthoPosition = othPos.xyz;\n    #endif\n",excavation_fragment:"\n    #ifdef EXCAVATION_MODE\n        vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n        if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n        {\n            vec4 color = texture2D(u_SamplerExcavation, uv);\n            if(color.r > 0.0001)\n            {\n                discard;\n            }\n        } \n    #endif\n"},r.PolygonClimpGroundShader={polygonclimpground_pars_vertex:"\n\n",polygonclimpground_vertex:"\n\n",polygonclimpground_pars_fragment:"\n    #ifdef CLIMPGROUND_MODE\n      \n        uniform sampler2D u_matchTexture;\n        uniform sampler2D u_polygonsColorTexture;\n        uniform sampler2D u_onlyClimpColorTexture;\n\n        uniform float u_width;\n        uniform float u_height;\n        uniform int   u_climpMode;\n\n        uniform mat4  u_matchMat;\n        uniform vec4  u_fragColor;\n\n    #endif\n",polygonclimpground_fragment:"\n    #ifdef CLIMPGROUND_MODE\n\n        vec4 outColor = gl_FragColor;\n        vec2 pviewport = vec2(u_width,u_height);\n        vec2 screenuv = gl_FragCoord.xy / pviewport.xy;\n\n        vec4 mmcolor = texture2D(u_matchTexture, screenuv);\n        vec4 polygonscolor = texture2D(u_polygonsColorTexture, screenuv);\n\n        if( mmcolor.r>0.98 ) \n        {\n            if(mmcolor.g<0.001) \n            {\n                gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                gl_FragColor.a = outColor.a;\n            }\n            else\n            {\n                bool hasValue = false;\n                for(int i =0 ;i<4;i++) {\n                    for(int j =0 ;j<4;j++) {\n                        float matElementValue = u_matchMat[i][j];\n                        if(matElementValue > 0.0) {\n                            if(abs(matElementValue - mmcolor.g)<0.002) {\n                                hasValue = true;\n                                break;\n                            }\n                        }\n                    }\n                }\n                if(hasValue)\n                {\n                    gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                    gl_FragColor.a = outColor.a;\n                }\n                else\n                {\n                    gl_FragColor = outColor;\n                }\n\n                #ifdef DEMMODEL\n                    gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                    gl_FragColor.a = outColor.a;\n                #endif\n            }\n        }\n        else\n        {\n            if(u_climpMode == 1) \n            {\n                if( mmcolor.r>0.5 && mmcolor.r<0.7) \n                {\n                   \n                    vec4 climpGroundcolor = texture2D(u_onlyClimpColorTexture, screenuv);\n                    gl_FragColor = mix(vec4(climpGroundcolor.r, climpGroundcolor.g , climpGroundcolor.b , climpGroundcolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-climpGroundcolor.a));\n                    gl_FragColor.a = outColor.a;\n                }\n            }\n            else if(u_climpMode == 2) \n            {\n                if( mmcolor.r>0.2 && mmcolor.r<0.4) \n                {\n                    if(mmcolor.g<0.001)\n                    {\n                        gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                        vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                        gl_FragColor.a = outColor.a;\n                    }\n                    else\n                    {\n                        bool hasValue = false;\n                        for(int i =0 ;i<4;i++) {\n                            for(int j =0 ;j<4;j++){\n                                float matElementValue = u_matchMat[i][j];\n                                if(matElementValue > 0.0) {\n                                    if(abs(matElementValue - mmcolor.g)<0.002) {\n                                        hasValue = true;\n                                        break;\n                                    }\n                                }\n                            }\n                        }\n\n                        if(hasValue)\n                        {\n                            gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                            vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                            gl_FragColor.a = outColor.a;\n                        }\n                        else\n                        {\n                            gl_FragColor = outColor;\n                        }\n\n                    }\n                }\n            }\n        }\n    #endif\n",polygonclimpground_pars_fragment_ground:"\n    uniform sampler2D u_matchTexture;\n    uniform sampler2D u_polygonsColorTexture;\n    uniform sampler2D u_onlyClimpColorTexture;\n\n    uniform float u_width;\n    uniform float u_height;\n    uniform int   u_climpMode;\n\n    uniform mat4  u_matchMat;\n    uniform vec4  u_fragColor;\n",polygonclimpground_fragment_ground:"\n\n    if(u_climpMode == 1){\n\n        vec4 outColor = gl_FragColor;\n        vec2 pviewport = vec2(u_width,u_height);\n        vec2 screenuv = gl_FragCoord.xy / pviewport.xy;\n    \n        vec4 mmcolor = texture2D(u_matchTexture, screenuv);\n        vec4 polygonscolor = texture2D(u_polygonsColorTexture, screenuv);\n    \n        if( mmcolor.r>0.98 ) \n        {\n            if(mmcolor.g<0.001)\n            {\n                gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                gl_FragColor.a = outColor.a;\n                //gl_FragColor = vec4(1.0,0,0,1.0);\n       \n            }\n            else\n            {\n                bool hasValue = false;\n                for(int i =0 ;i<4;i++) {\n                    for(int j =0 ;j<4;j++) {\n                        float matElementValue = u_matchMat[i][j];\n                        if(matElementValue > 0.0) {\n                            if(abs(matElementValue - mmcolor.g)<0.002) {\n                                hasValue = true;\n                                break;\n                            }\n                        }\n                    }\n                }\n                if(hasValue)\n                {\n     \n                    gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                    gl_FragColor.a = outColor.a;\n\n                }\n                else\n                {\n                    gl_FragColor = outColor;\n                }\n    \n                #ifdef DEMMODEL\n                    gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                    gl_FragColor.a = outColor.a;\n                #endif\n            }\n        }\n        else\n        {\n            if(u_climpMode == 1) \n            {\n                if( mmcolor.r>0.5 && mmcolor.r<0.7) \n                {\n           \n                    vec4 climpGroundcolor = texture2D(u_onlyClimpColorTexture, screenuv);\n                    gl_FragColor = mix(vec4(climpGroundcolor.r, climpGroundcolor.g , climpGroundcolor.b , climpGroundcolor.a ), \n                    vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-climpGroundcolor.a));\n                    gl_FragColor.a = outColor.a;\n       \n                }\n            }\n            else if(u_climpMode == 2) \n            {\n                if( mmcolor.r>0.2 && mmcolor.r<0.4) \n                {\n                    if(mmcolor.g<0.001)\n                    {\n                \n                        gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                        vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                        gl_FragColor.a = outColor.a;\n         \n                    }\n                    else\n                    {\n                        bool hasValue = false;\n                        for(int i =0 ;i<4;i++) {\n                            for(int j =0 ;j<4;j++){\n                                float matElementValue = u_matchMat[i][j];\n                                if(matElementValue > 0.0) {\n                                    if(abs(matElementValue - mmcolor.g)<0.002) {\n                                        hasValue = true;\n                                        break;\n                                    }\n                                }\n                            }\n                        }\n    \n                        if(hasValue)\n                        {\n                           \n                            gl_FragColor = mix(vec4(polygonscolor.r, polygonscolor.g , polygonscolor.b , polygonscolor.a ), \n                            vec4(outColor.r, outColor.g, outColor.b ,outColor.a),(1.0-polygonscolor.a));\n                            gl_FragColor.a = outColor.a;\n               \n                        }\n                        else\n                        {\n                            gl_FragColor = outColor;\n                        }\n                    }\n                }\n            }\n        }\n\n\n    }\n\n\n"},r.CommonShader={
//! IBLShaders  CloudStandardShader  CloudStandardShaderV3 CloudStandardInstanceShaderV3
inverse_matrix_pars_vertex_quantization:"\n    #ifdef MESHOPTQUANTIZATION\n      uniform mat3 quantizationNormalMatrix;\n    #endif\n  ",defaultnormal_vertex_quantization:"\n    vec3 transformedNormal = objectNormal;\n    #ifdef USE_INSTANCING\n      mat3 m = mat3( instanceMatrix );\n      transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n      transformedNormal = m * transformedNormal;\n    #endif\n\n    #ifdef MESHOPTQUANTIZATION\n      transformedNormal = normalMatrix * quantizationNormalMatrix * transformedNormal;\n    #else\n      transformedNormal = normalMatrix * transformedNormal;\n    #endif\n\n    #ifdef FLIP_SIDED\n      transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n      vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n      #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n      #endif\n    #endif\n  ",defaultnormal_instance_vertex_quantization:"\n    vec3 transformedNormal = objectNormal;\n\n  #ifdef USE_INSTANCING\n    mat3 m = mat3( instanceMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n  #endif\n \n  mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n  #ifdef SUPPORT_INSTANCE_MIRROR\n    bool mirror = isMirror_mat3(normalMat);\n  #endif\n\n  normalMat = inverse_mat3(normalMat);\n  normalMat = transpose_mat3(normalMat);\n  normalMat = normalMatrix * normalMat;\n\n  #ifdef MESHOPTQUANTIZATION    \n    normalMat = normalMat * quantizationNormalMatrix; \n  #endif\n  \n  transformedNormal = normalMat * transformedNormal;\n\n  #ifdef SUPPORT_INSTANCE_MIRROR\n    if(mirror) {\n        transformedNormal = - transformedNormal;\n    }\n  #endif\n\n  #ifdef FLIP_SIDED\n    transformedNormal = - transformedNormal;\n  #endif\n\n    transformedNormal = normalize( transformedNormal );\n\n  #ifdef USE_TANGENT\n    vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n    #ifdef FLIP_SIDED\n      transformedTangent = - transformedTangent;\n    #endif\n  #endif\n  ",getnormalmatrix_instance_vertex_quantization:"\n    // mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n    normalMat = inverse_mat3(normalMat);\n    normalMat = transpose_mat3(normalMat);\n    normalMat = normalMatrix * normalMat;\n\n  #ifdef MESHOPTQUANTIZATION\n    normalMat = normalMat * quantizationNormalMatrix; \n  #endif\n  ",matrix_transform_pars_vertex:"\n    mat3 inverse_mat3(in mat3 m) {\n       float determinant =\n            m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2]) -\n            m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2]) +\n            m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n\n        mat3 inverse;\n        inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);\n        inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);\n        inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);\n        inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);\n        inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);\n        inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);\n        inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n        inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);\n        inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);\n        inverse /= determinant;\n        return inverse;\n    }\n\n    mat3 transpose_mat3( const in mat3 v ) {\n      mat3 tmp;\n      tmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n      tmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n      tmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n      return tmp;\n    }\n\n    bool isMirror_mat3(in mat3 m) {\n      vec3 vx = m[0];\n      vec3 vy = m[1];\n      vec3 vz = m[2];\n      vec3 vc = cross(vx, vy);\n      float d = dot(vc, vz);\n      return d < 0.0 ? true : false;\n    }\n\n  ",get_instance_position_pars_vertex:"\n        vec3 getInstancePosition(vec3 position) {\n            return vec3(mat4(\n                vec4(mcol0, 0.0),\n                vec4(mcol1, 0.0),\n                vec4(mcol2, 0.0),\n                vec4(mcol3, 1.0)) * vec4(position, 1.0));\n        }\n    ",
//! IBLShader IBLShader_Transform_pars_vertex CloudStandardShader_Transform_pars_vertex
Transform_pars_vertex:"\n        transformed = vec3(\n            mat4(vec4(mcol0, 0.0),\n                 vec4(mcol1, 0.0),\n                 vec4(mcol2, 0.0),\n                 vec4(mcol3, 1.0)\n            ) * vec4(transformed, 1.0));\n    ",
//! IBLShader
IBLShader_Transform_pars_vertex:"\n        #ifdef USE_INSTANCE\n            vaColor = aColor;\n            fClipping = vClipping;\n            componentState = vState.x;\n            #include <Transform_pars_vertex>\n            #ifdef USE_INSTANCE_NORMAL\n                mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n                #ifdef SUPPORT_INSTANCE_MIRROR\n                bool mirror = isMirror_mat3(normalMat);\n                #endif\n\n                normalMat =inverse_mat3(normalMat);\n                normalMat = transposeMat3(normalMat);\n                objectNormal = normalMat * vertexNormal;\n                transformedNormal = normalMatrix * vertexNormal;\n\n                #ifdef SUPPORT_INSTANCE_MIRROR\n                if(mirror){\n                  transformedNormal = - transformedNormal;\n                  objectNormal = -objectNormal;\n                }\n                #endif\n                \n                #ifdef FLIP_SIDED\n                    transformedNormal = - transformedNormal;\n                    objectNormal = -objectNormal;\n                #endif\n                transformedNormal = normalize( transformedNormal );\n            #endif\n            mvNormal = transformedNormal;//\n            Normal = normalize(mat3(modelMatrix) * objectNormal);\n            Pos = vec3(modelMatrix * vec4(transformed, 1.0));\n        #endif\n\n        #include <CompressColor_vertex>\n        \n    ",
//! CloudStandardShaderV3  CloudStandardShader
CloudStandardShader_Transform_pars_vertex:"\n        vec3 transformed = vec3( position );\n\n        #ifdef USE_INSTANCE\n            vaColor = aColor;\n            #include <num_clipping_planes_vertex>\n            #if defined(USE_MULTI_BLINK_COLOR) \n                vbColor = bColor;\n            #endif\n            componentState = vState.x;\n            #include <Transform_pars_vertex>\n            #include <cloudstandard_instance_normal_vertex>\n\n        #endif\n\n        #include <CompressColor_vertex>\n\n        #include <flat_shaded_vertex>\n    ",
//! IBLShader CloudStandardShader CloudStandardShaderV3 CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3
hdrDecode_pars_Fragment:"\n    vec3 hdrDecode(in vec4 rgbm) {\n        const float rgbmScale = 2.82842712; // sqrt(8)\n        vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));\n        return r * r;\n    }\n    ",
//! toneMap_pars IBLShader CloudStandardShader CloudStandardShaderV3 CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3
toneMapCanonFilmic_pars_Fragment:"\n    vec3 toneMapCanonFilmic(vec3 color)\n    {\n        color *= (1.0 / shift);\n        return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);\n    }\n ",
//! IBLShader CloudStandardShader CloudStandardShaderV3 CloudStandardInstanceShaderV3(repeated) CloudStandardBatchedShaderV3(repeated)
USE_LIGHTMAP_pars_Fragment:"\n\n   #ifdef USE_COMPONENT_LIGHTMAP\n       vec3 lightMapIrradiance = (texture2D(lightMap, vUv2)).rgb * lightMapIntensity;\n   #else\n       vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;\n   #endif\n",
//! IBLShader CloudStandardShader
USE_INSTANCE_pars_Vertex:"\n    #ifdef USE_INSTANCE\n        attribute vec4 vState;\n        attribute float vClipping;\n        varying float fClipping;\n        varying float componentState;\n        attribute vec4 aColor;\n        varying vec4 vaColor;\n        attribute vec3 mcol0;\n        attribute vec3 mcol1;\n        attribute vec3 mcol2;\n        attribute vec3 mcol3;\n        #if defined(USE_MAP)||defined(USE_BUMPMAP) \n            attribute vec4 muvCol0;\n            attribute vec2 muvCol1;\n            //    attribute vec2 muvCol2;\n        #endif\n        #if defined(USE_LIGHTMAP)\n            attribute vec4 uv2OffsetRepeat;\n        #endif\n    #endif\n    ",
//! IBLUniform_pars_Fragment
varying_pars:"\n    varying vec2 vUv;\n    varying vec3 Normal;\n    varying vec3 Pos;\n    varying vec3 mvPosition;\n    varying vec3 mvNormal;",
//! IBLUniform_pars_Fragment
clipping_pars:"\n    #if NUM_CLIPPING_PLANES > 0\n        uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];\n    #endif",
//! IBLUniform_pars_Fragment
maos_pars:"\n    #ifdef USE_MAP\n        uniform sampler2D map;\n    #endif\n\n    #ifdef USE_NORMALMAP\n        uniform sampler2D normalMap;\n        uniform vec2 normalScale;\n        vec3 perturbNormal2Arb(vec3 pos, vec3 normal)\n        {\n            vec3 q0 = vec3(dFdx(pos.x), dFdx(pos.y), dFdx(pos.z));\n            vec3 q1 = vec3(dFdy(pos.x), dFdy(pos.y), dFdy(pos.z));\n            vec2 st0 = dFdx(vUv.st);\n            vec2 st1 = dFdy(vUv.st);\n            vec3 S = normalize(q0 * st1.t - q1 * st0.t);\n            vec3 T = normalize(-q0 * st1.s + q1 * st0.s);\n            vec3 N = normalize(normal);\n            vec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;\n            mapN.xy = normalScale * mapN.xy;\n            mat3 tsn = mat3(S, T, N);\n            return normalize(tsn * mapN);\n        }\n    #endif\n\n    #ifdef USE_ROUGHNESSMAP\n        uniform sampler2D roughnessMap;\n    #endif\n\n    #ifdef USE_METALNESSMAP\n        uniform sampler2D metalnessMap;\n    #endif\n\n    #ifdef USE_AOMAP\n        uniform sampler2D aoMap;\n        uniform float aoMapIntensity;\n    #endif\n",
//! IBLUniform_pars_Fragment
iblMaps_pars:"\n    uniform samplerCube irradianceMap;\n    uniform samplerCube prefilterMap;\n    uniform sampler2D brdfMap;\n",
//! IBLUniform_pars_Fragment
lighting_pars:"\n    #include <packing>\n    #include <common>\n    #include <shadowmap_pars_fragment>\n    #include <lights_pars_begin>\n\n    float punctualLightIntensityToIrradianceFactor(const in float lightDistance, const in float cutoffDistance, const in float decayExponent)\n    {\n\n        return mix(\n            1.0 / max(pow(abs(lightDistance), decayExponent), 0.01) * pow(abs(clamp(1.0 - pow(abs(lightDistance / cutoffDistance), 4.0), 0.0, 1.0)), 2.0),\n            1.0 / max(pow(abs(lightDistance), 2.0), 0.01),\n            step(decayExponent, 0.0)\n        );\n        if(decayExponent > 0.0)\n        {\n            float distanceFalloff = 1.0 / max(pow(abs(lightDistance), decayExponent), 0.01);\n            float maxDistanceCutoffFactor = pow(abs(clamp(1.0 - pow(abs(lightDistance / cutoffDistance), 4.0), 0.0, 1.0)), 2.0);\n            return distanceFalloff * maxDistanceCutoffFactor;\n        }\n\n        float distanceFalloff = 1.0 / max(pow(abs(lightDistance), 2.0), 0.01);\n        return distanceFalloff;\n    }\n",
//! IBLUniform_pars_Fragment
toneMap_pars:"\n    uniform float shift;\n    uniform float A;\n    uniform float B;\n    uniform float C;\n    uniform float D;\n    uniform float E;\n    uniform float F;\n    uniform float scale;\n    #include <toneMapCanonFilmic_pars_Fragment>\n",
//! IBLShaders
IBLUniform_pars_Fragment:"\n    #include <varying_pars>\n    #include <clipping_pars>\n    uniform bool IBLEnabled;\n    uniform int debug;\n    uniform float gamma;\n\n    uniform vec3 albedo;\n    uniform float metalness;\n    uniform float roughness;\n    uniform float opacity;\n    uniform float iblFactor;\n\n    uniform vec4 blinkColor;\n    uniform float blinkCoefficient;\n    uniform float colorState;\n    uniform vec3 tintColor;\n    #include <maos_pars>\n    #include <iblMaps_pars>\n    #include <lighting_pars>\n    #include <toneMap_pars>\n",
//! IBLShaders
IBLEnable_pars_fragment:"\n    if (IBLEnabled)\n    {\n        vec3 Fr = F_SchlickRoughness(max(dot(N, V), 0.0), F0, roughnessFactor);\n\n        vec3 kS = Fr;\n        vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n        vec3 irradiance = textureCube(irradianceMap, N, 0.0).rgb;\n\n        vec3 diffuse = irradiance * baseColor;\n\n        const float MAX_REFLECTION_LOD = 1.0;\n        vec3 prefilteredColor = textureCube(prefilterMap, R, roughnessFactor * MAX_REFLECTION_LOD).rgb;\n\n        vec2 brdf = texture2D(brdfMap, vec2(max(dot(N, V), 0.0), roughnessFactor)).rg;\n        vec3 specular = prefilteredColor* (Fr* brdf.x + brdf.y)*iblFactor;\n\n        vec3 color = (kD * diffuse + specular + totalLightColor) * aoFactor;\n        color = postProcessing(color, true);\n\n        if (debug == 1 || useBaseColor) \n        {\n            baseColor = postProcessing(baseColor, false);\n            gl_FragColor = vec4(baseColor, realOpacity);\n        }\n        else if (debug == 2)\n        {\n            irradiance = postProcessing(irradiance, true);\n            gl_FragColor = vec4(irradiance, realOpacity);\n        }\n        else if (debug == 3)\n        {\n            prefilteredColor = postProcessing(prefilteredColor, true);\n            gl_FragColor = vec4(prefilteredColor, realOpacity);\n        }\n        else if (debug == 4)\n        {\n            diffuse = postProcessing(diffuse, true);\n            gl_FragColor = vec4(diffuse, realOpacity);\n        }\n        else if (debug == 5)\n        {\n            specular = postProcessing(specular, true);\n            gl_FragColor = vec4(specular, realOpacity);\n        }\n        else if (debug == 6)\n        {\n            gl_FragColor = vec4(brdf, 0.0, realOpacity);\n        }\n        else if (debug == 7)\n        {\n            gl_FragColor = vec4(normal, realOpacity);\n        }\n        else\n        {\n        if(iblFactor > 1.0 && realOpacity < 0.6) realOpacity = 0.6;\n            gl_FragColor = vec4(color, realOpacity);\n        }\n    }\n    else\n    {\n        totalLightColor = postProcessing(totalLightColor, true);\n        gl_FragColor = vec4(totalLightColor, realOpacity);\n    }\n",
//! IBLShaders ClippingPlanesShader
NUM_CLIPPING_PLANES_fragment:"\n    #if NUM_CLIPPING_PLANES > 0\n\n        vec4 plane;\n\n        #pragma unroll_loop_start\n        for (int i = 0; i < UNION_CLIPPING_PLANES; i++)\n        {\n            plane = clippingPlanes[ i ];\n            if (dot(vViewPosition, plane.xyz) > plane.w) discard;\n        }\n        #pragma unroll_loop_end\n            \n        #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\n            bool clipped = true;\n            #pragma unroll_loop_start\n            for (int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i++)\n            {\n                plane = clippingPlanes[ i ];\n                clipped = (dot(vViewPosition, plane.xyz) > plane.w) && clipped;\n            }\n            #pragma unroll_loop_end\n\n            if (clipped) discard;\n        \n        #endif\n    #endif\n",
//! IBLShdaers
baseColor_pars_fragment:"\n    vec3 baseColor = pow(diffuseColor.rgb, vec3(gamma));\n    #ifdef CCOLOR\n        baseColor = pow(ocColor.rgb, vec3(gamma));\n    #endif\n\n    float realOpacity = opacity;\n    #ifdef USE_INSTANCE\n        if (floatEqual(componentState, ElementState_HIDDEN)) \n            discard;\n        \n        baseColor = mix(baseColor, pow(vaColor.rgb, vec3(gamma)), step(0.01, abs(componentState - ElementState_NONE)));\n        realOpacity = mix(realOpacity, vaColor.a, step(0.01, abs(componentState - ElementState_NONE)));\n        \n        // if (!floatEqual(componentState, ElementState_NONE)){\n        //     baseColor =  pow(vaColor.rgb, vec3(gamma));\n        //     realOpacity = vaColor.a; }\n    #endif\n\n    vec3 keepColor = baseColor;\n    #ifdef USE_MAP\n        vec4 texelColor = texture2D(map, vUv);\n        baseColor = pow(texelColor.rgb, vec3(gamma));\n        #ifdef USE_CLAMP_TO_BORDER\n            baseColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ? keepColor : baseColor;\n        #endif\n\n        // BIMFACE-31308: 需要和非IBL保持一致\n        baseColor = mix(keepColor.rgb, texelColor.rgb, texelColor.a);\n        realOpacity = min(realOpacity, texelColor.a);\n\n        #ifdef USE_INSTANCE\n            realOpacity = mix(realOpacity, vaColor.a, step(0.01, abs(componentState - ElementState_NONE)));\n            // if (!floatEqual(componentState, ElementState_NONE)) //componentState!=0;after showAll, it returns its own color.\n            //     realOpacity = vaColor.a;\n\n            baseColor = mix(keepColor, baseColor, step(0.01, abs(componentState - ElementState_OVERRIDED)));\n            // if (floatEqual(componentState, ElementState_OVERRIDED))//override color, its map should not be kept on\n            //     baseColor = keepColor;\n        #endif\n    #endif\n",
//! CloudStandardShader CloudStandardShaderV3
CloudStandardUnf_pars_fragment:"\n    #define PHYSICAL\n    uniform vec3 diffuse;\n    uniform vec3 emissive;\n    uniform float roughness;\n    uniform float metalness;\n    uniform float opacity;\n    uniform float imageFade;\n    uniform vec3 tintColor;\n    #ifndef STANDARD\n        uniform float clearCoat;\n        uniform float clearCoatRoughness;\n    #endif\n\n        varying vec3 vViewPosition;\n\n    #include <flat_shaded_pars_fragment>\n\n    #ifdef USE_INSTANCE\n        varying vec4 vaColor;\n        varying float componentState;\n        varying float fClipping;\n    #endif\n\n    #include <CompressColor_pars_fragment>\n\n    #if defined(USE_MULTI_BLINK_COLOR) \n         varying vec4 vbColor;\n    #endif\n\n    #include <use_fillpattern_pars_fragment>\n    varying vec4 wPositionForInnerClipping;\n    uniform float shift;\n    uniform float A;\n    uniform float B;\n    uniform float C;\n    uniform float D;\n    uniform float E;\n    uniform float F;\n    uniform float scale;\n    uniform vec4 blinkColor;\n    uniform float blinkCoefficient;\n    uniform float colorState;\n    uniform int localClipping;\n    uniform int innerClipping;\n    uniform mat4 orthoViewProjMatrix;\n    uniform bool useForCap;\n",
//! IBLShaders
DirationLights_pars_Fragment:"\n    #if NUM_DIR_LIGHTS > 0\n        vec3 dirColor = vec3(0.0);\n        #if defined(USE_CSM)\n            DirectionalLight directionalLight;\n            vec3 debugColor = vec3(0.,0.,0.);\n            float shadowValue = calcShadowFactor(normalVector,debugColor);\n            for (int i = 4; i < NUM_DIR_LIGHTS; ++i)\n            {\n                directionalLight = directionalLights[i];\n                vec3 dirVector = normalize(directionalLight.direction);\n                vec3 halfVector = normalize(dirVector + viewVector);\n\n                float NdotL = max(dot(normalVector, dirVector), 0.0);\n                float NdotH = max(dot(normalVector, halfVector), 0.0);\n                float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                vec3 F = F_Schlick(HdotV, F0);\n                vec3 kS = F;\n                vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                float D = D_GGX(NdotH, roughnessFactor);\n                float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                #ifdef USE_SHADOWMAP\n                    directionalLight.color = mix(\n                        directionalLight.color * shadowValue,\n                        directionalLight.color,\n                        step(realOpactity, 0.9) // if (0.9 < realOpacity) return 0.0\n                    );\n                \n                    // if(realOpacity > 0.9)\n                    //     directionalLight.color *= shadowValue;\n                #endif\n\n\n                dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n            }\n        #else\n            #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                DirectionalLightShadow directionalLightShadow;\n            #endif\n\n            DirectionalLight directionalLight;\n            vec3 dirVector;\n            vec3 halfVector;\n            float NdotL;\n            float NdotH;\n            float HdotV;\n\n            vec3 F;\n            vec3 kS;\n            vec3 kD;\n\n            float D;\n            float G;\n            vec3 specular;\n\n            #pragma unroll_loop_start\n            for (int i = 0; i < NUM_DIR_LIGHTS; i++)\n            {\n                directionalLight = directionalLights[i];\n                \n                dirVector = normalize(directionalLight.direction);\n                halfVector = normalize(dirVector + viewVector);\n\n                NdotL = max(dot(normalVector, dirVector), 0.0);\n                NdotH = max(dot(normalVector, halfVector), 0.0);\n                HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                F = F_Schlick(HdotV, F0);\n                kS = F;\n                kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                D = D_GGX(NdotH, roughnessFactor);\n                G = G_Smith(NdotV, NdotL, roughnessFactor);\n                specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && (UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                    directionalLightShadow = directionalLightShadows[ i ];\n                    \n                    directionalLight.color = mix(\n                        mix(\n                            directionalLight.color * 1.0,\n                            directionalLight.color * getShadow(directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ),\n                            clamp(float(receiveShadow), 0.0, 1.0)\n                        ),\n                        directionalLight.color,\n                        step(realOpacity, 0.9)\n                    );\n\n                    // if(realOpacity > 0.9)\n                    //     directionalLight.color *= \n                    //         all( bvec2(receiveShadow, true ) ) ? \n                    //             getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : \n                    //             1.0;\n                #endif\n\n                dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n            }\n            #pragma unroll_loop_end\n        #endif\n        totalLightColor += dirColor;\n    #endif\n",
//! IBLShaders   deprecated
PointLights_pars_Fragment:"\n    #if NUM_POINT_LIGHTS > 0\n        vec3 pointColor  = vec3(0.0);\n        #pragma unroll_loop_start\n        for (int i = 0; i < NUM_POINT_LIGHTS; i++)\n        {\n            PointLight pointLight = pointLights[i];\n            vec3 dirVector = pointLight.position - mvPosition;\n            float distance = length(dirVector);\n            dirVector = normalize(dirVector);\n            vec3 halfVector = normalize(dirVector + viewVector);\n\n            float NdotL = max(dot(normalVector, dirVector), 0.0);\n            float NdotH = max(dot(normalVector, halfVector), 0.0);\n            float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n            vec3 F = F_Schlick(HdotV, F0);\n            vec3 kS = F;\n            vec3 kD = (1.0 - kS) * (1 - metalnessFactor);\n\n            float D = D_GGX(NdotH, roughnessFactor);\n            float G = G_Smith(NdotV, NdotL, roughnessFactor);\n            vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n            pointColor += (kD * baseColor / PI + specular) * pointLight.color * NdotL * punctualLightIntensityToIrradianceFactor(distance, pointLight.distance, pointLight.decay);\n        }\n        #pragma unroll_loop_end\n        totalLightColor += pointColor;\n    #endif\n",
//! IBLShaders
SpotLights_pars_Fragment:"\n        #if NUM_SPOT_LIGHTS > 0\n        vec3 spotColor  = vec3(0.0);\n\n        for (int i = 0; i < NUM_SPOT_LIGHTS; i++)\n        {\n            SpotLight spotLight = spotLights[i];\n            vec3 dirVector = spotLight.position - mvPosition;\n            float distance = length(dirVector);\n            dirVector = normalize(dirVector);\n            vec3 halfVector = normalize(dirVector + viewVector);\n\n            float angleCos = dot(dirVector, spotLight.direction);\n\n            // 此处优化可以换成两个函数，calculateTotalLightColor和originTotalLightColor\n            // 然后使用mix函数\n            // totalLightColor = mix(calculateTotalLightColor(),originTotalLightColor(),step(angleCos, spotLight.coneCos))\n\n            if (angleCos > spotLight.coneCos)\n            {\n                float spotEffect = smoothstep(spotLight.coneCos, spotLight.penumbraCos, angleCos);\n                float NdotL = max(dot(normalVector, dirVector), 0.0);\n                float NdotH = max(dot(normalVector, halfVector), 0.0);\n                float HdotV = max(dot(halfVector, viewVector), 0.0);\n\n                vec3 F = F_Schlick(HdotV, F0);\n                vec3 kS = F;\n                vec3 kD = (1.0 - kS) * (1.0 - metalnessFactor);\n\n                float D = D_GGX(NdotH, roughnessFactor);\n                float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n\n                spotColor += (kD * baseColor / PI + specular) * spotLights[i].color * spotEffect * NdotL\n                * punctualLightIntensityToIrradianceFactor(distance, spotLight.distance, spotLight.decay);\n               \n                totalLightColor += spotColor;\n            }\n        }\n    #endif\n",
//! CloudStandardShader CloudStandardShaderV3
innerClipping_common_fragment:"\n    if (innerClipping > 0)\n    {\n        #include <innerClipping_fragment>\n    }\n    else\n    {\n        #if NUM_CLIPPING_PLANES > 0\n        vec3 cameraPosInViewSpace = vec3(0.0);\n        #ifdef USE_INSTANCE\n            if ((localClipping == 1 && floatEqual(fClipping, ElementState_LOCALCLIPPING)) || localClipping < 0) {\n                vec4 plane;\n                #pragma unroll_loop_start\n                for ( int i = 0; i < UNION_CLIPPING_PLANES; i++ ) {\n                    plane = clippingPlanes[ i ];\n                    if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap &&dot( cameraPosInViewSpace, plane.xyz ) > plane.w )) ) discard;\n                }\n                #pragma unroll_loop_end\n\n                #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                    bool clipped = true;\n                    #pragma unroll_loop_start\n                    for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i++ ) {\n                        plane = clippingPlanes[ i ];\n                        clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                    }\n                    #pragma unroll_loop_end\n                    \n                    if ( clipped ) discard;\n                #endif\n            }\n        #else\n            vec4 plane;\n\n            #pragma unroll_loop_start\n            for ( int i = 0; i < UNION_CLIPPING_PLANES; i++ ) {\n                plane = clippingPlanes[ i ];\n                if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap&&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))  ) discard;\n            }\n            #pragma unroll_loop_end\n\n            #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                bool clipped = true;\n                #pragma unroll_loop_start\n                for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i++ ) {\n                    plane = clippingPlanes[ i ];\n                    clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                }\n                #pragma unroll_loop_end\n                if ( clipped ) discard;\n            #endif\n\n        #endif\n    #endif\n    }\n",
//! CloudStandardShader  CloudStandardShaderV3
diffuseColor_Fragment:"\n    // 选中的颜色，不受光照，曝光等影响，保持最初的颜色\n    vec4 selectedColor = diffuseColor;\n    vec4 withoutLightColor = diffuseColor;\n    #ifndef USE_LIGHTMAP\n        diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n    #endif\n\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n\n    // BIMFACE-15305: 根据颜色创建的override材质emissive默认值为(0.0, 0.0, 0.0)\n    // 对于实例对象需要特殊处理:不使用原材质emissive值,而是直接使用默认值\n    #ifdef USE_INSTANCE\n        totalEmissiveRadiance = mix(vec3(0.0), totalEmissiveRadiance, step(0.01, abs(componentState - ElementState_OVERRIDED)));\n\n        // if (floatEqual(componentState, ElementState_OVERRIDED))//after transparented, its map should not be kept on\n        //     totalEmissiveRadiance = vec3(0.0);   // 默认值\n    #endif\n\n    #include <logdepthbuf_fragment>\n    // #include <map_fragment>\n\n    vec4 gamaColor = diffuseColor ;//经过gamma处理\n\n    #ifdef USE_MAP\n        vec4 texelColor = texture2D( map, vUv );\n        texelColor = mapTexelToLinear( texelColor );\n\n        #ifdef USE_CLAMP_TO_BORDER\n            texelColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?diffuseColor:mapTexelToLinear( texelColor );\n        #endif\n\n        // BIMFACE-31308: 若材质不透明，则将贴图和底色混合，消除贴图alpha为0对应的颜色\n        // 若是半透明材质，使用mix将贴图和原色混合，和实际的半透明效果会存在差异！\n        // 混合模式NormalBlending： blendFuncSeparate(SRC_ALPHA, ONE_MINUS_SRC_ALPHA, ONE, ONE_MINUS_SRC_ALPHA)\n        // diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);//mix color with texture mix(texelColor.rgb,diffuseColor.rgb , 0.0)\n        diffuseColor = vec4( mix(diffuseColor.rgb, texelColor.rgb, imageFade * texelColor.a), min(opacity, texelColor.a));\n        // BIMFACE-32457: alpha混合的话，有两个问题，一是容易出现色差，二是如果材质半透明，混合后可能变成不透明\n        // diffuseColor.a = texelColor.a + opacity * (1.0 - texelColor.a);\n\n        #ifdef USE_INSTANCE\n            diffuseColor.a = mix(diffuseColor.a, vaColor.a, step(0.01, abs(componentState - ElementState_NONE)));\n            diffuseColor = mix(gamaColor, diffuseColor, step(0.01, abs(componentState - ElementState_OVERRIDED)));\n\n            // if (!floatEqual(componentState, ElementState_NONE)) //componentState!=0;after showAll, it returns its own color.\n            //     diffuseColor.a = vaColor.a;\n            // if (floatEqual(componentState, ElementState_OVERRIDED))//override color, its map should not be kept on\n            //     diffuseColor = gamaColor;\n        #endif\n\n    #endif\n",
//! CloudStandardShader CloudStandardShaderV3 CloudStandardInstancedShaderV3 CloudStandardBatchedShaderV3
//! 有地方没有引用
directLight_pars_Fragment:"\n    GeometricContext geometry;\n    geometry.position = - vViewPosition;\n    geometry.normal = normal;\n    geometry.viewDir = normalize( vViewPosition );\n    IncidentLight directLight;\n    #if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n        PointLight pointLight;\n        #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)\n            PointLightShadow pointLightShadow;\n        #endif\n        #pragma unroll_loop_start\n        for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n            pointLight = pointLights[ i ];\n            getPointDirectLightIrradiance( pointLight, geometry, directLight );\n            //r142\n            //getPointLightInfo( pointLight, geometry, directLight );\n            #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n                pointLightShadow = pointLightShadows[ i ];\n                directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n            #endif\n            RE_Direct( directLight, geometry, material, reflectedLight );\n        }\n        #pragma unroll_loop_end\n    #endif\n\n    #if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n        SpotLight spotLight;\n        #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n            SpotLightShadow spotLightShadow;\n        #endif\n        #pragma unroll_loop_start\n        for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n            spotLight = spotLights[ i ];\n            getSpotDirectLightIrradiance( spotLight, geometry, directLight );\n    //r142\n    //        getSpotLightInfo( spotLight, geometry, directLight );\n            #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n            spotLightShadow = spotLightShadows[ i ];\n\n            directLight.color = mix(\n                mix(\n                    directLight.color * getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ),\n                    directLight.color * 1.0,\n                    clamp(2.0 - (float(receiveShadow) + float(directLight.visible)), 0.0, 1.0)\n                ),\n                directLight.color,\n                step(opacity, 0.8)\n            );\n\n            // if(opacity > 0.8)\n            //     directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n            #endif\n            RE_Direct( directLight, geometry, material, reflectedLight );\n        }\n    #pragma unroll_loop_end\n    #endif\n\n    #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )\n\n        DirectionalLight directionalLight;\n        vec3 debugColor = vec3(0.,0.,0.);\n        float shadowValue = calcShadowFactor(geometry.normal,debugColor);\n\n        #pragma unroll_loop_start\n        for ( int i = 4; i < NUM_DIR_LIGHTS; i ++ ) {\n            directionalLight = directionalLights[ i ];\n            getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n    //r142\n    //        getDirectionalLightInfo( directionalLight, geometry, directLight );\n            \n            #ifdef USE_SHADOWMAP\n                directLight.color = mix(\n                    mix(\n                        directLight.color,\n                        directLight.color * shadowValue,\n                        clamp(float(receiveShadow), 0.0, 1.0)\n                    ),\n                    directLight.color,\n                    step(opacity, 0.8)\n                );\n                // if(opacity > 0.8)\n                //     directLight.color *=  receiveShadow ? shadowValue : 1.0;\n            #endif\n            RE_Direct( directLight, geometry, material, reflectedLight );\n            #ifdef USE_SHADOW_CSM_DEBUG\n                reflectedLight.directDiffuse = debugColor * (receiveShadow ? shadowValue : 1.0);\n                //reflectedLight.indirectDiffuse = vec3(0.,0.,0.);\n                //reflectedLight.directSpecular = vec3(0.,0.,0.);\n            #endif\n        }\n        #pragma unroll_loop_end\n    #endif\n\n    #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n        DirectionalLight directionalLight;\n\n        #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n            DirectionalLightShadow directionalLightShadow;\n        #endif\n\n        #pragma unroll_loop_start\n        for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n            directionalLight = directionalLights[ i ];\n            getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n            //r142\n            //getDirectionalLightInfo( directionalLight, geometry, directLight );\n            #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                directionalLightShadow = directionalLightShadows[ i ];\n                if(opacity > 0.8)\n                {\n                    // auto depth bias\n                    vec4 positionWS = vDirectionalShadowCoord[ i ];\n                    float cos = dot(normal, directionalLight.direction);\n                    float sin = sqrt(1.0 - cos*cos);\n                    float tan = min(1.0, sin/cos);\n                    float bias = directionalLightShadow.shadowBias * tan;\n                    //directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                    directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, bias, directionalLightShadow.shadowRadius, positionWS ) : 1.0;\n                \n                }\n            #endif\n            RE_Direct( directLight, geometry, material, reflectedLight );\n        }\n        #pragma unroll_loop_end\n    #endif\n",
//! CloudStandardShader CloudStandardShaderV3 CloudStandardInstancedShaderV3 CloudStandardBatchedShaderV3
gl_FragColor_pars_Fragment:"\n    #if defined( TONE_MAPPING )\n        #if defined(USE_LIGHTMAP)\n            #ifdef EXPOSED_COLOR\n                vec3 exposedColor = pow(1.0 * diffuseSpecularEmissive.xyz, vec3(1.0));\n            #endif\n\n            gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );\n        #else\n            gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );\n        #endif\n    #endif\n",
//! CloudStandardShader CloudStandardShaderV3
cloudstandard_component_state_fragment:"\n    #ifdef USE_INSTANCE\n        gl_FragColor = mix(selectedColor, gl_FragColor, step(0.01, abs(componentState - ElementState_SELECTED)));\n        // if (floatEqual(componentState, ElementState_SELECTED))//if seleted, all are the same color;\n        //     gl_FragColor = selectedColor;\n        \n        #if defined(USE_MULTI_BLINK_COLOR)\n            vec4 finBlinkColor = vbColor;\n        #else\n            vec4 finBlinkColor = blinkColor;\n        #endif\n\n        gl_FragColor = mix(\n            mix(gl_FragColor, finBlinkColor, blinkCoefficient),\n            gl_FragColor,\n            clamp(step(0.01, abs(componentState - ElementState_BLINK)) + step(0.01, abs(colorState - ShaderColorState_BLINK)), 0.0, 1.0)\n        );\n\n\n        // if (floatEqual(componentState, ElementState_BLINK) && floatEqual(colorState, ShaderColorState_BLINK)) {//if seleted, all are the same color;\n           \n        //     gl_FragColor = mix(gl_FragColor, finBlinkColor, blinkCoefficient);\n        // }\n    #else\n        if (floatEqual(colorState, ShaderColorState_BLINK)) {\n            gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n        }\n        if (floatEqual(colorState, ShaderColorState_SELECT))\n            gl_FragColor = selectedColor;\n    #endif\n    ",packingMaterial_pars_Vertex:"\n       #if defined(USE_PACKINGMAT)\n       attribute vec2 uv3;\n       varying vec2 vUv3;\n       #endif\n    ",packingMaterial_Vertex:"\n       #if defined(USE_PACKINGMAT)\n         vUv3 = uv3;\n       #endif\n    ",packingMaterial_pars_Fragment:"\n        #if defined(USE_PACKINGMAT)\n          varying vec2 vUv3;\n          uniform sampler2D packingMatMap;\n        #endif\n    ",packingMaterial_Fragment:"\n        float noise_type = 0.0;\n        #ifdef USE_PACKINGMAT\n           float fUVStep = 0.0009765625;\n           float uvx = vUv3.x;\n           vec4 packing_pixel0 = texture2D(packingMatMap, vec2(uvx  , vUv3.y) );\n        //    vec4 packing_pixel1 = texture2D(packingMatMap, vec2(uvx + 1.0*fUVStep , vUv3.y));\n        vec4 packing_pixel2 = texture2D(packingMatMap, vec2(uvx + 2.0*fUVStep , vUv3.y));\n        vec4 packing_pixel3 = texture2D(packingMatMap, vec2(uvx + 3.0*fUVStep , vUv3.y));\n        vec4 packing_pixel4 = texture2D(packingMatMap, vec2(uvx + 4.0*fUVStep , vUv3.y));\n       vec4 packing_pixel5 = texture2D(packingMatMap, vec2(uvx + 5.0*fUVStep , vUv3.y));\n        vec3 diffuse             = packing_pixel0.xyz  ;\n        //float opacity            = packing_pixel0.w     ;\n        //    vec3 specular            = packing_pixel1.xyz;\n        //    float shininess          = packing_pixel1.w;\n        float bumpScale          = packing_pixel2.x;\n        float roughness           = packing_pixel2.y;\n        float metalness          = packing_pixel2.z;\n        vec3 emissive            = packing_pixel3.xyz;\n        float reflectivity       = packing_pixel3.w;\n        vec3 enviroment          = packing_pixel4.xyz;\n        float refractionRatio    = packing_pixel4.w;\n        noise_type               = packing_pixel5.x;\n    #endif\n",
//! CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3 MeshBasicClipMaterial
outline_pars_Vertex:"\n    #ifdef USE_BC_OUTLINE \n        attribute vec3 barycentric;\n        varying vec3 vBarycentric;\n    #endif\n",
//! CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3
outline_Vertex:"\n    #if defined(USE_BC_OUTLINE)\n        vBarycentric = barycentric;\n    #endif\n",
//! CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3 IBLShader CloudStandardShaderV3
outline_pars_Fragment:"\n    #if defined(USE_BC_OUTLINE)\n        varying vec3 vBarycentric;\n        uniform vec3 outLineColor;\n\n        float edgeFactor3(){\n            vec3 d = fwidth(vBarycentric);\n            float minValue = 0.0000001;\n            // make sure d is not 0\n            d = clamp(d, vec3(minValue), vec3(10.0));\n            vec3 a3 = smoothstep(vec3(0.0), d*0.8, vBarycentric);\n            return min(min(a3.x, a3.y), a3.z);\n        }\n    #endif\n",
//! CloudStandardInstanceShaderV3 CloudStandardBatchedShaderV3
outline_Fragment:"\n    #if defined(USE_BC_OUTLINE)\n        #include <cloud_wire_frame_state_fragment>\n        vec3 _tempColor = gl_FragColor.rgb;\n        const float darkFactor = 0.8;\n        vec3 _outlineColor = gl_FragColor.rgb * darkFactor;\n        gl_FragColor = mix(\n            gl_FragColor,\n            mix(\n                mix(vec4(finWireFrameColor, 0.6), gl_FragColor, edgeFactor3()),\n                mix(\n                    vec4(mix(finWireFrameColor, _outlineColor, clamp(length(fwidth(vPosition)) * 2.0, 0.0, 1.0)), gl_FragColor.a),\n                    vec4(_tempColor, gl_FragColor.a),\n                    edgeFactor3()\n                ),\n                clamp(step(0.6, gl_FragColor.a) + step(gl_FragColor.a, 0.01), 0.0, 1.0)\n            ),\n            step(0.01, abs(wireFrameState -  WireframeState_HIDDEN))\n        );\n        // if(!floatEqual(wireFrameState, WireframeState_HIDDEN))\n        // {\n        //     vec3 d = fwidth(vPosition);\n        //     float fDis = length(d);\n        //     //fDis += 0.3;\n        //     fDis *= 2.0;\n        //     fDis = clamp(fDis, 0.0,1.0);\n        //     vec3 tempWireColor = mix(finWireFrameColor,_outlineColor,fDis);\n\n        //     //全透明的构件不进行线框显示加强\n        //     if( gl_FragColor.a < 0.6 && gl_FragColor.a > 0.01 )\n        //     {\n        //         gl_FragColor = mix(vec4(finWireFrameColor,0.6 ), gl_FragColor, edgeFactor3());\n        //     }\n        //     else\n        //         gl_FragColor.rgb = mix(tempWireColor, _tempColor, edgeFactor3());\n\n\n        // }\n    #endif\n",compare_function:"\n        // bool bitEqual(int elementState,int state)\n        // {\n        //     if(state <= 0)\n        //     {\n        //         return state == elementState;\n        //     }\n        //     int k = int(log2(float(state)));\n        //     float a = float(elementState >> k);\n        //     float b = float(state >> k);\n        //     a = mod(a,2.);\n        //     b = mod(b,2.);\n        //     return abs(a-b) < 0.01;\n        // }\n\n        bool intEqual(int elementState,int state)\n        {\n            return elementState == state;\n        }\n\n        bool floatEqual(float elementState,float state)\n        {\n            return abs(elementState-state) < 0.01;\n        }\n\n",cloudstandard_instance_v3_pars_vertex:"\n        #include <num_clipping_planes_pars_vertex>\n        attribute vec4 aColor;\n        varying vec4 vaColor;\n        attribute vec3 mcol0;\n        attribute vec3 mcol1;\n        attribute vec3 mcol2;\n        attribute vec3 mcol3;\n        #if defined(USE_MAP)||defined(USE_BUMPMAP) \n            attribute vec4 muvCol0;\n            attribute vec2 muvCol1;\n            //attribute vec2 muvCol2;\n        #endif\n        #if defined(USE_MULTI_BLINK_COLOR) \n            attribute vec4 bColor;\n            varying vec4 vbColor;\n        #endif\n        #if defined(USE_LIGHTMAP)\n            attribute vec4 uv2OffsetRepeat;\n        #endif\n",cloudstandard_instance_normal_vertex:"\n        #ifdef USE_INSTANCE_NORMAL\n            // mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n            // #ifdef SUPPORT_INSTANCE_MIRROR\n            // bool mirror = isMirror_mat3(normalMat);\n            // #endif\n\n            // normalMat = inverse_mat3(normalMat);\n            // normalMat = transposeMat3(normalMat);\n\n            // transformedNormal = normalMat * objectNormal;\n            // transformedNormal = normalMatrix * transformedNormal;\n\n            // #ifdef SUPPORT_INSTANCE_MIRROR\n            // if(mirror){\n            //   transformedNormal = - transformedNormal;\n            // }\n            // #endif\n            \n            // #ifdef FLIP_SIDED\n            //     transformedNormal = - transformedNormal;\n            // #endif\n            // transformedNormal = normalize( transformedNormal );\n\n            mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n          #ifdef SUPPORT_INSTANCE_MIRROR\n            bool mirror = isMirror_mat3(normalMat);\n          #endif\n\n            normalMat = inverse_mat3(normalMat);\n            normalMat = transpose_mat3(normalMat);\n            normalMat = normalMatrix * normalMat;\n\n          #ifdef MESHOPTQUANTIZATION    \n            normalMat = normalMat * quantizationNormalMatrix; \n          #endif\n          \n            transformedNormal = normalMat * objectNormal;\n\n          #ifdef SUPPORT_INSTANCE_MIRROR\n            if(mirror) {\n                transformedNormal = - transformedNormal;\n            }\n          #endif\n\n          #ifdef FLIP_SIDED\n            transformedNormal = - transformedNormal;\n          #endif\n\n            transformedNormal = normalize( transformedNormal );\n\n        #endif\n",cloudstandard_v3_pars_fragment:"\n        #define PHYSICAL\n        uniform vec3 diffuse;\n        uniform vec3 emissive;\n        uniform float roughness;\n        uniform float metalness;\n        uniform float opacity;\n        uniform float imageFade;\n        uniform vec3 tintColor;\n        #ifndef STANDARD\n            uniform float clearCoat;\n            uniform float clearCoatRoughness;\n        #endif\n\n        varying vec3 vViewPosition;\n        varying vec4 wPositionForInnerClipping;\n        uniform float shift;\n        uniform float A;\n        uniform float B;\n        uniform float C;\n        uniform float D;\n        uniform float E;\n        uniform float F;\n        uniform float scale;\n        uniform vec4 blinkColor;\n        uniform float blinkCoefficient;\n        uniform float colorState;\n        uniform int localClipping;\n        uniform int innerClipping;\n        uniform mat4 orthoViewProjMatrix;\n\n        uniform bool useForCap;\n",noise_function:"\nvec4 mod289(vec4 x)\n{\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec3 mod289(vec3 x) {\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec3 permute(vec3 x) {\n  return mod289(((x*34.0)+10.0)*x);\n}\n\nvec4 permute(vec4 x)\n{\n  return mod289(((x*34.0)+10.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r)\n{\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\n    \nvec3 fade(vec3 t) {\n    return t*t*t*(t*(t*6.0-15.0)+10.0);\n  }\n      \n\n    \nfloat snoise(vec3 v)\n{ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //   x0 = x0 - 0.0 + 0.0 * C.xxx;\n  //   x1 = x0 - i1  + 1.0 * C.xxx;\n  //   x2 = x0 - i2  + 2.0 * C.xxx;\n  //   x3 = x0 - 1.0 + 3.0 * C.xxx;\n  vec3 x1 = x0 - i1 + C.xxx;\n  vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n  vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n// Permutations\n  i = mod289(i); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients: 7x7 points over a square, mapped onto an octahedron.\n// The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n  float n_ = 0.142857142857; // 1.0/7.0\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  //vec4 s0 = vec4(lessThan(b0,0.0))*2.0 - 1.0;\n  //vec4 s1 = vec4(lessThan(b1,0.0))*2.0 - 1.0;\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.5 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 105.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n                                dot(p2,x2), dot(p3,x3) ) );\n}\n\nvec3 RotVec3(vec3 inVec, float angle )\n{\n    float rad = radians(angle);\n    //rot matrix\n    mat4 m4 = mat4(\n    cos(rad), sin(rad), 0.0, 0.0,\n    -sin(rad), cos(rad), 0.0, 0.0,\n    0.0,        0.0,         1.0, 0.0,\n    0.0,        0.0,         0.0, 1.0\n    );\n\n    vec4 pos = m4 * vec4(inVec, 1.0);\n    return pos.xyz;\n}\n\n// Classic Perlin noise\nfloat cnoise(vec3 P)\n{\n  vec3 Pi0 = floor(P); // Integer part for indexing\n  vec3 Pi1 = Pi0 + vec3(1.0); // Integer part + 1\n  Pi0 = mod289(Pi0);\n  Pi1 = mod289(Pi1);\n  vec3 Pf0 = fract(P); // Fractional part for interpolation\n  vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n  vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n  vec4 iy = vec4(Pi0.yy, Pi1.yy);\n  vec4 iz0 = Pi0.zzzz;\n  vec4 iz1 = Pi1.zzzz;\n\n  vec4 ixy = permute(permute(ix) + iy);\n  vec4 ixy0 = permute(ixy + iz0);\n  vec4 ixy1 = permute(ixy + iz1);\n\n  vec4 gx0 = ixy0 * (1.0 / 7.0);\n  vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n  gx0 = fract(gx0);\n  vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n  vec4 sz0 = step(gz0, vec4(0.0));\n  gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n  gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n  vec4 gx1 = ixy1 * (1.0 / 7.0);\n  vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n  gx1 = fract(gx1);\n  vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n  vec4 sz1 = step(gz1, vec4(0.0));\n  gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n  gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n  vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n  vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n  vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n  vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n  vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n  vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n  vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n  vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n  vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n  g000 *= norm0.x;\n  g010 *= norm0.y;\n  g100 *= norm0.z;\n  g110 *= norm0.w;\n  vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n  g001 *= norm1.x;\n  g011 *= norm1.y;\n  g101 *= norm1.z;\n  g111 *= norm1.w;\n\n  float n000 = dot(g000, Pf0);\n  float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n  float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n  float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n  float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n  float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n  float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n  float n111 = dot(g111, Pf1);\n\n  vec3 fade_xyz = fade(Pf0);\n  vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n  vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n  float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); \n  return 2.2 * n_xyz;\n}\n\n// Classic Perlin noise, periodic variant\nfloat pnoise(vec3 P, vec3 rep)\n{\n  vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\n  vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\n  Pi0 = mod289(Pi0);\n  Pi1 = mod289(Pi1);\n  vec3 Pf0 = fract(P); // Fractional part for interpolation\n  vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n  vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n  vec4 iy = vec4(Pi0.yy, Pi1.yy);\n  vec4 iz0 = Pi0.zzzz;\n  vec4 iz1 = Pi1.zzzz;\n\n  vec4 ixy = permute(permute(ix) + iy);\n  vec4 ixy0 = permute(ixy + iz0);\n  vec4 ixy1 = permute(ixy + iz1);\n\n  vec4 gx0 = ixy0 * (1.0 / 7.0);\n  vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n  gx0 = fract(gx0);\n  vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n  vec4 sz0 = step(gz0, vec4(0.0));\n  gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n  gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n  vec4 gx1 = ixy1 * (1.0 / 7.0);\n  vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n  gx1 = fract(gx1);\n  vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n  vec4 sz1 = step(gz1, vec4(0.0));\n  gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n  gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n  vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n  vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n  vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n  vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n  vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n  vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n  vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n  vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n  vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n  g000 *= norm0.x;\n  g010 *= norm0.y;\n  g100 *= norm0.z;\n  g110 *= norm0.w;\n  vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n  g001 *= norm1.x;\n  g011 *= norm1.y;\n  g101 *= norm1.z;\n  g111 *= norm1.w;\n\n  float n000 = dot(g000, Pf0);\n  float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n  float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n  float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n  float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n  float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n  float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n  float n111 = dot(g111, Pf1);\n\n  vec3 fade_xyz = fade(Pf0);\n  vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n  vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n  float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); \n  return 2.2 * n_xyz;\n}\n",noise_fragment:"\n#ifndef USE_MAP\n    if(floatEqual(noise_type , 2.0 ) && roughnessFactor > 0.59 && opacity > 0.95 )\n    {\n        float fRand = snoise(vPosition *250.0);\n        float fFactor = 0.05;\n        roughnessFactor -= fFactor;\n        roughnessFactor += fFactor * fRand;\n    \n        // float fRandAngle = 10.0 * fRand;\n        // normal = RotVec3(normal, fRandAngle);\n    }\n#endif\n\n",ACESFilm_function_fragment:"\nvec3 ACESFilm(vec3 x)\n{\n    float a = 2.51;\n    float b = 0.03;\n    float c = 2.43;\n    float d = 0.59;\n    float e = 0.14;\n    return saturate((x*(a*x+b))/(x*(c*x+d)+e));\n}\n\n",specular_unuse_envMap_pars_fragment:"\n    uniform bool useEnvLight;\n  ",specular_unuse_envMap_fragment:"\n  #if defined( RE_IndirectSpecular )\n      if(useEnvLight)\n      {\n        vec3 radiance =vec3(1.0,1.0,1.0) * metalness * 0.2;\n        #ifndef STANDARD\n            vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );\n        #else\n            vec3 clearCoatRadiance = vec3( 0.0 );\n        #endif\n        RE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); \n      }\n    #endif\n    ",bumpmap_pars_fragment:"\n      #ifdef USE_BUMPMAP\n        uniform sampler2D bumpMap;\n        uniform float bumpScale;\n        varying vec2 vBumpMapUv;\n      \n        // Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen\n        // http://api.unrealengine.com/attachments/Engine/Rendering/LightingAndShadows/BumpMappingWithoutTangentSpace/mm_sfgrad_bump.pdf\n      \n        // Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)\n      \n        vec2 dHdxy_fwd() {\n      \n          vec2 dSTdx = dFdx( vBumpMapUv );\n          vec2 dSTdy = dFdy( vBumpMapUv );\n      \n          float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n          float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n          float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n      \n          return vec2( dBx, dBy );\n      \n        }\n      \n        vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n      \n          // Workaround for Adreno 3XX dFd*( vec3 ) bug. See #9988\n      \n          vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n          vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n          vec3 vN = surf_norm;\t\t// normalized\n      \n          vec3 R1 = cross( vSigmaY, vN );\n          vec3 R2 = cross( vN, vSigmaX );\n      \n          float fDet = dot( vSigmaX, R1 ) * faceDirection;\n      \n          vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n          return normalize( abs( fDet ) * surf_norm - vGrad );\n      \n        }\n      #endif\n    ",color_correction_pars_fragment:"\n      uniform float saturation;\n      uniform float temperature;\n      uniform float temperatureStrength;\n      uniform float contrast;\n\n      // Valid from 1000 to 40000 K (and additionally 0 for pure full white)\n      vec3 colorTemperatureToRGB(const in float temperature){\n        // Values from: http://blenderartists.org/forum/showthread.php?270332-OSL-Goodness&p=2268693&viewfull=1#post2268693   \n        mat3 m = (temperature <= 6500.0) ? mat3(vec3(0.0, -2902.1955373783176, -8257.7997278925690),\n                                              vec3(0.0, 1669.5803561666639, 2575.2827530017594),\n                                              vec3(1.0, 1.3302673723350029, 1.8993753891711275)) : \n                        mat3(vec3(1745.0425298314172, 1216.6168361476490, -8257.7997278925690),\n                                                vec3(-2666.3474220535695, -2173.1012343082230, 2575.2827530017594),\n                                              vec3(0.55995389139931482, 0.70381203140554553, 1.8993753891711275)); \n        return mix(clamp(vec3(m[0] / (vec3(clamp(temperature, 1000.0, 40000.0)) + m[1]) + m[2]), vec3(0.0), vec3(1.0)), vec3(1.0), smoothstep(1000.0, 0.0, temperature));\n      }\n\n      vec3 adjustContrast(vec3 color, float value) {\n        return 0.5 + (1.0 + value) * (color - 0.5);\n      }\n    ",color_correction_fragment:"\n      float gray = 0.2125 * gl_FragColor.r + 0.7154 * gl_FragColor.g + 0.0721 * gl_FragColor.b;\n      gl_FragColor.rgb = mix(vec3(gray), gl_FragColor.rgb, saturation);\n      gl_FragColor.rgb = mix(gl_FragColor.rgb , gl_FragColor.rgb  * colorTemperatureToRGB(temperature), temperatureStrength);\n      gl_FragColor.rgb = adjustContrast(gl_FragColor.rgb, contrast);\n      ",clamp_color_alpha:"\n        #ifdef USE_COLOR_CLAMP\n        // BIMFACE-37244: mac os glsl bug: gl_FragColor.a > 1.0 并没有钳制到1.0，这里手动钳制到1.0。\n        if(gl_FragColor.a >= 1.0){\n          gl_FragColor.a = 1.0;\n        }\n        #endif\n      "};let D=(e,t,i)=>e.replace(t,i);THREE.ShaderChunk.meshphong_id_vert="\n    #define PHONG\n    varying vec3 vViewPosition;\n\n    #include <flat_shaded_pars_vertex>\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n\n    void main() {\n        \n        #include <uv_vertex>\n        #include <uv2_vertex>\n        #include <color_vertex>\n        #include <beginnormal_vertex>\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        #include <defaultnormal_vertex>\n        #include <flat_shaded_vertex>\n        #include <begin_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        \n        vViewPosition = - mvPosition.xyz;\n        \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n    }",THREE.ShaderChunk.lights_fillFace_template="\n    GeometricContext geometry;\n\tgeometry.position = - vViewPosition;\n\t//change fillFace's normal\n\t#if NUM_CLIPPING_PLANES == 1\n\t\tif (gl_FrontFacing) geometry.normal = normal;\n\t\telse if (fillFaceClipDistance < 0.0) geometry.normal = -clippingPlanes[0].xyz;\n\t\telse geometry.normal = -normal;\n\t#else\n\t\tgeometry.normal = normal;\n\t#endif\n\tgeometry.viewDir = normalize( vViewPosition );\n\n\tIncidentLight directLight;\n\n\t#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\t\tPointLight pointLight;\n\t   #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)\n\t\t  PointLightShadow pointLightShadow;\n\t   #endif\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\t\tpointLight = pointLights[ i ];\n\t\t\tgetPointLightInfo( pointLight, geometry, directLight );\n\n\t\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\t\tpointLightShadow = pointLightShadows[ i ];\n\t\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t\t\t#endif\n\n\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t\t}\n\t   #pragma unroll_loop_end\n\n\t#endif\n\n\t#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\t\tSpotLight spotLight;\n\t   #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n\t        SpotLightShadow spotLightShadow;\n\t   #endif\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\t\tspotLight = spotLights[ i ];\n\t\t\tgetSpotLightInfo( spotLight, geometry, directLight );\n\n\t\t\t#if defined( USE_SHADOWMAP )  && (NUM_SPOT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t       spotLightShadow = spotLightShadows[ i ];\n\t\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t\t}\n\t   #pragma unroll_loop_end\n\n\t#endif\n\n\t#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\t\tDirectionalLight directionalLight;\n\t   #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\t      DirectionalLightShadow directionalLightShadow;\n\t\t#endif\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\t\tdirectionalLight = directionalLights[ i ];\n\t\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t//r142\n\t//\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\n\t\t\t#if defined( USE_SHADOWMAP )  && (NUM_DIR_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t\t#endif\n\n\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t\t}\n\t   #pragma unroll_loop_end\n\n\t#endif\n\n\t#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\t\tRectAreaLight rectAreaLight;\n\n\t\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\t\trectAreaLight = rectAreaLights[ i ];\n\t\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\n\t\t}\n\n\t#endif\n\n\t#if defined( RE_IndirectDiffuse )\n\n\t\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t\t#ifdef USE_LIGHTMAP\n\n\t\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\n\t\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage\n\n\t\t\t#endif\n\n\t\t\tirradiance += lightMapIrradiance;\n\n\t\t#endif\n\t\t#ifndef DISABLE_HEMI_LIGHT\n\t\t\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\n\t\t\t\t}\n\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\t\t// TODO, replace 8 with the real maxMIPLevel\n\t\t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );\n\n\t\t#endif\n\n\t\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n\n\t#endif\n\n\t#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\n\t\t// TODO, replace 8 with the real maxMIPLevel\n\t\tvec3 radiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, 8 );\n\n\t\t#ifndef STANDARD\n\t\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );\n\t\t#else\n\t\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t\t#endif\n\n\t\tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); \n\n\t#endif",THREE.ShaderChunk.lights_template=r.LightsTemplateShader,THREE.ShaderChunk.fillFaceFragment="\n    #define PHONG\n\n    uniform vec3 diffuse;\n    uniform vec3 emissive;\n    uniform vec3 specular;\n    uniform float shininess;\n    uniform float opacity;\n\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <gradientmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    //r142\n    //#include <alphatest_pars_fragment>\n    #include <lights_pars_begin>\n    #include <lights_phong_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n\n    void main() {\n\n    \t#include <clipping_planes_fragment>\n\n    \tvec4 diffuseColor = vec4( diffuse, opacity );\n    \tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \tvec3 totalEmissiveRadiance = emissive;\n\n    \t#include <logdepthbuf_fragment>\n    \t#include <map_fragment>\n    \t#include <color_fragment>\n    \t#include <alphamap_fragment>\n    \t#include <alphatest_fragment>\n    \t#include <specularmap_fragment>\n    \t#include <normal_flip>\n    \t#include <normal_fragment_begin>\n    \t#include <emissivemap_fragment>\n\n       float fillFaceClipDistance = 0.0;\n       #if NUM_CLIPPING_PLANES == 1\n           vec4 plane = clippingPlanes[ 0 ];\n\t\t    fillFaceClipDistance = dot( vViewPosition, plane.xyz ) - plane.w;\n       #endif\n\n        // accumulation\n    \t#include <lights_phong_fragment>\n    \t#include <lights_fillFace_template>\n\n        // modulation\n    \t#include <aomap_fragment>\n\n    \tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n    \t#include <envmap_fragment>\n\n    \tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n    \t#include <tonemapping_fragment>\n    \t#include <encodings_fragment>\n    \t#include <premultiplied_alpha_fragment>\n    \t#include <dithering_fragment>\n       #include <fog_fragment>\n    }",THREE.ShaderChunk.cloudStandardVertex="\n    #define PHYSICAL\n    varying vec3 vViewPosition;\n    #include <flat_shaded_pars_vertex>\n    #include <USE_INSTANCE_pars_Vertex>\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <view_shed_pars_vertex>\n    #include <video_cast_pars_vertex>\n\n    varying vec4 wPositionForInnerClipping;\n    \n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <heightLimit_pars_vertex>\n    #include <excavation_pars_vertex>\n    #include <matrix_transform_pars_vertex>\n    #include <growthAnimation_pars_vertex>\n    #include <treeTrunkAnimation_instance_pars_vertex>\n    #include <treeLeavesAnimation_instance_pars_vertex>\n\n    #include <compress_uv_pars_vertex>\n\n    #include <inverse_matrix_pars_vertex_quantization>\n\n    void main() {\n        // #include <uv_vertex>//BIMFACE-6940,BIMFACE-17859\n        #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )  || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n            \n            #include <compress_uv_vertex>\n\n        #endif\n\n        #include <uv2_vertex>\n        #include <color_vertex>\n        #include <beginnormal_vertex>\n\n        #ifdef CNORMAL\n            objectNormal = octDecode();\n        #endif\n\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        // #include <defaultnormal_vertex>\n        #include <defaultnormal_vertex_quantization>\n        //实例的贴图不能直接先用uv_vertex中处理过的vUv,不然matrix相乘的顺序颠倒了\n        #if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  \n           #include <uv_transform_vertex>\n        #endif\n        \n        #if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))\n           #include <uv2_decode_vertex>\n        #endif\n\n        #if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  \n           #include <uv2_offsetrepeat_vertex>\n        #endif\n\n        #include <CloudStandardShader_Transform_pars_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <growthAnimation_vertex>\n        #include <treeTrunkAnimation_instance_vertex>\n        #include <treeLeavesAnimation_instance_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n        wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );\n\n        #include <heightLimit_vertex>\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n        \n        vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n\n        #include <view_shed_vertex>\n        #include <video_cast_vertex>\n        #include <excavation_vertex>\n    }",THREE.ShaderChunk.cloudStandardFragment="\n    #include <CloudStandardUnf_pars_fragment>\n    #include <heightLimit_pars_fragment>\n    #include <toneMapCanonFilmic_pars_Fragment>\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <cube_uv_reflection_fragment>\n    #include <lights_pars_begin>\n    //r142\n    //#include <alphatest_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <csm_fragment>\n    #include <clipping_planes_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n    #include <view_shed_pars_fragment>\n    #include <video_cast_pars_fragment>\n    #include <excavation_pars_fragment>\n    #include <cloud_state_defines>\n    #include <hdrDecode_pars_Fragment>\n    #include <growthAnimation_pars_fragment>\n    #include <polygonclimpground_pars_fragment>\n    #include <color_correction_pars_fragment>\n\n    vec3 linearToGammaUnreal(in vec3 rgb) {\n         return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);\n    }\n    #include <compare_function>\n    #include <specular_unuse_envMap_pars_fragment>\n\n    void main() {\n        #include <innerClipping_common_fragment>\n        #include <growthAnimation_fragment>\n        \n        #include <use_fillpattern_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n\n        #include <vertex_color_frag>\n        #include <cloud_state_instance_color_fragment>\n        #include <CompressColor_fragment>\n        #include <diffuseColor_Fragment>\n        \n        diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb,diffuseColor.a);\n\n        #include <alphamap_fragment_override>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <emissivemap_fragment>\n\n        #ifdef USE_INSTANCE\n           #include <state_override_rough_n_metal_fragment>\n        #endif\n\n        #include <lights_physical_fragment>\n        // #include <lights_template>\n        //改动为光照贴图的lightMapIrradiance的计算,增加对比度\n        #include <incident_light_fragment>\n        #include <rect_area_light_fragment>\n        #include <re_indirect_diffuse_fragment>\n        #include <re_indirect_specular_fragment>\n        #include <specular_unuse_envMap_fragment>\n        #include <aomap_fragment>\n        #include <diffuse_specular_emissive_fragment>\n\n        vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n        gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        #define EXPOSED_COLOR 1.0\n        #define COLORSTATE_BLINK_STATE ShaderColorState_BLINK\n        #define COLORSTATE_SELECT_STATE ShaderColorState_SELECT\n        #include <gl_FragColor_pars_Fragment>\n\n\n        #include <color_without_light_frag>\n        #include <view_shed_fragment>\n        #include <video_cast_fragment>\n\n        #include <color_correction_fragment>\n        #ifndef USE_LIGHTMAP\n          #include <encodings_fragment>\n        #endif\n\n        #include <heightLimit_fragment>\n        #include <excavation_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n        #include <cloudstandard_component_state_fragment>\n        #include <fog_fragment>\n        #include <polygonclimpground_fragment>\n    }",THREE.ShaderChunk.cloudStandardVertexV3="  \n    #define PHYSICAL\n    varying vec3 vViewPosition;\n    #include <flat_shaded_pars_vertex>\n    // add v3\n    #ifdef USE_INSTANCE\n        attribute vec4 vState;\n        #include <cloudstandard_instance_v3_pars_vertex>\n    #endif\n    \n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <view_shed_pars_vertex>\n    #include <video_cast_pars_vertex>\n\n    varying vec4 wPositionForInnerClipping;\n    \n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <heightLimit_pars_vertex>\n    #include <excavation_pars_vertex>\n    #include <matrix_transform_pars_vertex>\n    #include <growthAnimation_pars_vertex>\n    // #include <treeTrunkAnimation_pars_instance_vertex>\n    // #include <treeLeavesAnimation_pars_instance_vertex>\n    //addV3\n    #include <cloud_state_pars_vertex>\n    #include <packing_material_pars_vertex>\n    #include <outline_pars_vertex>\n    #include <compress_uv_pars_vertex>\n    #include <inverse_matrix_pars_vertex_quantization>\n    #include <specular_unuse_envMap_pars_fragment>\n    \n    void main() {\n        // #include <uv_vertex>//BIMFACE-6940,BIMFACE-17859\n\n        #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )  || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n            \n            #include <compress_uv_vertex>\n        \n        #endif\n\n        #include <outine_vertex>\n        #include <uv2_vertex>\n        #include <color_vertex>\n        #include <beginnormal_vertex>\n\n        #ifdef CNORMAL\n            objectNormal = octDecode();\n        #endif\n        \n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        // #include <defaultnormal_vertex>\n        #include <defaultnormal_vertex_quantization>\n        // 实例的贴图不能直接先用uv_vertex中处理过的vUv，不然matrix相乘的顺序颠倒了\n        #if (defined(USE_MAP) || defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  \n          #include <uv_transform_vertex>\n        #endif\n\n        #if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))\n            #include <uv2_decode_vertex>\n        #endif\n        \n        #if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  \n           #include <uv2_offsetrepeat_vertex>\n        #endif\n\n        #include <packing_material_vertex>\n        #include <CloudStandardShader_Transform_pars_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <growthAnimation_vertex>\n        // #include <treeTrunkAnimation_instance_vertex>\n        // #include <treeLeavesAnimation_instance_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n        wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );\n\n        #include <heightLimit_vertex>\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n\n        vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n        \n        #include <view_shed_vertex>\n        #include <video_cast_vertex>\n        #include <excavation_vertex>\n        //addV3\n        #include <cloud_state_vertex>\n\n    }",THREE.ShaderChunk.cloudStandardFragmentV3="  \n    #include <CloudStandardUnf_pars_fragment>\n    #include <heightLimit_pars_fragment>\n    #include <toneMapCanonFilmic_pars_Fragment>\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <cube_uv_reflection_fragment>\n    #include <lights_pars_begin>\n    //r142\n    //#include <alphatest_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <csm_fragment>\n    #include <clipping_planes_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n    #include <view_shed_pars_fragment>\n    #include <video_cast_pars_fragment>\n    #include <excavation_pars_fragment>\n    //addV3\n    #include <cloud_state_defines>\n    #include <cloud_state_pars_fragment>\n    #include <hdrDecode_pars_Fragment>\n    #include <growthAnimation_pars_fragment>\n    #include <packing_material_pars_fragment>\n    #include <outline_pars_fragment>\n    \n    vec3 linearToGammaUnreal(in vec3 rgb) {\n         return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);\n    }\n\n    #include <compare_function>\n    #include <outline_function_pars_fragment_10>\n\n    void main() {\n        #include <innerClipping_fragment>\n        #include <growthAnimation_fragment>\n        \n        #define USE_PACKING_PIXEL0_W    1.0\n        #include <packing_material_fragment>\n\n        #include <use_fillpattern_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n        \n        #include <vertex_color_frag>\n        //addV3\n        #include <cloud_state_instance_color_v3_fragment>\n        #include <CompressColor_fragment>\n        #include <diffuseColor_Fragment>\n        //addV3\n        #include <cloud_state_fragment>\n\n        diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb,diffuseColor.a);\n        \n        #include <alphamap_fragment_override>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <emissivemap_fragment>\n\n        #ifdef USE_INSTANCE\n            #include <state_override_rough_n_metal_fragment>\n        #endif\n        #include <lights_physical_fragment>\n        // #include <lights_template>\n        //改动为光照贴图的lightMapIrradiance的计算,增加对比度\n        #include <incident_light_fragment>\n        #include <rect_area_light_fragment>\n        #include <re_indirect_diffuse_fragment>\n        #include <re_indirect_specular_fragment>\n        #include <specular_unuse_envMap_fragment>\n        #include <aomap_fragment>\n        #inlcude <diffuse_specular_emissive_fragment>\n        \n        vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n        gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        #defined COLORSTATE_BLINK_STATE ElementState_SELECT\n        #defined COLORSTATE_SELECT_STATE ElementState_BLINK\n        #include <gl_FragColor_pars_Fragment>\n\n        #include <cloudstandard_component_state_fragment>\n        #include <color_without_light_frag>\n        //addV3\n        #include <cloud_transparent_state_fragment>\n        #include <view_shed_fragment>\n        #include <video_cast_fragment>\n\n        #ifndef USE_LIGHTMAP\n          #include <encodings_fragment>\n        #endif\n\n        #include <heightLimit_fragment>\n        #include <excavation_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n        #include <cloudstandard_bc_outline_v3_fragment>\n        #include <fog_fragment>\n    }",THREE.ShaderChunk.cloudStandardBatchedVertexV3="\n    #define PHYSICAL\n    varying vec3 vViewPosition;\n    // #define CLOUDSTANDARDBATCHEDV3\n    #include <flat_shaded_pars_vertex>\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <view_shed_pars_vertex>\n    #include <video_cast_pars_vertex>\n    \n    varying vec4 wPositionForInnerClipping;\n    \n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <heightLimit_pars_vertex>\n    #include <excavation_pars_vertex>\n    //addV3\n    #include <cloud_state_pars_vertex>\n\n    #include <packing_material_pars_vertex>\n    #include <outline_pars_vertex>\n    #include <growthAnimation_pars_vertex>\n    \n\n    varying vec3 vPosition;\n\n    #include <compress_uv_pars_vertex>\n    #include <inverse_matrix_pars_vertex_quantization>\n    #include <matrix_transform_pars_vertex>\n\n    void main() {\n        // #include <uv_vertex>//BIMFACE-6940,BIMFACE-17859\n        #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )  || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n            \n            #include <compress_uv_vertex>\n        \n        #endif\n\n        #include <outine_vertex>\n        \n        #include <uv2_vertex>\n        #include <color_vertex>\n\n        #include <beginnormal_vertex>\n\n        #ifdef CNORMAL\n            objectNormal = octDecode();\n        #endif\n        \n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        // #include <defaultnormal_vertex>\n        #include <defaultnormal_vertex_quantization>\n\n        #if defined(USE_COMPRESS_UV) && ((defined(USE_LIGHTMAP) && defined(USE_COMPONENT_LIGHTMAP))|| defined(USE_AOMAP))\n            #include <uv2_decode_vertex>\n        #endif\n\n        #include <packing_material_vertex>\n\n        vec3 transformed = vec3( position ); \n\n        #include <CompressColor_vertex>\n        #include <flat_shaded_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n\n        #include <project_vertex>\n\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <growthAnimation_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n\n        wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );\n        vPosition = transformed;\n\n        #include <heightLimit_vertex>\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n\n        vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n        \n        #include <view_shed_vertex>\n        #include <video_cast_vertex>\n        #include <excavation_vertex>\n        //addV3\n        #include <cloud_state_vertex>\n\n    }",THREE.ShaderChunk.cloudStandardBatchedFragmentV3="  \n    #include <cloudstandard_v3_pars_fragment>\n    #include <flat_shaded_pars_fragment>\n\t#include <CompressColor_pars_fragment>\n  // #define CLOUDSTANDARDBATCHEDV3\n    #if defined(USE_MULTI_BLINK_COLOR) \n        varying vec4 vbColor;\n    #endif\n\n    #include <use_fillpattern_pars_fragment>\n    #include <heightLimit_pars_fragment>\n    #include <toneMapCanonFilmic_pars_Fragment>\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <cube_uv_reflection_fragment>\n    #include <lights_pars_begin>\n    //r142\n    //#include <alphatest_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <csm_fragment>\n    #include <clipping_planes_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n    #include <view_shed_pars_fragment>\n    #include <video_cast_pars_fragment>\n    #include <excavation_pars_fragment>\n    //addV3\n    #include <cloud_state_defines>\n    #include <cloud_state_pars_fragment>\n    #include <hdrDecode_pars_Fragment>\n\n    #include <packing_material_pars_fragment>\n    #include <growthAnimation_pars_fragment>\n\t\n\t#include <outline_pars_fragment>\n    #include <outline_function_pars_fragment>\n    #include <outline_function_fragment_get_line_tickness>\n\n\tvarying vec3 vPosition;\n    vec3 linearToGammaUnreal(in vec3 rgb) {\n         return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);\n    }\n\n    #include <compare_function>\n    #include <noise_function>\n    #include <ACESFilm_function_fragment>\n    #include <specular_unuse_envMap_pars_fragment>\n    #include <color_correction_pars_fragment> \n    \n    void main() {\n        \n        if (innerClipping > 0)\n        {   \n            #include <innerClipping_fragment>\n        }\n        else\n        {   \n            #include <num_clipping_planes_for_batched_fragment>\n        }\n        #include <growthAnimation_fragment>\n        #include <packing_material_fragment>\n        #include <use_fillpattern_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n        #include <vertex_color_frag>\n        //addV3\n        //#include <cloud_state_instance_color_v3_fragment>\n\n        #include <CompressColor_fragment>\n\n        // 选中的颜色，不受光照，曝光等影响，保持最初的颜色\n        vec4 selectedColor = diffuseColor;\n        vec4 withoutLightColor = diffuseColor;\n        #ifndef USE_LIGHTMAP\n           diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n        #endif\n\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n        vec3 totalEmissiveRadiance = emissive;\n\n        // BIMFACE-15305: 根据颜色创建的override材质emissive默认值为(0.0, 0.0, 0.0)\n        \n        totalEmissiveRadiance = mix(vec3(0.0), totalEmissiveRadiance, step(0.01, abs(componentState- ElementState_OVERRIDED)));\n\n        \n        #include <logdepthbuf_fragment>\n\n        vec4 gamaColor = diffuseColor ;//经过gamma处理\n        #ifdef USE_MAP\n\n           vec4 texelColor = texture2D( map, vUv );\n           texelColor = mapTexelToLinear( texelColor );\n           #ifdef USE_CLAMP_TO_BORDER\n               texelColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?diffuseColor:mapTexelToLinear( texelColor );\n           #endif\n\n           // BIMFACE-31308:\n           //diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);//mix color with texture mix(texelColor.rgb,diffuseColor.rgb , 0.0)\n           diffuseColor = vec4( mix(diffuseColor.rgb, texelColor.rgb, imageFade * texelColor.a), min(opacity, texelColor.a) );\n\n        #endif\n\n        //addV3\n        #if defined( USE_COLOR_ALPHA )\n            diffuseColor.a =  1.0 - vColor.a;\n        #endif\n\n        diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb,diffuseColor.a);\n\n        #include <cloud_global_opacity_fragment>\n        #include <cloud_state_fragment>\n        \n\n        #include <alphamap_fragment_override>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <emissivemap_fragment>\n        #include <noise_fragment>\n\n\n        #include <lights_physical_fragment>\n        // #include <lights_template>\n        //改动为光照贴图的lightMapIrradiance的计算,增加对比度\n        #include <incident_light_fragment>\n        #include <rect_area_light_fragment>\n        #include <re_indirect_diffuse_fragment>\n        #include <re_indirect_specular_fragment>\n        #include <specular_unuse_envMap_fragment>\n        #include <aomap_fragment>\n        #include <diffuse_specular_emissive_fragment>\n        \n        vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n        gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        #include <gl_FragColor_pars_Fragment>\n       \n        if (floatEqual(colorState, ShaderColorState_BLINK)) {\n            gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n        }\n\t\tif (floatEqual(colorState, ShaderColorState_SELECT))\n            gl_FragColor = selectedColor;\n\n\n       \n\n        \n\n           \n         \n\t\t \n\t\t \n\t\t //add,注释掉下面这句\n        //#include <tonemapping_fragment>\n        \n        #include <color_without_light_frag>\n        //addV3\n        #include <cloud_transparent_state_fragment>\n        #include <view_shed_fragment>\n        #include <video_cast_fragment>\n        //gl_FragColor.rgb = ACESFilm(gl_FragColor.rgb);\n        #include <color_correction_fragment>\n        #ifndef USE_LIGHTMAP\n          #include <encodings_fragment>\n        #endif\n\t\t\n        #include <heightLimit_fragment>\n        #include <excavation_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n        #include <outline_fragment>\n        #include <fog_fragment>\n        #include <clamp_color_alpha>\n    }",THREE.ShaderChunk.cloudStandardInstanceVertexV3="  \n    #define PHYSICAL\n    varying vec3 vViewPosition;\n    // #define CLOUDSTANDARDINSTANCEDV3\n    #include <flat_shaded_pars_vertex>\n    #include <cloudstandard_instance_v3_pars_vertex>\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <view_shed_pars_vertex>\n    #include <video_cast_pars_vertex>\n\n    varying vec4 wPositionForInnerClipping;\n\n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <heightLimit_pars_vertex>\n    #include <excavation_pars_vertex>\n    //addV3\n    #include <cloud_state_pars_vertex>\n    #include <matrix_transform_pars_vertex>\n\n    #include <packing_material_pars_vertex>\n    #include <outline_pars_vertex>\n    #include <growthAnimation_pars_vertex>\n    #include <treeLeavesAnimation_instance_pars_vertex>\n    #include <treeTrunkAnimation_instance_pars_vertex>\n\n    varying vec3 vPosition;\n\n    #include <compress_uv_pars_vertex>\n    #include <inverse_matrix_pars_vertex_quantization>\n\n    void main() {\n        // #include <uv_vertex>//BIMFACE-6940,BIMFACE-17859\n        #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )  || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n           \n            #include <compress_uv_vertex>\n        \n        #endif\n        #include <outine_vertex>\n        #include <uv2_vertex>\n        #include <color_vertex>\n        #include <beginnormal_vertex>\n\n        #ifdef CNORMAL\n            objectNormal = octDecode();\n        #endif\n\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        // #include <defaultnormal_vertex>\n        #include <defaultnormal_vertex_quantization>\n        //实例的贴图不能直接先用uv_vertex中处理过的vUv，不然matrix相乘的顺序颠倒了\n        #if (defined(USE_MAP)||defined(USE_BUMPMAP))\n           #include <uv_transform_vertex>\n        #endif\n\n        #if defined(USE_COMPRESS_UV) && ((defined(USE_LIGHTMAP) && defined(USE_COMPONENT_LIGHTMAP))|| defined(USE_AOMAP))\n            #include <uv2_decode_vertex>\n        #endif\n\n        #if defined(USE_LIGHTMAP)\n           #include <uv2_offsetrepeat_vertex>\n        #endif\n\n        #include <packing_material_vertex>\n\n        vec3 transformed = vec3( position );\n\n        vaColor = aColor;\n        #include <num_clipping_planes_vertex>\n\n        #if defined(USE_MULTI_BLINK_COLOR) \n            vbColor = bColor;\n        #endif\n\n        componentState = vState.x;\n\n        \n        #include <treeLeavesAnimation_instance_vertex>\n        #include <treeTrunkAnimation_instance_vertex>\n        #include <Transform_pars_vertex>\n        #include <cloudstandard_instance_normal_vertex>\n        #include <CompressColor_vertex>\n        #include <flat_shaded_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <growthAnimation_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n        wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );\n        vPosition = transformed;\n\n        #include <heightLimit_vertex>\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n\n        vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n\n        #include <view_shed_vertex>\n        #include <video_cast_vertex>\n        #include <excavation_vertex>\n        //addV3\n        #include <cloud_state_vertex>\n    }",THREE.ShaderChunk.cloudStandardInstanceFragmentV3="\n    #include <cloudstandard_v3_pars_fragment>\n    #include <flat_shaded_pars_fragment>\n    // #define CLOUDSTANDARDINSTANCEDV3\n    varying vec4 vaColor; \n    varying float fClipping;\n    #include <CompressColor_pars_fragment>\n    \n    #if defined(USE_MULTI_BLINK_COLOR) \n         varying vec4 vbColor;\n    #endif\n\n    #include <use_fillpattern_pars_fragment>\n    #include <heightLimit_pars_fragment>\n    #include <toneMapCanonFilmic_pars_Fragment>\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <cube_uv_reflection_fragment>\n    #include <lights_pars_begin>\n    //r142\n    //#include <alphatest_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <csm_fragment>\n    #include <clipping_planes_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n    #include <view_shed_pars_fragment>\n    #include <video_cast_pars_fragment>\n    #include <excavation_pars_fragment>\n    //addV3\n    #include <cloud_state_defines>\n    #include <cloud_state_pars_fragment>\n    #include <hdrDecode_pars_Fragment>\n\n    #include <packing_material_pars_fragment>\n    #include <growthAnimation_pars_fragment>\n\n\n    #include <outline_pars_fragment>\n    #include <outline_function_pars_fragment>\n    #include <outline_function_fragment_get_line_tickness>\n\n    varying vec3 vPosition;\n    vec3 linearToGammaUnreal(in vec3 rgb) {\n         return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);\n    }\n    #include <compare_function>\n    #include <noise_function>\n    #include <ACESFilm_function_fragment>\n    #include <specular_unuse_envMap_pars_fragment>\n    #include <color_correction_pars_fragment> \n    \n    void main() {\n        if (innerClipping > 0)\n        {\n            #include <innerClipping_fragment>\n        }\n        else\n        {\n            #include <num_clipping_planes_for_instance_fragment>\n        }\n        \n        #include <growthAnimation_fragment>\n\n        #include <packing_material_fragment>\n        #include <use_fillpattern_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n        #include <vertex_color_frag>\n        //addV3\n        #include <cloud_state_instance_color_v3_fragment>\n        #include <CompressColor_fragment>\n\n        // 选中的颜色，不受光照，曝光等影响，保持最初的颜色\n        vec4 selectedColor = diffuseColor;\n        vec4 withoutLightColor = diffuseColor;\n        #ifndef USE_LIGHTMAP\n           diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n        #endif\n\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n        vec3 totalEmissiveRadiance = emissive;\n        // BIMFACE-15305: 根据颜色创建的override材质emissive默认值为(0.0, 0.0, 0.0)\n        // 对于实例对象需要特殊处理:不使用原材质emissive值,而是直接使用默认值\n        totalEmissiveRadiance = mix(\n            vec3(0.0),\n            totalEmissiveRadiance,\n            step(0.01, abs(componentState - ElementState_OVERRIDED))\n        );\n\n        #include <logdepthbuf_fragment>\n        vec4 gamaColor = diffuseColor ;//经过gamma处理\n        #ifdef USE_MAP\n            vec4 texelColor = texture2D( map, vUv );\n            texelColor = mapTexelToLinear( texelColor );\n            #ifdef USE_CLAMP_TO_BORDER\n               texelColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?diffuseColor:mapTexelToLinear( texelColor );\n            #endif\n            // BIMFACE-31308:\n            //diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);//mix color with texture mix(texelColor.rgb,diffuseColor.rgb , 0.0)\n            diffuseColor = vec4( mix(diffuseColor.rgb, texelColor.rgb, imageFade * texelColor.a), min(opacity, texelColor.a));\n            diffuseColor.a = mix(diffuseColor.a, vaColor.a, step(0.01, abs(componentState - ElementState_NONE)));\n            diffuseColor = mix(gamaColor, diffuseColor, step(0.01, abs(componentState - ElementState_OVERRIDED)));\n\n            \n\n        #endif\n\n        diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb, diffuseColor.a);\n        //addV3\n        #include <cloud_state_instance_fragment>\n        \n        #include <alphamap_fragment_override>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <emissivemap_fragment>\n        #include <noise_fragment>\n        #include <state_override_rough_n_metal_fragment>\n\n        #include <lights_physical_fragment>\n        // #include <lights_template>\n        //改动为光照贴图的lightMapIrradiance的计算,增加对比度\n        #include <incident_light_fragment>\n        #include <rect_area_light_fragment>\n        #include <re_indirect_diffuse_fragment>\n        #include <re_indirect_specular_fragment>\n        #include <specular_unuse_envMap_fragment>\n        #include <aomap_fragment>\n        \n        vec3 diffuseSpecularEmissive = vec3(0.0);\n        #ifdef USE_LIGHTMAP\n           #ifdef USE_COMPONENT_LIGHTMAP\n               vec3 lightMapIrradiance = (texture2D(lightMap, vUv2)).rgb * lightMapIntensity;\n           #else\n               vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;\n           #endif\n            //#include <USE_LIGHTMAP_pars_Fragment>\n           vec3 diffuseSpecular =  clamp(diffuseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;\n           diffuseSpecularEmissive = diffuseSpecular + diffuseColor.rgb * 0.0;\n        #endif\n        \n        vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n        gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        #include <gl_FragColor_pars_Fragment>\n\n        gl_FragColor = mix(selectedColor, gl_FragColor, step(0.01, abs(componentState - ElementState_SELECTED)));\n\n        #if defined(USE_MULTI_BLINK_COLOR)\n            vec4 finBlinkColor = vbColor;\n        #else\n            vec4 finBlinkColor = blinkColor;\n        #endif\n        \n        gl_FragColor = mix(\n            mix(gl_FragColor, finBlinkColor, blinkCoefficient),\n            gl_FragColor,\n            clamp(step(0.01, abs(componentState - ElementState_BLINK) + abs(colorState - ShaderColorState_BLINK)), 0.0, 1.0)\n        );\n        // 对应上面的语句\n        // if (floatEqual(componentState, ElementState_BLINK) && floatEqual(colorState, ShaderColorState_BLINK)) {//if seleted, all are the same color;\n        //     gl_FragColor = mix(gl_FragColor, finBlinkColor, blinkCoefficient);\n        // }\n         //add,注释掉下面这句\n        //#include <tonemapping_fragment>\n        #include <color_without_light_frag>\n        //addV3\n        #include <cloud_transparent_state_fragment>\n        #include <view_shed_fragment>\n        #include <video_cast_fragment>\n        //gl_FragColor.rgb = ACESFilm(gl_FragColor.rgb);\n        #include <color_correction_fragment>\n        #ifndef USE_LIGHTMAP\n          #include <encodings_fragment>\n        #endif\n\n        #include <heightLimit_fragment>\n        #include <excavation_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n        #include <outline_fragment>\n        #include <fog_fragment>\n        #include <clamp_color_alpha>\n    }",THREE.ShaderChunk.cloudPMPhongVertex='\n    #define PHONG\n    #include <flat_shaded_pars_vertex>\n    #ifdef USE_INSTANCE\n       attribute vec4 vState;\n       #include <num_clipping_planes_pars_vertex>\n       varying float componentState;\n       attribute vec4 aColor;\n       varying vec4 vaColor;\n       attribute vec3 mcol0;\n       attribute vec3 mcol1;\n       attribute vec3 mcol2;\n       attribute vec3 mcol3;\n       #if defined(USE_MAP)||defined(USE_BUMPMAP)  \n           attribute vec4 muvCol0;\n           attribute vec2 muvCol1;\n         //   attribute vec2 muvCol2;\n       #endif \n       #if defined(USE_MULTI_BLINK_COLOR)  \n           attribute vec4 bColor;\n           varying vec4 vbColor;\n       #endif \n       #if defined(USE_LIGHTMAP) \n           attribute vec4 uv2OffsetRepeat;\n       #endif \n    #endif\n    varying vec3 vViewPosition;\n//    "varying vec3 vNormal;\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    //                "#include <normal_pars_vertex>\n    #include <common>\n    #include <logdepthbuf_pars_vertex>//log depth buffer\n    #include <shadowmap_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <clipping_planes_pars_vertex>\n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <inverse_matrix_pars_vertex_quantization>\n\n    varying vec4 wPositionForInnerClipping;\n    // uv3 pars\n    #include <packing_material_pars_vertex>\n    // end\n    #include <matrix_transform_pars_vertex>\n\n    //uv decode\n    #include <compress_uv_pars_vertex>\n\n    void main() { \n\n       #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP ) \n            #include <compress_uv_vertex>\n       #endif\n      \n       #include <uv_vertex>\n       #include <uv2_vertex>\n       #include <color_vertex>\n       #include <begin_vertex>\n\n    //"   #include <project_vertex>\n\n       #include <beginnormal_vertex>\n\n       #ifdef CNORMAL \n         objectNormal = octDecode();\n       #endif\n      //实例的贴图不能直接先用uv_vertex中处理过的vUv，不然matrix相乘的顺序颠倒了\n       #if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  \n          #include <uv_transform_vertex>\n       #endif\n       \n       #if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP)) \n         #include <uv2_decode_vertex>\n       #endif\n\n       #if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  \n          #include <uv2_offsetrepeat_vertex>\n       #endif\n\n      //  #include <defaultnormal_vertex>\n      #include <defaultnormal_vertex_quantization>\n\n //     vec3 transformed = vec3( position );\n\n       #ifdef USE_INSTANCE\n          vaColor = aColor;\n          #include <num_clipping_planes_vertex>\n          #if defined(USE_MULTI_BLINK_COLOR)\n             vbColor = bColor;\n          #endif\n          componentState = vState.x;\n          #include <Transform_pars_vertex>\n          #include <cloudstandard_instance_normal_vertex>\n       #endif\n\n       #include <CompressColor_vertex>\n       #include <flat_shaded_vertex>\n       #include <displacementmap_vertex>\n       #include <morphtarget_vertex>\n       #include <skinning_vertex>\n       #include <project_vertex>\n       #include <logdepthbuf_vertex>//must be after gl_position\'s computing\n       #include <clipping_planes_vertex>\n\n       vViewPosition = - mvPosition.xyz;\n       wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );\n\n       #include <packing_material_vertex>\n       #include <heightLimit_vertex>\n       #include <worldpos_vertex>\n       #include <shadowmap_vertex>\n       #include <fog_vertex>\n\n       vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n       \n       #include <view_shed_vertex>\n       #include <video_cast_vertex>\n       #include <excavation_vertex>\n    }',THREE.ShaderChunk.cloudPMPhongFragment="\n   #define PHONG\n   uniform vec3 diffuse;\n   uniform float opacity;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform vec3 emissive;\n\n   #include <common>\n   #include <uv_pars_fragment>\n   #include <uv2_pars_fragment>\n   #include <map_pars_fragment>\n\n   #include <aomap_pars_fragment>\n   #include <lightmap_pars_fragment>\n   #include <emissivemap_pars_fragment>\n   #include <envmap_pars_fragment>\n   #include <fog_pars_fragment>\n   #include <cloud_state_defines>\n\n   varying vec4 wPositionForInnerClipping;\n   uniform float shift;\n   uniform float A;\n   uniform float B;\n   uniform float C;\n   uniform float D;\n   uniform float E;\n   uniform float F;\n   uniform float scale;\n   uniform vec4 blinkColor;\n   uniform float blinkCoefficient;\n   uniform float colorState;\n   uniform int localClipping;\n   uniform int innerClipping;\n   uniform mat4 orthoViewProjMatrix;\n   uniform bool useForCap;\n\n   #include <packing>\n   #include <bsdfs>\n   #include <packing_material_pars_fragment>\n\n   #ifdef USE_INSTANCE\n      varying vec4 vaColor;\n      varying float componentState;\n      varying float fClipping;\n   #endif\n   \n   #include <CompressColor_pars_fragment>\n\n   #if defined(USE_MULTI_BLINK_COLOR)  \n      varying vec4 vbColor;\n   #endif\n\n   #include <use_fillpattern_pars_fragment>\n\n   //r142\n   //#include <normal_pars_fragment>\n   #include <cube_uv_reflection_fragment>\n   #include <lights_pars_begin>\n   #include <lights_phong_pars_fragment>\n   #include <specularmap_pars_fragment>\n   #include <shadowmap_pars_fragment>\n\n   #include <csm_fragment>\n   #include <clipping_planes_pars_fragment>\n\n   #include <logdepthbuf_pars_fragment>\n   #ifdef USE_CAP \n   uniform sampler2D backSceneTexture;\n   uniform vec2 viewportSize;\n   #endif\n\n   vec3 linearToGammaUnreal(in vec3 rgb) { \n      return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);\n   } \n\n   vec3 toneMapCanonFilmic(vec3 color) \n   { \n      color *= (1.0 / shift);\n      return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);\n   } \n\n   #include <compare_function>\n\n   void main() { \n\n      #include <innerClipping_pars_Fragment>\n\n      #define USE_PACKING_PIXEL1   1.0\n      #define USE_PACKING_PIXEL0_W 1.0\n      #include <packing_material_fragment>\n\n      vec4 diffuseColor = vec4( diffuse, opacity );\n\n      #ifdef USE_INSTANCE \n         if (floatEqual(componentState, ElementState_HIDDEN))  \n            discard;\n\n         #ifndef USE_COLOR \n               diffuseColor = mix(vec4(vaColor.xyz, opacity), diffuseColor, step(0.01, abs(componentState - ElementState_HIDDEN)));\n         #endif\n         diffuseColor = mix(diffuseColor, vaColor, step(0.01, abs(componentState - ElementState_NONE)));\n      #endif\n\n      #include <CompressColor_fragment>\n      #include <logdepthbuf_fragment>\n\n      // 选中的颜色，不受光照，曝光等影响，保持最初的颜色\n      vec4 selectedColor = diffuseColor;\n      vec4 withoutLightColor = diffuseColor;\n\n      #ifndef USE_LIGHTMAP \n         diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));\n      #endif\n\n      #ifdef USE_MAP \n         vec4 texelColor = texture2D( map, vUv );\n         texelColor = mapTexelToLinear( texelColor );\n         diffuseColor = vec4(texelColor.rgb, opacity);\n      #endif\n\n      ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n      vec3 totalEmissiveRadiance = emissive;\n      float specularStrength = 1.0;\n      #include <alphamap_fragment_override>\n      #include <alphatest_fragment>\n//       #include <specularmap_fragment>\n      #include <normal_fragment_begin>\n      #include <normal_fragment_maps>\n      #include <lights_phong_fragment>\n      #include <emissivemap_fragment>\n      #include <lights_template>\n\n      // 对于实例对象需要特殊处理:不使用原材质emissive值,而是直接使用默认值\n      #ifdef USE_INSTANCE \n         totalEmissiveRadiance = mix(vec3(0.0), totalEmissiveRadiance, step(0.01, abs(componentState - ElementState_OVERRIDED)));\n      #endif\n\n            \n      #include <aomap_fragment>\n\n      reflectedLight.directSpecular =  clamp(reflectedLight.directSpecular,vec3(0.0), vec3(1.0));\n      reflectedLight.indirectSpecular =  clamp(reflectedLight.indirectSpecular,vec3(0.0), vec3(1.0));\n\n      vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse  + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n      gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n      #if defined( TONE_MAPPING ) \n         #if defined(USE_LIGHTMAP) \n            gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );\n         #else\n            gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );\n         #endif\n      #endif\n\n      #ifdef USE_INSTANCE\n         gl_FragColor = mix(selectedColor, gl_FragColor, step(0.01, abs(componentState - ElementState_SELECTED)));\n\n         #if defined(USE_MULTI_BLINK_COLOR) \n            vec4 finBlinkColor = vbColor;\n         #else\n            vec4 finBlinkColor = blinkColor;\n         #endif\n         gl_FragColor = mix(\n            mix(gl_FragColor, finBlinkColor, blinkCoefficient), \n            gl_FragColor, \n            clamp(step(0.01, abs(componentState - ElementState_BLINK)) + step(0.01, abs(colorState - ShaderColorState_BLINK)), 0.0, 1.0)\n         );\n      #else\n         gl_FragColor = mix(\n            mix(gl_FragColor, blinkColor, blinkCoefficient), \n            gl_FragColor, \n            step(0.01, abs(colorState - ShaderColorState_BLINK))\n         );\n         gl_FragColor = mix(selectedColor, gl_FragColor, step(0.01, colorState - ShaderColorState_SELECT));\n      #endif\n\n      #include <color_without_light_frag>\n      #include <view_shed_fragment>\n      #include <video_cast_fragment>\n\n      #ifndef USE_LIGHTMAP \n         #include <encodings_fragment>\n      #endif\n\n      #include <heightLimit_fragment>\n      #include <excavation_fragment>\n\n      #include <premultiplied_alpha_fragment>\n      #include <dithering_fragment>\n      #include <fog_fragment>\n\n\n      #ifdef USE_CAP \n         vec2 screenUV = vec2(gl_FragCoord.x / viewportSize.x, gl_FragCoord.y / viewportSize.y);\n         vec4 backColor = texture2D(backSceneTexture, screenUV);\n         gl_FragColor = texture2D(backSceneTexture, screenUV);\n      #endif\n      //gl_FragColor = vec4(1.0,0.0,0.0,1.0);\n   }",THREE.ShaderChunk.newStyleVertex="\n\n    #define PHYSICAL\n    varying vec3 vViewPosition;\n\n    #include <flat_shaded_pars_vertex>\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n\n    void main() {\n\n        #include <uv_vertex>\n        #include <uv2_vertex>\n        #include <color_vertex>\n\n        #include <beginnormal_vertex>\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        #include <defaultnormal_vertex>\n\n        #include <flat_shaded_vertex>\n\n        #include <begin_vertex>\n        #include <displacementmap_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n    }\n",THREE.ShaderChunk.newStyleFragment="\n\n    #define PHYSICAL\n\n    uniform vec3 diffuse;\n    uniform vec3 emissive;\n    uniform float roughness;\n    uniform float metalness;\n    uniform float opacity;\n\n    #ifndef STANDARD\n        uniform float clearCoat;\n        uniform float clearCoatRoughness;\n    #endif\n\n    varying vec3 vViewPosition;\n\n    #include <flat_shaded_pars_fragment>\n\n    #include <common>\n    #include <packing>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <uv2_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <cube_uv_reflection_fragment>\n    #include <lights_pars_begin>\n    #include <lights_physical_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n\n        #include <clipping_planes_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n        vec3 totalEmissiveRadiance = emissive;\n\n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        //r142\n        //#include <alphatest_pars_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_flip>\n        #include <normal_fragment_begin>\n        #include <emissivemap_fragment>\n\n\t\tconst mat4 diffuseMatrix = mat4(-0.07425443828105927, -0.05652861297130585, 0.12247831374406815, 0.2297295778989792,\n                                        -0.05652860924601555, 0.034799136221408844, -0.08437120914459229, -0.13896968960762024,\n                                        0.12247832119464874, -0.08437121659517288, 0.021763987839221954, 0.12510454654693604,\n                                        0.2297295778989792, -0.13896968960762024, 0.12510454654693604, 0.6190560460090637);\n\n        const vec3 sunDir = vec3(-0.6632131338119507, 0.5486575961112976, -0.509041428565979);\n        vec3 viewDir = normalize( vViewPosition );\n\n        vec4 diffuseDir = diffuseMatrix * vec4(normal, 1.0);\n        float diffuseTerm = dot(vec4(normal, 1.0), diffuseDir);\n        float nv = max(dot(normal, -viewDir), 0.0);\n        float vl = max(dot(viewDir, sunDir), 0.0);\n        diffuseTerm = diffuseTerm + (nv * (1.0 - vl)) * 0.8;\n\n        vec3 H = -normalize(sunDir + viewDir);\n        float nh = max(dot(normal, H), 0.0);\n        float specularTerm = pow(nh, 100.0);\n        vec3 color = 1.05 * vec3(0.5, 0.497, 0.49) * (diffuse * diffuseTerm + vec3(specularTerm)) + diffuse * 0.5;\n\n        vec3 outgoingLight = color + totalEmissiveRadiance;\n        gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n        #include <fog_fragment>\n    }",THREE.ShaderChunk.view_shed_pars_vertex=r.ViewshedShader.view_shed_pars_vertex,THREE.ShaderChunk.view_shed_pars_fragment=r.ViewshedShader.view_shed_pars_fragment,THREE.ShaderChunk.view_shed_vertex=r.ViewshedShader.view_shed_vertex,THREE.ShaderChunk.view_shed_fragment=r.ViewshedShader.view_shed_fragment,THREE.ShaderChunk.video_cast_pars_vertex=r.VideoCastShader.video_cast_pars_vertex,THREE.ShaderChunk.video_cast_pars_fragment=r.VideoCastShader.video_cast_pars_fragment,THREE.ShaderChunk.video_cast_vertex=r.VideoCastShader.video_cast_vertex,THREE.ShaderChunk.video_cast_fragment=r.VideoCastShader.video_cast_fragment,THREE.ShaderChunk.heightLimit_pars_vertex=r.HeightLimitShader.heightLimit_pars_vertex,THREE.ShaderChunk.heightLimit_vertex=r.HeightLimitShader.heightLimit_vertex,THREE.ShaderChunk.heightLimit_pars_fragment=r.HeightLimitShader.heightLimit_pars_fragment,THREE.ShaderChunk.heightLimit_fragment=r.HeightLimitShader.heightLimit_fragment,THREE.ShaderChunk.excavation_pars_vertex=r.ExcavationShader.excavation_pars_vertex,THREE.ShaderChunk.excavation_pars_fragment=r.ExcavationShader.excavation_pars_fragment,THREE.ShaderChunk.excavation_vertex=r.ExcavationShader.excavation_vertex,THREE.ShaderChunk.excavation_fragment=r.ExcavationShader.excavation_fragment,THREE.ShaderChunk.polygonclimpground_pars_vertex=r.PolygonClimpGroundShader.polygonclimpground_pars_vertex,THREE.ShaderChunk.polygonclimpground_pars_fragment=r.PolygonClimpGroundShader.polygonclimpground_pars_fragment,THREE.ShaderChunk.polygonclimpground_vertex=r.PolygonClimpGroundShader.polygonclimpground_vertex,THREE.ShaderChunk.polygonclimpground_fragment=r.PolygonClimpGroundShader.polygonclimpground_fragment,THREE.ShaderChunk.polygonclimpground_pars_fragment_ground=r.PolygonClimpGroundShader.polygonclimpground_pars_fragment_ground,THREE.ShaderChunk.polygonclimpground_fragment_ground=r.PolygonClimpGroundShader.polygonclimpground_fragment_ground,THREE.ShaderChunk.oblique_photography_vertex=r.ObliquePhotographyShader.vertex,THREE.ShaderChunk.oblique_photography_fragment=r.ObliquePhotographyShader.fragment,THREE.ShaderChunk.map_tile_vertex=r.MapTileShader.vertex,THREE.ShaderChunk.map_tile_fragment=r.MapTileShader.fragment,THREE.ShaderChunk.points_vertex=r.PointsShader.vertex,THREE.ShaderChunk.points_fragment=r.PointsShader.fragment,THREE.ShaderChunk.depth_parse_fragment=r.DepthParseShader.depth_parse_fragment,THREE.ShaderChunk.csm_fragment=r.CSMShader.csm_fragment,THREE.ShaderChunk.lights_fragment_begin=D(THREE.ShaderChunk.lights_fragment_begin,"directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","directLight.color *= vec3(0.25);"),THREE.ShaderChunk.CompressNormal_pars_vertex=r.CompressNormalShader.CompressNormal_pars_vertex,THREE.ShaderChunk.CompressNormal_vertex=r.CompressNormalShader.CompressNormal_vertex,THREE.ShaderChunk.CompressColor_pars_vertex=r.CompressColorShader.CompressColor_pars_vertex,THREE.ShaderChunk.vertex_color_frag=r.VertexColorFrag.vertex_color_frag,THREE.ShaderChunk.alphamap_fragment_override="#if defined(USE_MAP)&&defined(USE_ALPHAMAP)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdiffuseColor.a *= texture2D( map, vUv ).a;\n\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t",THREE.ShaderChunk.shadowmap_pars_fragment=r.ShadowMapShader.shadowmap_pars_fragment,THREE.ShaderChunk.depth_frag=r.DepthFragShader.depth_frag,THREE.ShaderChunk.cloud_mesh_physical_frag=D(THREE.ShaderChunk.meshphysical_frag,"#include <alphamap_fragment>","#include <alphamap_fragment_override>"),THREE.ShaderChunk.cloud_mesh_basic_frag=D(THREE.ShaderChunk.meshbasic_frag,"#include <alphamap_fragment>","#include <alphamap_fragment_override>"),THREE.ShaderChunk.cloud_line_basic_frag=D(THREE.ShaderChunk.meshbasic_frag,"#include <color_fragment>","#include <vertex_color_frag>"),THREE.ShaderChunk.cloud_line_basic_frag=D(THREE.ShaderChunk.cloud_line_basic_frag,"#include <encodings_fragment>",""),THREE.ShaderChunk.inverse_matrix_pars_vertex_quantization=r.CommonShader.inverse_matrix_pars_vertex_quantization,THREE.ShaderChunk.defaultnormal_vertex_quantization=r.CommonShader.defaultnormal_vertex_quantization,THREE.ShaderChunk.defaultnormal_instance_vertex_quantization=r.CommonShader.defaultnormal_instance_vertex_quantization,THREE.ShaderChunk.getnormalmatrix_instance_vertex_quantization=r.CommonShader.getnormalmatrix_instance_vertex_quantization,THREE.ShaderChunk.matrix_transform_pars_vertex=r.CommonShader.matrix_transform_pars_vertex,THREE.ShaderChunk.get_instance_position_pars_vertex=r.CommonShader.get_instance_position_pars_vertex,THREE.ShaderChunk.USE_COMPRESS_UV_pars_vertex=r.CommonShader.USE_COMPRESS_UV_pars_vertex,THREE.ShaderChunk.Transform_pars_vertex=r.CommonShader.Transform_pars_vertex,THREE.ShaderChunk.IBLShader_Transform_pars_vertex=r.CommonShader.IBLShader_Transform_pars_vertex,THREE.ShaderChunk.CloudStandardShader_Transform_pars_vertex=r.CommonShader.CloudStandardShader_Transform_pars_vertex,THREE.ShaderChunk.toneMapCanonFilmic_pars_Fragment=r.CommonShader.toneMapCanonFilmic_pars_Fragment,THREE.ShaderChunk.hdrDecode_pars_Fragment=r.CommonShader.hdrDecode_pars_Fragment,THREE.ShaderChunk.USE_LIGHTMAP_pars_Fragment=r.CommonShader.USE_LIGHTMAP_pars_Fragment,THREE.ShaderChunk.USE_INSTANCE_pars_Vertex=r.CommonShader.USE_INSTANCE_pars_Vertex,THREE.ShaderChunk.USE_COMPRESS_UV=r.CommonShader.USE_COMPRESS_UV,THREE.ShaderChunk.varying_pars=r.CommonShader.varying_pars,THREE.ShaderChunk.clipping_pars=r.CommonShader.clipping_pars,THREE.ShaderChunk.maos_pars=r.CommonShader.maos_pars,THREE.ShaderChunk.iblMaps_pars=r.CommonShader.iblMaps_pars,THREE.ShaderChunk.lighting_pars=r.CommonShader.lighting_pars,THREE.ShaderChunk.toneMap_pars=r.CommonShader.toneMap_pars,THREE.ShaderChunk.IBLUniform_pars_Fragment=r.CommonShader.IBLUniform_pars_Fragment,THREE.ShaderChunk.IBLEnable_pars_fragment=r.CommonShader.IBLEnable_pars_fragment,THREE.ShaderChunk.NUM_CLIPPING_PLANES_fragment=r.CommonShader.NUM_CLIPPING_PLANES_fragment,THREE.ShaderChunk.baseColor_pars_fragment=r.CommonShader.baseColor_pars_fragment,THREE.ShaderChunk.cloudstandard_instance_v3_pars_vertex=r.CommonShader.cloudstandard_instance_v3_pars_vertex,THREE.ShaderChunk.cloudstandard_instance_normal_vertex=r.CommonShader.cloudstandard_instance_normal_vertex,THREE.ShaderChunk.cloudstandard_v3_pars_fragment=r.CommonShader.cloudstandard_v3_pars_fragment,THREE.ShaderChunk.DirationLights_pars_Fragment=r.CommonShader.DirationLights_pars_Fragment,THREE.ShaderChunk.PointLights_pars_Fragment=r.CommonShader.PointLights_pars_Fragment,THREE.ShaderChunk.SpotLights_pars_Fragment=r.CommonShader.SpotLights_pars_Fragment,THREE.ShaderChunk.innerClipping_common_fragment=r.CommonShader.innerClipping_common_fragment,THREE.ShaderChunk.diffuseColor_Fragment=r.CommonShader.diffuseColor_Fragment,THREE.ShaderChunk.directLight_pars_Fragment=r.CommonShader.directLight_pars_Fragment,THREE.ShaderChunk.gl_FragColor_pars_Fragment=r.CommonShader.gl_FragColor_pars_Fragment,THREE.ShaderChunk.cloudstandard_component_state_fragment=r.CommonShader.cloudstandard_component_state_fragment,THREE.ShaderChunk.CloudStandardUnf_pars_fragment=r.CommonShader.CloudStandardUnf_pars_fragment,THREE.ShaderChunk.compare_function=r.CommonShader.compare_function,THREE.ShaderChunk.outline_Fragment=r.CommonShader.outline_Fragment,THREE.ShaderChunk.noise_function=r.CommonShader.noise_function,THREE.ShaderChunk.noise_fragment=r.CommonShader.noise_fragment,THREE.ShaderChunk.ACESFilm_function_fragment=r.CommonShader.ACESFilm_function_fragment,THREE.ShaderChunk.outline_pars_Fragment=r.CommonShader.outline_pars_Fragment,THREE.ShaderChunk.outline_Vertex=r.CommonShader.outline_Vertex,THREE.ShaderChunk.outline_pars_Vertex=r.CommonShader.outline_pars_Vertex,THREE.ShaderChunk.packingMaterial_Fragment=r.CommonShader.packingMaterial_Fragment,THREE.ShaderChunk.packingMaterial_pars_Fragment=r.CommonShader.packingMaterial_pars_Fragment,THREE.ShaderChunk.packingMaterial_Vertex=r.CommonShader.packingMaterial_Vertex,THREE.ShaderChunk.packingMaterial_pars_Vertex=r.CommonShader.packingMaterial_pars_Vertex,THREE.ShaderChunk.specular_unuse_envMap_pars_fragment=r.CommonShader.specular_unuse_envMap_pars_fragment,THREE.ShaderChunk.specular_unuse_envMap_fragment=r.CommonShader.specular_unuse_envMap_fragment,THREE.ShaderChunk.bumpmap_pars_fragment=r.CommonShader.bumpmap_pars_fragment,THREE.ShaderChunk.color_correction_pars_fragment=r.CommonShader.color_correction_pars_fragment,THREE.ShaderChunk.color_correction_fragment=r.CommonShader.color_correction_fragment,THREE.ShaderChunk.color_without_light_frag=r.ColorWithoutLightFrag.color_without_light_frag,THREE.ShaderChunk.flat_shaded_pars_vertex=r.ShaderChunk.FlatShadedShader.flat_shaded_pars_vertex,THREE.ShaderChunk.flat_shaded_vertex=r.ShaderChunk.FlatShadedShader.flat_shaded_vertex,THREE.ShaderChunk.flat_shaded_tangent_pars_fragment=r.ShaderChunk.FlatShadedShader.flat_shaded_tangent_pars_fragment,THREE.ShaderChunk.flat_shaded_pars_fragment=r.ShaderChunk.FlatShadedShader.flat_shaded_pars_fragment,THREE.ShaderChunk.direction_light_fragment=r.ShaderChunk.LightsShader.direction_light_fragment,THREE.ShaderChunk.point_light_fragment=r.ShaderChunk.LightsShader.point_light_fragment,THREE.ShaderChunk.incident_light_fragment=r.ShaderChunk.LightsShader.incident_light_fragment,THREE.ShaderChunk.spot_light_fragment=r.ShaderChunk.LightsShader.spot_light_fragment,THREE.ShaderChunk.rect_area_light_fragment=r.ShaderChunk.LightsShader.rect_area_light_fragment,THREE.ShaderChunk.re_indirect_diffuse_fragment=r.ShaderChunk.LightsShader.re_indirect_diffuse_fragment,THREE.ShaderChunk.re_indirect_specular_fragment=r.ShaderChunk.LightsShader.re_indirect_specular_fragment,THREE.ShaderChunk.diffuse_specular_emissive_fragment=r.ShaderChunk.LightsShader.diffuse_specular_emissive_fragment,THREE.ShaderChunk.diffuse_specular_emissive_IBL_fragment=r.ShaderChunk.LightsShader.diffuse_specular_emissive_IBL_fragment,THREE.ShaderChunk.shadowmask_pars_fragment=r.ShaderChunk.shadowmask_pars_fragment,THREE.ShaderChunk.packing_material_pars_vertex=r.ShaderChunk.PackingMaterialShader.packing_material_pars_vertex,THREE.ShaderChunk.packing_material_vertex=r.ShaderChunk.PackingMaterialShader.packing_material_vertex,THREE.ShaderChunk.packing_material_pars_fragment=r.ShaderChunk.PackingMaterialShader.packing_material_pars_fragment,THREE.ShaderChunk.packing_material_fragment=r.ShaderChunk.PackingMaterialShader.packing_material_fragment,THREE.ShaderChunk.outline_pars_vertex=r.ShaderChunk.OutlineShader.outline_pars_vertex,THREE.ShaderChunk.outine_vertex=r.ShaderChunk.OutlineShader.outine_vertex,THREE.ShaderChunk.outline_pars_fragment=r.ShaderChunk.OutlineShader.outline_pars_fragment,THREE.ShaderChunk.outline_function_pars_fragment=r.ShaderChunk.OutlineShader.outline_function_pars_fragment,THREE.ShaderChunk.outline_function_pars_fragment_10=r.ShaderChunk.OutlineShader.outline_function_pars_fragment_10,THREE.ShaderChunk.outline_function_fragment_get_line_tickness=r.ShaderChunk.OutlineShader.outline_function_fragment_get_line_tickness,THREE.ShaderChunk.outline_fragment=r.ShaderChunk.OutlineShader.outline_fragment,THREE.ShaderChunk.cloudstandard_bc_outline_v3_fragment=r.ShaderChunk.OutlineShader.cloudstandard_bc_outline_v3_fragment,THREE.ShaderChunk.clamp_color_alpha=r.CommonShader.clamp_color_alpha,THREE.ShaderChunk.compress_uv_pars_vertex=r.ShaderChunk.CompressUV.compress_uv_pars_vertex,THREE.ShaderChunk.compress_uv_vertex=r.ShaderChunk.CompressUV.compress_uv_vertex,THREE.ShaderChunk.num_clipping_planes_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_fragment,THREE.ShaderChunk.num_clipping_planes_for_clip_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_clip_fragment,THREE.ShaderChunk.num_clipping_planes_for_stencil_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_stencil_fragment,THREE.ShaderChunk.num_clipping_planes_for_particle_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_particle_fragment,THREE.ShaderChunk.num_clipping_planes_for_bimtilepick_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_bimtilepick_fragment,THREE.ShaderChunk.innerClipping_fragment=r.ShaderChunk.ClippingPlanesShader.innerClipping_fragment,THREE.ShaderChunk.num_clipping_planes_for_bimtilepick_instance_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planenum_clipping_planes_for_bimtilepick_instance_fragments_fragment,THREE.ShaderChunk.num_clipping_planes_for_batched_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_batched_fragment,THREE.ShaderChunk.num_clipping_planes_for_instance_fragment=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_for_instance_fragment,THREE.ShaderChunk.num_clipping_planes_pars_vertex=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_pars_vertex,THREE.ShaderChunk.num_clipping_planes_vertex=r.ShaderChunk.ClippingPlanesShader.num_clipping_planes_vertex,THREE.ShaderChunk.CompressColor_vertex=r.CompressColorShader.CompressColor_vertex,THREE.ShaderChunk.CompressColor_pars_fragment=r.CompressColorShader.CompressColor_pars_fragment,THREE.ShaderChunk.CompressColor_fragment=r.CompressColorShader.CompressColor_fragment,THREE.ShaderChunk.uv_transform_vertex=r.ShaderChunk.UVShader.uv_transform_vertex,THREE.ShaderChunk.uv2_decode_vertex=r.ShaderChunk.UVShader.uv2_decode_vertex,THREE.ShaderChunk.uv2_offsetrepeat_vertex=r.ShaderChunk.UVShader.uv2_offsetrepeat_vertex,THREE.ShaderChunk.use_fillpattern_pars_fragment=r.ShaderChunk.FillPatternShader.use_fillpattern_pars_fragment,THREE.ShaderChunk.use_fillpattern_fragment=r.ShaderChunk.FillPatternShader.use_fillpattern_fragment,THREE.ShaderChunk.state_hidden_fragment=r.ShaderChunk.ComponentStateShader.state_hidden_fragment,THREE.ShaderChunk.state_override_rough_n_metal_fragment=r.ShaderChunk.ComponentStateShader.state_override_rough_n_metal_fragment,THREE.ShaderChunk.state_override_emissive_fragment=r.ShaderChunk.ComponentStateShader.state_override_emissive_fragment,THREE.ShaderChunk.state_override_diffuseColor=r.ShaderChunk.ComponentStateShader.state_override_diffuseColor,THREE.ShaderChunk.cloud_state_defines=r.CloudStateShader.cloud_state_defines,THREE.ShaderChunk.cloud_state_pars_vertex=r.CloudStateShader.cloud_state_pars_vertex,THREE.ShaderChunk.cloud_state_pars_fragment=r.CloudStateShader.cloud_state_pars_fragment,THREE.ShaderChunk.cloud_state_vertex=r.CloudStateShader.cloud_state_vertex,THREE.ShaderChunk.cloud_state_fragment=r.CloudStateShader.cloud_state_fragment,THREE.ShaderChunk.cloud_state_instance_fragment=r.CloudStateShader.cloud_state_instance_fragment,THREE.ShaderChunk.cloud_state_instance_color_v3_fragment=r.CloudStateShader.cloud_state_instance_color_v3_fragment,THREE.ShaderChunk.cloud_state_instance_color_fragment=r.CloudStateShader.cloud_state_instance_color_fragment,THREE.ShaderChunk.cloud_transparent_state_fragment=r.CloudStateShader.cloud_transparent_state_fragment,THREE.ShaderChunk.cloud_wire_frame_state_fragment=r.CloudStateShader.cloud_wire_frame_state_fragment,THREE.ShaderChunk.cloud_global_opacity_pars_fragment=r.CloudStateShader.cloud_global_opacity_pars_fragment,THREE.ShaderChunk.cloud_global_opacity_fragment=r.CloudStateShader.cloud_global_opacity_fragment,THREE.ShaderChunk.groundDrawing_pars_vertex=r.GroundDrawingShader.groundDrawing_pars_vertex,THREE.ShaderChunk.groundDrawing_pars_fragment=r.GroundDrawingShader.groundDrawing_pars_fragment,THREE.ShaderChunk.groundDrawing_vertex=r.GroundDrawingShader.groundDrawing_vertex,THREE.ShaderChunk.groundDrawing_fragment=r.GroundDrawingShader.groundDrawing_fragment,THREE.ShaderChunk.groundDrawing_fragment_getColor=r.GroundDrawingShader.groundDrawing_fragment_getColor,THREE.ShaderChunk.growthAnimation_pars_vertex=r.GrowthAnimationShader.growthAnimation_pars_vertex,THREE.ShaderChunk.growthAnimation_vertex=r.GrowthAnimationShader.growthAnimation_vertex,THREE.ShaderChunk.growthAnimation_pars_fragment=r.GrowthAnimationShader.growthAnimation_pars_fragment,THREE.ShaderChunk.growthAnimation_fragment=r.GrowthAnimationShader.growthAnimation_fragment,THREE.ShaderChunk.treeTrunkAnimation_instance_pars_vertex=r.TreeTrunkAnimationShader.treeTrunkAnimation_instance_pars_vertex,THREE.ShaderChunk.treeTrunkAnimation_instance_vertex=r.TreeTrunkAnimationShader.treeTrunkAnimation_instance_vertex,THREE.ShaderChunk.treeLeavesAnimation_instance_pars_vertex=r.TreeLeavesAnimationShader.treeLeavesAnimation_instance_pars_vertex,THREE.ShaderChunk.treeLeavesAnimation_instance_vertex=r.TreeLeavesAnimationShader.treeLeavesAnimation_instance_vertex,THREE.ShaderLib.background={uniforms:{uvTransform:{value:new THREE.Matrix3},t2D:{value:null}},vertexShader:"\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n\t#include <clipping_planes_pars_vertex>\n\t\n\tvoid main() {\n\t\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t\t#include <begin_vertex>\n\t\t#include <project_vertex>\n\t\t#include <clipping_planes_vertex>\n\t\t\n\t\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n\t\n\t}\n\t",fragmentShader:"\n\tuniform sampler2D t2D;\n\t\n\tvarying vec2 vUv;\n\t#include <clipping_planes_pars_fragment>\n\tvoid main() {\n\t\t#include <clipping_planes_fragment>\n\t\n\t\tvec4 texColor = texture2D( t2D, vUv );\n\t\n\t\tgl_FragColor = texColor;\n\t\t//r142\n\t\tgl_FragColor = mapTexelToLinear( texColor );\n\t\n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n\t\n\t}\n\t"},THREE.ShaderLib.fillFacePhong={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.gradientmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,{emissive:{value:new THREE.Color(0)},specular:{value:new THREE.Color(1118481)},shininess:{value:30}}]),vertexShader:THREE.ShaderChunk.meshphong_id_vert,fragmentShader:THREE.ShaderChunk.fillFaceFragment},THREE.ShaderLib.newStyle={vertexShader:THREE.ShaderChunk.newStyleVertex,fragmentShader:THREE.ShaderChunk.newStyleFragment},THREE.ShaderLib.cloudStandard={vertexShader:THREE.ShaderChunk.cloudStandardVertex,fragmentShader:THREE.ShaderChunk.cloudStandardFragment},r.WaterShader={uniforms:{waterColor:{type:"v4",value:null},reflectivity:{type:"f",value:0},flowTime:{type:"f",value:0},tReflectionMap:{type:"t",value:null},tRefractionMap:{type:"t",value:null},tNormalMap0:{type:"t",value:null},tNormalMap1:{type:"t",value:null},textureMatrix:{type:"m4",value:null},config:{type:"v4",value:new THREE.Vector4},sunDirection:{type:"v3",value:new THREE.Vector3}},vertexShader:"\n        #include <fog_pars_vertex>\n\n        uniform mat4 textureMatrix;\n\n        varying vec4 vCoord;\n        varying vec2 vUv;\n        varying vec2 worldPositionXZ;\n        varying vec3 vToEye;\n        //add clip part\n        #include <clipping_planes_pars_vertex>\n        #include <common>\n        //log depth buffer\n        #include <logdepthbuf_pars_vertex>\n\n        void main() {\n            vUv = uv;\n            vCoord = textureMatrix * vec4( position, 1.0 );\n            vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n            worldPositionXZ = (worldPosition.xz/worldPosition.w);\n\n            #ifdef USE_GLOBE\n                worldPositionXZ = worldPositionXZ*max(1.0,pow(cameraPosition.y,0.05));\n            #endif\n\n            vToEye = cameraPosition - worldPosition.xyz;\n            // used in fog_vertex\n            gl_Position = projectionMatrix * (viewMatrix * worldPosition);\n\n            #include <logdepthbuf_vertex>\n            \n            vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n            \n            #include <clipping_planes_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        #include <common>\n        #include <fog_pars_fragment>\n\n        #ifdef USE_SHADOW\n            uniform sampler2D tReflectionMap;\n             uniform sampler2D tRefractionMap;\n        #endif\n\n        #ifdef USE_FLOWMAP\n              uniform sampler2D tFlowMap;\n        #else\n             uniform vec2 flowDirection;\n        #endif\n\n        const vec3 sunColor = vec3(1.0, 0.9803921568627451,0.803921568627451);\n        uniform sampler2D tNormalMap0;\n        uniform sampler2D tNormalMap1;\n        uniform vec4 waterColor;\n        uniform float reflectivity;\n        uniform vec4 config;\n        uniform float flowTime;\n\n        uniform vec3 sunDirection;\n\n        #include <clipping_planes_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n\n        varying vec4 vCoord;\n        varying vec2 vUv;\n        varying vec3 vToEye;\n        varying vec2 worldPositionXZ;\n\n        void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection,in vec3 sunDir, inout vec3 diffuseColor, inout vec3 specularColor) {\n            float diffuse = 0.5;\n            vec3 _sunDir = normalize(sunDir);\n            vec3 reflection = normalize( reflect( -_sunDir, surfaceNormal ) );\n            diffuseColor += max( dot( _sunDir, surfaceNormal ), 0.0 ) * sunColor * diffuse;\n            //反光计算\n            float direction = max( 0.0, dot( eyeDirection, reflection ) );\n            specularColor += pow(direction, 300.0) * sunColor;\n        }\n\n        vec4 getNoise( vec2 uv, sampler2D normalSampler,float time) {\n            vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);\n            vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );\n            vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );\n            vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );\n            vec4 noise = texture2D( normalSampler, uv0 ) +\n                texture2D( normalSampler, uv1 ) +\n                texture2D( normalSampler, uv2 ) +\n                texture2D( normalSampler, uv3 );\n            return noise * 0.5 - 1.0;\n        }\n\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            //         gl_FragColor = vec4(config.xyz, 1.0);\n            //         return;\n\n            float flowMapOffset0 = config.x;\n            float flowMapOffset1 = config.y;\n            float halfCycle = config.z;\n            //反光密集\n            float scale = config.w*10.0;\n            vec3 toEye = normalize( vToEye );\n\n            // 判断使用图片还是vec2，决定水的流向\n            vec2 flow;\n            #ifdef USE_FLOWMAP\n                flow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;\n            #else\n                flow = flowDirection;\n            #endif\n            flow.x *= - 1.0;\n\n            // 两个法线贴图uv获取，加上水流动之后偏移\n            vec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );\n            vec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );\n\n            // linear interpolate to get the final normal color\n            float flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;\n            vec4 normalColor = mix( normalColor0, normalColor1, flowLerp );\n\n            // calculate normal vector\n            vec3 normal = normalize(normalColor.rbg * vec3(2.0, 1.0, 2.0) - vec3(1.0, 0.0, 1.0));\n            // vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 )  \n\n            // calculate the fresnel term to blend reflection and refraction maps\n            float theta = max( dot( toEye, normal ), 0.0 );\n            float reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );\n\n            // calculate final uv coords\n            vec3 coord = vCoord.xyz / vCoord.w;\n            vec2 uvReflect = coord.xy + coord.z * normal.xz * 0.03;\n            vec2 uvRefract = coord.xy + coord.z * normal.xz * 0.01;\n\n            vec4 reflectColor;\n            vec4 refractColor;\n\n            #ifdef USE_FLOWMAP\n                reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uvReflect.x, uvReflect.y ));\n            #endif\n\n            #ifdef USE_SHADOW\n\n                refractColor = mix(\n                texture2D( tRefractionMap, uvRefract ),\n                refractColor,\n                step(1.0, waterColor.a)\n                );\n            //   if(waterColor.a < 1.0){\n            //       refractColor = texture2D( tRefractionMap, uvRefract );\n            //   }\n            #endif\n\n            vec3 _waterColor = waterColor.rgb;\n\n            vec3 diffuseLight = vec3(0.0);\n            vec3 specularLight = vec3(0.0);\n\n            //产生噪点数据\n            vec3 _noise = getNoise(-worldPositionXZ, tNormalMap0, flowTime).xyz;\n            vec3 surfaceNormal = normalize(_noise.xzy * vec3( 1.5, 1.0, 1.5 ));\n\n            sunLight( surfaceNormal.xyz, toEye,sunDirection, diffuseLight, specularLight);\n            //此处根据产品需求，对逆光场合，也增加反光效果；但是与真实光反射中是不应该出现反光的\n            sunLight( surfaceNormal.xyz, toEye,vec3(-sunDirection.x,sunDirection.y,-sunDirection.z), diffuseLight, specularLight);\n            sunLight( surfaceNormal.xyz, toEye,vec3(sunDirection.x,sunDirection.y,-sunDirection.z), diffuseLight, specularLight);\n            sunLight( surfaceNormal.xyz, toEye,vec3(-sunDirection.x,sunDirection.y,sunDirection.z), diffuseLight, specularLight);\n            sunLight( surfaceNormal.xyz, toEye,vec3(0,1,0), diffuseLight, specularLight);\n\n            //         gl_FragColor = vec4(specularLight, 1.0);\n            //         return;\n\n            vec3 _reflectColor;\n\n            #ifdef USE_SHADOW\n                _reflectColor = mix(\n                    _waterColor.rgb * vec3(1.5, 1.4, 1.3), //天空补色,弥补倾角场合水面黑色问题\n                    mix(reflectColor.rgb, diffuseLight, 0.2),//阳光补色,弥补倾角场合水面黑色问题\n                    clamp(dot(step(vec3(0.05), reflectColor.rgb), vec3(1.0)),0.0, 1.0)\n                );\n\n               //反射,建筑倒影(倒影以外部分,是黑色的)\n               // if(reflectColor.r<0.05 && reflectColor.g < 0.05 && reflectColor.b < 0.05){\n               //    //天空补色,弥补倾角场合水面黑色问题\n               //    _reflectColor = vec3(_waterColor.r*1.5, _waterColor.g*1.4, _waterColor.b*1.3);\n               // }else{\n               //    //阳光补色,弥补倾角场合水面黑色问题\n               //    _reflectColor = mix(reflectColor.rgb, diffuseLight, 0.2);\n               // }\n            #else\n                _reflectColor = _waterColor.rgb * vec3(1.5, 1.4, 1.3);\n            #endif\n\n        //穿透,水下部分\n            vec3 _refractColor;\n            #ifdef USE_SHADOW\n                _refractColor = mix(\n                refractColor.rgb*(1.0 - waterColor.a) + _waterColor*waterColor.a,\n                vec3(_waterColor.r*0.45, _waterColor.g*0.55, _waterColor.b*0.75),\n                step(1.0, waterColor.a)\n                );\n                    \n            //   if(waterColor.a < 1.0){\n            //       //根据透明度系数，决定水下建筑成像效果\n            //       _refractColor = refractColor.rgb*(1.0-waterColor.a) + _waterColor*waterColor.a;\n            //   }else{\n            //       _refractColor = vec3(_waterColor.r*0.45, _waterColor.g*0.55, _waterColor.b*0.75);\n            //   }\n            #else\n                _refractColor = vec3(_waterColor.r*0.45, _waterColor.g*0.55, _waterColor.b*0.75);\n            #endif\n\n            // 反射|穿透进行混合\n            vec3 finalColor = mix(_refractColor + specularLight, _reflectColor, reflectance);\n\n            // 合并噪点数据\n            vec3 noiseScatter = max( 0.0, dot( surfaceNormal, toEye ) ) * _waterColor;\n            finalColor = mix(finalColor, noiseScatter, 0.4);\n\n            gl_FragColor = vec4(finalColor, 1.0);\n\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n\n        }\n    "},(()=>{class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="cloudStandard",r.Utils.isMacOS()&&(this.defines.USE_COLOR_CLAMP=""),this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.tintColor=new THREE.Color(16777215),this._referenceCount=1,this._imageByteSize=0,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92,!0===r.GlobalData.ForcedUseWebgl1&&(this.extensions={derivatives:!0}),this.receiveIBL=!0;const t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.fillMap=null,this.tag=null,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.localClipping=-1,this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.useEnvLight=!1,this.useCSM=r.GlobalData.EnableCSM,this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useAlphaMap=!1,this.useForCap=!1,this.useClampToBorder=!1,this.UnLight=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.matchTexture=null,this.polygonsColorTexture=null,this.screenWidth=0,this.screenHeight=0,this.matchMatrix=new THREE.Matrix4,this.matchMatrix.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this.growthAnimationPlanes=null,this.bumpUvTransform=new THREE.Matrix3,this.saturation=1,this.temperature=1,this.temperatureStrength=0,this.contrast=0,this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.lights,THREE.UniformsLib.common,THREE.UniformsLib.lightmap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.roughnessmap,THREE.UniformsLib.metalnessmap,THREE.UniformsLib.envmap,THREE.UniformsLib.fog,{emissive:{value:new THREE.Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},imageFade:{value:1},tintColor:{value:new THREE.Color(16777215)}},{fillMap:{value:null}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{localClipping:{value:-1},innerClipping:{value:this.innerClipping},orthoViewProjMatrix:{value:this.orthoViewProjMatrix}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null},isFineShadow:{value:!0}},{useForCap:{value:!1}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}},{u_matchTexture:{value:null},u_polygonsColorTexture:{value:null},u_width:{value:this.screenWidth},u_height:{value:this.screenHeight},u_climpMode:{value:2},u_matchMat:{value:this.matchMatrix}},{quantizationNormalMatrix:{value:new THREE.Matrix3}},{growthAnimationPlanes:{value:null}},{useEnvLight:{value:this.useEnvLight}},{bumpUvTransform:{value:new THREE.Matrix3}},{saturation:{value:this.saturation},temperature:{value:this.temperature},temperatureStrength:{value:this.temperatureStrength},contrast:{value:this.contrast}}]),this.vertexShader=THREE.ShaderChunk.cloudStandardVertex,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragment,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),null!=e.doubleSide&&e.doubleSide&&(this.side=THREE.DoubleSide),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights])),this.useCSM?(this.defines.USE_CSM="",this.defines.CSM_CASCADES=4):(delete this.defines.USE_CSM,delete this.defines.CSM_CASCADES),this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.disableHemiLight=!1,this.disableHemiLight?this.defines.DISABLE_HEMI_LIGHT="":delete this.defines.DISABLE_HEMI_LIGHT,this.UnLight&&(this.defines.USE_COLORWITHOUTLIGHT="")}destroy(){THREE.MeshStandardMaterial.prototype.dispose.call(this),this.blinkColor=null,this.uniforms=null,this.defaultAttributeValues=null,this.lights=null,this.uvCenter=null,this.uvHalfExtent=null,this.growthAnimationPlanes=null}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}const r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}}copy(e){for(var t in THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.imageFade=e.imageFade,this.tintColor.copy(e.tintColor),this.fillMap=e.fillMap,this.localClipping=e.localClipping,this.innerClipping=e.innerClipping,this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useEnvLight=e.useEnvLight,this.useHeightLimit=e.useHeightLimit,this.useCSM=e.useCSM,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,e.defines)this.defines[t]=e.defines[t];return this.u_polygonsColorTexture=e.polygonsColorTexture,this.u_matchTexture=e.matchTexture,this.u_width=e.screenWidth,this.u_height=e.screenHeight,this.u_matchMat=e.matchMatrix,this.disableHemiLight=e.disableHemiLight,this.UnLight=e.UnLight,this.growthAnimationPlanes=e.growthAnimationPlanes,this.bumpUvTransform=e.bumpUvTransform,this.saturation=e.saturation,this.temperature=e.temperature,this.temperatureStrength=e.temperatureStrength,this.contrast=e.contrast,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade,this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.fillMap.value=this.fillMap,this.uniforms.localClipping.value=this.localClipping,this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.uniforms.u_polygonsColorTexture.value=this.polygonsColorTexture,this.uniforms.u_matchTexture.value=this.matchTexture,this.uniforms.u_width.value=this.screenWidth,this.uniforms.u_height.value=this.screenHeight,this.uniforms.u_climpMode.value=2,this.uniforms.u_matchMat.value=this.matchMatrix,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_NUM=this.videoCastCount:delete this.defines.VIDEO_CAST_NUM,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.growthAnimationPlanes.value=this.growthAnimationPlanes,this.bumpMap&&this.uniforms.bumpUvTransform.value.copy(this.bumpUvTransform),this.uniforms.saturation.value=this.saturation,this.uniforms.temperature.value=this.temperature,this.uniforms.temperatureStrength.value=this.temperatureStrength,this.uniforms.contrast.value=this.contrast,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useEnvLight.value=this.useEnvLight,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.useCSM?(this.defines.USE_CSM="",this.defines.CSM_CASCADES=4):(delete this.defines.USE_CSM,delete this.defines.CSM_CASCADES),this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useMultiBlinkColor?this.defines.USE_MULTI_BLINK_COLOR="":delete this.defines.USE_MULTI_BLINK_COLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.useForCap.value=this.useForCap,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV,this.disableHemiLight?this.defines.DISABLE_HEMI_LIGHT="":delete this.defines.DISABLE_HEMI_LIGHT,this.UnLight&&(this.defines.USE_COLORWITHOUTLIGHT=""),this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=r.EnumShaderColorState.BLINK}setUnLight(e){null==e&&(e=!0),this.UnLight=e,this.UnLight?this.defines.USE_COLORWITHOUTLIGHT="":delete this.defines.USE_COLORWITHOUTLIGHT}updateBlinkUniformValue(e,t,i){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}resetBlinkUniformValue(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updatePolygonClimpGroundInfo(e){if(e){this.defines.CLIMPGROUND_MODE="",this.matchTexture=e.texture,this.polygonsColorTexture=e.colorTexture,this.screenWidth=e.width,this.screenHeight=e.height;for(let e=0;e<this.matchMatrix.elements.length;e++)this.matchMatrix.elements[e]=0;if(e.matchMatrix.length>0)for(let t=0;t<e.matchMatrix.length;t++)this.matchMatrix.elements[t]=e.matchMatrix[t]}this.refreshUniforms()}closePolygonClimpGround(){delete this.defines.CLIMPGROUND_MODE}updateExcavation(e){e&&e.isExcavation?(this.defines.EXCAVATION_MODE="",this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(delete this.defines.EXCAVATION_MODE,this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}setDisableHemiLight(e){this.disableHemiLight=e,this.disableHemiLight?this.defines.DISABLE_HEMI_LIGHT="":delete this.defines.DISABLE_HEMI_LIGHT}}r.CloudStandardMaterial=e})(),(()=>{class e extends THREE.ShaderMaterial{constructor(e){super(),this.type="CloudPMMeshPhongMaterial",this.packingMatMap=e.packingMatTexture,this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.isShaderMaterial=!0,this.map=null,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.tintColor=new THREE.Color(16777215),this._referenceCount=1,this._imageByteSize=0,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92,this.receiveIBL=!0;const t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.fillMap=null,this.tag=null,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.localClipping=-1,this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.useCSM=r.GlobalData.EnableCSM,this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useAlphaMap=!1,this.useForCap=!1,this.useClampToBorder=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,THREE.UniformsLib.lightmap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.envmap,THREE.UniformsLib.fog,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)},backSceneTexture:{value:null},viewportSize:{value:new THREE.Vector2(0,0)}},{packingMatMap:{value:null}},{fillMap:{value:null}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},imageFade:{value:1},tintColor:{value:new THREE.Color(16777215)}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{localClipping:{value:-1},innerClipping:{value:this.innerClipping},orthoViewProjMatrix:{value:this.orthoViewProjMatrix}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null},isFineShadow:{value:!0}},{useForCap:{value:!1}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}}]),this.vertexShader=THREE.ShaderChunk.cloudPMPhongVertex,this.fragmentShader=THREE.ShaderChunk.cloudPMPhongFragment,this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhongLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights])),this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.refreshUniforms()}copy(e){for(var t in super.copy(e),this.color.copy(e.color),this.opacity.copy(e.opacity),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this.packingMatMap=e.packingMatMap,this.map=e.map,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.imageFade=e.imageFade,this.tintColor.copy(e.tintColor),this.fillMap=e.fillMap,this.localClipping=e.localClipping,this.innerClipping=e.innerClipping,this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useHeightLimit=e.useHeightLimit,this.useCSM=e.useCSM,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,e.defines)this.defines[t]=e.defines[t];return this.refreshUniforms(),this}refreshUniforms(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map,null!=this.packingMatMap&&(this.uniforms.packingMatMap.value=this.packingMatMap),this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade,this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.fillMap.value=this.fillMap,this.uniforms.localClipping.value=this.localClipping,this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_NUM=this.videoCastCount:delete this.defines.VIDEO_CAST_NUM,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useMultiBlinkColor?this.defines.USE_MULTI_BLINK_COLOR="":delete this.defines.USE_MULTI_BLINK_COLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.useForCap.value=this.useForCap,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV,this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}const r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}}}r.CloudPMMeshPhongMaterial=e})(),(()=>{class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="ClippingStencilMaterial",this.defines={},this.vertexShader=r.ClippingStencilShader.vertexShader,this.fragmentShader=r.ClippingStencilShader.fragmentShader,this.uniforms=THREE.ShaderLib.basic.uniforms}}r.ClippingStencilMaterial=e})(),function(){const e="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ";class t extends THREE.MeshDepthMaterial{constructor(t){super(t),this.type="InstancedDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{discardAlpha:{value:0}}]),this.vertexShader=function(t){return t.replace("#include <project_vertex>",e)}(THREE.ShaderLib.depth.vertexShader.replace("void main() {","\n            attribute vec4 vState;            \n            attribute vec4 aColor;            \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec4 muvCol0;\n                attribute vec2 muvCol1;\n                // attribute vec2 muvCol2;\n            #endif\n            \n            varying float vfState;\n            \n            #include <get_instance_position_pars_vertex>\n            \n            void main() {\n                vfState = vState.r;\n        ")),this.fragmentShader=THREE.ShaderLib.depth.fragmentShader.replace("void main() {","\n            #include <cloud_state_defines>\n            #include <compare_function>\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                if(floatEqual(vfState, ElementState_HIDDEN) || floatEqual(vfState,ElementState_TRANSPARENT))\n                {\n                    discard;\n                }\n                \n        ")}}r.InstancedDepthMaterial=t}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="BatchedDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{discardAlpha:{value:0}}]),this.vertexShader=THREE.ShaderLib.depth.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n            #include <clipping_planes_pars_vertex>\n            #include <cloud_state_pars_vertex>\n            ").replace("void main() {","\n            void main() {\n                #include <cloud_state_vertex>\n            "),this.fragmentShader=THREE.ShaderLib.depth.fragmentShader.replace("#include <clipping_planes_pars_fragment>","\n            #include <clipping_planes_pars_fragment>\n            #include <cloud_state_defines>\n\t\t    #include <cloud_state_pars_fragment>\n            #include <compare_function>\n            ").replace("void main() {","\n            void main() {\n                if(floatEqual(componentState, ElementState_HIDDEN) || floatEqual(componentState,ElementState_TRANSPARENT))\n                {\n                    discard;\n                }\n            ")}}r.BatchedDepthMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){var t;super(e),this.type="InstancedMeshBasicMaterial",this.defines={},this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.growthAnimationPlanes=null,e&&e.growthAnimationPlanes&&(this.growthAnimationPlanes=e.growthAnimationPlanes),this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{orthoViewProjMatrix:{value:this.orthoViewProjMatrix},innerClipping:{value:this.innerClipping},growthAnimationPlanes:{value:this.growthAnimationPlanes}}]),this.vertexShader=function(e){return e.replace("#include <clipping_planes_vertex>","\n                #include <clipping_planes_vertex>\n                wPositionForInnerClipping = modelMatrix * vec4(getInstancePosition(transformed), 1.0);\n            ").replace("#include <project_vertex>","\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ")}(THREE.ShaderLib.basic.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n                    #include <clipping_planes_pars_vertex>\n                    #include <growthAnimation_pars_vertex>\n                    varying vec3 vViewPosition;\n                  ").replace("#include <clipping_planes_vertex>","\n                      #include <clipping_planes_vertex>\n                      vViewPosition = - mvPosition.xyz;\n                      #include <growthAnimation_vertex>\n                    ").replace("#include <clipping_planes_pars_vertex>","\n                #include <clipping_planes_pars_vertex>\n                varying vec4 wPositionForInnerClipping;\n            ").replace("void main() {","\n            attribute vec4 vState;           \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3; \n            varying float vfState;\n            \n            #include <get_instance_position_pars_vertex>\n            \n            void main() {\n                vfState = vState.r;\n        ")),this.fragmentShader=(t=THREE.ShaderLib.basic.fragmentShader.replace("#include <clipping_planes_pars_fragment>","\n                #include <clipping_planes_pars_fragment>\n                #include <growthAnimation_pars_fragment>\n                varying vec3 vViewPosition;\n              ").replace("#include <clipping_planes_fragment>","\n                  #include <clipping_planes_fragment>\n                  #include <growthAnimation_fragment>\n                "),t.replace("#include <clipping_planes_pars_fragment>","\n                #include <clipping_planes_pars_fragment>\n                uniform mat4 orthoViewProjMatrix;\n                uniform int innerClipping;\n                varying vec4 wPositionForInnerClipping;\n            ").replace("#include <clipping_planes_fragment>","\n                if (innerClipping > 0) \n                {\n                    #include <innerClipping_fragment>\n                }\n                else\n                {\n                    #include <clipping_planes_fragment>\n                }\n            ").replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        "))}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.innerClipping=e.innerClipping,this.growthAnimationPlanes=e.growthAnimationPlanes,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.growthAnimationPlanes.value=this.growthAnimationPlanes}}r.InstancedMeshBasicMaterial=e}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="LogNoAvailDepthMaterial",this.uniforms=THREE.ShaderLib.depth.uniforms,this.vertexShader=THREE.ShaderLib.depth.vertexShader,this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                #include <alphamap_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                void main() {\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n                    #endif\n                }"}}r.LogNoAvailDepthMaterial=e}(),function(){const e="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ";class t extends r.LogNoAvailDepthMaterial{constructor(t){super(t),this.type="LogNoAvailInstancedDepthMaterial",this.uniforms=THREE.ShaderLib.depth.uniforms,this.vertexShader=function(t){return t.replace("#include <project_vertex>",e)}(THREE.ShaderLib.depth.vertexShader.replace("void main() {","\n            attribute vec4 vState;\n            attribute vec4 aColor;\n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec4 muvCol0;\n                attribute vec2 muvCol1;\n                // attribute vec2 muvCol2;\n            #endif\n\n            varying float vfState;\n\n            #include <get_instance_position_pars_vertex>\n\n            void main() {\n                vfState = vState.r;\n        ")),this.fragmentShader=this.fragmentShader.replace("void main() {","\n            varying float vfState;\n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n\n        ")}}r.LogNoAvailInstancedDepthMaterial=t}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="CustomMeshDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{forceLogDepth:{value:!1},forceLogDepthBufFC:{value:1},forceCustomDepth:{value:!1},customDepth:{value:0},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),this.vertexShader="\n                #include <common>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <cloud_state_pars_vertex>\n                // #include <inverse_matrix_pars_vertex_quantization>\n                varying float forceFragDepth;\n                void main() {\n                    #include <cloud_state_vertex>\n                    #include <uv_vertex>\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n                    forceFragDepth = 1.0 + gl_Position.w;\n                    #include <clipping_planes_vertex>\n                }\n            ",this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <alphamap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <cloud_state_pars_fragment>\n                uniform bool forceLogDepth;\n                uniform float forceLogDepthBufFC;\n                uniform bool forceCustomDepth;\n                uniform float customDepth;\n                varying float forceFragDepth;\n                #include <compare_function>\n                void main() {\n                    if(floatEqual(componentState, ElementState_HIDDEN))\n                    {\n                        discard;\n                    }\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #include <logdepthbuf_fragment>\n                    #if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n                        float fragZ = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n                    #else\n                        float fragZ = gl_FragCoord.z;\n                    #endif\n                    if (forceLogDepth)\n                    {\n                        fragZ = log2( forceFragDepth ) * forceLogDepthBufFC * 0.5;\n                    }\n                    if (forceCustomDepth)\n                    {\n                        fragZ = customDepth;\n                    }\n\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( fragZ ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( fragZ );\n                    #endif\n                }\n            "}}r.CustomMeshDepthMaterial=e}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="CustomInstancedMeshDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{forceLogDepth:{value:!1},forceLogDepthBufFC:{value:1},forceCustomDepth:{value:!1},customDepth:{value:0},discardAlpha:{value:0},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),this.vertexShader="\n                #include <common>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n\n                varying float forceFragDepth;\n                \n                attribute vec4 vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec4 muvCol0;\n                    attribute vec2 muvCol1;\n                    // attribute vec2 muvCol2;\n                #endif\n\n                varying float componentState;\n                varying float vAlpha;\n\n                #include <get_instance_position_pars_vertex>\n\n                void main() {\n                    \n                    componentState = vState.r;\n                        \n                    #include <uv_vertex>\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    \n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n                    vAlpha = aColor.a;\n\n                    #include <logdepthbuf_vertex>\n                    \n                    forceFragDepth = 1.0 + gl_Position.w;\n                    \n                    #include <clipping_planes_vertex>\n                }\n            ",this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                #include <alphamap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <compare_function>\n                uniform bool forceLogDepth;\n                uniform float forceLogDepthBufFC;\n                uniform bool forceCustomDepth;\n                uniform float customDepth;\n                uniform float discardAlpha;\n                varying float forceFragDepth;\n                \n                varying float componentState;\n                varying float vAlpha;\n                void main() {\n                    if (floatEqual(componentState, ElementState_HIDDEN)) discard;\n                    if (vAlpha <= discardAlpha && vAlpha >= 0.0) discard;\n\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    \n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #include <logdepthbuf_fragment>\n                    \n                    #if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n                        float fragZ = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n                    #else\n                        float fragZ = gl_FragCoord.z;\n                    #endif\n                    \n                    if (forceLogDepth)\n                    {\n                        fragZ = log2( forceFragDepth ) * forceLogDepthBufFC * 0.5;\n                    }\n                    if (forceCustomDepth)\n                    {\n                        fragZ = customDepth;\n                    }\n\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( fragZ ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( fragZ );\n                    #endif\n                }\n            "}}r.CustomInstancedMeshDepthMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="PickingExcavationMaterial",this.vertexShader="\n                #include <common>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n\n                uniform mat4 u_CullOrthoMatrix;\n                varying vec3 v_CullOrthoPosition;\n\n                void main()\n                {\n                    vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                    othPos /= othPos.w;\n                    v_CullOrthoPosition = othPos.xyz;\n\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n\n                    #ifdef USE_SKINNING\n                        vec4 wPosition = modelMatrix * skinned;\n                    #else\n                        vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n                    #endif\n\n                    vec4 mvPosition = viewMatrix * wPosition;\n                    gl_Position = projectionMatrix * mvPosition;\n            \n                    #include <logdepthbuf_vertex>\n                    #include <worldpos_vertex>\n                }\n            ",this.fragmentShader="\n                #include <common>\n                #include <logdepthbuf_pars_fragment>\n        \n                varying vec3 v_CullOrthoPosition;\n                uniform sampler2D  u_SamplerExcavation;\n                \n                vec2 postProjToScreen(vec2 position)\n                {\n                    vec2 screenPos = position;\n                    return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n                }\n        \n                void main()\n                {   \n                    vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n                    vec4 resultColor = vec4(1.0);\n                    if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                    {\n                        vec4 color = texture2D(u_SamplerExcavation, uv);\n                        if(color.r > 0.0001)\n                        {\n                            resultColor = vec4(0.0);\n                        }\n                    } \n                    \n                    #include <logdepthbuf_fragment>\n                    gl_FragColor = resultColor;\n                }\n            ",this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{u_SamplerExcavation:{value:this.samplerExcavation},u_CullOrthoMatrix:{value:this.cullOrthoMatrix}}])}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}updateExcavation(e){e&&e.isExcavation?(this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.PickingExcavationMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.defines={},this.type="MeshBasicClipMaterial",this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.growthAnimationPlanes=null,e&&e.growthAnimationPlanes&&(this.growthAnimationPlanes=e.growthAnimationPlanes),e&&e.growthAnimationMap&&(this.growthAnimationMap=e.growthAnimationMap),e&&e.growthAnimationMapSizeWidth&&(this.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth),e&&e.growthAnimationMapSizeHeight&&(this.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight),this.uLineTexture=r.LineTextureManager.uLineTexture,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{orthoViewProjMatrix:{value:this.orthoViewProjMatrix},innerClipping:{value:this.innerClipping}},{runTime:{value:this.runTime}},{growthAnimationPlanes:{value:this.growthAnimationPlanes},growthAnimationMap:{value:this.growthAnimationMap},growthAnimationMapSizeWidth:{value:this.growthAnimationMapSizeWidth},growthAnimationMapSizeHeight:{value:this.growthAnimationMapSizeHeight}}]),this.uniforms.uLineTexture={value:this.uLineTexture},!0===r.GlobalData.ForcedUseWebgl1&&(this.extensions={derivatives:!0}),this.vertexShader=this._getVertexShader(THREE.ShaderLib.basic.vertexShader),this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader),this.vertexShader=this.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n                #include <clipping_planes_pars_vertex>\n                #include <growthAnimation_pars_vertex>\n                varying vec3 vViewPosition;\n            ").replace("#include <clipping_planes_vertex>","\n                #include <clipping_planes_vertex>\n                vViewPosition = - mvPosition.xyz;\n                #include <growthAnimation_vertex>\n\n            "),this.fragmentShader=this.fragmentShader.replace("#include <clipping_planes_pars_fragment>","\n                #include <clipping_planes_pars_fragment>\n                #include <growthAnimation_pars_fragment>\n                varying vec3 vViewPosition;\n            ").replace("#include <clipping_planes_fragment>","\n                #include <clipping_planes_fragment>    \n                #include <growthAnimation_fragment>\n            ")}setBorderLineVisible(e){e?this.defines.USE_BC_OUTLINE="":delete this.defines.USE_BC_OUTLINE}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.innerClipping=e.innerClipping,this.runTime=e.runTime,this.uLineTexture=e.uLineTexture,this.growthAnimationPlanes=e.growthAnimationPlanes,this.growthAnimationMap=e.growthAnimationMap,this.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth,this.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.runTime.value=this.runTime,this.uniforms.uLineTexture={value:this.uLineTexture},this.uniforms.growthAnimationPlanes.value=this.growthAnimationPlanes,this.uniforms.growthAnimationMap.value=this.growthAnimationMap,this.uniforms.growthAnimationMapSizeWidth.value=this.growthAnimationMapSizeWidth,this.uniforms.growthAnimationMapSizeHeight.value=this.growthAnimationMapSizeHeight}_getVertexShader(e){var t=e.replace("#include <clipping_planes_pars_vertex>","\n                    #include <clipping_planes_pars_vertex>\n                    varying vec4 wPositionForInnerClipping;\n                    #include <outline_pars_vertex>\n                ");return t=t.replace("#include <clipping_planes_vertex>","\n                    #include <clipping_planes_vertex>\n                    wPositionForInnerClipping = modelMatrix * vec4(transformed, 1.0);\n                    #include <outine_vertex>\n                ")}_getFragmentShader(e){var t=e.replace("#include <clipping_planes_pars_fragment>","\n                    #include <clipping_planes_pars_fragment>\n                    uniform mat4 orthoViewProjMatrix;\n                    uniform int innerClipping;\n                    varying vec4 wPositionForInnerClipping;\n                    #if defined(USE_BC_OUTLINE)\n                        varying vec3 vBarycentric;\n                        uniform sampler2D uLineTexture;\n                    #endif\n                    #include <outline_function_pars_fragment_10>\n                    #include <outline_function_fragment_get_line_tickness>\n                ");return t=(t=t.replace("#include <clipping_planes_fragment>","\n                    if (innerClipping > 0) \n                    {\n                       #include <innerClipping_fragment>\n                    }\n                    else\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                ")).replace("#include <dithering_fragment>","\n                    #include <dithering_fragment>\n                    #if defined(USE_BC_OUTLINE)\n                    vec4 _tempColor = gl_FragColor ;\n                    float line_tickness = getLineTickness();\n                    gl_FragColor = mix(_tempColor, vec4(0.29,0.86,0.79,1.0), line_tickness);\n                    #endif \n                    ")}}r.MeshBasicClipMaterial=e,r.MeshBasicClipInstanceMaterial=class extends e{constructor(e){super(e),this.vertexShader=this.vertexShader.replace("#include <clipping_planes_pars_vertex>","#include <clipping_planes_pars_vertex>\n          //  attribute vec3 mcol0;\n          //  attribute vec3 mcol1;\n          //  attribute vec3 mcol2;\n          //  attribute vec3 mcol3;\n          ").replace("vec3 transformed = vec3( position );","\n          vec3 transformed = vec3( position );\n          // transformed = vec3(\n          //   mat4(\n          //     vec4(mcol0, 0.0),\n          //     vec4(mcol1, 0.0),\n          //     vec4(mcol2, 0.0),\n          //     vec4(mcol3, 1.0)\n          //   ) * vec4(transformed, 1.0));\n          ")}}}(),(()=>{class e extends THREE.Material{constructor(e){super(),this.isPointsMaterial=!0,this.type="CLOUDPointsMaterial",this.color=new THREE.Color(16777215),this.map=null,this.alphaMap=null,this.size=1,this.scale=1,this.morphTargets=!1,this.defines={},this.sizeAttenuation=r.Utils.defaultValue(e.sizeAttenuation,!1),this.sizeAttenuation?this.defines.USE_SIZEATTENUATION="":delete this.defines.USE_SIZEATTENUATION,this.positionOffset=r.Utils.defaultValue(e.positionOffset,!1),this.positionOffset?this.defines.USE_POSITION_OFFSET="":delete this.defines.USE_POSITION_OFFSET,this.sizeAttribute=r.Utils.defaultValue(e.sizeAttribute,!1),this.sizeAttribute?this.defines.USE_ATTRIBUTE_SIZE="":delete this.defines.USE_ATTRIBUTE_SIZE,this.setValues(e),this.vertexShader=THREE.ShaderChunk.points_vertex,this.fragmentShader=THREE.ShaderChunk.points_fragment,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{size:{value:this.size},scale:{value:this.scale}}])}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.positionOffset=e.positionOffset,this.sizeAttribute=e.sizeAttribute,this.morphTargets=e.morphTargets,this}refreshUniforms(){this.uniforms.positionOffset.value=this.positionOffset,this.uniforms.sizeAttribute.value=this.sizeAttribute}}r.PointsMaterial=e})(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="InstancedNormalMaterial",this.uniforms=THREE.ShaderLib.normal.uniforms,this.uniforms.quantizationNormalMatrix={value:new THREE.Matrix3},this.vertexShader="\n                #define NORMAL\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n                #include <inverse_matrix_pars_vertex_quantization>\n\n                attribute vec4 vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n\n                #if defined(USE_MAP)\n                    attribute vec4 muvCol0;\n                    attribute vec2 muvCol1;\n                    // attribute vec2 muvCol2;\n                #endif\n                varying float vfState;\n\n                #include <get_instance_position_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                \n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                void main() {\n                    vfState = vState.r;\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    // #include <defaultnormal_vertex>\n\n                    // mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                    // normalMat = inverse_mat3(normalMat);\n                    // normalMat = transpose_mat3(normalMat);\n                    // transformedNormal = normalMat * objectNormal;\n                    // transformedNormal = normalMatrix * transformedNormal;\n                    \n                    // #ifdef FLIP_SIDED\n                    //    transformedNormal = - transformedNormal;\n                    // #endif\n\n                    // transformedNormal = normalize( transformedNormal );\n\n                    #include <defaultnormal_instance_vertex_quantization>\n\n                    #include <flat_shaded_vertex>\n                    #include <begin_vertex>\n\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n\n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n                    #include <clipping_planes_vertex>\n                    #include <logdepthbuf_vertex>\n\n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n                }\n            ",this.fragmentShader=THREE.ShaderLib.normal.fragmentShader.replace("void main() {","\n            varying float vfState;\n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n        ")}updateCNormalDefines(e){r.Utils.defined(this.defines)||(this.defines={}),e?this.defines.CNORMAL="":delete this.defines.CNORMAL}}r.InstancedNormalMaterial=e}(),function(){class e extends r.InstancedNormalMaterial{constructor(e){super(e),this.type="InstancedNormalDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.normal.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},isDEM:{value:!1},viewMatrix:{value:new THREE.Matrix4},logDepthBufFC:{value:0},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),this.defines={},this.defines.SUPPORT_INSTANCE_MIRROR="",!0===r.GlobalData.ForcedUseWebgl1&&(this.defines.USE_LOGDEPTHBUF="",this.defines.USE_LOGDEPTHBUF_EXT="",this.extensions={fragDepth:!0}),this.vertexShader="\n                #define NORMAL\n                #define EPSILON 1e-6\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n               \n                attribute vec4 vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                attribute vec4 pointColorState;\n                #if defined(USE_MAP)\n                    attribute vec4 muvCol0;\n                    attribute vec2 muvCol1;\n                    // attribute vec2 muvCol2;\n                #endif\n                varying float vfState;\n\n                #include <inverse_matrix_pars_vertex_quantization>\n                #include <get_instance_position_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                \n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n\n                mat3 transposeMat3( const in mat3 m ) {\n                    mat3 tmp;\n                    tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n                    tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n                    tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n                    return tmp;\n                }\n\n                varying float vDepth;\n                varying float overrideOpacity;\n                \n                void main() {\n                    vfState = vState.r;\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n\n                    overrideOpacity = pointColorState.w;\n\n                    // #include <defaultnormal_vertex>\n\n                    // mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n\n                    // #ifdef SUPPORT_INSTANCE_MIRROR\n                    //     bool mirror = isMirror_mat3(normalMat);\n                    // #endif\n                    \n                    // normalMat = inverse_mat3(normalMat);\n                    // normalMat = transposeMat3(normalMat);\n                    // transformedNormal = normalMat * objectNormal;\n                    // transformedNormal = normalMatrix * transformedNormal;\n\n                    // #ifdef SUPPORT_INSTANCE_MIRROR\n                    //     if(mirror) {\n                    //         transformedNormal = - transformedNormal;\n                    //     }\n                    // #endif\n\n                    // #ifdef FLIP_SIDED\n                    //    transformedNormal = - transformedNormal;\n                    // #endif\n\n                    // transformedNormal = normalize( transformedNormal );\n\n                    #include <defaultnormal_instance_vertex_quantization>\n\n                    #include <flat_shaded_vertex>\n                    #include <begin_vertex>\n\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    \n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n\n                    vec4 worldPosition = modelMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    vDepth =  (viewMatrix * worldPosition).z;\n\n                    #include <clipping_planes_vertex>\n                    #include <logdepthbuf_vertex>\n\n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n                }\n                ",this.fragmentShader=THREE.ShaderLib.normal.fragmentShader.replace("#include <clipping_planes_fragment>","").replace("#include <logdepthbuf_fragment>","").replace("#include <normal_fragment_begin>","").replace("#include <normal_fragment_maps>","").replace("void main() {","\n            #define EPSILON 1e-6\n            varying float vfState;\n            varying float vDepth;\n            varying float overrideOpacity;\n            #include <compare_function>\n            #include <cloud_state_defines>\n            void main() {\n                #include <clipping_planes_fragment>\n                #include <logdepthbuf_fragment>\n                #include <normal_fragment_begin>\n                #include <normal_fragment_maps>\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                if (floatEqual(vfState, ElementState_OVERRIDED) && floatEqual(overrideOpacity, 0.0)) discard;\n                vec3 n = normalize(normal);\n                gl_FragColor = vec4(n, vDepth);\n                return;\n        ")}}r.InstancedNormalDepthMaterial=e}(),function(){class e extends THREE.MeshPhongMaterial{constructor(e){super(e),this.defines={USE_NO_SSAO:"",USE_NO_SSR:""},this.type="MapTileMaterial",this.samplerExcavation=null,this.matchTexture=null,this.polygonsColorTexture=null,this.onlyClimpColorTexture=null,this.screenWidth=0,this.screenHeight=0,this.climpMode=0,this.cullOrthoMatrix=new THREE.Matrix4,this.brightness=1,this.contrast=1,this.saturation=1,this.hue=0,this.gamma=1,this.customColor=new THREE.Vector4(1,1,1,1),this.useCustomColor=0,this._imageByteSize=0,this.useCSM=r.GlobalData.EnableCSM,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},u_matchTexture:{value:null},u_polygonsColorTexture:{value:null},u_onlyClimpColorTexture:{value:null}},{brightness:{value:this.brightness},contrast:{value:this.contrast},saturation:{value:this.saturation},hue:{value:this.hue},gamma:{value:this.gamma},customColor:{value:this.customColor},useCustomColor:{value:this.useCustomColor},u_width:{value:this.screenWidth},u_height:{value:this.screenHeight},u_climpMode:{value:this.climpMode}},{csmCascades:{value:null},isFineShadow:{value:!0}},r.GroundDrawingShader.uniforms]),this.vertexShader=THREE.ShaderChunk.map_tile_vertex,this.fragmentShader=THREE.ShaderChunk.map_tile_fragment,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.u_SamplerExcavation.value=e.samplerExcavation,this.u_CullOrthoMatrix.value=e.cullOrthoMatrix,this.u_matchTexture.value=e.matchTexture,this.u_polygonsColorTexture.value=e.polygonsColorTexture,this.u_onlyClimpColorTexture.value=e.onlyClimpColorTexture,this.u_width=e.screenWidth,this.u_height=e.screenHeight,this.brightness=e.brightness,this.contrast=e.contrast,this.saturation=e.saturation,this.hue=e.hue,this.gamma=e.gamma,this.customColor=e.customColor,this.useCustomColor=e.useCustomColor,this.useCSM=e.useCSM,this}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix,this.uniforms.brightness.value=this.brightness,this.uniforms.contrast.value=this.contrast,this.uniforms.saturation.value=this.saturation,this.uniforms.hue.value=this.hue,this.uniforms.gamma.value=this.gamma,this.uniforms.customColor.value.copy(this.customColor),this.uniforms.useCustomColor.value=this.useCustomColor,this.uniforms.u_matchTexture.value=this.matchTexture,this.uniforms.u_polygonsColorTexture.value=this.polygonsColorTexture,this.uniforms.u_onlyClimpColorTexture.value=this.onlyClimpColorTexture,this.uniforms.u_width.value=this.screenWidth,this.uniforms.u_height.value=this.screenHeight,this.uniforms.u_climpMode.value=this.climpMode,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}updateStyle(e){this.brightness=r.Utils.isDefined(e.brightness)?e.brightness:1,this.contrast=r.Utils.isDefined(e.contrast)?e.contrast:1,this.saturation=r.Utils.isDefined(e.saturation)?e.saturation:1,this.hue=r.Utils.isDefined(e.hue)?e.hue:0,this.gamma=r.Utils.isDefined(e.gamma)?e.gamma:1,this.customColor=r.Utils.isDefined(e.color)?this.customColor.copy(e.color):this.customColor,this.useCustomColor=r.Utils.isDefined(e.color)?1:0,this.refreshUniforms()}updateExcavation(e){e&&e.isExcavation?(this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updatePolygonClimpGroundInfo(e){e&&(this.defines.DEMMODEL="",this.climpMode=1,this.matchTexture=e.texture,this.polygonsColorTexture=e.colorTexture,this.onlyClimpColorTexture=e.onlyClimpGroundTexture,this.screenWidth=e.width,this.screenHeight=e.height),this.refreshUniforms()}closePolygonClimpGround(){this.defines.hasOwnProperty("DEMMODEL")&&delete this.defines.DEMMODEL,1==this.climpMode&&(this.climpMode=-1),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.MapTileMaterial=e}(),function(){class e extends THREE.MeshPhongMaterial{constructor(e){super(e),this.defines={},this.type="ObliquePhotographyMaterial",this._referenceCount=1,this._imageByteSize=0,this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.matchTexture=null,this.polygonsColorTexture=null,this.width=0,this.height=0,this.matchMatrix=new THREE.Matrix4,this.matchMatrix.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this.useCSM=r.GlobalData.EnableCSM,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},u_matchTexture:{value:null},u_polygonsColorTexture:{value:null}},{csmCascades:{value:null},isFineShadow:{value:!0},u_width:{value:this.width},u_height:{value:this.height},u_climpMode:{value:2},u_matchMat:{value:this.matchMatrix}},r.GroundDrawingShader.uniforms]),this.vertexShader=THREE.ShaderChunk.oblique_photography_vertex,this.fragmentShader=THREE.ShaderChunk.oblique_photography_fragment,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}copy(e){return THREE.MeshPhongMaterial.prototype.copy.call(this,e),this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,this.useCSM=e.useCSM,this.u_matchTexture=e.matchTexture,this.u_polygonsColorTexture=e.polygonsColorTexture,this.u_width=e.width,this.u_height=e.height,this.u_matchMat=e.matchMatrix,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix,this.uniforms.u_matchTexture.value=this.matchTexture,this.uniforms.u_polygonsColorTexture.value=this.polygonsColorTexture,this.uniforms.u_width.value=this.width,this.uniforms.u_height.value=this.height,this.uniforms.u_climpMode.value=2,this.uniforms.u_matchMat.value=this.matchMatrix,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}updateExcavation(e){e&&e.isExcavation?(this.defines.EXCAVATION_MODE="",this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(delete this.defines.EXCAVATION_MODE,this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updatePolygonClimpGroundInfo(e){if(e){this.defines.CLIMPGROUND_MODE="",this.matchTexture=e.texture,this.polygonsColorTexture=e.colorTexture,this.width=e.width,this.height=e.height;for(let e=0;e<this.matchMatrix.elements.length;e++)this.matchMatrix.elements[e]=0;if(e.matchMatrix.length>0)for(let t=0;t<e.matchMatrix.length;t++)this.matchMatrix.elements[t]=e.matchMatrix[t]}this.refreshUniforms()}closePolygonClimpGround(){delete this.defines.CLIMPGROUND_MODE}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.ObliquePhotographyMaterial=e}(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="NormalMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.normal.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},isDEM:{value:!1},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),this.vertexShader="\n                #define NORMAL\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                #include <inverse_matrix_pars_vertex_quantization>\n\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                #include <clipping_planes_pars_vertex>\n\n                uniform mat4 u_CullOrthoMatrix;\n                varying vec3 v_CullOrthoPosition;\n\n                void main() {\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    // #include <defaultnormal_vertex>\n                    #include <defaultnormal_vertex_quantization>\n                    #include <flat_shaded_vertex>\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n\n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n\n                    #include <clipping_planes_vertex>\n\n                    vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                    othPos /= othPos.w;\n                    v_CullOrthoPosition = othPos.xyz;\n                }\n                ",this.fragmentShader="\n                #define NORMAL\n                uniform float opacity;\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_tangent_pars_fragment>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <bumpmap_pars_fragment>\n                #include <normalmap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n\n                varying vec3 v_CullOrthoPosition;\n                uniform sampler2D  u_SamplerExcavation;\n                uniform bool isDEM;\n\n                vec2 postProjToScreen(vec2 position)\n                {\n                    vec2 screenPos = position;\n                    return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n                }\n\n                void main() {\n\n                    if(isDEM) {\n\n                        vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);//zty\n                        if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                        {\n                            vec4 color = texture2D(u_SamplerExcavation, uv);\n                            if(color.r > 0.0001)\n                            {\n                                discard;\n                            }\n                        }\n\n                    }\n                    #include <clipping_planes_fragment>\n                    #include <logdepthbuf_fragment>\n                    #include <normal_fragment_begin>\n                    #include <normal_fragment_maps>\n                    \n                    gl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n                }\n            "}updateCNormalDefines(e){r.Utils.defined(this.defines)||(this.defines={}),e?this.defines.CNORMAL="":delete this.defines.CNORMAL}}r.NormalMaterial=e}(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="MetalnessMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.normal.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},isDEM:{value:!1},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),this.uniforms.packingMatMap={value:viewer.packingMatTexture},this.vertexShader="\n                #define NORMAL\n                #define USE_PACKINGMAT\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                #include <inverse_matrix_pars_vertex_quantization>\n\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                #include <clipping_planes_pars_vertex>\n\n                uniform mat4 u_CullOrthoMatrix;\n                varying vec3 v_CullOrthoPosition;\n                #include <packing_material_pars_vertex>\n                void main() {\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    // #include <defaultnormal_vertex>\n                    #include <defaultnormal_vertex_quantization>\n                    #include <flat_shaded_vertex>\n                    #include <begin_vertex>\n\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n                    #include <packing_material_vertex>\n\n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n\n                    #include <clipping_planes_vertex>\n\n                    vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                    othPos /= othPos.w;\n                    v_CullOrthoPosition = othPos.xyz;\n                }\n                ",this.fragmentShader="\n                #define NORMAL\n                #define USE_PACKINGMAT\n                uniform float opacity;\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_tangent_pars_fragment>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <bumpmap_pars_fragment>\n                #include <normalmap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                #include <packing_material_pars_fragment>\n\n                varying vec3 v_CullOrthoPosition;\n                uniform sampler2D  u_SamplerExcavation;\n                uniform bool isDEM;\n\n                vec2 postProjToScreen(vec2 position)\n                {\n                    vec2 screenPos = position;\n                    return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n                }\n\n                void main() {\n                    #include <packing_material_fragment>\n                    if(isDEM) {\n\n                        vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);//zty\n                        if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                        {\n                            vec4 color = texture2D(u_SamplerExcavation, uv);\n                            if(color.r > 0.0001)\n                            {\n                                discard;\n                            }\n                        }\n\n                    }\n                    #include <clipping_planes_fragment>\n                    #include <logdepthbuf_fragment>\n                    #include <normal_fragment_begin>\n                    #include <normal_fragment_maps>\n                    \n                    gl_FragColor = vec4( packNormalToRGB( normal ), metalness );\n                }\n            "}updatePackingMaterialTexture(e){null!=e&&(this.uniforms.packingMatMap.value=e,r.Utils.defined(this.defines)||(this.defines={}),this.defines.USE_PACKINGMAT="")}updateCNormalDefines(e){r.Utils.defined(this.defines)||(this.defines={}),e?this.defines.CNORMAL="":delete this.defines.CNORMAL}}r.MetalnessMaterial=e}(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="InstancedMetalnessMaterial",this.uniforms=THREE.ShaderLib.normal.uniforms,this.uniforms.packingMatMap={value:viewer.packingMatTexture},this.uniforms.quantizationNormalMatrix={value:new THREE.Matrix3},this.vertexShader="\n                #define NORMAL\n                #define USE_PACKINGMAT\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n                #include <inverse_matrix_pars_vertex_quantization>\n\n                attribute vec4 vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n\n                #if defined(USE_MAP)\n                    attribute vec4 muvCol0;\n                    attribute vec2 muvCol1;\n                    // attribute vec2 muvCol2;\n                #endif\n                varying float vfState;\n\n                #include <get_instance_position_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                #include <packing_material_pars_vertex>\n\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                void main() {\n                    vfState = vState.r;\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n\n                    // #include <defaultnormal_vertex>\n\n                    // mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                    // normalMat = inverse_mat3(normalMat);\n                    // normalMat = transpose_mat3(normalMat);\n                    // transformedNormal = normalMat * objectNormal;\n                    // transformedNormal = normalMatrix * transformedNormal;\n                    \n                    // #ifdef FLIP_SIDED\n                    //    transformedNormal = - transformedNormal;\n                    // #endif\n\n                    // transformedNormal = normalize( transformedNormal );\n\n                    #include <defaultnormal_instance_vertex_quantization>\n\n                    #include <flat_shaded_vertex>\n                    #include <begin_vertex>\n\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n\n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n                    #include <clipping_planes_vertex>\n                    #include <logdepthbuf_vertex>\n                    #include <packing_material_vertex>\n\n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n                }\n            ",this.fragmentShader=THREE.ShaderLib.normal.fragmentShader.replace("void main() {","\n            #define USE_PACKINGMAT\n            #include <packing_material_pars_fragment>\n            varying float vfState;\n            void main() {\n                #include <packing_material_fragment>\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n        ").replace("gl_FragColor = vec4( packNormalToRGB( normal ), opacity );","gl_FragColor = vec4( packNormalToRGB( normal ), metalness );")}updateCNormalDefines(e){r.Utils.defined(this.defines)||(this.defines={}),e?this.defines.CNORMAL="":delete this.defines.CNORMAL}updatePackingMaterialTexture(e){null!=e&&(this.uniforms.packingMatMap.value=e,r.Utils.defined(this.defines)||(this.defines={}),this.defines.USE_PACKINGMAT="")}}r.InstancedMetalnessMaterial=e}(),function(){class e extends r.NormalMaterial{constructor(e){super(e),this.type="NormalDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.normal.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4},isDEM:{value:!1},viewMatrix:{value:new THREE.Matrix4},logDepthBufFC:{value:0},quantizationNormalMatrix:{value:new THREE.Matrix3}}]),!0===r.GlobalData.ForcedUseWebgl1&&(this.defines={},this.defines.USE_LOGDEPTHBUF="",this.defines.USE_LOGDEPTHBUF_EXT="",this.extensions={fragDepth:!0}),this.vertexShader="\n                #define NORMAL\n                #define EPSILON 1e-6\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #include <flat_shaded_pars_vertex>\n\n                varying float vDepth;\n\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <CompressNormal_pars_vertex>\n                #include <matrix_transform_pars_vertex>\n                #include <inverse_matrix_pars_vertex_quantization>\n\n                attribute vec4 vState;\n                attribute vec4 pointColorState;\n                \n                varying float overrideOpacity;\n                varying float componentState;\n\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                #include <clipping_planes_pars_vertex>\n\n                uniform mat4 u_CullOrthoMatrix;\n                varying vec3 v_CullOrthoPosition;\n\n                void main() {\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    // #include <defaultnormal_vertex>\n                    #include <defaultnormal_vertex_quantization>\n\n                    #include <begin_vertex>\n                    \n\n                    // vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n                    vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n                    componentState = vState.x;\n                    overrideOpacity = pointColorState.w;\n                   \n\n\n                    #include <flat_shaded_vertex>\n                    // #include <begin_vertex> \n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n\n                    vDepth =  mvPosition.z;\n                    \n                    #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                        vViewPosition = - mvPosition.xyz;\n                    #endif\n\n                    #include <clipping_planes_vertex>\n\n                    vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                    othPos /= othPos.w;\n                    v_CullOrthoPosition = othPos.xyz;\n                }\n                ",this.fragmentShader="\n                #define NORMAL\n                #define EPSILON 1e-6\n                uniform float opacity;\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n\n                #include <flat_shaded_tangent_pars_fragment>\n                \n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <bumpmap_pars_fragment>\n                #include <normalmap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                \n                #include <compare_function>\n                #include <cloud_state_defines>\n\n                varying float componentState;\n                varying float overrideOpacity;\n                varying vec3 v_CullOrthoPosition;\n                uniform sampler2D  u_SamplerExcavation;\n                uniform bool isDEM;\n\n                varying float vDepth;\n\n                vec2 postProjToScreen(vec2 position)\n                {\n                    vec2 screenPos = position;\n                    return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n                }\n\n                void main() {\n\n                    if (floatEqual(componentState, ElementState_HIDDEN)) discard;\n                    if (floatEqual(componentState, ElementState_OVERRIDED) && floatEqual(overrideOpacity, 0.0)) discard;\n                    if(isDEM) {\n\n                        vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);//zty\n                        if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                        {\n                            vec4 color = texture2D(u_SamplerExcavation, uv);\n                            if(color.r > 0.0001)\n                            {\n                                discard;\n                            }\n                        }\n\n                    }\n                    #include <clipping_planes_fragment>\n                    #include <logdepthbuf_fragment>\n                    #include <normal_fragment_begin>\n                    #include <normal_fragment_maps>\n\n                    vec3 n = normalize(normal.xyz);\n                    gl_FragColor = vec4(n, vDepth);\n                }\n            "}}r.NormalDepthMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="WallMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.WallShader.uniforms]),this.vertexShader=r.WallShader.vertexShader,this.fragmentShader=r.WallShader.fragmentShader}}r.WallMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="PlaneScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.PlaneScanShader.uniforms]),this.vertexShader=r.PlaneScanShader.vertexShader,this.fragmentShader=r.PlaneScanShader.fragmentShader}}r.PlaneScanMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="RingScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.RingScanShader.uniforms]),this.vertexShader=r.RingScanShader.vertexShader,this.fragmentShader=r.RingScanShader.fragmentShader}}r.RingScanMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="FanScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.FanScanShader.uniforms]),this.vertexShader=r.FanScanShader.vertexShader,this.fragmentShader=r.FanScanShader.fragmentShader}}r.FanScanMaterial=e}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(e);var t=this;t.type="WaterMaterial",t.uniforms=THREE.UniformsUtils.merge([{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new THREE.Color(16777215)},postProcessMap:{value:null},postProcessAdditiveMap:{value:null},postProcessSSAOMap:{value:null},postProcessSSRMap:{value:null},postProcessMixRate:{value:0},postProcessSSAORate:{value:0},postProcessSSRRate:{value:0},postProcessAdditiveRate:{value:0},viewportWidth:{value:0},viewportHeight:{value:0}},r.WaterShader.uniforms]),t.vertexShader=r.WaterShader.vertexShader,t.fragmentShader=r.WaterShader.fragmentShader,t.textureMatrix=new THREE.Matrix4,t.transparent=!1,t.clipping=!0,t.side=THREE.DoubleSide,t.isUndersea=!0,t.fog=!0}initUniforms(e){var t=this;void 0!==e.flowMap?(t.defines.USE_FLOWMAP="",t.uniforms.tFlowMap={type:"t",value:e.flowMap}):t.uniforms.flowDirection={type:"v2",value:e.flowDirection},t.uniforms.tNormalMap0.value=e.normalMap0,t.uniforms.tNormalMap1.value=e.normalMap1,t.uniforms.waterColor.value=new THREE.Vector4(e.color.r,e.color.g,e.color.b,e.alpha),1==e.alpha&&(t.side=THREE.FrontSide,t.isUndersea=!1),t.uniforms.reflectivity.value=e.reflectivity,t.uniforms.config.value.x=0,t.uniforms.config.value.y=e.halfCycle,t.uniforms.config.value.z=e.halfCycle,t.uniforms.config.value.w=e.wavesScale,e.viewer.gisMode&&(t.defines.USE_GLOBE=""),e.shadow&&(t.defines.USE_SHADOW=""),t.uniforms.sunDirection.value=e.scene.sunDirection,t.uniforms.textureMatrix.value=t.textureMatrix}}r.WaterMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e);var t=this;t.type="MeshBasicMaterial",t.depthTest=!1,t.depthWrite=!1,t.wireframe=!0,t.clipping=!0,t.side=THREE.DoubleSide,t.fog=!0,t.transparent=!0}}r.CutFillMaterial=e}(),(()=>{class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="CLOUDMeshBasicMaterial",this.vertexShader=THREE.ShaderChunk.meshbasic_vert,this.fragmentShader=THREE.ShaderChunk.cloud_mesh_basic_frag,this.uniforms=THREE.ShaderLib.basic.uniforms}}r.MeshBasicMaterial=e})(),(()=>{class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="CLOUDMeshStandardMaterial",this.vertexShader=THREE.ShaderChunk.meshphysical_vert,this.fragmentShader=THREE.ShaderChunk.cloud_mesh_physical_frag,this.uniforms=THREE.ShaderLib.physical.uniforms,this.metalness=.5,this.roughness=.5}}r.MeshStandardMaterial=e})(),function(){class e extends THREE.LineBasicMaterial{constructor(e){super(e),this.type="CloudLineBasicMaterial",this.growthAnimationPlanes=null,this.defines={},this.vertexShader=THREE.ShaderLib.basic.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n          #include <clipping_planes_pars_vertex>\n          #include <growthAnimation_pars_vertex>\n          varying vec3 vViewPosition;\n        ").replace("#include <clipping_planes_vertex>","\n          #include <clipping_planes_vertex>\n          vViewPosition = - mvPosition.xyz;\n          #include <growthAnimation_vertex>\n        "),this.fragmentShader=THREE.ShaderChunk.cloud_line_basic_frag.replace("#include <clipping_planes_pars_fragment>","\n          #include <clipping_planes_pars_fragment>\n          #include <growthAnimation_pars_fragment>\n          varying vec3 vViewPosition;\n        ").replace("#include <clipping_planes_fragment>","\n            #include <clipping_planes_fragment>\n            #include <growthAnimation_fragment>\n          "),e&&e.growthAnimationPlanes&&(this.growthAnimationPlanes=e.growthAnimationPlanes),this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{growthAnimationPlanes:{value:this.growthAnimationPlanes}}])}copy(e){return THREE.LineBasicMaterial.prototype.copy.call(this,source),this.growthAnimationPlanes=source.growthAnimationPlanes,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.growthAnimationPlanes=this.growthAnimationPlanes}}r.LineBasicMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="GroundPolygonMaterial",this.clampMode=0,this.viewport=new THREE.Vector4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{clampMode:{value:this.clampMode},viewport:{value:this.viewport.clone()}}]),this.vertexShader=r.GroundPolygonShader.vertexShader,this.fragmentShader=r.GroundPolygonShader.fragmentShader}refreshUniforms(){this.uniforms.clampMode.value=this.clampMode,this.uniforms.viewport.value.copy(this.viewport)}}r.GroundPolygonMaterial=e}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(e),this.type="ClipCapsPickTestMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.PlaneScanShader.uniforms]),this.vertexShader="\n                varying vec3 vPos;\n                varying float pixelMeter;\n                uniform vec2 viewportSize;\n                uniform vec3 pickPoint;\n                uniform vec4 frustumPlanes;\n                uniform float cameraNear;\n                uniform float pixelRatio;\n\n                float metersPerPixel(vec4 positionEC) {\n                    float width = viewportSize.x;\n                    float height = viewportSize.y;\n                    float pixelWidth;\n                    float pixelHeight;\n                    float top = frustumPlanes.x;\n                    float bottom = frustumPlanes.y;\n                    float left = frustumPlanes.z;\n                    float right = frustumPlanes.w;\n            \n                    float distanceToPixel = -positionEC.z;\n                    float inverseNear = 1.0 / cameraNear;\n                    float tanTheta = top * inverseNear;\n                    pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n                    tanTheta = right * inverseNear;\n                    pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n            \n                    return max(pixelWidth, pixelHeight) * pixelRatio;\n                }\n\n                void main() {\n                vPos = position;\n                vec3 transformed = vec3( pickPoint );\n                vec4 positionEC = vec4(transformed, 1.0);\n                positionEC = modelViewMatrix * positionEC;\n                pixelMeter = metersPerPixel(positionEC);\n\n                gl_Position = projectionMatrix *\n                                modelViewMatrix *\n                                vec4(position,1.0);\n                }\n            ",this.fragmentShader="\n            varying vec3 vPos;\n            uniform sampler2D pickTemplate;\n            uniform vec2 viewportSize;\n            uniform vec3 pickPoint;\n            varying float pixelMeter;\n\n            void main() {\n                vec3 subVec = abs(pickPoint - vPos);\n                float length = length(subVec);\n                if(length < pixelMeter){\n                    vec2 screenUV = vec2(gl_FragCoord.x/viewportSize.x,gl_FragCoord.y/viewportSize.y);\n                    vec4 testColor = texture2D(pickTemplate,screenUV);\n                    if(testColor.w > 0.)\n                    {\n                        gl_FragColor = testColor;\n                    }\n                    else\n                    {\n                        discard;\n                    }\n                }     \n            }\n            \n        ",this.uniforms.pickPoint={value:new THREE.Vector3},this.uniforms.pickTemplate={value:null},this.uniforms.viewportSize={value:new THREE.Vector2},this.uniforms.pixelRatio={value:1},this.uniforms.cameraNear={value:.1},this.uniforms.frustumPlanes={value:new THREE.Vector4},this.side=THREE.DoubleSide}}r.ClipCapsPickTestMaterial=e}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(),this.type="SpriteMaterial",this.color=new THREE.Color(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this}}e.prototype.isSpriteMaterial=!0,r.SpriteShaderMaterial=e}(),function(){function e(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void realMain()"),i(e),e.fragmentShader+="\n      void main(){\n        realMain();\n\n        // // alpha >= PSEUDO_TRANSPARENT_ALPHA当不透明物体处理，直接discard掉, 这种像素方式剔除，会出现显示不平滑现象\n        // if(gl_FragColor.a >= PSEUDO_TRANSPARENT_ALPHA){\n        //   discard;\n        // }\n\n        vec3 Ci = gl_FragColor.rgb * gl_FragColor.a;\n        float ai = gl_FragColor.a;\n        float zi = gl_FragCoord.z;\n        float wzi = oit_weight(zi, ai);\n        gl_FragColor = vec4(Ci, ai) * wzi;\n      }\n      "}function t(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void realMain()"),i(e),e.fragmentShader+="\n      void main(){\n        realMain();\n        \n        // if(gl_FragColor.a >= PSEUDO_TRANSPARENT_ALPHA){\n        //   discard;\n        // }\n\n        // float ai = gl_FragColor.a;\n        // // gl_FragColor = vec4(ai);\n        // gl_FragColor.r = ai;\n        \n        float zi = gl_FragCoord.z;\n        // 获得最大的权重累积值\n        float wzi = oit_weight(zi, 1.0);\n        float ai = gl_FragColor.a;\n        gl_FragColor = vec4(wzi, 0.0, 0.0, ai);\n      }\n      "}function i(e){e.fragmentShader+=" \n        const float PSEUDO_TRANSPARENT_ALPHA = 0.99;\n        float oit_weight(float z, float a){\n          return pow(a + 0.01, 4.0) + max(1e-2, min(3.0 * 1e3, 0.03 / (1e-5 + pow(abs(z) / 200.0, 4.0))));\n        }\n    "}function n(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void realMain()"),e.fragmentShader+="\n      const float PSEUDO_TRANSPARENT_ALPHA = 0.99;\n      // vec4 alias_gl_FragColor;\n      void main(){\n        realMain();\n        if(gl_FragColor.a < PSEUDO_TRANSPARENT_ALPHA){\n          discard;\n        }\n      }\n      "}function s(e){n(e)}r.OIT=class{constructor(e){this._renderer=e.renderer,this._webgl2Support=r.Utils.defaultValue(e.webgl2Support,!0),this._fullScreenQuad=void 0,this._accumColorTarget=void 0,this._accumAlphaTarget=void 0,this._antialiasColorTarget=void 0,this._oldRenderState={clearColor:new THREE.Color,clearAlpha:1,autoClear:!0,autoClearColor:!0,autoClearDepth:!0,autoClearStencil:!0},this._initialized=!1,this._antialiasMode=r.EnumAntialiasMode.FXAA,this._antialiasModeLast=void 0}destroy(){this._oldRenderState=void 0,this._renderer=void 0,this._fullScreenQuad&&(this._fullScreenQuad.dispose(),this._fullScreenQuad=void 0),this._accumColorTarget&&(this._accumColorTarget.dispose(),this._accumColorTarget=void 0),this._accumAlphaTarget&&(this._accumAlphaTarget.dispose(),this._accumAlphaTarget=void 0),this._antialiasColorTarget&&(this._antialiasColorTarget.dispose(),this._antialiasColorTarget=void 0),this._antialiasPass&&(this._antialiasPass.dispose(),this._antialiasPass=void 0)}setSize(e,t){if(!this._accumColorTarget)return;let i=this._renderer.getPixelRatio(),r=e*i,n=t*i;this._accumColorTarget.setSize(r,n),this._accumAlphaTarget.setSize(r,n),this._antialiasColorTarget.setSize(r,n),this._antialiasPass.setSize(r,n)}setAntialiasMode(e){this._antialiasMode=e}_isInitialized(){return this._initialized}_init(){this._createFullScreenQuad(),this._createRenderTarget(),this._initialized=!0}_createAAPass(){const e=this._getDrawingSize();let t;switch(this._antialiasMode){case r.EnumAntialiasMode.SSAA:this._antialiasPass=new a.SSAAPass(e.width,e.height),this._antialiasPass.renderToScreen=!0,t=this._antialiasPass.material;break;case r.EnumAntialiasMode.SMAA:this._antialiasPass=new a.SMAAPass(e.width,e.height),this._antialiasPass.renderToScreen=!0,t=this._antialiasPass.materialBlend;break;case r.EnumAntialiasMode.FXAA:this._antialiasPass=new a.FXAAPass(e.width,e.height),this._antialiasPass.renderToScreen=!0,t=this._antialiasPass.material;break;case r.EnumAntialiasMode.NOAA:default:this._antialiasPass=new a.ShaderPass(THREE.CopyShader),this._antialiasPass.renderToScreen=!0,t=this._antialiasPass.material}t.premultipliedAlpha=!0,t.depthTest=!1,t.depthWrite=!1,t.transparent=!0}_chooseAntialiasPass(){this._antialiasModeLast!==this._antialiasMode&&(this._antialiasModeLast=this._antialiasMode,this._antialiasPass&&this._antialiasPass.dispose&&this._antialiasPass.dispose(),this._createAAPass())}_createFullScreenQuad(){const e=new THREE.ShaderMaterial({uniforms:{uAccumulate:{value:null},uAccumulateAlpha:{value:null}},vertexShader:"\n      #ifdef USE_GL1\n        varying vec2 vUv;\n      #endif\n\n      void main() {\n\n        #ifdef USE_GL1\n          vUv = uv;\n        #endif\n\n        gl_Position = vec4(position, 1.0);\n      }\n    ",fragmentShader:"\n      precision highp float;\n      uniform sampler2D uAccumulate;\n      uniform sampler2D uAccumulateAlpha;\n\n      #ifdef USE_GL1\n        varying vec2 vUv;\n      #endif\n\n      void main() {\n        vec4 accum = vec4(0);\n        vec4 accumAlpha = vec4(0);\n        #ifdef USE_GL1\n          accum = texture2D(uAccumulate, vUv);\n          accumAlpha = texture2D(uAccumulateAlpha, vUv);\n        #else\n          ivec2 fragCoord = ivec2(gl_FragCoord.xy);\n          accum = texelFetch(uAccumulate, fragCoord, 0);\n          accumAlpha = texelFetch(uAccumulateAlpha, fragCoord, 0);\n        #endif\n        \n        float revealage = accumAlpha.a;\n        float maxAccumAlpha = max(5e4, accumAlpha.r);\n        vec4 currFragColor = vec4(accum.rgb / clamp(accum.a, 1e-4, maxAccumAlpha), 1.0 - revealage);\n        gl_FragColor = vec4(currFragColor.rgb * currFragColor.a, currFragColor.a);\n      }\n    ",depthTest:!1,depthWrite:!1});this._webgl2Support||(e.defines.USE_GL1=""),this._fullScreenQuad=new THREE.Pass.FullScreenQuad(e)}_getDrawingSize(){const e=this._renderer,t=e.getPixelRatio();let i=new THREE.Vector2;return e.getSize(i),{width:i.x*t,height:i.y*t}}_createRenderTarget(){const e=this._renderer,t=this._getDrawingSize(),i=t.width,r=t.height,n=null===e.extensions.get("OES_texture_float_linear")?THREE.HalfFloatType:THREE.FloatType,a=new THREE.DepthTexture;a.type=this._webgl2Support?n:THREE.UnsignedIntType;const s=THREE.WebGLRenderTarget,o=THREE.LinearFilter,l=THREE.LinearFilter;this._accumColorTarget=new s(i,r,{minFilter:o,magFilter:l,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:n});const d=this._accumColorTarget;d.stencilBuffer=!1,d.depthBuffer=!0,d.depthTexture=a,this._accumAlphaTarget=new s(i,r,{minFilter:o,magFilter:l,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:n});const h=this._accumAlphaTarget;h.stencilBuffer=!1,h.depthBuffer=!0,h.depthTexture=a,this._antialiasColorTarget=new s(i,r,{minFilter:o,magFilter:l,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:n})}render(e,t,i){this._isInitialized()||this._init(),this._chooseAntialiasPass();const r=this._renderer;this._holdRenderState(),e.renderObjectsHolded=!0,this._hideDeferredComponent(i),this._holdBackground(e),this._renderForProjectObjectsOnly(e,t),this._updateBackgroud(e),this._renderOpaqueObjectsDepthOffScreen(e,t),this._renderPseudoTransparentObjectsDepthOffScreen(e,t),this._renderTransparentObjectsToTarget(r,e,t),this._resetRenderState(),r.setRenderTarget(null),this._renderOpaqueObjects(e,t),this._renderTransparentObjectsDepth(e,t),this._renderTransparentObjects(),this._showDeferredComponent(i),this._renderDeferredComponent(e,t,i),this._resetRenderState(),this._resetBackground(e),this._clearSceneRenderCache(e)}_holdMaterialStateForTransparentObjects(e){e.forEach((e=>{const t=e.material;t._holdedProperties={blending:t.blending,blendSrc:t.blendSrc,blendDst:t.blendDst,blendSrcAlpha:t.blendSrcAlpha,blendDstAlpha:t.blendDstAlpha,depthWrite:t.depthWrite,depthTest:t.depthTest,onBeforeCompile:t.onBeforeCompile}}))}_updateMaterialStateForTransparentObjects(i,r){let n=r?t:e;i.forEach((e=>{const t=e.material;t.blending=THREE.CustomBlending,r?(t.blendSrc=THREE.OneFactor,t.blendDst=THREE.OneFactor,t.blendSrcAlpha=THREE.ZeroFactor,t.blendDstAlpha=THREE.OneMinusSrcAlphaFactor):(t.blendSrc=THREE.OneFactor,t.blendDst=THREE.OneFactor,t.blendSrcAlpha=THREE.OneFactor,t.blendDstAlpha=THREE.OneFactor),t.depthWrite=!1,t.depthTest=!0,t.onBeforeCompile=n,t.needsUpdate=!0}))}_resetMaterialStateForTransparentObjects(e){e.forEach((e=>{const t=e.material,i=t._holdedProperties;t.blending=i.blending,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.onBeforeCompile=i.onBeforeCompile,t.needsUpdate=!0}))}_holdMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material;t._holdedProperties={blending:t.blending,depthWrite:t.depthWrite,depthTest:t.depthTest,colorWrite:t.colorWrite,onBeforeCompile:t.onBeforeCompile}}))}_updateMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material;t.blending=THREE.NoBlending,t.depthWrite=!0,t.depthTest=!0,t.onBeforeCompile=n,t.colorWrite=!1,t.needsUpdate=!0}))}_resetMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material,i=t._holdedProperties;t.blending=i.blending,t.depthTest=i.depthTest,t.depthWrite=i.depthWrite,t.colorWrite=i.colorWrite,t.onBeforeCompile=i.onBeforeCompile,t.needsUpdate=!0}))}_holdMaterialStateToPseudoAlphaCulling(e){this._holdMaterialStateToAlphaCulling(e)}_updateMaterialStateToPseudoAlphaCulling(e){e.forEach((e=>{const t=e.material;t.blending=THREE.NoBlending,t.depthWrite=!0,t.depthTest=!0,t.onBeforeCompile=s,t.colorWrite=!0,t.needsUpdate=!0}))}_resetMaterialStateToPseudoAlphaCulling(e){this._resetMaterialStateToAlphaCulling(e)}_holdMaterialStateForObjects(e){e.forEach((e=>{e.material._colorWrite=e.material.colorWrite}))}_updateMaterialStateForObjects(e){e.forEach((e=>{e.material.colorWrite=!1}))}_resetMaterialStateForObjects(e){e.forEach((e=>{e.material.colorWrite=e.material._colorWrite}))}_setRenderStateFlagForScene(e,t,i,r){e.renderStateInitSkipped=t,e.renderOpaqueObjectsSkipped=i,e.renderTransparentObjectsSkipped=r}_clearRenderStateFlagForScene(e){e.renderStateInitSkipped=void 0,e.renderOpaqueObjectsSkipped=void 0,e.renderTransparentObjectsSkipped=void 0}_clearSceneRenderCache(e){e.renderObjectsHolded=void 0,e.opaqueObjects=void 0,e.transparentObjects=void 0}_renderForProjectObjectsOnly(e,t){this._setRenderStateFlagForScene(e,!1,!0,!0);const i=this._renderer;i.setRenderTarget(null),i.render(e,t)}_renderOpaqueObjectsDepthOffScreen(e,t){this._setRenderStateFlagForScene(e,!0,!1,!0);const i=e.opaqueObjects;this._holdMaterialStateForObjects(i),this._updateMaterialStateForObjects(i);const r=this._renderer;r.setClearColor(0,1),r.autoClear=!0,r.autoClearColor=!0,r.autoClearDepth=!0,r.autoClearStencil=!0,r.setRenderTarget(this._accumColorTarget),r.render(e,t),this._resetMaterialStateForObjects(i),this._clearRenderStateFlagForScene(e)}_renderPseudoTransparentObjectsDepthOffScreen(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateToAlphaCulling(i),this._updateMaterialStateToAlphaCulling(i);const r=this._renderer;r.setClearColor(0,1),r.autoClear=!1,r.setRenderTarget(this._accumColorTarget),r.render(e,t),this._resetMaterialStateToAlphaCulling(i),this._clearRenderStateFlagForScene(e)}_renderTransparentObjectsOffScreen(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateForTransparentObjects(i),this._updateMaterialStateForTransparentObjects(i);const r=this._renderer;r.setClearColor(0,0),r.autoClear=!0,r.autoClearColor=!0,r.autoClearDepth=!1,r.autoClearStencil=!0,r.setRenderTarget(this._accumColorTarget),r.render(e,t),this._updateMaterialStateForTransparentObjects(i,!0),r.setClearColor(16777215,1),r.setRenderTarget(this._accumAlphaTarget),r.render(e,t),r.setRenderTarget(null),this._resetMaterialStateForTransparentObjects(i),this._clearRenderStateFlagForScene(e)}_renderPseudoTransparentObjects(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateToPseudoAlphaCulling(i),this._updateMaterialStateToPseudoAlphaCulling(i);const r=this._renderer;r.autoClear=!1,r.render(e,t),this._resetMaterialStateToPseudoAlphaCulling(i),this._clearRenderStateFlagForScene(e)}_renderOpaqueObjects(e,t){this._setRenderStateFlagForScene(e,!0,!1,!0);this._renderer.render(e,t),this._clearRenderStateFlagForScene(e)}_renderTransparentObjectsDepth(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateForObjects(i),this._updateMaterialStateForObjects(i);const r=this._renderer;r.autoClear=!1,r.render(e,t),this._resetMaterialStateForObjects(i),this._clearRenderStateFlagForScene(e)}_renderTransparentObjects(){this._renderTransparentObjectsToFSQuad()}_renderTransparentObjectsToSampleTarget(e){const t=this._fullScreenQuad.material.uniforms;t.uAccumulate.value=this._accumColorTarget.texture,t.uAccumulateAlpha.value=this._accumAlphaTarget.texture;const i=this._renderer;i.setClearColor(0,0),i.autoClear=!0,i.autoClearColor=!0,i.autoClearDepth=!0,i.autoClearStencil=!0,i.setRenderTarget(e),this._fullScreenQuad.render(i),i.setRenderTarget(null),t.uAccumulate.value=null,t.uAccumulateAlpha.value=null}_renderTransparentObjectsToTarget(e,t,i){this._renderTransparentObjectsOffScreen(t,i),this._renderTransparentObjectsToSampleTarget(this._antialiasColorTarget)}_renderTransparentObjectsToFSQuad(){const e=this._renderer;e.autoClear=!1,this._antialiasPass.render(e,void 0,this._antialiasColorTarget)}_renderDeferredComponent(e,t,i){i.hideAllExcludeWireframes(),this._renderWithConstraint(e,t),i.showAllExcludeWireframes(),i.resetAllNodeGroupVisibility(),i.resetClipPlaneGroupVisibility()}_renderWithConstraint(e,t){this._setRenderStateFlagForScene(e,!1,!1,!1);const i=this._renderer;i.autoClear=!1,i.render(e,t),this._clearRenderStateFlagForScene(e)}_holdRenderState(){const e=this._renderer,t=this._oldRenderState;e.getClearColor(t.clearColor),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.autoClearColor=e.autoClearColor,t.autoClearDepth=e.autoClearDepth,t.autoClearStencil=e.autoClearStencil}_resetRenderState(){const e=this._renderer,t=this._oldRenderState;e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.autoClearColor=t.autoClearColor,e.autoClearDepth=t.autoClearDepth,e.autoClearStencil=t.autoClearStencil}_holdBackground(e){e.background&&(e._background={},e._background.isTexture=e.background.isTexture,e._background.isColor=e.background.isColor,e._background.isCubeTexture=e.background.isCubeTexture,e._background.mapping=e.background.mapping)}_updateBackgroud(e){e.background&&(e.background.isTexture=!1,e.background.isColor=!1,e.background.isCubeTexture=!1,e.background.mapping=void 0)}_resetBackground(e){e.background&&(e.background.isTexture=e._background.isTexture,e.background.isColor=e._background.isColor,e.background.isCubeTexture=e._background.isCubeTexture,e.background.mapping=e._background.mapping,e._background=void 0)}_hideDeferredComponent(e){e.holdAllNodeGroupVisibility(),e.hideAllWireframes(),e.holdClipPlaneGroupVisibility(),e.hideClipPlaneGroup()}_showDeferredComponent(e){e.showAllWireframes(),e.showClipPlaneGroup()}}}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;let i;t.scene=e.scene,t.CONST_G=4.9,t.disPickable=!0,t.autoAnimation=!0,t.color=new THREE.Color(1,1,1),t.originPosition=new THREE.Vector3(0,0,0),t.originIntensity=.5,t.radius=2e4,t.originYaw=0,t.originPitch=0,t.particleScale=1,t.camera=e.camera,t.loader=new THREE.TextureLoader,t.zoomGis=1,t.setOpts(e),i=window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?window.BimfaceLoaderConfig.fullStaticHost+"/images/":"../../resources/Effect/",t.particleOpt=[{baseScale:60,imageUrl:`${i}sprayWater0.png`,minimumSpeed:22,maximumSpeed:25,minimumParticleLife:3.5,maximumParticleLife:4.5,emissionRate:1,radius:1,color:[{startAge:0,endAge:.4,startColor:.1,endColor:.15},{startAge:.4,endAge:1,startColor:.15,endColor:0}],scale:[{startAge:0,endAge:.3,startScale:.3,endScale:.66},{startAge:.3,endAge:.9,startScale:.66,endScale:15},{startAge:.9,endAge:1,startScale:3,endScale:20}],applyGravity:t.CONST_G,randomXY:.09},{baseScale:50,imageUrl:`${i}sprayWater1.png`,minimumSpeed:22,maximumSpeed:25,minimumParticleLife:3.5,maximumParticleLife:4,emissionRate:15,radius:1,color:[{startAge:0,endAge:.7,startColor:1,endColor:.2},{startAge:.7,endAge:1,startColor:.2,endColor:0}],scale:[{startAge:0,endAge:.4,startScale:.1,endScale:.66},{startAge:.4,endAge:1,startScale:.66,endScale:3.5}],applyGravity:t.CONST_G,randomXY:.08},{baseScale:110,imageUrl:`${i}sprayWater2.png`,minimumSpeed:23,maximumSpeed:24,minimumParticleLife:1.2,maximumParticleLife:1.8,emissionRate:1,radius:.5,color:[{startAge:0,endAge:.8,startColor:1,endColor:.8},{startAge:.8,endAge:1,startColor:.8,endColor:0}],scale:[{startAge:0,endAge:1,startScale:.3,endScale:1}],applyGravity:t.CONST_G,randomFrameNumber:!0,repeatX:.3,randomXY:.04},{baseScale:120,imageUrl:`${i}sprayWater3.png`,minimumSpeed:23,maximumSpeed:24,minimumParticleLife:1,maximumParticleLife:1.3,emissionRate:1,radius:.5,color:[{startAge:0,endAge:1,startColor:.5,endColor:.4}],scale:[{startAge:0,endAge:1,startScale:.3,endScale:1}],randomFrameNumber:!0,applyGravity:t.CONST_G,repeatX:.8,randomXY:.04}],t.water=[];for(var n=0;n<t.particleOpt.length;n++){for(var a=[],s=0;s<t.particleOpt[n].color.length;s++)a.push({startAge:t.particleOpt[n].color[s].startAge,endAge:t.particleOpt[n].color[s].endAge,startColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[n].color[s].startColor),endColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[n].color[s].endColor)});var o=new r.ParticleSystem({emissionRate:Math.floor(t.particleOpt[n].emissionRate*(1+t.originIntensity)),emitPosition:new THREE.Vector3(0,0,0),originYaw:t.originYaw,originPitch:t.originPitch,minimumSpeed:t.particleOpt[n].minimumSpeed*t.originIntensity/t.zoomGis,maximumSpeed:t.particleOpt[n].maximumSpeed*t.originIntensity/t.zoomGis,size:t.particleScale*t.particleOpt[n].baseScale/t.zoomGis,minimumParticleLife:t.particleOpt[n].minimumParticleLife*t.originIntensity/1.1,maximumParticleLife:t.particleOpt[n].maximumParticleLife*t.originIntensity/1.1,imgTexture:t.loader.load(t.particleOpt[n].imageUrl),color:a,scale:t.particleOpt[n].scale,updateCallback:t.particleOpt[n].updateCallback,applyGravity:null!=t.particleOpt[n].applyGravity?t.particleOpt[n].applyGravity/t.zoomGis:null,randomXY:t.particleOpt[n].randomXY*t.spread,repeatX:0==t.originPitch?t.particleOpt[n].repeatX:1,repeatY:t.particleOpt[n].repeatY,radius:t.particleOpt[n].radius*t.radius/t.zoomGis,camera:t.camera,randomFrameNumber:t.particleOpt[n].randomFrameNumber});t.water.push(o),t.add(o.particleSystem)}}destroy(){for(var e=this,t=0;t<e.water.length;t++)e.water[t].destroy(),e.remove(e.water[t].particleSystem);e.loader=null}play(){for(var e=0;e<this.water.length;e++)this.water[e].play()}stop(){for(var e=0;e<this.water.length;e++)this.water[e].stop()}update(){for(var e=0;e<this.water.length;e++)this.water[e].render()}effectOpt(e){var t=this;t.setOpts(e);for(var i=0;i<t.water.length;i++){for(var r=[],n=0;n<t.particleOpt[i].color.length;n++)r.push({startAge:t.particleOpt[i].color[n].startAge,endAge:t.particleOpt[i].color[n].endAge,startColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[i].color[n].startColor),endColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[i].color[n].endColor)});t.water[i].effectOpt({size:t.particleScale*t.particleOpt[i].baseScale/t.zoomGis,repeatX:0==t.originPitch?t.particleOpt[i].repeatX:1,originPitch:t.originPitch,originYaw:t.originYaw,minimumParticleLife:t.particleOpt[i].minimumParticleLife*t.originIntensity/1.1,maximumParticleLife:t.particleOpt[i].maximumParticleLife*t.originIntensity/1.1,randomXY:t.particleOpt[i].randomXY*t.spread,minimumSpeed:t.particleOpt[i].minimumSpeed*t.originIntensity/t.zoomGis,maximumSpeed:t.particleOpt[i].maximumSpeed*t.originIntensity/t.zoomGis,color:r,radius:t.particleOpt[i].radius*t.radius/t.zoomGis,emissionRate:Math.floor(t.particleOpt[i].emissionRate*(1+t.originIntensity))})}}hide(){for(var e=0;e<this.water.length;e++)this.water[e].hide()}show(){for(var e=0;e<this.water.length;e++)this.water[e].show()}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.originPitch&&null!==e.originPitch&&(t.originPitch=e.originPitch),void 0!==e.originYaw&&null!==e.originYaw&&(t.originYaw=e.originYaw),void 0!==e.scale&&null!==e.scale&&(t.particleScale=e.scale/5),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()),void 0!==e.spread&&null!==e.spread&&(t.spread=e.spread),void 0!==e.originRadius&&null!==e.originRadius&&(t.radius=e.originRadius),void 0!==e.originIntensity&&null!==e.originIntensity&&(t.originIntensity=e.originIntensity+.1),null!==e.isGis&&1==e.isGis&&(t.zoomGis=1e3))}}r.SprayWater=e}(),r.Particle=class{constructor(e){var t=this;t.size=e.size,t.alpha=e.alpha,t.visible=0,t.birth=e.birth,t.age=e.age,t.minimumParticleLife=e.minimumParticleLife,t.maximumParticleLife=e.maximumParticleLife,t.minimumSpeed=e.minimumSpeed,t.maximumSpeed=e.maximumSpeed,t.scaleAry=e.scaleAry,t.colorAry=e.colorAry,t.emitPosition=e.emitPosition,t.radius=e.radius,t.initSize=e.initSize,t.updateCallback=e.updateCallback,t.camera=e.camera,t.life=0,t.initVelocity=e.initVelocity,t.normalizedAge=0,t.originPitch=e.originPitch,t.birthplace={x:0,y:0,z:0},t.velocity={x:0,y:0,z:0},t.position={x:0,y:0,z:0},t.randomXY=e.randomXY,t.applyGravity=e.applyGravity,t.randomFrameNumber=e.randomFrameNumber,t.color=new THREE.Color}updateStatus(e){var t=this;if(null!=t.birth&&e!=t.birth)if(t.age=e-t.birth,t.age>t.life)t.visible=0;else{t.visible=1,t.randomFrameNumber&&(t.age=t.age+50*(2*Math.random()-1),t.age<0&&(t.age=0),t.age>t.life&&(t.age=t.life)),t.normalizedAge=t.age/t.life;for(var i=0;i<t.scaleAry.length;i++)if(t.normalizedAge<=t.scaleAry[i].endAge){t.size=t.initSize*r.Math.tweens(t.scaleAry[i].startScale,t.scaleAry[i].endScale,t.normalizedAge-t.scaleAry[i].startAge,t.scaleAry[i].endAge-t.scaleAry[i].startAge);break}for(i=0;i<t.colorAry.length;i++)if(t.normalizedAge<=t.colorAry[i].endAge){var n=t.normalizedAge-t.colorAry[i].startAge,a=t.colorAry[i].endAge-t.colorAry[i].startAge;t.color.setRGB(r.Math.tweens(t.colorAry[i].startColor.x,t.colorAry[i].endColor.x,n,a),r.Math.tweens(t.colorAry[i].startColor.y,t.colorAry[i].endColor.y,n,a),r.Math.tweens(t.colorAry[i].startColor.z,t.colorAry[i].endColor.z,n,a)),t.alpha=r.Math.tweens(t.colorAry[i].startColor.w,t.colorAry[i].endColor.w,n,a);break}t.position={x:t.birthplace.x+t.velocity.x*t.normalizedAge,y:t.birthplace.y+t.velocity.y*t.normalizedAge,z:t.birthplace.z+t.velocity.z*t.normalizedAge},null!=t.applyGravity&&(t.position.z=t.position.z-t.applyGravity*Math.pow(t.age/1e3,2)*1e3),null!=t.updateCallback&&t.updateCallback(t)}}init(e){var t=this;t.birth=e,t.age=0,t.life=1e3*t.minimumParticleLife+Math.random()*(t.maximumParticleLife-t.minimumParticleLife)*1e3;var i=t.minimumSpeed+Math.random()*(t.maximumSpeed-t.minimumSpeed);t.normalizedAge=0,t.visible=1,null!=t.scaleAry&&(t.size=t.initSize*t.scaleAry[0].startScale),null!=t.colorAry&&(t.color.setRGB(t.colorAry[0].startColor.x,t.colorAry[0].startColor.y,t.colorAry[0].startColor.z),t.alpha=t.colorAry[0].startColor.w),t.velocity={x:t.initVelocity.x*i*t.life,y:t.initVelocity.y*i*t.life,z:t.initVelocity.z*i*t.life},null!=t.randomXY&&(t.velocity.x=t.velocity.x+i*t.life*t.randomXY*(2*Math.random()-1),t.velocity.y=t.velocity.y+i*t.life*t.randomXY*(2*Math.random()-1)),t.birthplace={x:t.emitPosition.x+(2*Math.random()-1)*t.radius,y:t.emitPosition.y+(2*Math.random()-1)*t.radius,z:t.emitPosition.z},t.position={x:t.birthplace.x,y:t.birthplace.y,z:t.birthplace.z}}destroy(){var e=this;e.velocity=null,e.position=null,e.birthplace=null,e.emitPosition=null,e.color=null}},function(){class e extends THREE.ShaderMaterial{constructor(e){super(e);var t=this;this.clipping=!0,t.vertexShader=t.getVertexShader(),t.fragmentShader=t.getFragmentShader()}getVertexShader(){return"\n                attribute float size;\n                attribute float alpha;\n                attribute vec3 color;\n\n                varying vec3 vColor;\n                varying float vAlpha;\n                varying float clipSize;\n\n                #include <common>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                void main() {\n                    vAlpha= alpha;\n                    vColor = color;\n                    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\n                    #include <clipping_planes_vertex>\n                    gl_PointSize = size * ( 300.0 / -mvPosition.z );\n                    clipSize = gl_PointSize * 0.5;\n                    gl_Position = projectionMatrix * mvPosition;\n                    #include <logdepthbuf_vertex>\n                }"}getFragmentShader(){return"\n                mat2 rotate(float rad) {\n                    float c = cos(rad);\n                    float s = sin(rad);\n                    return mat2(\n                        c, s,\n                        -s, c\n                    );\n                }\n                uniform sampler2D pointTexture;\n                uniform float repeatX;\n                uniform float repeatY;\n                varying vec3 vColor;\n                varying float vAlpha;\n                varying float clipSize;\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                void main() {\n                    #include <num_clipping_planes_for_particle_fragment>\n                    #include <logdepthbuf_fragment>\n                    vec2 pos = gl_PointCoord;\n                    float offsetX =(1.0-repeatX)/2.0;\n                    float offsetY =(1.0-repeatY)/2.0;\n                    if(pos.x-offsetX>repeatX || pos.x-offsetX<0.0 || pos.y-offsetY>repeatY || pos.y-offsetY<0.0) discard;\n                    vec4 img = texture2D(pointTexture, vec2((pos.x-offsetX)/repeatX, (pos.y-offsetY)/repeatY));\n                    vec4 color = vec4( vColor, vAlpha );\n                    gl_FragColor = vec4(color.xyz, color.w * img.w);\n                }"}}r.ParticleMaterial=e}(),r.ParticleSystem=class{constructor(e){var t=this;t.showParticle=!0,t.particleSystemManager=new r.ParticleSystemManager(t,e),t.repeatX=1,t.repeatY=1,t.imgTexture=null,t.uniforms={pointTexture:{value:t.imgTexture},repeatX:{value:t.repeatX},repeatY:{value:t.repeatY}},t.setOpts(e),t.shaderMaterial=new r.ParticleMaterial({uniforms:t.uniforms,blending:THREE.NormalBlending,depthTest:!0,depthWrite:!1,transparent:!0}),t.geometry=new THREE.BufferGeometry,t.particleSystem=new THREE.Points(t.geometry,t.shaderMaterial)}destroy(){this.particleSystemManager.destroy()}stop(){this.particleSystemManager.stop()}play(){this.particleSystemManager.play()}render(){this.particleSystemManager.render()}hide(){var e=this;e.showParticle=!1,null!=e.particleSystem&&(e.particleSystem.visible=e.show)}show(){var e=this;e.showParticle=!0,null!=e.particleSystem&&(e.particleSystem.visible=e.show)}setOpts(e){var t=this;null!=e.repeatX&&(t.repeatX=e.repeatX,t.uniforms.repeatX.value=t.repeatX),null!=e.repeatY&&(t.repeatY=e.repeatY,t.uniforms.repeatY.value=t.repeatY),null!=e.imgTexture&&t.imgTexture!=e.imgTexture&&(t.imgTexture=e.imgTexture,t.imgTexture.wrapS=THREE.ClampToEdgeWrapping,t.imgTexture.wrapT=THREE.ClampToEdgeWrapping,t.imgTexture.minFilter=THREE.NearestFilter,t.uniforms.pointTexture.value=t.imgTexture)}effectOpt(e){this.setOpts(e),this.particleSystemManager.effectOpt(e)}update(e){var t=this;null==e.position||null!=t.geometry.attributes.position&&t.geometry.attributes.position.array.length==e.position.length||t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(e.position,3)),null==e.color||null!=t.geometry.attributes.color&&t.geometry.attributes.color.array.length==e.color.length||t.geometry.setAttribute("color",new THREE.Float32BufferAttribute(e.color,3)),null==e.size||null!=t.geometry.attributes.size&&t.geometry.attributes.size.array.length==e.size.length||t.geometry.setAttribute("size",new THREE.Float32BufferAttribute(e.size,1).setUsage(THREE.DynamicDrawUsage)),null==e.alpha||null!=t.geometry.attributes.alpha&&t.geometry.attributes.alpha.array.length==e.alpha.length||t.geometry.setAttribute("alpha",new THREE.Float32BufferAttribute(e.alpha,1).setUsage(THREE.DynamicDrawUsage)),t.particleSystem.visible=t.showParticle;var i=t.geometry.attributes.size.array,r=t.geometry.attributes.color.array,n=t.geometry.attributes.alpha.array,a=t.geometry.attributes.position.array;if(null!=e.position)for(var s=0;s<e.position.length;s++)a[s]=e.position[s];if(null!=e.color)for(s=0;s<e.color.length;s++)r[s]=e.color[s];if(null!=e.alpha)for(s=0;s<e.alpha.length;s++)n[s]=e.alpha[s];if(null!=e.size)for(s=0;s<e.size.length;s++)i[s]=e.size[s];t.geometry.attributes.size.needsUpdate=e.sizeNeedsUpdate,t.geometry.attributes.color.needsUpdate=e.colorNeedsUpdate,t.geometry.attributes.alpha.needsUpdate=e.alphaNeedsUpdate,t.geometry.attributes.position.needsUpdate=e.positionNeedsUpdate}},r.ParticleSystemManager=class{constructor(e,t){var i=this;i.FPS=20,i.FPS_MS=1e3/i.FPS,i.particleSystem=e,i.particleList=[],i.initialOpts(t)}initialOpts(e){var t=this;t.setOpts(e);for(var i=0;i<t.count;i++)t.createParticle()}createParticle(){var e=this,t=new r.Particle({initSize:e.size,initVelocity:e.initVelocity,emitPosition:e.emitPosition,scaleAry:e.scale,colorAry:e.color,minimumSpeed:e.minimumSpeed,maximumSpeed:e.maximumSpeed,minimumParticleLife:e.minimumParticleLife,maximumParticleLife:e.maximumParticleLife,originPitch:e.originPitch,radius:e.radius,updateCallback:e.updateCallback,applyGravity:e.applyGravity,randomFrameNumber:e.randomFrameNumber,randomXY:e.randomXY,camera:e.camera});e.particleList.push(t)}setOpts(e){var t=this;null!=e.emissionRate&&(t.emissionRate=e.emissionRate),null!=e.minimumParticleLife&&(t.minimumParticleLife=e.minimumParticleLife),null!=e.maximumParticleLife&&(t.maximumParticleLife=e.maximumParticleLife),null!=e.originYaw&&(t.originYaw=e.originYaw),null!=e.originPitch&&(t.originPitch=e.originPitch),null!=e.originYaw&&(t.initVelocity={z:Math.cos(t.originPitch),x:Math.sin(t.originPitch)*Math.cos(t.originYaw),y:Math.sin(t.originPitch)*Math.sin(t.originYaw)}),null!=e.size&&(t.size=e.size),null!=e.emitPosition&&(t.emitPosition=e.emitPosition),null!=e.scale&&(t.scale=e.scale),null!=e.color&&(t.color=e.color),null!=e.minimumSpeed&&(t.minimumSpeed=e.minimumSpeed),null!=e.maximumSpeed&&(t.maximumSpeed=e.maximumSpeed),null!=e.radius&&(t.radius=e.radius),null!=e.updateCallback&&(t.updateCallback=e.updateCallback),null!=e.applyGravity&&(t.applyGravity=e.applyGravity),null!=e.randomFrameNumber&&(t.randomFrameNumber=e.randomFrameNumber),null!=e.randomXY&&(t.randomXY=e.randomXY),null!=e.camera&&(t.camera=e.camera),t.renderCount=Math.floor(t.FPS*t.maximumParticleLife),t.count=t.emissionRate*t.renderCount}effectOpt(e){var t=this;if(t.setOpts(e),t.count<t.particleList.length)t.particleList.length=t.count;else if(t.count>t.particleList.length)for(var i=t.particleList.length;i<t.count;i++)t.createParticle();for(i=0;i<t.particleList.length;i++)t.particleList[i].initSize=t.size,t.particleList[i].initVelocity=t.initVelocity,t.particleList[i].emitPosition=t.emitPosition,t.particleList[i].scaleAry=t.scale,t.particleList[i].colorAry=t.color,t.particleList[i].minimumSpeed=t.minimumSpeed,t.particleList[i].maximumSpeed=t.maximumSpeed,t.particleList[i].minimumParticleLife=t.minimumParticleLife,t.particleList[i].maximumParticleLife=t.maximumParticleLife,t.particleList[i].originPitch=t.originPitch,t.particleList[i].radius=t.radius,t.particleList[i].updateCallback=t.updateCallback,t.particleList[i].applyGravity=t.applyGravity,t.particleList[i].randomFrameNumber=t.randomFrameNumber,t.particleList[i].randomXY=t.randomXY,t.particleList[i].camera=t.camera}stop(){this.startTime=null}play(){var e=this;e.startTime=(new Date).getTime(),e.renderTimes=0,e.loops=0}render(){var e=this,t=(new Date).getTime();if(null!=e.startTime){var i=(t-e.startTime)%(1e3*e.maximumParticleLife),r=Math.floor((t-e.startTime)/(1e3*e.maximumParticleLife));for(r>e.loops?(e.loops=r,e.renderTimes=0):r<e.loops&&(e.loops=r);e.renderTimes*e.FPS_MS<=i;){for(var n=e.renderTimes*e.emissionRate;n<(e.renderTimes+1)*e.emissionRate;n++)n<e.particleList.length&&e.particleList[n].init(t-i+e.renderTimes*e.FPS_MS);e.renderTimes++}}var a={position:[],color:[],alpha:[],size:[]};for(n=0;n<e.count;n++)e.particleList[n].updateStatus(t),a.position.push(e.particleList[n].position.x),a.position.push(e.particleList[n].position.y),a.position.push(e.particleList[n].position.z),a.color.push(e.particleList[n].color.r),a.color.push(e.particleList[n].color.g),a.color.push(e.particleList[n].color.b),0==e.particleList[n].visible?a.alpha.push(0):a.alpha.push(e.particleList[n].alpha),a.size.push(e.particleList[n].size);a.angleNeedsUpdate=!0,a.sizeNeedsUpdate=!0,a.colorNeedsUpdate=!0,a.alphaNeedsUpdate=!0,a.positionNeedsUpdate=!0,e.particleSystem.update(a)}destroy(){this.particleSystem=null,this.initVelocity=null}},function(){class e extends THREE.Group{constructor(e){super();var t=this;t._running=!0,t._paused=!1,t._tickTimeFirst=void 0,t._tickTimeLast=void 0,t._visible=!0,t.disPickable=!0,t.autoAnimation=!0,null!=e.scene?t.scene=e.scene:t.scene=t,t.SQRT2=Math.SQRT2,t.setOpts(e),t.createLine(),t.createMesh(),t.show(),t.offsetHeight=0,t.hopFlg=!0}destroy(){var e=this;e._clear(),e.scene=void 0,e.meshGeometry=void 0,e.meshMaterial=void 0,e.lineGeometry=void 0,e.lineMaterial.color=void 0}createMesh(){var e=this;e.meshGeometry=new THREE.BufferGeometry;let t=new Float32Array([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]);e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(t,3));e.meshGeometry.setIndex([0,1,2,0,2,3,0,3,4,0,4,1,1,2,3,3,4,1]),e.meshGeometry.computeBoundingSphere(),e.meshMaterial=new THREE.MeshBasicMaterial({color:e.color,opacity:e.alpha,side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.scene.add(e.mesh)}updateMesh(){const e=this,t=e.meshGeometry.getAttribute("position");t.array.set([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]),t.needsUpdate=!0,e.meshGeometry.computeBoundingSphere(),e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha}createLine(){var e=this;e.lineGeometry=new THREE.BufferGeometry;let t=new Float32Array([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]);e.lineGeometry.setAttribute("position",new THREE.BufferAttribute(t,3));e.lineGeometry.setIndex([0,1,2,0,2,3,0,3,4,0,4,1]),e.lineGeometry.computeBoundingSphere(),e.lineMaterial=new THREE.MeshBasicMaterial({color:e.wireframeColor,opacity:e.wireframeAlpha,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!0,wireframeLinewidth:1,wireframeLinejoin:"round"}),e.line=new THREE.Mesh(e.lineGeometry,e.lineMaterial),e.scene.add(e.line)}updateLine(){const e=this,t=e.lineGeometry.getAttribute("position");t.array.set([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]),t.needsUpdate=!0,e.lineGeometry.computeBoundingSphere(),e.lineMaterial.color=e.wireframeColor,e.lineMaterial.opacity=e.wireframeAlpha}_clear(){var e=this;null!=e.mesh&&e.scene.remove(e.mesh),null!=e.line&&e.scene.remove(e.line),null!=e.lineGeometry&&e.lineGeometry.dispose(),null!=e.lineMaterial&&e.lineMaterial.dispose(),null!=e.meshGeometry&&e.meshGeometry.dispose(),null!=e.meshMaterial&&e.meshMaterial.dispose()}update(){var e=this;if(void 0===e._tickTimeFirst&&(e._tickTimeFirst=(new Date).getTime(),e._tickTimeLast=e._tickTimeFirst),!this._running)return void this._updatePosition();if(this._paused)return void this._updatePosition(e._tickTimeLast);const t=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this._updatePosition(t)}_updatePosition(e){var t=this;t.offsetHeight=void 0===e?0:r.Math.breatheTweens(0,t.size/2,e,t.duration),t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z+t.offsetHeight),t.updateMatrixWorld()}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}effectOpt(e){var t=this;t.setOpts(e),t.updateMesh(),t.updateLine(),t.lineMaterial.visible=t._visible,t.meshMaterial.visible=t._visible}hide(){var e=this;e._visible=!1,e.lineMaterial.visible=!1,e.meshMaterial.visible=!1}show(){var e=this;e._visible=!0,e.lineMaterial.visible=!0,e.meshMaterial.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.wireframeColor&&null!==e.wireframeColor&&(t.wireframeColor=e.wireframeColor),void 0!==e.wireframeAlpha&&null!==e.wireframeAlpha&&(t.wireframeAlpha=e.wireframeAlpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.size&&null!==e.size&&(t.size=e.size),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()),t.radius_SQRT2=t.size/t.SQRT2/2)}changeRotation(){this.rotation.x=Math.PI/2,this.updateMatrixWorld()}}r.PrismPoint=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.disPickable=!0,t.autoAnimation=!0,t.viewer=e.engineViewer,t.color=new THREE.Color(1,0,0),t.alpha=.8,t.duration=1e3,t.blendingRatio=0,t.directionType=0,t.directionReverse=0,t.height=1,t.wallTexture=null,t.stretch=!1,t.repeat=!0,t.path=[],t.sideSum=0,t.imageWidth=512,t.imageHeight=32,t.unitLength=1,null!=e.scene?t.scene=e.scene:t.scene=t,t.setOpts(e),t.createUpdateMesh(),t.show()}createUpdateMesh(){const e=this;null==e.meshGeometry&&(e.meshGeometry=new THREE.BufferGeometry),e.meshGeometry.dispose();const t=e.path.length;var i=[],n=[];e.sideSum=0;for(var a=0,s=0;s<t-1;s++){var o=Math.sqrt((e.path[s].x-e.path[s+1].x)*(e.path[s].x-e.path[s+1].x)+(e.path[s].y-e.path[s+1].y)*(e.path[s].y-e.path[s+1].y));i.push(o),e.sideSum=e.sideSum+o}for(s=0;s<t-1;s++)n.push(a/e.sideSum),a+=i[s];n.push(a/e.sideSum);let l=[];for(let i=0;i<t;i++)l.push(new THREE.Vector3(e.path[i].x,e.path[i].y,e.path[i].z),new THREE.Vector3(e.path[i].x,e.path[i].y,e.path[i].z+e.height));const d=[],h=[];for(let e=0;e<t-1;++e){var c=2*e;h.push(l[c],l[c+1],l[c+3]),h.push(l[c],l[c+2],l[c+3]),d.push(new THREE.Vector2(n[e],0),new THREE.Vector2(n[e],1),new THREE.Vector2(n[e+1],1)),d.push(new THREE.Vector2(n[e],0),new THREE.Vector2(n[e+1],0),new THREE.Vector2(n[e+1],1))}l=null;let u=new Float32Array(3*h.length),p=new Float32Array(2*d.length);e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(u,3).copyVector3sArray(h)),e.meshGeometry.setAttribute("uv",new THREE.BufferAttribute(p,2).copyVector2sArray(d));const m=Array.from(new Array(h.length).keys()).slice(0);e.meshGeometry.setIndex(m),e.meshGeometry.attributes.position.needsUpdate=!0,null==e.meshMaterial&&(e.meshMaterial=new r.WallMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms(),null===e.meshGeometry.boundingSphere&&e.meshGeometry.computeBoundingSphere(),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.mesh.renderOrder=r.EnumRenderOrder.Effect,e.scene.add(e.mesh))}destroy(){var e=this;e.clear(),e.color=null,e.wallTexture=null,e.path=null,e.resetPath=null,e.scene=null}clear(){var e=this;null!=e.mesh&&(e.scene.remove(e.mesh),e.mesh=null),null!=e.meshGeometry&&(e.meshGeometry.dispose(),e.meshGeometry=null),null!=e.meshMaterial&&(e.meshMaterial.map=null,e.meshMaterial.dispose(),e.meshMaterial=null)}getBoundingBox(){let e=(new THREE.Box3).setFromObject(this);const t=this.viewer.getScene().getInverseMatrixGlobal();return e.applyMatrix4(t)}update(){var e=this,t=(new Date).getTime();1==e.directionReverse?e.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,t,e.duration):e.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,t,e.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetPath&&(t.createUpdateMesh(),t.resetPath=null),t.refreshUniforms()}refreshUniforms(){var e=this;if(e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.blendingRatio.value=e.blendingRatio,e.meshMaterial.uniforms.directionType.value=e.directionType,e.meshMaterial.uniforms.directionReverse.value=e.directionReverse,e.meshMaterial.uniforms.repeat.value=e.repeat?1:0,e.meshMaterial.map=e.wallTexture,0==e.stretch){var t=e.imageWidth/e.imageHeight;0==e.directionType?e.unitLength=e.sideSum/e.height/t:e.unitLength=e.height/e.sideSum/t}else e.unitLength=1;e.meshMaterial.uniforms.unitLength.value=e.unitLength}hide(){this.meshMaterial.visible=!1}show(){this.meshMaterial.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.blendingRatio&&null!==e.blendingRatio&&(t.blendingRatio=e.blendingRatio),void 0!==e.directionType&&null!==e.directionType&&("Tangent"==e.directionType?t.directionType=0:t.directionType=1),void 0!==e.directionReverse&&null!==e.directionReverse&&(0==e.directionReverse?t.directionReverse=0:t.directionReverse=1),void 0!==e.height&&null!==e.height&&(t.height=e.height),void 0!==e.wallTexture&&null!==e.wallTexture&&(t.wallTexture=e.wallTexture),void 0!==e.path&&null!==e.path&&(t.path=e.path),void 0!==e.stretch&&null!==e.stretch&&(t.stretch=e.stretch),void 0!==e.repeat&&null!==e.repeat&&(t.repeat=e.repeat),void 0!==e.imageWidth&&null!==e.imageWidth&&(t.imageWidth=e.imageWidth),void 0!==e.imageHeight&&null!==e.imageHeight&&(t.imageHeight=e.imageHeight))}}r.Wall=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.disPickable=!0,t.autoAnimation=!0,t.viewer=e.viewer,t.modelManager=t.viewer.getModelManager(),null!=e.scene?t.scene=e.scene:t.scene=t,t.mesh=[],t.meshGeometry=[],t.angle=0,t.hiddenIds=[],t.externalObjectConverter=new r.ExternalObjectConverter(t.viewer),t.setOpts(e),t._updateGeometry(),t.createUpdateMesh(),t.show(),t.translateZ(.01)}_getRandomName(){return Math.floor(1e3*Math.random())+"_"+(new Date).getTime()}_cancelAllHidden(){for(var e=this,t=0;t<e.hiddenIds.length;t++)e.viewer.gisMode?e.viewer.getFilter().addToOverrideListByColor([e.hiddenIds[t].featureId],null,e.hiddenIds[t].modelId):e.viewer.getFilter().showByIds([e.hiddenIds[t].featureId],e.hiddenIds[t].modelId);e.hiddenIds=[]}_updateGeometry(){var e=this;if(e._cancelAllHidden(),e.meshLen=0,null!=e.boundaryGeometry)e._addGeometry(e.boundaryGeometry,new THREE.Matrix4);else{for(var t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds;if(null==i)return void console.log("objectIds不能为空.");var r=e.ids[t].modelId;for(let t=0;t<i.length;t++)e.hiddenIds.push({modelId:r,featureId:i[t]});if(e.viewer.gisMode)e.viewer.getFilter().addToOverrideListByColor(i,{color:0,opacity:0},r);else{e.viewer.getFilter().hideByIds(i,r);this.modelManager.getModel(r);for(let t=0;t<i.length;t++){var n=e.externalObjectConverter.convertToExternalObject(e._getRandomName(),i[t],!1);if(!(n.children.length<=0))for(var a=0,s=n.children.length;a<s;a++){let t=(new THREE.Matrix4).copy(n.children[a].matrix);e._addGeometry(n.children[a].geometry,t)}}}}e.viewer.gisMode&&(e.tempMaterial=new THREE.ShaderMaterial)}e.meshGeometry.length>e.meshLen&&e.segmentationClear(e.meshLen)}createUpdateMesh(){var e=this;null==e.meshMaterial&&(e.meshMaterial=new r.PlaneScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms());for(var t=!1,i=e.mesh.length;i<e.meshGeometry.length;i++){var n=new THREE.Mesh(e.meshGeometry[i],e.meshMaterial);n.renderOrder=r.EnumRenderOrder.Effect,e.scene.add(n),e.mesh.push(n),t=!0}t&&e.updateMatrixWorld()}_checkGeomtry(){var e=this;e.meshLen=e.meshGeometry.length;var t={};e.featureIdData={};for(var i=0;i<e.ids.length;i++)for(var r=e.ids[i].objectIds,n=e.ids[i].modelId,a=0;a<r.length;a++){var s={};s[r[a]]=!0,e.modelManager.traverseModels((function(i){i.id==n&&i.getPickingMeshes({skinningWireframeMaterial:e.tempMaterial,skinningSelectedMaterial:e.tempMaterial,selectedLineMaterial:e.tempMaterial,selectedMaterial:e.tempMaterial,wireframeMaterial:e.tempMaterial,instancedSelectedMaterial:e.tempMaterial,instancedWireFrameMaterial:e.tempMaterial},t,[r[a]],s,e.id+n)})),null!=t[n]&&e._getGeometry(t[n],n+"|"+r[a])}var o=!1;if(null!=e.featureIdDataBak){for(let t in e.featureIdDataBak)null==e.featureIdData[t]&&1==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!1);for(let t in e.featureIdData)if(null!=e.featureIdDataBak[t])if(e.featureIdData[t].drawcalls==e.featureIdDataBak[t].drawcalls)0==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!0),delete e.featureIdData[t];else{o=!0,e.featureIdDataBak[t]=e.featureIdData[t];for(a=e.mesh.length-1;a>=0;a--)e.mesh[a].geometry.mfKey==t&&(e.scene.remove(e.mesh[a]),e.mesh.splice(a,1),e.meshLen--)}else o=!0,e.featureIdDataBak[t]=e.featureIdData[t]}else e.featureIdDataBak=e.featureIdData,o=!0;if(0!=o){for(a=e.mesh.length-1;a>=0;a--)e.mesh[a].visible=e.featureIdDataBak[e.mesh[a].geometry.mfKey].visible;for(let i in e.featureIdData)for(let r=0;r<e.featureIdData[i].geometry.length;r++){var l=i.split("|")[0],d=t[l].matrix.clone();d=d.multiply(e.featureIdData[i].matrix[r]),e._addGeometry(e.featureIdData[i].geometry[r],d,i)}e.createUpdateMesh()}}_getGeometry(e,t){var i=this;if(null!=e.geometry){if(!e.isMesh)return;null==i.featureIdData[t]&&(i.featureIdData[t]={geometry:[],matrix:[],drawcalls:0,visible:!0}),i.featureIdData[t].geometry.push(e.geometry),i.featureIdData[t].matrix.push(e.matrix);for(var r=e.geometry.groups,n=0;n<r.length;n++)i.featureIdData[t].drawcalls+=e.geometry.groups[n].count}for(var a=e.children,s=0,o=a.length;s<o;s++)i._getGeometry(a[s],t)}_addGeometry(e,t,i){var r=this;let n=[],a=[],s=[];var o,l=e.getIndex().array,d=e.attributes.position.array;null!=e.attributes.uv?s=e.attributes.uv.array:(e.computeBoundingBox(),e.boundingBox.clone().applyMatrix4(t)),r.meshGeometry.length<=r.meshLen?(o=new THREE.BufferGeometry,r.meshGeometry.push(o)):o=r.meshGeometry[r.meshLen];for(var h={x:Number.MAX_VALUE,y:Number.MAX_VALUE},c={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},u=new THREE.Vector3,p=0;p<d.length;p+=3)u.set(d[p],d[p+1],d[p+2]),u.applyMatrix4(t),n.push(u.x),n.push(u.y),n.push(u.z),null==e.attributes.uv&&(s.push(u.x),s.push(u.y));var m=e.groups;if(null!=m&&0!=m.length)for(let t=0;t<m.length;t++)for(var f=m[t],g=f.start;g<f.start+f.count;g++)a.push(l[g]),null==e.attributes.uv&&(c.x=Math.max(c.x,n[3*l[g]]),c.y=Math.max(c.y,n[3*l[g]+1]),h.x=Math.min(h.x,n[3*l[g]]),h.y=Math.min(h.y,n[3*l[g]+1]));else if(a=l,null==e.attributes.uv)for(g=0;g<l.length;g++)c.x=Math.max(c.x,n[3*l[g]]),c.y=Math.max(c.y,n[3*l[g]+1]),h.x=Math.min(h.x,n[3*l[g]]),h.y=Math.min(h.y,n[3*l[g]+1]);if(null==e.attributes.uv)for(p=0;p<s.length;p++)if(p%2==0){var v=(s[p]-h.x)/(c.x-h.x);s[p]=v}else{var y=(s[p]-h.y)/(c.y-h.y);s[p]=y}o.setIndex(new THREE.Uint32BufferAttribute(a,1)),o.setAttribute("uv",new THREE.Float32BufferAttribute(s,2)),o.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),null!=i&&(o.mfKey=i),r.meshLen++}destroy(){this.clear(),this.externalObjectConverter.destroy()}clear(){var e=this;if(null!=e.mesh&&e.mesh.length>0){for(var t=0;t<e.mesh.length;t++)e.scene.remove(e.mesh[t]);e.mesh=[]}if(null!=e.meshGeometry&&e.meshGeometry.length>0){for(t=0;t<e.meshGeometry.length;t++)e.meshGeometry[t].dispose();e.meshGeometry=[]}null!=e.meshMaterial&&e.meshMaterial.dispose(),e._cancelAllHidden()}segmentationClear(e=0){var t=this;if(t.featureIdDataBak=null,null!=t.mesh&&t.mesh.length>0){for(var i=e;i<t.mesh.length;i++)t.scene.remove(t.mesh[i]);t.mesh.length=e}if(null!=t.meshGeometry&&t.meshGeometry.length>0){for(i=e;i<t.meshGeometry.length;i++)t.meshGeometry[i].dispose();t.meshGeometry.length=e}}update(){var e=this;e.ids.length>0&&e.viewer.gisMode&&e._checkGeomtry();var t=(new Date).getTime();e.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,t,e.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetPath&&(t._updateGeometry(),t.createUpdateMesh(),t.resetPath=null),t.refreshUniforms()}refreshUniforms(){var e=this;null!=e.meshMaterial&&(e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.blendingRatio.value=e.blendingRatio,e.meshMaterial.uniforms.angle.value=e.angle,e.meshMaterial.map=e.planeScanTexture)}hide(){null!=this.meshMaterial&&(this.meshMaterial.visible=!1)}show(){null!=this.meshMaterial&&(this.meshMaterial.visible=!0)}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.blendingRatio&&null!==e.blendingRatio&&(t.blendingRatio=e.blendingRatio),void 0!==e.direction&&null!==e.direction&&(t.direction=e.direction,0==t.direction.x&&0==t.direction.y?t.angle=0:0==t.direction.x&&0!=t.direction.y?t.angle=t.direction.y>0?Math.PI/2:3*Math.PI/2:0!=t.direction.x&&0==t.direction.y?t.angle=t.direction.x>0?0:Math.PI:(t.angle=Math.atan(t.direction.y/t.direction.x),t.direction.x<0&&(t.angle=t.angle+Math.PI))),void 0!==e.planeScanTexture&&null!==e.planeScanTexture&&(t.planeScanTexture=e.planeScanTexture,t.planeScanTexture.encoding=THREE.sRGBEncoding),void 0===e.ids||null===e.ids||e.boundaryGeometry?void 0!==e.boundaryGeometry&&null!==e.boundaryGeometry&&(t.boundaryGeometry=e.boundaryGeometry,t.ids=[]):(t.ids=e.ids,t.boundaryGeometry=null))}}r.PlaneScan=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t._running=!0,t._paused=!1,t._tickTimeFirst=void 0,t._tickTimeLast=void 0,t.disPickable=!0,t.autoAnimation=!0,null!=e.scene?t.scene=e.scene:t.scene=t,t.setOpts(e),t.createUpdateMesh(),t.show()}createUpdateMesh(){var e=this;null==e.meshGeometry&&(e.meshGeometry=new THREE.BufferGeometry);var t=2*Math.PI;let i=new Float32Array(195);i.set([0,0,0]);let n=new Uint32Array(192),a=3,s=0;for(var o=0;o<64;o++){var l=o/64*t,d=Math.cos(l),h=Math.sin(l);i[a++]=e.radius*d,i[a++]=e.radius*h,i[a++]=0,o<63?(n[s++]=0,n[s++]=o+1,n[s++]=o+2):(n[s++]=0,n[s++]=o+1,n[s++]=1)}e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(i,3)),e.meshGeometry.setIndex(new THREE.BufferAttribute(n,1)),null===e.meshGeometry.boundingSphere&&e.meshGeometry.computeBoundingSphere(),null==e.meshMaterial&&(e.meshMaterial=new r.FanScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms(),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.scene.add(e.mesh))}destroy(){this._clear()}_clear(){var e=this;null!=e.mesh&&(e.scene.remove(e.mesh),e.mesh=null),null!=e.meshGeometry&&(e.meshGeometry.dispose(),e.meshGeometry=null),null!=e.meshMaterial&&(e.meshMaterial.dispose(),e.meshMaterial=null)}update(){if(void 0===this._tickTimeFirst&&(this._tickTimeFirst=(new Date).getTime(),this._tickTimeLast=this._tickTimeFirst),!this._running)return void(this.meshMaterial.uniforms.time.value=1);if(this._paused)return void(this.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,this._tickTimeLast,this.duration));const e=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,e,this.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetMesh&&t.createUpdateMesh(),t.refreshUniforms(),t.resetMesh=null}refreshUniforms(){var e=this;e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.backgroundColor.value=e.backgroundColor,e.meshMaterial.uniforms.backgroundOpacity.value=e.backgroundAlpha,e.meshMaterial.uniforms.fanAngle.value=e.fanAngle/(2*Math.PI)}hide(){this.visible=!1}show(){this.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.backgroundColor&&null!==e.backgroundColor&&(t.backgroundColor=e.backgroundColor),void 0!==e.backgroundAlpha&&null!==e.backgroundAlpha&&(t.backgroundAlpha=e.backgroundAlpha),null!=e.fanAngle&&(t.fanAngle=e.fanAngle),null!=e.radius&&(t.radius=e.radius),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()))}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}r.FanScan=e}(),function(){class e extends THREE.Group{constructor(e){super(),this._running=!0,this._paused=!1,this._tickTimeFirst=void 0,this._tickTimeLast=void 0,this.disPickable=!1,this.autoAnimation=!0,this.radius=500,this.emitPosition=new THREE.Vector3(0,1,0),this.originPosition=new THREE.Vector3(0,0,0),this.progressive=10,this.duration=3e3,this.color=new THREE.Vector3(1,1,1),this.alpha=1,this.range=[],this.meshGeometry=null,this.setOpts(e),this.createUpdateMesh()}destroy(){this.clear(),this.radius=void 0,this.emitPosition=null,this.originPosition=null,this.progressive=void 0,this.duration=void 0,this.color=null,this.alpha=void 0,this.range=null,this.meshGeometry.dispose(),this.meshGeometry=null,this.meshMaterial.dispose(),this.meshMaterial=null}updateGeometry(){const e=[this.originPosition.x-this.radius,this.originPosition.y+this.radius,this.originPosition.z,this.originPosition.x+this.radius,this.originPosition.y+this.radius,this.originPosition.z,this.originPosition.x-this.radius,this.originPosition.y-this.radius,this.originPosition.z,this.originPosition.x+this.radius,this.originPosition.y-this.radius,this.originPosition.z];this.meshGeometry.setIndex([0,2,1,2,3,1]),this.meshGeometry.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.meshGeometry.setAttribute("normal",new THREE.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1],3)),this.meshGeometry.attributes.position.needsUpdate=!0,this.meshGeometry.computeBoundingBox(),this.meshGeometry.computeBoundingSphere()}createUpdateMesh(){null==this.meshGeometry&&(this.meshGeometry=new THREE.BufferGeometry,this.updateGeometry()),null===this.meshGeometry.boundingSphere&&this.meshGeometry.computeBoundingSphere(),null==this.meshMaterial&&(this.meshMaterial=new r.RingScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10}),this.refreshUniforms()),this.mesh=new THREE.Mesh(this.meshGeometry,this.meshMaterial),this.add(this.mesh)}update(){if(void 0===this._tickTimeFirst&&(this._tickTimeFirst=(new Date).getTime(),this._tickTimeLast=this._tickTimeFirst),!this._running)return void(this.meshMaterial.uniforms.time.value=1);if(this._paused)return void(this.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,this._tickTimeLast,this.duration));const e=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,e,this.duration)}effectOpt(e){this.setOpts(e),null!=this.resetPath&&(this.updateGeometry(),this.resetPath=null),this.refreshUniforms()}refreshUniforms(){null!=this.meshMaterial&&(this.meshMaterial.opacity=this.alpha,this.meshMaterial.uniforms.backGroundColor.value=this.color,this.meshMaterial.uniforms.radius.value=this.radius,this.meshMaterial.uniforms.progressive.value=this.progressive,this.meshMaterial.uniforms.scanCenter.value=this.originPosition)}hide(){null!=this.meshMaterial&&(this.visible=!1)}show(){null!=this.meshMaterial&&(this.visible=!0)}setOpts(e){e&&(null!=e.originPosition&&(this.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.progressive&&(this.progressive=e.progressive),null!=e.radius&&(this.radius=e.radius),null!=e.duration&&(this.duration=e.duration),void 0!==e.color&&null!==e.color&&(this.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(this.alpha=e.alpha))}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}r.RingScan=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.viewer=e.engineViewer,t.modelManager=t.viewer.getModelManager(),t.scene=t.viewer.getScene(),t.refleRefraManager=t.viewer.refleRefraManager,t.modelsColorInfo=[],t.externalObjectConverter=new r.ExternalObjectConverter(t.viewer),t.initNormalMap(e),t.initOption(e),t.saveOriginalModelsColor(),t.modelUserIdTileMapVisibility={},t.modelUserIdTileMapState={},t._updateGeometry(),t.addMesh(),t.translateZ(.01),t._enableAnimation=!0}saveOriginalModelsColor(){let e=this;for(let t=0;t<e.ids.length;t++){let i=e.ids[t].modelId;e.viewer.modelManager.getModel(i).getFilter().filterActionList.forEach((r=>{if(r.material&&r.ids){let n=r.material.color,a=r.material.opacity,s=new Glodon.Web.Graphics.Color(255*n.r,255*n.g,255*n.b,a),o=parseInt(s.getHEX(),16),l=s.getAlpha();if(0===o&&0===l)return;for(let n=0;n<e.ids[t].objectIds.length;n++){if(r.ids.includes(e.ids[t].objectIds[n])){let r=new Array;r.push(e.ids[t].objectIds[n]),e.modelsColorInfo.push({modelId:i,objectIds:r,modelColor:o,modelOpacity:l})}}}}))}}_cancelAllHidden(){for(var e=this,t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds,r=e.ids[t].modelId;e.viewer.getFilter().addToOverrideListByColor(i,null,r),e.viewer.getFilter().showByIds(i,r)}e.modelsColorInfo.forEach((t=>{let i=t.modelId,r=t.modelColor,n=t.modelOpacity,a=t.objectIds;e.viewer.getFilter().addToOverrideListByColor(a,{color:r,opacity:n},i),e.viewer.getFilter().showByIds(a,i)}))}getBoundingBox(){let e=(new THREE.Box3).setFromObject(this);const t=this.viewer.getScene().getInverseMatrixGlobal();return e.applyMatrix4(t)}_getRandomName(){return Math.floor(1e3*Math.random())+"_"+(new Date).getTime()}_updateGeometry(){var e=this;if(e._cancelAllHidden(),e.meshLen=0,e.featureCount=0,e.isLoadedMeshes=!1,e.isAddUpdate=!1,null!=e.boundaryGeometry)e._addGeometry(e.boundaryGeometry,new THREE.Matrix4);else{for(var t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds;if(null==i)return void console.log("objectIds不能为空.");var r=e.ids[t].modelId;for(let t=0;t<i.length;t++){var n=e.externalObjectConverter.convertToExternalObject(e._getRandomName(),i[t],!1);if(n.children.length<=0)continue;let o=r+"|"+i[t];for(var a=0,s=n.children.length;a<s;a++){let t=(new THREE.Matrix4).copy(n.children[a].matrix);e._addGeometry(n.children[a].geometry,t,o)}}e.viewer.getFilter().addToOverrideListByColor(i,{color:0,opacity:0},r),e.featureCount+=i.length}e.viewer.gisMode&&(e.tempMaterial=new THREE.ShaderMaterial)}e.meshGeometry.length>e.meshLen&&e.segmentationClear(e.meshLen)}createMesh(e){var t=this,i=t.initMaterial(e);t.meshMaterial.push(i);var n=new THREE.Mesh(e,i);return n.type="Water",n.renderOrder=r.GlobalData.IncrementRender?r.EnumRenderOrder.Effect:r.EnumRenderOrder.BeforeComponent,t.shadow&&t.refleRefraManager.addWaterManager({textureWidth:t.textureWidth,textureHeight:t.textureHeight,clipBias:t.clipBias,mesh:n}),n}addMesh(){for(var e=this,t=e.mesh.length;t<e.meshGeometry.length;t++){var i=e.createMesh(e.meshGeometry[t]);e.add(i),i.translateZ(e.meshGeometry[t].initialOffset),e.mesh.push(i),e.isAddUpdate=!0}e.isAddUpdate&&e.updateMatrixWorld()}_checkVisible(){var e=this;for(var t in e.featureIdDataBak){var i=t.split("|"),r=i[0],n=i[1];let a=!e.viewer.getFilter().isHidden(n,r);if(e.viewer.gisMode||!0===e.isGisMode){const t=e.modelManager.getModel(r);a=a&&t.isUserIdVisible(n)}a!=e.featureIdDataBak[t].visible&&(e.featureIdDataBak[t].visible=a,e.isAddUpdate=!0)}e.updateVisible()}updateVisible(){for(var e=this,t=e.mesh.length-1;t>=0;t--)void 0!==e.mesh[t]&&e.featureIdDataBak[e.mesh[t].geometry.mfKey]&&(e.mesh[t].visible=e.featureIdDataBak[e.mesh[t].geometry.mfKey].visible,e.mesh[t].material.visible=e.mesh[t].visible)}_checkGeomtry(){var e=this;e.meshLen=e.meshGeometry.length,e.featureIdData={};for(var t={},i=0;i<e.ids.length;i++)for(var r=e.ids[i].objectIds,n=e.ids[i].modelId,a=0;a<r.length;a++){var s={};s[r[a]]=!0,e.modelManager.traverseModels((function(i){i.id==n&&i.isVisible()&&i.getPickingMeshes({skinningWireframeMaterial:e.tempMaterial,skinningSelectedMaterial:e.tempMaterial,selectedLineMaterial:e.tempMaterial,selectedMaterial:e.tempMaterial,wireframeMaterial:e.tempMaterial,instancedSelectedMaterial:e.tempMaterial,instancedWireFrameMaterial:e.tempMaterial},t,[r[a]],s,e.id+n)})),null!=t[n]&&e._getGeometry(t[n],n+"|"+r[a])}var o=!1;if(null!=e.featureIdDataBak){for(let t in e.featureIdDataBak)null==e.featureIdData[t]&&1==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!1);for(let t in e.featureIdData)if(null!=e.featureIdDataBak[t])if(e.featureIdData[t].drawcalls==e.featureIdDataBak[t].drawcalls)0==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!0),delete e.featureIdData[t];else{o=!0,e.featureIdDataBak[t]=e.featureIdData[t];for(a=e.mesh.length-1;a>=0;a--)e.mesh[a].geometry.mfKey==t&&(e.shadow&&e.refleRefraManager.removeWaterManager(e.mesh[a].material.refleRefraId),e.remove(e.mesh[a]),e.mesh.splice(a,1),e.meshGeometry[a].dispose(),e.meshGeometry.splice(a,1),e.meshMaterial[a].dispose(),e.meshMaterial.splice(a,1),e.meshLen--)}else o=!0,e.featureIdDataBak[t]=e.featureIdData[t]}else e.featureIdDataBak=e.featureIdData,o=!0;0!=o&&(e.updateVisible(),e.isLoadedMeshes=e.featureCount==Object.keys(e.featureIdDataBak).length)}_getGeometry(e,t){var i=this;if(null!=e.geometry){if(!e.isMesh)return;null==i.featureIdData[t]&&(i.featureIdData[t]={geometry:[],matrix:[],drawcalls:0,visible:!0}),i.featureIdData[t].geometry.push(e.geometry),i.featureIdData[t].matrix.push(e.matrix);for(var r=e.geometry.groups,n=0;n<r.length;n++)i.featureIdData[t].drawcalls+=e.geometry.groups[n].count}for(var a=e.children,s=0,o=a.length;s<o;s++)i._getGeometry(a[s],t)}_addGeometry(e,t,i){var r=this,n=function(e){return e>=p.z-r.heightTolerance&&e<=p.z+r.heightTolerance};let a=[],s=[],o=[],l=[];var d=e.getIndex().array,h=e.attributes.position.array;e.computeBoundingBox();var c,u={x:Number.MAX_VALUE,y:Number.MAX_VALUE},p={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE,z:-Number.MAX_VALUE};r.meshGeometry.length<=r.meshLen?(c=new THREE.BufferGeometry,r.meshGeometry.push(c)):c=r.meshGeometry[r.meshLen];var m=[],f=[],g=e.groups;if(null!=g&&0!=g.length){var v={},y=0;for(let e=0;e<g.length;e++)for(var M=g[e],E=M.start;E<M.start+M.count;E++)null==v[d[E]]?(m.push(y),v[d[E]]=y,y++,f.push(h[3*d[E]]),f.push(h[3*d[E]+1]),f.push(h[3*d[E]+2])):m.push(v[d[E]])}else m=d,f=h;for(var x,_,b,I,T=new THREE.Vector3,S=0;S<f.length;S+=3)T.set(f[S],f[S+1],f[S+2]),T.applyMatrix4(t),a.push(T.x),a.push(T.y),a.push(T.z),l.push(0),l.push(0),l.push(1),o.push(T.x),o.push(T.y);for(S=0;S<m.length;S++)x=m[S],_=void 0,b=void 0,I=void 0,_=a[3*x],b=a[3*x+1],I=a[3*x+2],p.x=Math.max(p.x,_),p.y=Math.max(p.y,b),p.z=Math.max(p.z,I),u.x=Math.min(u.x,_),u.y=Math.min(u.y,b);for(S=0;S<m.length;S+=3){let e=m[S],t=m[S+1],i=m[S+2];(null==r.heightTolerance||n(a[3*e+2])&&n(a[3*t+2])&&n(a[3*i+2]))&&(s.push(e),s.push(t),s.push(i))}for(S=2;S<a.length;S+=3)a[S]=0;for(S=0;S<o.length;S++)if(S%2==0){var C=(o[S]-u.x)/(p.x-u.x);o[S]=C}else{var w=(o[S]-u.y)/(p.y-u.y);o[S]=w}c.setIndex(new THREE.Uint32BufferAttribute(s,1)),c.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),c.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),c.setAttribute("normal",new THREE.Float32BufferAttribute(l,3)),c.initialOffset=p.z,null!=i&&(c.mfKey=i),c.computeBoundingBox(),null==r.box&&(r.box=new THREE.Box3),r.box.expandByPoint(c.boundingBox.min),r.box.expandByPoint(c.boundingBox.max),r.meshLen++}destroy(){this.clear(),this.externalObjectConverter.destroy()}clear(){var e=this;if(null!=e.mesh&&e.mesh.length>0){for(var t=0;t<e.mesh.length;t++)e.shadow&&e.refleRefraManager.removeWaterManager(e.mesh[t].material.refleRefraId),e.remove(e.mesh[t]);e.mesh=[]}if(null!=e.meshGeometry&&e.meshGeometry.length>0){for(t=0;t<e.meshGeometry.length;t++)e.meshGeometry[t].dispose();e.meshGeometry=[]}if(null!=e.meshMaterial&&e.meshMaterial.length>0){for(t=0;t<e.meshMaterial.length;t++)e.meshMaterial[t].dispose();e.meshMaterial=[]}e._cancelAllHidden()}segmentationClear(e=0){var t=this;if(t.featureIdDataBak=null,null!=t.mesh&&t.mesh.length>0){for(var i=e;i<t.mesh.length;i++)t.shadow&&t.refleRefraManager.removeWaterManager(t.mesh[i].material.refleRefraId),t.remove(t.mesh[i]);t.mesh.length=e}if(null!=t.meshGeometry&&t.meshGeometry.length>0){for(i=e;i<t.meshGeometry.length;i++)t.meshGeometry[i].dispose();t.meshGeometry.length=e}}_updateBoundaryGeometry(e){let t=this,i=[],r=[];t.box=new THREE.Box3;const n=e.getIndex().array,a=e.attributes.position.array;for(let e=0;e<a.length;e+=3)r.push(0),r.push(0),r.push(1),i.push(a[e]),i.push(a[e+1]);e.computeBoundingBox();const s=e.boundingBox;for(var o=0;o<i.length;o++)if(o%2==0){var l=(i[o]-s.min.x)/(s.max.x-s.min.x);i[o]=l}else{var d=(i[o]-s.min.y)/(s.max.y-s.min.y);i[o]=d}let h=t.mesh[0].geometry;h.setIndex(new THREE.Uint32BufferAttribute(n,1)),h.setAttribute("uv",new THREE.Float32BufferAttribute(i,2)),h.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),h.setAttribute("normal",new THREE.Float32BufferAttribute(r,3)),h.attributes.uv.needsUpdate=!0,h.attributes.position.needsUpdate=!0,h.attributes.normal.needsUpdate=!0,h.computeBoundingBox(),h.computeBoundingSphere(),t.meshGeometry[0]=h,null==t.box&&(t.box=new THREE.Box3),t.box.expandByPoint(h.boundingBox.min),t.box.expandByPoint(h.boundingBox.max),this.boundaryGeometry=e}update(){var e=this;if(e.unrender=!1,e.isAddUpdate=!1,e.ids.length>0&&(null!=e.featureIdDataBak&&e.isLoadedMeshes?e._checkVisible():e._checkGeomtry()),e.flow){if(e._enableAnimation)for(var t=e.clock.getDelta(),i=0;i<e.mesh.length;i++)if(e.mesh[i].visible){e.meshMaterial[i].uniforms.sunDirection.value=e.scene.sunDirection,e.meshMaterial[i].uniforms.flowTime.value+=1/120;var r=e.meshMaterial[i].uniforms.config;r.value.x+=e.flowSpeed*t,r.value.y=r.value.x+e.halfCycle,r.value.x>=e.cycle?(r.value.x=0,r.value.y=e.halfCycle):r.value.y>=e.cycle&&(r.value.y=r.value.y-e.cycle)}}else e.isAddUpdate||(e.unrender=!0)}setColor(e,t){var i=this;i.color=e,i.alpha=t;for(var r=0;r<i.meshMaterial.length;r++)i.meshMaterial[r].isUndersea=i.alpha<1,i.meshMaterial[r].uniforms.waterColor.value=new THREE.Vector4(i.color.r,i.color.g,i.color.b,i.alpha)}setScale(e){var t=this;t.wavesScale=e;for(var i=0;i<t.meshMaterial.length;i++)t.meshMaterial[i].uniforms.config.value.w=t.wavesScale}setDirection(e,t){var i=this;i.flowDirection=new THREE.Vector2(e,t);for(var r=0;r<i.meshMaterial.length;r++)i.meshMaterial[r].uniforms.flowDirection.value=i.flowDirection}initOption(e){var t=this;t.color=e.color,t.alpha=e.alpha,void 0!==e.ids&&null!==e.ids&&e.ids.length>0?(t.ids=e.ids,t.boundaryGeometry=null,t.componentIds=[]):void 0!==e.boundaryGeometry&&null!==e.boundaryGeometry&&(t.boundaryGeometry=e.boundaryGeometry,t.ids=[],t.componentIds=[]),void 0!==e.heightTolerance&&null!==e.heightTolerance?t.heightTolerance=e.heightTolerance:t.heightTolerance=null,t.flowDirection=e.flowDirection||new THREE.Vector2(1,0),t.flowMap=e.flowMap||void 0,t.flowSpeed=e.flowSpeed||.03,t.reflectivity=e.reflectivity||.1,t.wavesScale=e.scale||1,e.shadow?t.shadow=!0:t.shadow=!1,e.flow?t.flow=!0:t.flow=!1,t.cycle=e.cycle||.4,t.halfCycle=.5*t.cycle,t.clock=new THREE.Clock,t.hiddenIds=[],t.meshMaterial=[],t.mesh=[],t.meshGeometry=[]}initNormalMap(e){var t=this,i=new THREE.TextureLoader;t.textureWidth=e.textureWidth||512,t.textureHeight=e.textureHeight||512,t.clipBias=e.clipBias||0;var r=e.map0,n=e.map1;t.normalMap0=e.normalMap0||i.load(r),t.normalMap1=e.normalMap1||i.load(n),t.normalMap0.wrapS=t.normalMap0.wrapT=THREE.RepeatWrapping,t.normalMap1.wrapS=t.normalMap1.wrapT=THREE.RepeatWrapping}initMaterial(e){var t=new r.WaterMaterial;return t.initUniforms(this),t}show(){this.visible=!0}hide(){this.visible=!1}enableAnimation(e){this._enableAnimation=e}}r.Water=e}(),r.RefleRefraManager=class{constructor(e){var t=this;t.viewer=e,t.scene=t.viewer.getScene(),t.refleRefraManager={}}getReflectorTexture(e){if(null!=this.refleRefraManager[e])return this.refleRefraManager[e].reflector.getRenderTarget().texture}getRefractorTexture(e){if(null!=this.refleRefraManager[e])return this.refleRefraManager[e].refractor.getRenderTarget().texture}_getRandomId(){return"RefleRefra-"+Math.floor(1e3*Math.random())+"-"+(new Date).getTime()}removeWaterManager(e){var t=this;null!=t.refleRefraManager[e]&&(t.refleRefraManager[e]=null,delete t.refleRefraManager[e])}addWaterManager(e){var t=this,i=t._getRandomId(),r=e.mesh,n=new THREE.Reflector(r.geometry,{textureWidth:e.textureWidth,textureHeight:e.textureHeight,clipBias:e.clipBias});n.matrixAutoUpdate=!1;var a=new THREE.Refractor(r.geometry,{textureWidth:e.textureWidth,textureHeight:e.textureHeight,clipBias:e.clipBias});a.matrixAutoUpdate=!1,t.refleRefraManager[i]={reflector:n,refractor:a,mesh:r},r.material.refleRefraId=i,r.material.uniforms.tReflectionMap.value=t.getReflectorTexture(i),r.material.uniforms.tRefractionMap.value=t.getRefractorTexture(i)}hideAllMesh(){for(var e in this.refleRefraManager)this.refleRefraManager[e].mesh.visible=!1}showAllMesh(){for(var e in this.refleRefraManager)this.refleRefraManager[e].mesh.visible=!0}render(e){var t=this;for(var i in t.refleRefraManager){var r=t.refleRefraManager[i],n=r.mesh;if(0!=r.mesh.visible){var a=n.material;a.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),a.textureMatrix.multiply(t.viewer.camera.projectionMatrix),a.textureMatrix.multiply(t.viewer.camera.matrixWorldInverse),a.textureMatrix.multiply(n.matrixWorld),t.hideAllMesh(),r.reflector.matrixWorld.copy(n.matrixWorld),r.reflector.onBeforeRender(e,t.scene,t.viewer.camera),a.isUndersea&&(r.refractor.matrixWorld.copy(n.matrixWorld),r.refractor.onBeforeRender(e,t.scene,t.viewer.camera)),t.showAllMesh()}}}dispose(){var e=this;e.viewer=null,e.scene=null,e.refleRefraManager=null}},function(){class e extends THREE.Mesh{constructor(t,i={}){super(t),this.isReflector=!0,this.type="Reflector",this.camera=new THREE.PerspectiveCamera;const r=this,n=void 0!==i.color?new THREE.Color(i.color):new THREE.Color(8355711),a=i.textureWidth||512,s=i.textureHeight||512,o=i.clipBias||0,l=i.shader||e.ReflectorShader,d=void 0!==i.multisample?i.multisample:4,h=new THREE.Plane,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4,f=new THREE.Vector3(0,0,-1),g=new THREE.Vector4,v=new THREE.Vector3,y=new THREE.Vector3,M=new THREE.Vector4,E=new THREE.Matrix4,x=this.camera,_=new THREE.WebGLRenderTarget(a,s,{samples:d}),b=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});b.uniforms.tDiffuse.value=_.texture,b.uniforms.color.value=n,b.uniforms.textureMatrix.value=E,this.material=b,this.onBeforeRender=function(e,t,i){if(u.setFromMatrixPosition(r.matrixWorld),p.setFromMatrixPosition(i.matrixWorld),m.extractRotation(r.matrixWorld),c.set(0,0,1),c.applyMatrix4(m),v.subVectors(u,p),v.dot(c)>0)return;v.reflect(c).negate(),v.add(u),m.extractRotation(i.matrixWorld),f.set(0,0,-1),f.applyMatrix4(m),f.add(p),y.subVectors(u,f),y.reflect(c).negate(),y.add(u),x.position.copy(v),x.up.set(0,1,0),x.up.applyMatrix4(m),x.up.reflect(c),x.lookAt(y),x.far=i.far,x.updateMatrixWorld(),x.projectionMatrix.copy(i.projectionMatrix),E.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),E.multiply(x.projectionMatrix),E.multiply(x.matrixWorldInverse),E.multiply(r.matrixWorld),h.setFromNormalAndCoplanarPoint(c,u),h.applyMatrix4(x.matrixWorldInverse),g.set(h.normal.x,h.normal.y,h.normal.z,h.constant);const n=x.projectionMatrix;M.x=(Math.sign(g.x)+n.elements[8])/n.elements[0],M.y=(Math.sign(g.y)+n.elements[9])/n.elements[5],M.z=-1,M.w=(1+n.elements[10])/n.elements[14],g.multiplyScalar(2/g.dot(M)),n.elements[2]=g.x,n.elements[6]=g.y,n.elements[10]=g.z+1-o,n.elements[14]=g.w,_.texture.encoding=e.outputEncoding,r.visible=!1;const a=e.getRenderTarget(),s=e.xr.enabled,l=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(_),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,x),e.xr.enabled=s,e.shadowMap.autoUpdate=l,e.setRenderTarget(a);const d=i.viewport;void 0!==d&&e.state.viewport(d),r.visible=!0},this.getRenderTarget=function(){return _},this.dispose=function(){_.dispose(),r.material.dispose()}}}e.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\t\tuniform mat4 textureMatrix;\n\t\tvarying vec4 vUv;\n\n\t\t#include <common>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t}",fragmentShader:"\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\t\tvarying vec4 vUv;\n\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n            return mix(\n                2.0 * base * blend,\n                1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ),\n                step(0.5, base)\n            );\n\t\t\t// return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t\t#include <encodings_fragment>\n\n\t\t}"},THREE.Reflector=e}(),function(){class e extends THREE.Mesh{constructor(t,i={}){super(t),this.isRefractor=!0,this.type="Refractor",this.camera=new THREE.PerspectiveCamera;const r=this,n=void 0!==i.color?new THREE.Color(i.color):new THREE.Color(8355711),a=i.textureWidth||512,s=i.textureHeight||512,o=i.clipBias||0,l=i.shader||e.RefractorShader,d=void 0!==i.multisample?i.multisample:4,h=this.camera;h.matrixAutoUpdate=!1,h.userData.refractor=!0;const c=new THREE.Plane,u=new THREE.Matrix4,p=new THREE.WebGLRenderTarget(a,s,{samples:d});this.material=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,transparent:!0}),this.material.uniforms.color.value=n,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=u;const m=function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Matrix4,n=new THREE.Vector3,a=new THREE.Vector3;return function(s){return e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(s.matrixWorld),n.subVectors(e,t),i.extractRotation(r.matrixWorld),a.set(0,0,1),a.applyMatrix4(i),n.dot(a)<0}}(),f=function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Quaternion,n=new THREE.Vector3;return function(){r.matrixWorld.decompose(t,i,n),e.set(0,0,1).applyQuaternion(i).normalize(),e.negate(),c.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){const e=new THREE.Plane,t=new THREE.Vector4,i=new THREE.Vector4;return function(r){h.matrixWorld.copy(r.matrixWorld),h.matrixWorldInverse.copy(h.matrixWorld).invert(),h.projectionMatrix.copy(r.projectionMatrix),h.far=r.far,e.copy(c),e.applyMatrix4(h.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);const n=h.projectionMatrix;i.x=(Math.sign(t.x)+n.elements[8])/n.elements[0],i.y=(Math.sign(t.y)+n.elements[9])/n.elements[5],i.z=-1,i.w=(1+n.elements[10])/n.elements[14],t.multiplyScalar(2/t.dot(i)),n.elements[2]=t.x,n.elements[6]=t.y,n.elements[10]=t.z+1-o,n.elements[14]=t.w}}();this.onBeforeRender=function(e,t,i){p.texture.encoding=e.outputEncoding,!0!==i.userData.refractor&&!0!=!m(i)&&(f(),function(e){u.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),u.multiply(e.projectionMatrix),u.multiply(e.matrixWorldInverse),u.multiply(r.matrixWorld)}(i),g(i),function(e,t,i){r.visible=!1;const n=e.getRenderTarget(),a=e.xr.enabled,s=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,h),e.xr.enabled=a,e.shadowMap.autoUpdate=s,e.setRenderTarget(n);const o=i.viewport;void 0!==o&&e.state.viewport(o),r.visible=!0}(e,t,i))},this.getRenderTarget=function(){return p},this.dispose=function(){p.dispose(),r.material.dispose()}}}e.RefractorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec4 vUv;\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n            return mix(\n                2.0 * base * blend,\n                1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ),\n                step(0.5, base)\n            );\n\t\t\t// return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t\t#include <encodings_fragment>\n\n\t\t}"},THREE.Refractor=e}(),function(){class e extends r.Water{constructor(e){super(e),this.isGisMode=!0,this.translateZ(.03)}_updateGeometry(){if(this._cancelAllHidden(),this.meshLen=0,this.featureCount=0,this.isLoadedMeshes=!1,this.isAddUpdate=!1,null==this.boundaryGeometry)for(let e=0;e<this.ids.length;e++){const t=this.ids[e].objectIds;if(null==t)return void console.log("objectIds不能为空.");const i=this.ids[e].modelId,r=this.modelManager.getModel(i),n=r.getUserIdTileMap(t);r.getUserIdTileMapVisibility(n),this.modelUserIdTileMapVisibility[r.id]||(this.modelUserIdTileMapVisibility[r.id]=n,this.modelUserIdTileMapState[r.id]={});for(const e in n){const t=n[e];let i=!0,a=!1;this.modelUserIdTileMapState[r.id][e]=0;for(const e in t)if(!0===t[e]&&(a=!0),null===t[e]){i=!1;break}!0===i&&!0===a&&(this.modelUserIdTileMapState[r.id][e]=1)}for(let e=0;e<t.length;e++){if(0===this.modelUserIdTileMapState[r.id][t[e]])continue;const n=this.externalObjectConverter.convertToExternalObject(this._getRandomName(),t[e],!1);if(n.children.length<=0)continue;let a=i+"|"+t[e];for(let e=0,t=n.children.length;e<t;e++){let t=(new THREE.Matrix4).copy(n.children[e].matrix);this._addGeometry(n.children[e].geometry,t,a)}}this.featureCount+=t.length,this.viewer.getFilter().addToOverrideListByColor(t,{color:0,opacity:0},i)}else this._addGeometry(this.boundaryGeometry,new THREE.Matrix4)}clear(){super.clear(),this.modelUserIdTileMapVisibility={},this.modelUserIdTileMapState={}}update(){for(let e=0;e<this.ids.length;e++){const t=this.ids[e].objectIds;if(null==t)return void console.log("objectIds不能为空.");const i=this.ids[e].modelId,r=this.modelManager.getModel(i),n=r.getUserIdTileMap(t);r.getUserIdTileMapVisibility(n);for(const e in n){const t=n[e];let r=!0,a=!1;for(const e in t)if(!0===t[e]&&(a=!0),null===t[e]){r=!1;break}if(!0===r&&!0===a&&0===this.modelUserIdTileMapState[i][e]){this.modelUserIdTileMapState[i][e]=1;const t=this.externalObjectConverter.convertToExternalObject(this._getRandomName(),e,!1);if(t.children.length<=0)continue;let r=i+"|"+e;const n=this.meshLen;for(let e=0,i=t.children.length;e<i;e++){let i=(new THREE.Matrix4).copy(t.children[e].matrix);this._addGeometry(t.children[e].geometry,i,r)}for(let e=n;e<this.meshLen;e++){const t=this.createMesh(this.meshGeometry[e]);this.add(t),t.translateZ(this.meshGeometry[e].initialOffset),this.mesh.push(t)}this.updateMatrixWorld()}}}super.update()}}r.BimtilesWater=e}(),r.PickingEffecter=class{constructor(e){this.viewer=e;var t=1170103;this.wireframeMaterial=new r.MeshBasicClipMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this._enableUpdateScene=!0,this.selectedMaterial=r.MaterialUtil.getDefaultSelectedMaterial(),this.skinningWireframeMaterial=new r.MeshBasicClipMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation,skinning:!0}),this.skinningSelectedMaterial=new r.MeshBasicClipMaterial({color:t,opacity:.3,transparent:!0,skinning:!0}),this.selectedLineMaterial=new THREE.LineMaterial({color:t,opacity:1,transparent:!0,linewidth:2,dashed:!1}),this.instancedWireFrameMaterial=new r.InstancedMeshBasicMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this.instancedSelectedMaterial=new r.InstancedMeshBasicMaterial({color:t,opacity:.3,transparent:!0}),this.selectionScene=new THREE.Scene,this.selectionScene.autoUpdate=!1,this.selectionObjectGroup=new r.ObjectGroup,this.selectionObjectGroup.name="PickingObjectGroup",this.selectionObjectGroup.matrixAutoUpdate=!1,this.selectionScene.add(this.selectionObjectGroup),this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null,this.selectedMaterialForClip=this.selectedMaterial.clone(),this.wireframeMaterialForClip=this.wireframeMaterial.clone(),this.instancedSelectedMaterialForClip=this.instancedSelectedMaterial.clone(),this.instancedWireFrameMaterialForClip=this.instancedWireFrameMaterial.clone(),this.selectedMaterialId=void 0}destroy(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.wireframeMaterialForClip.dispose(),this.wireframeMaterialForClip=null,this.selectedMaterial.dispose(),this.selectedMaterial=null,this.selectedMaterialForClip.dispose(),this.selectedMaterialForClip=null,this.skinningWireframeMaterial.dispose(),this.skinningWireframeMaterial=null,this.skinningSelectedMaterial.dispose(),this.skinningSelectedMaterial=null,this.selectedLineMaterial.dispose(),this.selectedLineMaterial=null,this.instancedWireFrameMaterial.dispose(),this.instancedWireFrameMaterial=null,this.instancedWireFrameMaterialForClip.dispose(),this.instancedWireFrameMaterialForClip=null,this.instancedSelectedMaterial.dispose(),this.instancedSelectedMaterial=null,this.instancedSelectedMaterialForClip.dispose(),this.instancedSelectedMaterialForClip=null,this.selectionObjectGroup.clear(),this.selectionObjectGroup=null,this.selectionScene=null,this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null,this.viewer=null}_hasSelectionInModel(e){for(const t in e)if(e[t].size>0)return!0;return!1}apply(e){var t=this.viewer;const i=t.modelManager.sceneState.selectionSet;if(!i||!1===this._hasSelectionInModel(i))return this._clearSelectedUserIdsCache(),void this._clearMeshesFromScene();(e||t.modelManager.sceneState.isSelectionsChanged())&&(this._cacheSelectedUserIds(i),this._updateScene(i),t.modelManager.sceneState.setSelectionsChanged(!1)),e&&!1===this._enableUpdateScene&&t.modelManager.traverseModels((e=>{e.getFilter()&&e.getFilter().isVisibleStateChanged()&&(e.applySelection(),this.viewer.modelManager.setRenderStateChanged(!0))})),this._render(t.rendererManager.getRenderer(),t.camera)}isSelectionsChanged(){const e=this.lastSelectedUserIdMap;if(!r.Utils.defined(e))return!0;const t=this.viewer.getSelectionWithModelId();if(t.length!==Object.keys(e).length)return!0;let i=!1;for(var n=t.length-1;n>=0;n--){const a=t[n],s=e[a.selectedId];if(!r.Utils.defined(s)){i=!0;break}if(s.modelId!==a.modelId){i=!0;break}}return!0===i||i}_cacheSelectedUserIds(e){}_clearSelectedUserIdsCache(){this.lastSelectedUserIdMap=null}_render(e,t){var i=e.autoClearColor,r=e.autoClearDepth,n=e.autoClearStencil;e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.render(this.selectionScene,t),e.autoClearColor=i,e.autoClearDepth=r,e.autoClearStencil=n}_updateScene(e){this._clearMeshesFromScene(),this._addMeshesToScene(this._getSelectedMeshes(e)),this._updateMatrixWorldForScene(),this._updateSelectedLineMaterial()}_clearMeshesFromScene(){this._enableUpdateScene?this.selectionObjectGroup.clear():this.selectionObjectGroup.children.map((e=>{e.pickTile||this.selectionObjectGroup.remove(e)}))}_addMeshesToScene(e){let t=Object.keys(e);for(const i of t)this.selectionObjectGroup.add(e[i])}_updateMatrixWorldForScene(){this.selectionObjectGroup.matrix.copy(this.viewer.getScene().getRawMatrixGlobal()),this.selectionObjectGroup.updateMatrixWorld(!0)}enableUpdateScene(e){this._enableUpdateScene=e}_getSelectedMeshes(e){var t={},i=this;return this.viewer.getModelManager().traverseLoadedModels((function(r){const n=e[r.databagId];n&&(r.pickingManager||r.getPickingMeshes(i,t,[...n.keys()],n))})),t}_updateSelectedLineMaterial(){r.GlobalData.PickingLineWidthEnabled&&this.selectedLineMaterial.resolution.set(this.viewer.domElement.offsetWidth,this.viewer.domElement.offsetHeight)}},r.PickingNodeGenerator=class{constructor(e){this.manager=e,this.pickingNodeMap=null,this.pickingNodeGroup=null,this.nodeGroupName="PickingNodeGroup"}destroy(){this.clearData(),this.pickingNodeGroup=null,this.manager=null}clearData(){this.clearAllFromPickingNodeGroup(),this.clearAllFromPickingNodeMap()}addToPickingNodeMap(e,t){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]=t,this.addToPickingNodeGroup(t)}removeFromPickingNodeMap(e){this.pickingNodeMap&&this.pickingNodeMap[e]&&(this.removeFormPickingNodeGroup(e),this.disposePickingNodeById(e),delete this.pickingNodeMap[e])}addToPickingNodeGroup(e){this.pickingNodeGroup||(this.pickingNodeGroup=new THREE.Group,this.pickingNodeGroup.name=this.nodeGroupName);for(var t=0,i=e.length;t<i;t++)this.pickingNodeGroup.add(e[t])}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)this.pickingNodeGroup.remove(t[i])}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i].material=null,t[i].geometry.dispose(),t[i]=null}clearAllFromPickingNodeMap(){if(this.pickingNodeMap){for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)this.disposePickingNodeById(t[i]);this.pickingNodeMap=null}}clearAllFromPickingNodeGroup(){this.pickingNodeGroup&&(this.pickingNodeGroup.children.length=0)}hideAllFromPickingNodeGroup(){this.pickingNodeGroup&&this.pickingNodeGroup.children.forEach((e=>{e.visible=!1}))}isPickingMeshesGenerated(){return!!this.pickingNodeMap}generatePickingMeshes(){}updatePickingMeshesState(e,t,i,r){}resetPickingMeshesState(){}updatePickingMeshes(e,t,i,r){return this.isPickingMeshesGenerated()||(this.generatePickingMeshes(),this.isPickingMeshesGenerated())?(this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i,r),this.getPickingNodeGroup()):null}getPickingNodeGroup(){return this.pickingNodeGroup}getMeshesForCap(e,t){}updatePickingMeshesStateForCap(e,t,i){}},function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingBatchedMeshGroup"}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i]._indicesGroup=null,t[i].material=null,t[i].geometry.dispose(),t[i]=null}generatePickingMeshes(){for(var e=this.manager,t=Object.keys(e.mapMaterialIdToMergedNode),i=0,n=t.length;i<n;i++){for(var a=t[i],s=e.getPropertyValueByMaterialKey(a),o=e.mapMaterialIdToMergedNode[a],l=[],d=0,h=o.length;d<h;d++){var c=o[d],u=c.geometry,p=c.indices,m=new THREE.BufferGeometry;m.setAttribute("position",u.getAttribute("position")),m.setIndex(u.getIndex()),u.getAttribute("growthPlaneIndex")&&m.setAttribute("growthPlaneIndex",u.getAttribute("growthPlaneIndex"));var f="lines"===s.type?THREE.LineSegments:THREE.Mesh,g=r.MaterialUtil.DefaultCloudMaterial;let e=c.mesh.material instanceof Array?c.mesh.material[0]:c.mesh.material;if(this.reserveMaterial){g=e,u.getAttribute("uv")&&m.setAttribute("uv",u.getAttribute("uv"))}g&&e&&g!==e&&e.growthAnimationPlanes&&((g=g.clone()).growthAnimationPlanes=e.growthAnimationPlanes,g.refreshUniforms());var v=new f(m,[g]);v.name=a,v.frustumCulled=!1,v.renderOrder=r.EnumRenderOrder.Component,v._indicesGroup=p,v.matrix.copy(c.mesh.matrix),v.matrixAutoUpdate=!1,v.updateMatrixWorld(!0),r.Utils.defined(c.mesh.selectedMeshes)||(c.mesh.selectedMeshes=[]),c.mesh.selectedMeshes.push(v),l.push(v)}this.addToPickingNodeMap(a,l)}}getMeshesForCap(e,t){for(var i=this.manager,n=Object.keys(i.mapMaterialIdToMergedNode),a=0,s=n.length;a<s;a++){for(var o=n[a],l=i.getPropertyValueByMaterialKey(o),d=i.mapMaterialIdToMergedNode[o],h=[],c=0,u=d.length;c<u;c++){var p=d[c],m=p.geometry,f=p.indices,g=new THREE.BufferGeometry;g.setAttribute("position",m.getAttribute("position")),g.setIndex(m.getIndex());var v="lines"===l.type?THREE.LineSegments:THREE.Mesh,y=p.mesh.material;if((y=y instanceof Array?y[0]:y).side==THREE.DoubleSide)continue;var M=new v(g,[y]);M.name=o,M.frustumCulled=!1,M.renderOrder=r.EnumRenderOrder.Component,M._indicesGroup=f,M.matrix.copy(p.mesh.matrix),M.matrixAutoUpdate=!1,M.updateMatrixWorld(!0);let i=[],n=[t[y.name]],a=[y.name];for(var E in f){let r=e[E][0].materialId,s=f[E];var x=a.indexOf(r);-1==x&&(a.push(r),n.push(t[r]),x=n.length-1);for(let e=0;e<s.length;e++)i.push({indexStart:s[e].indexStart,indexCount:s[e].indexCount,state:x}),s[e].capMaterialIndex=x}i.sort((function(e,t){return e.indexStart-t.indexStart}));for(let e=0,t=i.length;e<t;e++){var _=i[e].indexStart,b=i[e].indexCount,I=i[e].state;if(0===e)g.addGroup(_,b,I);else{var T=i[e-1].indexStart,S=i[e-1].indexCount;I===i[e-1].state&&_===T+S?g.groups[g.groups.length-1].count+=b:g.addGroup(_,b,I)}}M.material=n,h.push(M)}this.addToPickingNodeMap(o,h)}return this.getPickingNodeGroup()}updatePickingMeshesStateForCap(e,t,i){this.isPickingMeshesGenerated()||this.getMeshesForCap(t,i);for(var r,n,a,s,o=this.manager.manager,l=this.pickingNodeMap,d=Object.keys(l),h=e.getFilter(),c=0,u=d.length;c<u;c++)for(var p=l[d[c]],m=0,f=p.length;m<f;m++){let e=p[m];var g=e._indicesGroup;let t=Object.keys(g),i=g;var v=[];for(a=0,s=t.length;a<s;a++){var y=t[a];if(o.isPickableNode(y)&&i[y]){var M=g[y];if(M&&M.length>0){if(h.isHidden(y))continue;for(r=0,n=M.length;r<n;r++)v.push({indexStart:M[r].indexStart,indexCount:M[r].indexCount,state:M[r].capMaterialIndex})}}}e.visible=!0;var E=e.geometry;if(E.clearGroups(),0!==v.length)for(v.sort((function(e,t){return e.indexStart-t.indexStart})),r=0,n=v.length;r<n;r++){var x=v[r].indexStart,_=v[r].indexCount,b=v[r].state;if(0===r)E.addGroup(x,_,b);else{var I=v[r-1].indexStart,T=v[r-1].indexCount;b===v[r-1].state&&x===I+T?E.groups[E.groups.length-1].count+=_:E.addGroup(x,_,b)}}else e.visible=!1}return this.getPickingNodeGroup()}_rebuildGeometryGroup(e,t,i,n,a){var s,o,l,d,h,c,u=this.manager.manager,p=e._indicesGroup,m=Object.keys(p);m.length<t.length?(h=m,c=i):(h=t,c=p);var f=null,g=n.getFilter();g&&(f=g.getLocalClippingList());var v=[],y=[];let M={},E=r.EnumElementState.OVERRIDED,x=(e,t)=>e instanceof Map?e.has(t):e[t];for(l=0,d=h.length;l<d;l++){var _=h[l];if(!u.isPickableNode(_)||!x(c,_))continue;const e=g._getOverrideMaterialById(_);var b=p[_];if(b&&b.length>0){if(f&&f.get(_)){var I="localClipping|"+_;y.push(I);var T=y.length-1;for(s=0,o=b.length;s<o;s++)v.push({indexStart:b[s].indexStart,indexCount:b[s].indexCount,state:1+T});continue}for(s=0,o=b.length;s<o;s++){let t=0;e&&!a.selectedMaterial&&(void 0===M[e.name]?(t=E,E++,M[e.name]={material:e,state:t}):t=M[e.name].state),v.push({indexStart:b[s].indexStart,indexCount:b[s].indexCount,state:t})}}}e.visible=!0;var S=e.geometry;if(S.clearGroups(),0===v.length)return void(e.visible=!1);for(v.sort((function(e,t){return e.indexStart-t.indexStart})),s=0,o=v.length;s<o;s++){var C=v[s].indexStart,w=v[s].indexCount,R=v[s].state;if(0===s)S.addGroup(C,w,R);else{var B=v[s-1].indexStart,A=v[s-1].indexCount;R===v[s-1].state&&C===B+A?S.groups[S.groups.length-1].count+=w:S.addGroup(C,w,R)}}let P=a.selectedMaterial||e.material[0];P&&e.material[0]&&P!==e.material[0]&&e.material[0].growthAnimationPlanes&&(P=a.selectedMaterial.clone(),P.growthAnimationPlanes=e.material[0].growthAnimationPlanes,P.refreshUniforms&&P.refreshUniforms());var L=[P];for(s=0,o=y.length;s<o;s++){var O;"localClipping"==y[s].split("|")[0]&&(O=a.selectedMaterialForClip),L.push(O)}for(const e in M){const t=M[e];L[t.state]=t.material}e.material=L}updatePickingMeshesState(e,t,i,r){for(var n=this.pickingNodeMap,a=Object.keys(n),s=0,o=a.length;s<o;s++){let o=!0;this.manager.getPropertyValueByMaterialKey(a[s]).materialId!=e.selectedMaterialId&&null!=e.selectedMaterialId&&(o=!1);for(var l=n[a[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1,o&&this._rebuildGeometryGroup(l[d],t,i,r,e)}}}r.PickingBatchedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingBatchedWireFrameGroup"}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i]._indicesGroup=null,t[i].material=null,t[i].geometry.dispose(),t[i]=null}generatePickingMeshes(){var e=this.manager.getWireFrameLineSegments();if(e)for(var t=0,i=e.length;t<i;t++){var n=e[t].geometry,a=new THREE.BufferGeometry;a.setAttribute("position",n.getAttribute("position")),a.setIndex(n.getIndex()),n.getAttribute("growthPlaneIndex")&&a.setAttribute("growthPlaneIndex",n.getAttribute("growthPlaneIndex"));let i=r.MaterialUtil.DefaultCloudMaterial,o=e[t].material instanceof Array?e[t].material[0]:e[t].material;i&&o&&o.growthAnimationPlanes&&(i=i.clone(),i.growthAnimationPlanes=o.growthAnimationPlanes,i.refreshUniforms());var s=new THREE.LineSegments(a,i);s._indicesGroup=e[t]._indicesGroup,s.frustumCulled=!1,s.renderOrder=r.EnumRenderOrder.WireFrame,s.matrix.copy(e[t].matrix),s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0),r.Utils.defined(e[t].selectedMeshes)||(e[t].selectedMeshes=[]),e[t].selectedMeshes.push(s),this.addToPickingNodeMap(t,[s])}}_rebuildGeometryGroup(e,t,i,r,n){var a,s,o,l,d,h,c=this.manager.manager,u=e._indicesGroup,p=Object.keys(u);p.length<t.length?(d=p,h=i):(d=t,h=u);var m=null,f=r.getFilter();f&&(m=f.getLocalClippingList());var g=[],v=[];let y=(e,t)=>e instanceof Map?e.has(t):e[t];for(o=0,l=d.length;o<l;o++){var M=d[o];if(c.isPickableNode(M)&&y(h,M)){var E=u[M];if(E&&E.length>0){if(m&&m.get(M)){var x="localClipping|"+M;v.push(x);var _=v.length-1;for(a=0,s=E.length;a<s;a++)g.push({indexStart:E[a].indexStart,indexCount:E[a].indexCount,state:1+_});continue}for(a=0,s=E.length;a<s;a++)E[a].materialId!=n.selectedMaterialId&&null!=n.selectedMaterialId||g.push({indexStart:E[a].indexStart,indexCount:E[a].indexCount,state:0})}}}e.visible=!0;var b=e.geometry;if(b.clearGroups(),0===g.length)return void(e.visible=!1);for(g.sort((function(e,t){return e.indexStart-t.indexStart})),a=0,s=g.length;a<s;a++){var I=g[a].indexStart,T=g[a].indexCount,S=g[a].state;if(0===a)b.addGroup(I,T,S);else{var C=g[a-1].indexStart,w=g[a-1].indexCount;S===g[a-1].state&&I===C+w?b.groups[b.groups.length-1].count+=T:b.addGroup(I,T,S)}}var R=[n.wireframeMaterial];let B=e.material instanceof Array?e.material[0]:e.material;for(B&&R[0]&&B.growthAnimationPlanes&&((R=[n.wireframeMaterial.clone()])[0].growthAnimationPlanes=B.growthAnimationPlanes,R[0].refreshUniforms&&R[0].refreshUniforms()),a=0,s=v.length;a<s;a++){var A;"localClipping"==v[a].split("|")[0]&&(A=n.wireframeMaterialForClip),R.push(A)}e.material=R}updatePickingMeshesState(e,t,i,r){for(var n=this.pickingNodeMap,a=Object.keys(n),s=0,o=a.length;s<o;s++)for(var l=n[a[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1,this._rebuildGeometryGroup(l[d],t,i,r,e)}}r.PickingBatchedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingMeshGroup"}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=this.pickingNodeMap[e][t[i]],a=0,s=n.length;a<s;a++)n[a].material=null,n[a].geometry.dispose(),n[a]=null}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=0,a=this.pickingNodeMap[e][t[i]].length;n<a;n++)this.pickingNodeGroup.remove(nodes[n])}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}generatePickingMeshes(e){var t=this;this.manager.traverseActiveMeshMap(e,(function(e,i,n){if(!t._isExistNode(e,i)){for(var a=[],s=0,o=n.length;s<o;s++){var l=n[s],d=new THREE.BufferGeometry;d.setAttribute("position",l.geometry.getAttribute("position")),d.setIndex(l.geometry.getIndex()),d._withDrawRange&&d.setDrawRange(l.geometry.drawRange.start,l.geometry.drawRange.count);var h=new(l.isLineSegments?THREE.LineSegments:THREE.Mesh)(d,r.MaterialUtil.DefaultMaterial);r.GeomUtil.copyMeshProperties(h,l),h.renderOrder=r.EnumRenderOrder.WireFrame,a.push(h)}t.addToPickingNodeMap(e,i,a)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var r=e.selectedMaterial,n=this.pickingNodeMap,a=this.manager,s=0,o=t.length;s<o;s++){var l=t[s];if(n[l]&&a.isPickableNode(l)){var d=a.getActiveMeshMapById(l);if(d)for(var h=Object.keys(n[l]),c=0,u=h.length;c<u;c++){var p=h[c];if(d[p]){var m=n[l][p];if(m)for(var f=0,g=m.length;f<g;f++)m[f].material=r,m[f].visible=!0}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var n=t[i],a=Object.keys(e[n]),s=0,o=a.length;s<o;s++)for(var l=e[n][a[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingWireFrameGroup"}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=this.pickingNodeMap[e][t[i]],a=0,s=n.length;a<s;a++)n[a].material=null,n[a].geometry.dispose(),n[a]=null}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=0,a=this.pickingNodeMap[e][t[i]].length;n<a;n++)this.pickingNodeGroup.remove(nodes[n])}generatePickingMeshes(e){var t=this,i=this.manager;this.manager.manager.getMeshManager().traverseActiveMeshMap(e,(function(e,n,a){if(!(a&&a.length&&a[0].isLineSegments||t._isExistNode(e,n))){var s,o,l=a[0].geometryId,d=[];for(s=0,o=a.length;s<o;s++)d.push(a[s].geometry);var h=i._getWireframeGeometryById(l,d),c=[];for(s=0,o=h.length;s<o;s++){var u=new THREE.LineSegments(h[s],r.MaterialUtil.DefaultMaterial);r.GeomUtil.copyMeshProperties(u,a[s]),u.renderOrder=r.EnumRenderOrder.Component,c.push(u)}t.addToPickingNodeMap(e,n,c)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var r=e.selectedMaterial,n=this.pickingNodeMap,a=this.manager.manager.getMeshManager(),s=0,o=t.length;s<o;s++){var l=t[s];if(n[l]&&a.isPickableNode(l)){var d=a.getActiveMeshMapById(l);if(d)for(var h=Object.keys(n[l]),c=0,u=h.length;c<u;c++){var p=h[c];if(d[p]){var m=n[l][p];if(m)for(var f=0,g=m.length;f<g;f++)m[f].material=r,m[f].visible=!0}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var n=t[i],a=Object.keys(e[n]),s=0,o=a.length;s<o;s++)for(var l=e[n][a[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingInstancedMeshGroup"}generatePickingMeshes(){var e=this,t=this.manager,i=t.cachedInstance,n=!r.GlobalData.BatchMergeEnabled;t.traverseInstanceNodeMap(null,(function(t,a){for(var s=[],o=a[0],l=0,d=o.length;l<d;l++){var h=o[l].geometry,c=new THREE.InstancedBufferGeometry;c.setAttribute("position",h.getAttribute("position")),c.setAttribute("mcol0",h.getAttribute("mcol0")),c.setAttribute("mcol1",h.getAttribute("mcol1")),c.setAttribute("mcol2",h.getAttribute("mcol2")),c.setAttribute("mcol3",h.getAttribute("mcol3")),c.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),4,!1,1)),h.getAttribute("growthPlaneIndex")&&c.setAttribute("growthPlaneIndex",h.getAttribute("growthPlaneIndex")),c.setIndex(h.getIndex());var u=r.MaterialUtil.DefaultCloudMaterial;e.reserveMaterial&&(u=o[l].material,c.setAttribute("muvCol0",h.getAttribute("muvCol0")),c.setAttribute("muvCol1",h.getAttribute("muvCol1")),h.getAttribute("muvCol2")&&c.setAttribute("muvCol2",h.getAttribute("muvCol2"))),u&&o[l]&&o[l].material&&u!==o[l].material&&o[l].material.growthAnimationPlanes&&((u=u.clone()).growthAnimationPlanes=o[l].material.growthAnimationPlanes,u.refreshUniforms&&u.refreshUniforms());var p=new THREE.Mesh(c,u);p.name=t,p.frustumCulled=!1,p.matrix.copy(o[l].matrix),p.matrixAutoUpdate=!1,p.updateMatrixWorld(!0),p.renderOrder=n?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,r.Utils.defined(o[l].selectedMeshes)||(o[l].selectedMeshes=[]),o[l].selectedMeshes.push(p),s.push(p)}e.addToPickingNodeMap(t,s)}))}getMeshesForCap(e,t){var i=this,n=this.manager,a=n.cachedInstance,s=!r.GlobalData.BatchMergeEnabled;return n.traverseInstanceNodeMap(null,(function(e,n){for(var o=[],l=n[0],d=0,h=l.length;d<h;d++){var c=l[d].geometry,u=new THREE.InstancedBufferGeometry;u.setAttribute("position",c.getAttribute("position")),u.setAttribute("mcol0",c.getAttribute("mcol0")),u.setAttribute("mcol1",c.getAttribute("mcol1")),u.setAttribute("mcol2",c.getAttribute("mcol2")),u.setAttribute("mcol3",c.getAttribute("mcol3")),u.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(a.vState[e]),4,!1,1)),u.setAttribute("aColor",c.getAttribute("aColor")),u.setIndex(c.getIndex());var p=t[l[d].material.name],m=new THREE.Mesh(u,p);m.name=e,m.frustumCulled=!1,m.matrix.copy(l[d].matrix),m.matrixAutoUpdate=!1,m.updateMatrixWorld(!0),m.renderOrder=s?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,o.push(m)}i.addToPickingNodeMap(e,o)})),this.getPickingNodeGroup()}updatePickingMeshesStateForCap(e,t,i){this.isPickingMeshesGenerated()||this.getMeshesForCap(t,i);for(var n=this.pickingNodeMap,a=0,s=(m=Object.keys(n)).length;a<s;a++)for(var o=0,l=(f=n[m[a]]).length;o<l;o++)f[o].visible=!0,f[o].geometry.getAttribute("vState").array.fill(r.EnumElementState.NONE),f[o].geometry.getAttribute("vState").needsUpdate=!0;var d=this.manager.manager;let h=e.filter,c=e.getModelDescriptor().getInstancedUserIds();for(a=0,s=c.length;a<s;a++){var u=c[a];if(h.isHidden(u)){var p=d.getMeshManager().getNodeIdxMapByUserId(u);if(p){var m;for(o=0,l=(m=Object.keys(p)).length;o<l;o++){var f,g=m[o];if(f=n[g])for(var v=p[g],y=0,M=f.length;y<M;y++){var E=f[y];E.visible=!0;for(var x=E.geometry,_=x.getAttribute("vState").array,b=0,I=v.length;b<I;b++)_[4*v[b]]=r.EnumElementState.HIDDEN;x.getAttribute("vState").needsUpdate=!0}}}}}return this.getPickingNodeGroup()}updatePickingMeshesState(e,t,i,n){if(this.pickingNodeMap){var a=this.manager.manager,s=this.pickingNodeMap,o=n.getFilter(),l=null;o&&(l=o.getLocalClippingList());for(var d=0,h=t.length;d<h;d++){var c=t[d];if(!a.isPickableNode(c))continue;var u=a.getMeshManager().getNodeIdxMapByUserId(c);if(!u)continue;let i=(e,t)=>{const i=[];for(let r=0;r<t;++r){const t=null!=e.opacity?e.opacity:1;i.push(e.r,e.g,e.b,t)}return new THREE.InstancedBufferAttribute(new Float32Array(i),4,!1,1)};const n=o._getOverrideMaterialById(c);for(var p=Object.keys(u),m=0,f=p.length;m<f;m++){var g=p[m];if(g.split("&")[0]==e.selectedMaterialId||null==e.selectedMaterialId){var v=s[g];if(v)for(var y=u[g],M=0,E=v.length;M<E;M++){var x=v[M];if(l&&l.get(c))x.material=e.instancedSelectedMaterialForClip;else if(e.instancedSelectedMaterial){let t=e.instancedSelectedMaterial,i=x.material instanceof Array?x.material[0]:x.material;i&&t&&i.growthAnimationPlanes&&(t=t.clone(),t.growthAnimationPlanes=i.growthAnimationPlanes,t.refreshUniforms&&t.refreshUniforms()),x.material=t}x.visible=!0;var _=x.geometry,b=_.getAttribute("vState").array;if(n&&!e.instancedSelectedMaterial&&!_.getAttribute("aColor")){const e=i(x.material.color,b.length/4);_.setAttribute("aColor",e)}for(var I=0,T=y.length;I<T;I++)if(b[4*y[I]]=r.EnumElementState.NONE,n&&!e.instancedSelectedMaterial){const e=_.getAttribute("aColor").array;e[4*y[I]]=n.color.r,e[4*y[I]+1]=n.color.g,e[4*y[I]+2]=n.color.b,e[4*y[I]+3]=n.opacity,b[4*y[I]]=r.EnumElementState.OVERRIDED}_.getAttribute("vState").needsUpdate=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,n=t.length;i<n;i++)for(var a=e[t[i]],s=0,o=a.length;s<o;s++)a[s].visible=!1,a[s].geometry.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),a[s].geometry.getAttribute("vState").needsUpdate=!0}}r.PickingInstancedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingInstancedWireFrameGroup"}generatePickingMeshes(){var e=this,t=this.manager,i=t.manager.getCachedInstanceData(),n=!r.GlobalData.BatchMergeEnabled;t._traverseWireframeMeshNodeMap((function(t,a){for(var s=[],o=0,l=a.length;o<l;o++){var d=a[o],h=a[o].geometry,c=new THREE.InstancedBufferGeometry;c.setAttribute("position",h.getAttribute("position")),c.setAttribute("mcol0",h.getAttribute("mcol0")),c.setAttribute("mcol1",h.getAttribute("mcol1")),c.setAttribute("mcol2",h.getAttribute("mcol2")),c.setAttribute("mcol3",h.getAttribute("mcol3")),c.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),4,!1,1)),h.getAttribute("growthPlaneIndex")&&c.setAttribute("growthPlaneIndex",h.getAttribute("growthPlaneIndex")),c.setIndex(h.getIndex());let e=r.MaterialUtil.DefaultCloudMaterial,l=d.material instanceof Array?d.material[0]:d.material;e&&l&&l.growthAnimationPlanes&&(e=e.clone(),e.growthAnimationPlanes=l.growthAnimationPlanes,e.refreshUniforms&&e.refreshUniforms());var u=new THREE.LineSegments(c,e);u.name=t,u.frustumCulled=!1,h.getAttribute("mcol3").originMatrix&&(u.matrix.copy(h.getAttribute("mcol3").originMatrix),u.matrixAutoUpdate=!1,u.updateMatrixWorld(!0)),u.renderOrder=n?r.EnumRenderOrder.Component:r.EnumRenderOrder.WireFrame,r.Utils.defined(d.selectedMeshes)||(d.selectedMeshes=[]),d.selectedMeshes.push(u),s.push(u)}e.addToPickingNodeMap(t,s)}))}updatePickingMeshesState(e,t,i,n){if(this.pickingNodeMap){var a=this.manager.manager,s=this.pickingNodeMap,o=n.getFilter(),l=null;o&&(l=o.getLocalClippingList());for(var d=0,h=t.length;d<h;d++){var c=t[d];if(a.isPickableNode(c)){var u=a.getMeshManager().getNodeIdxMapByUserId(c);if(u)for(var p=Object.keys(u),m=0,f=p.length;m<f;m++){var g=p[m],v=s[g];if((g.split("&")[0]==e.selectedMaterialId||null==e.selectedMaterialId)&&v)for(var y=u[g],M=0,E=v.length;M<E;M++){var x=v[M];if(l&&l.get(c))x.material=e.instancedWireFrameMaterialForClip;else{let t=e.instancedWireFrameMaterial,i=x.material instanceof Array?x.material[0]:x.material;t&&i&&i.growthAnimationPlanes&&(t=t.clone(),t.growthAnimationPlanes=i.growthAnimationPlanes,t.refreshUniforms&&t.refreshUniforms()),x.material=t}x.visible=!0;for(var _=x.geometry,b=_.getAttribute("vState").array,I=0,T=y.length;I<T;I++)b[4*y[I]]=r.EnumElementState.NONE;_.getAttribute("vState").needsUpdate=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,n=t.length;i<n;i++)for(var a=e[t[i]],s=0,o=a.length;s<o;s++)a[s].visible=!1,a[s].geometry.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),a[s].geometry.getAttribute("vState").needsUpdate=!0}}r.PickingInstancedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingIncrementInstancedMeshGroup"}_isExistNode(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}generatePickingMeshes(){var e=this,t=this.manager,i=t.getCachedInstanceData(),n=!r.GlobalData.BatchMergeEnabled;t.traverseActiveMeshMap(null,(function(t,a){if(!e._isExistNode(t)){for(var s=[],o=0,l=a.length;o<l;o++){var d=a[o].geometry,h=new THREE.InstancedBufferGeometry;h.setAttribute("position",d.getAttribute("position")),h.setAttribute("mcol0",d.getAttribute("mcol0")),h.setAttribute("mcol1",d.getAttribute("mcol1")),h.setAttribute("mcol2",d.getAttribute("mcol2")),h.setAttribute("mcol3",d.getAttribute("mcol3")),h.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),4,!1,1)),h.setIndex(d.getIndex());var c=new THREE.Mesh(h,r.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,c.renderOrder=n?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,s.push(c)}e.addToPickingNodeMap(t,s)}}))}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var n=e.selectedMaterial,a=this.manager.manager,s=this.pickingNodeMap,o=0,l=t.length;o<l;o++){var d=t[o];if(a.isPickableNode(d)){var h=a.getMeshManager().getNodeIdxMapByUserId(d);if(h){var c=Object.keys(h);a.getMeshManager().traverseActiveMeshMap(c,(function(e,t){if(s[e])for(var i=h[e],a=s[e],o=0,l=a.length;o<l;o++){var d=a[o];d.material=n,d.visible=!0;for(var c=d.geometry,u=c.getAttribute("vState").array,p=0,m=i.length;p<m;p++)u[4*i[p]]=r.EnumElementState.NONE;c.getAttribute("vState").needsUpdate=!0}}))}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,n=t.length;i<n;i++)for(var a=e[t[i]],s=0,o=a.length;s<o;s++)a[s].visible=!1,a[s].geometry.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),a[s].geometry.getAttribute("vState").needsUpdate=!0}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingIncrementInstancedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingIncrementInstancedWireFrameGroup"}_isExistNode(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}generatePickingMeshes(){var e=this,t=this.manager.manager,i=t.getMeshManager(),n=t.getWireFrameManager(),a=i.getCachedInstanceData(),s=!r.GlobalData.BatchMergeEnabled;i.traverseActiveMeshMap(null,(function(t,i){if(!e._isExistNode(t)){var o=[];n._createGeometryById(t),n._traverseWireframeGeometryMapById(t,(function(e,t){var i=new THREE.InstancedBufferGeometry;i.setAttribute("position",e.getAttribute("position")),i.setAttribute("mcol0",e.getAttribute("mcol0")),i.setAttribute("mcol1",e.getAttribute("mcol1")),i.setAttribute("mcol2",e.getAttribute("mcol2")),i.setAttribute("mcol3",e.getAttribute("mcol3")),i.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(a.vState[t]),4,!1,1)),i.setIndex(e.getIndex());var n=new THREE.Mesh(i,r.MaterialUtil.DefaultMaterial);n.name=t,n.frustumCulled=!1,n.renderOrder=s?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,o.push(n)})),e.addToPickingNodeMap(t,o)}}))}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var n=e.selectedMaterial,a=this.manager.manager,s=this.pickingNodeMap,o=0,l=t.length;o<l;o++){var d=t[o];if(a.isPickableNode(d)){var h=a.getMeshManager().getNodeIdxMapByUserId(d);if(h){var c=Object.keys(h);a.getMeshManager().traverseActiveMeshMap(c,(function(e,t){if(s[e])for(var i=h[e],a=s[e],o=0,l=a.length;o<l;o++){var d=a[o];d.material=n,d.visible=!0;for(var c=d.geometry,u=c.getAttribute("vState").array,p=0,m=i.length;p<m;p++)u[4*i[p]]=r.EnumElementState.NONE;c.getAttribute("vState").needsUpdate=!0}}))}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,n=t.length;i<n;i++)for(var a=e[t[i]],s=0,o=a.length;s<o;s++)a[s].visible=!1,a[s].geometry.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),a[s].geometry.getAttribute("vState").needsUpdate=!0}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingIncrementInstancedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingExternalMeshGroup",this.pickingEffecter=this.manager.getModelManager().viewer.rendererManager.getPickingEffecter()}destroy(){this.pickingEffecter=null,super.destroy()}_disposeGeometryByNode(e){e.traverseVisible((function(t){t!==e&&(t.isMesh||t.isLine)&&(t.material=null,t.geometry.dispose())}))}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)this._disposeGeometryByNode(t[i]),t[i]=null}updatePickingMeshes(e,t,i){if(this.pickingNodeMap){for(var r=Object.keys(this.pickingNodeMap),n=0,a=r.length;n<a;n++){var s,o,l=r[n],d=this.pickingNodeMap[l];if(i.get(l)&&this.manager.isPickableNode({userId:l,name:l}))for(s=0,o=d.length;s<o;s++)d[s].visible=!0;else for(s=0,o=d.length;s<o;s++)d[s].visible=!1}return this.getPickingNodeGroup()}}addNode(e,t){this.addToPickingNodeMap(e,t)}removeNodeById(e){this.removeFromPickingNodeMap(e)}clearNodes(){this.clearData()}addToPickingNodeMap(e,t){for(var i=[],n=!r.GlobalData.BatchMergeEnabled,a=0,s=t.length;a<s;a++){var o=this._createPickingNodeBy(t[a],n);if(o)if(Array.isArray(o))for(var l=0,d=o.length;l<d;l++)o[l].name=e,i.push(o[l]),t[a]._oriMatrix&&(o[l]._oriMatrix=(new THREE.Matrix4).compose(o[l].position,o[l].quaternion,o[l].scale));else o.name=e,i.push(o),t[a]._oriMatrix&&(o._oriMatrix=(new THREE.Matrix4).compose(o.position,o.quaternion,o.scale))}this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]=i,this.addToPickingNodeGroup(i))}_createPickingNodeBy(e,t){var i=this,n={},a={};if("Object3D"===e.type||e instanceof THREE.Group||e instanceof r.ObjectGroup){var s,o,l,d=new THREE.Group;d.copy(e,!1),e.animations&&(d.animations=e.animations),e.traverseVisible((function(s){if(s!==e){var o=null;if("Object3D"===s.type||s instanceof THREE.Group||s instanceof r.ObjectGroup||s instanceof THREE.Bone)(o=s instanceof THREE.Bone?new THREE.Bone:new THREE.Group).copy(s,!1),n[s.uuid]={destination:o,source:s};else{if(!s.isMesh&&!s.isLine)return;(o=i._createPickingMeshesBy(s,t))&&(a[s.uuid]={destination:o,source:s})}o=null}}));var h=Object.keys(n);for(s=0,o=h.length;s<o;s++){var c=n[h[s]];c.source.parent!==e?(l=c.source.parent.uuid,n[l]&&n[l].destination.add(c.destination)):d.add(c.destination)}var u=Object.keys(a);for(s=0,o=u.length;s<o;s++){var p,m,f=a[u[s]];if(f.source.parent===e)if(Array.isArray(f.destination))for(p=0,m=f.destination.length;p<m;p++)d.add(f.destination[p]);else d.add(f.destination);else if(l=f.source.parent.uuid,Array.isArray(f.destination))for(p=0,m=f.destination.length;p<m;p++){(n[l]?n[l].destination:a[l].destination[p]).add(f.destination[p])}else{(n[l]?n[l].destination:a[l].destination).add(f.destination)}}return d}return e.isMesh||e.isLine?i._createPickingMeshesBy(e,t):null}_createLineMeshBy(e,t,i){var n,a,s=this.pickingEffecter;if(r.GlobalData.PickingLineWidthEnabled){n=this.reserveMaterial?e.material:s.selectedLineMaterial;var o=new THREE.LineSegmentsGeometry;e.isLineSegments?o.fromLineSegments(e):e.isLineLoop?o.fromLineLoop(e):o.fromLine(e),a=new THREE.LineSegments2(o,n),r.GeomUtil.copyMeshProperties(a,e),a.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component}else n=s.selectedMaterial,a=e.isLineSegments?new THREE.LineSegments(t,n):e.isLineLoop?new THREE.LineLoop(t,n):new THREE.Line(t,n),r.GeomUtil.copyMeshProperties(a,e),a.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component;return a}_createMeshBy(e,t,i){var n=this.reserveMaterial||e._originMaterial&&e._originMaterial instanceof r.MeshLineMaterial?e._originMaterial:this.pickingEffecter.selectedMaterial,a=new THREE.Mesh(t,n);return r.GeomUtil.copyMeshProperties(a,e),a.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,a._originMaterial||e._originMaterial||(a._originMaterial=e.material),a}_createSkinnedMeshBy(e,t,i){var n=this.reserveMaterial?e._originMaterial:this.pickingEffecter.skinningSelectedMaterial,a=new(e.isSkinnedMeshEx?THREE.SkinnedMeshEx:THREE.SkinnedMesh)(t,n);return r.GeomUtil.copyMeshProperties(a,e),a.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,a.bindMatrix.copy(e.bindMatrix),a.bindMatrixInverse.copy(e.bindMatrixInverse),a.bindMode=e.bindMode,a.userData=e.userData,a.skeleton=e.skeleton,a._originMaterial||e._originMaterial||(a._originMaterial=e.material),a}_createSkinnedWireFrameBy(e,t,i){if(!t.index)return null;var n=this.pickingEffecter.skinningWireframeMaterial,a=r.BuildEdge(t.attributes.position.array,t.index.array),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(a,1)),s.setAttribute("position",t.getAttribute("position")),s.setAttribute("skinIndex",t.getAttribute("skinIndex")),s.setAttribute("skinWeight",t.getAttribute("skinWeight"));var o=new(e.isSkinnedMeshEx?r.SkinnedLineEx:r.SkinnedLine)(s,n);return r.GeomUtil.copyMeshProperties(o,e),o.bindMatrix.copy(e.bindMatrix),o.bindMatrixInverse.copy(e.bindMatrixInverse),o.bindMode=e.bindMode,o.userData=e.userData,o.skeleton=e.skeleton,o.renderOrder=i?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}_createWireFrameBy(e,t,i){if(!t.index||t.getAttribute("previous"))return null;var n=this.pickingEffecter.wireframeMaterial,a=r.BuildEdge(t.attributes.position.array,t.index.array),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(a,1)),s.setAttribute("position",t.getAttribute("position"));var o=new THREE.LineSegments(s,n);return r.GeomUtil.copyMeshProperties(o,e),o.renderOrder=i?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}_createPickingMeshesBy(e,t){var i,n,a=r.GeomUtil.createBufferGeometryWithPosAndSkin(e.geometry,this.reserveMaterial);return a?e.isLineSegments?this._createLineMeshBy(e,a,t):(e.isSkinnedMesh?(i=this._createSkinnedMeshBy(e,a,t),n=this._createSkinnedWireFrameBy(e,a,t)):(i=this._createMeshBy(e,a,t),n=this._createWireFrameBy(e,a,t)),n?[i,n]:i):null}_hasObjectId(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}setAccumulateTransform(e,t,i,r){if(this._hasObjectId(e))for(var n=this.pickingNodeMap[e],a=0,s=n.length;a<s;a++)this.manager.setAccumulateTransformForMesh(n[a],t,i,r)}setTransform(e,t,i,r,n){if(this._hasObjectId(e))for(var a=this.pickingNodeMap[e],s=0,o=a.length;s<o;s++)this.manager.setTransformForMesh(a[s],t,i,r,n)}rotateOnBasePoint(e,t,i,r){if(this._hasObjectId(e))for(var n=this.pickingNodeMap[e],a=0,s=n.length;a<s;a++){let e=n[a],s=e.quaternion.clone().clone().invert(),o=e.position.clone(),l=(new THREE.Quaternion).setFromAxisAngle(i,r);e.quaternion.multiply(l);let d=t.clone().sub(o).applyQuaternion(s).applyQuaternion(e.quaternion);e.position.sub(d).add(t.clone().sub(o)),e.updateMatrixWorld()}}scaleOnBasePoint(e,t,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],n=0,a=r.length;n<a;n++){let e=r[n];e.scale.multiply(i);let a=i.clone().sub(new THREE.Vector3(1,1,1)),s=e.quaternion.clone(),o=s.clone().invert(),l=e.position.clone(),d=t.clone().sub(l).applyQuaternion(o).multiply(a).applyQuaternion(s);e.position.sub(d),e.updateMatrixWorld()}}applyTransform(e,t,i,r){if(this._hasObjectId(e)){var n=this.manager.getTransformMatrix(t,i,r);this.applyTransformMatrix(e,n)}}applyTransformMatrix(e,t,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],n=0,a=r.length;n<a;n++)this.manager.updateMatrixWorldForMesh(r[n],t,i)}}r.PickingExternalMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingSegmentMeshGroup",this.pickingEffecter=this.manager.viewer.rendererManager.getPickingEffecter()}destroy(){this.pickingEffecter=null,super.destroy()}_createPickingMeshBy(e,t){var i=this.pickingEffecter.selectedMaterial,n=e.geometry,a=new THREE.BufferGeometry;a.setAttribute("position",n.getAttribute("position")),a.setIndex(n.getIndex());var s=new(e.isLineSegments?THREE.LineSegments:THREE.Mesh)(a,i);return r.GeomUtil.copyMeshProperties(s,e),s.renderOrder=t?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,s}_createPickingWireFrameBy(e,t){if(e.isLineSegments)return null;var i=this.pickingEffecter.wireframeMaterial,n=e.geometry,a=r.BuildEdge(n.attributes.position.array,n.index.array),s=new THREE.BufferGeometry;s.setAttribute("position",n.getAttribute("position")),s.setIndex(new THREE.Uint32BufferAttribute(a,1));var o=new THREE.LineSegments(s,i);return r.GeomUtil.copyMeshProperties(o,e),o.renderOrder=t?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=this.pickingNodeMap[e][t[i]],a=0,s=n.length;a<s;a++)n[a].material=null,n[a].geometry.dispose(),n[a]=null}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var n=0,a=this.pickingNodeMap[e][t[i]].length;n<a;n++)this.pickingNodeGroup.remove(nodes[n])}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}generatePickingMeshes(e){var t=this,i=this.manager,n=!r.GlobalData.BatchMergeEnabled;i.traverseMeshNodeMapByUserIds(e,(function(e,i,r){var a=r.userId;if(!t._isExistNode(a,i)){for(var s=[],o=0,l=e.length;o<l;o++){var d=e[o],h=t._createPickingMeshBy(d,n);s.push(h);var c=t._createPickingWireFrameBy(d,n);c&&s.push(c)}t.addToPickingNodeMap(a,i,s)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap){e.selectedMaterial;for(var r=this.pickingNodeMap,n=this.manager,a=0,s=t.length;a<s;a++){var o=t[a];if(r[o]){var l=n.getNodeIdsByUserId(o);if(l&&l.length)for(var d=0,h=l.length;d<h;d++){var c=l[d],u=n.getNodeInfoByNodeId(c);if(n.isPickableNode(u)){var p=r[o][c];if(p)for(var m=0,f=p.length;m<f;m++)p[m].visible=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var n=t[i],a=Object.keys(e[n]),s=0,o=a.length;s<o;s++)for(var l=e[n][a[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingSegmentMeshGenerator=e}();var N,H=H||{};H.brdf_vs="\n\n\tvarying vec2 vUV;\n\n\tvoid main() {\n\t\tvUV = uv;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}\n",H.brdf_fs="\n\n\tvarying vec2 vUV;\n\tuniform sampler2D HammersleyTable;\n\n\tconst float PI = 3.14159265358979;\n\n\tfloat GGX(float NdotV, float alpha)\n\t{\n\t\tfloat alpha2 = pow(alpha, 2.0);\n\t\treturn 2.0 * NdotV / (NdotV + sqrt(alpha2 + (1.0 - alpha2) * NdotV * NdotV));\n\t}\n\n\tfloat G_Smith(float NdotV, float NdotL, float roughness)\n\t{\n\t\tfloat alpha = pow(roughness, 2.0);\n\t\treturn GGX(NdotV, alpha) * GGX(NdotL, alpha);\n\t}\n\t\n\tvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n\t{\n\t\tfloat a = roughness * roughness;\n\n\t\tfloat Phi = 2.0 * PI * Xi.x; \n\t\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); \n\t\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);\n\n\t\tvec3 H;\n\t\tH.x = SinTheta * cos(Phi); \n\t\tH.y = SinTheta * sin(Phi); \n\t\tH.z = CosTheta;\n\n\t\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); \n\t\tvec3 TangentX = normalize(cross(UpVector, N)); \n\t\tvec3 TangentY = cross(N, TangentX);\n\n\t\t// Tangent to world space \n\t\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);\n\t}\n\n\tvec2 IntegrateBRDF(float NdotV, float roughness)\n\t{\n\t\tvec3 N = vec3(0.0, 0.0, 1.0);\n\t\tvec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);\n\t\tvec2 result = vec2(0.0, 0.0);\n\n\t\tconst int NumSamples = 1024;\n\t\tfor (int i = 0; i < NumSamples; i++)\n\t\t{\n\t\t\tfloat u = float(i) / float(NumSamples);\n\t\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);\n\t\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);\n\t\t\tvec3 L = 2.0 * dot(V, H) * H - V;\n\n\t\t\tfloat NdotL = saturate(L.z);\n\t\t\tfloat NdotH = saturate(H.z);\n\t\t\tfloat VdotH = saturate(dot(V, H));\n\t\t\tfloat NdotV = saturate(dot(N, V));\n\t\t\tif (NdotL > 0.0)\n\t\t\t{\n\t\t\t\tfloat G = G_Smith(NdotV, NdotL, roughness);\n\t\t\t\tfloat G_Vis = G * VdotH / (NdotH * NdotV); \n\t\t\t\tfloat F = pow(1.0 - VdotH, 5.0);\n\t\t\t\tresult.x += (1.0 - F) * G_Vis;\n\t\t\t\tresult.y += F * G_Vis;\n\t\t\t}\n\t\t}\n\n\t\treturn result / float(NumSamples);\n\t}\n\n\tvoid main()\n\t{\n\t\tvec2 brdf = IntegrateBRDF(vUV.x, vUV.y);\n\t\tgl_FragColor = vec4(brdf, 0.0, 1.0);\n\t}\n\n",H.BRDFMap=function(e,t){this.texture=null,this.resolution=t||512,this.brdfMaterial=new THREE.ShaderMaterial({vertexShader:H.brdf_vs,fragmentShader:H.brdf_fs,uniforms:{HammersleyTable:{value:e}},lights:!1}),this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth,window.innerHeight),this.brdfMaterial),this.quad.position.z=-100},H.BRDFMap.prototype.constructor=H.BRDFMap,H.BRDFMap.prototype.generateMap=function(e){var t=new THREE.Scene;t.add(this.quad);var i=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4);i.position.z=100;var r=new THREE.WebGLRenderTarget(this.resolution,this.resolution,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});e.render(t,i,r,!0),this.texture=r.texture},function(){class e extends THREE.Loader{constructor(e){super(e),this.hdrLoader=new THREE.RGBELoader,this.type=THREE.HalfFloatType}load(e,t,i,r){Array.isArray(e)||(console.warn("THREE.HDRCubeTextureLoader signature has changed. Use .setDataType() instead."),this.setDataType(e),e=t,t=i,i=r,r=arguments[4]);const n=new THREE.CubeTexture;switch(n.type=this.type,n.type){case THREE.UnsignedByteType:n.encoding=THREE.RGBEEncoding,n.format=THREE.RGBAFormat,n.minFilter=THREE.NearestFilter,n.magFilter=THREE.NearestFilter,n.generateMipmaps=!1;break;case THREE.FloatType:case THREE.HalfFloatType:n.encoding=THREE.LinearEncoding,n.format=THREE.RGBAFormat,n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.generateMipmaps=!1}const a=this;let s=0;function o(t,i,r,o){new THREE.FileLoader(a.manager).setPath(a.path).setResponseType("arraybuffer").setWithCredentials(a.withCredentials).load(e[t],(function(e){s++;const r=a.hdrLoader.parse(e);if(r){if(void 0!==r.data){const e=new THREE.DataTexture(r.data,r.width,r.height);e.type=n.type,e.encoding=n.encoding,e.format=n.format,e.minFilter=n.minFilter,e.magFilter=n.magFilter,e.generateMipmaps=n.generateMipmaps,n.images[t]=e}6===s&&(n.needsUpdate=!0,i&&i(n))}}),r,o)}for(let n=0;n<e.length;n++)o(n,t,i,r);return n}setDataType(e){return this.type=e,this.hdrLoader.setDataType(e),this}}THREE.HDRCubeTextureLoader=e}(),H.HDRTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},H.HDRTextureLoader.prototype.load=function(e,t,i,r){var n=new THREE.DataTexture;return this.hdrLoader.load(e,(function(e,i){e.flipY=!0,e.type=THREE.FloatType,e.format=THREE.RGBAFormat,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.encoding=THREE.LinearEncoding;for(var r=function(e,t,i,r){var n=e[t+3],a=Math.pow(2,n-128)/256;i[r+0]=e[t+0]*a,i[r+1]=e[t+1]*a,i[r+2]=e[t+2]*a,i[r+3]=1},a=e.image.width*e.image.height*4,s=new Float32Array(a),o=0;o<a;o++)r(e.image.data,4*o,s,4*o);e.image.data=s,n=e,t&&t(n)}),i,r),n},H.equirectangular_vs="\n\n\tvarying vec3 pos;\n\n\tvoid main() {\n\t\tpos = vec3(modelMatrix * vec4(position, 1.0));\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}\n    \n",H.equirectangular_fs="\n\n\tvarying vec3 pos;\n\tuniform sampler2D map;\n\n\tconst float PI = 3.14159265358979;\n\tconst float INV_PI = 1.0 / PI;\n\n\tvec2 sampleSphericalMap(vec3 v)\n\t{\n\t\tvec2 uv = vec2(atan(v.z, v.x), asin(v.y));\n\t\tuv *= vec2(INV_PI * 0.5, INV_PI);\n\t\tuv += 0.5;\n\t\treturn uv;\n\t}\n\n\tvoid main() {\n\t\tvec2 uv = sampleSphericalMap(normalize(pos));\n\t\tvec4 color = texture2D(map, uv);\n\t\tgl_FragColor = vec4(color.rgb, 1.0);\n\t}\n",H.EquirectangularMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="EquirectangularMaterial",this.map=null,this.lights=!1,this.side=THREE.BackSide,this.defines={},this.uniforms=THREE.UniformsUtils.merge([{map:{value:null}}]),this.vertexShader=H.equirectangular_vs,this.fragmentShader=H.equirectangular_fs,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},H.EquirectangularMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),H.EquirectangularMaterial.prototype.constructor=H.EquirectangularMaterial,H.EquirectangularMaterial.prototype.isShaderMaterial=!0,H.EquirectangularMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.map=e.map,this},H.EquirectangularMaterial.prototype.refreshUniforms=function(){this.uniforms.map.value=this.map},H.HDRToCubeMap=function(e,t,i,r){var n=new THREE.CubeCamera(.1,10,r||512);if(i){var a={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};n.renderTarget=new THREE.WebGLRenderTargetCube(r||512,r||512,a)}var s=new THREE.Scene,o=new EquirectangularMaterial({map:e}),l=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),o);return s.add(l),n.updateCubeMap(t,s),n.renderTarget.texture},H.IBLMaps=function(e,t,i){this.environmentMap=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,e&&this.loadMaps(e,t,void 0,i)},H.IBLMaps.prototype.constructor=H.IBLMaps,H.IBLMaps.prototype.loadMaps=function(e,t,i,r){t?this.loadHDRMaps(e,i,r):this.loadJPGMaps(e,i,r)},H.IBLMaps.prototype.loadHDRMaps=function(e,t,i){for(var r=this,n=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],a=[],s=0;s<6;++s)a.push(e+"/EnvMap_"+n[s]);var o=new THREE.HDRCubeTextureLoader;o.setDataType(THREE.FloatType),o.load(a,(function(t){r.environmentMap=t;for(var a=[],s=0;s<6;++s)a.push(e+"/IrradianceMap_"+n[s]);o.load(a,(function(t){r.irradianceMap=t;for(var a=[],s=0;s<6;++s)a.push(e+"/PrefilterMap_"+n[s]);o.load(a,(function(t){r.prefilterMap=t;var n=new H.HDRTextureLoader,a=e+"/brdf.hdr";n.load(a,(function(e){r.brdfMap=e,i(r,!0)}))}))}))}))},H.IBLMaps.prototype.loadJPGMaps=function(e,t,i){const r=new THREE.CubeTextureLoader;r.setCrossOrigin("anonymous"),r.load(e,(e=>{this.environmentMap=e,i(this,!1)}))},function(){class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="IBLMaterial",r.Utils.isMacOS()&&(this.defines.USE_COLOR_CLAMP=""),this.IBLEnabled=!0,this.debug=0,this.iblFactor=1,this.gamma=2.2,this.color=new THREE.Color(16777215),this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this._referenceCount=1,this._imageByteSize=0,this.opacity=1,this.aoMap=null,this.IBLMaps=null,this.shift=.5,this.A=.27,this.B=.29,this.C=.052,this.D=.2,this.E=0,this.F=.18,this.scale=.897105;var t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.tintColor=new THREE.Color(16777215),this.receiveIBL=!0,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.emissive=new THREE.Color(0,0,0),this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useCSM=r.GlobalData.EnableCSM,this.useAlphaMap=!1,this.useEnvLight=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.growthAnimationPlanes=null,this.useClampToBorder=!1,this.uLineTexture=r.LineTextureManager.uLineTexture,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms,{IBLEnabled:{value:!0},debug:{value:0},iblFactor:{value:1},gamma:{value:2.2},albedo:{value:new THREE.Color(16777215)},aoMap:{value:null},irradianceMap:{value:null},prefilterMap:{value:null},brdfMap:{value:null},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},tintColor:{value:new THREE.Color(16777215)}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null},isFineShadow:{value:!0}},{quantizationNormalMatrix:{value:new THREE.Matrix3}},{growthAnimationPlanes:{value:null}},{useEnvLight:{value:this.useEnvLight}}]),this.uniforms.uLineTexture={value:this.uLineTexture},this.lights=!0,this.vertexShader=H.IBLVertexShader,this.fragmentShader=H.IBLFragmentShader,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,!0===r.GlobalData.ForcedUseWebgl1&&(this.extensions={derivatives:!0})}setValues(e){if(void 0!==e)for(var t in e){var i=e[t];if(void 0!==i){var r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}}copy(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.IBLEnabled=e.IBLEnabled,this.debug=e.debug,this.gamma=e.gamma,this.color.copy(e.color),this.aoMap=e.aoMap,this.IBLMaps=e.IBLMaps,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.tintColor.copy(e.tintColor),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.iblFactor=e.iblFactor,this.useCSM=e.useCSM,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useHeightLimit=e.useHeightLimit,this.growthAnimationPlanes=e.growthAnimationPlanes,this.useEnvLight=e.useEnvLight,this.uLineTexture=e.uLineTexture,this}refreshUniforms(){this.uniforms.IBLEnabled.value=this.IBLEnabled,this.uniforms.debug.value=this.debug,this.uniforms.gamma.value=this.gamma,this.uniforms.iblFactor.value=this.iblFactor,this.uniforms.albedo.value.set(this.color),this.uniforms.aoMap.value=this.aoMap,this.IBLMaps&&(this.uniforms.irradianceMap.value=this.IBLMaps.irradianceMap,this.uniforms.prefilterMap.value=this.IBLMaps.prefilterMap,this.uniforms.brdfMap.value=this.IBLMaps.brdfMap),this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.uniforms.growthAnimationPlanes.value=this.growthAnimationPlanes,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_NUM=this.videoCastCount:delete this.defines.VIDEO_CAST_NUM,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.uniforms.useEnvLight.value=this.useEnvLight,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV,this.uniforms.uLineTexture={value:this.uLineTexture}}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=r.EnumShaderColorState.BLINK}updateBlinkUniformValue(e,t,i){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}resetBlinkUniformValue(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}}H.IBLMaterial=e}(),function(){class e extends H.IBLMaterial{constructor(e){super(e),this.vertexShader=H.IBLVertexShaderV3,this.fragmentShader=H.IBLFragmentShaderV3,this.packingMatMap=null,null!=e&&null!=e&&void 0!==e.packingMatTexture&&(this.packingMatMap=e.packingMatTexture),this.useBCOutline=!1,this.borderLineVisible=!0,this.packingMaterialEnable=r.GlobalData.IsPackingMaterialEnable,this.uniforms.packingMatMap={value:null},this.outLineColor=new THREE.Color(.3,.3,.3),e&&e.hasOwnProperty("useBCOutline")&&(this.useBCOutline=e.useBCOutline),e&&e.hasOwnProperty("borderLineVisible")&&(this.borderLineVisible=e.borderLineVisible),e&&e.hasOwnProperty("packingMaterialEnable")&&(this.packingMaterialEnable=e.packingMaterialEnable),e&&e.hasOwnProperty("outLineColor")&&(this.outLineColor=e.outLineColor),this.uniforms.outLineColor={value:this.outLineColor}}setBorderLineVisible(e){this.borderLineVisible=e,this.useBCOutline&&this.borderLineVisible?this.defines.USE_BC_OUTLINE="":delete this.defines.USE_BC_OUTLINE}setOutLineColor(e){e?(this.outLineColor=e,this.uniforms.outLineColor={value:this.outLineColor}):(this.outLineColor=new THREE.Color(.3,.3,.3),this.uniforms.outLineColor={value:this.outLineColor})}setPackingMaterialEnable(e){this.packingMaterialEnable=e,null!=this.packingMatMap&&e?this.defines.USE_PACKINGMAT="":delete this.defines.USE_PACKINGMAT}copy(e){return this.useBCOutline=e.useBCOutline,this.borderLineVisible=e.borderLineVisible,this.packingMatMap=e.packingMatMap,this.packingMaterialEnable=e.packingMaterialEnable,this.outLineColor=e.outLineColor,super.copy(e),this}refreshUniforms(){super.refreshUniforms(),this.useBCOutline&&this.borderLineVisible?this.defines.USE_BC_OUTLINE="":delete this.defines.USE_BC_OUTLINE,null!=this.packingMatMap&&(this.uniforms.packingMatMap.value=this.packingMatMap,this.packingMaterialEnable?this.defines.USE_PACKINGMAT="":delete this.defines.USE_PACKINGMAT),this.uniforms.outLineColor={value:this.outLineColor}}}H.IBLMaterialV3=e}(),function(){class e extends H.IBLMaterialV3{constructor(e){super(e),this.vertexShader=H.IBLBatchedVertexShaderV3,this.fragmentShader=H.IBLBatchedFragmentShaderV3}}H.IBLBatchedMaterialV3=e}(),function(){class e extends H.IBLMaterialV3{constructor(e){super(e),this.vertexShader=H.IBLInstanceVertexShaderV3,this.fragmentShader=H.IBLInstanceFragmentShaderV3}}H.IBLInstanceMaterialV3=e}(),H.IBLProbe=function(e,t,i,r,n,a,s){this.environmentMap=e,this.hammersleyTable=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,this.hammersleyUrl=t,this.irradianceResolution=r||32,this.prefilterResolution=n||128,this.brdfResolution=a||512,this.maxMipLevel=s||1,this.isHDR=!1,this.isComputed=!1,this.onSuccess=i,this.loadHammersleyTable()},H.IBLProbe.prototype.constructor=H.IBLProbe,H.IBLProbe.prototype.loadHammersleyTable=function(){var e=this;(new THREE.TextureLoader).load(this.hammersleyUrl,(function(t){e.hammersleyTable=t,e.initMap(),e.onSuccess&&e.onSuccess()}))},H.IBLProbe.prototype.initMap=function(){this.irradianceMap=new H.IrradianceMap(this.environmentMap,this.irradianceResolution),this.prefilterMap=new H.PrefilterMap(this.environmentMap,this.hammersleyTable,this.prefilterResolution,this.maxMipLevel),this.brdfMap=new H.BRDFMap(this.hammersleyTable,this.brdfResolution)},H.IBLProbe.prototype.setEnvironmentMap=function(e){this.environmentMap=e,this.irradianceMap.irradianceMaterial.uniforms.environmentMap.value=this.environmentMap,this.prefilterMap.prefilterMaterial.uniforms.environmentMap.value=this.environmentMap},H.IBLProbe.prototype.computed=function(e){this.irradianceMap.generateMap(e,this.isHDR),this.prefilterMap.generateMap(e,this.isHDR),this.brdfMap.generateMap(e),this.isComputed=!0},H.IBLVertexShader="\n    uniform mat3 uvTransform; \n    varying vec2 vUv;\n    varying vec3 Normal;\n    varying vec3 Pos;\n    varying vec3 mvPosition;\n    varying vec3 mvNormal;\n    varying vec3 vViewPosition;\n    #include <shadowmap_pars_vertex>\n    #include <view_shed_pars_vertex>\n    #include <video_cast_pars_vertex>\n    #include <common>\n    #include <logdepthbuf_pars_vertex>//log depth buffer\n    #include <heightLimit_pars_vertex>\n    #include <uv2_pars_vertex>\n    #include <CompressNormal_pars_vertex>\n    #include <CompressColor_pars_vertex>\n    #include <color_pars_vertex>\n    #include <USE_INSTANCE_pars_Vertex>\n    #include <matrix_transform_pars_vertex>\n    #include <packing_material_pars_vertex>\n    #include <growthAnimation_pars_vertex>\n    #include <outline_pars_vertex>\n    #include <compress_uv_pars_vertex>\n    #include <inverse_matrix_pars_vertex_quantization>\n\n    void main()\n    {\n        vec3 vertexNormal = normal;\n\n        #ifdef CNORMAL\n            vertexNormal = octDecode();\n        #endif\n\n        vUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n        #include <compress_uv_vertex>\n        #include <outine_vertex>\n\n        #include <begin_vertex>\n\n        Pos = vec3(modelMatrix * vec4(transformed, 1.0));\n        Normal = normalize(mat3(modelMatrix) * vertexNormal);\n        mvPosition = vec3(modelViewMatrix * vec4(transformed, 1.0));\n        mvNormal = normalize(normalMatrix * vertexNormal);\n        // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n        #include <beginnormal_vertex>\n        // #include <defaultnormal_vertex>\n        #include <defaultnormal_vertex_quantization>\n        #include <color_vertex>\n\n        #include <uv2_vertex>\n\n        #if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))\n            #include <uv2_decode_vertex>\n        #endif\n\n        #if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  \n            #include <uv2_offsetrepeat_vertex>\n        #endif\n\n        #include <packing_material_vertex>\n\n        // vec3 transformed = vec3( position );\n        #include <IBLShader_Transform_pars_vertex>\n        #include <project_vertex>\n        #include <heightLimit_vertex>\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <logdepthbuf_vertex>\n        #include <growthAnimation_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n        vec3 vsWorldPosition = Pos;\n\n        #include <view_shed_vertex>\n        #include <video_cast_vertex>\n    }\n",H.IBLFragmentShader="\n\n    #include <IBLUniform_pars_Fragment>\n    #include <uv2_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <hdrDecode_pars_Fragment>\n    #include <heightLimit_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <view_shed_pars_fragment>\n    #include <video_cast_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <growthAnimation_pars_fragment>\n    varying vec3 vViewPosition;\n\n    #include <csm_fragment>\n    #include <color_pars_fragment>\n    #include <cloud_state_defines>\n\n    float D_GGX(float NdotH, float roughness)\n    {\n        float alpha = pow(roughness, 2.0);\n        float alpha2 = pow(alpha, 2.0);\n        return alpha2 / (PI * pow(abs(NdotH * NdotH * (alpha2 - 1.0) + 1.0), 2.0));\n    }\n\n    float GGX_Schlick(float NdotV, float roughness)\n    {\n        float k = (roughness + 1.0) * 0.125;\n        return NdotV / (NdotV * (1.0 - k) + k);\n    }\n\n    float G_Smith(float NdotV, float NdotL, float roughness)\n    {\n        return GGX_Schlick(NdotV, roughness) * GGX_Schlick(NdotL, roughness);\n    }\n\n    vec3 F_Schlick(float HdotV, vec3 F0)\n    {\n        return F0 + (vec3(1.0) - F0) * pow((1.0 - HdotV), 5.0);\n    }\n\n    vec3 F_SchlickRoughness(float NdotV, vec3 F0, float roughness)\n    {\n        return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - NdotV, 5.0);\n    }\n\n    #include <CompressColor_pars_fragment>\n\n    vec3 postProcessing(vec3 color, bool toneMap)\n    {\n        vec3 result = toneMap ? toneMapCanonFilmic(color) : color;\n        result = pow(result, vec3(1.0 / gamma));\n        return result;\n    }\n\n    #ifdef USE_INSTANCE\n        varying vec4 vaColor;\n        varying float componentState;\n        varying float fClipping;\n    #endif\n\n    #include <compare_function>\n    #include <packing_material_pars_fragment>\n    #include <outline_pars_fragment>\n    #include <outline_function_pars_fragment_10>\n    #include <outline_function_fragment_get_line_tickness>\n\n    void main()\n    {\n        #include <NUM_CLIPPING_PLANES_fragment>\n        #define USE_PACKING_PIXEL0_W   1.0\n        #include <packing_material_fragment>\n\n        #ifdef USE_PACKINGMAT\n            vec4 diffuseColor = vec4(diffuse, opacity) ;\n        #else\n            vec4 diffuseColor = vec4(albedo.rgb, opacity) ;\n        #endif\n        bool useBaseColor = false;\n        #include <vertex_color_frag>\n        #include <baseColor_pars_fragment>\n        #include <growthAnimation_fragment>\n        #ifdef USE_ALPHAMAP\n            realOpacity *= texture2D( map, vUv ).a;\n        #endif\n\n        #ifdef DOUBLE_SIDED\n            float flipNormal = float(gl_FrontFacing) * 2.0 - 1.0;\n        #else\n            float flipNormal = 1.0;\n        #endif\n\n        vec3 normal = Normal * flipNormal;\n        vec3 vNormal = mvNormal * flipNormal;\n\n        #ifdef USE_NORMALMAP\n            normal = perturbNormal2Arb(Pos, normal);\n            vNormal = perturbNormal2Arb(mvPosition, vNormal);\n        #endif\n\n        #ifdef USE_BUMPMAP\n            normal = perturbNormalArb( mvPosition, normal, dHdxy_fwd(), 1.0);\n        #endif\n\n        float roughnessFactor = roughness;\n\n        #ifdef USE_ROUGHNESSMAP\n            roughnessFactor = texture2D(roughnessMap, vUv).r;\n        #endif\n\n        float metalnessFactor = metalness;\n\n        #ifdef USE_METALNESSMAP\n            metalnessFactor = texture2D(metalnessMap, vUv).r;\n        #endif\n\n        #ifdef USE_INSTANCE\n            #include <state_override_rough_n_metal_fragment>\n        #endif\n\n        float aoFactor = 1.0;\n        #ifdef USE_AOMAP\n            aoFactor = texture2D(aoMap, vUv).r;\n        #endif\n       \n        vec3 N = normal;\n        vec3 V = normalize(cameraPosition - Pos);\n        vec3 R = reflect(-V, N);\n\n        vec3 F0 = mix(vec3(0.04), baseColor, metalnessFactor);\n\n        vec3 totalLightColor = vec3(0.0);\n\n        vec3 viewVector = normalize(-mvPosition);\n        vec3 normalVector = normalize(vNormal);\n        float NdotV = max(dot(normalVector, viewVector), 0.0);\n\n        totalLightColor += ambientLightColor * baseColor / PI;\n\n        //Directional Lights\n        #include <direction_light_fragment>\n\n        //Point Lights\n        #include <point_light_fragment>\n\n        //Spot Lights\n        #include <spot_light_fragment>\n\n        #include <diffuse_specular_emissive_IBL_fragment>\n\n        totalLightColor += diffuseSpecularEmissive;\n        #include <IBLEnable_pars_fragment>\n        \n        #ifdef USE_INSTANCE\n\n            gl_FragColor = mix(\n                mix(gl_FragColor, blinkColor, blinkCoefficient), \n                gl_FragColor,\n                clamp(step(0.01, abs(componentState - ElementState_BLINK)) + step(0.01, abs(colorState - ShaderColorState_BLINK)), 0.0, 1.0)\n            );\n\n            // if (floatEqual(componentState, ElementState_BLINK) && floatEqual(colorState, ShaderColorState_BLINK)) {//if seleted, all are the same color;\n            //     gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n            // }\n        #else\n            gl_FragColor = mix(\n                mix(gl_FragColor, blinkColor, blinkCoefficient),\n                gl_FragColor,\n                step(0.01, abs(colorState - ShaderColorState_BLINK))\n            );\n            // if (floatEqual(colorState, ShaderColorState_BLINK)) {\n            //     gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n            // }\n        #endif\n        gl_FragColor = vec4(gl_FragColor.rgb * tintColor.rgb,gl_FragColor.a);\n\n        #include <view_shed_fragment>\n        #include <video_cast_fragment>\n        #include <heightLimit_fragment>\n\n        #if defined(USE_BC_OUTLINE)\n            vec3 _tempColor = gl_FragColor.rgb;\n            float line_tickness = getLineTickness();\n            line_tickness *= getLineDistFactor();// 远处线条渐隐\n            gl_FragColor.rgb = mix(_tempColor, outLineColor, line_tickness);\n        #endif\n\n        #include <fog_fragment>\n        #include <logdepthbuf_fragment>\n        #include <clamp_color_alpha>\n    }",H.cube_vs="\n\n    varying vec3 pos;\n    void main()\n    {\n        pos = position;\n        gl_Position = projectionMatrix * mat4(mat3(viewMatrix)) * modelMatrix * vec4(position, 1.0);\n        gl_Position = gl_Position.xyww;\n    }\n",H.cube_fs="\n\n    varying vec3 pos;\n\n    uniform samplerCube environmentMap;\n    uniform bool hdr;\n    uniform float shift;\n    uniform float A;\n    uniform float B;\n    uniform float C;\n    uniform float D;\n    uniform float E;\n    uniform float F;\n    uniform float scale;\n\n    #include <fog_pars_fragment>\n    #include <toneMapCanonFilmic_pars_Fragment>\n\n    void main()\n    {\n        vec3 envColor = textureCube(environmentMap, pos, 0.0).rgb;\n        if (hdr)\n        {\n            envColor = toneMapCanonFilmic(envColor);\n            envColor = pow(envColor, vec3(1.0 / 2.2));\n        }\n        gl_FragColor = vec4(envColor, 1.0);\n        #include <fog_fragment>\n    }\n",H.IBLBatchedVertexShaderV3=H.IBLVertexShader.replace("#include <USE_INSTANCE_pars_Vertex>","\n#include <cloud_state_pars_vertex>"),H.IBLBatchedVertexShaderV3=H.IBLBatchedVertexShaderV3.replace("#include <IBLShader_Transform_pars_vertex>",""),H.IBLInstanceVertexShaderV3=H.IBLVertexShader.replace("#include <IBLShader_Transform_pars_vertex>","\ncomponentState = vState.x;\n#include <Transform_pars_vertex>\n"),H.IBLInstanceVertexShaderV3=H.IBLInstanceVertexShaderV3.replace("#include <USE_INSTANCE_pars_Vertex>","\nattribute vec4 vState;\nattribute vec4 pointColorState;\nattribute float vClipping;\nvarying float fClipping;\nvarying float componentState;\nvarying vec4 vIdState;\nattribute vec4 aColor;\nvarying vec4 vaColor;\nattribute vec3 mcol0;\nattribute vec3 mcol1;\nattribute vec3 mcol2;\nattribute vec3 mcol3;\nvarying float wireFrameState;\nvarying vec4 vColorState;\n#if defined(USE_MAP)||defined(USE_BUMPMAP) \n    attribute vec4 muvCol0;\n    attribute vec2 muvCol1;\n //    attribute vec2 muvCol2;\n#endif\n#if defined(USE_LIGHTMAP)\n    attribute vec4 uv2OffsetRepeat;\n#endif"),H.IBLInstanceVertexShaderV3=H.IBLInstanceVertexShaderV3.replace("#include <Transform_pars_vertex>","\n   \n    #include <cloud_state_vertex>\n    vaColor = aColor;\n    fClipping = vClipping;\n    componentState = vState.x;\n    #include <Transform_pars_vertex>\n\n    #ifdef USE_INSTANCE_NORMAL\n        mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n        bool mirror = isMirror_mat3(normalMat);\n\n        // normalMat = inverse_mat3(normalMat);\n        // normalMat = transposeMat3(normalMat);\n\n        #include <getnormalmatrix_instance_vertex_quantization>\n\n        objectNormal = normalMat * vertexNormal;\n        transformedNormal = normalMatrix * vertexNormal;\n\n        if(mirror){\n          transformedNormal = - transformedNormal;\n          objectNormal = -objectNormal;\n        }\n        \n        #ifdef FLIP_SIDED\n            transformedNormal = - transformedNormal;\n            objectNormal = -objectNormal;\n        #endif\n        transformedNormal = normalize( transformedNormal );\n    #endif\n\n    mvNormal = transformedNormal;//\n    Normal = normalize(mat3(modelMatrix) * objectNormal);\n    Pos = vec3(modelMatrix * vec4(transformed, 1.0));\n\n    #include <CompressColor_vertex>\n"),H.IBLBatchedVertexShaderV3=H.IBLBatchedVertexShaderV3.replace("#include <video_cast_vertex>","\n#include <video_cast_vertex>\n#include <cloud_state_defines>\n#include <cloud_state_vertex>"),H.IBLInstanceFragmentShaderV3=H.IBLFragmentShader.replace("#include <video_cast_pars_fragment>","\n#include <video_cast_pars_fragment>\n#include <cloud_state_defines>\n#include <cloud_state_pars_fragment>\nvarying vec4 vaColor;\n"),H.IBLInstanceFragmentShaderV3=H.IBLInstanceFragmentShaderV3.replace("#include <vertex_color_frag>","\n#include <vertex_color_frag>\nif (floatEqual(componentState, ElementState_HIDDEN)) \n    discard;\n#ifndef USE_COLOR\n    diffuseColor = mix(\n        diffuseColor,\n        vec4(vaColor.xyz,opacity),\n        clamp(3.0 - (step(0.01, abs(componentState - ElementState_NONE)) + step(0.01, abs(componentState - ElementState_HOVER)) + step(0.01, abs(componentState - ElementState_BLINK))), 0.0, 1.0)\n    );\n    // if (floatEqual(componentState, ElementState_NONE) || floatEqual(componentState, ElementState_HOVER)|| floatEqual(componentState, ElementState_BLINK)) \n    //     diffuseColor = vec4(vaColor.xyz,opacity);\n#endif\n"),H.IBLInstanceFragmentShaderV3=H.IBLInstanceFragmentShaderV3.replace("#include <IBLEnable_pars_fragment>","\n    if (floatEqual(componentState, ElementState_HOVER))\n    {\n        realOpacity = vColorState.a;\n    }\n    else if (floatEqual(componentState,ElementState_OVERRIDED))\n    {\n        baseColor = vColorState.rgb;\n        realOpacity = vColorState.a;\n    }else if (floatEqual(componentState,ElementState_TRANSPARENT))\n    {\n        useBaseColor = true;\n        baseColor = vColorState.rgb;\n        realOpacity = vColorState.a;\n    }\n    #include <IBLEnable_pars_fragment>\n"),H.IBLBatchedFragmentShaderV3=H.IBLFragmentShader.replace("#include <video_cast_pars_fragment>","\n#include <video_cast_pars_fragment>\n#include <cloud_state_pars_fragment>\n"),H.IBLBatchedFragmentShaderV3=H.IBLBatchedFragmentShaderV3.replace("#include <IBLEnable_pars_fragment>","\n\n\n    #if defined( USE_COLOR )\n        realOpacity =  1.0 - vColor.a;\n    #endif\n\n    if (floatEqual(componentState, ElementState_HIDDEN))\n    {\n        discard;\n    }\n    else if (floatEqual(componentState, ElementState_HOVER))\n    {\n        realOpacity = vColorState.a;\n    }\n    else if (floatEqual(componentState,ElementState_OVERRIDED))\n    {\n        baseColor = vColorState.rgb;\n        realOpacity = vColorState.a;\n    }else if (floatEqual(componentState,ElementState_TRANSPARENT))\n    {\n        useBaseColor = true;\n        baseColor = vColorState.rgb;\n        realOpacity = vColorState.a;\n    }\n#include <IBLEnable_pars_fragment>\n"),H.irradiance_vs="\n\n\tvarying vec3 pos;\n\t//varying vec3 Normal;\n\n\tvoid main() {\n\t\tpos = vec3(modelMatrix * vec4(position, 1.0));\n\t//\tNormal = mat3(modelMatrix) * normal;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}",H.irradiance_fs="\n\n\tvarying vec3 pos;\n\tuniform samplerCube environmentMap;\n\t//uniform sampler2D HammersleyTable;\n\n\tconst float PI = 3.14159265358979;\n\t//const float INV_PI = 1.0 / PI;\n\n\tvec3 caluIrradiance(vec3 normal, vec3 up, vec3 right)\n\t{\n\t\tvec3 irradiance = vec3(0.0);\n\n\t\tint count = 0;\n\t\tconst int phiSampleCount = 1024;\n\t\tconst int thetaSampleCount = phiSampleCount / 4;\n\t\tfloat phiDelta = 2.0 * PI / float(phiSampleCount);\n\t\tfloat thetaDelta = 0.5 * PI / float(thetaSampleCount);\n\t\tfor(int i = 0; i < phiSampleCount; ++i)\n\t\t{\n\t\t\tfloat phi = float(i) * phiDelta;\n\t\t\tfor(int j = 0; j < thetaSampleCount; ++j)\n\t\t\t{\n\t\t\t\tfloat theta = float(j) * thetaDelta;\n\t\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));\n\t\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * normal; \n\n\t\t\t\tirradiance += textureCube(environmentMap, sampleVec, 0.0).rgb * cos(theta) * sin(theta);\n\t\t\t\t++count;\n\t\t\t}\n\t\t}\n\t\tirradiance = PI * irradiance * (1.0 / float(count));\n\n\t\treturn irradiance;\n\t}\n\n\tvoid main()\n\t{\n\t\tvec3 normal = normalize(pos);\n\t\tvec3 up = vec3(0.0, 1.0, 0.0);\n\t\tvec3 right = cross(up, normal);\n\t\tup = cross(normal, right);\n\t\tvec3 irradiance = caluIrradiance(normal, up, right);\n\n\t\tgl_FragColor = vec4(irradiance, 1.0);\n\t}",H.IrradianceMap=function(e,t){this.cubeTexture=null,this.resolution=t||32,this.irradianceMaterial=new THREE.ShaderMaterial({vertexShader:H.irradiance_vs,fragmentShader:H.irradiance_fs,uniforms:{environmentMap:{value:e}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.irradianceMaterial)},H.IrradianceMap.prototype.constructor=H.IrradianceMap,H.IrradianceMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var r=new THREE.CubeCamera(.1,10,this.resolution);if(t){var n={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,n)}r.updateCubeMap(e,i),this.cubeTexture=r.renderTarget.texture},H.prefilter_vs="\n\n\tvarying vec3 pos;\n\tvarying vec3 Normal;\n\n\tvoid main() {\n\t\tpos = vec3(modelMatrix * vec4(position, 1.0));\n\t\tNormal = mat3(modelMatrix) * normal;\n\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}",H.prefilter_fs="\n\n\tvarying vec3 pos;\n\tvarying vec3 Normal;\n\n\tuniform float roughness;\n\n\tuniform samplerCube environmentMap;\n\tuniform sampler2D HammersleyTable;\n\n\tconst float PI = 3.14159265358979;\n\t//const float INV_PI = 1.0 / PI;\n\n\tfloat D_GGX(float NdotH, float roughness)\n\t{\n\t\tfloat alpha = pow(roughness, 2.0);\n\t\tfloat alpha2 = pow(alpha, 2.0);\n\t\treturn alpha2 / (PI * pow(NdotH * NdotH * (alpha2 - 1.0) + 1.0, 2.0));\n\t}\n\n\tvec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness) \n\t{\n\t\tfloat a = roughness * roughness;\n\n\t\tfloat Phi = 2.0 * PI * Xi.x; \n\t\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); \n\t\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);\n\n\t\tvec3 H;\n\t\tH.x = SinTheta * cos(Phi); \n\t\tH.y = SinTheta * sin(Phi); \n\t\tH.z = CosTheta;\n\n\t\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); \n\t\tvec3 TangentX = normalize(cross(UpVector, N)); \n\t\tvec3 TangentY = cross(N, TangentX);\n\n\t\t// Tangent to world space \n\t\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);\n\t}\n\n\tvoid main()\n\t{\n\t\tvec3 N = normalize(pos);\n\t\tvec3 R = N;\n\t\tvec3 V = R;\n\n\t\tconst int sampleCount = 1024;\n\n\t\tfloat totalWeight = 0.0;\n\t\tvec3 prefilteredColor = vec3(0.0);\n\n\t\tfor (int i = 0; i < sampleCount; ++i) {\n\t\t\tfloat u = float(i) / float(sampleCount);\n\t\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);\n\t\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);\n\t\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);\n\n\t\t\tfloat NdotL = max(dot(N, L), 0.0);\n\t\t\tif(NdotL > 0.0)\n\t\t\t{\n\t\t\t\tfloat NdotH = max(dot(N, H), 0.0);\n\t\t\t\tfloat D = D_GGX(NdotH, roughness);\n\n\t\t\t\tfloat HdotV = max(dot(H, V), 0.0);\n\t\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV);\n\n\t\t\t\tfloat resolution = 2048.0; // resolution of source cubemap (per face)\n\t\t\t\tfloat solidAngleTexel= 4.0 * PI / (6.0 * resolution * resolution);\n\t\t\t\tfloat solidAngleSample = 1.0 / (float(sampleCount) * pdf);\n\n\t\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(solidAngleSample / solidAngleTexel);\n\n\t\t\t\tprefilteredColor += textureCube(environmentMap, L, mipLevel).rgb * NdotL;\n\t\t\t\ttotalWeight += NdotL;\n\t\t\t}\n\t\t}\n\n\t\tprefilteredColor = prefilteredColor / totalWeight;\n\t\tgl_FragColor = vec4(prefilteredColor, 1.0);\n\t}",H.PrefilterMap=function(e,t,i,r){this.cubeTexture=null,this.resolution=i||128,this.maxMipLevel=r||1,this.prefilterMaterial=new THREE.ShaderMaterial({vertexShader:H.prefilter_vs,fragmentShader:H.prefilter_fs,uniforms:{roughness:{value:0},environmentMap:{value:e},HammersleyTable:{value:t}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.prefilterMaterial)},H.PrefilterMap.prototype.constructor=H.PrefilterMap,H.PrefilterMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var r=new THREE.CubeCamera(.1,10,this.resolution);if(t){var n={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,n)}for(var a=this.maxMipLevel<=1?1:this.maxMipLevel-1,s=0;s<this.maxMipLevel;s++){var o=this.resolution*Math.pow(.5,s);r.renderTarget.width=r.renderTarget.height=o;var l=s/a;this.prefilterMaterial.uniforms.roughness.value=l,r.renderTarget.activeMipMapLevel=s,r.updateCubeMap(e,i)}this.cubeTexture=r.renderTarget.texture},function(){class e extends THREE.DataTextureLoader{constructor(e){super(e),this.type=THREE.UnsignedByteType}parse(e){const t=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},i=function(e,t,i){t=t||1024;let r=e.pos,n=-1,a=0,s="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));for(;0>(n=o.indexOf("\n"))&&a<t&&r<e.byteLength;)s+=o,a+=o.length,r+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));return-1<n&&(!1!==i&&(e.pos+=a+n+1),s+o.slice(0,n))},r=function(e,t,i,r){const n=e[t+3],a=Math.pow(2,n-128)/255;i[r+0]=e[t+0]*a,i[r+1]=e[t+1]*a,i[r+2]=e[t+2]*a,i[r+3]=1},n=function(e,t,i,r){const n=e[t+3],a=Math.pow(2,n-128)/255;i[r+0]=THREE.DataUtils.toHalfFloat(Math.min(e[t+0]*a,65504)),i[r+1]=THREE.DataUtils.toHalfFloat(Math.min(e[t+1]*a,65504)),i[r+2]=THREE.DataUtils.toHalfFloat(Math.min(e[t+2]*a,65504)),i[r+3]=THREE.DataUtils.toHalfFloat(1)},a=new Uint8Array(e);a.pos=0;const s=function(e){const r=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*FORMAT=(\S+)\s*$/,s=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,d;if(e.pos>=e.byteLength||!(l=i(e)))return t(1,"no header found");if(!(d=l.match(/^#\?(\S+)/)))return t(3,"bad initial token");for(o.valid|=1,o.programtype=d[1],o.string+=l+"\n";l=i(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((d=l.match(r))&&(o.gamma=parseFloat(d[1])),(d=l.match(n))&&(o.exposure=parseFloat(d[1])),(d=l.match(a))&&(o.valid|=2,o.format=d[1]),(d=l.match(s))&&(o.valid|=4,o.height=parseInt(d[1],10),o.width=parseInt(d[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid?4&o.valid?o:t(3,"missing image size specifier"):t(3,"missing format specifier")}(a);if(-1!==s){const e=s.width,i=s.height,o=function(e,i,r){const n=i;if(n<8||n>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(n!==(e[2]<<8|e[3]))return t(3,"wrong scanline width");const a=new Uint8Array(4*i*r);if(!a.length)return t(4,"unable to allocate buffer space");let s=0,o=0;const l=4*n,d=new Uint8Array(4),h=new Uint8Array(l);let c=r;for(;c>0&&o<e.byteLength;){if(o+4>e.byteLength)return t(1);if(d[0]=e[o++],d[1]=e[o++],d[2]=e[o++],d[3]=e[o++],2!=d[0]||2!=d[1]||(d[2]<<8|d[3])!=n)return t(3,"bad rgbe scanline format");let i,r=0;for(;r<l&&o<e.byteLength;){i=e[o++];const n=i>128;if(n&&(i-=128),0===i||r+i>l)return t(3,"bad scanline data");if(n){const t=e[o++];for(let e=0;e<i;e++)h[r++]=t}else h.set(e.subarray(o,o+i),r),r+=i,o+=i}const u=n;for(let e=0;e<u;e++){let t=0;a[s]=h[e+t],t+=n,a[s+1]=h[e+t],t+=n,a[s+2]=h[e+t],t+=n,a[s+3]=h[e+t],s+=4}c--}return a}(a.subarray(a.pos),e,i);if(-1!==o){let t,a,l;switch(this.type){case THREE.UnsignedByteType:t=o;THREE.RGBEFormat;a=THREE.UnsignedByteType;break;case THREE.FloatType:l=o.length/4;const e=new Float32Array(4*l);for(let t=0;t<l;t++)r(o,4*t,e,4*t);t=e,a=THREE.FloatType;break;case THREE.HalfFloatType:l=o.length/4;const i=new Uint16Array(4*l);for(let e=0;e<l;e++)n(o,4*e,i,4*e);t=i,a=THREE.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:i,data:t,header:s.string,gamma:s.gamma,exposure:s.exposure,type:a}}}return null}setDataType(e){return this.type=e,this}load(e,t,i,r){return super.load(e,(function(e,i){switch(e.type){case THREE.UnsignedByteType:e.encoding=THREE.RGBEEncoding,e.minFilter=THREE.NearestFilter,e.magFilter=THREE.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case THREE.FloatType:case THREE.HalfFloatType:e.encoding=THREE.LinearEncoding,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,i)}),i,r)}}THREE.RGBELoader=e}(),r.IBLManager=function(e){this.viewer=e,this.IBLConfig=null,this.host="",this.isHDR=!0,this.textureLoad=!1;var t=0,i=null,n=null;this.enableIBL=function(e){r.GlobalData.IBL!==e&&(r.GlobalData.IBL=e,this.viewer.setRenderStateChanged(!0),e?null!=i?this.initIBLByName(i):this.initIBLByIndex(t):(this.viewer.modelManager.changeAllMaterials(!1),this.removeSkyBox()))},this.loadIBLConfig=function(e){var t=this,i=this.viewer;(new THREE.FileLoader).load(e,(function(e){t.IBLConfig=JSON.parse(e),r.GlobalData.IBL&&t.initIBLByIndex(0)}),void 0,(function(){i.modelManager.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_IBLCONFIG_ERROR,event:event})}))},this.initIBLByIndex=function(e){if(r.GlobalData.IBL&&null!=this.IBLConfig){var n=Object.keys(this.IBLConfig);if(n.length>e){var a=this.IBLConfig[n[e]];this.loadIBLMaps(this.host+a.url,a.isHDR,!0,a.uniforms),t=e,i=n[e]}}},this.initIBLByName=function(e){if(r.GlobalData.IBL&&null!=this.IBLConfig&&this.IBLConfig.hasOwnProperty(e)){var t=this.IBLConfig[e];this.loadIBLMaps(this.host+t.url,t.isHDR,!0,t.uniforms),i=e}},this.loadIBLMaps=function(e,t,i,n,a){function s(e){for(var r in o.modelManager.changeAllMaterials(!0),o.modelManager.updateMaterialsValue("IBLMaps",e,!0),n)"shift"!=r&&o.modelManager.updateMaterialsValue(r,n[r],!0);i&&l.addSkyBox(t,n),l.textureLoad=!0,o.setRenderStateChanged(!0),o.render()}if(r.GlobalData.IBL){var o=this.viewer;!n.iblFactor&&o.modelManager.isMeterUnit()&&(n.iblFactor=10),this.IBLParams=n;var l=this,d=o.getScene();a?s(d.IBLMaps):d.IBLMaps.loadMaps(e,t,!1,s)}},this.loadSkyBoxNew=function(e,t,i,r,n){function a(e){i&&o.addSkyBox(t,r),o.textureLoad=!0,s.setRenderStateChanged(!0),s.render()}var s=this.viewer,o=this,l=s.getScene();n?a(l.IBLMaps):l.IBLMaps.loadMaps(e,t,!1,a)},this.loadSkyBox=function(e,t){var i=this,r=this.viewer;r.getScene().IBLMaps.loadMaps(e,t,!0,(function(e,t){i.addSkyBox(t),r.render()}))},this.addSkyBox=function(e,t){e=null==e?this.isHDR:e;this.isHDR=e;var i=null,n=this.viewer.getScene();n.hasObjectGroup(r.ObjectGroupType.IBLCUBE)?((i=n.getObjectGroup(r.ObjectGroupType.IBLCUBE).children[0]).material.uniforms.environmentMap.value=n.IBLMaps.environmentMap,i.material.uniforms.hdr.value=e):((i=new THREE.Mesh(new THREE.BoxBufferGeometry(2e3,2e3,2e3),new THREE.ShaderMaterial({uniforms:{environmentMap:{value:n.IBLMaps.environmentMap},hdr:{value:e},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105},fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new THREE.Color(16777215)},postProcessMap:{value:null},postProcessAdditiveMap:{value:null},postProcessSSAOMap:{value:null},postProcessSSRMap:{value:null},postProcessMixRate:{value:0},postProcessAdditiveRate:{value:0},postProcessSSAORate:{value:0},postProcessSSRRate:{value:0},viewportWidth:{value:0},viewportHeight:{value:0}},vertexShader:H.cube_vs,fragmentShader:H.cube_fs,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,fog:!0}))).frustumCulled=!1,n.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE,{priority:10}).add(i));if(t){var a=i.material;for(var s in t)a.uniforms.hasOwnProperty(s)&&(a.uniforms[s].value=t[s])}},this.renderWithOrthCamera=function(e,t,i,n){var a=e.getScene(),s=i||e.camera;if(a.hasObjectGroup(r.ObjectGroupType.IBLCUBE)&&(a.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!0,!s.isPerspective)){t.autoClear=!0,e.switchToCamera("persp",!1),r.GlobalData.IncrementRender&&0==n&&t.setObjectListUpdateState(!0);for(var o=a.getObjectGroups(),l=o.length,d=new Array(l),h=0;h<l;++h)d[h]=o[h].visible,o[h].visible=!1;a.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!0,t.render(a,s);for(h=0;h<l;++h)o[h].visible=d[h];d=null,a.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!1,e.switchToCamera("orth",!1),t.autoClear=!1,r.GlobalData.IncrementRender&&t.resetIncrementRender()}},this.removeSkyBox=function(){var e=this.viewer.getScene();e.hasObjectGroup(r.ObjectGroupType.IBLCUBE)&&(e.removeObjectGroupByName(r.ObjectGroupType.IBLCUBE),this.viewer.render())},this.setSkyBoxType=function(e){n=e},this.getSkyBoxType=function(){return n}},r.VolumeShader={uniforms:{backWorldPositionMap:{type:"t",value:null},densityMap:{type:"t",value:null},paletteMap:{type:"t",value:null},normalizeMatrix:{type:"m4",value:new THREE.Matrix4},resolution:{type:"f",value:81}},vertexShader:"\n    varying vec3 worldSpaceCoords;\n    varying vec4 projectedCoords;\n    uniform mat4 normalizeMatrix;\n\n    #include <logdepthbuf_pars_vertex>\n    bool isPerspectiveMatrix( mat4 m ) {\n      return m[ 2 ][ 3 ] == - 1.0;\n    }\n    void main()\n    {\n        //worldSpaceCoords = (modelMatrix * vec4(position + vec3(0.5, 0.5,0.5), 1.0 )).xyz;\n        worldSpaceCoords = (normalizeMatrix * vec4(position , 1.0 )).xyz;\n        gl_Position = projectionMatrix *  modelViewMatrix * vec4( position, 1.0 );\n        projectedCoords =  gl_Position;\n        #include <logdepthbuf_vertex>\n    }\n    ",fragmentShader:"\n\n    varying vec3 worldSpaceCoords;\n    varying vec4 projectedCoords;\n    uniform sampler2D backWorldPositionMap;\n    uniform sampler2D densityMap;\n    uniform sampler2D paletteMap;\n    uniform float resolution;\n    float steps = 256.0;\n    float alphaCorrection = 0.8;//1.0;\n    // The maximum distance through our rendering volume is sqrt(3).\n    // The maximum number of steps we take to travel a distance of 1 is 512.\n    // ceil( sqrt(3) * 512 ) = 887\n    // This prevents the back of the image from getting cut off when steps=512 & viewing diagonally.\n    const int MAX_STEPS = 887;\n\n\n    float getRealAlpha(float a){\n        a = min(0.85, a) / 0.85;\n        return a < 0.03 ? 0.02: a;\n    }\n\n    //Acts like a texture3D using Z slices and trilinear filtering.\n    vec4 sampleAs3DTexture( vec3 texCoord )\n    {\n        float texLen = resolution - 1.0;\n        float sqrLen = sqrt(resolution);\n\n        vec4 colorSlice1, colorSlice2;\n        vec2 texCoordSlice1, texCoordSlice2;\n\n        //The z coordinate determines which Z slice we have to look for.\n        //Z slice number goes from 0 to 255.\n        float zSliceNumber1 = floor(texCoord.z  * texLen);\n\n        //As we use trilinear we go the next Z slice.\n        float zSliceNumber2 = min( zSliceNumber1 + 1.0, texLen); //Clamp to 255\n\n        //The Z slices are stored in a matrix of 16x16 of Z slices.\n        //The original UV coordinates have to be rescaled by the tile numbers in each row and column.\n        texCoord.xy /= sqrLen;\n\n        texCoordSlice1 = texCoordSlice2 = texCoord.xy;\n\n        //Add an offset to the original UV coordinates depending on the row and column number.\n        texCoordSlice1.x += (mod(zSliceNumber1, sqrLen ) / sqrLen);\n        texCoordSlice1.y += floor((texLen - zSliceNumber1) / sqrLen) / sqrLen;\n\n        texCoordSlice2.x += (mod(zSliceNumber2, sqrLen ) / sqrLen);\n        texCoordSlice2.y += floor((texLen - zSliceNumber2) / sqrLen) / sqrLen;\n\n        //Get the opacity value from the 2D texture.\n        //Bilinear filtering is done at each texture2D by default.\n        colorSlice1.a = getRealAlpha(texture2D( densityMap, texCoordSlice1 ).x);//0.01\n        colorSlice2.a = getRealAlpha(texture2D( densityMap, texCoordSlice2 ).x);\n\n        //Based on the opacity obtained earlier, get the RGB color in the transfer function texture.\n        colorSlice1.rgb = texture2D( paletteMap, vec2( colorSlice1.a, 1.0) ).rgb;\n        colorSlice2.rgb = texture2D( paletteMap, vec2( colorSlice2.a, 1.0) ).rgb;\n\n        //How distant is zSlice1 to ZSlice2. Used to interpolate between one Z slice and the other.\n        float zDifference = mod(texCoord.z * texLen, 1.0);\n\n        //Finally interpolate between the two intermediate colors of each Z slice.\n        return mix(colorSlice1, colorSlice2, zDifference) ;\n    }\n\n    #include <logdepthbuf_pars_fragment>\n    void main( void ) {\n        //Transform the coordinates it from [-1;1] to [0;1]\n        vec2 texc = vec2(((projectedCoords.x / projectedCoords.w) + 1.0 ) / 2.0,\n                        ((projectedCoords.y / projectedCoords.w) + 1.0 ) / 2.0 );\n\n        //The back position is the world space position stored in the texture.\n        vec3 backPos = texture2D(backWorldPositionMap, texc).xyz;\n\n        //The front position is the world space position of the second render pass.\n        vec3 frontPos = worldSpaceCoords;\n\n        //Using NearestFilter for rtTexture mostly eliminates bad backPos values at the edges\n        //of the cube, but there may still be no valid backPos value for the current fragment.\n        if ((backPos.x == 0.0) && (backPos.y == 0.0))\n        {\n            // gl_FragColor = vec4(0.0);\n            // return;\n            discard;\n        }\n\n        //The direction from the front position to back position.\n        vec3 dir = backPos - frontPos;\n\n        float rayLength = length(dir);\n        bool constraintSteps = false;\n        if(rayLength == 0.0){\n            constraintSteps = true;\n        }\n\n        //Calculate how long to increment in each step.\n        float delta = 1.0 / steps;\n\n        //The increment in each direction for each step.\n        vec3 deltaDirection = normalize(dir) * delta;\n        float deltaDirectionLength = length(deltaDirection);\n\n        //Start the ray casting from the front position.\n        vec3 currentPosition = frontPos;\n\n        //The color accumulator.\n        vec4 accumulatedColor = vec4(0.0);\n\n        //The alpha value accumulated so far.\n        float accumulatedAlpha = 0.0;\n\n        //How long has the ray travelled so far.\n        float accumulatedLength = 0.0;\n\n        //If we have twice as many samples, we only need ~1/2 the alpha per sample.\n        //Scaling by 256/10 just happens to give a good value for the alphaCorrection slider.\n        float alphaScaleFactor = 25.6 * delta;\n\n        vec4 colorSample;\n        float alphaSample;\n\n        //Perform the ray marching iterations\n        for(int i = 0; i < MAX_STEPS; i++)\n        {\n            if(constraintSteps && i >= 1){\n              break;\n            }\n\n            //Get the voxel intensity value from the 3D texture.\n            colorSample = sampleAs3DTexture( currentPosition );\n\n            //Allow the alpha correction customization.\n            alphaSample = colorSample.a * alphaCorrection;\n\n            //Applying this effect to both the color and alpha accumulation results in more realistic transparency.\n            alphaSample *= (1.0 - accumulatedAlpha);\n\n            //Scaling alpha by the number of steps makes the final color invariant to the step size.\n            alphaSample *= alphaScaleFactor;\n\n            //Perform the composition.\n            accumulatedColor += colorSample * alphaSample;\n\n            //Store the alpha accumulated so far.\n            accumulatedAlpha += alphaSample;\n\n            //Advance the ray.\n            currentPosition += deltaDirection;\n            accumulatedLength += deltaDirectionLength;\n\n            //If the length traversed is more than the ray length, or if the alpha accumulated reaches 1.0 then exit.\n            if(accumulatedLength >= rayLength || accumulatedAlpha >= 1.0 )\n                break;\n        }\n        gl_FragColor  = accumulatedColor;\n        // remark:是不是应该用accumulatedAlpha?\n        // gl_FragColor  = vec4(accumulatedColor.rgb, clamp(accumulatedAlpha, 0.0, 1.0));\n        #include <logdepthbuf_fragment>\n\n    }\n    "},r.BackWorldPosShader={uniforms:{normalizeMatrix:{type:"m4",value:new THREE.Matrix4}},vertexShader:"\n    varying vec3 worldSpaceCoords;\n    uniform mat4 normalizeMatrix;\n    // #include <clipping_planes_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    bool isPerspectiveMatrix( mat4 m ) {\n        return m[ 2 ][ 3 ] == - 1.0;\n    }\n    void main()\n    {\n        //Set the world space coordinates of the back faces vertices as output.\n        worldSpaceCoords = (normalizeMatrix * vec4(position , 1.0 )).xyz; \n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        // #include <begin_vertex>\n        // #include <project_vertex>\n        // #include <clipping_planes_vertex>\n        #include <logdepthbuf_vertex>\n    }\n    ",fragmentShader:"\n    varying vec3 worldSpaceCoords;\n    // #include <clipping_planes_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    void main()\n    {\n        //#include <clipping_planes_fragment>\n        //The fragment's world space coordinates as fragment output.\n        gl_FragColor = vec4( worldSpaceCoords.x , worldSpaceCoords.y, worldSpaceCoords.z, 1 );\n        #include <logdepthbuf_fragment>\n    }\n    "},function(){class e extends THREE.Mesh{constructor(e,t,i){super(t,i),this.viewer=e.viewer;let n=this.viewer.getRenderer();this.size=new THREE.Vector2,n.getDrawingBufferSize(this.size),this.radiusScale=e.radiusScale,this.resolution=e.resolution,this.gradient={.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},this.backSceneRenderTarget=new THREE.WebGLRenderTarget(this.size.x,this.size.y,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:THREE.FloatType,generateMipmaps:!1}),this.heatmapNum=0,this.sceneForBackPos=new THREE.Scene;var a=this.viewer.getScene().getRawMatrixGlobal();this.meshGroup=new r.ObjectGroup("backScene"),this.meshGroup.matrix.copy(a),this.meshGroup.matrixAutoUpdate=!1,this.meshGroup.updateMatrixWorld(!0),this.sceneForBackPos.add(this.meshGroup),this.material=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(r.VolumeShader.uniforms),vertexShader:r.VolumeShader.vertexShader,fragmentShader:r.VolumeShader.fragmentShader,side:THREE.DoubleSide,transparent:!0}),this.material.uniforms.backWorldPositionMap.value=this.backSceneRenderTarget.texture,this.material.uniforms.densityMap.value=this._getDensityMap(e.data),this.material.uniforms.paletteMap.value=this._getPaletteMap(),this.material.uniforms.normalizeMatrix.value=e.normalizeMatrix,this.material.uniforms.resolution.value=e.resolution.x,this.geometry=this._getGeometry(e.boundary,e.height),this.position.z=e.offsetZ,this.updateMatrixWorld(),this.backMaterial=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(r.BackWorldPosShader.uniforms),vertexShader:r.BackWorldPosShader.vertexShader,fragmentShader:r.BackWorldPosShader.fragmentShader,side:THREE.BackSide}),this.backMaterial.uniforms.normalizeMatrix.value=e.normalizeMatrix,this.backMesh=new THREE.Mesh(this.geometry,this.backMaterial),this.backMesh.position.z=e.offsetZ,this.backMesh.updateMatrixWorld(),this.meshGroup.add(this.backMesh),this.meshGroup.updateMatrixWorld(),this.renderOrder=r.GlobalData.IncrementRender?100:-1}onBeforeRender(e,t,i){e.getDrawingBufferSize(this.size);let r=this.backSceneRenderTarget;this.size.x==r.width&&this.size.y==r.height||r.setSize(this.size.x,this.size.y);var n=e.getRenderTarget();e.setRenderTarget(this.backSceneRenderTarget),e.clear(),e.render(this.sceneForBackPos,i),this.material.uniforms.backWorldPositionMap.value=this.backSceneRenderTarget.texture,e.setRenderTarget(n)}_getGeometry(e,t){var i=new THREE.Shape(e),r={depth:t,bevelEnabled:!1};return new THREE.ExtrudeGeometry(i,r)}_getDensityMap(e){var t=this.resolution.x,i=this.resolution.y,r=this.resolution.z;let n=Math.sqrt(r),a=Math.sqrt(r),s=new Uint8Array(t*i*r);const o=!0===this.viewer.webgl2Support?THREE.RedFormat:THREE.LuminanceFormat;this._updateDensityMapData(s,e);var l=new THREE.DataTexture(s,t*n,i*a,o);return l.minFilter=THREE.LinearFilter,l.magFilter=THREE.LinearFilter,l.generateMipmaps=!1,l.needsUpdate=!0,this.densityMap=l,this.densityMap}updateDensityMap(e){let t=this.densityMap.image.data;this._updateDensityMapData(t,e),this.densityMap.needsUpdate=!0}_updateDensityMapData(e,t){var i=this.resolution.x,r=this.resolution.y,n=this.resolution.z;let a=Math.sqrt(n),s=Math.sqrt(n);function o(e,t,i,r,n,a,s){return Math.sqrt(Math.pow((e-r)/s.x,2)+Math.pow((t-n)/s.y,2)+Math.pow((i-a)/s.z,2))}e.fill(0);let l=this.radiusScale;for(var d=0;d<t.length;d++){let m=t[d],f=Math.floor(Math.max(0,m.x-m.radius*l.x)),g=Math.floor(Math.max(0,m.y-m.radius*l.y)),v=Math.floor(Math.max(0,m.z-m.radius*l.z)),y=Math.ceil(Math.min(i,m.x+m.radius*l.x)),M=Math.ceil(Math.min(r,m.y+m.radius*l.y)),E=Math.ceil(Math.min(n,m.z+m.radius*l.z));for(var h=v;h<E;h++)for(var c=g;c<M;c++)for(var u=f;u<y;u++){var p=o(u,c,h,m.x,m.y,m.z,l);let t=u+h%s*i,d=n-h-1,f=c+Math.floor(d/a)*r,g=p<0*m.radius?m.value:(1-p/m.radius+0)*m.value,v=f*r*s+t;e[v]=Math.max(255*g,e[v])}}}_getPaletteMap(){var e=this.gradient,t=document.createElement("canvas"),i=t.getContext("2d");t.width=256,t.height=1;var r=i.createLinearGradient(0,0,256,1);for(var n in e)r.addColorStop(n,e[n]);i.fillStyle=r,i.fillRect(0,0,256,1);let a=new THREE.Texture(t);return a.wrapS=a.wrapT=THREE.ClampToEdgeWrapping,a.needsUpdate=!0,a}dispose(){this.geometry.dispose(),this.material.dispose()}setGradient(e){this.gradient=e,this.material.uniforms.paletteMap.value=this._getPaletteMap()}}r.Heatmap3D=e}();r.Storage=r.Storage||{},r.Storage.IndexedDBHelper=class{constructor(e){this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,this.indexedDB||console.log("IndexedDB not supported"),this._db=null,this._opt=e,this._onOpening=!1,this._onOpeningResolves=[],this._onOpeningRejects=[],this._temp={}}open(e,t){this._onOpening=!0;const i=e||this._opt.name,r=t||this._opt.version,n=this.indexedDB.open(i,r);return new Promise(((e,t)=>{n.onsuccess=i=>{let r=n.result,a=!1;if(this._opt.storeList){let i=Object.values(r.objectStoreNames);this._opt.storeList.some((n=>{if(-1===i.indexOf(n)){let{name:i,version:n}=r;return n++,r.close(),this.open(i,n).then(e).catch(t),a=!0}}))}a||(this._db=r,e(r))},n.onupgradeneeded=e=>{let t=this._db=e.target.result,i=this._opt.storeList||[];i.forEach((e=>!t.objectStoreNames.contains(e)&&t.createObjectStore(e))),Object.values(t.objectStoreNames).forEach((e=>-1===i.indexOf(e)&&t.deleteObjectStore(e)))},n.onerror=e=>{t(e)}}))}getDB(){return new Promise(((e,t)=>{this._db?e(this._db):this._onOpening?(this._onOpeningResolves.push(e),this._onOpeningRejects.push(t)):this.open().then((t=>{e(t),this._onOpeningResolves.forEach((e=>e(t)))})).catch((e=>{t(e),this._onOpeningRejects.forEach((t=>t(e)))}))}))}addObject(e,t,i){return new Promise(((r,n)=>{this.getDB().then((a=>{if(!a.objectStoreNames.contains(e))return void n();const s=a.transaction(e,"readwrite");s.objectStore(e).put(t,i).onsuccess=n=>{this._temp[e]&&this._temp[e].keys&&(this._temp[e].keys.push(i),this._temp[e].map[i]=t),r(n.target.result)},s.onerror=n})).catch(n)}))}getObject(e,t,i=!1){return new Promise(i?(i,r)=>{if(this._temp[e]){let n=this._temp[e].map[t];if(n)return void i(n);if(-1===this._temp[e].keys.indexOf(t))return void r()}this.getDB().then((n=>{if(!n.objectStoreNames.contains(e))return void r();const a=n.transaction(e,"readonly"),s=a.objectStore(e);let o=new Promise((e=>s.getAllKeys().onsuccess=t=>e(t.target.result))),l=new Promise((e=>s.getAll().onsuccess=t=>e(t.target.result)));Promise.all([o,l]).then((n=>{let[a,s]=n;this._temp[e]={keys:a,map:{}};let o=!1;a.forEach(((r,n)=>{t===r?(i(s[n]),o=!0):this._temp[e].map[r]=s[n]})),o||r()})),a.onerror=r})).catch(r)}:(i,r)=>{this.getDB().then((n=>{if(!n.objectStoreNames.contains(e))return void r();const a=n.transaction(e,"readonly");a.objectStore(e).get(t).onsuccess=e=>{let t=e.target.result;t?i(t):r(e)},a.onerror=r})).catch(r)})}deleteObject(e,t){return new Promise(((i,r)=>{this.getDB().then((n=>{if(!n.objectStoreNames.contains(e))return void r();const a=n.transaction(e,"readwrite");a.objectStore(e).delete(t).onsuccess=e=>{i(e.target.result)},a.onerror=r})).catch(r)}))}},r.Storage.IndexedDBHelper.loadWithStorage=(e,t,i,n,a,s=!1)=>{let o=()=>{i(t).then((i=>{let a=s?JSON.stringify(i):i;r.EnableStorage&&r.storageManager[`add${e}`](a,t),n&&n(i)})).catch((e=>a&&a(e)))};r.EnableStorage?r.storageManager[`get${e}`](t).then((e=>{let t=s?JSON.parse(e):e;n&&n(t)})).catch((e=>{o()})):o()};r.Storage.StorageManager=class{constructor(){this.helperMap={},r.storageManager=this}getHelper(e){return this.helperMap[e]=this.helperMap[e]||new r.Storage.IndexedDBHelper({name:`Bf_${e}`,storeList:["i","m","t"]}),this.helperMap[e]}getDatabagIdAndKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/resource\/v3\/model\/(.+?)(\.gz)?(\?.+)?$/.exec(e);return t?{databagId:t[1],key:t[2]}:{databagId:"i",key:e}}getDatabagIdAndRootKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/(.+?)(\.gz)?(\?.+)?$/.exec(e);return t?{databagId:t[1],key:t[2]}:{databagId:"i",key:e}}addData(e,t,i,r=!0){return new Promise(((n,a)=>{let s=r?this.getDatabagIdAndRootKeyByUrl(i):this.getDatabagIdAndKeyByUrl(i),{databagId:o,key:l}=s;this.getHelper(o).addObject(e,t,l).then((e=>n(e))).catch((e=>a(e)))}))}addModelData(e,t){return this.addData("m",e,t)}addInfoData(e,t){return this.addData("i",e,t)}getData(e,t,i=!0){return new Promise(((r,n)=>{let a=i?this.getDatabagIdAndRootKeyByUrl(e):this.getDatabagIdAndKeyByUrl(e),{databagId:s,key:o}=a;this.getHelper(s).getObject(t,o).then((e=>{r(e)})).catch((e=>n(e)))}))}getModelData(e){return this.getData(e,"m")}getInfoData(e){return this.getData(e,"i")}addTexture(e,t){const i=(e,t)=>{let i=this._canvas=this._canvas||document.createElement("canvas"),r=i.getContext("2d");return r.clearRect(0,0,i.width,i.height),i.width=t,i.height=t,r.drawImage(e,0,0,t,t),r.getImageData(0,0,t,t)};return new Promise(((n,a)=>{let s,o=this.getDatabagIdAndKeyByUrl(t),{databagId:l,key:d}=o;e.image instanceof HTMLImageElement?(e.image=r.MaterialUtil.ensurePowerOfTwo(e.image),s={type:"DataTexture",data:{image:i(e.image,e.image.width)}}):s={type:"CompressedTexture",data:{image:e.image}},["anisotropy","encoding","flipY","format","generateMipmaps","magFilter","mapping","minFilter","mipmaps","premultiplyAlpha","rotateMatrix","type","unpackAlignment","wrapS","wrapT"].forEach((t=>s.data[t]=e[t])),this.getHelper(l).addObject("t",s,d).then((e=>n(e))).catch((e=>a(e)))}))}getTexture(e){return new Promise(((t,i)=>{let r=this.getDatabagIdAndKeyByUrl(e),{databagId:n,key:a}=r;this.getHelper(n).getObject("t",a).then((e=>{if(!["DataTexture","CompressedTexture"].includes(e.type)||!e.data)return void this.getHelper(n).deleteObject("t",a).then((e=>i(e)));let r=new THREE[e.type];Object.keys(e.data).forEach((t=>r[t]=e.data[t])),r.needsUpdate=!0,t(r)})).catch((e=>i(e)))}))}addBimtiles(e,t){return new Promise(((i,r)=>{let n=this.getDatabagIdAndKeyByUrl(t),{databagId:a,key:s}=n;this.getHelper(a).addObject("t",e,s).then((e=>i(e))).catch((e=>r(e)))}))}getBimtiles(e){return new Promise(((t,i)=>{let r=this.getDatabagIdAndKeyByUrl(e),{databagId:n,key:a}=r;this.getHelper(n).getObject("t",a).then((e=>{t(e)})).catch((e=>i(e)))}))}};r.Storage.SceneStorageManager=class{constructor(e){this.helper=new r.Storage.IndexedDBHelper({name:`Bg_${e.sceneId}`,storeList:["i",...e.databagIdList]}),r.storageManager=this}getStoreNameAndKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/resource\/v3\/model\/bimtiles\/(.+?)(\.gz)?$/.exec(e);return t?{storeName:t[1],key:t[2]}:{storeName:"i",key:e}}addTexture(e,t){const i=(e,t,i)=>{let r=this._canvas=this._canvas||document.createElement("canvas"),n=r.getContext("2d");return n.clearRect(0,0,r.width,r.height),r.width=t,r.height=i,n.drawImage(e,0,0,t,i),n.getImageData(0,0,t,i)};return new Promise(((r,n)=>{let a,s=this.getStoreNameAndKeyByUrl(t),{storeName:o,key:l}=s;a=e.image instanceof HTMLImageElement?{type:"Texture",data:{image:i(e.image,e.image.width,e.image.height)}}:{type:"CompressedTexture",data:{image:e.image}},["anisotropy","encoding","flipY","format","generateMipmaps","magFilter","mapping","minFilter","mipmaps","premultiplyAlpha","rotateMatrix","type","unpackAlignment","wrapS","wrapT"].forEach((t=>a.data[t]=e[t])),this.helper.addObject(o,a,l).then((e=>r(e))).catch((e=>n(e)))}))}getTexture(e){return new Promise(((t,i)=>{let r=this.getStoreNameAndKeyByUrl(e),{storeName:n,key:a}=r;this.helper.getObject(n,a).then((e=>{if(!["Texture","CompressedTexture"].includes(e.type)||!e.data)return void this.helper.deleteObject(n,a).then((e=>i(e)));let r=new THREE[e.type];Object.keys(e.data).forEach((t=>r[t]=e.data[t])),"Texture"===e.type&&(r.image=(e=>{let t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.putImageData(e,0,0),t})(e.data.image)),r.needsUpdate=!0,t(r)})).catch((e=>i(e)))}))}addBimtiles(e,t){return new Promise(((i,r)=>{let n=this.getStoreNameAndKeyByUrl(t),{storeName:a,key:s}=n;this.helper.addObject(a,e,s).then((e=>i(e))).catch((e=>r(e)))}))}getBimtiles(e){return new Promise(((t,i)=>{let r=this.getStoreNameAndKeyByUrl(e),{storeName:n,key:a}=r;this.helper.getObject(n,a).then((e=>{t(e)})).catch((e=>i(e)))}))}addInfoData(e,t){return this.addBimtiles(e,t)}getInfoData(e){return this.getBimtiles(e)}},(()=>{let e=new THREE.Vector3;r.ExplosionManager=class{constructor(e){this.modelManager=e,this.totalHeightMap={},this.explosionParamMap={},this.explodeCount=0,this.isElementExplodedMap={},this.isFloorExplodedMap={},this.modelExplosionCenterMap={}}destroy(){this.modelManager=null,this.totalHeightMap=null,this.explosionParamMap=null,this.isElementExplodedMap=null,this.isFloorExplodedMap=null}getExplosionParam(e){return this.explosionParamMap[e]||(this.explosionParamMap[e]={explosionExtent:0,floorExplosionExtent:0,floorExplosionList:[],floorInfos:void 0,floorExplosionDirection:void 0,boundingBox:new THREE.Box3}),this.explosionParamMap[e]}getExplosionExtent(e){if(e)return this.getExplosionParam(e).explosionExtent}setFloorInfos(t,i){if(i&&!this.getExplosionParam(i).floorInfos){for(var r=0,n=t.length;r<n;r++)t[r].explodedHeight=t[r].elevation,t[r].preExplodedHeight=t[r].elevation,t[r].preExplodedTranslation=null;this.getExplosionParam(i).floorInfos=t,this.totalHeightMap[i]={};const a=this.modelManager.getModel(i).getRawBoundingBox();this.totalHeightMap[i].totalHeight=a.getSize(e).z}}setExplosionCenter(t,i){const{position:r,type:n}=t;if(this.modelExplosionCenterMap[i]=void 0,"userDefined"===n)this.modelExplosionCenterMap[i]=new THREE.Vector3(r.x,r.y,r.z);else if("default"===n){this.modelManager.viewer.getFilter().getVisibleComponentsBbox().getCenter(e),this.modelExplosionCenterMap[i]=new THREE.Vector3(e.x,e.y,e.z)}}setExplosionExtent(t,i){if(!i)return;var n,a=t-this.getExplosionParam(i).explosionExtent;if(0==a)return;this.modelManager.modelCollection.traverse((e=>{var r=e.id,a=new THREE.Box3,s=r==i?t:this.getExplosionParam(r).explosionExtent;r==i?(e.modelExplosion.preElementExplode(a,s,this.modelExplosionCenterMap[i]),a.isEmpty()?a.copy(this.getExplosionParam(r).boundingBox):this.getExplosionParam(r).boundingBox.copy(a),0===s&&a.copy(e.getBoundingBoxWorld())):a=0===s?e.getBoundingBoxWorld():this.getExplosionParam(r).boundingBox,a&&(n?n.union(a):n=a)}));const s=this.modelManager.getModel(i),o=this.modelExplosionCenterMap[i]?this.modelExplosionCenterMap[i]:s.getBoundingBoxWorld().getCenter(e);let l=this.modelManager.modelCollection.getById("ExternalComponent");l&&l.elementExplode(s,a,o);let d=this.modelManager.modelCollection.getById("ExtrudeBodyManager");d&&d.elementExplode(s,t,o),this.explodeCount=1e4==this.explodeCount?0:this.explodeCount+1,this.isElementExplodedMap[i]=0!==t,this.modelManager.scene.setBoundingBoxWorld(n),this.modelManager.scene.setBoundingBoxWorldWithoutDEM(n),4!=r.GlobalData.LightPreset&&6!=r.GlobalData.LightPreset||this.modelManager.scene.lightManager.updateShadowLight(),r.GlobalData.EnableShadowMap&&this.modelManager.viewer.updateShadowMap(),this.modelManager.modelCollection.getById(i).modelExplosion.explode(),this.getExplosionParam(i).explosionExtent=t,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EXPLOSION,extent:t})}setFloorExplosion(e,t,i,n){if(!n)return;if(n=n.toString(),this.getExplosionParam(n).floorExplosionDirection=i,null==this.getExplosionParam(n).floorInfos)return;this.getExplosionParam(n).floorExplosionList=[];var a=!0,s={};if(t){for(var o=0,l=t.length;o<l;o++)s[t[o]]=!0;if(a=!1,0==t.length)return}for(var d=this.getExplosionParam(n).floorInfos,h=d.length,c=h>1?e*this.totalHeightMap[n].totalHeight/(h-1):0,u=0,p=0;p<h;p++){d[p].name;var m=d[p].elevation+u*c;(a||s[d[p].id])&&(u++,this.getExplosionParam(n).floorExplosionList.push(d[p].id)),d[p].preExplodedHeight=d[p].explodedHeight,d[p].explodedHeight=m,d[p].preExplodedDirection=d[p].explodedDirection,d[p].explodedDirection=i}let f=this.modelManager.modelCollection.getById("ExtrudeBodyManager");f&&f.explode(n);let g=this.modelManager.modelCollection.getById("ExternalComponent");const v=this.modelManager.getModel(n);var y;g&&g.explode(v),this.modelManager.modelCollection.traverse((e=>{var t=e.id.toString();const i=this.getExplosionParam(t).floorExplosionDirection;var r=new THREE.Box3,n=this.getExplosionParam(t).floorInfos;if(i&&n&&n.length>0){let t=(new THREE.Matrix4).copy(e.getTransformMatrix()).invert();const a=i.clone().applyMatrix4(t).sub(new THREE.Vector3(0,0,0).applyMatrix4(t));e.modelExplosion.preFloorExplode(r,n,a),r&&(y?y.union(r):y=r)}else r=e.getBoundingBoxWorld(),y?y.union(r):y=r})),this.explodeCount=1e4==this.explodeCount?0:this.explodeCount+1,this.isFloorExplodedMap[n]=0!==e,this.modelManager.scene.setBoundingBoxWorld(y),this.modelManager.scene.updateBoundingBoxWorldWithoutDEM(y),this.modelManager.getFilter().needUpdateBoxAfterExplode(),this.modelManager.modelCollection.getById(n).modelExplosion.explode(),4!=r.GlobalData.LightPreset&&6!=r.GlobalData.LightPreset||this.modelManager.scene.lightManager.updateShadowLight(),r.GlobalData.EnableShadowMap&&this.modelManager.viewer.updateShadowMap(),this.getExplosionParam(n).floorExplosionExtent=e,0===e&&(this.getExplosionParam(n).floorExplosionList=[]),this.modelManager.dispatchEvent({type:r.EVENTS.ON_FLOOR_EXPLOSION,floorInfos:d,modelId:n})}getFloorInfos(e){if(e)return this.getExplosionParam(e).floorInfos}getFloorExplosionList(e){if(e)return this.getExplosionParam(e).floorExplosionList}getFloorExplosionExtent(e){if(e)return this.getExplosionParam(e).floorExplosionExtent}getFloorExplosionDirection(e){if(e)return this.getExplosionParam(e).floorExplosionDirection}destroy(){delete this.explosionParamMap}isExploded(e){return this.isElementExplodedMap[e]||this.isFloorExplodedMap[e]}getExplosedTileBoundingBox(e,t){const i=this.modelManager.modelCollection.getById(e).modelExplosion;if(i)return i.getTileBoundingBoxByTileId(t)}}})(),r.BaseModelExplosion=class{constructor(e){this.model=e,this.explosionTranslation={}}destroy(){this.model=null,this.explosionTranslation=null}explode(){this.model.explode()}preFloorExplode(e,t,i){}preElementExplode(e,t,i){}getExplosionTranslationByObjId(e){}getLevelNameByObjId(e){}},r.ModelView=r.ModelView||{},function(){class e{constructor(e,t){this.manager=e,this.setValues(t),this.castShadow=!0,this.receiveShadow=!0,t.loadConfig&&(this.castShadow=!r.Utils.isDefined(t.loadConfig.castShadow)||t.loadConfig.castShadow,this.receiveShadow=!r.Utils.isDefined(t.loadConfig.receiveShadow)||t.loadConfig.receiveShadow),this.localClippingMode=!1,this.localClippingPlanes=null,this.innerClippingMode=!1,this.innerClippingMatrix=null,this.filter=null,this.visible=!0,this.loaded=!1,this.emptyScene=!1,this.statistics={renderableCount:0,renderableTotal:r.GlobalData.maxObjectNumInPool,renderableTotalForPool:r.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,numOfVertices:0,memoeryInfo:{maxMemorySize:0,minMemorySize:0,triangleNumber:0,instanceEnabled:r.GlobalData.Instance}},this.transformInfos={octreeTransformed:!1,boundingBox:new THREE.Box3,position:new THREE.Vector3,rotation:(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray([-1.5708,0,0]),!1),scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.containsCamera=!1,this.destroyed=!1,this.boundaryPoints=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.modelExplosion=new r.BaseModelExplosion(this),this.objectGroup=void 0}get sequence(){return this._sequence}set sequence(e){this._sequence=e}set config(e){this._config=e}get config(){return this._config}destroy(){this.destroyed=!0,this.statistics=null,this.transformInfos=null,this.transformMatrix=void 0,this.transformMatrixInverse=void 0,this._rawTransformMatrix=void 0,this.boundaryPoints=void 0,this._lengthUnitsMatrix=void 0,this.filter&&(this.filter.destroy(),this.filter=null),this.manager=null,this._config=void 0}setValues(e){this.id=e.modelId,this.databagId=this.id,this.fileId=e.fileId,this._sequence=e.priority,this._config=e.config,this._config&&this._config.metadata&&this._config.metadata.model_unit?this._unit="m"===this._config.metadata.model_unit?r.EnumLengthlUnits.Meter:r.EnumLengthlUnits.Millimeter:this._unit=this.getDefaultUnit(),this._lengthUnitsMatrix=void 0,this.transform={translation:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1)},this.transformMatrix=new THREE.Matrix4,this.transformMatrixInverse=new THREE.Matrix4,this._rawTransformMatrix=new THREE.Matrix4,this.setupTransformMatrix(e)}setupTransformMatrix(e){let t=e.loadConfig?e.loadConfig.transformMatrix:void 0;if(!t){let i=new THREE.Vector3,r=new THREE.Quaternion,n=new THREE.Vector3(1,1,1);e.loadConfig&&e.loadConfig.translation&&i.fromArray(e.loadConfig.translation),e.loadConfig&&e.loadConfig.rotation&&r.setFromEuler((new THREE.Euler).fromArray(e.loadConfig.rotation)),e.loadConfig&&e.loadConfig.scale&&n.fromArray(e.loadConfig.scale),t=(new THREE.Matrix4).compose(i,r,n)}this.setTransformMatrix(t)}calculateClippingIds(){}load(e){}prepare(e,t){}isEmptyScene(){return!1}isLayerData(){return!1}isLoaded(){return!0}isDataReady(){return!0}isVisible(){return this.visible}setVisible(e){this.visible=e}isUseable(){return this.isLoaded()&&this.isVisible()}isCulled(){return!0}getTransforms(){return this.transformInfos}getStatistics(){return this.statistics}getBoundingBoxWorld(){return this.getTransforms().boundingBox}getRawBoundingBox(){return this.getTransforms().boundingBox}applyFilter(){}applySelection(){}clearSelection(){}applyHover(){}clearHover(){}applyBlink(){}clearBlink(){}applyReplacement(){}getId(){return this.id}getDatabagId(){return this.databagId}getEncodedDatabagId(){return this.databagId}getOctreeRoots(e){}updateOctreeNode(e){}disposeBufferAfterVbo(){}setRenderableCount(e){}updateMeshNodes(){}getNodeInfosByUserId(e){return[]}getAllNodeInfos(){return{}}getMaterialByMaterialId(e){return null}updateMaterialsValue(e,t,i,r){}updateMaterials(){}switchNewStyleMaterial(e){}changeAllMaterials(e){}getImageByUrl(e){}getMeshesForCap(e,t){}getWireframeElementCount(){return 0}getCameraNameList(){return[]}getCamera(e){return null}calculateCameraModelRelation(e){this.containsCamera=!1}isUserIdExist(e){return!1}hasUserId(e){return!1}isHiddenUserId(e){return!1}hasTransforms(){return!0}explode(){}getFilter(){return this.filter}getModelManager(){return this.manager}isDestroyed(){return this.destroyed}getPickingMeshes(e,t,i,r,n){}getBlinkMaterials(){return[]}getLoadedUserIdsObject(){return null}dispatchEvent(e){}enableColorWithoutLight(e){}adjustVisibility(e){}changeVisibilityOfSelectedObjects(e){}changeVisibilityOfNonSelectedObjects(e){}adjustInstanceVisibility(e){}changeInstanceVisibilityOfSelectedObjects(e){}changeInstanceVisibilityOfNonSelectedObjects(e){}restoreVisibilityOfObjects(){}calculateClippingContours(){}preUpdate(){}update(){}postUpdate(){}getTransformMatrix(){return this.transformMatrix.clone()}getRawTransformMatrix(){return this._rawTransformMatrix.clone()}setTransformMatrix(e){this._rawTransformMatrix.copy(e),this.transformMatrix.copy(e),this.applyLengthUnitsMatrix(this.transformMatrix),this.transformMatrixInverse.copy(this.transformMatrix).invert(),e.decompose(this.transform.translation,this.transform.rotation,this.transform.scale)}rotateOnBasePoint(e,t,i){let r=this.transform.rotation.clone().clone().invert(),n=this.transform.translation.clone(),a=(new THREE.Quaternion).setFromAxisAngle(t,i);this.transform.rotation.multiply(a);let s=e.clone().sub(n).applyQuaternion(r).applyQuaternion(this.transform.rotation);this.transform.translation.sub(s).add(e.clone().sub(n)),this.updateTransformMatrix()}scaleOnBasePoint(e,t){this.transform.scale.multiply(t);let i=t.clone().sub(new THREE.Vector3(1,1,1)),r=this.transform.rotation.clone(),n=r.clone().invert(),a=this.transform.translation.clone(),s=e.clone().sub(a).applyQuaternion(n).multiply(i).applyQuaternion(r);this.transform.translation.sub(s),this.updateTransformMatrix()}translate(e){this.transform.translation.add(e),this.updateTransformMatrix(),this.updateMatrix(),this.manager.updateSceneBoundingBox()}updateMatrix(){}updateTransformMatrix(){let e=this.transform.translation,t=this.transform.scale,i=this.transform.rotation;this.transformMatrix.compose(e,i,t),this._rawTransformMatrix.copy(this.transformMatrix),this.applyLengthUnitsMatrix(this.transformMatrix),this.transformMatrixInverse.copy(this.transformMatrix).invert()}getBoundaryPoints(){let e=this.getRawBoundingBox();const t=this.getTransformMatrix(),i=this.boundaryPoints;return i[0].set(e.min.x,e.min.y,e.min.z).applyMatrix4(t),i[1].set(e.max.x,e.min.y,e.min.z).applyMatrix4(t),i[2].set(e.max.x,e.max.y,e.min.z).applyMatrix4(t),i[3].set(e.min.x,e.max.y,e.min.z).applyMatrix4(t),i[4].set(e.min.x,e.min.y,e.max.z).applyMatrix4(t),i[5].set(e.max.x,e.min.y,e.max.z).applyMatrix4(t),i[6].set(e.max.x,e.max.y,e.max.z).applyMatrix4(t),i[7].set(e.min.x,e.max.y,e.max.z).applyMatrix4(t),i}getGeometryBuffersByUserId(e){return this._handler?this._handler.getGeometryBuffersByUserId(e):[]}getRealUserId(e){return e}setCastShadow(e){this.castShadow=e}setReceiveShadow(e){this.receiveShadow=e}enableLocalClippingMode(e){this.localClippingMode=e}clone(t,i){i=r.Utils.defaultValue(i,{});const n=r.Utils.defaultValue(i.modelId,this.databagId);return r.Utils.defined(t)||(t=new e({modelId:n})),t}_copy(e){this.manager=e.manager,this.transform={translation:e.transform.translation.clone(),rotation:e.transform.rotation.clone(),scale:e.transform.scale.clone()},this.emptyScene=e.emptyScene,this.statistics=r.Utils.clone(e.statistics,!0),this.transformInfos={octreeTransformed:e.transformInfos.octreeTransformed,boundingBox:e.transformInfos.boundingBox.clone(),position:e.transformInfos.position.clone(),rotation:e.transformInfos.rotation.clone(),scale:e.transformInfos.scale.clone(),transformMatrix:e.transformInfos.transformMatrix.clone()},this._config=r.Utils.clone(e._config,!0),this._unit=e._unit,this._sequence=e._sequence,this.modelExplosion=new r.BaseModelExplosion(this)}isVisibleMesh(e){return!0}getDefaultUnit(){return r.EnumLengthlUnits.Meter}getUnit(){return this._unit}setLengthUnitsMatrix(e){e&&(this._lengthUnitsMatrix=e,this.updateTransformMatrix())}applyLengthUnitsMatrix(e){this._lengthUnitsMatrix&&e.multiply(this._lengthUnitsMatrix)}getLengthUnitsMatrix(){return this._lengthUnitsMatrix}getAllNodeGroups(){return this.objectGroup?this.objectGroup.children:[]}hideWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(this._isActiveNodeGroup(t))for(let i=0,r=e.length;i<r;i++)if(t.name===e[i]){t.visible=!1;break}}))}showWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(this._isActiveNodeGroup(t))for(let i=0,r=e.length;i<r;i++)if(t.name===e[i]){t.visible=!0;break}}))}hideExcludeWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(!this._isActiveNodeGroup(t))return;let i=!1;for(let r=0,n=e.length;r<n;r++)if(t.name===e[r]){i=!0;break}i||(t.visible=!1)}))}showExcludeWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(!this._isActiveNodeGroup(t))return;let i=!1;for(let r=0,n=e.length;r<n;r++)if(t.name===e[r]){i=!0;break}i||(t.visible=!0)}))}holdNodeGroupVisibility(){this.getAllNodeGroups().forEach((e=>{e._oriVisible=e.visible}))}resetNodeGroupVisibility(){this.getAllNodeGroups().forEach((e=>{e._oriVisible=void 0}))}_isActiveNodeGroup(e){return!!e._oriVisible}getAllWireframeGroupNames(){return[]}collectBlinkedMaterial(e,t){}getAllUserIds(){return[]}processBimtileUnit(e,t=1){if(this.manager.isBimtilesAsset()&&this.getUnit()!==r.EnumLengthlUnits.Meter){let i=Number(e);if(!isNaN(i))return e*Math.pow(.001,t);if(e instanceof THREE.Vector3||e instanceof THREE.Vector2)return e.clone().multiplyScalar(Math.pow(.001,t))}return e}getObjectGroup(){return this.objectGroup}}r.BaseModel=e}(),r.TaskWorker=function(e,t){this.MaxThreadCount=e||8;var i=this;i.todoList={},i.todoCount=0,i.doingCount=0,this.hasTask=function(){return i.todoCount>0},this.addItem=function(e,t){i.todoList[e]=t,i.todoCount++},this.clearTasks=function(){i.todoList={},i.todoCount=0},this.run=function(e,i){var n=this;if(!(n.doingCount>0)){var a=[],s=n.todoList;for(var o in s)s.hasOwnProperty(o)&&a.push(o);n.todoList={},n.todoCount=0;var l=a.length;if(0!==l){i&&a.sort(i);var d=Math.min(this.MaxThreadCount,r.GlobalData.ConcurrencyRequestCount,l);n.doingCount=l;for(var h=0;h<d;++h)c(h)}}function c(i){if(i>=l)n.doingCount<1&&t();else{var r=a[i];e(r,i+d,c)}}}},r.TaskWorker2=function(e){this.MaxThreadCount=e||8,this.todoList=[],this.doingCount=0,this.addItem=function(e){void 0!==e&&this.todoList.push(e)},this.run=function(e,t,i){if(!(this.doingCount>0))if(0!==this.todoList.length){var n=this.todoList,a=n.length;this.todoList=[],this.doingCount=a;for(var s=Math.min(this.MaxThreadCount,r.GlobalData.ConcurrencyRequestCount,a),o=this,l=0;l<s;++l)d(l)}else i();function d(r){r>=a?o.doingCount<1&&(t(o.doingCount,a),i()):(t(o.doingCount,a),e(n[r],r+s,d))}}},r.TaskManager=function(){this.worker=new r.TaskWorker2(8)},r.TaskManager.prototype={constructor:r.TaskManager,addTask:function(e){this.worker.addItem(e)},processTasks:function(e,t,i){t=t||function(){},i=i||function(){};var r=this.worker;this.worker.run((function(t,i,n){e(t,(function(){--r.doingCount,n(i)}))}),t,i)}},function(){function e(e,t,i){if(!t.receiveIBL)return null;var n,a=r.MaterialUtil.getMaterialParameters(t);return""!=t.defines.USE_INSTANCE&&""!=t.defines.USE_INSTANCE_NORMAL||(a.defines=t.defines),i?(delete a.textureColor,delete a.pureColor,delete a.imageFade,a.lights=!0,(n=new H.IBLMaterial(a)).type="IBL",n.refreshUniforms()):(delete a.iblProbe,a.lights=!e.lightmap,(n=r.MaterialUtil.createStandardMaterial(a)).roughness=a.originRoughness,n.metalness=a.originMetalness,n.refreshUniforms()),n.name=t.name,n._primary=t._primary,n.overrideColor=t.overrideColor,a=null,n}r.MaterialManager=class{constructor(e){this.instanceMaterials={},this.materials={},this.textures={},this.lightmaps={},this.ensureImagePowerOfTwo=!1,this.handlerUrl=null,this.textureLoader=null,this.textureManager=new r.TaskManager,this.enableCompressedTexture=!1,this.enableSmallTexture=!1,this.enablePkgTexture=!1,this.enableTexturePkgGz=!0,this.enableOrgTexture=!1,this.enableDdsTexture=!1,this.texturePkgLoadState=void 0,this.textureCount=0,this.pkgTextureMap={},this.pkgTextureArrayBufferMap={},this.texturePkgMap={},this.delayLoadTexture=!1,this.delayMaxCount=50,this.pkgCount=0,this.pkgLoadedCount=0,this.pkgLoadedParseCount=10,this.taskRunner=new r.LoadTaskRunner(5),this.delayLoadedTextureMap={},this.parsedMaterialMap={},this.textureNameMap={},this.basisTextureLoader=r.MaterialUtil.getBasisTextureLoader(),this.viewer=e,this.alphaMapArray=[],this.materialParams={}}destroy(){this.instanceMaterials=null,this.materials=null,this.textures=null,this.lightmaps=null,this.textureCount=void 0,this.handlerUrl=null,this.textureLoader=null,this.textureConfig=null,this.textureManager=null,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null,this.texturePkgMap=null,this.delayLoadTexture=void 0,this.delayMaxCount=void 0,this.pkgCount=void 0,this.pkgLoadedCount=void 0,this.taskRunner=null,this.textureNameMap=null,this.alphaMapArray=null,this.parsedMaterialMap=null,this.basisTextureLoader.dispose(),this.basisTextureLoader=null,this.viewer=null}disposeInstanceMaterials(e){var t=this.instanceMaterials;for(var i in t){var r=t[i];if(r instanceof Array)for(var n=0,a=r.length;n<a;n++)r[n].dispose();else r.dispose()}}disposeMaterials(e){for(var t in this.materials)this.materials[t].dispose();this.disposeInstanceMaterials(e)}updateMaterialsValue(e,t,i,r){let n=(e,t,i,r)=>{e&&e.hasOwnProperty(t)&&(r&&0==e.receiveIBL||(e[t]=i,void 0!==e.refreshUniforms&&e.refreshUniforms(),e.needsUpdate=!0))},a=this.materials;for(const e in a){let s=a[e];n(s,t,i,r)}let s=this.instanceMaterials;for(const e in s){let a=s[e];if(a instanceof Array)for(let e=0,s=a.length;e<s;e++)n(a[e],t,i,r);else n(a,t,i,r)}e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).map((e=>{n(e,t,i,r)}))}enableColorWithoutLight(e){var t,i=this.materials,r=this.instanceMaterials;if(e){for(var n in i)(t=i[n])&&(t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0);for(var n in r)if(t=r[n])if(t instanceof Array)for(var a=0,s=t.length;a<s;a++)t[a].defines.USE_COLORWITHOUTLIGHT="",t[a].needsUpdate=!0;else t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0}else{for(var n in i)(t=i[n])&&(delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0);for(var n in r)if(t=r[n])if(t instanceof Array)for(a=0,s=t.length;a<s;a++)delete t[a].defines.USE_COLORWITHOUTLIGHT,t[a].needsUpdate=!0;else delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0}}_onLoadTexture(e){this.textureCount--,this.textureCount<=0&&e&&e()}_loadTextureByCrypto(e,t,i,n){let a=null,s=THREE.DefaultLoadingManager.getHandler(e);if(null!==s)a=s.load(e,t);else{a=new THREE.Texture,a.src=e;const i=e.lastIndexOf("/"),o=e.substring(i+1);if(this.textureNameMap[o]=a,this.enablePkgTexture&&o in this.pkgTextureMap){const e=new THREE.FileLoader;e.setResponseType("arraybuffer");const i=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[o].pkg,this.pkgTextureMap[o].type),s=this.handlerUrl.textureUrl(i),l=this.pkgTextureMap[o].offset,d=this.pkgTextureMap[o].length;if(i in this.pkgTextureArrayBufferMap){const e=this.pkgTextureArrayBufferMap[i].slice(l,l+d);this.creatTextureImage(a,e,t,n)}else e.load(s,(e=>{this.pkgTextureArrayBufferMap[i]=e;const r=e.slice(l,l+d);this.creatTextureImage(a,r,t,n)}),(e=>{void 0!==n&&n(e)}))}else{const i=i=>{const n=new Blob([i],{type:"jpeg"});let s=new Image;s.onload=function(){a.image=r.MaterialUtil.ensurePowerOfTwo(s),a.needsUpdate=!0,t&&t(a)},s.onerror=i=>{console.log(`${e} load failed`),t(a)},s.src=URL.createObjectURL(n)},o=e=>{void 0!==n&&n(e)},l=()=>new Promise(((t,i)=>{s=new TEST.CryptoResourceLoader,s.loadURL(e,t,i)}));r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,l,i,o)}}return a}_loadCompressedTexture(e,t,i,n){const a=(e=e.substring(0,e.lastIndexOf("."))+".dds").lastIndexOf("/"),s=e.substring(a+1),o=new THREE.DDSLoader;if(this.enableDdsTexture&&s in this.pkgTextureMap){const e=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[s].pkg,this.pkgTextureMap[s].type),i=(this.handlerUrl.textureUrl(e),this.pkgTextureMap[s].offset),n=this.pkgTextureMap[s].length,a=this.pkgTextureArrayBufferMap[e].slice(i,i+n);o.loadBuffer(a,t)}else o.load(e,t,i,(e=>{void 0!==n&&n(e)}))}_loadBasisTexture(e,t,i,n){const a=(e=e.substring(0,e.lastIndexOf("."))+".basis").lastIndexOf("/"),s=e.substring(a+1),o=this.basisTextureLoader;if(o.detectedSupport||o.detectSupport(this.viewer.getRenderer()),s in this.pkgTextureMap){const e=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[s].pkg,this.pkgTextureMap[s].type),i=(this.handlerUrl.textureUrl(e),this.pkgTextureMap[s].offset),a=this.pkgTextureMap[s].length,l=this.pkgTextureArrayBufferMap[e].slice(i,i+a);o.loadFromBuffer(l,t,n)}else o.load(e,t,i,(e=>{void 0!==n&&n(e)}))}creatTextureImage(e,t,i,n){var a=new TEST.CryptoResourceLoader;try{a.load(t,(t=>{const a=new Blob([t],{type:"jpeg"});let s=new Image;s.onload=()=>{e.image=r.MaterialUtil.ensurePowerOfTwo(s),e.needsUpdate=!0,i&&i(e)},s.onerror=e=>{n&&n(e)},s.src=URL.createObjectURL(a)}))}catch(t){console.warn("invalid texture"),i&&i(e)}}_parseTextureJson(e,t,i,n){let a=[];const s=window.TEST||{},o=i.type,l=i.data;let d=t.textureUrl(l.sourceFile);const h=this.enableSmallTexture&&l.texture_small;if(this.textureLoader=null,l.basis)this.textureLoader=this._loadBasisTexture;else if(!h&&this.enableCompressedTexture&&l.dds)this.textureLoader=this._loadCompressedTexture;else if(s.CryptoResourceLoader&&(this.textureLoader=this._loadTextureByCrypto),h){const e=d.lastIndexOf(".");d=d.substring(0,e)+"_s"+d.substring(e)}this.textures[e.name]=a,this.textureLoader(d,(t=>{t.encoding=THREE.GammaEncoding,t.repeat.fromArray([l.scale[0],l.scale[1]]),t.offset.fromArray([l.offset[0],l.offset[1]]),t.rotation=THREE.Math.degToRad(l.angle),r.MaterialUtil.updateUVMatrix(t),l.repeatU&&(t.wrapS=THREE.RepeatWrapping),l.repeatV&&(t.wrapT=THREE.RepeatWrapping),t.texturetype=o,"reliefMap"==o&&(t.texturetype="bumpMap"),l.dataType&&"NormalMap"==l.dataType&&(t.texturetype="normalMap"),l.alpha&&"map"==o&&(t.texturetype="alphaMap"),null!=l.depth&&(t.depth=l.depth),t&&a.push(t),this._updateMaterialTexture(e,a),this._onLoadTexture(n)}),void 0,(()=>{this._updateMaterialTexture(e,a),this._onLoadTexture(n)}))}setPolygonClimpGroundInfo(e){if(e)for(const t in this.materials){const i=this.materials[t];i.updatePolygonClimpGroundInfo&&(i.updatePolygonClimpGroundInfo(e),i.needsUpdate=!0)}}closePolygonClimpGround(){for(const e in this.materials){const t=this.materials[e];t.closePolygonClimpGround&&(t.closePolygonClimpGround(),t.needsUpdate=!0)}}_updateMaterialTexture(e,t){if(t){if(void 0===t.length)e.map=t;else for(var i=0;i<t.length;i++){switch(!this.ensureImagePowerOfTwo&&t[i].image&&(t[i]instanceof THREE.CompressedTexture?THREE.Math.isPowerOfTwo(t[i].image.width)&&THREE.Math.isPowerOfTwo(t[i].image.height)||console.log("Warning: THREE.CompressedTexture is not power of two."):t[i].image=r.MaterialUtil.ensurePowerOfTwo(t[i].image)),t[i].texturetype){case"map":e.map=t[i];break;case"bumpMap":e.bumpMap=t[i],null!=t[i].depth&&(e.bumpScale=t[i].depth,e.bumpUvTransform=t[i].matrix);break;case"specularMap":e.specularMap=t[i];break;case"alphaMap":e.useAlphaMap=!0,e.alphaTest=.01,e.map=t[i],this._initAlphaMapProperty(e),this.alphaMapArray.push(e);break;case"emissiveMap":e.emissiveMap=t[i];break;case"environmentMap":e.envMap=t[i];break;case"normalMap":e.normalMap=t[i],t[i].depth&&e.normalScale.set(t[i].depth,t[i].depth);break;default:console.warn("This map type is not supported yet:",t[i].texturetype)}t[i].wrapS!=THREE.RepeatWrapping&&(e.useClampToBorder=!0)}e.refreshUniforms(),e.needsUpdate=!0}else e.textureColor&&e.color.setStyle(e.textureColor),e.needsUpdate=!0}updateTexturePkgMapping(e,t){!0===this.texturePkgLoadState&&(this._updateTextureMapping(e,t),t&&t()),void 0===this.texturePkgLoadState&&(this.texturePkgLoadState=!1,this._getPgkTexture((()=>{!0!==this.delayLoadTexture?(this.lastTextureEnabled=!1,this._updateTextureMapping(e,t),t&&t()):t&&t()})))}delayUpdateTexturePkgMapping(e,t){if(!1===this.delayLoadTexture)return void(t&&t());const i=new THREE.FileLoader;i.setResponseType("arraybuffer");for(let n=0;n<this.pkgCount;++n){const a=this.pkgTextureArrayBufferMap[n],s=this.handlerUrl.textureUrl(a);this.taskRunner.push(i,s,(i=>{this.pkgLoadedCount++,this.pkgTextureArrayBufferMap[a]=i;this.texturePkgMap[n].map((e=>{this.delayLoadedTextureMap[e]=!0})),this.pkgLoadedCount%this.pkgLoadedParseCount!=this.pkgLoadedParseCount-1&&this.pkgLoadedCount!==this.pkgCount||(this.lastTextureEnabled=!1,r.GlobalData.EnableTextureMapping=!0,this._updateTextureMapping(e,t))}))}}_parseMapTexture(e,t,i,r){for(let n=0,a=i.length;n<a;n++)this.textureCount++,this._parseTextureJson(e,t,i[n],r)}_createTextureMap(e){this.textures;const t=this.materials;let i=this.handlerUrl,n=this.textureDataArray;this.textureCount=0;for(const a in t){let s=t[a];if(s){const t=r.Utils.splitCombinedKeyString(a,"_")[0];let o=n[parseInt(t)];o&&this._parseMapTexture(s,i,o,e)}}}_updateTextureMapping(e,t){let i=r.GlobalData.EnableTextureMapping;this.ensureImagePowerOfTwo;if(this.lastTextureEnabled!==i){var n=this.textures,a=this.materials;let v=this.handlerUrl,y=this.textureDataArray;if(e)var s=e.manager.getMaterialOverrideSet(),o=s?s.materialsByName:null,l=s?s.textures:null;var d=this.instanceMaterials;let M=e=>{const t=e.data;let i=t.sourceFile;if(!0===t.basis){const e=i.lastIndexOf(".");return i=i.substring(0,e)+".basis",i}if(this.enableSmallTexture&&t.texture_small){const e=i.lastIndexOf(".");i=i.substring(0,e)+"_s"+i.substring(e)}return i};var h,c;if(i){for(h in this.textureCount=0,a)if(c=a[h]){var u=n[p=r.Utils.splitCombinedKeyString(h,"_")[0]];let e=y?y[parseInt(p)]:null;if(e&&this.delayLoadTexture){let i=!0;const r=e.length;for(let t=0;t<r;++t){const r=M(e[t]);i=i&&this.delayLoadedTextureMap[r]}i&&!this.parsedMaterialMap[p]&&(this.parsedMaterialMap[p]=!0,this._parseMapTexture(c,v,e,t));continue}if(!this.delayLoadTexture||this.delayLoadTexture&&!e||!0!==this.texturePkgLoadState){this._updateMaterialTexture(c,u);continue}}for(h in d)if(c=d[h]){u=n[p=r.Utils.splitCombinedKeyString(h,"_")[0]];var p,m=p.split("#")[0];if(l&&l[m]&&(u=l[m]),c instanceof Array)for(var f=0,g=c.length;f<g;f++)this._updateMaterialTexture(c[f],u);else this._updateMaterialTexture(c,u)}for(h in o)if(c=o[h]){u=l[m=h.split("#")[0]];this._updateMaterialTexture(c,u)}this.ensureImagePowerOfTwo=!0}else{for(h in a)(c=a[h])&&(c.map=null,c.needsUpdate=!0);for(h in d)if(c=d[h])if(c instanceof Array)for(f=0,g=c.length;f<g;f++)c[f].pureColor&&(c[f].color.setStyle(c[f].pureColor),c[f].map=null,c[f].needsUpdate=!0),c[f].map=null,c[f].needsUpdate=!0;else c.pureColor&&(c.color.setStyle(c.pureColor),c.map=null,c.needsUpdate=!0),c.map=null,c.needsUpdate=!0;for(h in o)(c=o[h])&&(c.map=null,c.needsUpdate=!0,c.pureColor&&c.color.setStyle(c.pureColor))}this.lastTextureEnabled=i}}updateMaterials(e){this._updateBasicMaterialsForIBL(e),this._updateInstanceMaterialsForIBL(e),this._updateFilterMaterialsForIBL(e)}_updateBasicMaterialsForIBL(e){const t=this.materials,i=Object.keys(t),r=e.manager.scene.IBLMaps;i.forEach((e=>{const i=t[e];i.IBLMaps=r,i.refreshUniforms()}))}_updateInstanceMaterialsForIBL(e){const t=this.instanceMaterials,i=Object.keys(t),r=e.manager.scene.IBLMaps;i.forEach((e=>{const i=t[e];i instanceof Array?i.forEach((e=>{e.IBLMaps=r,e.refreshUniforms()})):(i.IBLMaps=r,i.refreshUniforms())}))}_updateFilterMaterialsForIBL(e){const t=e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}),i=e.manager.scene.IBLMaps;t.forEach((e=>{e.IBLMaps=i,e.refreshUniforms()}))}_updateIBL(e){if(r.GlobalData.IBL){this.updateMaterials(e);var t=e.manager.viewer.getIBLManager().IBLParams;for(var i in t)this.updateMaterialsValue(e,i,t[i])}}_changeBasicMaterials(t,i){const r=this.materials;Object.keys(r).forEach((n=>{const a=r[n],s=e(t,a,i);s&&(r[n]=s)}))}_changeInstanceMaterials(t,i){const r=this.instanceMaterials;Object.keys(r).forEach((n=>{const a=r[n];if(a instanceof Array)a.forEach(((r,n)=>{const s=e(t,r,i);s&&(a[n]=s)}));else{const s=e(t,a,i);s&&(r[n]=s)}}))}_changeFilterMaterials(t,i){const r=t.filter.materialSelector.getAll();t.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).forEach((n=>{const a=e(t,n,i);a&&(r[n.name]=a)}))}changeAllMaterials(e,t){this._changeBasicMaterials(e,t),this._changeInstanceMaterials(e,t),this._changeFilterMaterials(e,t)}_switchNewStyleBasicMaterials(e,t){const i=this.materials;Object.keys(i).forEach((e=>{const n=i[e],a=r.MaterialUtil.getMaterialParameters(n),s=t?r.MaterialUtil.createNewStyleMaterial(a):r.MaterialUtil.createStandardMaterial(a);s.name=e,i[e]=s}))}_switchNewStyleInstanceMaterials(e,t){const i=this.instanceMaterials;Object.keys(i).forEach((e=>{const n=i[e];if(n instanceof Array)n.forEach(((e,i)=>{const a=r.MaterialUtil.getMaterialParameters(e),s=t?r.MaterialUtil.createNewStyleMaterial(a):r.MaterialUtil.createStandardMaterial(a);s.name=i,n[i]=s}));else{const a=r.MaterialUtil.getMaterialParameters(n),s=t?r.MaterialUtil.createNewStyleMaterial(a):r.MaterialUtil.createStandardMaterial(a);s.name=e,i[e]=s}}))}_switchNewStyleFilterMaterials(e,t){const i=e.filter.materialSelector.getAll();e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).forEach((e=>{const n=r.MaterialUtil.getMaterialParameters(e),a=t?r.MaterialUtil.createNewStyleMaterial(n):r.MaterialUtil.createStandardMaterial(n);a.name=e.name,i[e.name]=a}))}switchNewStyleMaterial(e,t){this._switchNewStyleBasicMaterials(e,t),this._switchNewStyleInstanceMaterials(e,t),this._switchNewStyleFilterMaterials(e,t)}updateLightmapMaterial(e){if(!this.materials[e]){var t=this.materials,i=r.Utils.splitCombinedKeyString(e,"_"),n=i[0],a=i[1];if(a){var s=r.MaterialUtil.getMaterialParameters(t[n]);s.lights=!1;var o=this.lightmaps[a];s.lightMap=o,s.lightMapIntensity=r.GlobalData.LightmapIntensity,this.materials[e]=r.MaterialUtil.createStandardMaterial(s)}}}getInstanceMaterialById(e,t){if(this.instanceMaterials[e])return this.instanceMaterials[e];var i=r.Utils.splitCombinedKeyString(e,"_"),n=i[0],a=i[1],s=r.MaterialUtil.getMaterialParameters(t.manager.getOverrideMaterialByName(n)||this.getMaterialById(n)),o=s.transparent;if(t.lightmap&&a){s.lights=!1;var l=this.lightmaps[a];s.lightMap=l,s.lightMapIntensity=r.GlobalData.LightmapIntensity}var d=r.MaterialUtil.createInstanceMaterial(s,!0);d.transparent=!1,d.name=e;var h=r.MaterialUtil.createInstanceMaterial(s,!0);return h.transparent=!0,h.name=e,r.GlobalData.TranslucentDepthDisabled&&(h.depthWrite=!1),o===d.transparent?d._primary=!0:h._primary=!0,void 0===this.materials[e]&&(this.materials[e]=r.MaterialUtil.createStandardMaterial(s)),this.instanceMaterials[e]=[d,h],this.instanceMaterials[e]}getMaterialById(e){return this.materials[e]||r.MaterialUtil.getDefaultStandardMaterial()}_loadFileByPromise(e,t){let i=new THREE.FileLoader;return new Promise((function(n,a){r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,(()=>new Promise(((r,n)=>{i.setResponseType(t),i.load(e,r)}))),(e=>{"string"==typeof e?n(JSON.parse(e)):null==e.metadata?a(e):n(e)}))}))}_loadTexturePkgByIndex(e,t){const i=this.pkgTextureArrayBufferMap[e],n=this.handlerUrl.textureUrl(i),a=new THREE.FileLoader;r.Storage.IndexedDBHelper.loadWithStorage("ModelData",n,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(n,e,void 0,t)}))),(e=>{this.pkgTextureArrayBufferMap[i]=e,t()}))}_getPgkTexture(e){if(!this.enablePkgTexture)return this._createTextureMap(e),void(this.texturePkgLoadState=!0);const t=this.handlerUrl;let i=[];this.pkgTextureMap={},this.texturePkgMap={};const n=1==this.enableTexturePkgGz?"gzip":"json",a=".gz"==r.GlobalData.ZipResourcePostfix?"gzip":"json";r.Compatibility.useMergeTexturePkg?i.push(this._loadFileByPromise(t.texturePkgIndexUrl(this.enableTexturePkgGz),n)):(this.enableOrgTexture&&i.push(this._loadFileByPromise(t.texturePkgOrgIndexUrl(),a)),this.enableSmallTexture&&i.push(this._loadFileByPromise(t.texturePkgSmallIndexUrl(),a))),Promise.all(i.map((e=>e.catch((e=>e))))).then((t=>{let i=0;for(const e in t)for(const n in t[e].textures){this.pkgTextureMap[n]=t[e].textures[n],null==this.pkgTextureMap[n].type&&(this.pkgTextureMap[n].type=t[e].metadata.type);const a=this.pkgTextureMap[n].pkg;void 0===this.texturePkgMap[a]?this.texturePkgMap[a]=[n]:this.texturePkgMap[a].push(n);const s=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,t[e].textures[n].pkg,t[e].metadata.type);s in this.pkgTextureArrayBufferMap||(this.pkgTextureArrayBufferMap[i]=s,this.pkgTextureArrayBufferMap[s]={},this.textureManager.addTask(i),i++)}if(this.pkgCount=i,i>this.delayMaxCount)return this.delayLoadTexture=!0,void(e&&e());this.textureManager.processTasks(this._loadTexturePkgByIndex.bind(this),void 0,(()=>{this.texturePkgLoadState=!0,this._createTextureMap(e)}))})).catch((function(e){console.log("promise reject failed reason",e)}))}getImageByUrl(e){const t=e.lastIndexOf("/"),i=e.substring(t+1),r=this.textureNameMap[i];return r&&r.image}_initAlphaMapProperty(e){e.forInstance||(e.transparent=e.opacity<1),e._transparent=e.transparent,e._transparent||(e.transparent=!1,e.blending=THREE.CustomBlending,e.blendSrc=THREE.SrcAlphaFactor,e.blendDst=THREE.OneMinusSrcAlphaFactor,e.blendSrcAlpha=THREE.OneFactor,e.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.priorityOrderId=1)}updateAlphaMapProperties(e){const t=e?THREE.NormalBlending:THREE.CustomBlending,i=!!e,r=e?0:1;this.alphaMapArray.forEach((e=>{e._transparent||(e.transparent=i,e.blending=t,e.blendSrc=THREE.SrcAlphaFactor,e.blendDst=THREE.OneMinusSrcAlphaFactor,e.blendSrcAlpha=THREE.OneFactor,e.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.priorityOrderId=r)}))}getBackMaterials(){if(this.backMaterials)return this.backMaterials;let e={},t=this.materials;for(const i in t){let r=t[i].clone();r.transparent=!1,r.useForCap=!0,r.uniforms.useForCap.value=!0,r.side=THREE.BackSide,r.shift=.5,r.uniforms.shift.value=.5,e[i]=r}let i=this.instanceMaterials,r={};for(const e in i){let t=i[e][0].clone();t.transparent=!1,t.useForCap=!0,t.uniforms.useForCap.value=!0,t.side=THREE.BackSide,t.shift=.5,t.uniforms.shift.value=.5,r[e]=t}return this.backMaterials={batchMaterials:e,instanceMaterials:r},this.backMaterials}storeMaterialParam(e){this.materialParams[e.name]||(this.materialParams[e.name]={color:e.color.clone(),opacity:e.opacity,transparent:e.transparent,map:e.map})}restoreMaterialParam(e){let t=this.materialParams[e.name];t&&(e.color.setRGB(t.color.r,t.color.g,t.color.b),e.opacity=t.opacity,e.transparent=t.transparent,e.map=t.map,e.needsUpdate=!0)}}}(),r.SourceObjectManager=class{constructor(){this.hiddenUserIdMap={}}destroy(){this.hiddenUserIdMap=null}hideByUserId(e,t,i){this.hiddenUserIdMap||(this.hiddenUserIdMap={}),this.hiddenUserIdMap[i]||(this.hiddenUserIdMap[i]={}),this.hiddenUserIdMap[i][e]=!!t}cancelHiddenByUserId(e){if(this.hiddenUserIdMap)for(const t in this.hiddenUserIdMap)delete this.hiddenUserIdMap[t][e]}cancelAllHidden(){this.hiddenUserIdMap=null}isHidden(e,t){if(!this.hiddenUserIdMap)return!1;if(t)return!!this.hiddenUserIdMap[t]&&this.hiddenUserIdMap[t][e];for(const t in this.hiddenUserIdMap)if(this.hiddenUserIdMap[t][e])return!0;return!1}hasHidden(){return!r.Utils.isEmptyObject(this.hiddenUserIdMap)}},function(){class e extends THREE.EventDispatcher{constructor(e){super(),r.GlobalData.IsMobile&&(r.GlobalData.maxObjectNumInPool=6e3,r.GlobalData.maxDrawCacheNum=4e3),this.viewer=e,this.scene=new r.Scene({gisMode:e.gisMode}),this.filterHelper=new r.ModelView.FilterHelper(this),this.filter=new r.ModelView.FilterDirector(this),this.interactionScene=new THREE.Scene,this.crossOrigin=!0,this.loadingModels={},this.materialPool=null,this.occlusionCamera=null,this.containsCamera=!1,this.highPriorityCategories={inner:{},outer:{}},this.octantToObjectMap={},this.sceneState=new r.SceneStateHelper(this),this.rotation=new THREE.Quaternion,this.boundingBox=new THREE.Box3,this.boundingBoxLast=void 0,this.IBLMaterial=!1,this.selectPriority=!0,this.materialOverrideSet=null,this._renderStateChanged=!1,this.explosionManager=new r.ExplosionManager(this),this.isDrawableModel=!1,this.filterApplied=!1,this.modelLoader=new r.ModelLoader,this.modelCollection=new r.ModelView.LayerCollection,this.blinkManager=new r.BlinkManager(this),this.rootMatrix=void 0,this.rootMatrixLast=void 0,this.firstLoadedBmdLayer=void 0,this.demLoaded=!1,this.tilesCacheScheduler=new r.TilesCacheScheduler({maximumMemoryUsage:e._options.maxMemoryUsage}),this._unifiedLengthUnits=r.GlobalData.SceneUnit,this._firstModelLoaded=!1,this.scratchVector=new THREE.Vector3,this.scratchBoundingBox=new THREE.Box3}destroy(){this.removeAllEventListener(),this.modelCollection.destroy(),this.blinkManager.destroy(),this.modelCollection=null,this.octantToObjectMap=null,this.materialPool&&(this.materialPool.destroy(),this.materialPool=null),this.occlusionCamera&&(this.occlusionCamera=null),this.loadOnDemandDirector&&(this.loadOnDemandDirector.destroy(),this.loadOnDemandDirector=null),this.highPriorityCategories=null,this.rotation=null,this.boundingBox=null,this.boundingBoxLast=void 0,this.scene.destroy(),this.scene=null,this.interactionScene=null,this.filter.destroy(),this.filter=null,this.sceneState.destroy(),this.sceneState=null,this.filterHelper.destroy(),this.filterHelper=null,this.explosionManager.destroy(),this.explosionManager=null,this.rootMatrix=void 0,this.rootMatrixLast=void 0,this.tilesCacheScheduler.destroy(),this.tilesCacheScheduler=void 0,this.viewer=void 0}getFilter(){return this.filter}getFilterHelper(){return this.filterHelper}removeAllEventListener(){this._listeners=void 0}_updateOcclusionCamera(e){var t=e.near,i=e.distanceFromWorldToDrawing(this.getMatrixWorldGlobal(),r.GlobalData.OcclusionDistanceToCamera);this.occlusionCamera?this.occlusionCamera.copy(e):this.occlusionCamera=e.clone(),this.occlusionCamera.setNearFar(t,i),this.occlusionCamera.updateMVP()}_clearMaterialPool(){this.materialPool&&this.materialPool.clear()}acquireMaterial(){return this.materialPool?this.materialPool.acquire():null}getObjectPool(){return this.scene.getObjectPool()}getFrustumFromOcclusionCamera(){return this.occlusionCamera.getFrustum(!1)}getOcclusionCamera(){return this.occlusionCamera}prepareScene(e,t){r.GlobalData.BatchMergeEnabled||(this.clearPool(),this.clearObjectRangeFromOctantMap()),r.GlobalData.OcclusionTranslucentEnabled&&(null==this.materialPool&&(this.materialPool=new r.ExpandableObjectPool,this.materialPool.init(r.MaterialEx,50)),this._clearMaterialPool(),this._updateOcclusionCamera(e)),this.modelCollection.traverse((i=>{i.isLoaded()&&!i.isEmptyScene()&&i.prepare(e,t)})),this.dealStateChanged()}clearPool(){this.scene.getObjectPool().clear()}clearObjectRangeFromOctantMap(){this.octantToObjectMap&&this.octantToObjectMap.pool&&(this.octantToObjectMap.pool={})}setDrawableModel(e){this.isDrawableModel=e}isDrawable(){return this.isDrawableModel}load(e,t,i){const n=this._preLoad(e);return r.Utils.isDefined(n)?(this._loadModels(n,t,i),n.modelId):null}_preLoad(e){let t=e.modelId;const i=r.Utils.clone(e,!0);if(i.notifyProgress=void 0===e.notifyProgress||e.notifyProgress,r.Utils.isDefined(t)){t=`${t}`;const e=this.modelCollection.getById(t);if(r.Utils.isDefined(e))return this.setDrawableModel(!0),e.isVisible()||(e.setVisible(!0),e.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t})),console.log(`[BIMFACE ERROR]: Failed to load model with id ${t}, a model with the same ID already exists`),null}else{t=e.modelFileId,t=r.Utils.isDefined(t)?`${t}`:r.Utils.getEncodedString(e.databagId);const i=this.modelCollection.getById(t);if(r.Utils.isDefined(i)){t=`${t}_${(new Date).getTime()}`}}return i.modelId=t,i.fileId=e.modelFileId||t,i}_loadModels(e,t,i){const n=this,{modelId:a}=e;return new Promise(((s,o)=>{this.modelLoader.load({viewer:this.viewer,manager:this,parameters:e,parseCfgFinish:t,debut:i},(function(t){n.modelCollection.add(t);const i=!r.Utils.isDefined(e.defaultVisible)||e.defaultVisible;t.setVisible(i),t instanceof r.BimTilesModel&&e.loadConfig&&e.loadConfig.forceLoadBIMTiles&&r.EnableStorage&&t.setForceLoadModel(e.loadConfig.forceLoadBIMTiles);n.checkIfFirstLodedModelLayer({isBmdLayer:t.isBmdLayer,unit:t.getUnit()}),t.setLengthUnitsMatrix(n.getModelLengthUnitsMatrix(t)),delete n.loadingModels[a];const o=t.load(e.notifyProgress);o&&o.then((()=>{n.updateRenderLoopState(),s(t)})).catch((()=>{n.modelCollection.remove(a,!0),console.log(`[BIMFACE ERROR]:some error occurred when load config of model ${a}`)}))}),(function(){n.modelCollection.remove(a,!0),delete n.loadingModels[a],console.log(`[BIMFACE ERROR]:some error occurred when load model ${a}`)}))}))}_loadModelWithShell(e,t,i){if(!e.shell)return null;if(!e.shell.databagId)return null;const n=r.Utils.clone(e.shell,!0),a=void 0!==n.modelId?`${n.modelId}_shell`:`${r.Utils.getEncodedString(n.databagId)}_shell`;n.modelId=a,n.loadShell=!0,n.serverUrl=void 0!==n.serverUrl?n.serverUrl:e.serverUrl;const s=void 0===e.visible||e.visible,o=!s;return n.visible=s,n.notifyProgress=!1,e.visible=o,this._loadModels(n,t,i).then((r=>{this._loadModels(e,t,i).then((e=>{e.shellModel=r}))})).catch((()=>{this._loadModels(e,t,i),console.log(`can not load shell-${e.shell.databagId}`)})),a}setModelShellVisibility(e,t){var i=this.modelCollection.getById(e);i&&i.shellModel&&(t?(i.setVisible(!1),i.shellModel.setVisible(!0)):(i.setVisible(!0),i.shellModel.setVisible(!1)))}unload(e,t){e+="",this.modelCollection.remove(e,!0)&&(this.updateScene(),this.updateFilterManager(),this.getFilter().calculateVisibleComponentsBbox(),t&&t())}unloadAll(){const e=this.modelCollection.getIds();for(let t=0,i=e.length;t<i;++t)this.unload(e[t]);this.clearPool()}addModel(e){this.modelCollection.add(e)}removeModel(e){this.modelCollection.remove(e)}getModelIds(e){if(e){var t=[];return this.modelCollection.traverse((function(e){e.isUseable()&&t.push(e.id)})),t}return this.modelCollection.getIds()}setModelVisibility(e,t,i){var r=this.getModel(e);r&&(r.setVisible(t),i&&i())}updateScene(e,t){this._needUpdateScene()&&(t=r.Utils.defaultValue(t,{}),this.updateSceneBoundingBox(e),this.updateSceneRootMatrix(t.forceUpdate),this.updateSceneRenderable(),this.updateOctreeNode())}_needUpdateScene(){return this.modelCollection.some((e=>{if(e.isEmptyScene())return!0;{let t=e.getBoundingBoxWorld();if(t&&!t.isEmpty())return!0}}))}_calculateSceneBoundingBox(){this.scratchBoundingBox.makeEmpty();const e=this.boundingBox.clone();e.makeEmpty();const t=[];if(this.modelCollection.traverse((i=>{if(i.isEmptyScene())return;if(i.loadMpkOnDemand)return void t.push(i);const n=i.getBoundingBoxWorld();n&&!n.isEmpty()&&(this.scratchBoundingBox.isEmpty()?(this.scratchBoundingBox.copy(n),i.id!=r.ObjectGroupType.TILEGROUP&&e.copy(n)):(this.scratchBoundingBox.union(n),i.id!=r.ObjectGroupType.TILEGROUP&&e.union(n)))})),this.hasLoadOnDemandDirector()){const t=this.getLoadOnDemandDirector().getBoundingBoxOnDemand();t&&(this.scratchBoundingBox.union(t),e.union(t))}else t.forEach((t=>{const i=t.getBoundingBoxWorld();i&&(this.scratchBoundingBox.union(i),e.union(i))}));this.scratchBoundingBox.isEmpty()&&(this.scratchBoundingBox=new THREE.Box3(new THREE.Vector3(-r.GlobalData.SceneSize,-r.GlobalData.SceneSize,-r.GlobalData.SceneSize),new THREE.Vector3(r.GlobalData.SceneSize,r.GlobalData.SceneSize,r.GlobalData.SceneSize)),e.copy(this.scratchBoundingBox)),this.boundingBox.copy(this.scratchBoundingBox),this.scene.setBoundingBoxWorld(this.scratchBoundingBox),this.scene.setBoundingBoxWorldWithoutDEM(e);let i=this.viewer.getUserInputEditor();i.resetMobileParamsByBox&&i.resetMobileParamsByBox(this.scratchBoundingBox)}updateSceneBoundingBox(e){if(r.Utils.isDefined(e)){const t=e.getBoundingBoxWorld();if(!r.Utils.isDefined(t))return;return this.scene.updateBoundingBoxWorld(t),e.id!=r.ObjectGroupType.TILEGROUP&&this.scene.updateBoundingBoxWorldWithoutDEM(t),this.boundingBox.expandByPoint(t.min),void this.boundingBox.expandByPoint(t.max)}this._calculateSceneBoundingBox()}updateSceneRootMatrix(e){var t=!1,i=new THREE.Matrix4,n=new THREE.Matrix4,a=new THREE.Quaternion;let s=null,o=!1;const l=e=>{a.copy(e.getTransforms().rotation),i.copy(e.getTransforms().transformMatrix),t=e.getTransforms().octreeTransformed,o=!0};if(this.modelCollection.some((e=>{if(!e.isEmptyScene()&&e.hasTransforms()&&["ExtrudeBodyManager","ExternalComponent"].indexOf(e.id)<0)return l(e),!0;!s&&e.isEmptyScene()&&(s=e)})),!o&&s&&(l(s),this.boundingBox.set(new THREE.Vector3(-500,-500,-500),new THREE.Vector3(500,500,500))),e=r.Utils.defaultValue(e,!1),void 0===this.rootMatrix||e){if(this.scene.setTransformMatrixGlobal(i),t)n.copy(i);else{var d=new THREE.Vector3(1,1,1),h=r.GlobalData.SceneSize,c=this.boundingBox.getSize(this.scratchVector),u=h/Math.max(c.x,c.y,c.z);d.multiplyScalar(u),n.makeRotationFromQuaternion(a),n.scale(d)}this.rootMatrix=n}this.scene.updateWorldMatrixByMatrix(this.rootMatrix),this.traverseValidModels((function(e){e.updateMatrix()}))}updateSceneRenderable(){var e=r.GlobalData.maxObjectNumInPool,t=[],i=0;this.modelCollection.traverse((e=>{e.isEmptyScene()||(i+=e.getStatistics().renderableTotalForPool,t.push(e.id))}));for(var n=0,a=0,s=t.length;a<s;++a){var o=t[a],l=this.modelCollection.getById(o),d=Math.floor(l.getStatistics().renderableTotalForPool/i*e);d>l.getStatistics().renderableTotalForPool&&(d=l.getStatistics().renderableTotalForPool),l.setRenderableCount(d),n+=d}this.scene.resizePool(n>e?e:n)}getVisibleLayersBoundingBox(){const e=new THREE.Box3;return this.modelCollection.traverse((t=>{if(t.id==r.ObjectGroupType.TILEGROUP)return;if(!t.isCulled())return;if(t.isEmptyScene())return;const i=t.getBoundingBoxWorld();r.Utils.isDefined(i)&&(i.isEmpty()||(e.expandByPoint(i.min),e.expandByPoint(i.max)))})),e.applyMatrix4(this.scene.geometryGroup.matrix),e}updateOctreeNode(){this.modelCollection.traverse((e=>{e.isLoaded()&&!e.isEmptyScene()&&e.updateOctreeNode(!0)}))}updateMaterials(){this.modelCollection.traverse((e=>{e.isLoaded()&&!e.isEmptyScene()&&e.updateMaterials()}))}updateMaterialsValue(e,t,i){this.modelCollection.traverse((r=>{r.isLoaded()&&!r.isEmptyScene()&&r.updateMaterialsValue(e,t,i)})),this.materialOverrideSet&&this.materialOverrideSet.updateMaterialsValue(e,t)}enableColorWithoutLight(e){this.modelCollection.traverse((t=>{t.isLoaded()&&!t.isEmptyScene()&&t.enableColorWithoutLight(e)}))}switchNewStyleMaterial(e){this.modelCollection.traverse((t=>{t.isLoaded()&&!t.isEmptyScene()&&t.switchNewStyleMaterial(e)}))}changeAllMaterials(e){this.IBLMaterial!=e&&(this.modelCollection.traverse((t=>{t.isEmptyScene()||t.changeAllMaterials(e)})),this.IBLMaterial=e)}setCrossOrigin(e){this.crossOrigin=e}getMatrixWorldGlobal(){return this.scene.getMatrixWorldGlobal()}hasModel(){return this.modelCollection.some((e=>e.isLoaded()))}hasModelDataReady(){if(0===this.modelCollection.length)return!1;return!this.modelCollection.some((e=>!e.emptyScene&&!e.isDataReady()||e.emptyScene&&!1))}isLayerData(){return this.modelCollection.some((e=>e.isLayerData()))}getModel(e){return this.modelCollection.getById(e+"")}getFirstModel(){return this.modelCollection.getByIndex(0)}showOctreeBox(e){if(r.GlobalData.ShowOctant){var t=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.OCTREENODE,{pickable:0,priority:2});function a(e){for(var i=0,n=e.childOctants.length;i<n;i++){var s=e.childOctants[i],o=new THREE.Box3(s.min,s.max),l=255;l<<=5*s.depth;var d=new r.BBoxNode(o,l);t.add(d),d.updateMatrixWorld(!0),a(s)}}if(t.visible=!0,0===t.children.length){var i=new THREE.Box3(e.min,e.max),n=new r.BBoxNode(i,16711680);t.add(n),n.updateMatrixWorld(!0),a(e)}}else this.scene.removeObjectGroupByName(r.ObjectGroupType.OCTREENODE)}setCategoriesToHighPriority(e,t){var i=e.length;if(!(i<1))for(var r=this.highPriorityCategories[t]={},n=0;n<i;++n)r[e[n]]=!0}getCategoriesFromHighPriority(e){return this.highPriorityCategories[e]}clearCategoriesFromHighPriority(e){this.highPriorityCategories[e]={}}clearAllCategoriesFromHighPriority(){this.clearCategoriesFromHighPriority("inner"),this.clearCategoriesFromHighPriority("outer")}calculateCameraModelRelation(e){var t=!1;this.modelCollection.traverse((i=>{i.isLoaded()&&!i.isEmptyScene()&&(i.calculateCameraModelRelation(e),t=t||i.containsCamera)})),this.containsCamera=t}getCameraNameList(){var e=[];return this.modelCollection.traverse((t=>{t.isEmptyScene()||(e=e.concat(t.getCameraNameList()))})),e}getCamera(e){var t=null;return this.modelCollection.some((i=>{if(!i.isEmptyScene()&&(t=i.getCamera(e)))return!0})),t}getNumOfElements(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfElements)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfElements)}));return t}getNumOfRenderables(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().renderableTotal)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().renderableTotal)}));return t}getNumOfTriangles(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfTriangles)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfTriangles)}));return t}getNumOfVertices(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfVertices)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfVertices)}));return t}getScene(){return this.scene}getOctreeRoots(){var e={};return this.modelCollection.traverse((t=>{if(t.isLoaded()&&!t.isEmptyScene()){var i=t.getEncodedDatabagId();e[i]=[],t.getOctreeRoots(e[i])}})),e}addMeshToOctantMap(e,t,i){var r=this.octantToObjectMap;r[e]||(r[e]={}),r[e].mesh||(r[e].mesh={}),r[e].mesh[t]||(r[e].mesh[t]=[]),r[e].mesh[t].push(i)}addNodeInfoToOctantMap(e,t,i){var r=this.octantToObjectMap;r[e]||(r[e]={}),r[e].info||(r[e].info={}),r[e].info[t]||(r[e].info[t]=[]),r[e].info[t].push(i)}removeNodeInfoFromOctantMap(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].info&&i[e].info[t.cellId])for(var r=i[e].info[t.cellId],n=r.length-1;n>=0;n--)if(t.nodeId===r[n].nodeId){r.splice(n);break}}clearNodeInfosFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&t[e].info&&(t[e]=null)}removeAllFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&delete t[e]}clearMeshFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&t[e].mesh&&delete t[e].mesh}removeMeshFromOctantMap(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].mesh&&i[e].info){var r,n=i[e].info[t.cellId];for(r=n.length-1;r>=0;r--)if(t.nodeId===n[r].nodeId){n.splice(r);break}i[e].mesh[t.nodeId]&&delete i[e].mesh[t.nodeId]}}getOctantMap(){return this.octantToObjectMap}isFilterApplied(){return this.filterApplied}setFilterApplied(e){this.filterApplied=e}applyFilter(e){if(void 0===e)this.traverseValidModels((function(e){e.applyFilter()}));else{var t=this.getModel(e);t&&t.applyFilter()}this.setFilterApplied(!0)}applySelection(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels((function(e){e.applySelection()}));else{var t=this.getModel(e);t&&t.applySelection()}}clearSelection(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels((function(e){e.clearSelection()}));else{var t=this.getModel(e);t&&t.clearSelection()}}applyHover(e){if(r.GlobalData.Hover)if(void 0===e)this.traverseValidModels((function(e){e.applyHover()}));else{var t=this.getModel(e);t&&t.applyHover()}}clearHover(e){if(r.GlobalData.Hover)if(void 0===e)this.traverseValidModels((function(e){e.clearHover()}));else{var t=this.getModel(e);t&&t.clearHover()}}chooseRendering(e,t,i){if(!this.firstChooseRendering){if(this.firstChooseRendering=!0,t)return r.GlobalData.DynamicScheduling=!0,r.GlobalData.BatchMergeEnabled=!0,void(r.GlobalData.IncrementRender=!1);switch(console.log("Maximum Memory (M):",e.maxMemorySize),r.GlobalData.Renderer){case r.EnumRendererType.FULL:r.GlobalData.BatchMergeEnabled=!0,r.GlobalData.IncrementRender=!1;break;case r.EnumRendererType.INCREMENT:r.GlobalData.BatchMergeEnabled=!1,r.GlobalData.IncrementRender=!0;break;default:if(r.GlobalData.BatchMergeEnabled=!1,r.GlobalData.IncrementRender=!0,r.Compatibility.isUseDoubleMatrix(i.metadata.version)&&r.Compatibility.isUseINCREMENTByBmpkCount(i.metadata.bmpks,i.metadata.mpks))break;e.maxMemorySize<=r.GlobalData.MaxMemeorySizeToFullRender&&(r.GlobalData.BatchMergeEnabled=!0,r.GlobalData.IncrementRender=!1)}}}isUserIdExist(e,t){if(void 0===t)return this.modelCollection.some((t=>t.isUserIdExist(e)));const i=this.getModel(t);return!(!i||!i.isUserIdExist(e))}getNodeInfosByUserId(e,t){var i;return this.filterHelper.executeId(e,((e,t)=>{i&&0!==i.length||(i=e.getNodeInfosByUserId(t))}),t),i&&i.length>0?i:null}getNodeInfos(){let e={};return this.modelCollection.traverse((t=>{t.updateNodeInfosForPlugins&&t.updateNodeInfosForPlugins();let i=t.getAllNodeInfos();i&&(e[t.id]=i)})),e}getMaterialByNodeId(e,t,i){var r=this.modelCollection.getById(e);if(!r)return null;for(var n=r.getNodeInfosByUserId(t),a=-1,s=0,o=n.length;s<o;s++)if(n[s].nodeId===i){a=s;break}return-1!==a?r.getMaterialByMaterialId(n[a].materialId):null}getImageByUrl(e){const t=this.modelCollection._layers;for(let i=0;i<t.length;i++){if(!t[i].dataUrl)continue;const r=e.lastIndexOf("/")-8;if(e.substring(0,r)!=t[i].dataUrl.databagPath)continue;const n=t[i].getImageByUrl(e);if(n)return n}return null}getNodeInfoByNodeId(e,t,i){var r=this.modelCollection.getById(e);if(!r)return null;for(var n=r.getNodeInfosByUserId(t),a=-1,s=0,o=n.length;s<o;s++)if(n[s].nodeId===i){a=s;break}return-1!==a?n[a]:null}getComponentInfoByUserId(e,t){var i=this.getNodeInfosByUserId(e,t);if(i&&i.length>0){for(var r=new THREE.Box3,n=[],a=0,s=i.length;a<s;a++){let e=i[0].transformMatrix||new THREE.Matrix4,t=i[a].boundingBox.clone().applyMatrix4(e);r.union(t),-1===n.indexOf(i[a].materialId)&&n.push(i[a].materialId)}return{userId:e,state:0,materials:n,boundingBox:r,userData:i[0].userData}}return null}getBoundingBoxByIds(e,t,i){var n=this.viewer,a=new THREE.Box3;for(const d of e)if(i||!this.isHiddenUserIdWithModel(d,t)){var s=this.getComponentInfoByUserId(d,t);if(s)a.union(s.boundingBox);else{var o=r.ExtrudeBodyManager.getInstance(n).getNode(d);if(o){var l=o.geometry.boundingBox.clone();o.matrix&&l.applyMatrix4(o.matrix),a.union(l)}}}return a}createMaterialOverrideSet(e,t){this.materialOverrideSet=new r.MaterialOverriderSet(e,t),r.GlobalData.EnableTextureMapping=!0}getMaterialOverrideSet(){return this.materialOverrideSet}getOverrideMaterialByNodeInfo(e,t){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByNodeInfo(e,t):null}getOverrideMaterialByName(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByName(e):null}loadOverrideMaterialsByDemand(e,t){if(this.materialOverrideSet){var i=this.getConditions();this.materialOverrideSet.loadByDemand(i,e,t)}else t&&t()}getConditions(){let e={},t={},i={};return this.modelCollection.traverse((r=>{const n=r.getAllNodeInfos();if(n)for(const r in n)if(n.hasOwnProperty(r))for(let a=0,s=n[r].length;a<s;a++){const s=n[r][a].userData;t[n[r][a].userId]=!0,i[s.systemTypeId]=!0,e[s.familyId]=!0}})),{familyIds:e,elementIds:t,systemTypeIds:i}}isHiddenUserId(e){return this.modelCollection.some((t=>t.isHiddenUserId(e)))}isHiddenUserIdWithModel(e,t){if(t){return this.modelCollection.getById(t).isHiddenUserId(e)}return this.isHiddenUserId(e)}updateMeshNodes(){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((e=>{!e.isEmptyScene()&&e.isLoaded()&&e.updateMeshNodes()}))}getMinDistanceObjects(e,t){var i={},{modelId:n,objectId:a}=this.filterHelper.distributeId(e),{modelId:s,objectId:o}=this.filterHelper.distributeId(t);if(n&&s&&n===s){var l=this.modelCollection.getById(n);l.minDistanceObjects={},l.getMeshesByUserIds(a,o),l.minDistanceObjects[a].length>0&&l.minDistanceObjects[o].length>0&&(i[e]=l.minDistanceObjects[a],i[t]=l.minDistanceObjects[o])}else{if(n){var d=this.modelCollection.getById(n);d.minDistanceObjects={},d.getMeshesByUserIds(a,a),d.minDistanceObjects[a].length>0&&(i[e]=d.minDistanceObjects[a])}if(s){var h=this.modelCollection.getById(s);h.minDistanceObjects={},h.getMeshesByUserIds(o,o),h.minDistanceObjects[o].length>0&&(i[t]=h.minDistanceObjects[o])}if(n&&s||this.modelCollection.traverse((r=>{"ExtrudeBodyManager"!==r.id&&"ExternalComponent"!==r.id&&(r.minDistanceObjects={},r.getMeshesByUserIds(a,o),!i[e]&&r.minDistanceObjects[a].length>0&&(i[e]=r.minDistanceObjects[a]),!i[t]&&r.minDistanceObjects[o].length>0&&(i[t]=r.minDistanceObjects[o]))})),!i[e]||!i[t]){function g(e,t,r){var n={};n.mesh=e;var a=new THREE.Matrix4;r?a.multiplyMatrices(r,e.matrix):a=e.matrix,n.matrix=a;var s=e.geometry.boundingBox;s||(e.geometry.computeBoundingBox(),s=n.mesh.geometry.boundingBox);var o=s.clone().applyMatrix4(a);n.boundingBox=o,i[t]||(i[t]=[]),i[t].push(n)}var c=this.scene.getObjectGroup("ExternalComponentManager");if(!c)return;for(var u=c.children,p=0,m=u.length;p<m;p++){var f=u[p];f.name!=e&&f.name!=t||(r.Utils.isGroupObject(f)?f.traverseVisible((function(e){r.Utils.isMeshObject(e)&&g(e,f.name,f.matrix)})):g(f,f.name))}}}return i[e]&&i[t]?i:null}adjustVisibility(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.adjustVisibility&&t.adjustVisibility(e)}))}changeVisibilityOfSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeVisibilityOfSelectedObjects&&t.changeVisibilityOfSelectedObjects(e)}))}changeVisibilityOfNonSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeVisibilityOfNonSelectedObjects&&t.changeVisibilityOfNonSelectedObjects(e)}))}adjustInstanceVisibility(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.adjustInstanceVisibility&&t.adjustInstanceVisibility(e)}))}changeInstanceVisibilityOfSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeInstanceVisibilityOfSelectedObjects&&t.changeInstanceVisibilityOfSelectedObjects(e)}))}changeInstanceVisibilityOfNonSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeInstanceVisibilityOfNonSelectedObjects&&t.changeInstanceVisibilityOfNonSelectedObjects(e)}))}adjustDemVisibility(e,t){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((i=>{i.isDemLayer&&i.tileManager&&(e?i.tileManager.showAllLayers(t):i.tileManager.hideAllLayers(t))}))}adjustDemOthersVisibility(e){let t={};return this.modelCollection.traverse((i=>{t[i.id]=i.visible,i.isDemLayer&&i.tileManager||i.setVisible(e)})),t}adjustVisibilityByModelIdMap(e,t){if(!r.Utils.defined(t))return null;let i={};return this.modelCollection.traverse((r=>{t[r.id]&&r.tilesLoader?(i[r.id]=r.visible,r.setVisible(e)):!t[r.id]&&r.tilesLoader&&r.visible===e&&(i[r.id]=r.visible,r.setVisible(!e))})),i}restoreVisibilityByModelIdMap(e){this.modelCollection.traverse((t=>{r.Utils.defined(e[t.id])&&t.setVisible(e[t.id])}))}restoreVisibilityOfObjects(){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((e=>{e.restoreVisibilityOfObjects&&e.restoreVisibilityOfObjects()}))}isSelectPriority(){return this.selectPriority}getSceneState(){return this.sceneState}disposeBufferAfterVbo(){r.GlobalData.EnableDisposeBufferAfterVbo&&this.modelCollection.traverse((e=>{e.disposeBufferAfterVbo()}))}getSourceObjectManager(){return this.sourceObjectManager||(this.sourceObjectManager=new r.SourceObjectManager),this.sourceObjectManager}isHiddenSourceObjectUserId(e,t){let i=!1;if(this.sourceObjectManager&&(i=i||this.sourceObjectManager.isHidden(e,t)),t){const r=this.getModel(t);r&&r.isReplacedUserId&&(i=i||r.isReplacedUserId(e))}return i}hasHiddenSourceObjectUserId(e){let t=!1;if(this.sourceObjectManager&&(t=t||this.sourceObjectManager.hasHidden()),e){const i=this.getModel(e);i&&i.hasReplacedUserId&&(t=t||i.hasReplacedUserId())}return t}traverseModels(e,t){this.modelCollection.traverseIf(e,t)}traverseLoadedModels(e){this.traverseValidModels(e)}traverseValidModels(e){this.viewer.globalRendering||this.modelCollection.traverse((t=>{t.isUseable()&&e(t)}))}dealStateChanged(){if(this.hasModelDataReady()&&(this.isRenderStateChanged()||this.filter.isStateChanged()||this.filter.isTileLoadedStateChanged())){if(this.isRenderStateChanged()&&this.setRenderStateChanged(!1),this.filter.isStateChanged()||this.filter.isTileLoadedStateChanged())r.GlobalData.EnableShadowMap&&this.viewer.updateShadowMap(),(e=this.scene.fillClipPlane)&&e.update(),this._updateMaterialProperties(),this.filter.disableStateChanged(),this.filter.disableTileLoadedStateChanged();if(this.filter.isVisibleStateChanged()){var e=this.scene.fillClipPlane,t=this.scene.clipPlanes,i=e&&e.isEnabled()?e:t;i&&r.GlobalData.ClippingCapsType>0&&i.reCalculateClippingIds(!0),this.forceUpdateGTAOPass()}this.filter.isColorStateChanged()&&this.forceUpdateGTAOPass(),this.applyFilter(),this.viewer.viewshedManager&&this.viewer.viewshedManager.update()}}_updateMaterialProperties(){this._updateExposureShift()}_updateExposureShift(){const e=this.viewer.getExposureShift();void 0!==e&&this.setExposureShift(e)}setColorSaturation(e){this.updateMaterialsValue("saturation",e)}setColorTemperature(e,t){this.updateMaterialsValue("temperature",e),this.updateMaterialsValue("temperatureStrength",t)}setColorContrast(e){this.updateMaterialsValue("contrast",e)}setExposureShift(e){const t=e>0?-.4*e+.5:-4*e+.5;this.updateMaterialsValue("shift",t)}setRenderStateChanged(e){this._renderStateChanged=e}isRenderStateChanged(){return this._renderStateChanged}hasLoadOnDemandDirector(){return!!this.loadOnDemandDirector}getLoadOnDemandDirector(){return this.loadOnDemandDirector||(this.loadOnDemandDirector=new r.LoadOnDemandDirector(this)),this.loadOnDemandDirector}checkLayerDataLoading(){return!!(this.isLayerData()&&this.hasLoadOnDemandDirector()&&this.getLoadOnDemandDirector().isLoading())&&(this.filter.isStateChanged()&&this.filter.disableStateChanged(),!0)}updateFilterManager(){var e=this.getNodeInfos(),t=this.getFilter();t.clearFilterManager(),t.initFilterManager(e),t.isStateChanged()&&t.disableStateChanged(),this.updateMeshNodes(),this.applyFilter()}isDrawingBoardlineEnabled(){return!(!r.GlobalData.DrawingBoardlineEnabled||r.GlobalData.DrawingStyle!==r.DrawingStyle.BOARDLINE&&r.GlobalData.DrawingStyle!==r.DrawingStyle.SHADINGWITHLINE)}isOnlyWireframe(){return r.GlobalData.DrawingStyle===r.DrawingStyle.BOARDLINE}calculateClippingIds(e,t){this.modelCollection.traverse((i=>{i.calculateClippingIds(e,t)}))}calculateClippingContours(e){this.modelCollection.traverse((t=>{t.calculateClippingContours(e)}))}getInstanceDepthMaterial(){if(this.instanceDepthMaterial)return this.instanceDepthMaterial;var e=new r.InstancedDepthMaterial;return e.depthPacking=THREE.RGBADepthPacking,this.instanceDepthMaterial=e,this.instanceDepthMaterial}createDemModel(e,t){if(this.removeModel(r.ObjectGroupType.TILEGROUP),this.viewer.camera.isPerspective||this.viewer.switchToCamera("persp"),e=e||{},!r.GlobalData.EnableLodDemDom&&!t){const t=new r.DemModel(this.viewer,this,{});return t.loadTile(this.viewer,e),this.addModel(t),t}const i=e.loadConfig?e:{loadConfig:e};i.manager=this,this.checkIfFirstLodedModelLayer({isDemLayer:!0});const n=r.ModelFactory.globe(this.viewer,i);return this.addModel(n),n.load(),n}createLineModel(e){const t=new r.LineModel(this.viewer,this,e);return this.addModel(t),t.load(),t}setDemLoadedState(e){this.demLoaded=e,this.updateRenderLoopState()}isSceneChanged(){return this.isRenderStateChanged()||this.filter.isStateChanged()}isMeterUnit(){const e=this.getSceneUnit();if(e)return e===r.EnumLengthlUnits.Meter;let t=!1;return this.modelCollection.traverse((e=>{e._config&&e._config.metadata&&("bimtile"===e._config.metadata.asset||"bimtiles"===e._config.metadata.asset||"m"===e._config.metadata.model_unit)&&(t=!0)})),t}isBimtilesAsset(){let e=!1;return this.modelCollection.traverse((t=>{t._config&&t._config.metadata&&("bimtile"===t._config.metadata.asset||"bimtiles"===t._config.metadata.asset)&&(e=!0)})),e}updatePickingMaterial(){this.modelCollection.traverse((e=>{e.updatePickingMaterial&&e.updatePickingMaterial()}))}checkIfFirstLodedModelLayer(e){void 0===this.firstLoadedBmdLayer&&(this.firstLoadedBmdLayer=!!e.isBmdLayer,this._setDefaultSceneUnit(this.firstLoadedBmdLayer,e.unit),r.Tile.TileMath.unitScale=r.GlobalData.SceneUnit===r.EnumLengthlUnits.Millimeter?1e3:1)}updateRenderLoopState(){if(!this.viewer||!this.viewer.rendererManager)return;const e=this.viewer.rendererManager.renderer;e&&e.isBatched&&(this._isLoadedBmdModelOnly()?e.setRenderLoop(!1):e.setRenderLoop(!0))}_isLoadedBmdModelOnly(){return this.firstLoadedBmdLayer&&!this.demLoaded}_setDefaultSceneUnit(e,t){e?this.setSceneUnit(t):this.setSceneUnit(r.EnumLengthlUnits.Meter)}setSceneUnit(e){r.GlobalData.SceneUnit=e}getSceneUnit(){return r.GlobalData.SceneUnit}getModelUnit(e){const t=this.getModel(e);return t?t.getUnit():this.getSceneUnit()}getModelLengthUnitsMatrix(e){if(!e.isBmdLayer&&e.getUnit()!==r.EnumLengthlUnits.Meter)return r.Utils.MatrixFromMillimeterToMeter}hasLoadedModel(){return this._firstModelLoaded}checkIfFirstModelLoaded(){this._firstModelLoaded||(this._firstModelLoaded=!0)}holdAllNodeGroupVisibility(){this.modelCollection.traverse((e=>{e.holdNodeGroupVisibility&&e.holdNodeGroupVisibility()}))}resetAllNodeGroupVisibility(){this.modelCollection.traverse((e=>{e.resetNodeGroupVisibility&&e.resetNodeGroupVisibility()}))}hideAllWireframes(){this.modelCollection.traverse((e=>{e.hideWireframeGroup&&e.hideWireframeGroup()}))}showAllWireframes(){this.modelCollection.traverse((e=>{e.showWireframeGroup&&e.showWireframeGroup()}))}hideAllExcludeWireframes(){this.modelCollection.traverse((e=>{e.hideExcludeWireframeGroup&&e.hideExcludeWireframeGroup()}))}showAllExcludeWireframes(){this.modelCollection.traverse((e=>{e.showExcludeWireframeGroup&&e.showExcludeWireframeGroup()}))}_getClipPlaneGroupNames(){return[r.ObjectGroupType.CLIPPLANE,r.ObjectGroupType.FILLCLIPPLANE,r.ObjectGroupType.CAPSWIREFRAME,r.ObjectGroupType.CLIPREGION]}_traverseClipPlaneGroup(e){this._getClipPlaneGroupNames().forEach((t=>{const i=this.scene.getObjectGroup(t);i&&e(i)}))}holdClipPlaneGroupVisibility(){this._traverseClipPlaneGroup((e=>{e._oriVisible=e.visible}))}hideClipPlaneGroup(){this._traverseClipPlaneGroup((e=>{e._oriVisible&&(e.visible=!1)}))}showClipPlaneGroup(){this._traverseClipPlaneGroup((e=>{e._oriVisible&&(e.visible=!0)}))}resetClipPlaneGroupVisibility(){this._traverseClipPlaneGroup((e=>{e._oriVisible=void 0}))}updateAlphaMapProperties(e){this.modelCollection.traverse((t=>{t.materialManager&&t.materialManager.updateAlphaMapProperties&&t.materialManager.updateAlphaMapProperties(e)}))}descriptorCountEvent(e){const t=e.getDescriptor();let i=[],n=[];r.BimTilesVersionControl.isVersion_3(e.dataVersion)?(i=t.userIdInstanceInfoMap,n=t.userIdInfoMap):(i=t.mapNodeInfoByInstance,n=t.mapNodeInfoByBatched);[i,n].forEach((t=>{null!=t&&(e.changeStateTime.descriptorCount+=t.size)}))}fireTilesLoadEvent(e){const t=this,i=this.tilesCacheScheduler,n=i._statistics,a=n.getNumberOfTilesWithContentReady(),s=n.getNumberOfPendingRequests(),o=n.getNumberOfTilesProcessing(),l=n.getNumberOfAttemptedRequests(),d=i._statisticsLast,h=d.getNumberOfPendingRequests(),c=d.getNumberOfTilesProcessing();d.copy(n);const u=s!==h||o!==c;u&&e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_PROGRESS,data:{numPendingRequests:s,numTilesProcessing:o}})}));const p=a>0;!this._initialTilesLoaded&&p&&(this._initialTilesLoaded=!0,e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_INITIAL})}))),this._tilesLoaded=0===s&&0===o&&0===l;let m={};u&&this._tilesLoaded&&(this.modelCollection.traverse((e=>{let t=e.id;!e.initTileLoaded&&e instanceof r.BimTilesModel&&(this.descriptorCountEvent(e),m[t]=e.changeStateTime.descriptorCount,e.initTileLoaded=!0)})),e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_MODEL_INITIAL,data:m})})),e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_COMPLETE})})))}enableCSM(e){this.modelCollection.traverse((t=>{t.enableCSM&&t.enableCSM(e)}))}forceUpdateGTAOPass(){const e=this.viewer.rendererManager.renderer;e&&e.forceUpdateGTAOPass&&e.forceUpdateGTAOPass()}classifyGISModels(){let e=[],t=[];return this.modelCollection.traverse((i=>{i._config&&(i._config&&i._config.metadata&&i._config.metadata.content&&("osgb"===i._config.metadata.content||"3dtiles"===i._config.metadata.content||"las"===i._config.metadata.content||"shp"===i._config.metadata.content||"dwg"===i._config.metadata.content)||i._config&&i._config.metadata&&i._config.metadata.FeatureType&&("point"===i._config.metadata.FeatureType||"shp"===i._config.metadata.FeatureType)?e.push(i):t.push(i))})),[e,t]}calculateModelRequestSequencesByCameraDistance(e){const t=e.cameraPositionWc;let i=[],r=0;this.traverseValidModels((function(e){const n=e.getBoundingBoxWorld();r=n&&!n.isEmpty()?n.distanceToPoint(t):0,i.push({modelId:e.id,distance:r})})),i.sort(((e,t)=>e.distance-t.distance));let n={};i.forEach(((e,t)=>{n[e.modelId]=t})),this.traverseValidModels((function(e){e.setRequestSequencePriority&&e.setRequestSequencePriority(n[e.id])}))}}r.ModelManager=e}(),r.ModelView.FilterDirector=class{constructor(e){this.modelManager=e,this.observerForSceneState=null,this.filterHelper=this.modelManager.getFilterHelper()}destroy(){this.modelManager=null,this.observerForSceneState=null,this.filterHelper=null}clear(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clear()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clear(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clear()})))}}setIsolateMaterial(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&t.getFilter().setIsolateMaterial(e)}));else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&(i.getFilter().setIsolateMaterial(e),this.filterHelper._executeCallbackWithPlugins(i,(t=>{t.getFilter().setIsolateMaterial(e)})))}}resetIsolateMaterial(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().resetIsolateMaterial()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().resetIsolateMaterial(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().resetIsolateMaterial()})))}}setFrozonMaterial(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&t.getFilter().setFrozonMaterial(e)}));else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&(i.getFilter().setFrozonMaterial(e),this.filterHelper._executeCallbackWithPlugins(i,(t=>{t.getFilter().setFrozonMaterial(e)})))}}getFrozonMaterial(e){var t,i=[];if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&(t=e.getFilter().getFrozonMaterial())&&i.push(t)}));else{var r=this.modelManager.getModel(e);r&&r.getFilter()&&((t=r.getFilter().getFrozonMaterial())&&i.push(t),this.filterHelper._executeCallbackWithPlugins(r,(e=>{(t=e.getFilter().getFrozonMaterial())&&i.push(t)})))}return i[0]}_getMaterialByName(e,t){var i,r=[];if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&(i=t.getFilter()._getMaterialByName(e))&&r.push(i)}));else{var n=this.modelManager.getModel(t);n&&n.getFilter()&&((i=n.getFilter()._getMaterialByName(e))&&r.push(i),this.filterHelper._executeCallbackWithPlugins(n,(t=>{(i=t.getFilter()._getMaterialByName(e))&&r.push(i)})))}return r[0]}_isolate(e,t,i){var n=e.getFilter();switch(i){case"hide":n.setIsolateConditions(t,r.EnumIsolateState.HIDDEN_OTHERS);break;case"translucent":n.setIsolateConditions(t,r.EnumIsolateState.TRANSLUCENT_OTHERS);break;default:console.log("no this isolate state : "+i)}}isolate(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{this._isolate(e,i,t)}),i)}setConditions(e,t,i){this.filterHelper.executeConditions(t,((t,i)=>{t.getFilter().setConditions(e,i)}),i)}setWireFrameVisibilityCondition(e,t){const i=this.modelManager.getModel(t);i&&i.getFilter()&&i.getFilter().setWireFrameVisibilityCondition(e)}isHidden(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isHidden(t))}),t),i}isFrozen(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isFrozen(t))}),t),i}isIsolate(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isIsolate())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter().isIsolate(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter().isIsolate()})))}return t}isFiltering(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isFiltering())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter().isFiltering(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter().isFiltering()})))}return t}getMatchIds(e,t){var i=[];return this.filterHelper.executeConditions(e,((e,t)=>{i=i.concat(e.getFilter().getMatchIds(t))}),t),i}isMatchConditions(e,t,i){var r=!1;return this.filterHelper.executeConditions(t,((t,i)=>{r=r||t.getFilter().getObjectInfoManager().isMatchConditions(e,i)}),i),r}deactivateByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().deactivateByIds(t),e.getFilter().enableStateChanged(!0)}),t)}addAllComponentsToOverrideListByColor(e,t){this.filterHelper.executeIds([],((t,i)=>{i=t.getAllUserIds(),t.getFilter().addToOverrideListWithAllIdsByColor(i,e)}),t)}addToOverrideListForAllWireFrame(e,t){this.filterHelper.executeIds([],((t,i)=>{i=t.getAllUserIds(),t.getFilter().addToOverrideListForAllWireFrameByColor(i,e)}),t)}addToOverrideListForRestoreAllWireFrame(e){this.filterHelper.executeIds([],((e,t)=>{t=e.getAllUserIds(),e.getFilter().addToOverrideListForAllWireFrameByColor(t,null)}),e)}addToOverrideListByColor(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListByColor(i,t)}),i)}addToOverrideListAboutBmdByOpacity(e,t,i,r){let n=i.getFilter().findColorMap(t,i,r),a=[],s=[];for(const e in n){const t=n[e];a.push(t.ids),s.push(t.color)}i.getFilter().overrideComponentsOpacity(e,r,a,s)}addToOverrideListByOpacity(e,t,i){var n=this;let a=(i,a)=>{if(i&&i instanceof r.BimTilesModel){for(let e=0;e<a.length;e++)i.getFilter().addToModifyOpacityList(a[e],t);"conditions"===e.type?i.getFilter().addToOverrideListByOpacityAndConditions(e.param,t):i.getFilter().addToOverrideListByOpacity(a,t),i.getFilter().enableStateChanged()}else n.addToOverrideListAboutBmdByOpacity(e,a,i,t)};if("conditions"===e.type){var s=e.param,o=(e,t)=>{e.getFilter().addToOpacityListByConditions(t,((t,i)=>{i&&a(e,t)}))};this.filterHelper.executeConditions(s,o,i)}else{var l=e.param;o=(e,t)=>{a(e,t)},this.filterHelper.executeIds(l,o,i)}}restoreComponentsOpacity(e,t){if(this.staticTimeInit(t),"conditions"===e.type){const i=e.param,r=(e,t)=>{e.getFilter().addToOpacityListByConditions(t,((i,r)=>{r&&e.getFilter().restoreComponentsOpacityWithConditions(t,i,e)}))};this.filterHelper.executeConditions(i,r,t)}else{const i=e.param,r=(e,t)=>{e.getFilter().restoreComponentsOpacityWithIds(e,t)};this.filterHelper.executeIds(i,r,t)}}addToOverrideListByMaterial(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListByMaterial(i,t)}),i)}addToOverrideListByConditions(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListByConditions(i,t)}),i)}addToOverrideListByMaterialAndId(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListByMaterialAndId(i,t)}),i)}clearAllOverrideList(e){if(this.staticTimeInit(e),void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearAllOverrideList()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearAllOverrideList(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearAllOverrideList()})))}}clearAllComponentsOverrideList(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearAllComponentsOverrideList()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearAllComponentsOverrideList(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearAllComponentsOverrideList()})))}}addToOverrideListForWireFrameByColor(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListForWireFrameByColor(i,t)}),i)}addToOverrideListForWireFrameByConditions(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListForWireFrameByConditions(i,t)}),i)}addToLocalClippingList(e,t){var i=this,n=function(e,t){if(e&&e instanceof r.BimTilesModel)for(var n=e.getFilter().getLocalClippingList(),a=0;a<t.length;a++){var s=t[a];n.get(s)||e.getFilter().addToLocalClippingList(s)}else if(e&&e.getFilter()&&e._handler)for(n=e.getFilter().getLocalClippingList(),a=0;a<t.length;a++)if(s=t[a],!n.get(s)){var o=e._handler.instancedManager.meshManager;o.traverseNodeIdxMapByUserId(s,(function(t,i){if(o.getInstanceGeometries(t)){var r=o.getMaterialIdByMeshId(t),n=e.materialManager.getInstanceMaterialById(r,e);if(n)if(n instanceof Array)for(var a=0;a<n.length;a++){var s=n[a];e.getFilter().addInstanceMaterialForClip(s.uuid,s)}else e.getFilter().addInstanceMaterialForClip(n.uuid,n)}}));var l=!0,d=i.modelManager.getNodeInfosByUserId(s,e.id);if(d)for(var h=0;h<d.length;h++)if(!d[h].instanceOrNot){l=!1;break}if(l)e.getFilter().addToLocalClippingList(s);else{var c=e._handler.getGeometryBuffersByUserId(s);if(c&&c.length>0)for(var u=0;u<c.length;u++){var p=c[u],m=i.modelManager.getMaterialByNodeId(p.databagId,s,p.nodeId);if(m){var f={};f.color=m.color.getHex(),f.opacity=m.opacity,f.side=m.side,m.map&&(f.map=m.map);var g=e.getWireframeMaterial(),v={};v.color=g.color.getHex(),v.opacity=g.opacity,v.side=g.side,e.getFilter().addToLocalClippingList(s,f,v,p.nodeId)}}}}};if("conditions"===e.type){var a=e.param,s=(e,t)=>{e.getFilter().addToLocalClippingListByConditions(t,((t,i)=>{i&&n(e,t)})),e.getFilter().enableStateChanged()};this.filterHelper.executeConditions(a,s,t)}else{var o=e.param;s=(e,t)=>{n(e,t)},this.filterHelper.executeIds(o,s,t)}}clearLocalClippingList(e){if(e){var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearLocalClippingList(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearLocalClippingList()})))}else this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearLocalClippingList()}))}addToIsolateList(e,t,i){this.staticTimeInit(i),this.filterHelper.executeIds(e,((e,i)=>{!1!==e.modelLoaded&&e.getFilter().addToIsolateList(i,t)}),i)}setIsolateConditions(e,t,i){this.staticTimeInit(i),this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().setIsolateConditions(i,t)}),i)}clearIsolation(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearIsolation()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearIsolation(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearIsolation()})))}}clearAllIsolateConditions(e){if(this.staticTimeInit(e),void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearAllIsolateConditions()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearAllIsolateConditions(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearAllIsolateConditions()})))}}showByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().showByIds(t)}),t)}showByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().showByConditions(t)}),t)}hideByIds(e,t){this.staticTimeInit(t),this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().hideByIds(t)}),t)}hideByConditions(e,t){this.staticTimeInit(t),this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().hideByConditions(t)}),t)}hideOthersByConditions(e,t){this.staticTimeInit(t),this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().hideOthersByConditions(t)}),t)}showAll(e){if(this.staticTimeInit(e),void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().showAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().showAll(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().showAll()})))}}hideAll(e){if(this.staticTimeInit(e),void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().hideAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().hideAll(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().hideAll()})))}}showScene(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().showScene()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().showScene(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().showScene()})))}}clearInactivatedIdMap(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearInactivatedIdMap()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().clearInactivatedIdMap(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().clearInactivatedIdMap()})))}}makeTranslucentByIds(e,t){this.staticTimeInit(t),this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().makeTranslucentByIds(t)}),t)}makeTranslucentByConditions(e,t){this.staticTimeInit(t),this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().makeTranslucentByConditions(t)}),t)}makeTranslucentOthersByIds(e,t){this.staticTimeInit(t),this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().makeTranslucentOthersByIds(t)}),t)}opaqueByIds(e,t){this.staticTimeInit(t),this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().opaqueByIds(t)}),t)}opaqueByConditions(e,t){this.staticTimeInit(t),this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().opaqueByConditions(t)}),t)}opaqueAll(e){if(this.staticTimeInit(e),void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().opaqueAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&(t.getFilter().opaqueAll(),this.filterHelper._executeCallbackWithPlugins(t,(e=>{e.getFilter().opaqueAll()})))}}_hasVisibleFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasVisibleFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasVisibleFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasVisibleFilter()})))}return t}_hasPickableFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasPickableFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasPickableFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasPickableFilter()})))}return t}_hasHiddenFileIdFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasHiddenFileIdFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasHiddenFileIdFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasHiddenFileIdFilter()})))}return t}_hasOverrideMaterialFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasOverrideMaterialFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasOverrideMaterialFilter()})))}return t}_hasTransparentFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasTransparentFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasTransparentFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasTransparentFilter()})))}return t}_hasOverrideMaterialFilterForWireFrame(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilterForWireFrame())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasOverrideMaterialFilterForWireFrame(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasOverrideMaterialFilterForWireFrame()})))}return t}_hasRenderWithBoardlineFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasRenderWithBoardlineFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasRenderWithBoardlineFilter(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{t=t||e.getFilter()._hasRenderWithBoardlineFilter()})))}return t}_isRenderWithBoardline(e,t){var i=!1;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isRenderWithBoardline(e))}),(function(e){return i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isRenderWithBoardline(e),this.filterHelper._executeCallbackWithPlugins(r,(e=>{i=i||e.getFilter()._isRenderWithBoardline()})))}return i}_isVisible(e,t){var i=!0;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isVisible(e))}),(function(e){return!i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isVisible(e),this.filterHelper._executeCallbackWithPlugins(r,(t=>{i=i||t.getFilter()._isVisible(e)})))}return i}_isPickable(e,t){var i=!0;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isPickable(e))}),(function(e){return!i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isPickable(e),this.filterHelper._executeCallbackWithPlugins(r,(t=>{i=i||t.getFilter()._isPickable(e)})))}return i}initFilterManager(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){if(t.getFilter()){var i={};i[t.id]=e[t.id]||{},t.getFilter().initFilterManager(i)}}));else{var i=this.modelManager.getModel(t);if(i&&i.getFilter()){var r={};r[t]=e[t]||{},i.getFilter().initFilterManager(r)}}}reinitFilterManager(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){if(t.getFilter()){var i={};i[t.id]=e[t.id]||{},t.getFilter().reinitFilterManager(i)}}));else{var i=this.modelManager.getModel(t);if(i&&i.getFilter()){var r={};r[t]=e[t]||{},i.getFilter().reinitFilterManager(r)}}}clearFilterManager(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearFilterManager()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearFilterManager()}}isStateChanged(e){var t=!1,i=this.modelManager;if(void 0===e)i.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isStateChanged())}),(function(e){return t||!e.isUseable()}));else{var r=i.getModel(e);r&&r.getFilter()&&(t=r.getFilter().isStateChanged(),this.filterHelper._executeCallbackWithPlugins(r,(e=>{t=t||e.getFilter().isStateChanged()})))}return t}disableStateChanged(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().disableStateChanged()}));else{var i=t.getModel(e);i&&i.getFilter()&&(i.getFilter().disableStateChanged(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{e.getFilter().disableStateChanged()})))}}isVisibleStateChanged(e){var t=!1,i=this.modelManager;if(void 0===e)i.traverseModels((e=>{e.getFilter()&&(t=t||e.getFilter().isVisibleStateChanged())}));else{var r=i.getModel(e);r&&r.getFilter()&&(t=r.getFilter().isVisibleStateChanged(),this.filterHelper._executeCallbackWithPlugins(r,(e=>{t=t||e.getFilter().isVisibleStateChanged()})))}return t}disableVisibleStateChanged(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().disableVisibleStateChanged()}));else{var i=t.getModel(e);i&&i.getFilter()&&(i.getFilter().disableVisibleStateChanged(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{e.getFilter().disableVisibleStateChanged()})))}}isColorStateChanged(e){let t=!1;const i=this.modelManager;if(void 0===e)i.traverseModels((e=>{e.getFilter()&&(t=t||e.getFilter().isColorStateChanged())}));else{const r=i.getModel(e);r&&r.getFilter()&&(t=r.getFilter().isColorStateChanged(),this.filterHelper._executeCallbackWithPlugins(r,(e=>{t=t||e.getFilter().isColorStateChanged()})))}return t}disableColorStateChanged(e){const t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().disableColorStateChanged()}));else{const i=t.getModel(e);i&&i.getFilter()&&(i.getFilter().disableColorStateChanged(),this.filterHelper._executeCallbackWithPlugins(i,(e=>{e.getFilter().disableColorStateChanged()})))}}isTileLoadedStateChanged(e){let t=!1;const i=this.modelManager;if(void 0===e)i.traverseModels((e=>{e.getFilter()instanceof r.BimTileFilterManager&&(t=e.getFilter().isTileLoadedStateChanged())}),(e=>t||!e.isUseable()));else{const n=i.getModel(e).getFilter();n instanceof r.BimTileFilterManager&&(t=n.isTileLoadedStateChanged())}return t}disableTileLoadedStateChanged(e){const t=this.modelManager;if(void 0===e)t.traverseValidModels((e=>{const t=e.getFilter();t instanceof r.BimTileFilterManager&&t.disableTileLoadedStateChanged()}));else{const i=t.getModel(e).getFilter();i instanceof r.BimTileFilterManager&&i.disableTileLoadedStateChanged()}}calculateVisibleComponentsBbox(){const e=this.modelManager.isBimtilesAsset();this.modelManager.traverseValidModels((function(t){if(t.getFilter()){var i=!0;if(e&&!t.modelLoaded)return;"ExternalComponent"==t.id&&(t.checkVisibleComponentsBox()||(i=!1)),i&&t.getFilter().getObjectInfoManager().calculateVisibleComponentsBbox()}}))}getVisibleComponentsBbox(){var e,t=new THREE.Box3;return this.modelManager.traverseValidModels((function(i){if(i.getFilter()&&!(e=i.getFilter().getVisibleComponentsBbox()).isEmpty()){let r=i.getTransformMatrix();e.applyMatrix4(r),t.union(e)}})),t}getInvisibleComponentsBboxes(e=[]){let t=!0,i=500,r=0;return this.modelManager.traverseValidModels((n=>{if(!t)return;const a=n.getFilter();if(a){const s=a.filterActionList;for(const a of s)switch(a.className){case"VisibleConditionFA":case"TransparentConditionFA":return void(t=!1);case"VisibleIdsFA":case"TransparentIdsFA":if(!(void 0!==a.isVisible?a.isVisible:a.isOpaque)){const s=a.ids;if(i-=a.ids.length,i<=0)return void(t=!1);for(const t of s)n.getNodeInfosByUserId(t).map((t=>{e[r]=t.boundingBox,++r}))}}}})),t}setObserverForSceneState(e){this.observerForSceneState=e}getObserverForSceneState(){return this.observerForSceneState}isComponentActive(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isComponentActive(t))}),t),i}needUpdateBoxAfterExplode(){var e=!1;return this.modelManager.traverseModels((function(t){t.getFilter()&&(e=t.getFilter().needUpdateBoxAfterExplode())}),(function(t){return e||!t.isUseable()})),e}getVisibleComponentArray(e){var t=[];return this.modelManager.traverseValidModels((function(i){if(i.getFilter()){var r=i.getFilter().getVisibleComponentArray(e);for(var n of r)i.isUserIdExist(n)&&t.push(n)}})),t}getVisibleComponentSetWithModelId(e){let t={};for(const i in e){const r=this.modelManager.getModel(i);if(!r||!r.getFilter())continue;const n=r.getFilter().getVisibleComponentArray(e[i]);t[i]={};for(const e of n)r.isUserIdExist(e)&&(t[i][e]=e)}return t}saveState(){var e={};this.modelManager.traverseValidModels((function(t){t.getFilter()&&(e[t.id]=t.getFilter().saveState())}));for(let t in e){const i=e[t].actions;if(!i)return;const r=i.length;for(let e=0;e<r;++e){const t=i[e];if(!t.material||!t.material.map)continue;if(!t.material.clone)continue;const r=t.material.clone();r.map=null,t.material=r}}return JSON.stringify(e)}loadState(e){var t=JSON.parse(e);t.version?this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().loadState(t)})):this.modelManager.traverseValidModels((function(e){e.getFilter()&&t[e.id]&&e.getFilter().loadState(t[e.id])}))}getObjectsMap(e){var t={},i=this.modelManager;if(void 0===e)i.traverseValidModels((function(e){if(e.getFilter()){var i=e.getFilter().getObjectInfoManager().getObjectsMap();for(var r in i)t[r]=i[r]}}));else{var r=i.getModel(e);if(r&&r.getFilter()){var n=r.getFilter().getObjectInfoManager().getObjectsMap();for(var a in n)t[a]=n[a]}}return t}deactivateAll(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().deactivateAll()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().deactivateAll()}}activateAll(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().activateAll()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().activateAll()}}getInactivatedIdMap(e){const t=this.modelManager;if(e){const i=t.getModel(e);if(!i||!i.getFilter())return;return i.getFilter().getInactivatedIdMap()}let i={};return t.traverseValidModels((e=>{e.getFilter()&&(i[e.id]=e.getFilter().getInactivatedIdMap())})),i}staticTimeInit(e){var t=this.modelManager.getModel(e);t instanceof r.BimTilesModel&&t.changeStateTime.init()}},r.ModelView.FilterHelper=class{constructor(e){this.modelManager=e}destroy(){this.modelManager=null}distributeIdsByModelId(e){for(var t={},i=this.modelManager.getModelIds(!0),r=[],n=function(e,i){e&&(e=e.toString(),t[e]||(t[e]=[]),"[object String]"===Object.prototype.toString.call(i)?t[e].push(i):"[object Array]"===Object.prototype.toString.call(i)&&(t[e]=t[e].concat(i)))},a=0;a<e.length;a++){var{modelId:s,objectId:o}=this.distributeId(e[a]);s?n(s,o):r.push(o)}if(r.length>0)for(var l=0;l<i.length;l++)n(i[l],r);return t}distributeId(e){if(!e)return{modelId:void 0,objectId:e};var t,i,r=/\[(.*?)\](.*)/.exec(e.toString());return r?(t=r[1],i=r[2],this.modelManager.getModelIds(!0).indexOf(t)<0&&(t=void 0,i=e)):i=e,{modelId:t,objectId:i}}distributeConditionsByModelId(e){for(var t={},i=this.modelManager.getModelIds(!0),r=[],n=function(e,r){e&&(e=e.toString(),i.indexOf(e)>=0&&(t[e]||(t[e]=[]),"[object Object]"===Object.prototype.toString.call(r)?t[e].push(r):"[object Array]"===Object.prototype.toString.call(r)&&(t[e]=t[e].concat(r))))},a=0;a<e.length;a++){var s=e[a];if(s.hasOwnProperty("modelId")){var o=s.modelId;delete s.modelId,n(o,s)}else r.push(s)}if(r.length>0)for(var l=0;l<i.length;l++)n(i[l],r);return t}executeConditions(e,t,i){if(i)(a=this.modelManager.getModel(i))&&a.getFilter()&&(e&&0!==e.length?(r=this.distributeConditionsByModelId(e))[i]&&("[object Function]"===Object.prototype.toString.call(t)&&t(a,r[i]),this._executeCallbackWithPlugins(a,t,r[i])):("[object Function]"===Object.prototype.toString.call(t)&&t(a,e),this._executeCallbackWithPlugins(a,t,e)));else if(e&&0!==e.length){var r=this.distributeConditionsByModelId(e);for(var n in r){var a=this.modelManager.getModel(n),s=r[n];a&&a.getFilter()&&s&&s.length>0&&("[object Function]"===Object.prototype.toString.call(t)&&t(a,s),this._executeCallbackWithPlugins(a,t,s))}}else this.modelManager.traverseValidModels((function(i){i.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}))}executeIds(e,t,i){if(i)(a=this.modelManager.getModel(i))&&a.getFilter()&&(e&&0!==e.length?(r=this.distributeIdsByModelId(e))[i]&&("[object Function]"===Object.prototype.toString.call(t)&&t(a,r[i]),this._executeCallbackWithPlugins(a,t,r[i])):("[object Function]"===Object.prototype.toString.call(t)&&t(a,e),this._executeCallbackWithPlugins(a,t,e)));else if(e&&0!==e.length){var r=this.distributeIdsByModelId(e);for(var n in r){var a=this.modelManager.getModel(n),s=r[n];a&&a.getFilter()&&s&&s.length>0&&("[object Function]"===Object.prototype.toString.call(t)&&t(a,s),this._executeCallbackWithPlugins(a,t,s))}}else this.modelManager.traverseValidModels((function(i){i.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}))}executeId(e,t,i){var r,{modelId:n,objectId:a}=this.distributeId(e);i?n&&n.toString()!==i.toString()||(r=this.modelManager.getModel(i))&&r.getFilter()&&("[object Function]"===Object.prototype.toString.call(t)&&t(r,a),this._executeCallbackWithPlugins(r,t,a)):n?(r=this.modelManager.getModel(n))&&r.getFilter()&&("[object Function]"===Object.prototype.toString.call(t)&&t(r,a),this._executeCallbackWithPlugins(r,t,a)):this.modelManager.traverseValidModels((function(e){e.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(e,a)}))}_executeCallbackWithPlugins(e,t,i){"[object Function]"===Object.prototype.toString.call(t)&&e.traversePluginModels&&e.traversePluginModels((e=>{t(e,i)}),!0)}},r.BlinkManager=class{constructor(e){this._manager=e,this.modelCollection=e.modelCollection,this.sceneState=e.sceneState,this.blinkStartTimeMap={},this.blinkLastTimeMap={},this.positiveSequenceMap={},this.blinkTimesMap={},this.blinkEnabled=!1,this.blinkPermited=!1,this.defaultBlinkColor=r.Blink.DefaultBlinkColor.color,this.defaultBlinkAlpha=r.Blink.DefaultBlinkColor.opacity,this.blinkColorMap={},this.blinkIntervalTimeMap={}}destroy(){this.blinkIntervalTimeMap=null,this.defaultBlinkColor=null,this.blinkColorMap=null,this.blinkStartTimeMap=null,this.blinkLastTimeMap=null,this.positiveSequenceMap=null,this.blinkTimesMap=null,this.sceneState=null,this.modelCollection=null,this._manager=null}getBlinkMaterials(e){if(e)return this.modelCollection.getById(e).getBlinkMaterials();let t={};return this.modelCollection.traverse((e=>{e.getBlinkMaterials&&(t[e.id]=e.getBlinkMaterials())})),t}resetBlinkMaterial(e){const t=this.getBlinkMaterials(e);if(e)for(let e=0,i=t.length;e<i;e++)t[e].resetBlinkUniformValue();else for(let e in t){const i=t[e];for(let e=0,t=i.length;e<t;e++)i[e].resetBlinkUniformValue()}}updateBlinkMaterial(e){const t=e=>{var t=this.getBlinkColor(e),i=this.getBlinkMaterials(e);if(0!=i.length){var n=this._manager.getModel(e),a=0,s=r.EnumShaderColorState.BLINK;this.blinkIntervalTimeMap[e]=this.blinkIntervalTimeMap[e]||600;var o=this.blinkIntervalTimeMap[e];if(n&&n.updateBlinkMaterial)n.updateBlinkMaterial(o);else{var l=Date.now();if(void 0===this.blinkStartTimeMap[e]&&(this.positiveSequenceMap[e]=!0,this.blinkStartTimeMap[e]=l,this.blinkLastTimeMap[e]=l),!(l-this.blinkLastTimeMap[e]<=100)){l-this.blinkStartTimeMap[e]>o&&(this.positiveSequenceMap[e]=!this.positiveSequenceMap[e],this.blinkStartTimeMap[e]=l,this.blinkLastTimeMap[e]=l);var d=(l-this.blinkStartTimeMap[e])/o;a=this.positiveSequenceMap[e]?d:1-d;for(var h=0,c=i.length;h<c;h++)i[h].updateBlinkUniformValue(s,t,a);this.blinkLastTimeMap[e]=l}}}},i=this.sceneState.getBlinkComponentIdsDetailMap();if(Object.keys(i).length>0)this.updateBlinkMaterialByMap(i);else if(e)t(e);else{var n=this.getBlinkMaterials();Object.keys(n).forEach((e=>{t(e)}))}}clearTime(e){this.blinkTimesMap[e]=0}updateBlinkMaterialByMap(e){for(const t in e){const i=e[t];if(!1===i.enable)continue;if(void 0===i.materials){i.models.map((e=>{const t=e.modelId;var i=this._manager.getModel(t);i&&i.updateBlinkMaterial&&i.updateBlinkMaterial()}));continue}const n=i.detail,a=i.materials;let s=0;const o=r.EnumShaderColorState.BLINK,l=n.interval,d=100,h=Date.now();this.blinkTimesMap[t]=null==this.blinkTimesMap[t]?0:this.blinkTimesMap[t],n.color&&(this.blinkColorMap[t]=this.blinkColorMap[t]||new THREE.Vector4,this.blinkColorMap[t].set(n.color.red/255,n.color.green/255,n.color.blue/255,n.color.alpha));const c=this.blinkColorMap[t];if(void 0===this.blinkStartTimeMap[t]&&(this.positiveSequenceMap[t]=!0,this.blinkStartTimeMap[t]=h,this.blinkLastTimeMap[t]=h),h-this.blinkLastTimeMap[t]<=d)return;if(h-this.blinkStartTimeMap[t]>l&&(this.positiveSequenceMap[t]=!this.positiveSequenceMap[t],this.blinkStartTimeMap[t]=h,this.blinkLastTimeMap[t]=h,n.times&&(this.blinkTimesMap[t]++,this.blinkTimesMap[t]==2*n.times)))return this.blinkTimesMap[t]=0,void this.sceneState.clearBlinkComponentsByDetail(t);const u=(h-this.blinkStartTimeMap[t])/l;s=this.positiveSequenceMap[t]?u:1-u,this.blinkLastTimeMap[t]=h;for(const e of a)e.updateBlinkUniformValue(o,c,s)}}getBlinkColor(e){return this.blinkColorMap[e]||this.setBlinkColor(void 0,void 0,e),this.blinkColorMap[e]}setBlinkColor(e,t,i){const n=i=>{if(!this.blinkColorMap[i]&&(this.blinkColorMap[i]=new THREE.Vector4),e){var n=r.Utils.hexToRgb(e);this.blinkColorMap[i].fromArray([n.r,n.g,n.b,t||1])}else this.blinkColorMap[i].set(this.defaultBlinkColor.r,this.defaultBlinkColor.g,this.defaultBlinkColor.b,this.defaultBlinkAlpha)};if(i)n(i);else{var a=this.getBlinkMaterials();Object.keys(a).forEach((e=>{n(e)}))}}setBlinkIntervalTime(e,t){const i=t=>{this.blinkIntervalTimeMap[t]<=0||(this.blinkIntervalTimeMap[t]=e)};if(t)i(t);else{var r=this.getBlinkMaterials();Object.keys(r).forEach((e=>{i(e)}))}}enableBlink(e){this.blinkEnabled=e,!1===e&&(this.blinkStartTime=null,this.resetBlinkMaterial()),this.applyBlink()}getBlinkEnabled(){return!this.isBlinkPermited()&&this.blinkEnabled}getBlinkComponentsIdMap(e){return this.isBlinkPermited()?null:this.sceneState.getBlinkComponentsIdMap(e)}applyBlink(e){this.isBlinkPermited()||(this._manager.selectPriority=!1,e?this.modelCollection.getById(e).applyBlink():this.modelCollection.traverse((e=>{e.applyBlink()})))}clearBlink(e){this.isBlinkPermited()||(this._manager.selectPriority=!1,e?this.modelCollection.getById(e).clearBlink():this.modelCollection.traverse((e=>{e.clearBlink()})))}permitBlink(e){this.blinkPermited=e}isBlinkPermited(){return this.blinkPermited}},r.ModelView.LayerCollection=class{constructor(){this._layers=[],this._destroyed=!1,this.eventDispatcher=new r.EventDispatcher}get length(){return this._layers.length}destroy(){this._destroyed=!0,this.removeAll(!0),this.eventDispatcher.destroy(),this.eventDispatcher=null,this._layers=null}isDestroyed(){return this._destroyed}add(e){return!!e&&(!this.getById(e.id)&&(this._layers.push(e),void(void 0===e.sequence?e.sequence=this._layers.length-1:this.moveToIdx(e,e.sequence))))}remove(e,t){t=r.Utils.isDefined(t,!0);const i=this.getById(e);if(!i)return!1;this._layers.splice(this._layers.findIndex((t=>t.id==e)),1);const n=this._getByFilter();for(const e of n)!e.isDestroyed()&&e.sequence>i.sequence&&e.sequence--;return t&&i.destroy(),!0}removeAll(e){if(e){const e=this._getByFilter();for(let t=0,i=e.length;t<i;++t){if(e[t].isDestroyed())return;e[t].destroy()}}this._layers=[]}_getByFilter(e){const t=[];for(const i of this._layers)e&&!e(i)||t.push(i);return t}getById(e){return e&&(e=e.toString()),this._getByFilter((t=>t.id===e))[0]}getByIndex(e){return this._layers[e]}getMaxSequence(){return this._layers.length-1}getOrderedIds(){const e=Array.from(this._layers);return e.sort(((e,t)=>e.sequence-t.sequence)),e.map((e=>e.id))}getIds(){return this._layers.map((e=>e.id))}traverse(e,t){const i=t?Array.from(this._layers):this._layers;t&&i.sort(((e,t)=>e.sequence-t.sequence)),i.forEach((t=>e(t)))}traverseIf(e,t){const i=this._layers;for(let r=0,n=i.length;r<n;++r){let n=i[r];if(t&&t(n))break;e&&e(n)}}some(e){return this._layers.some((t=>e(t)))}moveToIdx(e,t){const i=this._layers,n=r.Math.clamp(t,0,i.length-1),a=e.sequence;for(const t of i)t.id===e.id?t.sequence=n:t.sequence>a&&t.sequence<=n?t.sequence--:t.sequence>=n&&t.sequence<a&&t.sequence++}shiftDown(e){e.sequence>0&&this.moveToIdx(e,e.sequence-1)}shiftUp(e){const t=this.getMaxSequence();e.sequence<t&&this.moveToIdx(e,e.sequence+1)}},r.ModelLoader=class{constructor(){this.loader=new THREE.FileLoader}destroy(){this.loader=null}load(e,t,i){var n=new r.Loader.Url({serverUrl:e.parameters.serverUrl,databagId:e.parameters.databagId,lightmapDatabagId:e.parameters.lightmapDatabagId,lightmapServerUrl:e.parameters.lightmapServerUrl});if(null==e.parameters.metaData){var a=this,s=this.loader;s.setResponseType("");var o=n.projectUrl();r.Storage.IndexedDBHelper.loadWithStorage("InfoData",o,(()=>new Promise(((e,t)=>{s.load(o,e,void 0,t)}))),(n=>{var s;try{s=JSON.parse(n)}catch(e){return i(e),void r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}var o=a.getModel(s,e);if(!r.Utils.CheckBimtilesVersionMatch(r.BimtileVersion,s.metadata))return i("Version mismatch"),void e.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_MODEL_VERSION,modelId:o.id});t&&t(o)}),(e=>{console.log("Config load error!"),i(e),r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}))}else{let i={};i.metadata=e.parameters.metaData,i.coordinateSystem=e.parameters.coordinateSystem;let r=this.getModel(i,e);t&&t(r)}}getModel(e,t){let i=e.metadata.asset?e.metadata.asset:"bmd";r.Utils.isDefined(e.metadata.FeatureType)&&"point"===e.metadata.FeatureType&&"0.0.1"===e.metadata.version&&(i="point"),"bmd"!==i&&"point"!==i&&e.metadata.content&&"bim"!==e.metadata.content&&(i="standardtiles"),"bmd"===i||"point"===i||!e.metadata.content||"osgb"!==e.metadata.content&&"3dtiles"!==e.metadata.content||(i="ObliquePhotography"),t.parameters.fileType&&!e.metadata.content&&(e.metadata.content=t.parameters.fileType);const n=e.metadata.root?e.metadata.root:void 0;t.parameters.rootPath=n;const a=e.metadata.FeatureType?"shp":e.metadata.content?e.metadata.content:"bim";t.parameters.resourceType=a;const s=!!(!0===e.metadata.onDemand||t.parameters.loadConfig&&!0===t.parameters.loadConfig.onDemand);t.parameters.onDemand=s;const o=!0===e.metadata.layer;t.parameters.demandConditions=t.parameters.loadConfig&&t.parameters.loadConfig.condition,t.parameters.hasLayerInfo=o;const l=void 0===e.metadata.detailLevel?[]:e.metadata.detailLevel;if(t.parameters.detailLevelList=l,t.parameters.visualRange=t.parameters.loadConfig&&t.parameters.loadConfig.visualRange,t.parameters.disableUserData=!(!t.parameters.loadConfig||!0!==t.parameters.loadConfig.disableUserData),t.parameters.enableBorderLine=!(!t.parameters.loadConfig||!0!==t.parameters.loadConfig.enableBorderLine),t.parameters.maxDetailLevel=t.parameters.loadConfig&&t.parameters.loadConfig.maxDetailLevel,t.parameters.wireFrameVisibilityOption=!t.parameters.loadConfig||void 0===t.parameters.loadConfig.wireFrameVisibilityOption||t.parameters.loadConfig.wireFrameVisibilityOption,t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_1,t.parameters.config=e,t.parameters.sequence=t.priority,t.parameters.loadConfig&&t.parameters.loadConfig.lightmapDatabagId&&(t.parameters.lightmapDatabagId=t.parameters.loadConfig.lightmapDatabagId,t.parameters.lightmapServerUrl=t.parameters.loadConfig.lightmapServerUrl),e.metadata&&"BimtilesCompiler v0.02"===e.metadata.generateTool)t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_2;else if(e.metadata&&"BimtilesCompiler v0.03"===e.metadata.generateTool)return t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_3,t.parameters.disableUserData=!1,r.ModelFactory.bimtilesV3(t.viewer,t.manager,t.parameters,t.index,t.parseCfgFinish,t.debut);return r.ModelFactory[i](t.viewer,t.manager,t.parameters,t.index,t.parseCfgFinish,t.debut)}},r.ModelFactory={pointCloud:function(e,t,i,n,a,s){return new r.PointCloudModel(e,t,i,n,a,s)},"3dtiles":function(e,t,i,n,a,s){return new r.$3dTilesModel(e,t,i,n,a,s)},dem:function(e,t,i,n,a,s){return new r.DemModel(e,t,i,n,a,s)},bimtile:function(e,t,i,n,a,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModel:r.BimTilesModel)(e,t,i,n,a,s)},bimtiles:function(e,t,i,n,a,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModel:r.BimTilesModel)(e,t,i,n,a,s)},bimtilesV3:function(e,t,i,n,a,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModelV3:r.BimTilesModelV3)(e,t,i,n,a,s)},standardtiles:function(e,t,i,n,a,s){return new r.StandardTilesModel(e,t,i,n,a,s)},ObliquePhotography:function(e,t,i,n,a,s){return new r.ObliquePhotographyModel(e,t,i,n,a,s)},point:function(e,t,i,n,a,s){return new r.PointModel(e,t,i,a,s)},bmd:function(e,t,i,n,a,s){return new r.Model(t,i,n,a,s)},globe:function(e,t){return new r.Layer.GlobeLayer(e,t)}},function(){const e={split(e,t){if(e.indexOf("m.bimface.com")>=0||e.indexOf("m-test.bimface.com")>=0||window.hostConfig&&window.hostConfig.enableUrlSplit){let i=/http[s]?(:\/\/m[1]?[0-9]?(-test)?.)/.exec(e);if(i){let r=i[1],n=r.indexOf("-test")>=0?"-test":"";e=e.replace(r,`://m${t}${n}.`)}}return e},getHostNumByReg(e,t){let i=t.exec(e),r=i?i[1].charCodeAt()%10:0;return r+=1,r},splitByDatabagId(e){return this.split(e,this.getHostNumByReg(e,/.*\/(.+?).*\/resource/))},splitByTextureName(e){return this.split(e,this.getHostNumByReg(e,/texture\/(.+?).*/))},splitByContextId(e,t){const i=parseInt(t)%10+1;return this.split(e,i)},splitByUrlMd5(e){if(!0!==r.GlobalData.EnableDomainDiversion)return e;const t=r.Utils.charCodeUrl(e)%10+1;return this.split(e,t)}};r.RequestSpliter=e}(),function(){class e{static getBox(e,t){const i=new THREE.Box3;if(Array.isArray(e)&&e.length>=6&&i.setFromArray(e),e.region){const t=e.region;i.set(THREE.Math.radToDeg(t[0]),THREE.Math.radToDeg(t[2]),THREE.Math.radToDeg(t[1]),THREE.Math.radToDeg(t[3]))}if(e.box){const t=e.box,r=new THREE.Vector3(t[0],t[1],t[2]),n=r.x-Math.abs(t[3]),a=r.x+Math.abs(t[3]),s=r.y-Math.abs(t[7]),o=r.y+Math.abs(t[7]),l=r.z-Math.abs(t[11]),d=r.z+Math.abs(t[11]);i.set(new THREE.Vector3(n,s,l),new THREE.Vector3(a,o,d))}if(e.sphere){const t=new THREE.Sphere(new THREE.Vector3(e.sphere[0],e.sphere[1],e.sphere[2]),e.sphere[3]);i.copy(t.getBoundingBox())}return t&&i.applyMatrix4(t),i}static getDracoLibUrl(){return r.GlobalData.DracoLibUrl?r.GlobalData.DracoLibUrl:window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?(r.GlobalData.DracoLibUrl=window.BimfaceLoaderConfig.fullStaticHost+"/lib/draco/",r.GlobalData.DracoLibUrl):(r.GlobalData.DracoLibUrl="../../lib/draco/",r.GlobalData.DracoLibUrl)}static getDracoLoader(){return void 0===this.dracoLoader&&(this.dracoLoader=new THREE.DRACOLoader,this.dracoLoader.setDecoderPath(r.TilesUtil.getDracoLibUrl())),this.dracoLoader}static getProtobufLibUrl(){return r.GlobalData.ProtobufLibUrl?r.GlobalData.ProtobufLibUrl:window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?(r.GlobalData.ProtobufLibUrl=window.BimfaceLoaderConfig.fullStaticHost+"/lib/protobuf/",r.GlobalData.ProtobufLibUrl):(r.GlobalData.ProtobufLibUrl="../../lib/protobuf/",r.GlobalData.ProtobufLibUrl)}static getProtobufDecoder(){return void 0===this.protobufDecoder&&(this.protobufDecoder=new r.Loader.TilesWorkerDecoder,this.protobufDecoder.setDecoderPath(r.TilesUtil.getProtobufLibUrl())),this.protobufDecoder}static praseUserData(e){if(void 0===e)return;if(!(e.length>0))return e;let t={};return e.map((e=>{t[e[0]]=e[1]})),t}static getDebugColor(e,t){if(-1===e)return r.Debug.DebugColor.BLACK;if(!t)return r.Debug.DebugColor.GRAY;const i=r.Debug.DebugColorArray;return i[e%i.length]}static nodeIndexGroupsSort(e){let t=[];for(const[i,r]of e)for(const e of r.values())t.push({userId:i,indexGroup:e});return t.sort(((e,t)=>e.indexGroup.indexStart-t.indexGroup.indexStart)),t}static matchWireFrameVisibilityOption(e,t){return t instanceof Object?void 0!==t.ids&&t.ids[e]?t.isVisible:!t.isVisible:t}static isNodeInVisible(e){return!(e&&!1!==e.visible&&(!e.parent||!1!==e.parent.visible))}static isInstanceNodeInVisible(e){return!e||!1===e.visible||void 0===e.geometry}}e.max_uncompressed_blob_size=8388608,e.TILE_DATA_INDEX="INDEX",e.TILE_DATA_USERDATA="USERDATA",e.TILE_DATA_MATERIAL="MATERIAL",e.TILE_TEXTURE_NONE="TEXTURENONE",e.TILE_TEXTURE_LOADING="TEXTURE_LOADING",e.TILE_TEXTURE_LOADED="TEXTURELOADED",e.TWO_ACCURACY=.01,e.SIX_ACCURACY=1e-7,e.BMD_GEOMETRIC_ERROR_COEFFICIENT=1,e.OP_GEOMETRIC_ERROR_COEFFICIENT=.25,e.Minimum_Setting_SSEHold=.001,e.MODEL_SSE_Threshold_MAP={"3dtiles":e.OP_GEOMETRIC_ERROR_COEFFICIENT,osgb:e.OP_GEOMETRIC_ERROR_COEFFICIENT,shp:e.OP_GEOMETRIC_ERROR_COEFFICIENT,bim:e.BMD_GEOMETRIC_ERROR_COEFFICIENT},e.PICK_EFFECT_MODEL_TYPE={bim:!0,shp:!0,kml:!0,citygml:!0,dwg:!0},r.TilesUtil=e}(),function(){const e=(new THREE.FileLoader).setResponseType("json"),t=(new THREE.FileLoader).setResponseType("arraybuffer");class i{constructor(e){this._url=e.url,this._request=e.request,this._retryCallback=e.retryCallback,this._retryTimes=r.Utils.defaultValue(e.retryTimes,2),this._retryCount=0}destroy(){this._request=void 0,this._retryCallback=void 0}clone(e){return e||(e=new i),e._url=this._url,e._retryCallback=this._retryCallback,e._retryTimes=this._retryTimes,e._retryCount=0,this._request&&(e._request=this._request.clone()),e}fetch(e){return this._makeRequest(e)}set request(e){this._request=e}get request(){return this._request}setRequest(e){this._request=e}set url(e){this._url=e}get url(){return this._url}_checkRequest(e){return e.state===r.RequestState.ISSUED||e.state===r.RequestState.ACTIVE?(console.log("The Resource is already being fetched."),!1):(e.state=r.RequestState.UNISSUED,e.deferred=void 0,!0)}_getFetchCallback(i){return i.fetchCallback?i.fetchCallback:"arraybuffer"===i.responseType?t.load:e.load}_makeRequest(e){const t=this._request;if(!this._checkRequest(this._request))return;const i=this._getFetchCallback(e);t.url=this._url,t.requestCallback=function(){const e=new r.Deferred;return i(t.url,(function(t){e.resolve(t)}),(function(t){e.reject(t)})),t.cancelCallback=function(){},e.promise};const n=r.RequestScheduler.request(t);return n?n.then((function(e){return t.cancelCallback=void 0,e})).catch((function(e){return t.cancelCallback=void 0,Promise.reject(e)})):void 0}retryOnError(){return!(this._retryCount>=this._retryTimes)&&(++this._retryCount,!0)}_fetchArrayBuffer(){return this._makeRequest({fetchCallback:t.load})}static fetchArrayBuffer(e){return i.create(e)._fetchArrayBuffer()}_fetchJson(){return this._makeRequest({fetchCallback:e.load})}static fetchJson(e){return i.create(e)._fetchJson()}static create(e){return new i(e)}static fromUrl(e,t){const r=i.create({url:e});return t.request&&(r._request=t.request),t.retryCallback&&(r._retryCallback=t.retryCallback),t.retryTimes&&(r._retryTimes=t.retryTimes),r}static createIfNeeded(e){return e instanceof i?e.fromResource({request:e.request}):"string"!=typeof e?e:i.create({url:e})}fromResource(e){const t=this.clone();return e.request&&(t._request=e.request),e.retryCallback&&(t._retryCallback=e.retryCallback),e.retryTimes&&(t._retryTimes=e.retryTimes),t}}r.Resource=i}(),function(){r.RequestState=Object.freeze({UNISSUED:0,ISSUED:1,ACTIVE:2,RECEIVED:3,CANCELLED:4,FAILED:5});r.RequestType=Object.freeze({TERRAIN:0,IMAGERY:1,BIMTILES:2,OTHER:3})}(),function(){class e{constructor(e){e=e||{},this.url=e.url,this.requestCallback=e.requestCallback,this.cancelCallback=e.cancelCallback,this.priorityCallback=e.priorityCallback,this.priority=r.Utils.defaultValue(e.priority,0),this.throttle=r.Utils.defaultValue(e.throttle,!0),this.throttleByServer=r.Utils.defaultValue(e.throttleByServer,!0),this.type=r.Utils.defaultValue(e.type,r.RequestType.OTHER),this.state=r.RequestState.UNISSUED,this.deferred=void 0,this.cancelled=!1,this.destroyed=!1}destroy(){this.destroyed=!0,this.requestCallback=void 0,this.cancelCallback=void 0,this.priorityCallback=void 0,this.deferred=this.deferred&&this.deferred.destroy()}isDestroyed(){return this.destroyed}cancel(){this.cancelled=!0}clone(t){return t?(t.url=this.url,t.requestCallback=this.requestCallback,t.cancelCallback=this.cancelCallback,t.priorityCallback=this.priorityCallback,t.priority=this.priority,t.state=r.RequestState.UNISSUED,t.deferred=void 0,t.cancelled=!1,t):new e(this)}}r.Request=e}(),function(){function e(){function e(e){e.priorityCallback&&(e.priority=e.priorityCallback())}function t(e){if(!e.isDestroyed())return e.state===r.RequestState.UNISSUED&&(e.state=r.RequestState.ISSUED,e.deferred=new r.Deferred),e.deferred.promise}function i(e){if(e.isDestroyed())return;const i=t(e);return e.state=r.RequestState.ACTIVE,l.push(e),++a.numberOfActiveRequests,++c,e.requestCallback().then(function(e){return function(t){if(e.state===r.RequestState.CANCELLED)return;--a.numberOfActiveRequests,--c,u.fireEvent(),e.state=r.RequestState.RECEIVED;const i=e.deferred;e.deferred=void 0,i.resolve(t)}}(e)).catch(function(e){return function(t){e.state!==r.RequestState.CANCELLED&&(++a.numberOfFailedRequests,--a.numberOfActiveRequests,--c,u.fireEvent(t),e.state=r.RequestState.FAILED,e.deferred&&e.deferred.reject(t))}}(e)),i}function n(e){const t=e.state===r.RequestState.ACTIVE;if(e.state=r.RequestState.CANCELLED,++a.numberOfCancelledRequests,e.deferred){const t=e.deferred;e.deferred=void 0,t.reject("cancelRequest:"+e.url)}t&&(--a.numberOfActiveRequests,--c,++a.numberOfCancelledActiveRequests),e.cancelCallback&&e.cancelCallback()}let a={numberOfAttemptedRequests:0,numberOfActiveRequests:0,numberOfCancelledRequests:0,numberOfCancelledActiveRequests:0,numberOfFailedRequests:0,numberOfActiveRequestsEver:0,lastNumberOfActiveRequests:0},s=10,o=new r.Heap({comparator:function(e,t){return e.priority-t.priority}});o.maximumLength=s,o.reserve(s);let l=[],d=10,h=18,c=0;const u=new r.Event;class p{static get maxRequests(){return d}static set maxRequests(e){d=e}static get throttleRequests(){return true}static get maxRequestsByServer(){return h}static set maxRequestsByServer(e){h=e}static get statistics(){return a}static get priorityHeapLength(){return s}static get requestHeap(){return o}static set priorityHeapLength(e){if(e<s)for(;o.length>e;){n(o.pop())}s=e,o.maximumLength=e,o.reserve(e)}static hasOpenServerSlots(){const e=r.Utils.defaultValue(h,6);return c+1<=e}static update(){let t,a,s,d=0;for(t=0,a=l.length;t<a;++t)s=l[t],s.cancelled&&n(s),s.state===r.RequestState.ACTIVE?d>0&&(l[t-d]=s):++d;l.length-=d;const h=o.internalArray;for(t=0,a=o.length;t<a;++t)e(h[t]);o.resort();const c=Math.max(p.maxRequests-l.length,0);let u=0;for(;u<c&&o.length>0;)s=o.pop(),s&&(s.cancelled?n(s):!s.throttleByServer||p.hasOpenServerSlots()?(i(s),++u):n(s))}static request(r){if(++a.numberOfAttemptedRequests,p.throttleRequests&&r.throttleByServer&&!p.hasOpenServerSlots())return;if(!p.throttleRequests||!r.throttle)return i(r);if(l.length>=p.maxRequests)return;e(r);const s=o.insert(r);if(s){if(s===r)return;n(s)}return t(r)}static clear(){for(;o.length>0;){n(o.pop())}for(let e=0,t=l.length;e<t;++e)n(l[e]);l.length=0,c=0,a.numberOfAttemptedRequests=0,a.numberOfActiveRequests=0,a.numberOfCancelledRequests=0,a.numberOfCancelledActiveRequests=0,a.numberOfFailedRequests=0,a.numberOfActiveRequestsEver=0,a.lastNumberOfActiveRequests=0}}return p}r.RequestScheduler=e(),r.GlobeTileRequestScheduler=e()}(),r.FrameState=class{constructor(){this.frameNumber=0,this.newFrame=!1,this.time=void 0,this.camera=void 0,this.cameraPositionWc=new THREE.Vector3,this.cameraDirectionWc=new THREE.Vector3,this.cullingVolume=void 0,this.pixelRatio=window.devicePixelRatio||1,this.maximumScreenSpaceError=void 0,this.viewSize={width:0,height:0},this.globalInverseMatrix=void 0,this.globalMatrix=void 0,this.transformMatrix=void 0,this.afterRenderFns=[],this.viewer=null,this.transformMatrixUpdated=!1,this.globalMatrixUpdated=!1,this.geoErrScaleFactor=1}destroy(){this.afterRenderFns=void 0,this.viewSize=void 0,this.camera=void 0,this.cameraPositionWc=void 0,this.cameraDirectionWc=void 0,this.cullingVolume=void 0,this.globalInverseMatrix=void 0,this.globalMatrix=void 0,this.viewer=null}},r.Statistics=class{constructor(){this.selected=0,this.visited=0,this.numberOfAttemptedRequests=0,this.numberOfPendingRequests=0,this.numberOfTilesProcessing=0,this.numberOfTilesWithContentReady=0,this.numberOfTilesTotal=0,this.numberOfTilesLoadedTotal=0,this.numberOfTrianglesSelected=0,this.geometryByteLength=0,this.texturesByteLength=0}destroy(){}clear(){this.selected=0,this.visited=0,this.numberOfTrianglesSelected=0,this.numberOfAttemptedRequests=0}_updateMemoryCount(e,t,i){var r=e.trianglesLength,n=e.geometryByteLength,a=e.texturesByteLength;i?(this.geometryByteLength+=t?-n:n,this.texturesByteLength+=t?-a:a):this.numberOfTrianglesSelected+=t?-r:r}incrementSelectionCount(e){this._updateMemoryCount(e,!1,!1)}incrementGeometryMemoryCount(e){this.geometryByteLength+=e.geometryByteLength}incrementTextureMemoryCount(e){this.texturesByteLength+=e.texturesByteLength}decrementTextureMemoryCount(e){this.texturesByteLength-=e.texturesByteLength}incrementLoadCount(e){this._updateMemoryCount(e,!1,!0)}decrementLoadCount(e){this._updateMemoryCount(e,!0,!0)}incrementNumberOfPendingRequests(){++this.numberOfPendingRequests}decrementNumberOfPendingRequests(){--this.numberOfPendingRequests}getNumberOfPendingRequests(){return this.numberOfPendingRequests}incrementNumberOfTilesProcessing(){++this.numberOfTilesProcessing}decrementNumberOfTilesProcessing(){--this.numberOfTilesProcessing}getNumberOfTilesProcessing(){return this.numberOfTilesProcessing}incrementNumberOfAttemptedRequests(){++this.numberOfAttemptedRequests}decrementNumberOfAttemptedRequests(){--this.numberOfAttemptedRequests}getNumberOfAttemptedRequests(){return this.numberOfAttemptedRequests}incrementNumberOfTilesWithContentReady(){++this.numberOfTilesWithContentReady}decrementNumberOfTilesWithContentReady(){--this.numberOfTilesWithContentReady}getNumberOfTilesWithContentReady(){return this.numberOfTilesWithContentReady}incrementNumberOfTilesTotal(){++this.numberOfTilesTotal}decrementNumberOfTilesTotal(){--this.numberOfTilesTotal}getNumberOfTilesTotal(){return this.numberOfTilesTotal}copy(e){this.selected=e.selected,this.visited=e.visited,this.numberOfAttemptedRequests=e.numberOfAttemptedRequests,this.numberOfPendingRequests=e.numberOfPendingRequests,this.numberOfTilesProcessing=e.numberOfTilesProcessing,this.numberOfTilesWithContentReady=e.numberOfTilesWithContentReady,this.numberOfTilesTotal=e.numberOfTilesTotal,this.numberOfTrianglesSelected=e.numberOfTrianglesSelected,this.geometryByteLength=e.geometryByteLength,this.texturesByteLength=e.texturesByteLength}clone(){return(new this.constructor).copy(this)}},r.TileContentType={DATA_NULL:"NULL",DATA_TILE:"TILE",DATA_BIMTILE:"BIMTILE",DATA_MESH:"MESH",DATA_INSTANCE:"INSTANCE",DATA_B3DM:"B3DM",DATA_POINT:"POINT",DATA_LINE:"LINE",DATA_DEM:"DEM",DATA_CMPT:"CMPT",DATA_GLOBAL_USER_DATA:"GLOBAL_USER_DATA",DATA_GLOBAL_USER_ID:"GLOBAL_USER_ID",DATA_GLOBAL_NODE_ID:"GLOBAL_NODE_ID",DATA_GLOBAL_NODE_BOX:"GLOBAL_NODE_BOX",DATA_GLOBAL_USER_ID_BOX:"GLOBAL_USER_ID_BOX",DATA_GLOBAL_TILE_ID:"GLOBAL_TILE_ID",DATA_GLOBAL_MATERIAL:"GLOBAL_MATERIAL",DATA_GLOBAL_PRECUTTING_TREE:"DATA_GLOBAL_PRECUTTING_TREE"},r.TileContentState=Object.freeze({UNLOADED:0,LOADING:1,PROCESSING:2,CONSTRUCTING:3,READY:4,FAILED:5}),r.SharedGeometryState=Object.freeze({UNLOADED:0,PROCESSING:1,PROCESSED:2,FAILED:3,DESTROYED:4,CANCELED:5}),r.TileContentProcessState=Object.freeze({PENDING:0,LOADING:1,LOADED:2,PROCESSING:3,PROCESSED:4,CONSTRUCTING:5,CONSTRUCTED:6,READY:7,FAILED:8,SUB_PROCESSING:9,SUB_PROCESSED:10,LOD_ALL_PROCESSED:11}),r.Layer.ImageryState=Object.freeze({UNLOADED:0,TRANSITIONING:1,RECEIVED:2,TEXTURE_LOADED:3,READY:4,FAILED:5,INVALID:6,PLACEHOLDER:7}),r.Layer.TerrainState=Object.freeze({FAILED:0,UNLOADED:1,RECEIVING:2,RECEIVED:3,TRANSFORMING:4,TRANSFORMED:5,READY:6}),r.TilesCache=class{constructor(e){this._list=new r.DoublyLinkedList,this._sentinel=this._list.add(),this._trimTiles=!1,this._tilesCacheScheduler=e}destroy(){this._list=null,this._sentinel=null,this._tilesCacheScheduler=null}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){var t=e.cacheNode;t&&this._list.splice(this._sentinel,t)}add(e){e.cacheNode||(e.cacheNode=this._list.add(e))}unloadTile(e){var t=e.cacheNode;t&&(e._tileset.unloadTile(e),e.cacheNode=void 0,this._list.remove(t))}unloadTiles(){const e=this._trimTiles;this._trimTiles=!1;const t=this._list,i=this._sentinel;let n=t.head;for(;n!==i;){const t=n.item;n=n.next;const i=t._tileset;r.Utils.isDefined(i)&&(this._tilesCacheScheduler.isMemoryUsageExceeded()||e)&&this.unloadTile(t)}}trim(){this._trimTiles=!0}partialSort(){this._trimTiles||this._tilesCacheScheduler.isMemoryUsageExceeded()&&this._list.partialSort(this._sentinel)}},function(){function e(e,t){return e._priority-t._priority}let t=new THREE.Box3;class i{constructor(e){e=r.Utils.defaultValue(e,{}),this._destroyed=!1,this._id=e.id||"DefaultTileset",this._databagId=e.databagId||this._id,this._fileId=e.fileId||this._databagId,this._type=e.type||r.RequestType.BIMTILES,this._objectGroup=e.objectGroup||null,this._debugShowBoundingBox=e.debugShowBoundingBox||!1,this._debugShowGeometricError=e.debugShowGeometricError||!1,this.debugShowGeometricErrorHelper=e.debugShowGeometricErrorHelper,this._debugShowStatistics=e.debugShowStatistics||!1,this._transformMatrix=e.transformMatrix||new THREE.Matrix4,this._maxDetailLevel=e.maxDetailLevel,this._visualRange=e.visualRange,this._userInputWorking=e.userInputWorking,this.leavesLoadFirst=r.Utils.defaultValue(e._leavesLoadFirst,!0),this._sequence=0,this._geometricError=void 0,this._root=void 0,this._boundingBox=void 0,this._tilesCacheScheduler=e.tilesCacheScheduler,this._processingTiles=[],this._selectedTiles=[],this._requestedTiles=[],this._requestedTilesInFlight=[],this._priorityRange={max:{depth:0,distance:0,sse:0,foveate:0,availableDepth:0},min:{depth:0,distance:0,sse:0,foveate:0,availableDepth:0}},this._skipLodEnabled=e.skipLodEnabled||!1,this.maximumScreenSpaceError=r.Utils.defaultValue(e.maximumScreenSpaceError,16),this._foveatedConeLimit=r.Utils.defaultValue(e.foveatedConeLimit,{priorityEnabled:!1,foveatedConeFactor:1,foveatedSseRelaxation:0,degradedFactor:1}),this._degradeEnabled=!1,this.tileLoadedEvent=new r.Event,this.tileUnloadEvent=new r.Event,this.tileFailedEvent=new r.Event,this.onDemandManager=e.onDemandManager,this.hasLayerInfo=e.hasLayerInfo,this._traversalController=void 0;const t=e.loader?e.loader.dataVersion:void 0;this._createTraversalController(t),this.repeatPendingList=[],this.pendingList=[],this.shadowMapManager=new r.BimtilesShadowMapManager}destroy(){this._destroyed=!0,this._destroyAllTiles(),this._boundingBox=void 0,this._objectGroup=void 0,this._objectWireframeGroup=void 0,this._transformMatrix=void 0,this._tilesCacheScheduler=void 0,this._processingTiles=void 0,this._selectedTiles=void 0,this._requestedTiles=void 0,this._requestedTilesInFlight=void 0,this._priorityRange=void 0,this.tileLoadedEvent=void 0,this.tileUnloadEvent=void 0,this.tileFailedEvent=void 0,this.onDemandManager&&this.onDemandManager.destroy(),this.onDemandManager=null,this._traversalController.destroy(),this._traversalController=void 0,this.shadowMapManager.destroy(),this.shadowMapManager=null}_destroyAllTiles(){if(!this._root)return;const e=[];for(e.push(this._root);e.length>0;){const t=e.pop(),i=t.childrenTree;for(let t=0,r=i.length;t<r;++t)e.push(i[t]);t.destroy()}this._root=void 0}getAllTiles(){if(!this._root)return;const e=[],t=[],i=[];for(i.push(this._root);i.length>0;){const r=i.pop().childrenTree;for(let n=0,a=r.length;n<a;++n){const a=r[n];i.push(a);const s=a.contentUrl;t.push(s),void 0!==s&&a._visible&&e.push(s)}}return{all:t,visible:e}}isDestroyed(){return this._destroyed}set root(e){this._root=e}get root(){return this._root}get ready(){return!!this._root}get statistics(){return this._tilesCacheScheduler.statistics}get cache(){return this._tilesCacheScheduler.tilesCache}get maximumMemoryUsage(){return this._tilesCacheScheduler.maximumMemoryUsage}get totalMemoryUsageInBytes(){return this._tilesCacheScheduler.totalMemoryUsageInBytes}set sequence(e){this._sequence=e}get sequence(){return this._sequence}set type(e){this._type=e}get type(){return this._type}get foveatedConeFactor(){return this._foveatedConeLimit.foveatedConeFactor}get foveatedSseRelaxation(){return this._foveatedConeLimit.foveatedSseRelaxation}get degradedFactor(){return this._foveatedConeLimit.degradedFactor}get foveatedConePriorityEnabled(){return this._foveatedConeLimit.priorityEnabled}set degradeEnabled(e){this._degradeEnabled=e}get degradeEnabled(){return this._degradeEnabled}get transformMatrix(){return this._transformMatrix}preUpdate(e){this.ready&&this.processTiles(e)}update(e){return!!this.ready&&(this.updateFrameState(e),this.resetMaxAndMinPriority(),this.selectTiles(e),this.requestTiles(e),this.updateTiles(e),this.replenishShadowTile(),!0)}postUpdate(e){this.ready&&this.cancelTileRequests(e)}selectTiles(e){this._requestedTiles.length=0,this._selectedTiles.length=0,this._clearDrawableOfTiles(),this.updateTile(this.root,e),this.root.visible&&this._inVisualRange(e)&&(this.shadowTileIdMap?this._traverseShadowIdTiles(this.root,e):this._traverseTiles(this.root,e),this._traverseShadowTiles(this.root,e),this._updatePriorityForRequestedTiles())}_traverseShadowIdTiles(e,t){this.shadowTileIdMap[e.uniqueTileId]&&(e._visible=!0,this._selectedTiles.push(e)),e.hasChildren()&&e.childrenTree.forEach((e=>{this._traverseShadowIdTiles(e,t)}))}getRequestBySubTree(e){let t=this._requestedTiles;const i=t[0];let r=0;if(i){let n=i.parent;for(;n;){const t=n.childrenTree;for(let i=0;i<t.length;++i)t[i].contentUnloaded&&(t[i]._priority=--r,this._addTileToRequestedQueue(t[i],e),this.visitTile(t[i],e),this.touchTile(t[i],e));n=n.parent}0===t.length&&(i._priority=--r,this._addTileToRequestedQueue(i,e),this.visitTile(i,e),this.touchTile(i,e))}}_sortRequestedTiles(t){let i=this._requestedTiles;i.sort(e),this.leavesLoadFirst&&(this.getRequestBySubTree(t),i.sort(e))}requestTiles(e){if(this.isSkippingTilesUpdate(e))return;let t=this._requestedTiles;this._sortRequestedTiles(e);for(let e=0,i=t.length;e<i;++e)this.requestContent(t[e])}updateTiles(e){const t=this.statistics,i=this._selectedTiles;for(let r=0,n=i.length;r<n;++r){let n=i[r];n.update(e),t.incrementSelectionCount(n.content),++t.selected}this.debugShowStatistics(e)}replenishShadowTile(){}calShadowTile(e){}processTiles(t){this._removeTilesFromProcessingQueue(t);let i=this._processingTiles;i.sort(e);for(let e=0,r=i.length;e<r;++e)i[e].process(t)}updateTile(e,t){this.updateTileVisibility(e,t),this.updateMaxAndMinPriority(e)}updateTileVisibility(e,t){e.updateVisibility(t),e.visible&&(e.meetsSSE(t)?e.refineReplace&&e.hasChildren()&&!this.anyChildrenVisible(e,t)&&(e._visible=!1):e._visible=!1)}anyChildrenVisible(e,t){let i=!1;return e.childrenTree.forEach((e=>{e.updateVisibility(t),i=i||e.visible})),i}touchTile(e,t){e._touchedFrame!==t.frameNumber&&(this.cache.touch(e),e._touchedFrame=t.frameNumber)}visitTile(e,t){++this.statistics.visited,e._visitedFrame=t.frameNumber}cacheTile(e){this.cache.add(e)}updateTextureMemoryUsage(e){const t=this.statistics;t.decrementTextureMemoryCount(e.content),e.getTexturesByteLength(),t.incrementTextureMemoryCount(e.content)}resetCache(e){}requestContent(e){if(e.contentTypeNull)return;const t=this.statistics;e.requestContent()?(this._requestedTilesInFlight.push(e),e.contentProcessPromise&&e.contentProcessPromise.then(this._addTileToProcessingQueue(this,e)).catch((function(e){})),e.contentReadyPromise&&e.contentReadyPromise.then(this._handleTileContentSuccess(this,e)).catch(this._handleTileContentFailure(this,e))):t.incrementNumberOfAttemptedRequests()}cancelTileRequests(e){const t=this._requestedTilesInFlight;let i=0;for(let n=0,a=t.length;n<a;++n){const a=t[n];if(a._contentState!==r.TileContentState.LOADING){++i;continue}e.frameNumber-a._touchedFrame>=1?(a._request&&a._request.cancel(),++i):i>0&&(t[n-i]=a)}t.length-=i}_canBeTraverse(e,t){return!!e.hasChildren()&&e.passSSE(t)}onDemandJudgment(e){return this.onDemandManager.onDemandJudgment(e)}_traverseTiles(e,t){this._traversalController.traverseTiles(this,e,t)}_traverseShadowTiles(e,t){this._traversalController.traverseShadowTiles(this,e,t)}isCheckChildrenPassSSE(){return!1}anyChildrenPassSSE(e,t){let i=!1;return e.childrenTree.forEach((e=>{i=i||e.passSSE(t)})),i}_fetchChildrenOfTile(e,t){this.needLoadChildrenOfTile(e)&&(e._childrenState=r.TileContentState.READY,e.contentTypeTile&&this.loadChildrenOfTile(e,void 0,(function(){t.afterRenderFns.push((function(){}))})))}needLoadChildrenOfTile(e){return e.childrenUnload}loadChildrenOfTile(e,t,i){}updateFrameState(e){}_clearDrawableOfTiles(){this._objectGroup&&this._objectGroup.children.forEach((e=>{e.visible=!1})),this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.hideAll()}_updatePriorityForRequestedTiles(){const e=this._requestedTiles;for(let t=0,i=e.length;t<i;++t)e[t].clearPriority();for(let t=0,i=e.length;t<i;++t)e[t].computePriority()}resetMaxAndMinPriority(){let e=this._priorityRange.max,t=this._priorityRange.min;t.depth=Number.MAX_VALUE,t.distance=Number.MAX_VALUE,t.sse=Number.MAX_VALUE,t.foveate=Number.MAX_VALUE,t.availableDepth=Number.MAX_VALUE,e.depth=-Number.MAX_VALUE,e.distance=-Number.MAX_VALUE,e.sse=-Number.MAX_VALUE,e.foveate=-Number.MAX_VALUE,e.availableDepth=-Number.MAX_VALUE}updateMaxAndMinPriority(e){let t=this._priorityRange.max,i=this._priorityRange.min;i.distance=Math.min(e._distance,i.distance),i.depth=Math.min(e._depth,i.depth),i.sse=Math.min(e.sse,i.sse),i.foveate=Math.min(e._foveatedFactor,i.foveate),i.availableDepth=Math.min(e._availableDepth,i.availableDepth),t.distance=Math.max(e._distance,t.distance),t.depth=Math.max(e._depth,t.depth),t.sse=Math.max(e.sse,t.sse),t.foveate=Math.max(e._foveatedFactor,t.sse),t.availableDepth=Math.max(e._availableDepth,t.availableDepth)}_addTileToSelectedQueue(e,t){return!!(e.contentAvailable&&e.isContentVisible(t)&&this._isAvailableDetailLevel(e,1))&&(this._selectedTiles.push(e),!0)}_addTileToRequestedQueue(e,t){e._requestedFrame!==t.frameNumber&&e.contentUnloaded&&this._isAvailableDetailLevel(e,1)&&(e._requestedFrame=t.frameNumber,this._requestedTiles.push(e))}_addTileToProcessingQueue(e,t){return function(){e._processingTiles.push(t),e.statistics.incrementNumberOfTilesProcessing()}}_removeTilesFromProcessingQueue(e){const t=this._processingTiles;let i=0;for(let e=0,r=t.length;e<r;++e){const r=t[e];r.contentProcessing?i>0&&(t[e-i]=r):++i}t.length-=i}_handleTileContentFailure(e,t){return function(i){var r=t.contentIndex,n=i.message?i.message:i;e.tileFailedEvent.numberOfListeners>0&&e.tileFailedEvent.fireEvent({url:r,message:n})}}_handleTileContentSuccess(e,t){return r.GlobalData.EnableRequestStatics&&this._getRepeatPending(t),function(){const i=e.statistics;i.decrementNumberOfTilesProcessing(),t.isTilesetContent||(i.incrementNumberOfTilesWithContentReady(),i.incrementNumberOfTilesTotal(),t.getTexturesByteLength(),i.incrementLoadCount(t.content),e.cacheTile(t)),e.tileLoadedEvent.fireEvent(t)}}unloadTile(e){this.tileUnloadEvent.fireEvent(e),this.statistics.decrementNumberOfTilesWithContentReady(),e.unloadContent()}createTile(){return null}loadTileset(e,t){}debugShowStatistics(e){if(!this._debugShowStatistics||0===this._selectedTiles.length)return;let t=0,i=0,n="";const a=this._selectedTiles;for(let e=0,s=a.length;e<s;++e){const s=a[e];n+="\nUrl: "+s._contentUrl,n+="\nLodLevel: "+s._debugLodLevel,s.content.trianglesLength>0&&(n+="\nTriangles: "+s.content.trianglesLength),n+="\nTexture Memory: "+r.Utils.toMemoryString(s.content.texturesByteLength),n+="\nGeometry Memory: "+r.Utils.toMemoryString(s.content.geometryByteLength),n+="\n",t+=s.content.geometryByteLength,i+=s.content.texturesByteLength}let s="";s+="\n -------------------------------- ",s+="\n[Statistics]",s+="\nFrameNumber: "+e.frameNumber,s+="\nTiles: "+a.length,s+="\nTotal Texture Memory: "+r.Utils.toMemoryString(i),s+="\nTotal Geometry Memory: "+r.Utils.toMemoryString(t),s+="\n",s+="\n[Detail]",s+=n,console.log(s)}explode(){}clone(e){return r.Utils.defined(e)||(e=new i),e.tileLoadedEvent=new r.Event,e.tileUnloadEvent=new r.Event,e.tileFailedEvent=new r.Event,e._copy(this),e}_copy(e){this._type=e._type,this._maximumMemoryUsage=e._maximumMemoryUsage,this._debugShowBoundingBox=e._debugShowBoundingBox,this._debugShowStatistics=e._debugShowStatistics,this._priorityRange=e._priorityRange,this._boundingBox=e._boundingBox.clone(),this._geometricError=e._geometricError,this.onDemand=e.onDemand,this.hasLayerInfo=e.hasLayerInfo,this._destroyed=e._destroyed}get maxDetailLevel(){return this._maxDetailLevel}set maxDetailLevel(e){this._maxDetailLevel=e}get visualRange(){return this._visualRange}set visualRange(e){this._visualRange=e}_isAvailableDetailLevel(e,t){return t=void 0===t?0:t,void 0===this._maxDetailLevel||void 0===e.detailLevel||e.detailLevel<this._maxDetailLevel+t}_inVisualRange(e){if(!this._boundingBox||!this._visualRange)return!0;const i=t.copy(this._boundingBox);i.copy(this._boundingBox),r.Math.isIdentityMatrix4(this.transformMatrix)||i.applyMatrix4(this.transformMatrix);const n=i.distanceToPoint(e.cameraPositionWc),a=void 0===this._visualRange.max?1/0:this._visualRange.max,s=void 0===this._visualRange.min?-1/0:this._visualRange.min;return n<=a&&n>=s}_createTraversalController(e){this._traversalController=new r.TilesetTraversal}_getRepeatPending(e){let t=[];t.push(e.contentIndex),t.push(e._contentInsModelIndex),t.push(e.contentOutlineUrl),t.forEach((e=>{e&&null!=e&&(this.pendingList.indexOf(e)>-1?this.repeatPendingList.push(e):this.pendingList.push(e))}))}isSkippingTilesUpdate(e){return!(!this._userInputWorking||!e.viewer.inputStatusMonitor.needsStopUpdateScene())}setUserInputWorking(e){this._userInputWorking=e}visitSelectedTiles(e){this._selectedTiles.forEach((t=>{this.visitTile(t,e),this.touchTile(t,e)}))}}i.sortByPriority=e,r.AbstractTileset=i}(),function(){let e=new THREE.Sphere,t=new THREE.Vector3,i=1;class n{constructor(e,t){Object.defineProperty(this,"uniqueTileId",{value:i++}),this._tileset=r.Utils.defaultValue(e,null),this._parent=t,this._destroyed=!1,this._databagId=e._databagId,this._fileId=e._fileId,this._childrenTree=[],this._boundingBox=void 0,this._transformedBoundingBox=void 0,this._transformMatrix=new THREE.Matrix4,t?(t.childrenTree.push(this),this._depth=t._depth+1):this._depth=0,this._visible=!1,this._content=void 0,this._contentUrl=void 0,this._contentOutlineUrl=void 0,this._contentType=void 0,this._isExterior=!1,this._isShadowExterior=!1,this._contentIndex=void 0,this._contentState=r.TileContentState.UNLOADED,this._childrenState=r.TileContentState.UNLOADED,this._priority=0,this._visibilityPriority=1,this._distance=0,this._projectedDistanceFromCenter=0,this._contentProcessDeferred=void 0,this._contentReadyDeferred=void 0,this._request=void 0,this._instanceInfoArray=null,this._debugLodLevel=-1,this._level=0,this.refineReplace=void 0,this.geometricError=0,this.sse=0,t&&t.layerInfo?this.layerInfo=Object.assign({},t.layerInfo):this.layerInfo={},this._id=null,this.labelAdded=!1,this.buffer=null,this._foveatedFactor=0,this._degradedFactor=1,this.priorityDegradation=!1,this.stateChangedRenderer=r.EnumChangedState.NONE,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this.selectionChangedRenderer=r.EnumChangedState.NONE,this.selectionWireFrameChangedRenderer=r.EnumChangedState.NONE,this.selectionMeshes=[],this.selectionWireFrames=[],this.forceUpdateWireFrame=!1,this._globaledBoundingBox=new THREE.Box3,this.numberOfUpdateVisibilityFrame=-1,this.visibilityBoxs=[],this._availableDepth=-1,this.forceLoad=!1}destroy(){this._destroyed=!0,this._clearContent(),this._tileset=void 0,this._parent=void 0,this._childrenTree=void 0,this._boundingBox=void 0,this._transformedBoundingBox=void 0,this.selectionMeshes=void 0,this.selectionWireFrames=void 0,this._instanceInfoArray=void 0,this._transformMatrix=void 0,this._contentType=void 0,this._contentState=void 0,this._contentUrl=void 0,this._contentOutlineUrl=void 0,this._ancestorWithContent=void 0,this._ancestorWithAvailableContent=void 0,this.labelAdded=void 0,this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.destroy(),this.debugShowGeometricErrorHelper=void 0,this.forceUpdateWireFrame=void 0,this.stateChangedRenderer=void 0,this.stateWireFrameChangedRenderer=void 0,this.buffer=void 0,this.layerInfo=void 0,this._globaledBoundingBox=void 0,this.visibilityBoxs=void 0,this._availableDepth=-1}isDestroyed(){return this._destroyed}get visible(){return this._visible}set visible(e){this._visible=e}get nodeId(){return this._id}set nodeId(e){this._id=e}set contentVisible(e){this._content&&(this._content.visible=e),this.selectionMeshes.map((t=>{t.visible=e})),this.selectionWireFrames.map((t=>{t.visible=e}))}get contentVisible(){return!!this._content&&this._content.visible}get parent(){return this._parent}get childrenTree(){return this._childrenTree}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}get depth(){return this._depth}set depth(e){return this._depth=e}get level(){return this._level}set level(e){return this._level=e}get contentUrl(){return this._contentUrl}get contentOutlineUrl(){return this._contentOutlineUrl}set contentIndex(e){return this._contentIndex=e}get contentIndex(){return this._contentIndex}set contentUrl(e){return this._contentUrl=e}set contentOutlineUrl(e){return this._contentOutlineUrl=e}get content(){return this._content}set content(e){return this._content=e}get contentType(){return this._contentType}set contentType(e){this._contentType=e}get isExterior(){return this._isExterior}set isExterior(e){this._isExterior=e}get isShadowExterior(){return this._isShadowExterior}set isShadowExterior(e){this._isShadowExterior=e}get contentState(){return this._contentState}set contentState(e){this._contentState=e}get contentUnloaded(){return this._contentState===r.TileContentState.UNLOADED}get contentLoading(){return this._contentState===r.TileContentState.LOADING}get contentProcessing(){return this._contentState===r.TileContentState.PROCESSING}get contentConstructing(){return this._contentState===r.TileContentState.CONSTRUCTING}get childrenUnload(){return this._childrenState===r.TileContentState.UNLOADED}get childrenReady(){return this._childrenState===r.TileContentState.READY}get contentReady(){return this._contentState===r.TileContentState.READY}get contentAvailable(){return this.contentReady&&!this.contentTypeEmpty}get contentTypeTile(){return this.contentType===r.TileContentType.DATA_TILE||this.contentType===r.TileContentType.DATA_BIMTILE}get contentTypeMesh(){return this.contentType===r.TileContentType.DATA_MESH||this.contentType===r.TileContentType.DATA_B3DM}get contentTypeCMPT(){return this.contentType===r.TileContentType.DATA_CMPT}get contentTypePoint(){return this.contentType===r.TileContentType.DATA_POINT}get contentTypeInstance(){return this.contentType===r.TileContentType.DATA_INSTANCE}get contentTypeLine(){return this.contentType===r.TileContentType.DATA_LINE}get contentTypeMeshAvailable(){return this.contentTypeMesh||this.contentTypeInstance||this.contentTypePoint||this.contentTypeLine||this.contentTypeCMPT}get contentTypeEmpty(){return this.contentType===r.TileContentType.DATA_NULL||this.contentType===r.TileContentType.DATA_TILE||this.contentType===r.TileContentType.DATA_BIMTILE}get contentTypeNull(){return this.contentType===r.TileContentType.DATA_NULL}get contentProcessPromise(){if(this._contentProcessDeferred)return this._contentProcessDeferred.promise}get contentReadyPromise(){if(this._contentReadyDeferred)return this._contentReadyDeferred.promise}get instanceInfo(){return this._instanceInfoArray}set instanceInfo(e){this._instanceInfoArray=e}isContentVisible(e){return this.contentReady&&this.visible}getAbsoluteContentUrl(){return this._contentIndex}getOutlineContentUrl(){return this._contentOutlineUrl}update(e){if(!this.contentTypeEmpty){if(e.viewer.showTileType!=r.EnumShowTileType.All){if(e.viewer.showTileType==r.EnumShowTileType.OnlyInstance&&!this.contentTypeInstance)return;if(e.viewer.showTileType==r.EnumShowTileType.ExceptInstance&&this.contentTypeInstance)return;if(e.viewer.showTileType==r.EnumShowTileType.OnlyExterior&&!this.isExterior)return;if(e.viewer.showTileType==r.EnumShowTileType.OnlyExteriorShadow&&!this.isShadowExterior)return;if(e.viewer.showTileType==r.EnumShowTileType.ExceptExterior&&(this.isExterior||this.isShadowExterior))return}return this.explode(),this.updateContent(e),this.applyFilter(),this.applySelection(),this.activateRenderables(),this.debugShowBoundingBox(e),this.debugShowGeometricError(e),!0}}process(e){this._content.update(e)}_makeRequest(e,t){const i=this;e.url=t.url,e.requestCallback=function(){const t=new r.Deferred;return i.fetchContentBlock(e.url,(function(e){t.resolve(e)}),(function(e){t.reject(e)})),e.cancelCallback=function(){},t.promise};const n=r.RequestScheduler.request(e);if(n)return n.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}requestContent(){const e=this.getAbsoluteContentUrl(),t=new r.Request({type:this._tileset.type,priorityCallback:this._createPriorityCallback(this)});this._request=t;let i=[e];const n=this.getOutlineContentUrl();n&&i.push(n);const a=this._makeRequest(t,{url:i});if(!a)return!1;const s=this._contentState;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const o=this._tileset.statistics;o.incrementNumberOfPendingRequests();const l=this._handleFailedContent(this,this._tileset),d=this;return a.then((function(e){d.isDestroyed()?l():d.parseContentBlock(e,(function(e){o.decrementNumberOfPendingRequests(),d._initialContent(e)}))})).catch((function(e){if(t.state===r.RequestState.CANCELLED)return d._contentState=s,o.decrementNumberOfPendingRequests(),void o.incrementNumberOfAttemptedRequests();l(e)})),!0}parseContentBlock(e,t){t(e)}fetchContentBlock(e,t,i){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}createContent(e){return null}_initialContent(e){const t=this;t._content=t.createContent(e),t._contentState=r.TileContentState.PROCESSING,t._contentProcessDeferred.resolve(t._content),t._content.readyPromise.then((function(e){t._contentState=r.TileContentState.READY,t._contentReadyDeferred.resolve(e)}))}_createPriorityCallback(e){return function(){return e._priority}}_handleFailedContent(e,t){return function(i){e._contentState===r.TileContentState.PROCESSING?t.statistics.decrementNumberOfTilesProcessing():t.statistics.decrementNumberOfPendingRequests(),e._contentState=r.TileContentState.FAILED,e._contentReadyDeferred&&e._contentReadyDeferred.reject(i),e._contentProcessDeferred&&e._contentProcessDeferred.reject(i)}}updateContent(e){this._content.update(e)}_clearContent(){this.cacheNode?this._tileset.cache.unloadTile(this):(this.unloadContent(),this._clearAllBuffer())}unloadContent(){this.disposeMeshIdMap(),this.disposeDebugBoundingBox(),this.disposeDebugGeometricError(),r.Utils.defined(this._content)&&(this._content.destroy(),this.contentReady&&this._tileset.statistics.decrementLoadCount(this._content),this._content=void 0),this._contentState=r.TileContentState.UNLOADED,this._request=this._request&&this._request.destroy(),this._contentProcessDeferred=this._contentProcessDeferred&&this._contentProcessDeferred.destroy(),this._contentReadyDeferred=this._contentReadyDeferred&&this._contentReadyDeferred.destroy(),this._clearAllBuffer(),this.stateChangedRenderer=r.EnumChangedState.NONE,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this.forceUpdateWireFrame=!1,this._ancestorWithContent=void 0,this._ancestorWithAvailableContent=void 0,this._transformedBoundingBox=void 0,this.selectionMeshes=[],this.selectionWireFrames=[],this._visible=!1,this._instanceInfoArray=null}updateVisibility(e){if(this.numberOfUpdateVisibilityFrame==e.frameNumber)return;this.computeAvailableDepth(),this.computeVisibility(e),this.numberOfUpdateVisibilityFrame=e.frameNumber;const t=this.computeTransformedBoundingBox(e);this.visible=this.culling(e,t),this.visible?(this.computeDistanceToCamera(e),this.computeSSE(e),this.priorityDegradation=this.isPriorityDegradation(e),this.adjustSseIfNeeded()):(this.sse=0,this._distance=9999,this.priorityDegradation=!0)}adjustSseIfNeeded(){this._tileset.degradeEnabled&&1!==this._tileset.degradedFactor&&this.priorityDegradation&&this._ancestorWithContent&&(this.sse=this.sse*this._degradedFactor)}isPriorityDegradation(i){this._degradedFactor=1;const n=this._tileset,a=i.camera,s=this._transformedBoundingBox.getBoundingSphere(e),o=s.radius,l=t.copy(i.cameraDirectionWc).multiplyScalar(this._projectedDistanceFromCenter),d=l.addVectors(i.cameraPositionWc,l).sub(s.center);if(d.length()>o){const e=d.normalize().multiplyScalar(o).add(s.center).sub(i.cameraPositionWc);this._foveatedFactor=1-Math.abs(e.normalize().dot(i.cameraDirectionWc))}else this._foveatedFactor=0;if(!n.foveatedConePriorityEnabled)return!1;if(1===n.foveatedConeFactor)return!1;const h=1-Math.cos(THREE.Math.degToRad(.5*a.fov)),c=n.foveatedConeFactor*h;if(this._foveatedFactor<=c)return!1;const u=r.Math.clamp((this._foveatedFactor-c)/(h-c),0,1);this._degradedFactor=Math.max(.01,1-u);const p=THREE.Math.lerp(n.foveatedSseRelaxation,n.maximumScreenSpaceError,u);return(0===this.sse&&this.parent?.5*this.parent.sse:this.sse)+p>=n.maximumScreenSpaceError}clearPriority(){this.parent&&(this.parent._minChildPriority=Number.MAX_VALUE)}computeAvailableDepth(){if(-1!=this._availableDepth)return;if(this._availableDepth=0,this.contentTypeEmpty)return;if(!this.parent)return;let e=this.parent;for(;e;)e.contentTypeEmpty||this._availableDepth++,e=e.parent}computeVisibility(e){const t=this.visibilityBoxs;if(t.length>0){this._visibilityPriority=2;let i=!1;for(const r of t)if(r.containsPoint(e.cameraPositionWc)){i=!0;break}i&&(this._visibilityPriority=0)}else this._parent?this._visibilityPriority=this._parent._visibilityPriority:this._visibilityPriority=1}computePriority(){const e=this._tileset,t=e._priorityRange.max,i=e._priorityRange.min,n=r.Math.isolateDigits(r.Math.normalize(e.type,0,10),1,16),a=r.Math.isolateDigits(r.Math.normalize(e.sequence,0,1e3),3,13),s=r.Math.isolateDigits(r.Math.normalize(this.detailLevel,0,10),1,12),o=r.Math.isolateDigits(r.Math.normalize(this._visibilityPriority,0,10),1,11),l=this.priorityDegradation?r.Math.isolateDigits(.1,1,10):0,d=r.Math.isolateDigits(r.Math.normalize(this._foveatedFactor,i.foveate,t.foveate),4,8),h=r.Math.normalize(this._availableDepth,i.availableDepth,t.availableDepth),c=r.Math.isolateDigits(this._tileset.leavesLoadFirst?1-h:h,2,4),u=r.Math.isolateDigits(r.Math.normalize(this._distance,i.distance,t.distance),4,0);this._priority=n,this._priority+=a,this._priority+=s,this._priority+=o,this._priority+=l,this._priority+=d,this._priority+=c,this._priority+=u,this.parent&&(this.parent._minChildPriority=Math.min(this.parent._minChildPriority,this._priority))}updatePriority(){this.parent&&(this._priority=this.parent._minChildPriority)}subdivideNodeSubstractive(e){}culling(e,t){const i=this._isExploded();return(e.globalMatrixUpdated||t)&&this._globaledBoundingBox.copy(this._transformedBoundingBox),!(!i&&!this.forceLoad)||!!e.frustumWc.intersectsBox(this._globaledBoundingBox)}needUpdateTransformedBoundingBox(e){return!!e.transformMatrixUpdated||(void 0===this._transformedBoundingBox||!this._tileset.transformMatrix.equals(this._transformMatrix))}computeTransformedBoundingBox(e){return!!this.needUpdateTransformedBoundingBox(e)&&(void 0===this._transformedBoundingBox&&(this._transformedBoundingBox=new THREE.Box3),this._transformMatrix.copy(this._tileset.transformMatrix),this._transformedBoundingBox.copy(this._boundingBox),r.Math.isIdentityMatrix4(this._transformMatrix)||this._transformedBoundingBox.applyMatrix4(this._transformMatrix),!0)}computeDistanceToCamera(e){const i=this.getActualBoundingBoxWorld();this._distance=i.distanceToPoint(e.cameraPositionWc),this._distance=this._distance<r.Math.EPSILON2?r.Math.EPSILON2:this._distance,i.getCenter(t),t.sub(e.cameraPositionWc),this._projectedDistanceFromCenter=t.dot(e.cameraDirectionWc)}getActualBoundingBoxWorld(){return this._transformedBoundingBox}passSSE(e){return!!this.isPassSSEBecauseOfSpecialConditions()||this.sse>=e.maximumScreenSpaceError}isPassSSEBecauseOfSpecialConditions(){return this._isExploded()||this.forceLoad}passSSE_instanceLeafTile(e){return!!this.isPassSSEBecauseOfSpecialConditions()||!!this.geScale_instanceLeafTile&&this.sse*this.geScale_instanceLeafTile>=e.maximumScreenSpaceError}meetsSSE(e){if(this.isPassSSEBecauseOfSpecialConditions())return!0;const t=this.parent;if(!t||t.refineReplace)return!0;return t.sse>e.maximumScreenSpaceError}computeSSE(e){const t=void 0!==e.geoErrScaleFactor?e.geoErrScaleFactor:1,i=this.geometricError*t;return this.sse=e.cameraPreSSE*(i/this._distance),this.sse}disposeMeshIdMap(){const e=this._content&&this._content._meshes;e&&e.traverse((e=>{"MeshEx"!==e.type&&"LineSegmentsEx"!==e.type||!e.name?"LineSegments"===e.type&&e.tileId&&(!0===e.isInstanceMeshNode?this.disposeInstanceLineNodeById(e.tileId):this.disposeLineNodeById(e.tileId)):!0===e.isInstanceMeshNode?this.disposeInstanceMeshNodeById(e.name):this.disposeMeshNodeById(e.name)}))}disposeMeshNodeById(e){}disposeInstanceLineNodeById(e){}disposeLineNodeById(e){}hasChildren(){return this._childrenTree.length>0}debugShowBoundingBox(){if(this._tileset._debugShowBoundingBox){if(!this._debugBoundingBox){const e=this._tileset._objectGroup,t=r.TilesUtil.getDebugColor(this._debugLodLevel,this.refineReplace);this._debugBoundingBox=new r.BBoxNode(this._boundingBox,t),this._debugBoundingBox.renderOrder=r.EnumRenderOrder.Effect-1,this._debugBoundingBox.matrixAutoUpdate=!1,e.add(this._debugBoundingBox),e.updateMatrixWorld(!0)}this._debugBoundingBox.visible=!0}}disposeDebugBoundingBox(){this._debugBoundingBox&&(this._debugBoundingBox.parent&&this._debugBoundingBox.parent.remove(this._debugBoundingBox),this._debugBoundingBox.geometry.dispose(),this._debugBoundingBox.material.dispose(),this._debugBoundingBox=void 0)}debugShowGeometricError(){if(!this._tileset._debugShowGeometricError)return;const e=this._tileset.debugShowGeometricErrorHelper;if(!1===this.labelAdded){this.labelAdded=!0;let i=this._boundingBox.getCenter(t);i.applyMatrix4(this._tileset._transformMatrix);const r={id:this._id,position:i,size:100,text:`${this._contentUrl}:${this.geometricError}`,tooltip:this.geometricError};e.addLabel(r)}e.showById(this._id),e.update()}disposeDebugGeometricError(){if(!this._tileset._debugShowGeometricError)return;this._tileset.debugShowGeometricErrorHelper.removeById(this._id),this.labelAdded=!1}applyFilter(){}applySelection(){}activateRenderables(){this.contentVisible=!0}explode(){}_isExploded(){const e=this._loader.filter.model;return!!e.manager.explosionManager.isExploded(e.id)}getTexturesByteLength(){this.content.getTexturesByteLength()}sharedGeometryDestroy(){return!1}_cancelSharedGeometryRequest(){}_clearAllBuffer(){}clone(e){return r.Utils.defined(e)||(e=new n),e._copy(this),e}_copy(e){this.refineReplace=e.refineReplace,this.geometricError=e.geometricError,this._boundingBox=e._boundingBox,this._contentUrl=e._contentUrl,this._contentType=e._contentType,this._contentIndex=e._contentIndex,this._childrenState=e._childrenState,this._destroyed=e._destroyed,this._childrenTree=[],this._transformMatrix=e._transformMatrix.clone(),this._depth=e._depth,this._visible=e._visible,this._priority=e._priority,this._instanceInfoArray=null,this._debugLodLevel=e._debugLodLevel,this.layerInfo=e.layerInfo}updateContentLength(e){r.Utils.defined(this._content)&&(this._content._geometryByteLength+=e)}}r.AbstractTile=n}(),function(){class e{constructor(e,t){this._tile=e,this._ready=!1,this._destroyed=!1,this._contentBuffer=t,this._geometryByteLength=0;for(const e in t)this._geometryByteLength+=t[e].byteLength;this._texturesByteLength=0,this._trianglesLength=0,this._state=r.TileContentProcessState.PENDING,this._meshes=new THREE.Group,this._meshes.name=r.Utils.getEncodedString(this._tile.getAbsoluteContentUrl())||e.name,this._meshes.databagId=e._databagId,this._meshes.fileId=e._fileId,this._meshes.tileId=e.contentId,this._meshes.matrixAutoUpdate=!1,this._readyDeferred=new r.Deferred,this._geometryOwner=0}destroy(){this._destroyed=!0,this._contentBuffer=void 0,this._readyDeferred=this._readyDeferred.destroy(),this.disposeGeometry(),this._tile=void 0}isDestroyed(){return this._destroyed}get tile(){return this._tile}get ready(){return this._ready}get geometryByteLength(){return this._geometryByteLength}set geometryByteLength(e){this._geometryByteLength=e}get texturesByteLength(){return this._texturesByteLength}get trianglesLength(){return this._trianglesLength}get readyPromise(){return this._readyDeferred.promise}get meshes(){return this._meshes}set visible(e){this._meshes.visible=e,this._outlineContent&&(this._outlineContent.visible=e),this._copyMeshes&&(this._copyMeshes.visible=e)}get visible(){return this._meshes.visible}_updateTexturesByteLength(e){if(e)if(Array.isArray(e))for(let t of e)t._imageByteSize&&!t._sizeCached&&(this._texturesByteLength+=t._imageByteSize,t._sizeCached=!0);else{let t=e;t._imageByteSize&&!t._sizeCached&&(this._texturesByteLength+=t._imageByteSize,t._sizeCached=!0)}}getTexturesByteLength(){const e=this._meshes.children;for(let t of e)if(t.children&&t.children.length>0)for(let e of t)this._updateTexturesByteLength(e.material);else t.material&&this._updateTexturesByteLength(t.material)}disposeGeometry(){this._meshes.parent&&this._meshes.parent.remove(this._meshes),this._texturesByteLength=0;const e=this._meshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];if(i.children&&i.children.length)for(let e=0,t=i.children.length;e<t;++e){const t=i.children[e];this.disposeGeometryAttributes(t,e),this._disposeMesh(t)}else i.geometry&&(this.disposeGeometryAttributes(i,t),this._disposeMesh(i))}this._meshes=void 0,this.disposeGeometryRelatedResource()}disposeGeometryRelatedResource(){}disposeGeometryAttributes(e,t){}_disposeMesh(e){const t=e.geometry;t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0,this._disposeMaterials(e.material),e.geometry=void 0,e.material=void 0,e._indicesGroup=void 0,e.indexGroups=void 0}update(e){const t=this;let i=!1;this._state===r.TileContentProcessState.PENDING?(this._state=r.TileContentProcessState.PROCESSING,t.parseTileContent((function(e){t.attachToTilesGroup(e),t.disposeContentBuffer(),t._state=r.TileContentProcessState.PROCESSED}))):this._state===r.TileContentProcessState.PROCESSING||this._state===r.TileContentProcessState.PROCESSED&&(t._tile._clearAllBuffer(),i=!0),this._ready||i&&e.afterRenderFns.push((function(){t._ready=!0,t._readyDeferred&&t._readyDeferred.resolve(t)}))}parseTileContent(e){e&&e(this._tile)}attachToTilesGroup(e){const t=this._tile._tileset._objectGroup;t.add(this.meshes),t.updateMatrixWorld(!0)}disposeContentBuffer(){this._contentBuffer=void 0}clone(t,i){return i=r.Utils.defaultValue(i,{}),(t=r.Utils.defaultValue(t,new e))._copy(this,i),t}_copy(e,t){this._tile=r.Utils.defaultValue(t.tile,e._tile),this._ready=e._ready,this._destroyed=e._destroyed,this._contentBuffer=e._contentBuffer,this._geometryByteLength=e._geometryByteLength,this._texturesByteLength=e._texturesByteLength,this._trianglesLength=0,this._state=r.TileContentProcessState.PENDING,this._meshes=e._meshes}_disposeMaterials(e){const t=this._tile._tileset.materialManager;if(r.Utils.isDefined(t)){let i=(e,t)=>{const i=t._imageByteSize;e.disposeMaterial(t)&&i&&(this._texturesByteLength+=i)};if(!(e instanceof Array))return void i(t,e);for(let r of e)r&&i(t,r)}}}r.AbstractTileContent=e}(),r.TileEmptyContent=class{constructor(e){this._tile=e}destroy(){this._tile=void 0}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get trianglesLength(){return 0}get readyPromise(){}update(e){}},r.TileTilesetContent=class{constructor(e,t){this._tile=e,this._destroyed=!1,this._ready=!1,this._readyDeferred=new r.Deferred,this._initialize(t)}destroy(){this._destroyed=!0,this._tile=void 0,this._readyDeferred.destroy(),this._readyDeferred=void 0}isDestroyed(){return this._destroyed}_initialize(e){const t=this._tile;t._tileset.createChildrenOfTile(t,e)}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get trianglesLength(){return 0}get readyPromise(){return this._readyDeferred.promise}update(e){this._ready||(this._ready=!0,this._readyDeferred&&this._readyDeferred.resolve(this),e.afterRenderFns.push((function(){})))}},function(){const e=1048576;r.TilesCacheScheduler=class{constructor(t){t=r.Utils.defaultValue(t,{}),this._maximumMemoryUsage=t.maximumMemoryUsage||2048,this._maximumMemoryUsageInBytes=this._maximumMemoryUsage*e,this._destroyed=!1,this._statistics=new r.Statistics,this._statisticsLast=new r.Statistics,this._tilesCache=new r.TilesCache(this)}destroy(){this._destroyed=!0,this._tilesCache.destroy(),this._tilesCache=void 0,this._statistics.destroy(),this._statistics=void 0,this._statisticsLast.destroy(),this._statisticsLast=void 0}isDestroyed(){return this._destroyed}get statistics(){return this._statistics}get tilesCache(){return this._tilesCache}get maximumMemoryUsage(){return this._maximumMemoryUsage}set maximumMemoryUsage(t){this._maximumMemoryUsage=t,this._maximumMemoryUsageInBytes=t*e}get maximumMemoryUsageInBytes(){return this._maximumMemoryUsageInBytes}get totalMemoryUsageInBytes(){var e=this._statistics;return e.texturesByteLength+e.geometryByteLength}clearStatistics(){this._statistics.clear()}resetTilesCache(e){e.newFrame&&this._tilesCache.reset()}update(){this._tilesCache.unloadTiles()}partialSort(){this._tilesCache.partialSort()}isMemoryUsageExceeded(){return this.totalMemoryUsageInBytes>this.maximumMemoryUsageInBytes}}}(),r.TextureManager=class{constructor(e,t={}){this._textureMap={},this._imageUrlMap={},this._typicalTextureLoader=new r.TextureLoader,this._typicalTextureLoader.crossOrigin=!0,this._basisTextureLoader=r.MaterialUtil.getBasisTextureLoader(),this._ktx2TextureLoader=r.MaterialUtil.getKTX2TextureLoader(),this._textureLoader=this._typicalTextureLoader,this._viewer=e,this._textureEncoding=r.Utils.defaultValue(t.textureEncoding,THREE.GammaEncoding);const i=document.createElement("canvas"),n=i.getContext("2d");n.fillStyle="#FFFFFF",n.fillRect(0,0,1,1),this.defaultTexture=new THREE.CanvasTexture(i),this.defaultTexture.generateMipmaps=!1,this._destroyed=!1,this.imageMap={}}destroy(){this._destroyed=!0,this._textureMap=null,this._imageUrlMap=null,this._typicalTextureLoader=null,this._basisTextureLoader.dispose(),this._basisTextureLoader=null,this._ktx2TextureLoader.dispose(),this._ktx2TextureLoader=null,this._textureLoader=null,this._viewer=null,this.defaultTexture=null,this.imageMap=null}isDestroyed(){return this._destroyed}_dealWithTexturePara(e,t){const{textureName:i,textureEncoding:n,textureParm:a,fromWorker:s}=t;e.name=i,this._textureMap[i]=e,e._referenceCount=1,e.encoding=n,s?(e.bumpScale=a.depth,e.repeat.fromArray([a.scaleU,a.scaleV]),e.offset.fromArray([a.offsetU,a.offsetV]),e.rotation=THREE.Math.degToRad(a.angle),a.repeatU&&(e.wrapS=THREE.RepeatWrapping),a.repeatV&&(e.wrapT=THREE.RepeatWrapping)):(e.bumpScale=a.getDepth(),e.repeat.fromArray([a.getScaleU(),a.getScaleV()]),e.offset.fromArray([a.getOffsetU(),a.getOffsetV()]),e.rotation=THREE.Math.degToRad(a.getAngle()),a.getRepeatU()&&(e.wrapS=THREE.RepeatWrapping),a.getRepeatV()&&(e.wrapT=THREE.RepeatWrapping)),r.MaterialUtil.updateUVMatrix(e)}getTextureFromURL(e,t,i){const n=r.Utils.defaultValue(i.textureEncoding,this._textureEncoding);e=r.RequestSpliter.splitByUrlMd5(e);const a=r.Utils.defaultValue(i.imageType,".png"),s=i.textureParm,o=i.fromWorker;return this._chooseTextureLoader(a),new Promise(((i,l)=>{const d=this._textureMap[t];if(r.Utils.isDefined(d))return d._referenceCount++,void i(d);r.EnableStorage?this._createTextureWithIndexDB(e,a).then((e=>{this.isDestroyed()?l():(this._dealWithTexturePara(e,{textureName:t,textureEncoding:n,textureParm:s,fromWorker:o}),i(e))})):this._loadTextureFromURL(e,a).then((e=>{this.isDestroyed()?l():(this._dealWithTexturePara(e,{textureName:t,textureEncoding:n,textureParm:s,fromWorker:o}),i(e))}))}))}getTextureFromBuffer(e,t,i){const n=r.Utils.defaultValue(i.textureEncoding,this._textureEncoding),a=i.textureParm,s=i.fromWorker,o=r.Utils.defaultValue(i.imageType,".png");return this._chooseTextureLoader(o),new Promise(((i,o)=>{const l=this._textureMap[t];if(r.Utils.isDefined(l))l._referenceCount++,i(l);else{const r=new Blob([e],{type:"image/jpeg"});if(this._textureLoader.supportsImageBitmap&&this._textureLoader.supportsImageBitmap(r)){const e=t;this._textureLoader.loadFromBlob(e,r,(e=>{e.flipY=!1,this.isDestroyed()?o():(this._dealWithTexturePara(e,{textureName:t,textureEncoding:n,textureParm:a,fromWorker:s}),i(e))}))}else{const e=(window.URL||window.webkitURL).createObjectURL(r);this._textureLoader.load(e,(e=>{e.flipY=!1,this.isDestroyed()?o():(this._dealWithTexturePara(e,{textureName:t,textureEncoding:n,textureParm:a,fromWorker:s}),i(e))}))}}}))}disposeTexture(e){return e._referenceCount--,!e._referenceCount&&(e.dispose(),delete this._textureMap[e.name],e=null,!0)}_createTextureWithIndexDB(e,t){return new Promise(((i,n)=>{r.storageManager.getTexture(e).then((t=>{let n=t;!0===this._imageUrlMap[e]?(n=t.clone(),n.needsUpdate=!0):this._imageUrlMap[e]=!0,n.image=r.MaterialUtil.ensurePowerOfTwo(t.image),n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,i(n)})).catch((()=>{this._loadTextureFromURL(e,t).then((t=>{r.storageManager.addTexture(t,e).catch((e=>{})),i(t)})).catch((e=>{console.log(e),n()}))}))}))}_loadTextureFromURL(e,t){return new Promise((i=>{if(t&&this._chooseTextureLoader(t),".org"===t){const t=new THREE.FileLoader;t.setResponseType("arraybuffer"),t.load(e,(t=>{let n=new THREE.Texture;n.src=e;const a=new TEST.CryptoResourceLoader;try{a.load(t,(t=>{let a=new Image;if(this.imageMap[e])a.src=this.imageMap[e];else{const i=new Blob([t],{type:"jpeg"});a.src=URL.createObjectURL(i),this.imageMap[e]=a.src}a.onload=()=>{n.image=r.MaterialUtil.ensurePowerOfTwo(a),n.needsUpdate=!0,i(n)},a.onerror=e=>{console.log(e),i(this.defaultTexture)}}))}catch(t){console.warn(`invalid texture ${e}`),i(this.defaultTexture)}}))}else this._textureLoader.load(e,(t=>{let n=t;!0===this._imageUrlMap[e]?(n=t.clone(),n.needsUpdate=!0):this._imageUrlMap[e]=!0,n.image=r.MaterialUtil.ensurePowerOfTwo(t.image),n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,i(n)}),void 0,(()=>{i(this.defaultTexture)}))}))}_chooseTextureLoader(e){switch(e){case".basis":this._textureLoader=this._basisTextureLoader,this._textureLoader.detectedSupport||this._textureLoader.detectSupport(this._viewer.getRenderer());break;case".ktx2":this._textureLoader=this._ktx2TextureLoader,this._textureLoader.basisLoader.detectedSupport||this._textureLoader.basisLoader.detectSupport(this._viewer.getRenderer());break;default:this._textureLoader=this._typicalTextureLoader}return this._textureLoader}},function(){function e(e,t){return t._distance-e._distance}class t{constructor(){this.traversalStack=[],this.emptyTraversalStack=[],this.traversalDescendants=[]}destroy(){this.traversalStack=null,this.emptyTraversalStack=null,this.traversalDescendants=null}traverseTiles(e,t,i){const r=this.traversalStack;for(r.push(t);r.length>0;){const t=r.pop(),n=t.refineReplace,a=!t.parent||t.parent._refines;let s=!1;if(this.updateTileContentLinksToAncestor(t,i),e._isAvailableDetailLevel(t)){if(e._fetchChildrenOfTile(t,i),e.onDemandJudgment(t))continue;e._canBeTraverse(t,i)&&(s=this.subdivideTile(e,t,i),s=s&&a)}if(e._addTileToRequestedQueue(t,i),n){!s&&a&&e._addTileToSelectedQueue(t,i)}else e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=s}}traverseShadowTiles(e,t,i){}subdivideTile(t,i,r){const n=this.traversalStack,a=i.childrenTree;a.forEach((e=>{t.updateTile(e,r)})),a.sort(e);const s=i.refineReplace&&!i.contentTypeEmpty;let o=!0,l=!1;return a.forEach((e=>{if(e.visible?(n.push(e),l=!0):s&&(t._addTileToRequestedQueue(e,r),t.visitTile(e,r),t.touchTile(e,r)),!s)return;const i=e.contentTypeEmpty?this.traverseTileWithEmptyContent(t,e,r):e.contentAvailable;o=o&&i})),l||(o=!1),o}traverseTileWithEmptyContent(e,t,i){const r=this.emptyTraversalStack;r.push(t);let n=!0;for(;r.length>0;){const t=r.pop();if(e._fetchChildrenOfTile(t,i),t.contentTypeTile&&!t.hasChildren()){n=!1;continue}let a=t.contentTypeEmpty&&e._canBeTraverse(t,i),s=t.contentTypeEmpty&&!t.hasChildren();a||t.contentAvailable||s||(n=!1),a&&t.childrenTree.forEach((t=>{e.updateTile(t,i),t.visible||(e._addTileToRequestedQueue(t,i),e.visitTile(t,i),e.touchTile(t,i)),r.push(t)}))}return n}updateTileContentLinksToAncestor(e,t){e._ancestorWithContent=void 0,e._ancestorWithAvailableContent=void 0;const i=e.parent;i&&(e._ancestorWithContent=i.contentTypeEmpty?i._ancestorWithContent:i,e._ancestorWithAvailableContent=i.contentAvailable?i:i._ancestorWithAvailableContent)}}t.sortByDistanceToCamera=e,r.TilesetTraversal=t}(),function(){let e=null;r.RequstPoolLoader=class{constructor(){}static load(t,i,r,n){e&&e.push(t,i,r,n)}static setConcurrency(t){e&&(e.limit=t)}static destroy(){e&&(e.destroy(),e=null)}static init(){e||(e=new r.LoadTaskRunner)}}}(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModelExplosion{constructor(e){super(e)}explode(){var e=this.model._getHandler();e&&e.explode()}preFloorExplode(e,t,i){let r={};for(var n=0,a=t.length;n<a;n++){let e=t[n].explodedHeight-t[n].elevation,a=new THREE.Vector3(i.x*e,i.y*e,i.z*e);t[n].preExplodedTranslation?r[t[n].name]=a.clone().sub(t[n].preExplodedTranslation):r[t[n].name]=a,t[n].preExplodedTranslation=a}const s=this,o=this.model.getAllNodeInfos(),l=Object.keys(o);let d=new THREE.Matrix4;for(let t=0,i=l.length;t<i;t++){const i=l[t],n=o[i];for(let t=0,a=n.length;t<a;t++){if(0==t){let e=r[n[t].userData.levelName]||new THREE.Vector3;d.makeTranslation(e.x,e.y,e.z),s.explosionTranslation[i]=e}n[t].boundingBox.applyMatrix4(d),n[t].matrix.multiplyMatrices(d,n[t].matrix),e.union(n[t].boundingBox)}}e.applyMatrix4(this.model.getTransformMatrix())}getExplosionTranslation(e){return this.explosionTranslation[e]||new THREE.Vector3}getExplosionTranslationByObjId(e){return this.explosionTranslation[e]||new THREE.Vector3}getLevelNameByObjId(e){return this.model.getAllNodeInfos()[e][0].userData.levelName}preElementExplode(i,n,a){const s=this.model.getBoundingBoxWorld();if(!s)return;const o=n-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==o)return;let l=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert();let d=s.getCenter(t).applyMatrix4(e);a&&d.copy(a).applyMatrix4(e);const h=this.model.getAllNodeInfos(),c=Object.keys(h);let u=this.explosionTranslation;for(let e=0,t=c.length;e<t;e++){let t=c[e],n=h[t],a=new THREE.Box3;for(let e=0,t=n.length;e<t;e++)n[e].originBox||(n[e].originBox=n[e].boundingBox.clone()),a.union(n[e].originBox);let s=r.Utils.computeExplodeTranslation(d,a,o);u[t]=s,l.makeTranslation(s.x,s.y,s.z);for(let e=0,t=n.length;e<t;e++)n[e].boundingBox.applyMatrix4(l),n[e].matrix.multiplyMatrices(l,n[e].matrix),i.union(n[e].boundingBox)}i.applyMatrix4(this.model.getTransformMatrix())}}r.BMDModelExplosion=i})(),r.Loader=r.Loader||{},r.Loader.Url=class{constructor(e){this.databagPath=`${e.serverUrl}${e.databagId}`,this.lightmapPath=e.lightmapDatabagId?`${e.lightmapServerUrl}${e.lightmapDatabagId}`:e.lightmapDatabagId,this.shellDatabagId=e.shellDatabagId?`${e.serverUrl}${e.shellDatabagId}`:null}projectUrl(){return this.databagPath+"/config.json"}sceneUrl(e){return e=e||0,this.databagPath+"/scene/scene_"+e+r.GlobalData.ZipResourcePostfix}sceneIdUrl(){return this.databagPath+"/scene/scene_id"+r.GlobalData.ZipResourcePostfix}userIdUrl(){return this.databagPath+"/scene/user_id"+r.GlobalData.ZipResourcePostfix}octreeUrl(e){return e=e||"o",this.databagPath+"/scene/octree_"+e+r.GlobalData.ZipResourcePostfix}symbolUrl(){return this.databagPath+"/symbol/symbol"+r.GlobalData.ZipResourcePostfix}mpkUrl(e){return e=e||0,this.databagPath+"/mpk/mpk_"+e+r.GlobalData.ZipResourcePostfix}bmpkUrl(e){e=e||0;const t=this.databagPath+"/bmpk/bmpk_"+e+r.GlobalData.ZipResourcePostfix;return r.RequestSpliter.splitByContextId(t,e)}bmpkIndexUrl(){return this.databagPath+"/bmpk/index"+r.GlobalData.ZipResourcePostfix}meshIdUrl(){return this.databagPath+"/mpk/mesh_id"+r.GlobalData.ZipResourcePostfix}materialUrl(){return this.databagPath+"/material/material"+r.GlobalData.ZipResourcePostfix}uv2Url(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.buf":this.databagPath+"/uv2/uvs1-export.buf"}uv2MapItemUrl(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.json":this.databagPath+"/uv2/uvs1-export.json"}lightmapTexUrl(e){return this.lightmapPath?this.lightmapPath+"/texture/"+e:this.databagPath+"/texture/"+e}lightmapProjectUrl(){return this.lightmapPath?this.lightmapPath+"/config.json":this.lightmapPath}materialIdUrl(){return this.databagPath+"/material/material_id"+r.GlobalData.ZipResourcePostfix}texturePkgOrgIndexUrl(){return this.databagPath+"/texture/pkg_org_index"+r.GlobalData.ZipResourcePostfix}texturePkgSmallIndexUrl(){return this.databagPath+"/texture/pkg_s_index"+r.GlobalData.ZipResourcePostfix}texturePkgIndexUrl(e){return e?this.databagPath+"/texture/pkg_index"+r.GlobalData.ZipResourcePostfix:this.databagPath+"/texture/pkg_index"+r.GlobalData.JsonResourcePostfix}texturePkgFileName(e,t,i,n){var a=void 0;return a=e?`pkg_${i}`:`pkg_${n}_${i}`,t&&(a+=r.GlobalData.ZipResourcePostfix),a}bmpkPkgIndexUrl(){return this.databagPath+"/bmpk/pkg_index"+r.GlobalData.ZipResourcePostfix}userDataUrl(){return this.databagPath+"/userdata/userdata"+r.GlobalData.ZipResourcePostfix}cameraUrl(){return this.databagPath+"/scene/camera"+r.GlobalData.ZipResourcePostfix}textureUrl(e){const t=this.databagPath+"/texture/"+e,i=e.replace(/[^0-9]/gi,"");return r.RequestSpliter.splitByContextId(t,i)}layerUrl(){return this.databagPath+"/scene/layer"+r.GlobalData.ZipResourcePostfix}layerKeyUrl(){return this.databagPath+"/scene/layer_key"+r.GlobalData.ZipResourcePostfix}lineUrl(){return this.databagPath+"/line/line"+r.GlobalData.ZipResourcePostfix}layerSceneUrl(e){return e=e||0,this.databagPath+"/layer/layer_"+e+r.GlobalData.ZipResourcePostfix}layerSceneCell(){return this.databagPath+"/layer/layer_cell"+r.GlobalData.ZipResourcePostfix}layerOctree(){return this.databagPath+"/layer/layer_octree"+r.GlobalData.ZipResourcePostfix}borderLineUrl(e){return e=e||0,this.databagPath+"/outline/outline_"+e+r.GlobalData.ZipResourcePostfix}mpkBorderLineUrl(e){return e=e||0,this.databagPath+"/outline/outline_mpk_"+e+r.GlobalData.ZipResourcePostfix}terrainUrl(e,t,i){return this.databagPath+"/terrain/"+e+"/"+t+"/"+i+"/"+r.GlobalData.TerrainResourceFileName}sceneStatisticsUrl(){return this.databagPath+"/sceneStatistics.json"}shellModelUrl(){return this.shellDatabagId?`${this.shellDatabagId}/config.json`:null}},r.ModelView.WireframeManager=class{constructor(){this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),this.wireframeMaterial.defines.USE_NO_SSAO="",!1===r.GlobalData.TranslucentDepthDisabled&&(this.wireframeMaterial.transparent=!0),this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),!1===r.GlobalData.TranslucentDepthDisabled&&(this.instanceWireframeMaterial.transparent=!0),this.instanceWireframeMaterial.defines.USE_NO_SSAO="",this.wireframeGeometryMap={}}destroy(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.instanceWireframeMaterial.destroy(),this.instanceWireframeMaterial=null,this.wireframeGeometryMap=null,this.defaultWireframeColor=null}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){var e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){var e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}},r.ModelView.ConfigLoader=class{constructor(e){this.model=e,this.config=null,this.statistics={renderableCount:0,renderableTotal:r.GlobalData.maxObjectNumInPool,renderableTotalForPool:r.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,numOfVertices:0,memoeryInfo:null},this.transformInfos={octreeTransformed:!0,boundingBox:null,position:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.sceneStatistics=void 0}destroy(){this.model=null,this.config=null,this.statistics=null,this.transformInfos=null,this.sceneStatistics=null}load(e){var t=this,i=this.model,n=i.dataUrl,a=i.fileLoader;a.setResponseType(""),a.load(n.projectUrl(),(function(n){var a;try{a=JSON.parse(n)}catch(e){return console.log("Config data exceptions!"),void i.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}if(r.Utils.checkVersionMatch(r.Version,a.metadata.version)){if(0===a.metadata.scenes)return i.setEmptyScene(!0),void i.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE});0==a.metadata.gz?r.GlobalData.ZipResourcePostfix="":r.GlobalData.ZipResourcePostfix=".gz",i.setEmptyScene(!1),t._loadDataForSceneStatistics((function(){t._parse(a),e&&e()}))}else i.dispatchEvent({type:r.EVENTS.ON_VERSION_NO_MATCH,version:{engine:r.Version,data:a.metadata.version}})}),void 0,(function(){console.log("Config load error!"),i.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}))}loadWithConfig(e,t){var i=this,n=this.model;if(r.Utils.checkVersionMatch(r.Version,e.metadata.version)){if(0===e.metadata.scenes)return n.setEmptyScene(!0),console.warn("The scene is Empty!"),n.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE,modelId:n.id}),void i._loadDataForSceneStatistics((function(){e.view&&e.view.rotation&&(e.view.rotation[0]=-Math.PI/2),i._parse(e),t&&t()}));0==e.metadata.gz?r.GlobalData.ZipResourcePostfix="":r.GlobalData.ZipResourcePostfix=".gz",n.setEmptyScene(!1),i._loadDataForSceneStatistics((function(){i._parse(e),t&&t()}))}else n.dispatchEvent({type:r.EVENTS.ON_VERSION_NO_MATCH,version:{engine:r.Version,data:e.metadata.version}})}_loadDataForSceneStatistics(e){var t=this,i=this.model.fileLoader;const n=this.model.dataUrl.sceneStatisticsUrl();r.Storage.IndexedDBHelper.loadWithStorage("InfoData",n,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(n,e,void 0,t)}))),(i=>{var r=JSON.parse(i);t.sceneStatistics=r.sceneStatistics,e&&e()}),e)}_parse(e){this.config=e,this._setMetadata(e),this._toStatistics(e),this._setTransformInfos(e),this._chooseRendering(e),this._setHandler(e)}_setMetadata(e){e.metadata.scenes=e.metadata.scenes?1:0,e.metadata.symbol=e.metadata.symbol?1:0,e.metadata.octree_o=e.metadata.octree_o?1:0,e.metadata.octree_i=e.metadata.octree_i?1:0,e.metadata.userdata=e.metadata.userdata?1:0,e.metadata.userId=1,e.metadata.camera=e.metadata.camera?1:0,e.metadata.material=e.metadata.material||0,e.metadata.material_json=e.metadata.material_json?1:0,e.metadata.lines=r.Compatibility.isLoadLinesEnabled(e.metadata.version)&&e.metadata.lines?1:0,e.metadata.outline_0=e.metadata.outline_0?1:0,e.metadata.outline_1=e.metadata.outline_1?1:0,e.metadata.outline_mpk=e.metadata.outline_mpk||0,e.metadata.mpk_shared_index=e.metadata.mpk_shared_index||e.metadata.outline_mpk}_getDataProvider(e){if(r.GlobalData.DataProvider===r.EnumDataProvider.MERGED&&void 0!==e.bmpks&&e.bmpks>0)return r.EnumDataProvider.MERGED;if(r.GlobalData.EnableLoadOnDemand&&e.layers){if(r.GlobalData.DataProvider===r.EnumDataProvider.LAYER_SCENE)return e.layers>1&&r.Compatibility.isLoadLayerSceneEnabled(e.version)?r.EnumDataProvider.LAYER_SCENE:r.EnumDataProvider.LAYER;if(r.GlobalData.DataProvider===r.EnumDataProvider.LAYER)return r.EnumDataProvider.LAYER}if(r.GlobalData.DataProvider===r.EnumDataProvider.AUTO){if(r.GlobalData.EnableLoadOnDemand&&e.layers)return e.layers>1&&r.Compatibility.isLoadLayerSceneEnabled(e.version)?r.EnumDataProvider.LAYER_SCENE:r.EnumDataProvider.LAYER;if(r.GlobalData.BatchMergeEnabled&&r.Compatibility.isLoadBMpkEnabled(e.version)&&void 0!==e.bmpks&&e.bmpks>0)return r.EnumDataProvider.MERGED}return r.EnumDataProvider.DEFAULT}_chooseRendering(e){this.model.manager.chooseRendering(this.statistics.memoeryInfo,!1,e)}_setHandler(e){var t=!(!r.GlobalData.CanUseWireframeFromData||!e.metadata.outline_0&&!e.metadata.outline_1),i=this._getDataProvider(e.metadata),n=null,a=this.model;const s={useDataWireframe:t,version:e.metadata.version};if(r.GlobalData.BatchMergeEnabled)switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.LayerBatchedHandler(a,t),a.loadMpkOnDemand=!0;break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.LayerSceneBatchedHandler(a,s),a.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:n=new r.ModelView.DataBatchedHandler(a,s);break;default:n=new r.ModelView.BatchedHandler(a,s)}else if(r.GlobalData.OrganizeNodesByCameraView)switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.LayerIncrementHandler(a),a.loadMpkOnDemand=!0;break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.LayerSceneIncrementHandler(a),a.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:n=new r.ModelView.DataBatchedHandler(a,s);break;default:n=new r.ModelView.IncrementHandler(a)}else switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.FreeLayerIncrementHandler(a);break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,n=new r.ModelView.FreeLayerSceneIncrementHandler(a),a.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:n=new r.ModelView.DataBatchedHandler(a,s);break;default:e.metadata.mpk_batched?(console.log("use batched mpks"),n=new r.ModelView.IncrementBatchedHandler(a)):n=new r.ModelView.FreeIncrementHandler(a)}a._handler=n}_setTransformInfos(e){if(0!==e.view.transform?this.transformInfos.octreeTransformed=!0:this.transformInfos.octreeTransformed=!1,this.transformInfos.boundingBox=r.Utils.box3FromArray(e.view.bbox),e.view.rotation){var t=new THREE.Euler;t.fromArray(e.view.rotation),this.transformInfos.rotation.setFromEuler(t,!1)}e.view.position&&this.transformInfos.position.fromArray(e.view.position),e.view.scale&&this.transformInfos.scale.fromArray(e.view.scale),this.transformInfos.transformMatrix.compose(this.transformInfos.position,this.transformInfos.rotation,this.transformInfos.scale)}_toStatistics(e){e.count.texture_pixels&&e.count.texture_pixels>r.GlobalData.MaxTexturePixels&&(r.GlobalData.EnableTextureLoading=!1),void 0!==e.count&&(void 0!==e.count.mesh_face&&(this.statistics.numOfTriangles+=e.count.mesh_face),this.statistics.renderableTotal=0,this.statistics.renderableTotalForPool=0,void 0!==e.count.geom_box&&void 0!==e.count.geom_pipe&&void 0!==e.count.geom_tube&&void 0!==e.count.mesh?(this.statistics.renderableTotal+=e.count.geom_box,this.statistics.renderableTotal+=e.count.geom_pipe,this.statistics.renderableTotal+=e.count.geom_tube,this.statistics.renderableTotal+=e.count.mesh,this.statistics.renderableTotalForPool+=6*e.count.geom_box,this.statistics.renderableTotalForPool+=3*e.count.geom_pipe,this.statistics.renderableTotalForPool+=e.count.geom_tube,this.statistics.renderableTotalForPool+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom_box,this.statistics.numOfTriangles+=32*e.count.geom_pipe,this.statistics.numOfTriangles+=32*e.count.geom_tube):void 0!==e.count.geom&&void 0!==e.count.mesh&&(this.statistics.renderableTotal+=e.count.geom,this.statistics.renderableTotal+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom,this.statistics.numOfElements=this.statistics.renderableTotal,this.statistics.renderableTotalForPool=this.statistics.renderableTotal),void 0!==e.count.item&&(this.statistics.numOfElements=e.count.element||e.count.item)),this.sceneStatistics?(this.statistics.numOfTriangles=this.sceneStatistics.triangleTotalCount,this.statistics.numOfVertices=this.sceneStatistics.vertexTotalCount,this.statistics.numOfElements=this.sceneStatistics.elementCount,this.statistics.memoeryInfo=this._computeMaximumMemoryUsage(e)):(this.statistics.numOfVertices=this._computeNumOfVertices(e),this.statistics.memoeryInfo=this._computeApproximateMemoryUsage(e))}_computeNumOfVertices(e){return void 0===e.count?0:(e.count.mesh_vertex||0)+24*(e.count.geom_box||0)+130*(e.count.geom_pipe||0)+24*(e.count.geom_box_m||0)}_computeMaximumMemoryUsage(e){var t=this.sceneStatistics,i=t.vertexTotalCount,n=t.triangleTotalCount,a=0;a+=8*i,a+=3*n;var s=e.count.texture_pixels||0;return r.GlobalData.EnableTextureLoading&&(a+=4*s),a*=4,a*=1/1048576,{maxMemorySize:a=Math.ceil(a),triangleNumber:n}}_computeApproximateMemoryUsage(e){var t=0,i=0,n=1/1048576,a=e.count.mesh_vertex||0,s=e.count.mesh_face||0,o=e.count.geom_box||0,l=e.count.geom_pipe||0,d=130,h=124,c=e.count.texture_pixels||0;i+=8*a,i+=3*s,i+=0,i+=0,t+=6*a,t+=3*s,t+=0,t+=0;var u=0;return u+=s,o>0&&(u+=12*o),l>0&&(u+=h*l),u+=0,r.GlobalData.Instance?(o>0&&(i+=192,i+=36,i+=24*o,t+=144,t+=36,t+=18*o),l>0&&(i+=1040,i+=372,i+=24*l,t+=780,t+=372,t+=18*l)):(o>0&&(i+=24*o*8,i+=12*o*3,t+=24*o*6,t+=12*o*3),l>0&&(i+=l*d*8,i+=l*h*3,t+=l*d*6,t+=l*h*3)),r.GlobalData.EnableTextureLoading&&(i+=4*c,t+=4*c),i*=4,t*=4,i*=n,t*=n,{maxMemorySize:i=Math.ceil(i),minMemorySize:t=Math.ceil(t),triangleNumber:u,instanceEnabled:r.GlobalData.Instance}}getMemoryInfo(){return this.statistics.memoeryInfo}getStatistics(){return this.statistics}getConfig(){return this.config}getTransforms(){return this.transformInfos}setRenderableCount(e){this.statistics.renderableCount=e}getVersion(){return this.config.metadata.version}},function(){class e extends r.BaseModel{constructor(e,t,i,n,a){super(e,t),this.isBmdLayer=!0,this.filter=new r.FilterManager(this),this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.debut=a,this.dataUrl=new r.Loader.Url(t),this.fileLoader=new THREE.FileLoader(new THREE.LoadingManager),this.configLoader=new r.ModelView.ConfigLoader(this),this.pool=e.getObjectPool(),this.firstOctreeTransform=!0,this.selectedMaterial=this.manager.sceneState.selectionMaterial,this.materialManager=new r.MaterialManager(e.viewer),this.wireframeManager=new r.ModelView.WireframeManager,this.cameraList=[],this.index=i,this.parseCfgFinish=n,this.progressPercentage={load:.4,collect:.5,merge:.1};const s=r.GlobalData.BatchAsyncProcessingFrequency;this.progressFrequency="number"==typeof s?s:10,this._rootNodeGroupName=r.ObjectGroupType.MODEL+"|"+this.databagId,this._rootNodeGroup=this._createRootNodeGroup(),this._rootNodeGroup.transformMatrix=this.transformMatrix,this._handler=null,this.lightmap=null!=t.lightmapDatabagId,this.lightmapNum=0,this.enableLightmap=!1,this.lightmapIntensity=r.GlobalData.LightmapIntensity,this.minDistanceObjects={},this.prioritizedNodeCount=0,this.plugins=[],this.modelExplosion=new r.BMDModelExplosion(this),this.isAllMaterialChanged=!1,this.loadMpkOnDemand=!1,this._vertexOffsetMatrix=void 0,this.mapClippingIds=new Map,this.mapClippingIdsBox=[new Map,new Map,new Map,new Map,new Map,new Map]}destroy(){this.selectedMaterial=null,this.cameraList=null,this.occlusionCamera&&(this.occlusionCamera=null),this._handler&&(this._handler.destroy(),this._handler=null),this.wireframeManager.destroy(),this.wireframeManager=null,this.materialManager.disposeMaterials(this),this.materialManager.destroy(),this.materialManager=null,this.pool=null;for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].destroy(),this.plugins[e]=null;this.plugins=null,this.configLoader.destroy(),this.configLoader=null,this._removeMeshNodeGroup(),this.removeAllFromOctantMap(),this.dataUrl=null,this.fileLoader=null,this.debut=null,this.parseCfgFinish=null,this.progressPercentage=null,this.minDistanceObjects=null,this._vertexOffsetMatrix=void 0,super.destroy()}_createRootNodeGroup(){return this.manager.scene.getOrCreateObjectGroup(this._rootNodeGroupName,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0})}_getWireframeGroupName(){return r.ObjectGroupType.WIREFRAME+"|"+this.getEncodedDatabagId()}load(e){var t=this;return new Promise(((i,r)=>{this.configLoader.loadWithConfig(this.config,(function(){t.parseCfgFinish&&t.parseCfgFinish(),t.manager.updateScene(),t._getHandler().load(e),i()}))}))}setCrossOrigin(e){this.fileLoader.setCrossOrigin(e)}prepare(e,t){var i=this._getHandler();i&&i.prepare(e,t)}dispatchEvent(e){this.manager.dispatchEvent(e)}setLoaded(e){this.loaded=e}isLoaded(){return!!this._handler&&this.loaded}isEmptyScene(){return this.emptyScene}setEmptyScene(e){this.emptyScene=e}isLayerData(){return!(!this._handler||"layer"!==this._handler.tag)}isVisible(){return this.visible}setVisible(e){this.visible=e,this._rootNodeGroup.visible!==e&&(this._rootNodeGroup.visible=e,this._rootNodeGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0))}calculateCameraModelRelation(e){this.containsCamera=this.getModelDescriptor().isOctreeOuter(e)}addCamera(e){this.cameraList.push(e)}getCameraNameList(){for(var e=[],t=this.cameraList.length-1;t>=0;t--)e.push(this.cameraList[t].name);return e}getCamera(e){for(var t=this.cameraList.length-1;t>=0;t--)if(this.cameraList[t].name===e)return this.cameraList[t];return null}updateOctreeNode(e){if(e||this.firstOctreeTransform){this.firstOctreeTransform&&(this.firstOctreeTransform=!1);var t=this.manager.scene.getRawMatrixGlobal();this.getModelDescriptor().updateOctreeNode(t,this.getTransformMatrix())}}isDataReady(){var e=this._handler;return!!e&&e.isDataReady()}updateMeshNodes(){var e=this._getHandler();e&&e.updateNodes()}_getHandler(){return this._handler}getMeshesByUserIds(e,t){if(e&&t){this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[];var i=this._getHandler();i&&i.getMeshesByUserIds(e,t);for(var r=0,n=this.plugins.length;r<n;r++)this.plugins[r].getMeshesByUserIds([e,t])}}applyFilter(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyFilter();var i=this._getHandler();i&&i.applyFilter()}applySelection(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applySelection();var i=this._getHandler();i&&i.applySelection()}clearSelection(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearSelection();var i=this._getHandler();i&&i.clearSelection()}applyHover(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyHover();var i=this._getHandler();i&&i.applyHover()}clearHover(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearHover();var i=this._getHandler();i&&i.clearHover()}applyBlink(){var e=this._getHandler();e&&e.applyBlink()}clearBlink(){var e=this._getHandler();e&&e.clearBlink()}applyReplacement(){var e=this._getHandler();e&&(e.applyReplacement(),this.manager.setRenderStateChanged(!0))}_removeMeshNodeGroup(){this._removeNodeGroup(r.ObjectGroupType.GEOMETRY),this._removeNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY),this._removeNodeGroup(r.ObjectGroupType.WIREFRAME),this._removeNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),this._removeSceneGroup(),this._rootNodeGroup.transformMatrix=null,this._rootNodeGroup=null}_getNodeGroup(e,t){for(var i=this._rootNodeGroup.children,n=0,a=i.length;n<a;n++)if(i[n].name==e)return i[n];var s=new r.ObjectGroup(e,t);switch(this._rootNodeGroup.add(s),s.globalSpace&&(s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0)),e){case r.ObjectGroupType.GEOMETRY:case r.ObjectGroupType.INSTANCEGEOMETRY:s.renderOrder=r.EnumRenderOrder.Component;break;case r.ObjectGroupType.WIREFRAME:case r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY:s.renderOrder=r.EnumRenderOrder.WireFrame}return s}_removeNodeGroup(e){this._rootNodeGroup.removeByName(e)}_hasNodeGroup(e){return this._rootNodeGroup.hasChild(e)}_removeSceneGroup(){this.manager.scene.removeObjectGroupByName(this._rootNodeGroupName),this.manager.scene.removeObjectGroupByName(this._getWireframeGroupName())}removeAllFromOctantMap(){this.manager.removeAllFromOctantMap(this.getEncodedDatabagId())}clearMeshFromOctantMap(){this.manager.clearMeshFromOctantMap(this.getEncodedDatabagId())}getMaterialManager(){return this.materialManager}clearWireframeElementCount(){this.wireframeElementCount=void 0}getWireframeElementCount(){if(void 0!==this.wireframeElementCount)return this.wireframeElementCount;var e=this.getModelDescriptor().getAllNodeInfos(),t=this.getFilter(),i=0;for(var r in e){var n=e[r];t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(n[0])||(i+=n.length)}return this.wireframeElementCount=i,i}isActivateWireframe(){return this.manager.isDrawingBoardlineEnabled()}isOnlyWireframe(){return this.manager.isOnlyWireframe()}getLoadedUserIdsObject(){return this._handler&&this._handler.getLoadedUserIdsObject?this._handler.getLoadedUserIdsObject():null}clearNodeGroup(){var e=this._getNodeGroup(r.ObjectGroupType.GEOMETRY,{globalSpace:!0});e.clear(),(e=this._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})).clear(),(e=this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})).clear(),(e=this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})).clear(),(e=this.manager.scene.getObjectGroup(this._getWireframeGroupName()))&&e.clear()}getWireframeMaterial(){return this.wireframeManager.wireframeMaterial}getInstanceWireframeMaterial(){return this.wireframeManager.instanceWireframeMaterial}getMaterialByMaterialId(e){return this.materialManager.materials[e]}adjustProgressPercentage(e,t,i){this.progressPercentage.load=e,this.progressPercentage.collect=t,this.progressPercentage.merge=i}setReplacedUserIdMap(e){r.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}hasReplacedUserId(){return!r.Utils.isEmptyObject(this.replacedUserIdMap)}isReplacedUserId(e){return this.replacedUserIdMap&&this.replacedUserIdMap[e]}registerPlugin(e){this.plugins.push(e)}disposeBufferAfterVbo(){var e=this._getHandler();e&&e.disposeBufferAfterVbo()}isHiddenUserId(e){var t=this._getHandler();return!!t&&t.isHiddenNode(e)}isHiddenSourceObjectUserId(e){return this.manager.isHiddenSourceObjectUserId(e,this.id)}hasHiddenSourceObjectUserId(){return this.manager.hasHiddenSourceObjectUserId()}getModelDescriptor(){return this._handler?this._handler.loader.getDescriptor():null}getLoader(){return this._handler.loader}getConfig(){return this.configLoader.getConfig()}getVersion(){return this.configLoader.getVersion()}getTransforms(){return this.configLoader.getTransforms()}getStatistics(){return this.configLoader.getStatistics()}setRenderableCount(e){this.configLoader.setRenderableCount(e),this._handler&&this._handler.clearPriorityNodesSet&&this._handler.clearPriorityNodesSet(!0)}getRenderableCount(){return this.configLoader.getStatistics().renderableCount}getBoundingBoxWorld(){if(!this.configLoader.getTransforms().boundingBox)return null;return this.configLoader.getTransforms().boundingBox.clone().applyMatrix4(this.getTransformMatrix())}calculateClippingIds(e,t){var i=this._getHandler();i&&(this.filter.objectInfoManager.clearClippingIds(),i.calculateClippingIds(e,t),this.filter.objectInfoManager.setClippingIds(this.mapClippingIds))}calculateClippingContours(e){var t=this._getHandler();t&&t.calculateClippingContours(e)}getOctreeRoots(e){this.getModelDescriptor().getOctreeRoots(e)}isUserIdExist(e){return this.getModelDescriptor().isUserIdExist(e)}getNodeInfosByUserId(e){let t=this.getModelDescriptor().getNodeInfosByUserId(e);return t&&t instanceof Array&&(t[0].transformMatrix=this.getTransformMatrix()),t}getAllNodeInfos(){return this.getModelDescriptor()?this.getModelDescriptor().getAllNodeInfos():null}updateMaterialsValue(e,t,i){this.materialManager.updateMaterialsValue(this,e,t,i)}updateMaterials(){this.materialManager.updateMaterials(this)}switchNewStyleMaterial(e){this.materialManager.switchNewStyleMaterial(this,e)}changeAllMaterials(e){this.materialManager.changeAllMaterials(this,e),this.isAllMaterialChanged=!0}adjustVisibility(e){this._getHandler().adjustVisibility(e)}changeVisibilityOfSelectedObjects(e){this._getHandler().changeVisibilityOfSelectedObjects(e)}changeVisibilityOfNonSelectedObjects(e){this._getHandler().changeVisibilityOfNonSelectedObjects(e)}adjustInstanceVisibility(e){this._getHandler().adjustInstanceVisibility(e)}changeInstanceVisibilityOfSelectedObjects(e){this._getHandler().changeInstanceVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfNonSelectedObjects(e){this._getHandler().changeInstanceVisibilityOfNonSelectedObjects(e)}restoreVisibilityOfObjects(){this._getHandler().restoreVisibilityOfObjects()}isUseable(){return this.isLoaded()&&this.isVisible()}getFilter(){return this.filter}getMeshesForCap(e,t){let i=this.getId();if(e[i]=new r.ObjectGroup,e[i].matrix.copy(this.getTransformMatrix()),e[i].matrixAutoUpdate=!1,!this._handler)return;let n=this.getModelDescriptor().getAllNodeInfos(),a=this.materialManager.getBackMaterials();var s=this._handler.instancedManager;if(s.hasNodeInfo(this)){(l=s.getMeshManager().getPickingNodeGenerator(t).updatePickingMeshesStateForCap(this,n,a.instanceMaterials))&&e[i].add(l)}var o=this._handler.defaultManager;if(o.hasNodeInfo(this)){var l=o.getMeshManager().getPickingNodeGenerator(t).updatePickingMeshesStateForCap(this,n,a.batchMaterials);l&&e[i].add(l)}}getPickingMeshes(e,t,i,n,a){let s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1,this._dealNonInstancedNodesForPicking(e,t[s],i,n,a),this._dealInstancedNodesForPicking(e,t[s],i,n,a),this._dealPluginNodesForPicking(e,t[s],i,n,a)}_dealNonInstancedNodesForPicking(e,t,i,r,n){if(this._handler){var a=this._handler.defaultManager;if(a.hasNodeInfo(this)){var s=a.getMeshManager().getPickingNodeGenerator(n),o=s.updatePickingMeshes(e,i,r,this);if(o&&t.add(o),!s.reserveMaterial){var l=a.getWireFrameManager().getPickingNodeGenerator(n).updatePickingMeshes(e,i,r,this);l&&t.add(l)}}}}_dealInstancedNodesForPicking(e,t,i,r,n){if(this._handler){var a=this._handler.instancedManager;if(a.hasNodeInfo(this)){var s=a.getMeshManager().getPickingNodeGenerator(n),o=s.updatePickingMeshes(e,i,r,this);if(o&&t.add(o),!s.reserveMaterial){var l=a.getWireFrameManager().getPickingNodeGenerator(n).updatePickingMeshes(e,i,r,this);l&&t.add(l)}}}}_dealPluginNodesForPicking(e,t,i,r,n){if(this._handler)for(var a=this.plugins,s=0,o=a.length;s<o;s++){var l=a[s].getPickingNodeGenerator(n).updatePickingMeshes(e,i,r);l&&t.add(l)}}getBlinkMaterials(){var e=this._getHandler();return e?e.getBlinkMaterials():[]}hasTransforms(){return!0}setPolygonClimpGroundInfo(e){this.materialManager.setPolygonClimpGroundInfo(e)}enableColorWithoutLight(e){this.materialManager.enableColorWithoutLight(e)}enableLocalClippingMode(e){this.localClippingMode=e;var t=this._handler.instancedManager.meshManager,i=this._handler.instancedManager.wireframeManager;if(t.updateInstanceClipping(e),i.updateInstanceWireframeClipping(e),!e){for(var r in this.localClippingPlanes=null,this.materialManager.materials){(n=this.materialManager.materials[r]).clippingPlanes=null}for(var r in this.materialManager.instanceMaterials){var n;if((n=this.materialManager.instanceMaterials[r])instanceof Array)for(var a=0,s=n.length;a<s;a++)n[a].clippingPlanes=null;else n.clippingPlanes=null}}}clone(){}getImageByUrl(e){return this.materialManager.getImageByUrl(e)}getDefaultUnit(){return r.EnumLengthlUnits.Millimeter}getVertexOffsetMatrix(){if(void 0!==this._vertexOffsetMatrix)return this._vertexOffsetMatrix;const e=this.config.view.translation;return this._vertexOffsetMatrix=e?(new THREE.Matrix4).makeTranslation(-e[0],-e[1],-e[2]):null,this._vertexOffsetMatrix}getAllNodeGroups(){return this._rootNodeGroup.children}getAllWireframeGroupNames(){return[r.ObjectGroupType.WIREFRAME,r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,this._getWireframeGroupName()]}getObjectGroup(){return this._rootNodeGroup}collectBlinkedMaterial(e,t){for(const i of e){const e=this.getAllNodeInfos()[i];e&&e.map((e=>{if(!0===e.instanceOrNot){this.materialManager.instanceMaterials[e.materialId].map((e=>{t.push(e)}))}else{const r=this.filter._getOverrideMaterialById(i)||this.materialManager.materials[e.materialId],n=`blink#${r.name}#${i}`,a=this.manager.sceneState.getBlinkMaterial(r,n);t.push(a)}}))}}getAllUserIds(){return Object.keys(this.getModelDescriptor().getAllNodeInfos())}updateNodeInfosForPlugins(){this.plugins&&this.plugins.length&&this.plugins.forEach((e=>{e.addToNodeInfoMap&&e.addToNodeInfoMap()}))}}r.Model=e}(),r.Loader.IdReader=function(e){var t=new Uint32Array(e,0,2);this.size=t[0],this.count=t[1],this.cache={},this.idBuffer=e.slice(8),t=null},r.Loader.IdReader.prototype={constructor:r.Loader.IdReader,getSize:function(){return this.size},getCount:function(){return this.count},getString:function(e){if(void 0!==this.cache[e])return this.cache[e];if(e>=0&&e<this.count){var t=new Uint8Array(this.idBuffer,this.size*e,this.size),i=String.fromCharCode.apply(null,t),r=i.indexOf("\0");return this.cache[e]=-1!==r?i.substring(0,r):i,this.cache[e]}},getIndex:function(e){if(null==e)return-1;for(var t=0,i=this.count-1,r=e.length;t<=i;){var n=Math.floor((t+i)/2),a=new Uint8Array(this.idBuffer,this.size*n,r),s=String.fromCharCode.apply(null,a),o=s.indexOf("\0"),l=0;if(0==(l=-1!==o?e.localeCompare(s.substring(0,o)):e.localeCompare(s)))return n;l<0?i=n-1:l>0&&(t=n+1)}return-1}},r.Loader.UserDataReader=function(e){for(var t in this.userData=JSON.parse(e),this.count=0,this.userData)this.userData.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.userData},this.getUserData=function(e){if(e>=0&&e<this.count)return this.userData[e+""]}},r.Loader.OctNode=function(e,t){var i=new Uint32Array(e,t,5);this.cell_id=i[0],this.child_s=i[3],this.child_e=i[4];var r=new Float32Array(e,t+20,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5]))},r.Loader.OctreeReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.data=new Array(this.count);for(var i=0;i<this.count;++i)this.data[i]=new r.Loader.OctNode(e,4*(1+11*i))},r.Loader.OctreeReader.prototype={constructor:r.Loader.OctreeReader,getCount:function(){return this.count},getNode:function(e){if(e>=0&&e<this.count)return this.data[e]}},r.Loader.Material=function(e,t){var i=new Uint32Array(e,t,8);this.id=i[0],this.type=i[1],this.metal=i[2],this.color=i[3],this.emissive=i[4],this.specular=i[5],this.side=i[6],this.texture_n=i[7],this.texture_id=new Uint32Array(e,t+32,8);var r=new Float32Array(e,t+64,3);this.shininess=r[0],this.opacity=r[1],this.reflectivity=r[2],i=null,r=null},r.Loader.Texture=function(e,t){var i=new Uint32Array(e,t,4);this.id=i[0],this.type=i[1],this.repeat_u=i[2],this.repeat_v=i[3];var r=new Float32Array(e,t+16,5);this.angle=r[0],this.offset_u=r[1],this.offset_v=r[2],this.scale_u=r[3],this.scale_v=r[4];var n=new Uint8Array(e,t+36,8),a=String.fromCharCode.apply(null,n);this.file_name_ext=a.substring(0,a.indexOf("\0")),i=null,r=null,n=null},r.Loader.MaterialReader=function(e){var t=new Uint32Array(e,0,4);this.materialCount=t[0],this.materialOffset=t[1],this.textureCount=t[2],this.textureOffset=t[3],this.materialSize=76,this.textureSize=44,this.materialBuffer=e.slice(this.materialOffset,this.materialOffset+this.materialCount*this.materialSize),this.textureBuffer=e.slice(this.textureOffset,this.textureOffset+this.textureCount*this.textureSize),this.material_id=-1,this.texture_id=-1;var i=new ArrayBuffer(this.materialSize);this.material_cur=new r.Loader.Material(i,0),this.texture_cur=new r.Loader.Texture(i,0),t=null,i=null},r.Loader.MaterialReader.prototype={constructor:r.Loader.MaterialReader,getMaterial:function(e){if(e>=0&&e<this.materialCount)return new r.Loader.Material(this.materialBuffer,e*this.materialSize)},getTexture:function(e){if(e>=0&&e<this.textureCount)return new r.Loader.Texture(this.textureBuffer,e*this.textureSize)},getMaterialInfo:function(e){if(e==this.material_id)return this.material_cur;if(e>=0&&e<this.materialCount){var t=new Uint32Array(this.materialBuffer,e*this.materialSize,8);this.material_cur.id=t[0],this.material_cur.type=t[1],this.material_cur.metal=t[2],this.material_cur.color=t[3],this.material_cur.emissive=t[4],this.material_cur.specular=t[5],this.material_cur.side=t[6],this.material_cur.texture_n=t[7],this.material_cur.texture_id=new Uint32Array(this.materialBuffer,e*this.materialSize+32,8);var i=new Float32Array(this.materialBuffer,e*this.materialSize+64,3);return this.material_cur.shininess=i[0],this.material_cur.opacity=i[1],this.material_cur.reflectivity=i[2],t=null,i=null,this.material_id=e,this.material_cur}},getTextureInfo:function(e){if(e==this.texture_id)return this.texture_cur;if(e>=0&&e<this.textureCount){var t=new Uint32Array(this.textureBuffer,e*this.textureSize,4);this.texture_cur.id=t[0],this.texture_cur.type=t[1],this.texture_cur.repeat_u=t[2],this.texture_cur.repeat_v=t[3];var i=new Float32Array(this.textureBuffer,e*this.textureSize+16,5);this.texture_cur.angle=i[0],this.texture_cur.offset_u=i[1],this.texture_cur.offset_v=i[2],this.texture_cur.scale_u=i[3],this.texture_cur.scale_v=i[4];var r=new Uint8Array(this.textureBuffer,e*this.textureSize+36,8),n=String.fromCharCode.apply(null,r);return this.texture_cur.file_name_ext=n.substring(0,n.indexOf("\0")),t=null,i=null,r=null,this.texture_id=e,this.texture_cur}}},r.Loader.MaterialReaderJson=function(e){if(this.count=0,this.Data=JSON.parse(e),this.Data.hasOwnProperty("materials")&&(this.materials=this.Data.materials),this.Data.hasOwnProperty("metadata")&&(this.metadata=this.Data.metadata,this.metadata.hasOwnProperty("count")&&(this.count=this.metadata.count)),0===this.count)for(var t in this.materials)this.materials.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getMaterial=function(e){if(e>=0&&e<this.count)return this.materials[e+""]}},r.Loader.LayerKeyReader=function(e){for(var t in this.LayerKey=JSON.parse(e),this.count=0,this.LayerKey)this.LayerKey.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.LayerKey},this.getLayerKey=function(e){if(e>=0&&e<this.count)return this.LayerKey[e+""]}},r.Loader.LayerHeader=function(e){var t=new Uint32Array(e,0,4);this.layerCount=t[0],this.mpkBufferSize=t[1],this.layerOffset=t[2],this.mpkOffset=t[3];var i=new Float32Array(e,24,4);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.LayerData=function(e,t){var i=new Int32Array(e,t,3);this.layer_id=i[0],this.layer_mpk_index=i[1],this.layer_mpk_count=i[2];var r=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.LayerReader=function(e){this.header=new r.Loader.LayerHeader(e),this.DataSize=36,this.dataBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerCount*this.DataSize),this.mpkBuffer=e.slice(this.header.mpkOffset,this.header.mpkOffset+this.header.mpkBufferSize)},r.Loader.LayerReader.prototype={constructor:r.Loader.LayerReader,getLayerData:function(e){if(e>=0&&e<this.header.layerCount)return new r.Loader.LayerData(this.dataBuffer,e*this.DataSize)},getMpkList:function(e){var t=this.getLayerData(e);if(null!=t)return new Uint32Array(this.mpkBuffer,4*t.layer_mpk_index,t.layer_mpk_count)},getLayerCount:function(){return this.header.layerCount}},r.Loader.SymbolHeader=function(e){var t=new Uint32Array(e,0,9);this.blockId=t[0],this.symbolCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.symbolOffset=t[5],this.itemOffset=t[6],this.matrixOffset=t[7],this.geomOffset=t[8];var i=new Float32Array(e,36,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.Symbol=function(e,t){var i=new Int32Array(e,t,3);this.symbolId=i[0],this.itemIndex=i[1],this.itemCount=i[2];var r=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.SymbolReader=function(e,t){this.header=new r.Loader.SymbolHeader(e),this.symbolSize=36,this.itemSize=52,this.matrixSize=r.Compatibility.getMatrixSize(t),this.matrixDataType=r.Compatibility.getMatrixDatatype(t),this.geomSize=32,this.maxSize=256,this.boxUvSize=36,this.pipeUvSize=18,this.symbolBuffer=e.slice(this.header.symbolOffset,this.header.symbolOffset+this.header.symbolCount*this.symbolSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.matr_cur_id=-1,this.pt_symb_min=new THREE.Vector3(0,0,0),this.pt_symb_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var i=new ArrayBuffer(this.maxSize);this.symb_cur=new r.Loader.Symbol(i,0),this.item_cur=new r.Loader.Item(i,0),this.matr_cur=new r.Loader.Matrix(i,0,this.matrixDataType),this.pipe_cur=new r.Loader.GeomPipe(i,0),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},r.Loader.SymbolReader.prototype={constructor:r.Loader.SymbolReader,getSymbol:function(e){if(e>=0&&e<this.header.symbolCount)return new r.Loader.Symbol(this.symbolBuffer,e*this.symbolSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new r.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new r.Loader.Matrix(this.matrixBuffer,e*this.matrixSize,this.matrixDataType)},getGeomPipe:function(e){if(e>=0&&index<this.header.geomBuffSize)return new r.Loader.GeomPipe(this.geomBuffer,e)},getSymbolInfo:function(e){if(e>=0&&e<this.header.symbolCount){var t=new Int32Array(this.symbolBuffer,e*this.symbolSize,3);this.symb_cur.symbolId=t[0],this.symb_cur.itemIndex=t[1],this.symb_cur.itemCount=t[2];var i=new Float32Array(this.symbolBuffer,e*this.symbolSize+12,6);return this.pt_symb_min.set(i[0],i[1],i[2]),this.pt_symb_max.set(i[3],i[4],i[5]),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.symb_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){const t=new this.matrixDataType(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},r.Loader.MPKHeader=function(e){var t=new Uint32Array(e,0,6);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.bufferSize=t[4],this.bufferOffset=t[5],t=null},r.Loader.MeshData=function(e,t){var i=new Uint32Array(e,t,5);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.dataOffset=i[3],this.vertexFormat=i[4];var r=new Float32Array(e,t+20,4);this.baseScale=r[0],this.baseX=r[1],this.baseY=r[2],this.baseZ=r[3],i=null,r=null},r.Loader.MPKReader=function(e){this.header=new r.Loader.MPKHeader(e),this.meshSize=36,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.geomBuffer=e.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new r.Loader.MeshData(t,0)},r.Loader.MPKReader.prototype={constructor:r.Loader.MPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new r.Loader.MeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,5);this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.dataOffset=t[3],this.mesh_cur.vertexFormat=t[4];var i=new Float32Array(this.meshBuffer,e*this.meshSize+20,4);return this.mesh_cur.baseScale=i[0],this.mesh_cur.baseX=i[1],this.mesh_cur.baseY=i[2],this.mesh_cur.baseZ=i[3],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return 0==t.baseScale?new Float32Array(this.geomBuffer,t.dataOffset,3*t.ptCount):new Uint16Array(this.geomBuffer,t.dataOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vertexFormat))return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),2==(2&this.header.vtFormat)&&(i+=3*t.ptCount*4),new Float32Array(this.geomBuffer,i,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var i=this.getMeshInfo(e),r=void 0!==t?!t:4==(4&i.vFormat);return{meshId:i.mesh_id,positionStart:i.vOffset/4,positionCount:3*i.ptCount,indexStart:i.iOffset/4,indexCount:i.idxCount,uvStart:r?i.tOffset/4:0,uvCount:r?2*i.ptCount:0}}},hasUV:function(e){if(!(e<0||e>=this.header.meshCount))return 4==(4&this.getMeshInfo(e).vFormat)}},r.Loader.BMPKHeader=function(e){var t=new Uint32Array(e,0,12);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],this.matCount=0,t=null},r.Loader.BMPKMatrixHeader=function(e){var t=new Uint32Array(e,0,14);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],this.matCount=t[12],this.matBufferOffset=t[13],t=null},r.Loader.BMeshData=function(e,t){var i=new Uint32Array(e,t,8);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.vFormat=i[3],this.vOffset=i[4],this.iOffset=i[5],this.nOffset=i[6],this.tOffset=i[7],i=null},r.Loader.BMPKReader=function(e,t){this.header=null,r.Compatibility.isUseDoubleMatrixMPKHeader(t)?this.header=new r.Loader.BMPKMatrixHeader(e):this.header=new r.Loader.BMPKHeader(e),this.meshSize=32,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.vBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.iBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.nBuffer=e.slice(this.header.norBufferOffset,this.header.norBufferOffset+this.header.norBufferSize),this.tBuffer=e.slice(this.header.uvBufferOffset,this.header.uvBufferOffset+this.header.uvBufferSize),1===this.header.matCount&&(this.curMatrix=new r.Loader.Matrix(e,this.header.matBufferOffset,Float64Array).matrix.clone()),this.mesh_cur_id=-1;var i=new ArrayBuffer(this.maxSize);this.mesh_cur=new r.Loader.BMeshData(i,0)},r.Loader.BMPKReader.prototype={constructor:r.Loader.BMPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new r.Loader.BMeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,8);return this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.vFormat=t[3],this.mesh_cur.vOffset=t[4],this.mesh_cur.iOffset=t[5],this.mesh_cur.nOffset=t[6],this.mesh_cur.tOffset=t[7],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.vBuffer,t.vOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Uint32Array(this.iBuffer,t.iOffset,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.nBuffer,t.nOffset,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vFormat))return;return new Float32Array(this.tBuffer,t.tOffset,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var i=this.getMeshInfo(e),r=void 0!==t?!t:4==(4&i.vFormat);return{meshId:i.mesh_id,positionStart:i.vOffset/4,positionCount:3*i.ptCount,indexStart:i.iOffset/4,indexCount:i.idxCount,uvStart:r?i.tOffset/4:0,uvCount:r?2*i.ptCount:0}}},hasUV:function(e){if(!(e<0||e>=this.header.meshCount))return 4==(4&this.getMeshInfo(e).vFormat)},getMatrix:function(){return this.curMatrix}},r.Loader.BMeshIdReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.cache={};for(var i=new Uint32Array(e,4,this.count),r=0;r<this.count;r+=2){var n=i[r];this.cache[n]=i[r+1]}t=null,i=null},r.Loader.BMeshIdReader.prototype={constructor:r.Loader.BMeshIdReader,getCount:function(){return this.count},getBMeshId:function(e){return this.cache[e]}},r.Loader.LineHeader=function(e){var t=new Uint32Array(e,0,7);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],t=null},r.Loader.LineMatrixHeader=function(e){let t=new Uint32Array(e,0,9);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],this.matCount=t[7],this.matBufferOffset=t[8],t=null},r.Loader.LineData=function(e,t){var i=new Uint32Array(e,t,6);this.line_id=i[0],this.lineType=i[1],this.ptCount=i[2],this.ptOffset=i[3],this.idxCount=i[4],this.idxOffset=i[5],i=null},r.Loader.LineReader=function(e,t){this.header=null,r.Compatibility.isUseDoubleMatrixMPKHeader(t)?this.header=new r.Loader.LineMatrixHeader(e):this.header=new r.Loader.LineHeader(e),this.lineSize=24,this.ptSize=12,this.lineBuffer=e.slice(this.header.lineOffset,this.header.lineOffset+this.header.lineCount*this.lineSize),this.ptBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.idxBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),1===this.header.matCount&&(this.curMatrix=new r.Loader.Matrix(e,this.header.matBufferOffset,Float64Array).matrix.clone()),this.line_cur_id=-1;var i=new ArrayBuffer(this.lineSize);this.line_cur=new r.Loader.LineData(i,0)},r.Loader.LineReader.prototype={constructor:r.Loader.LineReader,getLineData:function(e){if(e>=0&&e<this.header.lineCount)return new r.Loader.LineData(this.lineBuffer,e*this.lineSize)},getLineInfo:function(e){if(e==this.line_cur_id)return this.line_cur;if(e>=0&&e<this.header.lineCount){var t=new Uint32Array(this.lineBuffer,e*this.lineSize,6);return this.line_cur.line_id=t[0],this.line_cur.lineType=t[1],this.line_cur.ptCount=t[2],this.line_cur.ptOffset=t[3],this.line_cur.idxCount=t[4],this.line_cur.idxOffset=t[5],this.line_cur_id=e,this.line_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;return new Float32Array(this.ptBuffer,t.ptOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;var i=new Uint32Array(this.idxBuffer,t.idxOffset,t.idxCount),r=t.ptOffset/this.ptSize;return i.forEach((function(e,t,i){i[t]-=r})),i}},getMatrix:function(){return this.curMatrix}},r.Loader.CameraReader=function(e){this.cameras=JSON.parse(e)},r.Loader.CameraReader.prototype.parse=function(e,t){function i(e,i){i.uuid=e.uuid,void 0!==e.name&&(i.name=e.name);var r=new THREE.Matrix4;if(void 0!==e.matrix)r.fromArray(e.matrix);else{var n=new THREE.Vector3,a=new THREE.Quaternion,s=new THREE.Vector3;if(void 0!==e.position&&n.fromArray(e.position),void 0!==e.rotation){var o=new THREE.Vector3;o.fromArray(e.rotation);var l=new THREE.Euler(o[0]*Math.PI/180,o[1]*Math.PI/180,o[2]*Math.PI/180,"XYZ");a.setFromEuler(l)}void 0!==e.quaternion&&a.fromArray(e.quaternion,0),void 0!==e.scale&&i.scale.fromArray(e.scale),r.compose(n,a,s)}r.multiply(t),r.decompose(i.position,i.quaternion,i.scale)}var n,a,s=this.cameras;if(s.Orthographic){var o=s.Orthographic;for(var l in o)i(a=o[l],n=new r.Camera(r.CAMERATYPE.ORTHOGRAPHIC,a)),e.addCamera(n)}if(s.Perspective){var d=s.Perspective;for(var l in d)a=d[l],n=new r.Camera(r.CAMERATYPE.PERSPECTIVE,a),void 0!==a.focus&&(n.focus=a.focus),void 0!==a.zoom&&(n.zoom=a.zoom),void 0!==a.filmGauge&&(n.filmGauge=a.filmGauge),void 0!==a.filmOffset&&(n.filmOffset=a.filmOffset),void 0!==a.view&&(n.view=Object.assign({},a.view)),i(a,n),e.addCamera(n)}},r.Loader.SceneHeader=function(e){var t=new Uint32Array(e,0,11);this.blockId=t[0],this.cellCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.layerBuffSize=t[5],this.cellOffset=t[6],this.itemOffset=t[7],this.matrixOffset=t[8],this.geomOffset=t[9],this.layerOffset=t[10];var i=new Float32Array(e,44,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.Cell=function(e,t){var i=new Int32Array(e,t,5);this.cellId=i[0],this.depth=i[1],this.itemIndex=i[2],this.itemCount=i[3],this.layerType=i[4],this.layerSize=new Int32Array(e,t+20,8),this.layerOffset=new Int32Array(e,t+52,8);var r=new Float32Array(e,t+84,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.Item=function(e,t){var i=new Int32Array(e,t,7);this.ItemId=i[0],this.originalId=i[1],this.materialId=i[2],this.userDataId=i[3],this.matrixId=i[4],this.type=i[5],this.toData=i[6];var r=new Float32Array(e,t+28,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.Matrix=function(e,t,i){const r=4*i.BYTES_PER_ELEMENT*4;let n=new i(e.slice(t,t+r),0,16);this.matrix=(new THREE.Matrix4).fromArray(n),n=null},r.Loader.GeomPipe=function(e,t){var i=new Float32Array(e,t,8);this.startPt=new THREE.Vector3(i[0],i[1],i[2]),this.endPt=new THREE.Vector3(i[3],i[4],i[5]),this.radius=i[6],this.thickness=i[7],i=null},r.Loader.SceneReader=function(e,t){this.header=new r.Loader.SceneHeader(e),this.cellSize=108,this.itemSize=52,this.matrixSize=r.Compatibility.getMatrixSize(t),this.matrixDataType=r.Compatibility.getMatrixDatatype(t),this.maxSize=1024,this.boxUvSize=36,this.pipeUvSize=18,this.cellBuffer=e.slice(this.header.cellOffset,this.header.cellOffset+this.header.cellCount*this.cellSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.layerBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerBuffSize),this.matr_cur_id=-1,this.pt_cell_min=new THREE.Vector3(0,0,0),this.pt_cell_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var i=new ArrayBuffer(this.maxSize);this.cell_cur=new r.Loader.Cell(i,0),this.item_cur=new r.Loader.Item(i,0),this.matr_cur=new r.Loader.Matrix(i,0,this.matrixDataType),this.pipe_cur=new r.Loader.GeomPipe(i,0),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},r.Loader.SceneReader.prototype={constructor:r.Loader.SceneReader,getCellMpks:function(e){if(e>=0&&e<this.header.cellCount){for(var t=[],i=this.getCellInfo(e),r=i.itemIndex;r<i.itemCount;++r){var n=this.getItemInfo(r);if(1===n.type){var a=this.getMpkID(n.toData);t.push(a)}}for(var s={},o=[],l=0;l<t.length;++l)s[t[l]]||(s[t[l]]=!0,o.push(t[l]));return o}},getCell:function(e){if(e>=0&&e<this.header.cellCount)return new r.Loader.Cell(this.cellBuffer,e*this.cellSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new r.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new r.Loader.Matrix(this.matrixBuffer,e*this.matrixSize,this.matrixDataType)},getGeomPipe:function(e){if(e>=0&&e<this.header.geomBuffSize)return new r.Loader.GeomPipe(this.geomBuffer,e)},getCellInfo:function(e){if(e>=0&&e<this.header.cellCount){var t=new Int32Array(this.cellBuffer,e*this.cellSize,5);this.cell_cur.cellId=t[0],this.cell_cur.depth=t[1],this.cell_cur.itemIndex=t[2],this.cell_cur.itemCount=t[3],this.cell_cur.layerType=t[4],this.cell_cur.layerSize=new Int32Array(this.cellBuffer,e*this.cellSize+20,8),this.cell_cur.layerOffset=new Int32Array(this.cellBuffer,e*this.cellSize+52,8);var i=new Float32Array(this.cellBuffer,e*this.cellSize+84,6);return this.pt_cell_min.set(i[0],i[1],i[2]),this.pt_cell_max.set(i[3],i[4],i[5]),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.cell_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){const t=new this.matrixDataType(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getLayerInfo:function(e,t){if(e>=0&&e+t<=this.header.layerBuffSize){new Uint32Array(this.layerBuffer,e,t);return this.data}},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},r.Loader.LayerIndex=function(e,t){var i=new Uint32Array(e,t,2);this.layer_id=i[0],this.item_index=i[1]},r.Loader.LayerIndexReader=function(e){var t=new Uint32Array(e,0,2);this.cell_count=t[0],this.data_count=t[1],this.headerSize=8,this.cellSize=108,this.dataSize=8;var i=this.cell_count*this.cellSize,r=this.data_count*this.dataSize;this.cellBuffer=e.slice(this.headerSize,this.headerSize+i),this.dataBuffer=e.slice(this.headerSize+i,this.headerSize+i+r)},r.Loader.LayerIndexReader.prototype={constructor:r.Loader.LayerIndexReader,getCell:function(e){if(e>=0&&e<this.cell_count)return new r.Loader.Cell(this.cellBuffer,e*this.cellSize)},getLayerIndex:function(e){if(e>=0&&e<this.data_count)return new r.Loader.LayerIndex(this.dataBuffer,e*this.dataSize)}},r.ModelView.MeshBaseManager=class{constructor(){this.geometries={}}destroy(){this.disposeGeometries(),this.geometries=null}disposeGeometries(){for(var e in this.geometries)this.disposeGeometry(e)}disposeGeometry(e){var t=this.geometries[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.geometries[e]}}_hasGeometry(e){return!!this.geometries[e]}_cacheGeometry(e,t){void 0===this.geometries[e]&&(this.geometries[e]=t)}getGeometryById(e){return this.geometries[e]}getGeometryByNodeInfo(e,t){return this._hasGeometry(t.geometryIdCode)?this.getGeometryById(t.geometryIdCode):this._createGeometryByNodeInfo(e,t)}_createGeometryByNodeInfo(e,t){return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),e.lightmap)}_createGeometry(e,t,i,r,n){if(this._hasGeometry(t))return this.getGeometryById(t);const a=this._createBufferGeometry(e,i,r,n);return a?(this._cacheGeometry(t,a),a):null}_createBufferGeometry(e,t,i,n){const a=r.ModelView.BaseDescriptor.EnumNodeItemType;let s=null;switch(e){case a.MESH:case a.MESH_REF:s=r.GeomUtil.getBufferGeometry(i,t);break;case a.LINE:s=r.GeomUtil.getLineBufferGeometry(i,t);break;case a.TUBE:case a.PIPE:s=r.GeomUtil.getPipeBufferGeometry(t,n);break;case a.PIPE_M:s=r.GeomUtil.getPipeMBufferGeometry(t,n);break;case a.BOX:s=r.GeomUtil.getBoxBufferGeometry(t,n);break;case a.BOX_M:s=r.GeomUtil.getBoxMBufferGeometry(t,n)}return s}createBufferByBufferDataWithUV2(e,t,i,n){var a=this.createBufferByBufferData(t,i,n,r.Compatibility.isUseDoubleMatrixMPKHeader(this.version));if(!a)return null;if(!e.lightmap)return a;var s=[],o=a.index,l=e.getLoader().getUV2ById(t.itemIdUV2,o.length);return l&&(t.lightmapIdx=l.lightmapIdx,t.materialId=t.materialId+"_"+t.lightmapIdx,s=l.uv2),this._expandNodeBufferWithUV2(a,s)}_expandNodeBufferWithUV2(e,t){for(var i=e.position,r=e.normal,n=e.uv,a=e.index,s=[],o=[],l=[],d=[],h=[],c=0,u=0;u<a.length;u++){var p=a[u];null==h[p]||t[2*h[p]]!=t[2*u]||t[2*h[p]+1]!=t[2*u+1]?(s.push(i[3*p]),s.push(i[3*p+1]),s.push(i[3*p+2]),r&&(o.push(r[3*p]),o.push(r[3*p+1]),o.push(r[3*p+2])),n&&(l.push(n[2*p]),l.push(n[2*p+1])),d.push(t[2*u]),d.push(t[2*u+1]),a[u]=c,c++,null==h[p]&&(h[p]=u)):a[u]=a[h[p]]}return i=null,r=null,n=null,t=null,h=null,e.uv2=d,e.position=s,e.normal=o,e.uv=l,e}createBufferForSharedMeshByBufferDataWithUV2(e,t,i,r){var n=this.createBufferByBufferData(t,i,r);if(!n)return null;if(!e.lightmap)return n;var a=[],s=n.index,o=e.getLoader().getInstanceUV2ForSharedMeshById(t.itemIdUV2,s.length);return o&&(t.uv2Info=o,t.lightmapIdx=o.lightmapIdx,t.materialId=t.materialId+"_"+t.lightmapIdx,a=o.uv2),this._expandNodeBufferWithUV2(n,a)}createBufferByBufferData(e,t,i,n){const a=r.ModelView.BaseDescriptor.EnumNodeItemType;let s=null;switch(e.type){case a.MESH:case a.MESH_REF:s=r.GeomUtil.getGeometryBuffer(t,e.matrix,e.fromMirror,i,n);break;case a.LINE:s=r.GeomUtil.getLineGeometryBuffer(t,e.matrix,e.fromMirror,i);break;case a.TUBE:case a.PIPE:s=r.GeomUtil.getPipeGeometryBuffer(e.matrix,e.fromMirror,i);break;case a.PIPE_M:s=r.GeomUtil.getPipeMGeometryBuffer(e.uvArrayBuffer,e.matrix,e.fromMirror,i);break;case a.BOX:case a.BOX_M:s=r.GeomUtil.getBoxMGeometryBuffer(e.uvArrayBuffer,e.matrix,e.fromMirror,i);break;default:console.log("error data!")}return s&&(e.uv=!!s.uv),s}},(()=>{new THREE.Vector3;let e=new THREE.Vector3;class t{constructor(){this.symbolReader=null,this.userIdReader=null,this.userDataReader=null,this.mapSceneReader={},this.lightmap=!1,this.mapNodeInfoByCategory={},this.mapNodeInfoByUserId={},this.mapNodeInfoByCellId={},this.mapNodeInfoByParameterizedDesc={},this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null,this.referencedMeshCache={},this.cellCount=0,this.borderLines={},this.fullNodeInfoArray=[],this.sharedGeometryCounter={},this.octreeRootNode={inner:null,outer:null,layer:null},this._config=null}destroy(){this.destroyReader(),this.mapNodeInfoByCategory=null,this.mapNodeInfoByUserId=null,this.mapNodeInfoByCellId=null,this.mapNodeInfoByParameterizedDesc=null,this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null,this.referencedMeshCache=null,this.borderLines=null,this.octreeRootNode=null,this.fullNodeInfoArray=null,this.sharedGeometryCounter=null,this._config=null}destroyReader(){this.userIdReader=null,this.userDataReader=null,this.symbolReader=null,this.mapSceneReader=null}setConfigure(e){this._config=e}getConfigure(){return this._config}getSceneReaderMap(){return this.mapSceneReader}isValidScene(){return!r.Utils.isEmptyObject(this.getSceneReaderMap())||(r.Logger.log("model load not started!"),!1)}_classifyNodeInfo(e){this._cacheNodeInfoByCellId(e),this._cacheNodeInfoByUserId(e),this._cacheNodeInfoByCategory(e),this._cacheNodeInfoByParameterizedDesc(e)}classifyAllNodeInfo(){this.fullNodeInfoArray.forEach((e=>{e.instanceOrNot=this._isInstancedNode(e),this._classifyNodeInfo(e)})),this.fullNodeInfoArray.length=0,this.sharedGeometryCounter={}}_cacheNodeInfoByCellId(e){void 0===this.mapNodeInfoByCellId[e.cellId]&&(this.mapNodeInfoByCellId[e.cellId]=[]),this.mapNodeInfoByCellId[e.cellId].push(e)}_cacheNodeInfoByUserId(e){void 0===this.mapNodeInfoByUserId[e.userId]&&(this.mapNodeInfoByUserId[e.userId]=[]),this.mapNodeInfoByUserId[e.userId].push(e)}_cacheNodeInfoByCategory(e){var t;t=e.instanceOrNot?r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED:r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD,void 0===this.mapNodeInfoByCategory[t]&&(this.mapNodeInfoByCategory[t]={}),void 0===this.mapNodeInfoByCategory[t][e.userId]&&(this.mapNodeInfoByCategory[t][e.userId]=[]),this.mapNodeInfoByCategory[t][e.userId].push(e)}_cacheNodeInfoByParameterizedDesc(e){e.parameterizedDesc&&(void 0===this.mapNodeInfoByParameterizedDesc[e.type]&&(this.mapNodeInfoByParameterizedDesc[e.type]=[]),this.mapNodeInfoByParameterizedDesc[e.type].push(e))}_clearNodeInfoCacheWithParameterizedDesc(){this.mapNodeInfoByParameterizedDesc={}}_clearNodeInfoCacheWithCellId(){this.mapNodeInfoByCellId={}}_clearNodeInfoCacheWithCategory(){this.mapNodeInfoByCategory={}}_clearNodeInfoCacheWithUserId(){this.mapNodeInfoByUserId={}}clearNodeInfoCache(){this._clearNodeInfoCacheWithCellId(),this._clearNodeInfoCacheWithUserId(),this._clearNodeInfoCacheWithCategory(),this._clearNodeInfoCacheWithParameterizedDesc()}getNodeInfosByCellId(e){return this.mapNodeInfoByCellId[e]}getNodeInfosWithCellId(){return this.mapNodeInfoByCellId}getNodeInfosWithParameterizedDesc(){return this.mapNodeInfoByParameterizedDesc}getAllNodeInfos(){return this.mapNodeInfoByUserId}getNodeInfosByUserId(e){return this.mapNodeInfoByUserId[e]}getStandardNodeInfos(){return this.mapNodeInfoByCategory[r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD]}getInstancedNodeInfos(){return this.mapNodeInfoByCategory[r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED]}getStandardUserIds(){return this.getStandardNodeInfos()?Object.keys(this.getStandardNodeInfos()):[]}getInstancedUserIds(){return this.getInstancedNodeInfos()?Object.keys(this.getInstancedNodeInfos()):[]}getStandardNodeInfosById(e){var t=this.getStandardNodeInfos();return t?t[e]:null}getInstancedNodeInfosById(e){var t=this.getInstancedNodeInfos();return t?t[e]:null}_getUserIdsByCategory(e,t){var i,n=[];if(i=t===r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED?this.getInstancedNodeInfos():this.getStandardNodeInfos())for(var a=0,s=e.length;a<s;a++)i[e[a]]&&n.push(e[a]);return n}getInstancedUserIdsByCategory(e){return this._getUserIdsByCategory(e,r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED)}getStandardUserIdsByCategory(e){return this._getUserIdsByCategory(e,r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD)}_traverseNodeInfosByIds(e,t,i){for(var r=0,n=t.length;r<n;r++){var a=t[r];i(a,e[a])}}traverseStandardNodeInfos(e,t){var i=this.getStandardNodeInfos();i&&(e=e||this.getStandardUserIds(),this._traverseNodeInfosByIds(i,e,t))}traverseInstancedNodeInfos(e,t){var i=this.getInstancedNodeInfos();i&&(e=e||this.getInstancedUserIds(),this._traverseNodeInfosByIds(i,e,t))}traverseNodeInfosByCell(e){for(var t=Object.keys(this.mapNodeInfoByCellId),i=0,r=t.length;i<r;i++)for(var n=t[i],a=this.mapNodeInfoByCellId[n],s=0,o=a.length;s<o;s++)e(n,a[s])}clearReferencedMeshCache(){for(var e in this.referencedMeshCache)delete this.referencedMeshCache[e];this.referencedMeshCache=null}cacheReferencedMeshBufferData(e,t){this.referencedMeshCache.bufferData||(this.referencedMeshCache.bufferData={}),this.referencedMeshCache.bufferData[e]=t}getReferencedMeshBufferData(){return this.referencedMeshCache.bufferData}getReferencedMeshBufferById(e){return this.referencedMeshCache&&this.referencedMeshCache.bufferData?this.referencedMeshCache.bufferData[e]:null}cacheReferencedMeshMpkIds(e,t){this.referencedMeshCache.mpkIds||(this.referencedMeshCache.mpkIds={}),this.referencedMeshCache.mpkIds[e]||(this.referencedMeshCache.mpkIds[e]=[]),this.referencedMeshCache.mpkIds[e].push(t)}clearReferencedMeshCacheByMpkIdxs(e,t){if(this.referencedMeshCache.mpkIds)for(var i=0,r=e.length;i<r;i++){var n=e[i],a=this.referencedMeshCache.mpkIds[n];if(a){for(var s=0,o=a.length;s<o;s++)t&&t(a[s]),delete this.referencedMeshCache[a[s]];delete this.referencedMeshCache.mpkIds[n]}}}cacheBorderLine(e,t){var i=e?"shared":"unique";this.borderLines[i]||(this.borderLines[i]=[]),this.borderLines[i].push(t)}getSharedBorderLineCache(){return this.borderLines.shared}getUniqueBorderLineCache(){return this.borderLines.unique}_isParameterizedNode(e){return t.isParameterizedNode(e)}_isGeometrySharedNode(e){return t.isGeometrySharedNode(e)}_isInstancedNode(e){if(!r.GlobalData.Instance)return!1;if(e.parameterizedDesc)return!0;if(!r.GlobalData.InstanceSharedMeshEnabled)return!1;if(!this._isGeometrySharedNode(e))return!1;const t=r.GlobalData.InstanceSharedMeshThreshold;return(this.sharedGeometryCounter[e.geometryId]||0)>t}getCellCount(){return this.cellCount}getOctreeRootNode(){return this.octreeRootNode}isUseInnerAndOuterOctree(){return!0}isOctreeOuter(e){var t=this.octreeRootNode.inner||this.octreeRootNode.outer;return!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}getOctreeRoots(e){this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer),this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner)}updateOctreeNodeBy(t,i){var r=new THREE.Box3;function n(t,i){r.copy(t.boundingBoxWorld),r.applyMatrix4(i),t.min.copy(r.min),t.max.copy(r.max),t.center=r.getCenter(t.center),t.size=r.getSize(e).lengthSq()}n(t,i),function e(t,i){for(var r=0,a=t.childOctants.length;r<a;++r){var s=t.childOctants[r];n(s,i),e(s,i)}}(t,i)}updateOctreeNode(e,t){let i=t.clone().premultiply(e);var r=this.getOctreeRootNode();r.outer&&this.updateOctreeNodeBy(r.outer,i),r.inner&&this.updateOctreeNodeBy(r.inner,i)}removeFromSceneReaderMap(e){for(var t=0,i=e.length;t<i;t++)this.mapSceneReader[e[t]]&&delete this.mapSceneReader[e[t]]}isUserIdExist(e){return!!this.getNodeInfosByUserId(e)}addToNodeInfoMap(e){for(var t=0,i=e.length;t<i;t++)this._cacheNodeInfoByUserId(e[t])}removeFromNodeInfoMap(e){for(var t=this.getAllNodeInfos(),i=0,r=e.length;i<r;i++){var n=e[i].userId;t[n]&&delete t[n]}}cacheNodeInfosOnGeometryId(){this.cacheStandardNodeInfosOnGeometryId(),this.cacheInstancedNodeInfosOnGeometryId()}cacheStandardNodeInfosOnGeometryId(){this.mapStandardNodeInfoByGeometryId={},this._cacheNodeInfosOnGeometryIdBy(this.getStandardNodeInfos(),this.mapStandardNodeInfoByGeometryId)}cacheInstancedNodeInfosOnGeometryId(){this.mapInstancedNodeInfoByGeometryId={},this._cacheNodeInfosOnGeometryIdBy(this.getInstancedNodeInfos(),this.mapInstancedNodeInfoByGeometryId)}_cacheNodeInfosOnGeometryIdBy(e,t){if(!e)return;Object.keys(e).forEach((i=>{e[i].forEach((e=>{e.geometryId=this.convertGeometryId(e.geometryId),t[e.geometryId]||(t[e.geometryId]=[]),t[e.geometryId].push(e)}))}))}getStandardNodeInfosOnGeometryId(){return this.mapStandardNodeInfoByGeometryId||this.cacheStandardNodeInfosOnGeometryId(),this.mapStandardNodeInfoByGeometryId}getInstancedNodeInfosOnGeometryId(){return this.mapInstancedNodeInfoByGeometryId||this.cacheInstancedNodeInfosOnGeometryId(),this.mapInstancedNodeInfoByGeometryId}clearNodeInfosWithGeometryId(){this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null}convertGeometryId(e){return e}static getMeshIdFromOctantMap(e){return e.single?e.nodeId:e.instanceOrNot?e.uv2Info?r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode,e.uv2Info.byteOffset]):r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode]):r.GlobalData.BatchMergeEnabled?r.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===t.EnumNodeItemType.LINE?"lines":"meshes"]):e.nodeId}static isParameterizedNode(e){return e.type===t.EnumNodeItemType.TUBE||e.type===t.EnumNodeItemType.PIPE||e.type===t.EnumNodeItemType.BOX||e.type===t.EnumNodeItemType.BOX_M||e.type===t.EnumNodeItemType.PIPE_M}static isParameterizedNodeType(e){return e===t.parameterizedNodeType.TUBE||e===t.parameterizedNodeType.PIPE||e===t.parameterizedNodeType.PIPE_M||e===t.parameterizedNodeType.BOX||e===t.parameterizedNodeType.BOX_M}static isGeometrySharedNode(e){return e.type===t.EnumNodeItemType.MESH_REF}static isLineNode(e){return e.type===t.EnumNodeItemType.LINE}}t.EnumNodeItemType={SYMBOL:0,MESH:1,TUBE:2,PIPE:3,BOX:4,BOX_M:5,PIPE_M:6,MESH_REF:7,LINE:8},t.NodeInfoCategory={INSTANCED:0,STANDARD:1},t.parameterizedNodeType={BOX:"box",BOX_M:"boxM",PIPE:"pipe",PIPE_M:"pipeM",TUBE:"tube"},r.ModelView.BaseDescriptor=t})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;r.ModelView.BaseLoader=class{constructor(e,t){this.handler=e,this.model=e.model,this.url=e.model.dataUrl,this.fileLoader=e.model.fileLoader,this.descriptor=null,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.loadTextureCount=0,this.maxLoadTextureCount=0,this.textruesLoaded=!1,this.dataLoaded=!1,this.mpkTaskManager=new r.TaskManager,this.enableCompressedTexture=!1,this.startCallback=null,this.progressCallback=null,this.finishCallback=null,this.version=t}destroy(){this.mpkTaskManager=null,this.textureManager=null,this.url=null,this.fileLoader=null,this.descriptor&&(this.descriptor.destroy(),this.descriptor=null),this.model=null,this.handler=null,this.startCallback=null,this.progressCallback=null,this.finishCallback=null,this.version=void 0}getDescriptor(){return this.descriptor}setNotifyProgress(e){this.notifyProgress=e}load(e,t,i){this.startCallback=e,this.progressCallback=t,this.finishCallback=i;var r=this.url.lightmapProjectUrl();if(r){var n=this;this._loadLightmapConfig(r,(function(){n.loadData()}))}else this.loadData()}loadData(){var e=this,t=e.model,i=t.getConfig().metadata;let n=this.model.materialManager;this.descriptor.setConfigure(t.getConfig()),r.GlobalData.CanUseCompressedTexture&&i.texture_dds&&(n.enableCompressedTexture=!0,this.enableCompressedTexture=!0),r.GlobalData.CanUseSmallTexture&&i.texture_small&&(n.enableSmallTexture=!0),i.texture_pkg&&(n.enablePkgTexture=!0),i.texture_org&&(n.enableOrgTexture=!0),i.texture_dds&&(n.enableDdsTexture=!0),0==i.texture_pkg_gz&&(n.enableTexturePkgGz=!1),r.Compatibility.isUseMergeTexturePkg(i.version)?r.Compatibility.useMergeTexturePkg=!0:r.Compatibility.useMergeTexturePkg=!1,r.Compatibility.isUse32MpkData(i.version)?r.Compatibility.use32MpkData=!0:r.Compatibility.use32MpkData=!1;var a=this.getSceneTaskCount(i);e.maxLoadTaskCount=0,e.maxLoadTaskCount+=a,e.maxLoadTaskCount+=i.material,e.maxLoadTaskCount+=i.userId,e.maxLoadTaskCount+=i.userdata,e.maxLoadTaskCount+=i.camera,e.maxLoadTaskCount+=i.octree_o,e.maxLoadTaskCount+=i.octree_i,t.lightmap&&(e.maxLoadTaskCount+=2),e.startCallback&&e.startCallback();this.url;i.material?e._loadMaterial(i.material_json):e.textruesLoaded=!0,i.userId&&e._loadUserId(),i.userdata&&e._loadUserData(),i.camera&&e._loadCamera(),(i.octree_o||i.octree_i)&&e._loadOctree(i.octree_o,i.octree_i),t.lightmap&&e._loadUV2(),a&&e.loadSceneAndMpks(i)}loadSceneAndMpks(e){}getSceneTaskCount(e){return 0}loadWithStorage(e,t,i,n){r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,t,i,n)}_loadLightmapConfig(e,t){var i=this.model,n=this.descriptor;const a=e;this.loadWithStorage(a,(()=>new Promise(((e,t)=>{this.fileLoader.load(a,e)}))),(e=>{var a;try{a=JSON.parse(e)}catch(e){return void console.log("Lightmap config data exceptions!")}void 0!==a.count.lightmapNum&&a.count.lightmapNum>0&&(i.lightmapNum=a.count.lightmapNum,n.lightmap=!0,r.GlobalData.EnableLightmap=!0),t&&t()}))}_onTaskFinished(){var e=this.model;this.loadTaskCount++;var t=this.dealProgressSegment(e,this.loadTaskCount);if(this.notifyProgress){var i={total:this.maxLoadTaskCount,loaded:t};this.progressCallback&&this.progressCallback(i)}this.loadTaskCount>=this.maxLoadTaskCount&&(this.dataLoaded=!0,this.textruesLoaded&&this.finishCallback&&this.finishCallback())}_onLoadTexture(){this.loadTextureCount++,this.loadTextureCount>=this.maxLoadTextureCount&&(this.textruesLoaded=!0,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null,this.textureManager=null,this.dataLoaded&&this.finishCallback&&this.finishCallback())}_loadScene(e){var t=this,i=this.model,n=this.url,a=this.fileLoader;const s=n.sceneUrl(e);this.loadWithStorage(s,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(s,e,void 0,t)}))),(i=>{t._parseScene(i,e),t._onTaskFinished()}),(e=>{i.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()}))}_parseScene(e,t){const i=this.model.getConfig().metadata.version;let n=new r.Loader.SceneReader(e,i);this.descriptor.mapSceneReader[t]=n,n=null}_loadLine(){var e=this,t=this.model,i=this.url,n=this.fileLoader;const a=i.lineUrl();this.loadWithStorage(a,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(a,e,void 0,t)}))),(t=>{e._parseLine(t),e._onTaskFinished()}),(i=>{t.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:i}),e._onTaskFinished()}))}_parseLine(e){for(var t=new r.Loader.LineReader(e,this.version),i=0,n=t.header.lineCount;i<n;++i){var a=t.getPtBuffer(i),s=t.getIdxBuffer(i);if(null!=a&&null!=s){var o=t.getLineData(i);if(0===o.lineType){for(var l=[],d=1,h=s.length;d<h;d++)l.push(s[d-1]),l.push(s[d]);l.length&&(s=l)}this.descriptor.cacheReferencedMeshBufferData("line-"+o.line_id,{P:a,I:s,mpkMatrix:t.getMatrix()})}else r.Logger.log("Error Geometry!")}t=null}_loadMaterial(e){var t=this,i=this.model,n=this.url,a=this.fileLoader;const s=n.materialUrl();this.loadWithStorage(s,(()=>new Promise(((t,i)=>{e?a.setResponseType(""):a.setResponseType("arraybuffer"),a.load(s,t,void 0,i)}))),(i=>{t._parseMaterial(i,e),t._onTaskFinished()}),(e=>{i.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t.textruesLoaded=!0,t._onTaskFinished()}))}_loadMaterialId(e,t){var i=this,r=this.url,n=this.fileLoader;const a=r.materialIdUrl();this.loadWithStorage(a,(()=>new Promise(((e,t)=>{n.setResponseType(""),n.load(a,e,void 0,t)}))),(t=>{let r=JSON.parse(t);i.model.materialManager.materialIdMap=r.materials,e&&e(Object.keys(r.materials))}),(e=>{console.log("ERROR: there is no material_id.zip, please reTranslate the model"),t&&t()}))}_parseMaterial(e,t){t?this._parseMaterialJson(e):this._parseMaterialBinary(e)}_parseMaterialBinary(e){var t,i=this.url,n=this.model.materialManager,a=n.materials,s=n.textures,o=new r.Loader.MaterialReader(e),l=o.materialCount,d=this,h=[];if(!(l<0)){var c=this.model.manager.scene;for(t=0;t<l;++t){var u,p={},m=o.getMaterial(t);if(void 0!==m.color&&(p.color=m.color),void 0!==m.opacity&&(p.opacity=m.opacity,m.opacity<1&&(p.transparent=!0)),void 0!==m.side&&m.side&&(p.side=THREE.DoubleSide),void 0!==m.emissive&&(p.emissive=m.emissive),void 0!==m.environment&&(p.envMapIntensity=m.environment),void 0!==m.roughness&&(p.roughness=m.roughness,p.originRoughness=m.roughness),void 0!==m.metalness&&(p.metalness=m.metalness,p.originMetalness=m.metalness),r.GlobalData.IBL?(p.iblProbe=c.iblProbe,(u=new H.IBLMaterial(p)).type="IBL"):u=r.MaterialUtil.createStandardMaterial(p),u.name=t,a[t]=u,p=null,r.GlobalData.EnableTextureLoading){var f=null;m.texture_n>0&&(f=o.getTexture(m.texture_id[0])),f&&h.push({id:t,data:f})}}if(h.length>0){for(l=this.maxLoadTextureCount=h.length,t=0;t<l;t++)this._parseTexture(i,h[t],s);h=null}if(this.model.lightmap){var g=this.model.lightmapNum;for(this.maxLoadTextureCount+=g,t=0;t<g;t++){var v=this._loadTexture(i.textureUrl("lightmap-rgbm"+t+".png"),(function(){d._onLoadTexture()}),void 0,(function(){d._onLoadTexture()}));n.lightmaps[t]=v}}0==this.maxLoadTextureCount&&d._onLoadTexture(),o=null}}_parseMaterialJson(e){var t,i=this.url,n=this.model.materialManager,a=n.materials,s=(n.textures,new r.Loader.MaterialReaderJson(e)),o=s.count,l=this;let d={};if(!(o<0)){var h=this.model.manager.scene;for(t=0;t<o;++t){var c,u={},p=s.getMaterial(t),m=p.parameters;if(void 0!==m.color&&(u.color=m.color),void 0!==m.opacity&&(u.opacity=m.opacity,m.opacity<1&&(u.transparent=!0)),void 0!==m.side&&"double"==m.side&&(u.side=THREE.DoubleSide),void 0!==m.emissive&&(u.emissive=m.emissive),void 0!==m.environment&&(u.envMapIntensity=m.environment),void 0!==m.roughness&&(u.roughness=m.roughness,u.originRoughness=m.roughness),void 0!==m.metalness&&(u.metalness=m.metalness,u.originMetalness=m.metalness),void 0!==m.refractionRatio&&(u.refractionRatio=m.refractionRatio),void 0!==m.imageFade&&(u.imageFade=m.imageFade),void 0!==m.tintColor&&(u.tintColor=m.tintColor),null!=p.fillPattern){u.fillMap=r.MaterialUtil.loadFillMap(p.fillPattern);var f=this.model.getModelManager().viewer.domElement;u.viewportSize=new THREE.Vector2(f.offsetWidth,f.offsetHeight)}if("user"==p.tag&&(u.tag="user"),null!=p.receiveIBL&&(u.receiveIBL=p.receiveIBL),r.GlobalData.IBL?(u.iblProbe=h.iblProbe,(c=new H.IBLMaterial(u)).type="IBL"):(c=r.MaterialUtil.createStandardMaterial(u)).refreshUniforms(),c.name=t,a[t]=c,u=null,r.GlobalData.EnableTextureLoading){var g=[],v=p.textures;for(var y in v){var M=v[y];"reliefMap"==y&&v.bumpMap||g.push({type:y,data:M})}g.length>0&&(d[t]=g)}}if(n.handlerUrl=i,n.textureDataArray=d,Object.keys(d).length>0&&(this.maxLoadTextureCount++,n.updateTexturePkgMapping(void 0,(()=>{this._onLoadTexture()}))),this.model.lightmap){var E=this.model.lightmapNum;for(this.maxLoadTextureCount+=E,t=0;t<E;t++){var x=this._loadTexture(i.lightmapTexUrl("lightmap-rgbm"+t+".png"),(function(e){e.encoding=THREE.GammaEncoding,l._onLoadTexture()}),void 0,(function(){l._onLoadTexture()}));n.lightmaps[t]=x}}0==this.maxLoadTextureCount&&l._onLoadTexture(),s=null}}_loadTexture(e,t,i,n){var a,s=THREE.DefaultLoadingManager.getHandler(e),o=this;if(null!==s)a=s.load(e,t);else{a=new THREE.Texture;const l=e=>{let i=document.createElement("canvas");i.width=e.width,i.height=e.height,i.getContext("2d").putImageData(e,0,0),a.image=r.MaterialUtil.ensurePowerOfTwo(i),a.needsUpdate=!0,t&&t(a)},d=e=>{void 0!==n&&n(e),o.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})},h=()=>new Promise(((t,r)=>{(s=new THREE.ImageLoader).setCrossOrigin("anonymous"),s.load(e,(function(e){let i=document.createElement("canvas");i.width=e.width,i.height=e.height;let r=i.getContext("2d");r.drawImage(e,0,0),t(r.getImageData(0,0,i.width,i.height))}),i,r)}));this.loadWithStorage(e,h,l,d)}return a}_parseTexture(e,t,i){var r=window.TEST||{},n=t.id,a=t.data,s=a.id+a.file_name_ext;const o=this.model.materialManager;this.enableCompressedTexture&&a.dds?this.textureLoader=o._loadCompressedTexture:r.CryptoResourceLoader?this.textureLoader=o._loadTextureByCrypto:this.textureLoader=o._loadTexture;var l=this;this.textureLoader(e.textureUrl(s),(function(e){e.repeat.fromArray([a.scale_u,a.scale_v]),e.offset.fromArray([a.offset_u,a.offset_v]),e.setRotateAngle&&e.setRotateAngle(a.angle),a.repeat_u&&(e.wrapS=THREE.RepeatWrapping),a.repeat_v&&(e.wrapT=THREE.RepeatWrapping),e&&(i[n]=e),l._onLoadTexture()}),void 0,(function(){l._onLoadTexture()}))}_loadUV2(){var e=this,t=this.url,i=this.fileLoader;(()=>{const r=t.uv2Url();this.loadWithStorage(r,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(r,e,void 0,t)}))),(t=>{e.uv2Buffer=new Uint16Array(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))})();(()=>{const r=t.uv2MapItemUrl();this.loadWithStorage(r,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(r,e,void 0,t)}))),(t=>{e.uv2MapItem=JSON.parse(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))})()}getUV2ById(e,t){if(this.uv2MapItem&&t){var i=this.uv2MapItem[e];if(i){var r=i.uv1Scale,n=i.uv1Translation,a=i.uv1ByteOffset/2,s=2*t;if(this.uv2Buffer){for(var o=this.uv2Buffer,l=[],d=a;d<a+s;d+=2)l.push(r[0]*(o[d]/65535)+n[0]),l.push(r[1]*(o[d+1]/65535)+n[1]);return{lightmapIdx:i.lightmapIdx,uv2:l}}}}}getInstanceUV2ForSharedMeshById(e,t){if(this.uv2MapItem&&t){var i=this.uv2MapItem[e];if(i){var r=i.uv1Scale,n=i.uv1Translation,a=i.uv1ByteOffset/2,s=2*t;if(this.uv2Buffer){for(var o=this.uv2Buffer,l=[],d=a;d<a+s;d+=2)l.push(o[d]),l.push(o[d+1]);var h=[];return h.push(r[0]),h.push(r[1]),h.push(n[0]),h.push(n[1]),{lightmapIdx:i.lightmapIdx,uv2:l,offsetRepeat:h}}}}}getInstanceUV2InfoById(e){if(this.uv2MapItem){var t=this.uv2MapItem[e];if(t){var i=t.uv1Scale,r=t.uv1Translation,n=[];return n.push(i[0]),n.push(i[1]),n.push(r[0]),n.push(r[1]),{lightmapIdx:t.lightmapIdx,byteOffset:t.uv1ByteOffset,offsetRepeat:n}}}}getInstanceUV2ById(e,t){var i=e/2;if(this.uv2Buffer)return this.uv2Buffer.slice(i,i+t)}_loadSymbol(e){var t=this,i=this.url,n=this.fileLoader;const a=i.symbolUrl();this.loadWithStorage(a,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(a,e,void 0,t)}))),(i=>{t.parseSymbol(i),t._onTaskFinished(),e&&e()}),(i=>{t.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_SYMBOL_ERROR,event:i}),t._onTaskFinished(),e&&e()}))}parseSymbol(e){const t=this.model.getConfig().metadata;this.descriptor.symbolReader=new r.Loader.SymbolReader(e,t.version)}_loadOctree(e,t){var i=null,r=this.model.configLoader.transformInfos.transformMatrix;this.model.configLoader.transformInfos.octreeTransformed&&(i=new THREE.Matrix4).copy(r).invert(),e&&this._loadOctreeBy(i,!1),t&&this._loadOctreeBy(i,!0)}_loadOctreeBy(e,t){var i=this,n=this.url,a=this.fileLoader;const s=t?n.octreeUrl("i"):n.octreeUrl("o");this.loadWithStorage(s,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(s,e,void 0,t)}))),(r=>{i._parseOctree(r,e,t),i._onTaskFinished()}),(e=>{i.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_OCTREEINNER_ERROR,event:e}),i._onTaskFinished()}))}_parseOctree(e,t,i){this.descriptor.octreeRootNode[i?"inner":"outer"]=this._getOctreeRootNode(e,t)}_getOctreeRootNode(i,n){function a(i,r){n&&r.boundingBox.applyMatrix4(n),i.boundingBoxWorld=r.boundingBox.clone(),i.min=r.boundingBox.min,i.max=r.boundingBox.max,i.center=r.boundingBox.getCenter(e).clone(),i.size=r.boundingBox.getSize(t).lengthSq(),i.childStart=r.child_s,i.childEnd=r.child_e}function s(e,t){e.octType=0,e.center.x<t.center.x&&(e.octType+=1),e.center.y<t.center.y&&(e.octType+=2),e.center.z<t.center.z&&(e.octType+=4)}var o=null,l=new r.Loader.OctreeReader(i);if(l.getCount()>0){var d=l.getNode(0),h=d.cell_id;a(o=new r.Loader.OctreeNode(h,0),d),function e(t,i){for(var n=t.childStart,o=t.childEnd,l=n;l<o;++l){var d=i.getNode(l),h=d.cell_id,c=new r.Loader.OctreeNode(h,t.depth);a(c,d),t.add(c),s(c,t),c.updateMaxDepth(),e(c,i)}}(o,l)}return l=null,o}_loadUserId(){var e=this,t=this.url,i=this.fileLoader;const n=t.userIdUrl();this.model.emptyScene?e._onTaskFinished():this.loadWithStorage(n,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(n,e,void 0,t)}))),(t=>{e._parseUserId(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()}))}_parseUserId(e){this.descriptor.userIdReader=new r.Loader.IdReader(e)}_loadUserData(){var e=this,t=this.url,i=this.fileLoader;const n=t.userDataUrl();this.loadWithStorage(n,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(n,e,void 0,t)}))),(t=>{e._parseUserData(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERDATA_ERROR,event:t}),e._onTaskFinished()}))}_parseUserData(e){this.descriptor.userDataReader=new r.Loader.UserDataReader(e)}_loadCamera(){var e=this,t=this.url,i=this.fileLoader;const n=t.cameraUrl();this.loadWithStorage(n,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(n,e,void 0,t)}))),(t=>{e._parseCamera(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_CAMERA_ERROR,event:t}),e._onTaskFinished()}))}_parseCamera(e){var t=this.model.configLoader.transformInfos.transformMatrix;new r.Loader.CameraReader(e).parse(this.model,t)}_loadMpk(e,t){var i=this,n=this.fileLoader;const a=this.url.mpkUrl(e);this.loadWithStorage(a,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(a,e,void 0,t)}))),(r=>{i._parseMpk(r,e),t(),i._onTaskFinished()}),(e=>{i.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),t(),i._onTaskFinished()}))}_loadAllMpks(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this._loadMpk.bind(this))}_parseMpk(e,t){for(var i=new(this.model.getConfig().metadata.mpk_batched?r.Loader.BMPKReader:r.Loader.MPKReader)(e),n=new THREE.Matrix4,a=0,s=i.header.meshCount;a<s;++a){var o=i.getPtBuffer(a),l=i.getIdxBuffer(a),d=i.getNormalBuffer(a),h=i.getMeshData(a),c=i.getUVBuffer(a);null!=o&&null!=l?(void 0!==h.baseScale&&0!==h.baseScale&&(o=new Float32Array(o),n.identity(),n.setPosition(new THREE.Vector3(h.baseX,h.baseY,h.baseZ)),n.scale(new THREE.Vector3(h.baseScale,h.baseScale,h.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(n,o)),this.descriptor.cacheReferencedMeshBufferData(h.mesh_id,{P:o,I:l,N:d,UV:c}),this.descriptor.cacheReferencedMeshMpkIds(t,h.mesh_id)):r.Logger.log("Error Geometry!")}i=null}_loadBorderline(e){var t=this,i=this.url,n=this.fileLoader;const a=e?i.borderLineUrl(1):i.borderLineUrl(0);this.loadWithStorage(a,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(a,e,void 0,t)}))),(i=>{t._parseBorderLine(i,e),t._onTaskFinished()}),(e=>{t.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t._onTaskFinished()}))}_parseBorderLine(e,t){for(var i=new r.Loader.LineReader(e,this.version),n=[],a=0,s=i.header.lineCount;a<s;++a){var o=i.getLineData(a);n.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:n,mpkMatrix:i.getMatrix()}),i=null}_isLoadMpkBorderlines(){var e=this.model.getConfig().metadata;return!(!r.GlobalData.BorderLineBatched||!e.outline_mpk)}getAllBorderlineCount(){var e=this.model.getConfig().metadata;return this._isLoadMpkBorderlines()?e.outline_mpk:e.outline_0+e.outline_1}_loadAllBorderlines(e){this._isLoadMpkBorderlines()?e.outline_mpk&&this._loadAllMpkBorderLines(e.outline_mpk):(e.outline_0&&this._loadBorderline(!1),e.outline_1&&this._loadBorderline(!0))}delayLoadBorderlines(e){this._isLoadMpkBorderlines()?this._delayLoadMpkBorderlines(e):this._delayLoadTogetherBorderlines(e)}_delayLoadMpkBorderlines(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_mpk,t.outline_mpk&&this._loadAllMpkBorderLines(t.outline_mpk)}_delayLoadTogetherBorderlines(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_0+t.outline_1,t.outline_0&&this._loadBorderline(!1),t.outline_1&&this._loadBorderline(!0)}_loadAllMpkBorderLines(e){this.mpkBorderLineTaskManager||(this.mpkBorderLineTaskManager=new r.TaskManager);for(var t=0;t<e;++t)this.mpkBorderLineTaskManager.addTask(t);this.mpkBorderLineTaskManager.processTasks(this._loadMpkBorderLine.bind(this))}_loadMpkBorderLine(e,t){var i=this,r=this.fileLoader,n=this.url,a=e>=this.model.getConfig().metadata.mpk_shared_index;const s=n.mpkBorderLineUrl(e);this.loadWithStorage(s,(()=>new Promise(((e,t)=>{r.setResponseType("arraybuffer"),r.load(s,e,void 0,t)}))),(e=>{i._parseMpkBorderLine(e,a),t(),i._onTaskFinished()}),(e=>{i._onTaskFinished()}))}_parseMpkBorderLine(e,t){for(var i=new r.Loader.LineReader(e,this.version),n=[],a=0,s=i.header.lineCount;a<s;++a){var o=i.getLineData(a);n.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:n,mpkMatrix:i.getMatrix()}),i=null}dealProgressSegment(e,t){return r.GlobalData.BatchMergeEnabled?t*e.progressPercentage.load:t}}})(),function(){class e extends r.ModelView.BaseLoader{constructor(e){super(e),this.descriptor=null}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadScene(0),e.lines&&this._loadLine(),e.mpks&&this._loadAllMpks(e.mpks),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=e.scenes;return t+=e.symbol,t+=e.lines,t+=e.mpks,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}r.ModelView.DefaultBaseLoader=e}(),r.ModelView.ModelBaseHandler=class{constructor(e){this.model=e,this.defaultManager=null,this.instancedManager=null,this.loader=null,this.loaded=!1,this.dataReady=!1,this.borderlinesLoaded=!1,this.borderlinesGenerated=!1}destroy(){this.model=null,this.defaultManager.destroy(),this.defaultManager=null,this.instancedManager.destroy(),this.instancedManager=null,this.loader&&(this.loader.destroy(),this.loader=null)}load(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START})}),(function(e){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:e})}),(function(){console.time("PrepareData:"),t.prepareData((function(){console.timeEnd("PrepareData:"),t.processLoadCompleted((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:i.id})}))}))}))}processLoadCompleted(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.updateOctreeNode();var i=t.getFilter();let r={};r[t.fileId]=this.model.getAllNodeInfos(),i.initFilterManager(r),requestAnimationFrame((function(){t.setLoaded(!0),e&&e(),t.updateMeshNodes(),t.applyFilter(),t.debut(t)}))}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().parseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepareWireframe(e,t){if(e.isActivateWireframe())if(r.GlobalData.BorderLineDelayLoaded&&this.loader.getAllBorderlineCount())if(this.borderlinesLoaded)this.borderlinesGenerated&&(this.defaultManager.asyncGenerateWireframe(e),this.instancedManager.generateWireframe(e));else{this.borderlinesLoaded=!0;var i=this;this.loader.delayLoadBorderlines((function(){i.instancedManager.generateWireframe(e),i.defaultManager.asyncGenerateWireframe(e,(function(){console.log("Delay loading borderline OK!"),i.borderlinesGenerated=!0,t&&t()}))}))}else this.defaultManager.generateWireframe(e),this.instancedManager.generateWireframe(e)}prepare(e){}needUpdate(){return!0}updateNodes(){this.needUpdate()&&(this.defaultManager.updateNodes(this.model),r.GlobalData.Instance&&this.instancedManager.updateNodes(this.model))}isLoaded(){return this.loaded}isDataReady(){return this.loaded}isAllReady(){return!0}isHidden(){var e=this.model;return!e.visible&&(e.manager.scene.removeObjectGroupByName(e._getWireframeGroupName()),!0)}settleData(e){}addNodeInfoToOctantMap(){}applyFilter(){this.isLoaded()&&(this.defaultManager.applyFilter(this.model),r.GlobalData.Instance&&this.instancedManager.applyFilter(this.model))}applySelection(){this.isLoaded()&&(this.defaultManager.applySelection(this.model),r.GlobalData.Instance&&this.instancedManager.applySelection(this.model))}clearSelection(){this.isLoaded()&&(this.defaultManager.clearSelection(this.model),r.GlobalData.Instance&&this.instancedManager.clearSelection(this.model))}applyHover(){this.isLoaded()&&(this.defaultManager.applyHover(this.model),r.GlobalData.Instance&&this.instancedManager.applyHover(this.model))}clearHover(){this.isLoaded()&&(this.defaultManager.clearHover(this.model),r.GlobalData.Instance&&this.instancedManager.clearHover(this.model))}applyBlink(){this.isLoaded()&&(this.defaultManager.applyBlink(this.model),r.GlobalData.Instance&&this.instancedManager.applyBlink(this.model))}clearBlink(){this.isLoaded()&&(this.defaultManager.clearBlink(this.model),r.GlobalData.Instance&&this.instancedManager.clearBlink(this.model))}applyReplacement(){this.isLoaded()&&(this.defaultManager.applyReplacement(this.model),r.GlobalData.Instance&&this.instancedManager.applyReplacement(this.model))}getMeshesByUserIds(e,t){this.isLoaded()&&(this.defaultManager.getMeshesByUserIds(this.model,e,t),r.GlobalData.Instance&&(this.instancedManager.getMeshesByUserId(this.model,e),this.instancedManager.getMeshesByUserId(this.model,t)))}rebuildIndicesforLightmap(){this.defaultManager.rebuildIndices(this.model)}adjustVisibility(e){this.defaultManager.adjustVisibility(this.model,e)}changeVisibilityOfSelectedObjects(e){this.defaultManager.changeVisibilityOfSelectedObjects(this.model,e)}changeVisibilityOfNonSelectedObjects(e){this.defaultManager.changeVisibilityOfNonSelectedObjects(this.model,e)}adjustInstanceVisibility(e){this.instancedManager.adjustVisibility(this.model,e)}changeInstanceVisibilityOfSelectedObjects(e){this.instancedManager.changeVisibilityOfSelectedObjects(this.model,e)}changeInstanceVisibilityOfNonSelectedObjects(e){this.instancedManager.changeVisibilityOfNonSelectedObjects(this.model,e)}restoreVisibilityOfObjects(){this.defaultManager.restoreVisibilityOfObjects(),this.instancedManager.restoreVisibilityOfObjects()}getBlinkMaterials(){var e=[],t=this.model.materialManager.instanceMaterials;for(var i in t)for(var r=t[i],n=0,a=r.length;n<a;n++)e.push(r[n]);return e=e.concat(this.defaultManager.meshManager.getBlinkMaterials())}disposeBufferAfterVbo(){this.isLoaded()&&(this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo())}getGeometryBuffersByUserId(e){if(!this.isLoaded())return[];var t=[];return t=(t=t.concat(this.defaultManager.getGeometryBuffersByUserId(this.model,e))).concat(this.instancedManager.getGeometryBuffersByUserId(this.model,e))}explode(){this.isLoaded()&&(this.defaultManager.explode(this.model),r.GlobalData.Instance&&this.instancedManager.explode(this.model))}calculateClippingIds(e,t){if(!this.isLoaded()||!r.GlobalData.BatchMergeEnabled)return;if(e){let e=this.model.getModelDescriptor().getStandardUserIds(),t=this.model.getModelDescriptor().getStandardNodeInfos();if(this.defaultManager._collectFilteredUserIds(this.model,e,t),r.GlobalData.Instance){let e=this.model.getModelDescriptor().getInstancedUserIds(),t=this.model.getModelDescriptor().getInstancedNodeInfos();this.instancedManager._collectFilteredUserIds(this.model,e,t)}}var i=this.model.manager.scene.fillClipPlane;let n=i&&i.isEnabled();var a=this.model.manager.scene.clipPlanes;let s=n?i:a;if(!s)return;let o=s.renderClipPlane,l=n?s.capsIntersectPosition:s.capsIntersectPosition[s.selectIndex];if(!l)return;let d=n?s.capsIntersectPositionGroup:s.capsIntersectPositionGroup[s.selectIndex];d.set(this.model,new Map);let h=n?-1:s.selectIndex;if(this.model.mapClippingIds=new Map,t?this.model.mapClippingIdsBox.forEach((e=>{e.clear()})):(this.defaultManager.calculateClippingIds(o,l,d,this.model),r.GlobalData.Instance&&this.instancedManager.calculateClippingIds(o,l,d,this.model)),h>=0){this.model.mapClippingIdsBox[h]=this.model.mapClippingIds,this.model.mapClippingIds=new Map;for(let e=0;e<this.model.mapClippingIdsBox.length;++e)this.model.mapClippingIdsBox[e].forEach(((e,t)=>{this.model.mapClippingIds.set(t,e)}))}r.GlobalData.CalculateClippingLine||(l.length=0)}calculateClippingContours(e){const t=this.model.manager.scene;var i=r.FillClipPlaneManager.getInstance(t);const n=i.planeMesh;var a=i.renderClipPlane;const s=r.FillClipPlaneManager.getFillClipPlaneBoundingBoxWorld(t),o=this.model.id;i.capsIntersectContour[o]={},this.defaultManager.calculateClippingContours(o,a,n,s,e,i.capsIntersectContour),r.GlobalData.Instance&&this.instancedManager.calculateClippingContours(o,a,n,s,e,i.capsIntersectContour)}isHiddenNode(e){return this.defaultManager.isHiddenNode(e)||this.defaultManager.isHiddenNode(e)}},(()=>{class e extends r.ModelView.BaseDescriptor{constructor(){super()}parseItemData(e){var t=this.getSceneReaderMap();for(var i in t)for(var r=t[i],n=0,a=r.header.cellCount;n<a;++n)for(var s=r.getCellInfo(n),o=s.itemIndex;o<s.itemCount;++o)this._readItemData(r,o,n);e&&e()}asyncParseItemData(e){for(var t=this.getSceneReaderMap(),i=Object.keys(t),n=i.length,a=0,s=this,o=0;o<n;o++){i[o];var l=t[i[o]];r.Utils.asyncProcess(l,l.header.cellCount,100,(function(e,t){s._parseItemDataBy(e,t)}),(function(){++a===n&&e&&e()}))}}_parseItemDataBy(e,t){for(var i=e.getCellInfo(t),r=i.itemIndex;r<i.itemCount;++r)this._readItemData(e,r,t)}parseItemDataByCellId(e){var t=this.getSceneReaderMap();for(var i in t)this._parseItemDataBy(t[i],e)}_readItemData(e,t,i){var n=e.getItemInfo(t);void 0!==n&&(n.type===r.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL?this._readSymbolInfo(e,i,n):this._readMeshInfo(e,i,n,null))}_readSymbolInfo(e,t,i){var n=this.symbolReader;if(n){var a=n.header.symbolCount,s=i.toData,o=e.getMatrixInfo(i.matrixId).matrix.clone(),l={matrix:o,ItemId:i.ItemId,originalId:i.originalId,userDataId:i.userDataId,materialId:i.materialId};if(s>=0&&s<a)for(var d=n.getSymbolInfo(s),h=d.itemIndex;h<d.itemCount;++h){var c=n.getItemInfo(h);c.type!==r.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL&&this._readMeshInfo(n,t,c,l)}o=null,l=null,n=null}}_readMeshInfo(e,t,i,n){var a,s,o;if(null===n)a=i.userDataId,s=i.originalId,o=i.materialId;else{a=n.userDataId,s=n.originalId;var l=this.getConfigure();o=(!l||0===l.metadata.material_override||1===l.metadata.material_override&&(-1===i.materialId||void 0===i.materialId))&&n.materialId>-1?n.materialId:i.materialId}var d=null,h=r.ModelView.BaseDescriptor.EnumNodeItemType;switch(i.type){case h.MESH:d=this._getMeshNodeAttr(e,i,n);break;case h.TUBE:d=this._getMeshNodeAttrOfTube(e,i,n);break;case h.PIPE:d=this._getMeshNodeAttrOfPipe(e,i,n);break;case h.BOX:d=this._getMeshNodeAttrOfBox(e,i,n);break;case h.BOX_M:d=this._getMeshNodeAttrOfBoxM(e,i,n);break;case h.PIPE_M:d=this._getMeshNodeAttrOfPipeM(e,i,n);break;case h.MESH_REF:d=this._getMeshNodeAttrOfMeshRef(e,i,n);break;case h.LINE:d=this._getLineNodeAttr(e,i,n)}if(d){if(d.userId=this.userIdReader?this.userIdReader.getString(s):s,d.userData=this.userDataReader?this.userDataReader.getUserData(a):null,d.name=d.userId,d.type=i.type,d.cellId=t,d.materialId=o,d.state=r.EnumObjectState.Visible,d.material=null,this.lightmap){var c=i.ItemId;n&&(c=n.ItemId+"_"+i.ItemId),d.itemIdUV2=c}d.parameterizedDesc=this._isParameterizedNode(d),this._isGeometrySharedNode(d)&&(void 0===this.sharedGeometryCounter[d.geometryId]&&(this.sharedGeometryCounter[d.geometryId]=0),this.sharedGeometryCounter[d.geometryId]+=1),this.fullNodeInfoArray.push(d),d=null}}_getMeshNodeAttrOfPipe(e,t,i){const n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);const a=r.Utils.scratchVector_1,s=r.Utils.scratchVector_2,o=r.Utils.scratchVector_3,l=r.Utils.scratchMatrix4_1,d=r.Utils.scratchQuaternion_1,h=t.boundingBox.clone();h.applyMatrix4(n);let c=e.getGeomPipeInfo(t.toData);const u=c.startPt,p=c.endPt,m=o.copy(p).sub(u),f=m.length();m.normalize();let g=c.radius;const v=a.set(0,1,0),y=s.set(g,f,g),M=d.setFromUnitVectors(v,m),E=a.copy(u).addScaledVector(m,.5*f),x=l.identity().compose(E,M,y);n.multiply(x),c=null;const _=r.Math.isMirror(n),b=r.ModelView.BaseDescriptor.parameterizedNodeType.PIPE,I=_?b+"Mirror":b;return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+b,geometryId:b,geometryIdCode:I,boundingBox:h,matrix:n,fromMirror:_}}_getMeshNodeAttrOfTube(e,t,i){return this._getMeshNodeAttrOfPipe(e,t,i)}_getMeshNodeAttrOfBox(e,t,i){const n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);const a=r.Utils.scratchVector_1,s=r.Utils.scratchMatrix4_1,o=t.boundingBox.clone();o.applyMatrix4(n);const l=t.boundingBox,d=l.getSize(a),h=s.identity().scale(d),c=l.getCenter(a);h.setPosition(c),n.multiply(h);const u=r.Math.isMirror(n),p=r.ModelView.BaseDescriptor.parameterizedNodeType.BOX,m=u?p+"Mirror":p;return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+p,geometryId:p,geometryIdCode:m,boundingBox:o,matrix:n,fromMirror:u}}_getMeshNodeAttrOfBoxM(e,t,i){const n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);const a=t.boundingBox.clone();a.applyMatrix4(n);const s=r.Math.isMirror(n),o=r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M,l=s?o+"Mirror":o,d=e.getGeomBoxUvInfo(t.toData);return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+o,geometryId:o,geometryIdCode:l,boundingBox:a,matrix:n,fromMirror:s,uvArrayBuffer:d}}_getMeshNodeAttrOfPipeM(e,t,i){const n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);const a=t.boundingBox.clone();a.applyMatrix4(n);const s=r.Math.isMirror(n),o=r.ModelView.BaseDescriptor.parameterizedNodeType.PIPE_M,l=s?o+"Mirror":o,d=e.getGeomPipeUvInfo(t.toData);return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+o,geometryId:o,geometryIdCode:l,boundingBox:a,matrix:n,fromMirror:s,uvArrayBuffer:d}}_getMeshNodeAttrOfMeshRef(e,t,i){const n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);const a=t.boundingBox.clone();a.applyMatrix4(n);const s=r.Math.isMirror(n),o=t.toData,l=s?o+"Mirror":o;return{nodeId:"refMesh|"+(i?i.ItemId+"_"+t.ItemId:t.ItemId),geometryId:o,geometryIdCode:l,boundingBox:a,matrix:n,fromMirror:s}}_getMeshNodeAttr(e,t,i){const n=t.boundingBox.clone(),a=new THREE.Matrix4;-1!==t.matrixId?(a.copy(e.getMatrixInfo(t.matrixId).matrix),i&&a.multiplyMatrices(i.matrix,a),n.applyMatrix4(a)):i&&n.applyMatrix4(i.matrix);const s=r.Math.isMirror(a),o=t.toData,l=s?o+"Mirror":o;return{nodeId:i?i.ItemId+"_"+t.ItemId:t.ItemId,geometryId:o,geometryIdCode:l,boundingBox:n,matrix:a,fromMirror:s}}_getLineNodeAttr(e,t,i){const r=t.boundingBox.clone(),n=new THREE.Matrix4;-1!==t.matrixId?(n.copy(e.getMatrixInfo(t.matrixId).matrix),i&&n.multiplyMatrices(i.matrix,n),r.applyMatrix4(n)):i&&r.applyMatrix4(i.matrix);const a="line-"+t.toData,s=a;return{nodeId:i?"line-"+i.ItemId+"-"+t.ItemId:"line-"+t.ItemId,geometryId:a,geometryIdCode:s,boundingBox:r,matrix:n}}}r.ModelView.DefaultDescriptor=e})(),function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.DefaultDescriptor}}r.ModelView.DefaultLoader=e}(),r.ModelView.InstancedBaseManager=class{constructor(){this.meshManager=null,this.wireframeManager=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getInstanceGeometries(){return this.meshManager.instanceGeometryMap}traverseInstanceGeometryMap(e){this.meshManager.traverseInstanceGeometryMap(e)}getCachedInstanceData(){return this.meshManager.cachedInstance}getBufferAttributesBy(e){return this.meshManager.getBufferAttributesBy(e)}traverseNodeIdxMapByUserId(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}traverseNodeIdxMap(e,t){this.meshManager.traverseNodeIdxMap(e,t)}getMeshesByUserId(e,t){this.meshManager.getMeshesByUserId(e,t)}_updateInstanceMaterialByUserId(e,t,i,r){this.meshManager.updateInstanceStateByUserId(e,t,i,r)}_updateInstanceClippingByUserId(e){this.meshManager.updateInstanceClippingByUserId(e)}_updateInstanceMaterialForWireFrameByUserId(e,t,i,r){this.wireframeManager.updateInstanceWireframeByUserId(e,t,i,r)}_updateInstanceWireframeClippingByUserId(e){this.wireframeManager.updateInstanceWireframeClippingByUserId(e)}_updateInstanceMaterial(e){r.Logger.time("update instance material");var t=r.EnumElementState;this.clearSelectedObjectIds();var i=null,n=e.getFilter();if(n&&(i=n.getLocalClippingList()),i)for(var[a,s]of i)this._updateInstanceClippingByUserId(a),this._updateInstanceWireframeClippingByUserId(a);for(var a in this.filteredIds){var o=this.filteredIds[a];if(o[t.HIDDEN])this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.HIDDEN),this._updateInstanceMaterialForWireFrameByUserId(e,a,r.EnumElementState.HIDDEN);else if(o[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(o[t.SELECTED]){r.GlobalData.PickingEffect?o[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.OVERRIDED,o[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.SELECTED);continue}if(o[t.BLINK]){o[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.BLINK,o[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.BLINK);continue}}else{if(o[t.BLINK]){o[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.BLINK,o[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.BLINK);continue}if(o[t.SELECTED]){r.GlobalData.PickingEffect?o[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.OVERRIDED,o[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.SELECTED);continue}}o[t.HOVER]?o[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.HOVER,o[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.HOVER):o[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.OVERRIDED,o[t.OVERRIDED]):o[t.CLIPPING]&&this._updateInstanceMaterialByUserId(e,a,r.EnumElementState.CLIPPING,o[t.OVERRIDED])}}this._updateInstanceMaterialForWireFrame(e),r.Logger.timeEnd("update instance material")}_updateInstanceMaterialForWireFrame(e){var t=this.mapFilteredUserIdsForWireFrame;if(t)for(var i=Object.keys(t),n=0,a=i.length;n<a;n++){var s=i[n];this.filteredIds&&this.filteredIds[s]&&this.filteredIds[s][r.EnumElementState.HIDDEN]||this._updateInstanceMaterialForWireFrameByUserId(e,s,r.EnumElementState.OVERRIDED,t[s])}}_resetInstanceMaterial(e,t){this.meshManager.resetInstanceMaterial(e),this.wireframeManager.resetInstanceMaterial(t)}_collectFilteredUserIds(e,t,i){var n=e.getFilter(),a=n._hasHiddenFileIdFilter(),s=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),l=n._hasTransparentFilter(),d=n._hasClippingFilter(),h=e.hasReplacedUserId(),c=e.hasHiddenSourceObjectUserId(),u=this.filteredIds={};if(a||s||o||l||h||c||d)for(var p=r.EnumElementState,m=0;m<t.length;++m){var f=t[m],g=i[f];if(g&&g.length){var v=g[0];a&&n._isHiddenFileId(v)||s&&!1===n._isVisible(v)||e.isReplacedUserId(f)||e.isHiddenSourceObjectUserId(f)?(u[f]||(u[f]={}),u[f][p.HIDDEN]=!0):l&&n._isTransparent(v)?(u[f]||(u[f]={}),u[f][p.TRANSPARENT]=!0):d&&n._isClipped(v)?(u[f]||(u[f]={}),u[f][p.CLIPPING]=!0):o&&n._hasOverrideMaterial(v)&&n._getOverrideMaterials(v).forEach((e=>{let t=null!=e?e.name:"",i=String(v.nodeId);e.nodeIds?e.nodeIds.includes(i)&&""!==t&&(void 0===u[f]&&(u[f]={}),u[f][p.OVERRIDED]=t):""!==t&&(void 0===u[f]&&(u[f]={}),u[f][p.OVERRIDED]=t)}))}}}_collectFilteredUserIdsForWireFrame(e,t,i){var n=e.getFilter(),a=n._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},a)for(var s=r.EnumElementState,o=0;o<t.length;++o){var l=t[o];if(!(this.filteredIds&&this.filteredIds[l]&&this.filteredIds[l][s.HIDDEN])){var d=i[l];if(d&&d.length){var h=d[0];if(n._hasOverrideMaterialForWireFrame(h)){var c=n._getOverrideMaterialForWireFrame(h),u=null!=c?c.name:"";""!==u&&(this.mapFilteredUserIdsForWireFrame[l]=u)}}}}}_collectSelectedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},n=r.EnumElementState,a={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][n.SELECTED]=!0,a[s]=!0);this.selectedUserIds=Object.keys(a)}_clearSelectedState(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var n=this.selectedUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][r.EnumElementState.SELECTED])}this.selectedUserIds=null}}_collectHoveredUserIds(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][r.EnumElementState.HOVER]=!0,this.hoverdUserId=e)}_clearHoveredState(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][r.EnumElementState.HOVER],this.hoverdUserId=void 0)}_collectBlinkedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},n=r.EnumElementState,a={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][n.BLINK]=!0,a[s]=!0);this.blinkUserIds=Object.keys(a)}_clearBlinkedState(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var n=this.blinkUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][r.EnumElementState.BLINK])}this.blinkUserIds=null}}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;this.updateNodes(e),this.meshManager.resetInstanceMeshVisible(),this._resetInstanceMaterial(e.isAllMaterialChanged?e.materialManager.instanceMaterials:null,e),e.isAllMaterialChanged=!1,i=t||e.getModelDescriptor().getInstancedUserIds();var r=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectFilteredUserIdsForWireFrame(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._updateInstanceMaterial(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._updateInstanceMaterial(e),this.updateNodes(e)}hasNodeInfo(e){return!!e.getModelDescriptor().getInstancedNodeInfos()}updateNodes(e){this.hasNodeInfo(e)&&(this.meshManager.updateNodes(e),this.wireframeManager.updateNodes(e))}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}clearCachedData(){}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}clearSelectedObjectIds(){this.meshManager.clearSelectedObjectIds()}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}addAllInstanceNodeToScene(e){this.meshManager.addAllInstanceNodeToScene(e)}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e)}calculateClippingIds(e,t,i,r){this.meshManager.calculateClippingIds(e,t,i,r)}calculateClippingContours(e,t,i,r,n,a){this.meshManager.calculateClippingContours(e,t,i,r,n,a)}isPickableNode(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],i=r.EnumElementState;return!t[i.HIDDEN]&&!t[i.TRANSPARENT]}isHiddenNode(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][r.EnumElementState.HIDDEN])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},function(){function e(e,t,i){e.forEach((e=>{!function(e,t,i){const r=e.getAttribute("vState").array;for(let e=0,n=t.length;e<n;++e)r[4*t[e]]=i;e.getAttribute("vState").needsUpdate=!0}(e.geometry,t,i)}))}function t(e,t,i,r){e.forEach((e=>{!function(e,t,i,r){const n=e.getAttribute("vState").array,a=e.getAttribute("aColor"),s=a?a.array:null;for(let e=0,a=t.length;e<a;++e){const a=t[e];n[4*a]=i,null!==s&&null!==r&&(s[4*a]=r[0],s[4*a+1]=r[1],s[4*a+2]=r[2],s[4*a+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,a&&(a.needsUpdate=!0)}(e.geometry,t,i,r)}))}function i(e,t,i){e.forEach((e=>{const r=e.geometry.getAttribute("vState");if(r.array.fill(t),r.needsUpdate=!0,i){var n=i[e.material.name];e.material=e.material.transparent?n[1]:n[0]}}))}function n(e,t){!0!==e.useCSM||t.uniforms.csmCascades.value||(t.uniforms.csmCascades.value=e.uniforms.csmCascades.value)}class a extends r.ModelView.MeshBaseManager{constructor(e,t){super(),this.manager=e,this.instanceGeometryMap={},this.bufferAttributeMap={},this.instanceNodeMap={},this.nodeIdxMapFromUserId={},this.matrixInfoMapFromUserId={},this.cachedInstance={vState:{},vClipping:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},uv2OffsetRepeat:{},uv2:{}},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.meshesVisible=!0,this.version=t}destroy(){if(super.destroy(),this.cachedInstance=null,this.instanceNodeMap=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache(),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}clearInstanceCache(){this.cachedInstance.vState={},this.cachedInstance.vClipping={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.uv2OffsetRepeat={},this.cachedInstance.uv2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceNodeMap={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}updateNodes(e){this.meshesVisible=!e.isOnlyWireframe();const t=this._getNodeGroup(e);this.meshesVisible?t._adjustActivated||(t.visible=!0):t.visible=!1}createMeshNodes(e,t){this._collectSharedMeshBufferIds(e),this._createInstanceGeometries(e,t),this._makeInstanceNodes(e)}asyncCreateMeshNodes(e,t,i){if(0===t.length)return void(i&&i());const n=this,a=r.GlobalData.InstanceAsyncProcessingStep;this._collectSharedMeshBufferIds(e),r.Utils.asyncProcess(t,t.length,a,(function(t,i){n._createInstanceGeometries(e,[t[i]])}),(function(){n._makeInstanceNodes(e),i&&i()}))}_createInstanceGeometries(e,t){var i=this;e.getModelDescriptor().traverseInstancedNodeInfos(t,(function(t,r){for(var n=0,a=r.length;n<a;n++){var s=r[n],o=i.getGeometryByNodeInfo(e,s);if(o){var l=e.manager.getOverrideMaterialByNodeInfo(s,e.materialManager.getMaterialById(s.materialId));if(l&&(s.materialId=l.name),e.lightmap&&void 0===s.uv2Info){var d=e.getLoader().getInstanceUV2InfoById(s.itemIdUV2);s.uv2Info=d,s.materialId=s.uv2Info?s.materialId+"_"+s.uv2Info.lightmapIdx:s.materialId}var h=i.getMeshIdByNodeInfo(s),c=i.cacheInstanceAttributeStateBy(e,h,o,s,l);i.cacheNodeIdxByUserId(s.userId,h,c),i.cacheMatrixInfoByUserId(s.userId,h,{matrix:s.matrix,boundingBox:s.boundingBox}),i.cacheInstanceGeometries(h,o,s.uv2Info,e)}}}))}getBufferAttributesBy(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance;let i=Float32Array;r.Compatibility.isUseDoubleMatrixMPKHeader(this.version);var n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,!1,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,!1,1),s=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,!1,1),o=new THREE.InstancedBufferAttribute(new i(t.mcol3[e]),3,!1,1),l=[],d=[];if(t.muvCol0[e])for(var h=0,c=t.muvCol0[e].length;h<c;h++)l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][h]),4,!1,1)),d.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][h]),2,!1,1));var u=new THREE.InstancedBufferAttribute(new Float32Array(t.uv2OffsetRepeat[e]),4,!1,1);new THREE.BufferAttribute(t.uv2[e],2);return this.bufferAttributeMap[e]={attributeMcol0:n,attributeMcol1:a,attributeMcol2:s,attributeMcol3:o,attributeMuvCol0Array:l,attributeMuvCol1Array:d,attributeUv2OffsetRepeat:u},this.bufferAttributeMap[e]}_addInstanceNodeToScene(e,t,i){this._getNodeGroup(e).add(i),i.updateMatrixWorld(!0),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t,new r.InstancedCapsuleObject(t,i))}addAllInstanceNodeToScene(e){const t=e.getEncodedDatabagId();this.traverseInstanceNodeMap(null,(function(i,n){const a=n[0],s=n[1];let o,l;for(o=0,l=a.length;o<l;++o)e.manager.addMeshToOctantMap(t,i,new r.InstancedCapsuleObject(i,a[o]));for(o=0,l=s.length;o<l;++o)e.manager.addMeshToOctantMap(t,i,new r.InstancedCapsuleObject(i,s[o]))}))}_getMeshFrom(e,t,i,n,a,s,o){i.setAttribute("mcol0",o.attributeMcol0),i.setAttribute("mcol1",o.attributeMcol1),i.setAttribute("mcol2",o.attributeMcol2);const l=r.GeomUtil.getMatrixFromInstancedBufferAttribute(o.attributeMcol3);i.setAttribute("mcol3",o.attributeMcol3),o.attributeMuvCol0Array.length>0&&(i.setAttribute("muvCol0",o.attributeMuvCol0Array[n]),i.setAttribute("muvCol1",o.attributeMuvCol1Array[n])),e.lightmap&&i.setAttribute("uv2OffsetRepeat",o.attributeUv2OffsetRepeat),i.setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(s.vColor[t]),4,!1,1)),i.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(s.vState[t]),4,!1,1)),i.setAttribute("vClipping",new THREE.InstancedBufferAttribute(new Float32Array(s.vClipping[t]),1,!1,1));i.getAttribute("vClipping").array.fill(e.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE);const d=new r.MeshEx(i,a);return d.databagId=e.databagId,d.fileId=e.fileId,d.frustumCulled=!1,l&&(d.matrix.copy(l),d.matrixAutoUpdate=!1,d.updateMatrixWorld(!0)),r.GlobalData.EnableShadowMap&&(d.customDepthMaterial=e.manager.getInstanceDepthMaterial(),d.castShadow=e.castShadow,d.receiveShadow=e.receiveShadow),d}_cloneMeshFrom(e,t){const i=e.geometry,n=new THREE.InstancedBufferGeometry;n.setAttribute("position",i.getAttribute("position")),n.setAttribute("normal",i.getAttribute("normal")),i.getAttribute("uv")&&n.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&n.setAttribute("uv2",i.getAttribute("uv2")),n.setAttribute("mcol0",i.getAttribute("mcol0")),n.setAttribute("mcol1",i.getAttribute("mcol1")),n.setAttribute("mcol2",i.getAttribute("mcol2")),n.setAttribute("mcol3",i.getAttribute("mcol3")),n.setAttribute("mcol0",i.getAttribute("mcol0")),n.setAttribute("mcol1",i.getAttribute("mcol1")),n.setAttribute("mcol2",i.getAttribute("mcol2")),n.setAttribute("mcol3",i.getAttribute("mcol3")),i.getAttribute("muvCol0")&&(n.setAttribute("muvCol0",i.getAttribute("muvCol0")),n.setAttribute("muvCol1",i.getAttribute("muvCol1"))),i.getAttribute("uv2OffsetRepeat")&&n.setAttribute("uv2OffsetRepeat",i.getAttribute("uv2OffsetRepeat")),n.setAttribute("aColor",i.getAttribute("aColor")),n.setAttribute("vClipping",i.getAttribute("vClipping")),n.setAttribute("vState",i.getAttribute("vState").clone()),n.setIndex(i.getIndex());const a=new r.MeshEx(n,t);return a.databagId=e.databagId,a.fileId=e.fileId,a.frustumCulled=e.frustumCulled,e.customDepthMaterial&&(a.customDepthMaterial=e.customDepthMaterial,a.castShadow=!e.castShadow,a.receiveShadow=!e.receiveShadow),e.matrix&&(a.matrix=e.matrix,a.matrixAutoUpdate=!1,a.updateMatrixWorld()),a}_makeInstanceNodeById(e,t,n){const a=e.materialManager,s=this.getMaterialIdByMeshId(t),o=a.getInstanceMaterialById(s,e);if(2!==o.length)return void console.log("instance material error!");const l=this.cachedInstance,d=this.getBufferAttributesBy(t),h=o[0],c=o[1],u=[],p=[];let m,f=n.length;for(m=0;m<f;m++){const i=this._getMeshFrom(e,t,n[m],m,h,l,d);u.push(i),1==c._primary&&(i.visible=!1),this._addInstanceNodeToScene(e,t,i)}for(m=0;m<f;m++){const i=this._cloneMeshFrom(u[m],c);p.push(i),1==h._primary&&(i.visible=!1),this._addInstanceNodeToScene(e,t,i)}const g=h._primary,v=r.EnumElementState.NONE,y=r.EnumElementState.HIDDEN;i(u,g?v:y),i(p,g?y:v),this.instanceNodeMap[t]=[u,p]}_makeInstanceNodes(e){var t=this;this.traverseInstanceGeometryMap((function(i,r){t._makeInstanceNodeById(e,i,r)}))}resetInstanceMaterial(e){const t=r.EnumElementState.NONE,n=r.EnumElementState.HIDDEN;this.traverseInstanceNodeMap(null,(function(r,a){const s=a[0],o=a[1],l=!!s[0].material._primary;i(s,l?t:n,e),i(o,l?n:t,e)}))}resetInstanceMeshVisible(){this.traverseInstanceNodeMap(null,((e,t)=>{const i=t[0],r=t[1];i.forEach((e=>{!0!==e.material._primary&&(e.visible=!1)})),r.forEach((e=>{!0!==e.material._primary&&(e.visible=!1)}))}))}clearInstanceStateByUserId(t){const i=this,n=r.EnumElementState.NONE,a=r.EnumElementState.HIDDEN;this.traverseNodeIdxMapByUserId(t,(function(t,r){const s=i.getInstanceNodesById(t),o=s[0],l=s[1],d=!!o[0].material._primary;e(o,r,d?n:a),e(l,r,d?a:n)}))}updateInstanceStateByUserId(i,a,s,o){const l=i.materialManager,d=this;this.traverseNodeIdxMapByUserId(a,(function(h,c){const u=d.getInstanceNodesById(h);if(!u)return;const p=u[0],m=u[1];p.forEach((e=>{e.visible=!0})),m.forEach((e=>{e.visible=!0}));const f=d.getMaterialIdByMeshId(h),g=l.getInstanceMaterialById(f,i),v=g[0],y=g[1],M=!!v._primary,E=d.getOriginalMaterialIdByMeshId(h),x=d.getUsableMaterialColorParamsBy(i,E,s,o),_=x.rgbaColor;let b=s,I=r.EnumElementState.HIDDEN;if(s===r.EnumElementState.TRANSPARENT&&(b=r.EnumElementState.OVERRIDED),s===r.EnumElementState.SELECTED&&d.cacheSelectedObjectIds(a,h),b===r.EnumElementState.BLINK){const e=i.manager.blinkManager.getBlinkColor(i.id);if(Object.keys(i.getModelManager().sceneState.blinkComponentIdsDetailMap).length>0){const e=i.getModelManager().sceneState.getBlinkComponentsColor(i.id,a);let t=t=>{let i=t.geometry.getAttribute("bColor");t.geometry.getAttribute("bColor")||(i=t.geometry.attributes.aColor.clone(),t.geometry.setAttribute("bColor",i));for(let t=0,r=c.length;t<r;++t){const r=c[t];i.array[4*r]=e.x,i.array[4*r+1]=e.y,i.array[4*r+2]=e.z,i.array[4*r+3]=e.w}t.geometry.getAttribute("bColor").needsUpdate=!0};p.map((e=>{t(e)})),m.map((e=>{t(e)})),v.useMultiBlinkColor=!0,y.useMultiBlinkColor=!0}else v.setBlinkColor(e),y.setBlinkColor(e)}if(b===r.EnumElementState.OVERRIDED&&(y.isOverrideOpacity=x.transparent),M){const i=v.transparent===x.transparent;t(p,c,i?b:I,_),e(m,c,i?I:b),n(v,y)}else{const i=y.transparent===x.transparent;t(m,c,i?b:I,_),e(p,c,i?I:b),n(y,v)}}))}updateInstanceClippingByUserId(e){function t(e,t){for(var i=e.getAttribute("vClipping").array,n=0;n<t.length;++n){i[t[n]]=r.EnumElementState.LOCALCLIPPING}e.getAttribute("vClipping").needsUpdate=!0}var i=this;this.traverseNodeIdxMapByUserId(e,(function(e,r){var n=i.getInstanceGeometries(e);if(n)for(var a=0,s=n.length;a<s;a++)t(n[a],r)}))}updateInstanceClipping(e){var t=this,i=e?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;this.traverseNodeIdxMap((function(e,r){var n=t.getInstanceNodesById(e),a=n[0],s=n[1];a.forEach((e=>{const t=e.geometry.getAttribute("vClipping").array;for(let e=0,n=r.length;e<n;++e)t[r[e]]=i;e.geometry.getAttribute("vClipping").needsUpdate=!0})),s.forEach((e=>{const t=e.geometry.getAttribute("vClipping").array;for(let e=0,n=r.length;e<n;++e)t[r[e]]=i;e.geometry.getAttribute("vClipping").needsUpdate=!0}))}))}getUsableMaterialColorParamsBy(e,t,i,n){var a,s,o=e.selectedMaterial,l=e.getFilter()._getMaterialByName("scene"),d=e.materialManager,h=e.manager.getOverrideMaterialByName(t)||d.getMaterialById(t);switch(i){case r.EnumElementState.HOVER:n?(a=e.getFilter()._getMaterialByName(n),s=e.manager.sceneState.getHoverColorByMaterial(a)):s=e.manager.sceneState.getHoverColorByMaterial(h);break;case r.EnumElementState.SELECTED:s=r.MaterialUtil.getColorParamsByMaterial(o);break;case r.EnumElementState.TRANSPARENT:s=r.MaterialUtil.getColorParamsByMaterial(l);break;case r.EnumElementState.OVERRIDED:case r.EnumElementState.BLINK:n?(a=e.getFilter()._getMaterialByName(n),s=r.MaterialUtil.getColorParamsByMaterial(a)):s=r.MaterialUtil.getColorParamsByMaterial(h);break;default:s=r.MaterialUtil.getColorParamsByMaterial(h)}return s}getInstanceNodesById(e){return this.instanceNodeMap[e]}traverseInstanceNodeMap(e,t){for(var i=this.instanceNodeMap,r=0,n=(e=e||Object.keys(this.instanceNodeMap)).length;r<n;r++){var a=e[r];t(a,i[a])}}getInstanceGeometries(e){return this.instanceGeometryMap[e]}cacheInstanceGeometries(e,t,i,r){if(!this.instanceGeometryMap[e]){var n=this.instanceGeometryMap[e]=[];t instanceof Array||(t=[t]);for(var a=i?i.byteOffset:0,s=0,o=t.length;s<o;++s)if(n[s]=new THREE.InstancedBufferGeometry,n[s].setIndex(t[s].index),n[s].setAttribute("position",t[s].attributes.position),n[s].setAttribute("normal",t[s].attributes.normal),t[s].attributes.uv&&n[s].setAttribute("uv",t[s].attributes.uv),t[s].attributes.uv2)n[s].setAttribute("uv2",t[s].attributes.uv2);else if(i){var l=2*t[s].index.count,d=r.getLoader().getInstanceUV2ById(a,l);n[s].setAttribute("uv2",new THREE.Float32BufferAttribute(d,2)),a+=2*l}}}traverseInstanceGeometryMap(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}disposeInstanceGeometries(){this.traverseInstanceGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}cacheInstanceAttributeStateBy(e,t,i,n,a){var s=n.uv2Info?r.Utils.splitCombinedKeyString(n.materialId,"_")[0]:n.materialId,o=n.uvArrayBuffer;i instanceof Array||(i=[i]);var l=i.length,d=this.cachedInstance;if(!d.vState[t]){d.vState[t]=[],d.vClipping[t]=[],d.vColor[t]=[],d.mcol0[t]=[],d.mcol1[t]=[],d.mcol2[t]=[],d.mcol3[t]=[],d.muvCol0[t]=[],d.muvCol1[t]=[];for(var h=0;h<l;++h)d.muvCol0[t][h]=[],d.muvCol1[t][h]=[];n.uv2Info&&(d.uv2OffsetRepeat[t]=[])}var c=a||e.materialManager.getMaterialById(s);d.vColor[t].push(c.color.r,c.color.g,c.color.b,c.opacity),d.vState[t].push(r.EnumElementState.NONE,r.EnumElementState.NONE,r.EnumElementState.NONE,r.EnumElementState.NONE),d.vClipping[t].push(r.EnumElementState.NONE);var u=n.matrix.elements;if(d.mcol0[t].push(u[0],u[1],u[2]),d.mcol1[t].push(u[4],u[5],u[6]),d.mcol2[t].push(u[8],u[9],u[10]),d.mcol3[t].push(u[12],u[13],u[14]),n.uv2Info){var p=n.uv2Info.offsetRepeat;d.uv2OffsetRepeat[t].push(p[0],p[1],p[2],p[3])}if(o)for(h=0;h<l;++h)d.muvCol0[t][h].push(o[6*h],o[6*h+1]),d.muvCol0[t][h].push(o[6*h+2],o[6*h+3]),d.muvCol1[t][h].push(o[6*h+4],o[6*h+5]);else for(h=0;h<l;++h)d.muvCol0[t][h].push(1,0),d.muvCol0[t][h].push(0,1),d.muvCol1[t][h].push(0,0);return d.vState[t].length/4-1}cacheNodeIdxByUserId(e,t,i){var r=this.nodeIdxMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}getNodeIdxMapByUserId(e){return this.nodeIdxMapFromUserId[e]}traverseNodeIdxMapByUserId(e,t){var i=this.nodeIdxMapFromUserId[e];for(var r in i)t(r,i[r])}traverseNodeIdxMap(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),r=0,n=i.length;r<n;r++){var a=i[r],s=this.nodeIdxMapFromUserId[a];if(!t||!t(a))for(var o in s)e(o,s[o])}}cacheMatrixInfoByUserId(e,t,i){var r=this.matrixInfoMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}traverseMatrixInfoMapByUserId(e,t){var i=this.matrixInfoMapFromUserId[e];for(var r in i)t(r,i[r])}getMeshesByUserId(e,t){const i=this,r=e.getLengthUnitsMatrix();this.traverseMatrixInfoMapByUserId(t,(function(n,a){const s=i.getInstanceNodesById(n)[0];for(let i=0,n=a.length;i<n;i++)for(let n=0,o=s.length;n<o;n++){const l=a[i].matrix,d=s[n];let h;1===o?h=a[i].boundingBox:(h=d.geometry.boundingBox,h?h=h.clone():(d.geometry.computeBoundingBox(),h=d.geometry.boundingBox.clone()),h.applyMatrix4(l)),e.minDistanceObjects[t].push({mesh:s[n],matrix:l,unitsMatrix:r,boundingBox:h,modelMatrix:e.transformMatrix})}}))}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY)}clearSelectedObjectIds(){this.selectedObjectIds.length=0}cacheSelectedObjectIds(e,t){this.selectedObjectIds.push({uid:e,mgId:t})}adjustVisibility(e,t){if(!this.meshesVisible)return;const i=this._getNodeGroup(e);i._adjustActivated=!t,i.visible!==t&&(i.visible=t)}changeVisibilityOfSelectedObjects(e,t){function i(e,t){for(let i=0,n=e.length;i<n;i++){const n=e[i],a=[],s=n.geometry.getAttribute("vState").array;for(let e=0,t=s.length;e<t;e++)s[e]===r.EnumElementState.SELECTED&&(a.push({idx:e,state:s[e]}),s[e]=r.EnumElementState.HIDDEN);a.length?(n.geometry.getAttribute("vState").needsUpdate=!0,t.push({object:n,indices:a})):(t.push({object:n,indices:null,visibility:n.visible}),n.visible=!1)}}let n;if(t){n=this.selectedMeshes;for(let e=0,t=n.length;e<t;e++){const t=n[e].object,i=n[e].indices;if(i){if(i.length){const e=t.geometry.getAttribute("vState").array;for(var a=0,s=i.length;a<s;a++)i[a].state&&(e[i[a].idx]=i[a].state);t.geometry.getAttribute("vState").needsUpdate=!0}}else t.visible=n[e].visibility}}else{this.selectedMeshes.length=0,n=this.selectedMeshes;let e={};for(var o=0,l=this.selectedObjectIds.length;o<l;o++)e[this.selectedObjectIds[o].mgId]=!0;const t=Object.keys(e);this.traverseInstanceNodeMap(t,(function(e,t){const r=t[0],a=t[1];i(r,n),i(a,n)}))}}changeVisibilityOfNonSelectedObjects(e,t){function i(e,t,i){if(i)for(let i=0,n=e.length;i<n;i++){const n=e[i],a=[],s=n.geometry.getAttribute("vState").array;for(let e=0,t=s.length;e<t;e++)s[e]!==r.EnumElementState.SELECTED&&s[e]!==r.EnumElementState.HIDDEN&&(a.push({idx:e,state:s[e]}),s[e]=r.EnumElementState.HIDDEN);a.length?(n.geometry.getAttribute("vState").needsUpdate=!0,t.push({object:n,indices:a})):(t.push({object:n,indices:null,visibility:n.visible}),n.visible=!1)}else for(let i=0,r=e.length;i<r;i++){var n=e[i];t.push({object:n,indices:null,visibility:n.visible}),n.visible=!1}}let n;if(t){n=this.nonSelectedMeshes;for(let e=0,t=n.length;e<t;e++){const t=n[e].object,i=n[e].indices;if(i){if(i.length){const e=t.geometry.getAttribute("vState").array;for(let t=0,r=i.length;t<r;t++)i[t].state&&(e[i[t].idx]=i[t].state);t.geometry.getAttribute("vState").needsUpdate=!0}}else t.visible=n[e].visibility}}else{this.nonSelectedMeshes.length=0,n=this.nonSelectedMeshes;let e={};for(var a=0,s=this.selectedObjectIds.length;a<s;a++)e[this.selectedObjectIds[a].mgId]=!0;this.traverseInstanceNodeMap(null,(function(t,r){const a=r[0],s=r[1],o=e[t];i(a,n,o),i(s,n,o)}))}}restoreVisibilityOfObjects(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}getMeshIdByNodeInfo(e){return e.uv2Info?r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode,e.uv2Info.byteOffset]):r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode])}getMaterialIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[0]}getOriginalMaterialIdByMeshId(e){var t=r.Utils.splitCombinedKeyString(e);return r.Utils.splitCombinedKeyString(t[0],"_")[0]}disposeBufferAfterVbo(){var e;this.bufferDestroyed||(this.bufferDestroyed=!0,r.GlobalData.PickingEffect?e=["muvCol0","muvCol1","uv2OffsetRepeat"]:(e=["muvCol0","muvCol1","uv2OffsetRepeat","mcol0","mcol1","mcol2","mcol3"],r.GlobalData.EnableExplosion&&e.pop()),this.traverseInstanceGeometryMap((function(t,i){for(var n=0,a=i.length;n<a;n++)r.GeomUtil.disposeBufferFromGeometry(i[n],e)})))}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var n=[],a=e.getDatabagId(),s=r.ModelView.BaseDescriptor.EnumNodeItemType,o=0,l=i.length;o<l;o++){var d,h=i[o];switch(h.type){case s.BOX_M:d=r.GeomUtil.getBoxBufferGeometryWithUvMatrices(h.uvArrayBuffer);break;case s.PIPE_M:d=r.GeomUtil.getPipeBufferGeometryWithUvMatrices(h.uvArrayBuffer);break;default:d=this.getGeometryByNodeInfo(e,h)}var c=r.ModelView.BaseDescriptor.isLineNode(h);if(d instanceof Array)for(var u=0,p=d.length;u<p;u++){var m=d[u].getAttribute("uv");n.push({isLines:c,databagId:a,nodeId:h.nodeId,position:d[u].getAttribute("position").array,index:d[u].getIndex().array,matrix:h.matrix,uv:m?m.array:null})}else{m=d.getAttribute("uv");n.push({isLines:c,databagId:a,nodeId:h.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:h.matrix,uv:m?m.array:null})}}return n}explode(e){function t(e,t,i){for(var r=e.getAttribute("mcol3").array,n=0;n<t.length;++n){var a=t[n];r[3*a]+=i.x,r[3*a+1]+=i.y,r[3*a+2]+=i.z}e.getAttribute("mcol3").needsUpdate=!0}var i=this;for(var r in i.nodeIdxMapFromUserId)i.traverseNodeIdxMapByUserId(r,(function(n,a){var s=e.modelExplosion.getExplosionTranslation(r),o=i.getInstanceGeometries(n);o&&t(o[0],a,s)}))}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingInstancedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_traverseIntersectNode(e,t,i){for(let n in this.nodeIdxMapFromUserId)this.manager.isHiddenNode(n)||this.traverseMatrixInfoMapByUserId(n,((a,s)=>{const o=this.getInstanceNodesById(a)[0];for(let a=0,l=s.length;a<l;a++)for(let l=0,d=o.length;l<d;l++)r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[a].boundingBox,t)&&i&&i(n,o[l],s[a])}))}_traverseIntersectNodeLimit(e,t,i){for(let n in this.nodeIdxMapFromUserId)this.manager.isHiddenNode(n)||this.traverseMatrixInfoMapByUserId(n,((a,s)=>{const o=this.getInstanceNodesById(a)[0];for(let a=0,l=s.length;a<l;a++)for(let l=0,d=o.length;l<d;l++){const d=o[l].matrixWorld.clone().setPosition(0,0,0);r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[a].boundingBox,d)&&o[l].intersectBoxWithPlaneMesh(t,s[a])&&i&&i(n,o[l],s[a])}}))}calculateClippingIds(e,t,i,n){let a=n.getFilter().getLocalClippingList(),s=n.manager.viewer.getRenderer().localClippingEnabled&&a.size>0;const o=n.manager.getScene().getMatrixGlobal(),l=n.manager.getModelLengthUnitsMatrix(n),d=l?o.multiply(l).multiply(n.transformMatrix):o.multiply(n.transformMatrix);this._traverseIntersectNode(e,d,((o,l,d)=>{if(!s||s&&a.get(o)){const a=r.ClippingBorderLineUtil.calculateIntersection(e,l,d,n);r.ClippingBorderLineUtil.push(n,a,t,i,o)}}))}calculateClippingContours(e,t,i,r,n,a){this._traverseIntersectNodeLimit(t,i,((i,s,o)=>{if(-1===n.indexOf(i))return;let l=[];const d={matrix:o.matrix,isInstance:!0};if(s.getIntersectionContours(t,d,l),0===l.length)return;let h=[];const c=s.material.color,u={red:parseInt(255*c.r),green:parseInt(255*c.g),blue:parseInt(255*c.b)};l.map((e=>{let t=[];e.map((e=>{r.containsPoint(e)&&t.push(e)})),t.length>0&&h.push(t)})),void 0===a[e][i]?a[e][i]={clippingContours:[h],colors:[u]}:(a[e][i].clippingContours.push(h),a[e][i].colors.push(u))}))}_createGeometryByNodeInfo(e,t){if(r.ModelView.BaseDescriptor.isParameterizedNode(t))return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,null,e.lightmap);const i=void 0!==t.bufferId?t.bufferId:t.geometryId;let n=e.getModelDescriptor().getReferencedMeshBufferById(i);if(!n)return null;if(n.IndexInfos){let i={buffer:n,indexInfo:n.IndexInfos[t.indexInfoIdx]};return this._createNodeBufferByMpkBufferData(e,t,i)}return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,n,e.lightmap)}_collectSharedMeshBufferIds(e){const t=e.getModelDescriptor().getInstancedNodeInfosOnGeometryId();let i=!1;for(let e in t)if(!r.ModelView.BaseDescriptor.isParameterizedNodeType(e)){i=!0;break}if(!i)return;const n=e.getModelDescriptor().getReferencedMeshBufferData();Object.keys(n).forEach((e=>{const i=n[e].IndexInfos;if(i)for(let r=0,n=i.length;r<n;r++){const n=t[i[r].meshId];n&&n.length&&n.forEach((t=>{t.bufferId=e,t.indexInfoIdx=r}))}}))}_createNodeBufferByMpkBufferData(e,t,i){let r=this.createBufferForSharedMeshByBufferDataWithUV2(e,t,i,!1);if(!r)return null;let n=new THREE.BufferGeometry;return n.setIndex(new THREE.BufferAttribute(new Uint32Array(r.index),1)),n.setAttribute("position",new THREE.BufferAttribute(new Float32Array(r.position),3)),r.normal&&n.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(r.normal),3)),r.uv&&n.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(r.uv),2)),r.uv2&&n.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(r.uv2),2)),e.lightmap&&void 0!==t.itemIdUV2&&(t.geometryIdCode=t.geometryIdCode+"_"+t.itemIdUV2),this._cacheGeometry(t.geometryIdCode,n),n}}r.ModelView.InstancedMeshManager=a}(),r.ModelView.InstancedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.generated=!1,this.meshesVisible=!0}destroy(){if(this.disposeGeometries(),this.wireframeGeometryMap=null,this.noNeedWireframingIdMap=null,this.manager=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.generated=!1,this.bufferDestroyed=!1,this.disposeGeometries(),this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}disposeGeometries(){this._traverseWireframeGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}updateNodes(e){this.meshesVisible=e.isActivateWireframe();const t=this._getNodeGroup(e);this.meshesVisible?t._adjustActivated||(t.updateMatrixWorld(!0),t.visible=!0):t.visible=!1}resetInstanceMaterial(e){var t=r.EnumElementState.NONE,i=e.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;this._traverseWireframeGeometryMap((function(e,r){for(var n=0,a=r.length;n<a;++n){for(var s=r[n].getAttribute("vState").array,o=r[n].getAttribute("vClipping").array,l=0,d=s.length;l<d;l++)s[l]=t,o[l]=i;r[n].getAttribute("vState").needsUpdate=!0,r[n].getAttribute("vClipping").needsUpdate=!0}})),this._updateNoWireframingState()}updateInstanceWireframeByUserId(e,t,i,n){if(i===r.EnumElementState.HIDDEN||i===r.EnumElementState.NONE||i===r.EnumElementState.OVERRIDED){if(!this._isNeedWireframing(t))return;var a;if(n){var s=e.getFilter()._getMaterialByName(n),o=r.MaterialUtil.getColorParamsByMaterial(s);a=o.rgbaColor}var l=this;this.manager.traverseNodeIdxMapByUserId(t,(function(e,t){l._setInstanceWireframeState(e,t,i,a)}))}}updateInstanceWireframeClippingByUserId(e){var t=this;this.manager.traverseNodeIdxMapByUserId(e,(function(e,i){var n=t._getWireframeGeometryById(e);if(n)for(var a=0,s=n.length;a<s;++a){for(var o=n[a].getAttribute("vClipping").array,l=0,d=i.length;l<d;++l)o[i[l]]=r.EnumElementState.LOCALCLIPPING;n[a].getAttribute("vClipping").needsUpdate=!0}}))}updateInstanceWireframeClipping(e){var t=this,i=e?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;this.manager.traverseNodeIdxMap((function(e,r){var n=t._getWireframeGeometryById(e);if(n)for(var a=0,s=n.length;a<s;++a){for(var o=n[a].getAttribute("vClipping").array,l=0,d=r.length;l<d;++l)o[r[l]]=i;n[a].getAttribute("vClipping").needsUpdate=!0}}))}_updateNoWireframingState(){var e=this,t=r.EnumElementState.HIDDEN;this.manager.traverseNodeIdxMap((function(i,r){e._setInstanceWireframeState(i,r,t)}),(function(t){return e._isNeedWireframing(t)}))}_setInstanceWireframeState(e,t,i,r){var n=this._getWireframeGeometryById(e);if(n)for(var a=0,s=n.length;a<s;++a){var o=n[a].getAttribute("vState").array,l=null,d=null;r&&(d=(l=n[a].getAttribute("aColor"))?l.array:null);for(var h=0,c=t.length;h<c;++h){var u=t[h];o[4*u]=i,null!==d&&(d[4*u]=r[0],d[4*u+1]=r[1],d[4*u+2]=r[2],d[4*u+3]=r[3])}n[a].getAttribute("vState").needsUpdate=!0,l&&(l.needsUpdate=!0)}}_generateInstanceWireframe(e){this._collectNoWireframingIds(e),this._createInstanceWireframeGeometries(),this._makeInstanceWireframe(e),this._updateNoWireframingState()}generateWireframe(e){this.generated||(this._generateInstanceWireframe(e),this.generated=!0)}_collectNoWireframingIds(e){var t=this,i=e.getFilter();e.getModelDescriptor().traverseInstancedNodeInfos(null,(function(e,r){r&&i.getWireFrameVisibilityCondition()?i._isRenderWithWireFrame(r[0])||(t.noNeedWireframingIdMap[e]=!0):r&&i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(r[0])&&(t.noNeedWireframingIdMap[e]=!0)}))}_createInstanceWireframeGeometries(){var e=this,t={};this.manager.traverseInstanceGeometryMap((function(i,r){for(var n=e._getWireframeBufferById(i,r,t),a=e.wireframeGeometryMap[i]=[],s=0,o=n.length;s<o;s++){var l=new THREE.InstancedBufferGeometry;l.setIndex(n[s].index),l.setAttribute("position",n[s].position),a.push(l)}})),t=null}_makeInstanceWireframe(e){var t=this,i=this.manager,n=i.getCachedInstanceData(),a=this._getWireframeMaterial(e),s=e.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;this.instanceNodeMap={},this._traverseWireframeGeometryMap((function(o,l){var d=i.getBufferAttributesBy(o);t.instanceNodeMap[o]=[];for(var h=0,c=l.length;h<c;h++){l[h].setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[o]),4,!1,1)),l[h].setAttribute("vClipping",new THREE.InstancedBufferAttribute(new Float32Array(n.vClipping[o]),1,!1,1)),l[h].setAttribute("mcol0",d.attributeMcol0),l[h].setAttribute("mcol1",d.attributeMcol1),l[h].setAttribute("mcol2",d.attributeMcol2);const i=r.GeomUtil.getMatrixFromInstancedBufferAttribute(d.attributeMcol3);l[h].setAttribute("mcol3",d.attributeMcol3),l[h].getAttribute("vClipping").array.fill(s),t._setDefaultColorAttribute(e,l[h],n.vState[o].length/4);var u=new THREE.LineSegments(l[h],a);u.frustumCulled=!1,i&&(u.matrix.copy(i),u.matrixAutoUpdate=!1,u.updateMatrixWorld(!0)),t.instanceNodeMap[o].push(u),t._addWireframeNodeToScene(e,u)}}))}_setDefaultColorAttribute(e,t,i){for(var r=this._getWireframeMaterial(e),n=[],a=0;a<i;a++)n.push(r.color.r,r.color.g,r.color.b,r.opacity);t.setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(n),4,!1,1))}_addWireframeNodeToScene(e,t){this._getNodeGroup(e).add(t),t.updateMatrixWorld(!0)}_isNeedWireframing(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}_getWireframeMaterial(e){return e.getInstanceWireframeMaterial()}_getWireframeBufferById(e,t,i){var n=this.getGeometryIdByMeshId(e);if(i[n])return i[n];i[n]=[];for(var a=0,s=t.length;a<s;a++){var o=t[a];i[n].push({index:r.BuildEdge(o.attributes.position.array,o.index.array),position:o.attributes.position})}return i[n]}_getWireframeGeometryById(e){return this.wireframeGeometryMap[e]}_traverseWireframeGeometryMap(e){var t=this.wireframeGeometryMap;for(var i in t)e(i,t[i])}_traverseWireframeMeshNodeMap(e){var t=this.instanceNodeMap;for(var i in t)e(i,t[i])}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY)}getGeometryIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[1]}adjustVisibility(e,t){if(!this.meshesVisible)return;const i=this._getNodeGroup(e);i._adjustActivated=!t,i.visible!==t&&(i.visible=t)}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){if(this.generated&&!this.bufferDestroyed){this.bufferDestroyed=!0;var e=["mcol0","mcol1","mcol2","mcol3"];r.GlobalData.EnableExplosion&&e.pop(),this._traverseWireframeGeometryMap((function(t,i){for(var n=0,a=i.length;n<a;n++)r.GeomUtil.disposeBufferFromGeometry(i[n],e)}))}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingInstancedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},function(){class e extends r.ModelView.InstancedBaseManager{constructor(e){super(),this.meshManager=new r.ModelView.InstancedMeshManager(this,e),this.wireframeManager=new r.ModelView.InstancedWireframeManager(this,e)}}r.ModelView.InstancedManager=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=null,this.instancedManager=null,this.loader=null}prepare(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(this.model,t),!this.model.lightmap||this.model.enableLightmap==r.GlobalData.EnableLightmap&&this.model.lightmapIntensity==r.GlobalData.LightmapIntensity&&i==r.GlobalData.EnableTextureMapping||(this.model.enableLightmap=r.GlobalData.EnableLightmap,this.model.lightmapIntensity=r.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.loader.getDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this,i=this.model,r=this.loader.getDescriptor();this.instancedManager.createMeshNodes(i,r.getInstancedUserIds()),this.defaultManager.asyncCreateMeshNodes(i,r.getStandardUserIds(),(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}clearCachedData(){this.loader.getDescriptor().destroyReader(),this.loader.getDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}r.ModelView.BatchedBaseHandler=e}(),r.ModelView.BatchedBaseManager=class{constructor(){this.meshManager=null,this.wireframeManager=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}updateNodes(e){this.meshManager.update(e),this.wireframeManager.update(e)}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}asyncGenerateWireframe(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}rebuildIndices(e){this._rebuildIndices(e)}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}getMeshNode(){return this.meshManager.getMeshNode()}getPropertyValueByMaterialKey(e){return this.meshManager.getPropertyValueByMaterialKey(e)}getFilteredUserIds(){return this.mapMaterialIdToUserIdsForFilter}getSelectedUserIds(){return this.mapMaterialIdToUserIdsForSelection}getHoveredUserIds(){return this.mapMaterialIdToUserIdsForHover}getBlinkedUserIds(){return this.mapBlinkUserIds}getHiddenUserIds(){return this.hiddenUserIdSetObject}getTransparentUserIds(){return this.transparentUserIdSetObject}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;i=t||e.getModelDescriptor().getStandardUserIds();var r=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._rebuildIndices(e),this.updateNodes(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._rebuildIndices(e),this.updateNodes(e)}_collectFilteredUserIds(e,t,i){var n=e.getFilter(),a=n._hasHiddenFileIdFilter(),s=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),l=n._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.transparentUserIdSetObject={},a||s||o||l||d||h)for(var u=0;u<t.length;++u){var p=t[u],m=i[p];if(m&&m.length)for(var f=0,g=m.length;f<g;f++){var v=m[f];a&&n._isHiddenFileId(v)||s&&!1===n._isVisible(v)||e.isReplacedUserId(p)||e.isHiddenSourceObjectUserId(p)?(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.HIDDEN]&&(c[v.materialId][r.EnumElementState.HIDDEN]={}),c[v.materialId][r.EnumElementState.HIDDEN][p]=!0,this.hiddenUserIdSetObject[p]=!0):l&&n._isTransparent(v)?(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.TRANSPARENT]&&(c[v.materialId][r.EnumElementState.TRANSPARENT]={}),c[v.materialId][r.EnumElementState.TRANSPARENT][p]=!0,this.transparentUserIdSetObject[p]=!0):o&&n._hasOverrideMaterial(v)&&n._getOverrideMaterials(v).forEach((e=>{let t=String(v.nodeId);if(e.nodeIds){if(e.nodeIds.includes(t)){let t=null!=e?e.name:"";""!==t&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.OVERRIDED]&&(c[v.materialId][r.EnumElementState.OVERRIDED]={}),c[v.materialId][r.EnumElementState.OVERRIDED][p]=t)}}else{let t=null!=e?e.name:"";""!==t&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.OVERRIDED]&&(c[v.materialId][r.EnumElementState.OVERRIDED]={}),c[v.materialId][r.EnumElementState.OVERRIDED][p]=t)}}))}}}_clearFilteredState(){this.mapMaterialIdToUserIdsForFilter=null}_collectSelectedUserIds(e,t){var i=this.mapMaterialIdToUserIdsForSelection={};for(var r in e){var n=t[r];if(n&&n.length)for(var a=0,s=n.length;a<s;a++)void 0===i[n[a].materialId]&&(i[n[a].materialId]={}),void 0===i[n[a].materialId][r]&&(i[n[a].materialId][r]=!0)}}_clearSelectedState(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}_collectHoveredUserIds(e,t){var i=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var r=t[e],n=0,a=r.length;n<a;n++)void 0===i[r[n].materialId]&&(i[r[n].materialId]={}),void 0===i[r[n].materialId][e]&&(i[r[n].materialId][e]=!0)}_clearHoveredState(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}_collectBlinkedUserIds(e,t){var i=this.mapBlinkUserIds={};for(var r in e){var n=t[r];if(n&&n.length)for(var a=0,s=n.length;a<s;a++)void 0===i[n[a].materialId]&&(i[n[a].materialId]={}),void 0===i[n[a].materialId][r]&&(i[n[a].materialId][r]=!0)}}_clearBlinkedState(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}_rebuildIndices(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}clearCachedData(){this.meshManager.clearAllNodeBuffer()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}isPickableNode(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var i=this.getTransparentUserIds();return!i||!i[e]}isHiddenNode(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.BatchedDescriptor}}r.ModelView.BatchedLoader=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}}r.ModelView.BatchedDescriptor=e}(),function(){class e extends r.ModelView.MeshBaseManager{constructor(e,t){super(),this.manager=e,this._maxIndiceseNum=0,this._materialList=[],this.mapMaterialIdToMergedNode={},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.blinkMaterials=[],this.mapDestroyedBufferKey={},this.clippingIdsForInstance=[],this.isCalculatedClippingIds=!1,this.clippingMaterialMap={},this.version=t}destroy(){if(super.destroy(),this.clearData(),this.mapMaterialIdToMergedNode=null,this.manager=null,this._materialList=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.blinkMaterials=null,this.mapDestroyedBufferKey=null,this.clippingMaterialMap=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.bufferDestroyed=!1,this.clearAllNodeBuffer(),this._disposeMergedGeometries(),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}getMeshesByUserId(e,t){const i=[],r=e.getLengthUnitsMatrix();for(let n in this.mapMaterialIdToMergedNode){const a=this.mapMaterialIdToMergedNode[n];for(let n=0,s=a.length;n<s;n++){const s=a[n],o=s.indices;for(let n in o)if(n==t){const t=o[n];for(let n=0,a=t.length;n<a;n++)i.push({mesh:s.mesh,indexInfo:t[n],boundingBox:t[n].boundingBox,unitsMatrix:r,modelMatrix:e.transformMatrix})}}}return i}getMeshesByUserIds(e,t,i){const r=e.getLengthUnitsMatrix();for(let n in this.mapMaterialIdToMergedNode){const a=this.mapMaterialIdToMergedNode[n];for(let n=0,s=a.length;n<s;n++){const s=a[n],o=s.indices;for(let n in o)if(n==t||n==i){const t=o[n];for(let i=0,a=t.length;i<a;i++)e.minDistanceObjects[n].push({mesh:s.mesh,indexInfo:t[i],boundingBox:t[i].boundingBox,unitsMatrix:r,modelMatrix:e.transformMatrix})}}}}_traverseIntersectNodeLimit(e,t,i){const n=this.manager.getHiddenUserIds();for(let a in this.mapMaterialIdToMergedNode){const s=this.mapMaterialIdToMergedNode[a];for(let a=0,o=s.length;a<o;a++){const o=s[a],l=o.mesh,d=l.matrixWorld.clone().setPosition(0,0,0),h=o.indices;for(const a in h){if(n&&n[a])continue;const s=h[a];for(let n=0,a=s.length;n<a;n++)"LineSegmentsEx"!=l.type&&r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[n].boundingBox,d)&&l.intersectBoxWithPlaneMesh(t,s[n])&&i&&i(l,s[n])}}}}_traverseIntersectNode(e,t,i){const n=this.manager.getHiddenUserIds();for(let a in this.mapMaterialIdToMergedNode){const s=this.mapMaterialIdToMergedNode[a];for(let a=0,o=s.length;a<o;a++){const o=s[a],l=o.mesh,d=o.indices;for(const a in d){if(n&&n[a])continue;const s=d[a];for(let n=0,a=s.length;n<a;n++)"LineSegmentsEx"!=l.type&&r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[n].boundingBox,t)&&i&&i(l,s[n])}}}}preCalculateClippingIdsForInstance(e){if(this.isCalculatedClippingIds)return;let t=e.getModelDescriptor(),i=t.getStandardUserIds(),n=t.getInstancedNodeInfos();if(n){for(var a=0;a<i.length;a++){let e=i[a],t=n[e];if(t&&t instanceof Array)for(let i=0;i<t.length;i++)if(t[i].type==r.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF){this.clippingIdsForInstance.push(e);break}}this.isCalculatedClippingIds=!0}}calculateClippingIds(e,t,i,n){let a=n.getFilter().getLocalClippingList(),s=n.manager.viewer.getRenderer().localClippingEnabled&&a.size>0;const o=n.manager.getScene().getMatrixGlobal(),l=n.manager.getModelLengthUnitsMatrix(n),d=l?o.multiply(l).multiply(n.transformMatrix):o.multiply(n.transformMatrix);this._traverseIntersectNode(e,d,((o,l)=>{let d=[];if(!s||s&&a.get(l.userId)){const a=r.ClippingBorderLineUtil.calculateIntersection(e,o,l,n);d=d.concat(a),r.ClippingBorderLineUtil.push(n,d,t,i,l.userId)}}))}calculateClippingContours(e,t,i,r,n,a){this._traverseIntersectNodeLimit(t,i,((i,s)=>{const o=s.userId;if(-1===n.indexOf(o))return;let l=[];if(i.getIntersectionContours(t,s,l),0===l.length)return;let d=[];const h=i.material[0].color,c={red:parseInt(255*h.r),green:parseInt(255*h.g),blue:parseInt(255*h.b)};l.map((e=>{let t=[];e.map((e=>{r.containsPoint(e)&&t.push(e)})),t.length>0&&d.push(t)})),void 0===a[e][o]?a[e][o]={clippingContours:[d],colors:[c]}:(a[e][o].clippingContours.push(d),a[e][o].colors.push(c))}))}rebuildIndices(e){this._materialList.length=0,this.clearSelectedObjectIds();var t=this.manager.getFilteredUserIds(),i=this.manager.getSelectedUserIds(),n=this.manager.getHoveredUserIds(),a=this.manager.getBlinkedUserIds(),s=e.mapClippingIds,o=!1,l=null,d=e.getFilter();for(var h in d&&(o=d._hasLocalClipping(),l=d.getLocalClippingList()),this.mapMaterialIdToMergedNode){var c,u,p,m,f=this.getPropertyValueByMaterialKey(h).materialId,g=null,v=null,y=null,M=null,E=null,x=null;i&&i[f]&&(M=i[f]),n&&n[f]&&(E=n[f]),a&&a[f]&&(x=a[f]),t&&t[f]&&(g=t[f][r.EnumElementState.HIDDEN],v=t[f][r.EnumElementState.OVERRIDED],y=t[f][r.EnumElementState.TRANSPARENT]);var _=this.mapMaterialIdToMergedNode[h];for(p=0,m=_.length;p<m;p++){var b=_[p],I=(b.mesh,b.indices),T=b.geometry;if(T.clearGroups(),T._visible=!0,M||g||v||E||y||s||o||x){var S=[];for(var C in I)if(I.hasOwnProperty(C)){if(g&&g[C])continue;var w=I[C];if(w&&w.length>0){if(w.sort((function(e,t){return e.indexStart-t.indexStart})),l&&l.get(C)){var R="localClipping#"+C+"#"+w[0].nodeId;y&&y[C]?R+="#transparent":x&&x[C]?(R+="#blink",v&&v[C]&&(R+="#"+v[C])):E&&E[C]?(R+="#hover",v&&v[C]&&(R+="#"+v[C])):v&&v[C]&&(R+="#override#"+v[C]),this._materialList.push(R);var B=this._materialList.length-1;for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}if(y&&y[C]){for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.TRANSPARENT});continue}if(e.manager.isSelectPriority()){if(M&&M[C]){if(this.cacheSelectedObjectIds(C,h,p),r.GlobalData.PickingEffect){if(v&&v[C]){var A="selected#"+v[C];for(-1===(B=this._materialList.indexOf(A))&&(this._materialList.push(A),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.NONE});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.SELECTED});continue}if(x&&x[C]){let e;e=`blink#${f}#${C}`,v&&v[C]&&(e=`blink#${v[C]}#${C}`);B=this._materialList.indexOf(e);for(-1===B&&(this._materialList.push(e),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}}else{if(x&&x[C]){let e;e=`blink#${f}#${C}`,v&&v[C]&&(e=`blink#${v[C]}#${C}`);B=this._materialList.indexOf(e);for(-1===B&&(this._materialList.push(e),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}if(M&&M[C]){if(this.cacheSelectedObjectIds(C,h,p),r.GlobalData.PickingEffect){if(v&&v[C]){A="selected#"+v[C];for(-1===(B=this._materialList.indexOf(A))&&(this._materialList.push(A),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.NONE});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.SELECTED});continue}}if(E&&E[C]){if(v&&v[C]){A="hover#"+v[C];for(-1===(B=this._materialList.indexOf(A))&&(this._materialList.push(A),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.HOVER});continue}if(v&&v[C]){A=v[C];for(-1===(B=this._materialList.indexOf(A))&&(this._materialList.push(A),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.OVERRIDED+B});continue}if(s.get(C))for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.EnumElementState.CLIPPING});for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:0})}}if(S.length>0)for(c=0,u=S.length;c<u;c++){var P=S[c].indexStart,L=S[c].indexCount,O=S[c].state;if(0===c)T.addGroup(P,L,O);else{var D=S[c-1].indexStart,N=S[c-1].indexCount;O===S[c-1].state&&P===D+N?T.groups[T.groups.length-1].count+=L:T.addGroup(P,L,O)}}else T._visible=!1}}}}update(e){var t,i,n,a,s=e.getFilter(),o=e.materialManager,l=e.materialManager.materials,d=e.selectedMaterial,h=e.manager.sceneState;if(e.isOnlyWireframe())for(var c in this.mapMaterialIdToMergedNode){for(n=0,a=(R=this.mapMaterialIdToMergedNode[c]).length;n<a;n++){(A=R[n].mesh)&&(A.visible=!1)}}else{r.GlobalData.TranslucentDepthDisabled&&(d.transparent?d.depthWrite=!1:d.depthWrite=!0);var u=s._getMaterialByName("scene");r.GlobalData.TranslucentDepthDisabled&&(u.depthWrite=!1);var p=[];this.blinkMaterials.length=0;var m={},f=s.getLocalClippingList();for(t=0,i=this._materialList.length;t<i;t++){var g,v=this._materialList[t],y=v.split("#");if("hover"===y[0])g=s._getMaterialByName(y[1]),g=h.getHoverMaterial(g);else if("blink"===y[0])g=s._getMaterialByName(y[1])||o.getMaterialById(y[1]),g=h.getBlinkMaterial(g,v),m[v]||(m[v]=g,this.blinkMaterials.push(g));else if("localClipping"===y[0]){var M=y[1],E=y[2],x=f.get(M).nodeMap.get(E),_=s.getMaterialForClipBy(x);if(y[3]&&"transparent"==y[3]){var b=x+y[3];(g=s.getMaterialForClipBy(b,_)).copy(u),g.isOverrideOpacity=g.transparent}else if(y[3]&&"blink"==y[3]){if(y[4]){b=x+y[3]+y[4];g=s.getMaterialForClipBy(b,_);var I=s._getMaterialByName(y[4]);I=h.getBlinkMaterial(I,e.id),g.copy(I)}else{b=x+y[3];g=s.getMaterialForClipBy(b,_);var T=h.getBlinkMaterial(g,e.id);g.copy(T)}m[g.name]||(m[v]=g,this.blinkMaterials.push(g))}else if(y[3]&&"hover"==y[3])if(y[4]){b=x+y[3]+y[4];g=s.getMaterialForClipBy(b,_);I=s._getMaterialByName(y[4]);I=h.getHoverMaterial(I),g.copy(I)}else{b=x+y[3];g=s.getMaterialForClipBy(b,_);var S=h.getHoverMaterial(g);g.copy(S)}else if(y[3]&&"override"==y[3]){b=x+y[3]+y[4];g=s.getMaterialForClipBy(b,_);I=s._getMaterialByName(y[4]);g.copy(I),g.isOverrideOpacity=I.transparent}else g=_;g.clippingPlanes=_.clippingPlanes,this.clippingMaterialMap[g.name]=!0}else g=s._getMaterialByName(v);r.GlobalData.TranslucentDepthDisabled&&(g.transparent?g.depthWrite=!1:g.depthWrite=!0),p[t]=g}for(var c in this.mapMaterialIdToMergedNode){var C=this.getPropertyValueByMaterialKey(c).materialId,w=e.manager.getOverrideMaterialByName(C)||o.getMaterialById(C);r.GlobalData.TranslucentDepthDisabled&&(w.transparent?w.depthWrite=!1:w.depthWrite=!0);var R,B=h.getHoverMaterial(l[C]);for(r.GlobalData.TranslucentDepthDisabled&&(B.transparent?B.depthWrite=!1:B.depthWrite=!0),n=0,a=(R=this.mapMaterialIdToMergedNode[c]).length;n<a;n++){var A,P=R[n],L=P.geometry;if(null!==L)if(A=P.mesh)if(L._visible){if(L.groups.length>0){r.GeomUtil.limitGeometryBufferSize(L);var O=[];for(O[r.EnumElementState.NONE]=w,O[r.EnumElementState.SELECTED]=d,O[r.EnumElementState.HOVER]=B,O[r.EnumElementState.TRANSPARENT]=u,O[r.EnumElementState.CLIPPING]=w,t=0,i=p.length;t<i;t++)this.clippingMaterialMap[p[t].name]||(p[t].side=w.side),r.Utils.defined(A.material[0])&&r.Utils.defined(A.material[0].growthAnimationPlanes&&A.material[0].defines&&A.material[0].defines.hasOwnProperty("GROWTH_ANIMATION"))&&(p[t].growthAnimationPlanes=A.material[0].growthAnimationPlanes,p[t].defines=r.Utils.defaultValue(p[t].defines,{}),p[t].defines.GROWTH_ANIMATION="",p[t].refreshUniforms()),O[r.EnumElementState.OVERRIDED+t]=p[t];if(r.Utils.defined(A.material[0])&&r.Utils.defined(A.material[0].growthAnimationPlanes))for(let e=0;e<O.length;++e)O[e]&&(O[e]=O[e].clone(),O[e].growthAnimationPlanes=A.material[0].growthAnimationPlanes,O[e].refreshUniforms());A.material=O}else r.GeomUtil.limitGeometryBufferSize(L),A.material=L.groups.length?[w]:w;A.visible=!0}else A.visible=!1}w=null}}}explode(e){function t(e,t,i,r){for(var n=e.getAttribute("position").array,a=t;a<i;a+=3)n[a]+=r.x,n[a+1]+=r.y,n[a+2]+=r.z;e.getAttribute("position").needsUpdate=!0}for(var i in this.mapMaterialIdToMergedNode)for(var r=this.mapMaterialIdToMergedNode[i],n=0,a=r.length;n<a;n++){var s=r[n],o=s.geometry;if(null!==o){var l=s.indices;for(var d in l){var h=e.modelExplosion.getExplosionTranslation(d),c=l[d];if(c)for(var u=0,p=c.length;u<p;u++){var m=c[u].positionStart;t(o,m,m+c[u].positionCount,h)}}}}}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.GEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.GEOMETRY)}_resetMaxIndicesNumberPerBathSegment(e){r.GlobalData.SegmentedBatchMergeEnable&&r.GlobalData.maxIndicesNumberPerBathSegment<this._maxIndiceseNum&&(console.log("adjust maxIndicesNumberPerBathSegment value from "+r.GlobalData.maxIndicesNumberPerBathSegment+" to "+this._maxIndiceseNum+"!"),r.GlobalData.maxIndicesNumberPerBathSegment=e)}asyncCreateMeshNodes(e,t,i){var r=this;t&&t.length?this._asyncMergeData(e,t,(function(){r._makeMeshNodes(e),i&&i()})):i&&i()}_asyncMergeData(e,t,i){var n={},a=this,s=e.getLoader().maxLoadTaskCount,o=e.progressPercentage.load,l=e.progressPercentage.collect,d=t.length,h=Math.ceil(d/e.progressFrequency),c=e.getModelDescriptor().getStandardNodeInfos();requestAnimationFrame(function u(p){var m=p;return function(){var p,f;for(f=m+h>d?d:m+h,p=m;p<f;p++){var g=t[p];if(a._collectMergedNodeInfosById(e,g,c,n),p===f-1)if(f!==d){var v={total:s,loaded:(p/d*l+o)*s};e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),requestAnimationFrame(u(p+1))}else{v={total:s,loaded:(l+o)*s};e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),a._asyncMergeGeometry(n,e,i)}}}}(0))}_asyncMergeGeometry(e,t,i){var n=[];for(var a in e)n.push(a);if(0!==n.length){this._resetMaxIndicesNumberPerBathSegment(this._maxIndiceseNum);var s=this,o=t.getLoader().maxLoadTaskCount,l=t.progressPercentage.load,d=t.progressPercentage.collect,h=t.progressPercentage.merge,c=n.length,u=Math.ceil(c/t.progressFrequency),p=this.mapMaterialIdToMergedNode;requestAnimationFrame(function a(m){var f=m;return function(){var m,g;for(g=f+u>c?c:f+u,m=f;m<g;m++)if(s._collectMergedGeometriesById(n[m],e,p),m===g-1)if(g!==n.length){var v={total:o,loaded:(m/c*h+l+d)*o};t.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),requestAnimationFrame(a(m+1))}else i()}}(0))}else i()}_collectMergedNodeInfosById(e,t,i,r){for(var n=i[t],a=0,s=n.length;a<s;a++){var o=n[a];this._createNodeBuffer(e,o);var l=this._getNodeBufferBy(o.nodeId);if(l){var d=l.index;d&&d.length>this._maxIndiceseNum&&(this._maxIndiceseNum=d.length);var h=this._getMaterialKeyByNodeInfo(o,e);void 0===r[h]&&(r[h]=[]),r[h].push(o)}}}_collectMergedGeometriesById(e,t,i){var n=t[e],a=0,s=0,o=0,l=0,d=0,h=null;void 0===i[e]&&(i[e]=[]);var c=[],u=0;n.sort((function(e,t){return e.userId-t.userId}));let p=null;for(var m=0,f=n.length;m<f;m++){var g=n[m];(h=this._getNodeBufferBy(g.nodeId))?(s+=h.index.length,a+=h.position.length,h.normal&&(o+=h.normal.length),h.uv&&(l+=h.uv.length),h.uv2&&(d+=h.uv2.length),p||(p=h.position instanceof Float64Array?Float64Array:Float32Array),r.GlobalData.SegmentedBatchMergeEnable&&s>r.GlobalData.maxIndicesNumberPerBathSegment?(s-=h.index.length,a-=h.position.length,h.normal&&(o-=h.normal.length),h.uv&&(l-=h.uv.length),h.uv2&&(d-=h.uv2.length),c.push({start:u,end:m,arrayPositionLength:a,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d}),a=0,s=0,o=0,l=0,d=0,u=m,m-=1):m===f-1&&c.push({start:u,end:f,arrayPositionLength:a,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d}),h=null):m===f-1&&c.push({start:u,end:f,arrayPositionLength:a,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d})}null===p&&(p=Float32Array);for(var v=0,y=c.length;v<y;v++){var M=c[v],E=new THREE.BufferGeometry,x={},_=new p(M.arrayPositionLength),b=new Uint32Array(M.arrayIndexLength),I=new Float32Array(M.arrayNormalLength),T=new Float32Array(M.arrayUVLength),S=new Float32Array(M.arrayUV2Length),C=0,w=0,R=0,B=0,A=0,P=[];for(m=M.start,f=M.end;m<f;m++){g=n[m];if(h=this._getNodeBufferBy(g.nodeId)){P.push(g.nodeId);var L=h.index,O=h.position,D=h.normal,N=h.uv,H=h.uv2;_.set(O,C);for(var U=Uint32Array.from(L),F=0,k=U.length;F<k;F++)U[F]+=C/3;b.set(U,w),void 0===x[g.userId]&&(x[g.userId]=[]),x[g.userId].push({userId:g.userId,nodeId:g.nodeId,positionStart:C,positionCount:O.length,indexStart:w,indexCount:L.length,lightmapIdx:g.lightmapIdx,boundingBox:g.boundingBox}),w+=L.length,C+=O.length,D&&(I.set(D,R),R+=D.length),N&&(T.set(N,B),B+=N.length),H&&(S.set(H,A),A+=H.length),L=null,O=null,D=null,N=null,H=null,h=null}}this.clearNodeBufferByNodeIds(P),E._visible=!0,E.setIndex(new THREE.BufferAttribute(b,1)),E.setAttribute("position",new THREE.BufferAttribute(_,3));let t=null;r.Compatibility.isUseDoubleMatrixMPKHeader(this.version),0,R>0&&E.setAttribute("normal",new THREE.BufferAttribute(I,3)),B>0&&E.setAttribute("uv",new THREE.BufferAttribute(T,2)),A>0&&E.setAttribute("uv2",new THREE.BufferAttribute(S,2)),i[e].push({geometry:E,indices:x,matrix:t})}}clearAllNodeBuffer(){this.cachedNodeBuffer&&(this.cachedNodeBuffer=null)}clearNodeBufferByNodeIds(e){if(this.cachedNodeBuffer)for(var t=0,i=e.length;t<i;t++)this.cachedNodeBuffer[e[t]]=null}_getNodeBufferByNodeInfo(e,t){return this.cachedNodeBuffer||this._createNodeBuffer(e,t),this.cachedNodeBuffer[t.nodeId]}_getNodeBufferBy(e){return this.cachedNodeBuffer?this.cachedNodeBuffer[e]:null}_createNodeBufferByMpkBufferData(e,t,i){this.cachedNodeBuffer||(this.cachedNodeBuffer={}),this.cachedNodeBuffer[t.nodeId]||(this.cachedNodeBuffer[t.nodeId]=this.createBufferByBufferDataWithUV2(e,t,i))}_createNodeBuffer(e,t){this._createNodeBufferByMpkBufferData(e,t,{buffer:e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),isDataView:!0})}_createGeometries(e,t){var i=this,r=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),n=e.getModelDescriptor().getReferencedMeshBufferData(),a=this._getClassifiedMeshes(r,n);this._dealDataMergedMeshs(e,a,n,r,(function(){i._dealDataMergeableMeshs(e,a,n,r,t)}))}_getClassifiedMeshes(e,t){var i={},n={};for(var a in t){var s=t[a].IndexInfos,o=void 0;if(s){if(s.length<1)continue;for(var l=0,d=s.length;l<d;l++){if((h=e[s[l].meshId])&&h.length){o=s[l].meshId;break}}}else{var h;(h=e[a])&&h.length&&(o=a)}if(void 0!==o)(h=e[o])&&h.length&&(h[0].type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE||!h[0].instanceOrNot&&h[0].type===r.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?i[a]=!0:n[a]=!0)}if(!r.GlobalData.Instance)for(var a in e)n[a]||i[a]||(i[a]=!0);return{mergeableIdxs:Object.keys(i),mergedIdxs:Object.keys(n)}}_collectMergeableMeshesByIdxId(e,t,i,r,n){i[t]&&i[t].IndexInfos?this._collectSharedMeshesByIdxId(e,t,i,r,n):this._collectLineOrIntanceMeshesByIdxId(e,t,i,r,n)}_collectLineOrIntanceMeshesByIdxId(e,t,i,r,n){for(var a=r[t],s={buffer:e.getModelDescriptor().getReferencedMeshBufferById(t)},o=0,l=a.length;o<l;o++){var d=a[o];this._createNodeBufferByMpkBufferData(e,d,s);var h=this._getMaterialKeyByNodeInfo(d);n[h]||(n[h]=[]),n[h].push(d)}}_collectSharedMeshesByIdxId(e,t,i,r,n){for(var a=i[t].IndexInfos,s=0,o=a.length;s<o;s++){var l=r[a[s].meshId];if(l)for(var d={buffer:e.getModelDescriptor().getReferencedMeshBufferById(t),indexInfo:a[s]},h=0,c=l.length;h<c;h++){var u=l[h];this._createNodeBufferByMpkBufferData(e,u,d);var p=this._getMaterialKeyByNodeInfo(u);n[p]||(n[p]=[]),n[p].push(u)}}}_mergeMergeableMeshes(e,t,i,n){var a=Object.keys(t);if(0!==a.length){var s=this,o=e.getLoader().maxLoadTaskCount,l=a.length,d=e.progressPercentage.load,h=e.progressPercentage.collect,c=e.progressPercentage.merge,u=Math.ceil(l/e.progressFrequency);requestAnimationFrame(function p(m){var f=m;return function(){var m,g;for(g=f+u>l?l:f+u,m=f;m<g;m++)s._collectMergedGeometriesById(a[m],t,i),m===g-1&&(g!==l?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:o,loaded:(m/l*c+d+h)*o}}),requestAnimationFrame(p(m+1))):s._makeMeshNodes(e,n))}}(0))}else this._makeMeshNodes(e,n)}_dealDataMergeableMeshs(e,t,i,n,a){if(0!==t.mergeableIdxs.length){var s=this,o=this.mapMaterialIdToMergedNode,l={},d=t.mergedIdxs.length,h=t.mergeableIdxs.length,c=d+h,u=t.mergeableIdxs,p=e.getLoader().maxLoadTaskCount,m=e.progressPercentage.load,f=e.progressPercentage.collect,g=Math.ceil(h/e.progressFrequency);requestAnimationFrame(function t(v){var y=v;return function(){var v,M;for(M=y+g>h?h:y+g,v=y;v<M;v++)s._collectMergeableMeshesByIdxId(e,u[v],i,n,l),v===M-1&&(M!==h?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:p,loaded:((v+d)/c*f+m)*p}}),requestAnimationFrame(t(v+1))):(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:p,loaded:(f+m)*p}}),s._mergeMergeableMeshes(e,l,o,a)))}}(0))}else this._makeMeshNodes(e,a)}_collectDataMergedMeshesByIdxId(e,t,i,r,n){var a=t[e],s=a.IndexInfos;if(s&&0!==s.length){var o=!1;a.UV&&(a.UV.byteLength||a.UV.length)&&(o=!0),n.lightmap&&(a=this.getAttributeForLightmapWithDataMerged(a,n,e));for(var l=void 0,d=-1,h=0,c=s.length;h<c;h++){var u=i[s[h].meshId];if(u&&0!==u.length){if(null!=a.lightmapIdx){var p=s[h];p.positionStart=3*(d+1),p.uvStart=2*(d+1);for(var m=p.indexStart,f=p.indexCount+p.indexStart;m<f;m++)d=d<a.I[m]?a.I[m]:d;var g=d+1;p.positionCount=3*g-p.positionStart,p.uvCount=2*g-p.uvStart}l=s[h].meshId;for(var v=0,y=u.length;v<y;v++)u[v].uv=o,null!=a.lightmapIdx&&(u[v].lightmapIdx=a.lightmapIdx,u[v].materialId=u[v].materialId+"_"+u[v].lightmapIdx)}}if(void 0!==l){var M=i[l][0],E={},x=this._getMaterialKeyByNodeInfo(M);void 0===r[x]&&(r[x]=[]);for(m=0,f=s.length;m<f;m++)i[s[m].meshId]&&(void 0===E[(M=i[s[m].meshId][0]).userId]&&(E[M.userId]=[]),s[m].userId=M.userId,s[m].nodeId=M.nodeId,s[m].boundingBox=M.boundingBox,E[M.userId].push(s[m]));var _=new THREE.BufferGeometry;_._visible=!0,_.setIndex(new THREE.BufferAttribute(new Uint32Array(a.I),1)),_.setAttribute("position",new THREE.BufferAttribute(new Float32Array(a.P),3)),a.N&&(a.N.byteLength||a.N.length)&&_.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(a.N),3)),o&&_.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(a.UV),2)),a.UV2&&(_.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(a.UV2),2)),_.lightmapIdx=a.lightmapIdx),r[x].push({geometry:_,indices:E,matrix:a.mpkMatrix})}}}getAttributeForLightmapWithDataMerged(e,t,i){var r=[],n=new Uint32Array(e.I),a=t.getLoader().getUV2ById("bmpk_"+i,n.length);if(!a)return e;var s=a.lightmapIdx;r=a.uv2;for(var o=new Float32Array(e.P),l=new Float32Array(e.N),d=new Float32Array(e.UV),h=[],c=[],u=[],p=[],m=[],f=0,g=0;g<n.length;g++){var v=n[g];null==m[v]||r[2*m[v]]!=r[2*g]||r[2*m[v]+1]!=r[2*g+1]?(h.push(o[3*v]),h.push(o[3*v+1]),h.push(o[3*v+2]),l.length>0&&(c.push(l[3*v]),c.push(l[3*v+1]),c.push(l[3*v+2])),d.length>0&&(u.push(d[2*v]),u.push(d[2*v+1])),p.push(r[2*g]),p.push(r[2*g+1]),n[g]=f,f++,null==m[v]&&(m[v]=g)):n[g]=n[m[v]]}return o=null,l=null,d=null,r=null,m=null,{I:n,UV2:p,P:h,N:c,UV:u,lightmapIdx:s}}_dealDataMergedMeshs(e,t,i,n,a){if(0!==t.mergedIdxs.length){var s=this,o=this.mapMaterialIdToMergedNode,l=t.mergedIdxs,d=l.length,h=t.mergedIdxs.length+t.mergeableIdxs.length,c=e.getLoader().maxLoadTaskCount,u=e.progressPercentage.load,p=e.progressPercentage.collect,m=Math.ceil(d/e.progressFrequency);requestAnimationFrame(function t(f){var g=f;return function(){var f,v;for(v=g+m>d?d:g+m,f=g;f<v;f++)s._collectDataMergedMeshesByIdxId(l[f],i,n,o,e),f===v-1&&(v!==d?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:c,loaded:(f/h*p+u)*c}}),requestAnimationFrame(t(f+1))):(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:c,loaded:(f/h*p+u)*c}}),a&&a()))}}(0))}else a&&a()}_makeMeshNodes(e,t){var i=e.manager,n=e.databagId;let a=e.fileId;var s=e.getEncodedDatabagId(),o=this._getNodeGroup(e),l=this.mapMaterialIdToMergedNode;for(var d in l){var h=this.getPropertyValueByMaterialKey(d),c=l[d];if(e.lightmap){var u=h.materialId;e.materialManager.updateLightmapMaterial(u)}for(var p=0,m=c.length;p<m;p++){var f=c[p].geometry,g=c[p].indices;const t=c[p].matrix;var v=null;if("lines"===h.type)(v=new r.LineSegmentsEx(f)).databagId=n,v.fileId=a,t&&v.matrix.copy(t),v.matrixAutoUpdate=!1,v.updateMatrixWorld(!0);else{var y={databagId:n,fileId:a};(v=new r.MeshEx(f)).spawn(y),t&&v.matrix.copy(t)}r.GlobalData.EnableShadowMap&&(v.castShadow=e.castShadow,v.receiveShadow=e.receiveShadow),v._indicesGroup=g,o.add(v),c[p].mesh=v,i.addMeshToOctantMap(s,d,new r.BatchedCapsuleObject(d,v)),g=null,v=null}}o.updateMatrixWorld(!0),e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:e.getLoader().maxLoadTaskCount,loaded:e.getLoader().maxLoadTaskCount}}),t&&t()}createMeshNodes(e,t){e.getModelDescriptor().getStandardNodeInfos()?this._createGeometries(e,(function(){t&&t()})):t&&t()}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}getMeshNode(){return this.mapMaterialIdToMergedNode}_disposeMergedGeometries(){for(var e in this.mapMaterialIdToMergedNode){for(var t=this.mapMaterialIdToMergedNode[e],i=0,r=t.length;i<r;i++){t[i].geometry.dispose(),delete t[i].geometry,delete t[i].indices,t[i].mesh&&(t[i].mesh._indicesGroup=null,delete t[i].mesh)}delete this.mapMaterialIdToMergedNode[e]}}_getMaterialKeyByNodeInfo(e,t){var i=e.materialId;if(t){var n=t.manager.getOverrideMaterialByNodeInfo(e,t.materialManager.getMaterialById(e.materialId));n&&(i=n.name,e.materialId=i)}return r.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE?"lines":"meshes"])}getPropertyValueByMaterialKey(e){var t=r.Utils.splitCombinedKeyString(e);return{materialId:t[0],uvProp:t[1],type:t[2]}}clearSelectedObjectIds(){this.selectedObjectIds.length=0}cacheSelectedObjectIds(e,t,i){this.selectedObjectIds.push({uid:e,mKey:t,idx:i})}adjustVisibility(e,t){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}changeVisibilityOfSelectedObjects(e,t){if(t)for(n=0,a=this.selectedMeshes.length;n<a;n++)for(c=this.selectedMeshes[n].object,m=0,f=(u=this.selectedMeshes[n].indices).length;m<f;m++){(g=c.geometry.groups[u[m].idx]).start=u[m].start,g.count=u[m].count}else{this.selectedMeshes.length=0;for(var i={},n=0,a=this.selectedObjectIds.length;n<a;n++)i[this.selectedObjectIds[n].mKey+"&"+this.selectedObjectIds[n].idx]=!0;for(var s=Object.keys(i),n=0,a=s.length;n<a;n++){for(var o=s[n].split("&"),l=o[0],d=o[1],h=this.mapMaterialIdToMergedNode[l][d],c=h.mesh,u=[],p=h.geometry.groups,m=0,f=p.length;m<f;m++){var g;(g=p[m]).materialIndex===r.EnumElementState.SELECTED&&(u.push({idx:m,start:g.start,count:g.count}),g.start=0,g.count=0)}u.length&&this.selectedMeshes.push({object:c,indices:u})}}}changeVisibilityOfNonSelectedObjects(e,t){if(t)for(n=0,a=this.nonSelectedMeshes.length;n<a;n++){c=this.nonSelectedMeshes[n].object;if(u=this.nonSelectedMeshes[n].indices)for(d=0,h=u.length;d<h;d++){(m=c.geometry.groups[u[d].idx]).start=u[d].start,m.count=u[d].count}else c.visible=this.nonSelectedMeshes[n].visibility}else{this.nonSelectedMeshes.length=0;for(var i={},n=0,a=this.selectedObjectIds.length;n<a;n++){var s=this.selectedObjectIds[n];i[s.mKey]||(i[s.mKey]={}),i[s.mKey][s.idx]=!0}for(var o in this.mapMaterialIdToMergedNode){var l=this.mapMaterialIdToMergedNode[o];if(i[o])for(var d=0,h=l.length;d<h;d++){var c=l[d].mesh;if(i[o][d]){var u=[],p=c.geometry.groups;for(n=0,a=p.length;n<a;n++){var m;(m=p[n]).materialIndex!==r.EnumElementState.SELECTED&&(u.push({idx:n,start:m.start,count:m.count}),m.start=0,m.count=0)}u.length?this.nonSelectedMeshes.push({object:c,indices:u}):(this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1)}else this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1}else for(var n=0,a=l.length;n<a;n++){var c=l[n].mesh;this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1}}}}restoreVisibilityOfObjects(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}getBlinkMaterials(){return this.blinkMaterials}disposeBufferAfterVbo(){if(!this.bufferDestroyed){var e=0;for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],n=0,a=i.length;n<a;n++){var s=i[n],o=s.geometry;if(null!==o){e++;var l=t+"-"+n;this.mapDestroyedBufferKey[l]||s.mesh&&s.mesh.visible&&(this.mapDestroyedBufferKey[l]=!0,r.GlobalData.EnableSplitComponent?r.GeomUtil.disposeBufferFromGeometry(o,["normal","uv2"]):r.GeomUtil.disposeBufferFromGeometry(o,["normal","uv","uv2"]))}}Object.keys(this.mapDestroyedBufferKey).length===e&&(this.mapDestroyedBufferKey={},this.bufferDestroyed=!0)}}_traverseMeshNodeMap(e){for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],r=0,n=i.length;r<n;r++)e&&e(t,i[r])}getGeometryBuffersByUserId(e,t){var i=[],r=e.getDatabagId(),n=this;return this._traverseMeshNodeMap((function(e,a){var s=a.indices[t];if(s)for(var o=a.geometry,l=o.getIndex().array,d=o.getAttribute("position").array,h=o.getAttribute("uv"),c=h?h.array:null,u="lines"===n.getPropertyValueByMaterialKey(e).type,p=0,m=s.length;p<m;p++){var f=s[p],g=f.indexStart,v=f.indexStart+f.indexCount,y=l.slice(g,v),M=null;c&&(v=(g=f.positionStart/3*2)+f.positionCount/3*2,M=c.slice(g,v)),g=f.positionStart,v=f.positionStart+f.positionCount;var E=d.slice(g,v);g/=3,y.forEach((function(e,t,i){i[t]-=g})),i.push({isLines:u,databagId:r,nodeId:f.nodeId,position:E,index:y,uv:M,matrix:a.matrix})}})),i}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}}r.ModelView.BatchedMeshManager=e}(),r.ModelView.BatchedWireframeManager=class{constructor(e){this.manager=e,this.generated=!1,this.wireframeLineSegment=null,this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}destroy(){if(this.clearData(),this.manager=null,this.userIdMapForNoWireFrame=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.generated=!1,this.bufferDestroyed=!1,this.wireframeLineSegment&&(this.wireframeLineSegment._indicesGroup=null,this.wireframeLineSegment.geometry.dispose(),this.wireframeLineSegment=null),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}_createWireframeGeometry(e,t){if(this.wireframeGeometryMap||(this.wireframeGeometryMap={}),!this.wireframeGeometryMap[t.nodeId]){for(var i=e.attributes.position.array.slice(t.positionStart,t.positionStart+t.positionCount),n=e.getIndex().array.slice(t.indexStart,t.indexStart+t.indexCount),a=0,s=n.length;a<s;a++)n[a]-=t.positionStart/3;var o=r.BuildEdge(i,n),l=new THREE.BufferGeometry;l.setIndex(new THREE.Uint32BufferAttribute(o,1)),l.setAttribute("position",new THREE.BufferAttribute(Float32Array.from(i),3)),l._userId=t.userId,this.wireframeGeometryMap[t.nodeId]=l}}_createWireframeGeometries(e){var t=e.getFilter(),i=e.getModelDescriptor().getStandardNodeInfos();function r(e){var r=i[e];return r&&t.getWireFrameVisibilityCondition()?!!t._isRenderWithWireFrame(r[0]):!(r&&t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(r[0]))}var n=this.manager.getMeshNode();for(var a in n)if("meshes"===this.manager.getPropertyValueByMaterialKey(a).type)for(var s=n[a],o=0,l=s.length;o<l;o++){var d=s[o],h=d.geometry;if(null!==h){var c=d.indices;for(var u in c){r(u)||(this.userIdMapForNoWireFrame[u]=!0);for(var p=c[u],m=0,f=p.length;m<f;m++)this._createWireframeGeometry(h,p[m])}}}return!0}_makeWireframe(e){var t={},i=e.getWireframeMaterial();for(var n in this.wireframeGeometryMap){var a=this.wireframeGeometryMap[n],s=a._userId,o=new THREE.LineSegments(a,i);o.name=s,o.nodeId=s,t[s]||(t[s]=[]),t[s].push(o),o=null}var l=[];for(var s in t)for(var d=t[s],h=0,c=d.length;h<c;h++)l.push(d[h]);if(l.length>0){var u={},p=r.GeomUtil.mergeBufferGeometries(l,u);p&&(this.wireframeLineSegment=new THREE.LineSegments(p,e.getWireframeMaterial()),this.wireframeLineSegment._indicesGroup=u)}for(var s in l=null,t)delete t[s];t=null,this.wireframeGeometryMap=null}generateWireframe(e,t){this.generated||(this._createWireframeGeometries(e),this._makeWireframe(e),this.generated=!0,t&&t())}update(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegment){var t=this._getNodeGroup(e);t.clear(),t.add(this.wireframeLineSegment),t.updateMatrixWorld(!0)}}else e._hasNodeGroup(r.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(r.ObjectGroupType.WIREFRAME)}rebuildIndices(e){if(this.needDealWireframeLine(e)){this.wireframeLineSegment.visible=!0;var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;i.clearGroups();var r=e.getWireframeMaterial();this.wireframeLineSegment.material=r;var n=this.manager.getFilteredUserIdsForWireFrame(),a=!(!n||!Object.keys(n).length);if(this._existHiddenUserId()||a){var s,o,l=[],d=[];for(var h in t)if(!this._isHiddenUserId(h)){var c=t[h];if(c&&c.length>0){if(n[h]){var u=n[h],p=l.indexOf(u);for(-1===p&&(l.push(u),p=l.length-1),s=0,o=c.length;s<o;s++)d.push({indexStart:c[s].indexStart,indexCount:c[s].indexCount,state:1+p});continue}for(s=0,o=c.length;s<o;s++)d.push({indexStart:c[s].indexStart,indexCount:c[s].indexCount,state:0})}}if(0!==d.length){for(d.sort((function(e,t){return e.indexStart-t.indexStart})),s=0,o=d.length;s<o;s++){var m=d[s].indexStart,f=d[s].indexCount,g=d[s].state;if(0===s)i.addGroup(m,f,g);else{var v=d[s-1].indexStart,y=d[s-1].indexCount;g===d[s-1].state&&m===v+y?i.groups[i.groups.length-1].count+=f:i.addGroup(m,f,g)}}var M=e.getFilter(),E=[r];for(s=0,o=l.length;s<o;s++){var x=M._getMaterialByName(l[s]);E.push(x)}this.wireframeLineSegment.material=E}else this.wireframeLineSegment.visible=!1}}}explode(e){if(this.wireframeLineSegment){var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;for(var r in t){var n=t[r];if(n)for(var a=e.modelExplosion.getExplosionTranslation(r),s=0,o=n.length;s<o;s++){var l=n[s].indexStart;d(i,l,l+n[s].indexCount,a)}}}function d(e,t,i,r){for(var n=e.getAttribute("position").array,a=e.getIndex().array,s={},o=t;o<i;o++){var l=a[o];s[l]||(n[3*l]+=r.x,n[3*l+1]+=r.y,n[3*l+2]+=r.z,s[l]=!0)}e.getAttribute("position").needsUpdate=!0,s=null}}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})}needDealWireframeLine(e){return!(!e.isActivateWireframe()||!this.wireframeLineSegment)}adjustVisibility(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&this.wireframeLineSegment.visible&&(this.bufferDestroyed=!0,r.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["normal","uv","uv2"]))}_existHiddenUserId(){var e=this.manager.getHiddenUserIds();return!!(this.userIdMapForNoWireFrame&&Object.keys(this.userIdMapForNoWireFrame).length||e&&Object.keys(e).length)}_isHiddenUserId(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}getWireFrameLineSegments(){return this.wireframeLineSegment?[this.wireframeLineSegment]:null}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.BatchedManager=class{constructor(e,t){this.meshManager=new r.ModelView.BatchedMeshManager(this,t),this.wireframeManager=e?new r.ModelView.DataBatchedWireframeManager(this):new r.ModelView.BatchedWireframeManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}updateNodes(e){this.meshManager.update(e),this.wireframeManager.update(e)}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}asyncGenerateWireframe(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}rebuildIndices(e){this._rebuildIndices(e)}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}getMeshNode(){return this.meshManager.getMeshNode()}getPropertyValueByMaterialKey(e){return this.meshManager.getPropertyValueByMaterialKey(e)}getFilteredUserIds(){return this.mapMaterialIdToUserIdsForFilter}getSelectedUserIds(){return this.mapMaterialIdToUserIdsForSelection}getHoveredUserIds(){return this.mapMaterialIdToUserIdsForHover}getBlinkedUserIds(){return this.mapBlinkUserIds}getHiddenUserIds(){return this.hiddenUserIdSetObject}getTransparentUserIds(){return this.transparentUserIdSetObject}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;i=t||e.getModelDescriptor().getStandardUserIds();var r=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectFilteredUserIdsForWireFrame(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._rebuildIndices(e),this.updateNodes(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._rebuildIndices(e),this.updateNodes(e)}_collectFilteredUserIds(e,t,i){var n=e.getFilter(),a=n._hasHiddenFileIdFilter(),s=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),l=n._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.transparentUserIdSetObject={},a||s||o||l||d||h)for(var u=0;u<t.length;++u){var p=t[u],m=i[p];if(m&&m.length)for(var f=0,g=m.length;f<g;f++){var v=m[f];a&&n._isHiddenFileId(v)||s&&!1===n._isVisible(v)||e.isReplacedUserId(p)||e.isHiddenSourceObjectUserId(p)?(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.HIDDEN]&&(c[v.materialId][r.EnumElementState.HIDDEN]={}),c[v.materialId][r.EnumElementState.HIDDEN][p]=!0,this.hiddenUserIdSetObject[p]=!0):l&&n._isTransparent(v)?(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.TRANSPARENT]&&(c[v.materialId][r.EnumElementState.TRANSPARENT]={}),c[v.materialId][r.EnumElementState.TRANSPARENT][p]=!0,this.transparentUserIdSetObject[p]=!0):o&&n._hasOverrideMaterial(v)&&n._getOverrideMaterials(v).forEach((e=>{let t=String(v.nodeId);if(e.nodeIds){if(e.nodeIds.includes(t)){let t=null!=e?e.name:"";""!==t&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.OVERRIDED]&&(c[v.materialId][r.EnumElementState.OVERRIDED]={}),c[v.materialId][r.EnumElementState.OVERRIDED][p]=t)}}else{let t=null!=e?e.name:"";""!==t&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.EnumElementState.OVERRIDED]&&(c[v.materialId][r.EnumElementState.OVERRIDED]={}),c[v.materialId][r.EnumElementState.OVERRIDED][p]=t)}}))}}}_collectFilteredUserIdsForWireFrame(e,t,i){var r=e.getFilter(),n=r._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},n)for(var a=0;a<t.length;++a){var s=t[a];if(!this.hiddenUserIdSetObject[s]){var o=i[s];if(o&&o.length)for(var l=0,d=o.length;l<d;l++){var h=o[l];if(r._hasOverrideMaterialForWireFrame(h)){var c=r._getOverrideMaterialForWireFrame(h),u=null!=c?c.name:"";""!==u&&(this.mapFilteredUserIdsForWireFrame[s]=u)}}}}}_clearFilteredState(){this.mapMaterialIdToUserIdsForFilter=null}_collectSelectedUserIds(e,t){var i=this.mapMaterialIdToUserIdsForSelection={};for(var r in e){var n=t[r];if(n&&n.length)for(var a=0,s=n.length;a<s;a++)void 0===i[n[a].materialId]&&(i[n[a].materialId]={}),void 0===i[n[a].materialId][r]&&(i[n[a].materialId][r]=!0)}}_clearSelectedState(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}_collectHoveredUserIds(e,t){var i=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var r=t[e],n=0,a=r.length;n<a;n++)void 0===i[r[n].materialId]&&(i[r[n].materialId]={}),void 0===i[r[n].materialId][e]&&(i[r[n].materialId][e]=!0)}_clearHoveredState(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}_collectBlinkedUserIds(e,t){var i=this.mapBlinkUserIds={};for(var r in e){var n=t[r];if(n&&n.length)for(var a=0,s=n.length;a<s;a++)void 0===i[n[a].materialId]&&(i[n[a].materialId]={}),void 0===i[n[a].materialId][r]&&(i[n[a].materialId][r]=!0)}}calculateClippingIds(e,t,i,r){this.meshManager.calculateClippingIds(e,t,i,r)}calculateClippingContours(e,t,i,r,n,a){this.meshManager.calculateClippingContours(e,t,i,r,n,a)}_clearBlinkedState(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}_rebuildIndices(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}clearCachedData(){this.meshManager.clearAllNodeBuffer()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}isPickableNode(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var i=this.getTransparentUserIds();return!i||!i[e]}isHiddenNode(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}getFilteredUserIdsForWireFrame(){return this.mapFilteredUserIdsForWireFrame}},function(){class e extends r.ModelView.BatchedBaseHandler{constructor(e,t){super(e),this.defaultManager=new r.ModelView.BatchedManager(t),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.BatchedLoader(this)}}r.ModelView.BatchedHandler=e}(),function(){class e extends r.ModelView.BaseLoader{constructor(e,t){super(e),this.version=t,this.descriptor=null,this.enableBmpkMerged=!1,this.bmpkPkgIndex=null}praseBmpkPkgIndex(e){var t=this,i=this.url,n=this.fileLoader;t.bmpkPkgIndex={};const a=i.bmpkPkgIndexUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",a,(()=>new Promise(((e,t)=>{n.setResponseType("json"),n.load(a,e,void 0,t)}))),(i=>{for(var r in i.bmpks){var n=i.bmpks[r],a=parseInt(r.substring(5,r.length));for(var s in t.bmpkPkgIndex[a]={},n)t.bmpkPkgIndex[a][s]=n[s]}t._loadAllMpks(e)}))}loadSceneAndMpks(e){var t=this;e.bmpk_merged&&(t.enableBmpkMerged=!0),t.url.mpkUrl=t.url.bmpkUrl,e.symbol?this._loadSymbol((function(){t._loadScene(0)})):t._loadScene(0),t._loadBMpkIndex(),e.lines&&t._loadLine(),e.bmpks&&(t.enableBmpkMerged?t.praseBmpkPkgIndex(e.bmpks):t._loadAllMpks(e.bmpks)),r.GlobalData.BorderLineDelayLoaded||t._loadAllBorderlines(e)}getSceneTaskCount(e){var t=2;return t+=e.symbol,t+=e.lines,t+=e.bmpks,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}_loadBMpkIndex(){var e=this,t=this.url,i=this.fileLoader;const n=t.bmpkIndexUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",n,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(n,e,void 0,t)}))),(t=>{e._paserBMeshId(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()}))}_paserBMeshId(e){this.descriptor.bmeshIdReader=new r.Loader.BMeshIdReader(e)}_parseReferencedMeshBufferData(e,t,i,n,a,s){var o=[],l=this.model.getVersion();r.Compatibility.isUseMergeTextureOptimize(l)||a&&i>0&&(s=e.hasUV(t));for(var d=void 0!==s?!s:void 0,h=t;h<i;++h){var c=e.getOffsetIndexInfo(h,d);c&&o.push(c)}var u=o.length,p=4*o[0].positionStart,m=4*(o[u-1].positionStart+o[u-1].positionCount),f=e.vBuffer.slice(p,m),g=4*o[0].indexStart,v=4*(o[u-1].indexStart+o[u-1].indexCount),y=e.iBuffer.slice(g,v);if(a){var M=new Uint32Array(y),E=o[0].positionStart/3;M.forEach((function(e,t,i){i[t]-=E})),y=M}var x,_=e.getMeshData(t).nOffset,b=e.getMeshData(i-1).nOffset+3*e.getMeshData(i-1).ptCount*4,I=e.nBuffer.slice(_,b);if(d)x=null;else if(a){var T=4*o[0].uvStart,S=4*(o[u-1].uvStart+o[u-1].uvCount);x=e.tBuffer.slice(T,S)}else x=e.tBuffer.slice();var C=o[0].positionStart,w=o[0].indexStart,R=o[0].uvStart;if(0!=C)for(h=0;h<u;++h)o[h].positionStart-=C,o[h].indexStart-=w,o[h].uvStart-=R;this.descriptor.cacheReferencedMeshBufferData(n,{P:f,I:y,N:I,UV:x,IndexInfos:o,mpkMatrix:e.getMatrix()})}_parseMpk(e,t){var i=new r.Loader.BMPKReader(e,this.version),n=this;if(n.enableBmpkMerged){var a=65536*t;if(t in n.bmpkPkgIndex){var s=Object.keys(n.bmpkPkgIndex[t]).length;if(1===s)n._parseReferencedMeshBufferData(i,0,i.header.meshCount,a);else{for(var o,l=n.bmpkPkgIndex[t],d=0,h=1;h<=s-1;h++){var c=l[h].mesh_index;if(d!==c){var u=a+d;o=l[h-1].texture,n._parseReferencedMeshBufferData(i,d,c,u,!0,o),d=c}}d=l[s-1].mesh_index,o=l[s-1].texture;u=a+d;n._parseReferencedMeshBufferData(i,d,i.header.meshCount,u,!0,o)}}else n._parseReferencedMeshBufferData(i,0,i.header.meshCount,a)}else n._parseReferencedMeshBufferData(i,0,i.header.meshCount,t);i=null}}r.ModelView.DataBatchedBaseLoader=e}(),function(){class e extends r.ModelView.DataBatchedBaseLoader{constructor(e,t){super(e,t),this.descriptor=new r.ModelView.DataBatchedDescriptor}}r.ModelView.DataBatchedLoader=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super(),this.bmeshIdReader=null}destroy(){super.destroy(),this.bmeshIdReader=null}convertGeometryId(e){var t=this.bmeshIdReader.getBMeshId(e);return void 0===t&&(t=e),t}}r.ModelView.DataBatchedDescriptor=e}(),r.ModelView.DataBatchedWireframeManager=class{constructor(e){this.manager=e,this.generated=!1,this.wireframeLineSegments=[],this.parameterizedShapeWireframeBufferMap={},this.userIdMapForNoWireFrame={},this.processedThresholdPerShared=1e3,this.splitSegmentEnabled=!0,this.splitCountPerSegment=1e4}destroy(){this.manager=null,this.userIdMapForNoWireFrame=null;for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;if(this.wireframeLineSegments=null,this.pickingNodeGenerators){for(var i in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(i)&&this.pickingNodeGenerators[i].destroy();this.pickingNodeGenerators=null}this.parameterizedShapeWireframeBufferMap=null}clearData(){this.generated=!1,this.userIdMapForNoWireFrame={};for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;if(this.wireframeLineSegments=[],this.pickingNodeGenerators)for(var i in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(i)&&this.pickingNodeGenerators[i].clearData()}_needWireframing(e,t){var i=e.getFilter(),r=e.getModelDescriptor().getStandardNodeInfos();return!(!r||!r[t.userId]||(i.getWireFrameVisibilityCondition()?!i._isRenderWithWireFrame(t):i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(t)))}_getWireframeBufferByIdForParameterizedShape(e,t){var i=this.parameterizedShapeWireframeBufferMap;if(i[e])return i[e];i[e]=[];for(var n=0,a=t.length;n<a;n++){var s=t[n];i[e].push({index:r.BuildEdge(s.attributes.position.array,s.index.array),position:s.attributes.position.array})}return i[e]}_dealWireframesForParameterizedShape(e){if(!r.GlobalData.Instance){for(var t=e.getModelDescriptor().getNodeInfosWithParameterizedDesc(),i={},n=e.getWireframeMaterial(),a=Object.keys(t),s=0,o=a.length;s<o;s++)for(var l=t[a[s]],d=0,h=l.length;d<h;d++){var c=l[d];this._needWireframing(e,c)||(this.userIdMapForNoWireFrame[c.userId]=!0);var u=this.manager.meshManager.getGeometryByNodeInfo(e,c);u instanceof Array||(u=[u]);for(var p=this._getWireframeBufferByIdForParameterizedShape(c.geometryId,u),m=0,f=p.length;m<f;m++){var g=p[m].index,v=p[m].position.slice();r.GeomUtil.applyMatrix4ToBuffer(c.matrix,v);var y=new THREE.BufferGeometry;y.setIndex(new THREE.Uint32BufferAttribute(g,1)),y.setAttribute("position",new THREE.BufferAttribute(v,3));var M=new THREE.LineSegments(y,n);M.name=c.userId,M.nodeId=c.userId,M.materialId=c.materialId,i[c.userId]||(i[c.userId]=[]),i[c.userId].push(M)}}var E=[];for(var x in i)for(var _=i[x],b=(m=0,_.length);m<b;m++)E.push(_[m]);if(E.length>0){var I={},T=r.GeomUtil.mergeBufferGeometries(E,I);if(T){var S=new THREE.LineSegments(T,n);S._indicesGroup=I,this.wireframeLineSegments.push(S)}}}}_dealSharedBorderLines(e){const t=e._config.metadata.version;var i=e.getModelDescriptor().getSharedBorderLineCache();if(i){for(var n=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),a={},s=e.getWireframeMaterial(),o=this.processedThresholdPerShared,l=0,d=i.length;l<d;l++)for(var h=i[l],c=h.IndexInfos,u=0,p=c.length;u<p;u++){var m=c[u],f=n[e.getModelDescriptor().convertGeometryId(m.meshId)];if(f&&!(f.length>o)){var g=new Uint32Array(h.I),v=new Float32Array(h.P);r.Compatibility.isUseDoubleMatrixMPKHeader(t);for(var y=0,M=f.length;y<M;y++){var E=f[y];this._needWireframing(e,E)||(this.userIdMapForNoWireFrame[E.userId]=!0);var x=v.slice(m.positionStart,m.positionStart+m.positionCount),_=m.positionStart/3,b=g.slice(m.indexStart,m.indexStart+m.indexCount);b.forEach((function(e,t,i){i[t]-=_})),r.GeomUtil.applyMatrix4ToBuffer(E.matrix,x);var I=new THREE.BufferGeometry;I.setIndex(new THREE.Uint32BufferAttribute(b,1)),I.setAttribute("position",new THREE.BufferAttribute(x,3));var T=new THREE.LineSegments(I,s);T.name=E.userId,T.nodeId=E.userId,T.materialId=E.materialId,a[E.userId]||(a[E.userId]=[]),a[E.userId].push(T)}}}var S=[];for(var C in a)for(var w=a[C],R=(u=0,w.length);u<R;u++)S.push(w[u]);if(!(S.length<1))if(this.splitSegmentEnabled){var B=this.splitCountPerSegment,A=Math.floor(S.length/B),P=S.length%B;for(u=0;u<A;u++){var L=S.slice(u*B,(u+1)*B),O={};if(N=r.GeomUtil.mergeBufferGeometries(L,O)){var D=new THREE.LineSegments(N,s);r.Compatibility.isUseDoubleMatrixMPKHeader(t),D._indicesGroup=O,this.wireframeLineSegments.push(D)}}P&&(L=S.slice(A*B,A*B+P),O={},(N=r.GeomUtil.mergeBufferGeometries(L,O))&&(D=new THREE.LineSegments(N,s),r.Compatibility.isUseDoubleMatrixMPKHeader(t),D._indicesGroup=O,this.wireframeLineSegments.push(D)))}else{var N;O={},(N=r.GeomUtil.mergeBufferGeometries(S,O))&&((D=new THREE.LineSegments(N,s))._indicesGroup=O,this.wireframeLineSegments.push(D))}}}_dealUniqueBorderLines(e){var t=e.getModelDescriptor().getUniqueBorderLineCache();if(t)for(var i=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),r={},n=0,a=t.length;n<a;n++){for(var s=t[n],o=s.IndexInfos,l=0,d=o.length;l<d;l++){var h=o[l],c=i[e.getModelDescriptor().convertGeometryId(h.meshId)];if(c)for(var u=0,p=c.length;u<p;u++){var m,f,g=c[u];r[g.userId]||(r[g.userId]=[]),this._needWireframing(e,g)||(this.userIdMapForNoWireFrame[g.userId]=!0),m=h.indexStart,f=h.indexCount,r[g.userId].push({nodeId:g.nodeId,indexStart:m,indexCount:f,materialId:g.materialId})}}var v=new THREE.BufferGeometry;v.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(s.I),1)),v.setAttribute("position",new THREE.BufferAttribute(new Float32Array(s.P),3));var y=new THREE.LineSegments(v,e.getWireframeMaterial());y._indicesGroup=r,s.mpkMatrix&&y.matrix.copy(s.mpkMatrix),y.matrixAutoUpdate=!1,y.updateMatrixWorld(!0),this.wireframeLineSegments.push(y)}}_createWireframeGeometries(e){this._dealWireframesForParameterizedShape(e),this._dealUniqueBorderLines(e),this._dealSharedBorderLines(e)}generateWireframe(e,t){e.isActivateWireframe()&&(this.generated||(this._createWireframeGeometries(e),this.generated=!0))}_asyncDealSharedBorderLines(e,t){var i=e.getModelDescriptor().getSharedBorderLineCache();if(i)for(var n=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),a={},s=e.getWireframeMaterial(),o=i.length,l=0,d=this,h=0;h<o;h++){var c=i[h];r.Utils.asyncProcess(c,c.IndexInfos.length,10,(function(t,i){var o=t,l=o.IndexInfos[i],h=e.getModelDescriptor().convertGeometryId(l.meshId),c=n[h];if(c)for(var u=new Uint32Array(o.I),p=new Float32Array(o.P),m=0,f=c.length;m<f;m++){var g=c[m];d._needWireframing(e,g)||(d.userIdMapForNoWireFrame[g.userId]=!0);var v=p.slice(l.positionStart,l.positionStart+l.positionCount),y=l.positionStart/3,M=u.slice(l.indexStart,l.indexStart+l.indexCount);M.forEach((function(e,t,i){i[t]-=y})),r.GeomUtil.applyMatrix4ToBuffer(g.matrix,v);var E=new THREE.BufferGeometry;E.setIndex(new THREE.Uint32BufferAttribute(M,1)),E.setAttribute("position",new THREE.BufferAttribute(v,3));var x=new THREE.LineSegments(E,s);x.name=g.userId,x.nodeId=g.userId,a[g.userId]||(a[g.userId]=[]),a[g.userId].push(x)}}),(function(){if(++l===o){var e=[];for(var i in a)for(var n=a[i],h=0,c=n.length;h<c;h++)e.push(n[h]);if(e.length>0){var u={},p=r.GeomUtil.mergeBufferGeometries(e,u);if(p){var m=new THREE.LineSegments(p,s);m._indicesGroup=u,d.wireframeLineSegments.push(m)}}t&&t()}}))}else t&&t()}_asyncDealUniqueBorderLines(e,t){var i=e.getModelDescriptor().getUniqueBorderLineCache();if(i)for(var n=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),a={},s=this,o=0,l=i.length,d=0;d<l;d++){var h=i[d];r.Utils.asyncProcess(h,h.IndexInfos.length,10,(function(t,i){var r=t.IndexInfos[i],o=e.getModelDescriptor().convertGeometryId(r.meshId),l=n[o];if(l)for(var d=0,h=l.length;d<h;d++){var c,u,p=l[d];a[p.userId]||(a[p.userId]=[]),s._needWireframing(e,p)||(s.userIdMapForNoWireFrame[p.userId]=!0),c=r.indexStart,u=r.indexCount,a[p.userId].push({nodeId:p.nodeId,indexStart:c,indexCount:u})}}),(function(i){o++;var r=i,n=new THREE.BufferGeometry;n.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(r.I),1)),n.setAttribute("position",new THREE.BufferAttribute(new Float32Array(r.P),3));var d=new THREE.LineSegments(n,e.getWireframeMaterial());d._indicesGroup=a,s.wireframeLineSegments.push(d),o===l&&t&&t()}))}else t&&t()}_asyncCreateWireframeGeometries(e,t){var i=this;this._dealWireframesForParameterizedShape(e),this._asyncDealUniqueBorderLines(e,(function(){i._asyncDealSharedBorderLines(e,(function(){t&&t()}))}))}asyncGenerateWireframe(e,t){e.isActivateWireframe()&&(this.generated||(this._asyncCreateWireframeGeometries(e,t),this.generated=!0))}update(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegments.length){var t=this._getNodeGroup(e);t.clear();for(var i=0,n=this.wireframeLineSegments.length;i<n;i++)t.add(this.wireframeLineSegments[i]);t.updateMatrixWorld(!0)}}else e._hasNodeGroup(r.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(r.ObjectGroupType.WIREFRAME)}rebuildIndicesForLineSegment(e,t){t.visible=!0;var i=t._indicesGroup,r=t.geometry;r.clearGroups();var n=e.getWireframeMaterial();t.material=n;var a,s,o=this.manager.getFilteredUserIdsForWireFrame(),l=null;(E=e.getFilter())&&(l=E.getLocalClippingList());var d=[],h=[];for(var c in i)if(!this._isHiddenUserId(c)){var u=i[c];if(u&&u.length>0){if(l&&l.get(c)){var p="localClipping|"+c;o&&o[c]&&(p+="|override|"+o[c]),d.push(p);var m=d.length-1;for(a=0,s=u.length;a<s;a++)h.push({indexStart:u[a].indexStart,indexCount:u[a].indexCount,state:1+m});continue}if(o&&o[c]){for(p=o[c],-1===(m=d.indexOf(p))&&(d.push(p),m=d.length-1),a=0,s=u.length;a<s;a++)h.push({indexStart:u[a].indexStart,indexCount:u[a].indexCount,state:1+m});continue}for(a=0,s=u.length;a<s;a++)h.push({indexStart:u[a].indexStart,indexCount:u[a].indexCount,state:0})}}if(0!==h.length){for(h.sort((function(e,t){return e.indexStart-t.indexStart})),a=0,s=h.length;a<s;a++){var f=h[a].indexStart,g=h[a].indexCount,v=h[a].state;if(0===a)r.addGroup(f,g,v);else{var y=h[a-1].indexStart,M=h[a-1].indexCount;v===h[a-1].state&&f===y+M?r.groups[r.groups.length-1].count+=g:r.addGroup(f,g,v)}}var E=e.getFilter(),x=[n];for(a=0,s=d.length;a<s;a++){var _,b=d[a].split("|");if("localClipping"==b[0]){var I=l.get(b[1]).wireframeMaterialName,T=E.getMaterialForClipBy(I);if(b[2]&&"override"==b[2]){var S=I+b[2]+b[3];_=E.getMaterialForClipBy(S,T);var C=E._getMaterialByName(b[3]);_.copy(C)}else _=T;_.clippingPlanes=T.clippingPlanes}else _=E._getMaterialByName(d[a]);x.push(_)}t.material=x}else t.visible=!1}rebuildIndices(e){if(this.needDealWireframeLine(e))for(var t=0,i=this.wireframeLineSegments.length;t<i;t++)this.rebuildIndicesForLineSegment(e,this.wireframeLineSegments[t])}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})}needDealWireframeLine(e){return!!(e.isActivateWireframe()&&this.wireframeLineSegments&&this.wireframeLineSegments.length)}adjustVisibility(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&(this.bufferDestroyed=!0,r.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["position","normal","uv","uv2"]))}explode(e){for(var t=0,i=this.wireframeLineSegments.length;t<i;t++){function u(e,t,i,r){for(var n=e.getAttribute("position").array,a=e.getIndex().array,s={},o=t;o<i;o++){var l=a[o];s[l]||(n[3*l]+=r.x,n[3*l+1]+=r.y,n[3*l+2]+=r.z,s[l]=!0)}e.getAttribute("position").needsUpdate=!0,s=null}var r=this.wireframeLineSegments[t],n=r._indicesGroup,a=r.geometry;for(var s in n){var o=n[s];if(o)for(var l=e.modelExplosion.getExplosionTranslation(s),d=0,h=o.length;d<h;d++){var c=o[d].indexStart;u(a,c,c+o[d].indexCount,l)}}a.computeBoundingSphere()}}_isHiddenUserId(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}getWireFrameLineSegments(){return this.wireframeLineSegments}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="merge_data",this.defaultManager=null,this.instancedManager=null,this.loader=null}prepare(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(this.model,t),!this.model.lightmap||this.model.enableLightmap==r.GlobalData.EnableLightmap&&this.model.lightmapIntensity==r.GlobalData.LightmapIntensity&&i==r.GlobalData.EnableTextureMapping||(this.model.enableLightmap=r.GlobalData.EnableLightmap,this.model.lightmapIntensity=r.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){const t=this,i=this.model;if(r.GlobalData.InstanceAsyncProcessing){const r=this.loader.getDescriptor();this.instancedManager.asyncCreateMeshNodes(i,r.getInstancedUserIds(),(()=>{this.defaultManager.createMeshNodes(i,(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}))}else this.instancedManager.createMeshNodes(i),this.defaultManager.createMeshNodes(i,(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}clearCachedData(e){e.getModelDescriptor().destroyReader(),e.getModelDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}r.ModelView.DataBatchedBaseHandler=e}(),function(){class e extends r.ModelView.DataBatchedBaseHandler{constructor(e,t){super(e);const{useDataWireframe:i,version:n}=t;this.defaultManager=new r.ModelView.BatchedManager(i,n),this.instancedManager=new r.ModelView.InstancedManager(n),this.loader=new r.ModelView.DataBatchedLoader(this,n)}}r.ModelView.DataBatchedHandler=e}(),r.ModelView.LayerBaseProvider=class{constructor(e){this.model=e,this.conditionsChanged=!0,this.nodeInfosWithLayerKey={},this.cachedLayerData={},this.cacheAttributes=null,this.cacheSpecialtysLevels={},this.mapLayerKeys={},this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.lastUsedLayerData=null,this.mapNeededConditions=null}destroy(){this.cachedLayerData=null,this.nodeInfosWithLayerKey=null,this.cacheAttributes=null,this.cacheSpecialtysLevels=null,this.mapLayerKeys=null,this.lastUsedLayerData=null,this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.mapNeededConditions=null,this.lastLayerKeyMap=null,this.cachedLayerKeys=null}clearData(){}loadLayerDataByIdxs(e,t,i,r){}dealLayerDataLoading(e,t,i,r,n){}loadMpkOnDemand(e,t,i,r,n){var a=e?this.getAllLayerIdxData():this.getUsedLayerIdxData();this.dealLayerDataLoading(this.getLayerIdxInfoByLayerData(a),t,i,r,n)}getUsedIdxsInfoFrom(e,t){var i,n={},a={},s={},o={};if(e&&e.length)for(var l=0,d=e.length;l<d;++l)n[i=e[l]]=!0;if(t)if(r.Utils.isEmptyObject(n))s=t;else{for(i in t)n[i]&&(o[i]=!0);if(r.Utils.isEmptyObject(o))a=n,s=t;else{for(i in t)o[i]||(s[i]=!0);for(i in n)o[i]||(a[i]=!0)}}else r.Utils.isEmptyObject(n)||(a=n);return{objCurrUsedIdxs:n,addIdxs:Object.keys(a),removeIdxs:Object.keys(s)}}getLayerIdxInfoByLayerData(e){var t,i;e?(t=e.layerIds,i=e.mpkIdxs):(t=null,i=null);var r=this.getUsedIdxsInfoFrom(t,this.lastUsedLayerIdsObject);this.lastUsedLayerIdsObject=r.objCurrUsedIdxs;var n=this.getUsedIdxsInfoFrom(i,this.lastUsedMpkIdxsObject);return this.lastUsedMpkIdxsObject=n.objCurrUsedIdxs,{layerScene:r,mpk:n}}getUsedLayerIdxData(){if(!this.isConditionsChanged()&&this.lastUsedLayerData)return this.lastUsedLayerData;this.setConditionsChanged(!1);var e=this.getConditionsOnDemand();if(!e)return this.lastUsedLayerData=null,null;var t=this.getCachedLayerData(),i=[],r=[],n=[],a=[];for(var s in e)if(t[s]){for(var o=t[s].mpkIdxs,l=0,d=o.length;l<d;++l)n.push(o[l]);i.push(s),r.push(t[s].layerId),a.push(t[s].boundingBox)}return this.lastUsedLayerData={layerIds:r,layerKeys:i,boundingBoxes:a,mpkIdxs:n},this.lastUsedLayerData}getAllLayerIdxData(){this.setConditionsChanged(!1);var e=this.getCachedLayerData();if(!e)return null;var t=[],i=[],r=[],n=[];for(var a in e){for(var s=e[a].mpkIdxs,o=0,l=s.length;o<l;++o)r.push(s[o]);t.push(a),i.push(e[a].layerId),n.push(e[a].boundingBox)}return{layerIds:i,layerKeys:t,boundingBoxes:n,mpkIdxs:r}}getUserIdsOnDemand(){var e={},t=this.nodeInfosWithLayerKey,i=this.getConditionsOnDemand();if(i){for(var r in i)if(s=t[r])for(var n=0,a=s.length;n<a;n++)e[s[n].userId]=!0}else for(var r in t){var s;if(s=t[r])for(n=0,a=s.length;n<a;n++)e[s[n].userId]=!0}return e}cacheLayerData(e,t){this.cachedLayerData[e]=t}getCachedLayerData(){return this.cachedLayerData}getCachedLayerKeys(){if(this.cachedLayerKeys)return this.cachedLayerKeys;this.cachedLayerKeys={};var e=this.getCachedLayerData();for(var t in e)e.hasOwnProperty(t)&&(this.cachedLayerKeys[t]=!0);return this.cachedLayerKeys}clearNodeInfoCacheWithLayerKey(){this.nodeInfosWithLayerKey={}}cacheNodeInfoByLayerKey(e,t){this.nodeInfosWithLayerKey[e]||(this.nodeInfosWithLayerKey[e]=[]),this.nodeInfosWithLayerKey[e].push(t)}cacheNodeInfosWithLayerKey(){var e=this.model.getModelDescriptor().getAllNodeInfos();for(var t in e)for(var i=e[t],r=0,n=i.length;r<n;r++){var a=i[r],s=this.formatLayerIds(a.userData);this.cacheNodeInfoByLayerKey(s[0],a)}}cacheLayerKeys(e){this.mapLayerKeys=e;var t={},i=this.getLayerKeyAttributes();for(var r in e){var n=e[r],a=n[i[0]],s=n[i[1]];t.hasOwnProperty(a)||(t[a]=[]),t.hasOwnProperty(s)||(t[s]=[]),t[a].push(s),t[s].push(a)}this.cacheSpecialtysLevels=t}getLayerKeyAttributes(){if(this.cacheAttributes)return this.cacheAttributes;var e=[],t=Object.keys(this.mapLayerKeys)[0],i=this.mapLayerKeys[t];for(var r in i)i.hasOwnProperty(r)&&e.push(r);return this.cacheAttributes=e,this.cacheAttributes}formatLayerIds(e){var t=[];if(!e)return t.push("unknown"),t;var i=this.getLayerKeyAttributes(),r=e[i[0]],n=e[i[1]];if(e.hasOwnProperty(i[0])&&e.hasOwnProperty(i[1]))if(r instanceof Array&&n instanceof Array)for(var a=0;a<r.length;a++)for(var s=0;s<n.length;s++){var o=r[a]+"-"+n[s];t.push(o)}else if(r instanceof Array)for(s=0;s<r.length;s++)o=r[s]+"-"+n,t.push(o);else if(n instanceof Array)for(s=0;s<n.length;s++)o=r+"-"+n[s],t.push(o);else o=r+"-"+n,t.push(o);else if(e.hasOwnProperty(i[0]))if(e.hasOwnProperty(i[1]))t.push("unknown"),console.warn("Object has no "+i[0]+" and "+i[1]);else if(r instanceof Array)for(s=0;s<r.length;s++)for(l=r[s],d=this.getLevelsOrSpecialtys(l),a=0;a<d.length;a++)o=l+"-"+d[a],t.push(o);else for(l=r,d=this.getLevelsOrSpecialtys(l),a=0;a<d.length;a++)o=l+"-"+d[a],t.push(o);else if(n instanceof Array)for(var s=0;s<n.length;s++)for(var l=n[s],d=this.getLevelsOrSpecialtys(l),a=0;a<d.length;a++)o=d[a]+"-"+l,t.push(o);else for(var l=n,d=this.getLevelsOrSpecialtys(l),a=0;a<d.length;a++)o=d[a]+"-"+l,t.push(o);return t}getLevelsOrSpecialtys(e){return this.cacheSpecialtysLevels.hasOwnProperty(e)?this.cacheSpecialtysLevels[e]:(console.warn("Attribute "+e+"has no according levels or specialtys."),[])}getUnionBoundingBoxOnDemand(){var e=this.getBoundingBoxesOnDemand();if(e&&e.length>0){for(var t=new THREE.Box3,i=0,r=e.length;i<r;++i)t.union(e[i]);return t}return null}getBoundingBoxesOnDemand(){var e=this.getUsedLayerIdxData();return e?e.boundingBoxes:null}setConditionsOnDemandLoad(e){var t={};if(e&&e instanceof Array){t={};for(var i=0,r=e.length;i<r;i++)for(var n=e[i],a=this.formatLayerIds(n),s=0;s<a.length;s++)t.hasOwnProperty(a[s])||(t[a[s]]=!0)}else t=this.getCachedLayerKeys();var o=this._isLayerKeysChanged(t);return o&&(this.mapNeededConditions=t,this.setConditionsChanged(!0)),o}_isLayerKeysChanged(e){var t=!1;if(void 0!==this.lastLayerKeyMap){var i=Object.keys(this.lastLayerKeyMap),r=Object.keys(e);if(i.length!==r.length)t=!0;else for(var n=0,a=r.length;n<a;n++){var s=r[n];if(void 0===this.lastLayerKeyMap[s]){t=!0;break}}}else t=!0;return t&&(this.lastLayerKeyMap=e),t}setConditionsChanged(e){this.conditionsChanged=e}getConditionsOnDemand(){return this.mapNeededConditions}isConditionsChanged(){return this.conditionsChanged}},function(){class e extends r.ModelView.BaseLoader{constructor(e,t){super(e,t),this._loadingOnDemand=!1}loadMpkOnDemand(e,t,i){for(var r=0,n=e.length;r<n;++r)this.mpkTaskManager.addTask(e[r]);var a=this;this.mpkTaskManager.processTasks(this._loadMpk.bind(this),t,(function(){a._loadingOnDemand=!1,i&&i()}))}resetProcessState(e){this.loadTaskCount=0,this.maxLoadTaskCount=e,this._loadingOnDemand=!0}dealProgressSegment(e,t){return r.GlobalData.BatchMergeEnabled&&this._loadingOnDemand?t*e.progressPercentage.load:t}_loadLayerKey(){var e=this,t=this.fileLoader,i=this.url,n=this.model,a=this.handler.getLayerProvider();const s=i.layerKeyUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",s,(()=>new Promise(((e,i)=>{t.setResponseType(""),t.load(s,e,void 0,i)}))),(t=>{var i=new r.Loader.LayerKeyReader(t),n=[],s=i.getData();a.cacheLayerKeys(s);for(var o=0,l=i.getCount();o<l;++o){var d=i.getLayerKey(o),h=a.formatLayerIds(d);n.push(h[0])}e._loadLayer(n)}),(t=>{n.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),e._onTaskFinished()}))}_loadLayer(e){var t=this,i=this.fileLoader,n=this.url,a=this.model,s=this.handler.getLayerProvider();const o=n.layerUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",o,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(o,e,void 0,t)}))),(i=>{for(var n=new r.Loader.LayerReader(i),a=0,o=n.getLayerCount();a<o;++a)if(void 0!==e[a]){for(var l=[],d=n.getLayerData(a),h=n.getMpkList(a),c=0,u=h.length;c<u;++c)l.push(h[c]);s.cacheLayerData(e[a],{layerId:d.layer_id,boundingBox:d.boundingBox,mpkIdxs:l})}t._onTaskFinished()}),(e=>{a.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),t._onTaskFinished()}))}delayLoadResources(e){var t=this.model.getConfig().metadata;0!==t.lines?(this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.maxLoadTaskCount+=t.lines,t.lines&&this._loadLine()):e&&e()}}r.ModelView.LayerBaseLoader=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider=null,this.firstToLoad=!0}destroy(){super.destroy(),this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider.destroy(),this.layerProvider=null}getLayerProvider(){return this.layerProvider}load(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START})}),(function(e){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:e})}),(function(){t.processLoadCompleted((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:i.id})}))}))}unload(e,t){}loadMpkOnDemand(e,t,i,n){var a=this,s=this.model,o=!e,l=function(e){s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_PROGRESS,progress:e})};this.firstToLoad?this.loader.delayLoadResources((function(){a.firstToLoad=!1,a.loader.finishCallback=null,a.prepareData((function(){a.loader.progressCallback=l,a.getLayerProvider().setConditionsOnDemandLoad(e),a._loadMpkOnDemand(o,t,i,n)}))})):(a.loader.progressCallback=l,a.getLayerProvider().setConditionsOnDemandLoad(e)?a._loadMpkOnDemand(o,t,i,n):(t&&t(),n&&n()))}_loadMpkOnDemand(e,t,i,n){var a=this,s=this.model;this.layerDataLoaded=!1,t&&t(),s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_START}),this.getLayerProvider().loadMpkOnDemand(e,(function(e){a.dealData(e)}),(function(e,t){a.unload(e,t)}),i,(function(){a.layerDataLoaded=!0,s.manager.updateFilterManager(),console.log("load finish"),s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_COMPLETE,data:{boundingBox:s.manager.getLoadOnDemandDirector().getBoundingBoxForUsedComponent()}}),n&&n()}))}processLoadCompleted(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.loaded=!0,t.updateOctreeNode(),requestAnimationFrame((function(){e&&e(),t.debut(t)}))}isAllReady(){return!(!this.isLoaded()||this.isHidden()||!this.isLayerDataLoaded())}applyFilter(){if(this.isLoaded()&&this.isLayerDataLoaded()){var e=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);if(e.length&&this.defaultManager.applyFilter(this.model,e),r.GlobalData.Instance){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.applyFilter(this.model,t)}}}needUpdate(){return!!this.isLayerDataLoaded()}clearData(){}initData(e){}dealMeshNodes(e){}dealData(e){var t=this;this.clearData(),this.initData((function(){t.model.manager.loadOverrideMaterialsByDemand((function(){t.dealMeshNodes(e)}),(function(){t.dealMeshNodes(e)}))}))}getLoadedUserIdsObject(){return this.loadedUserIdsObject}isLayerDataLoaded(){return this.layerDataLoaded}clearLoadedState(){this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null}}r.ModelView.LayerBaseHandler=e}(),function(){class e extends r.ModelView.LayerBaseHandler{constructor(e){super(e),this.layerProvider=new r.ModelView.LayerProvider(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}clearData(){this.model.clearNodeGroup(),this.model.clearMeshFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}initData(e){this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}unload(e,t){var i=this;this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,(function(e){i.defaultManager.disposeGeometry(e)}))}}r.ModelView.LayerHandler=e}(),function(){class e extends r.ModelView.LayerBaseProvider{constructor(e){super(e)}loadLayerDataByIdxs(e,t,i,r){this.model.getLoader().resetProcessState(t.length),this.model.getLoader().loadMpkOnDemand(t,(function(e,t){i&&i(t-e,t)}),r)}dealLayerDataLoading(e,t,i,r,n){var a=e.mpk;if(0!==a.addIdxs.length||0!==a.removeIdxs.length){var s=!1;a.removeIdxs.length>0&&(s=!0,i&&i(null,a.removeIdxs)),a.addIdxs.length>0?this.loadLayerDataByIdxs(null,a.addIdxs,r,(function(){t&&t(n)})):s?t&&t(n):n&&n()}else t&&t(n)}}r.ModelView.LayerProvider=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}}r.ModelView.LayerDescriptor=e}(),function(){class e extends r.ModelView.LayerBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.LayerDescriptor}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadScene(0),this._loadLayerKey(),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=2;return t+=e.symbol,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}r.ModelView.LayerLoader=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e,t){super(e),this.tag="layer",this.defaultManager=new r.ModelView.BatchedManager(t),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerLoader(this)}prepare(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}r.ModelView.LayerBatchedHandler=e}(),function(){class e extends r.ModelView.LayerBaseHandler{constructor(e){super(e),this.layerProvider=new r.ModelView.LayerSceneProvider(e)}prepareData(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}settleData(e){this.loaded=!0,e&&e()}clearData(){this.model.clearNodeGroup(),this.model.removeAllFromOctantMap(),this.model.getModelDescriptor().clearNodeInfosWithGeometryId(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}initData(e){this.model.getModelDescriptor().parseItemData(),this.model.getModelDescriptor().classifyAllNodeInfo(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.addNodeInfoToOctantMap(),this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}unload(e,t){var i=this;this.model.getModelDescriptor().removeFromSceneReaderMap(e),this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,(function(e){i.defaultManager.disposeGeometry(e)}))}}r.ModelView.LayerSceneHandler=e}(),function(){class e extends r.ModelView.LayerBaseProvider{constructor(e){super(e)}clearData(){this.model.getModelDescriptor().clearNodeInfoCache(),this.clearNodeInfoCacheWithLayerKey()}loadLayerDataByIdxs(e,t,i,r){var n=this.model.getLoader(),a=e.length,s=t.length;if(a&&s){var o=a+s;n.resetProcessState(o),n.loadLayerScenesOnDemand(e,(function(e,t){i&&i(t-e,o)}),(function(){n.loadMpkOnDemand(t,(function(e,t){i&&i(t-e+a,o)}),r)}))}else a?(n.resetProcessState(a),n.loadLayerScenesOnDemand(e,(function(e,t){i&&i(t-e,t)}),r)):s&&(n.resetProcessState(s),n.loadMpkOnDemand(t,(function(e,t){i&&i(t-e,t)}),r))}dealLayerDataLoading(e,t,i,r,n){var a=e.mpk,s=e.layerScene;if(0!==a.addIdxs.length||0!==a.removeIdxs.length||0!==s.addIdxs.length||0!==s.removeIdxs.length){var o=!1;(a.removeIdxs.length>0||s.removeIdxs.length>0)&&(o=!0,i&&i(s.removeIdxs,a.removeIdxs)),s.addIdxs.length>0||a.addIdxs.length>0?this.loadLayerDataByIdxs(s.addIdxs,a.addIdxs,r,(function(){t&&t(n)})):o?t&&t(n):n&&n()}else t&&t(n)}}r.ModelView.LayerSceneProvider=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}parseItemData(){var e=this.getSceneReaderMap();for(var t in e)for(var i=e[t],r=0,n=i.header.itemCount;r<n;++r)this._readItemData(i,r,this.getCellId(t,r));return!0}parseItemDataByCellId(e){var t=this.getSceneReaderMap();for(var i in t){var r=t[i],n=this.getItemIdsBy(e,i);if(n)for(var a=0,s=n.length;a<s;++a){var o=n[a];this._readItemData(r,o,this.getCellId(i,o))}}return!0}getLayerIdsByCellId(e){return this.cellIdMap&&this.cellIdMap[e]?Object.keys(this.cellIdMap[e]):null}getItemIdsBy(e,t){return this.cellIdMap&&this.cellIdMap[e]?this.cellIdMap[e][t]:null}cacheToCellIdMap(e,t,i){this.layerIdMap||(this.layerIdMap={}),this.layerIdMap[t]||(this.layerIdMap[t]={}),this.layerIdMap[t][i]=e,this.cellIdMap||(this.cellIdMap={}),this.cellIdMap[e]||(this.cellIdMap[e]={}),this.cellIdMap[e][t]||(this.cellIdMap[e][t]=[]),this.cellIdMap[e][t].push(i)}getCellId(e,t){return this.layerIdMap&&this.layerIdMap[e]&&this.layerIdMap[e][t]||0}isOctreeOuter(e){var t=this.octreeRootNode.layer;return t||(t=this.octreeRootNode.inner||this.octreeRootNode.outer),!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}isUseInnerAndOuterOctree(){return!this.octreeRootNode.layer}getOctreeRoots(e){this.octreeRootNode.layer?e.push(this.octreeRootNode.layer):(this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner),this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer))}updateOctreeNode(e){this.octreeRootNode.layer?this.updateOctreeNodeBy(this.octreeRootNode.layer,e):(this.octreeRootNode.inner&&this.updateOctreeNodeBy(this.octreeRootNode.inner,e),this.octreeRootNode.outer&&this.updateOctreeNodeBy(this.octreeRootNode.outer,e))}}r.ModelView.LayerSceneDescriptor=e}(),function(){class e extends r.ModelView.LayerBaseLoader{constructor(e,t){super(e,t),this.layerSceneTaskManager=new r.TaskManager,this.descriptor=new r.ModelView.LayerSceneDescriptor}loadLayerScenesOnDemand(e,t,i){for(var r=0,n=e.length;r<n;++r)this.layerSceneTaskManager.addTask(e[r]);this.layerSceneTaskManager.processTasks(this._loadLayerScene.bind(this),t,i)}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadLayerCellIndex(),this._loadLayerOctree(),this._loadLayerKey(),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=3;return t+=e.symbol,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}_loadLayerCellIndex(){var e=this,t=this.fileLoader;const i=this.url.layerSceneCell();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",i,(()=>new Promise(((e,r)=>{t.setResponseType("arraybuffer"),t.load(i,e,void 0,r)}))),(t=>{e._parseLayerCellIndex(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))}_parseLayerCellIndex(e){for(var t=new r.Loader.LayerIndexReader(e),i=this.descriptor,n=0,a=t.cell_count;n<a;n++)for(var s=t.getCell(n),o=s.itemIndex;o<s.itemCount;o++){var l=t.getLayerIndex(o);i.cacheToCellIdMap(s.cellId,l.layer_id,l.item_index)}}_loadLayerOctree(){var e=this.fileLoader,t=this.url,i=this;const n=t.layerOctree();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",n,(()=>new Promise(((t,i)=>{e.setResponseType("arraybuffer"),e.load(n,t,void 0,i)}))),(e=>{i._parseLayerOctree(e),i._onTaskFinished()}),(e=>{i._onTaskFinished()}))}_parseLayerOctree(e){this.descriptor.octreeRootNode.layer=this._getOctreeRootNode(e)}_loadLayerScene(e,t){var i=this,n=this.model,a=this.fileLoader;const s=this.url.layerSceneUrl(e);r.Storage.IndexedDBHelper.loadWithStorage("ModelData",s,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(s,e,void 0,t)}))),(r=>{i._parseScene(r,e),t(),i._onTaskFinished()}),(e=>{n.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),t(),i._onTaskFinished()}))}}r.ModelView.LayerSceneLoader=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e,t){super(e);const{useDataWireframe:i,version:n}=t;this.tag="layer",this.defaultManager=new r.ModelView.BatchedManager(i),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerSceneLoader(this,n)}prepare(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}r.ModelView.LayerSceneBatchedHandler=e}(),r.LoadOnDemandDirector=class{constructor(e){this.manager=e,this.requestCount=0,this.maxRequestCount=1e5,this.loading=!1,this.delayIntervalTime=300}destroy(){this.manager=null,this.currentConditions=null,this.delayLoadTimer&&(clearTimeout(this.delayLoadTimer),this.delayLoadTimer=null)}isValidModel(e){return!(e.isEmptyScene()||!e.isLayerData())}loadMpkOnDemandByConditionsWithDelay(e,t,i,r){var n=this,a=this.delayIntervalTime;n.delayLoadTimer&&clearTimeout(n.delayLoadTimer),n.delayLoadTimer=setTimeout((function(){n.loadMpkOnDemandByConditions(e,t,i,r)}),a)}loadMpkOnDemandByConditions(e,t,i,r){if(this.currentConditions=e,++this.requestCount,this.requestCount>this.maxRequestCount&&(this.requestCount=0),!this.loading){this.loading=!0;var n=this;requestAnimationFrame(function e(a){var s=a,o=n.currentConditions;return function(){n._loadMpkOnDemandByConditions(o,t,i,(function(){s!==n.requestCount?requestAnimationFrame(e(n.requestCount)):(n.loading=!1,r&&r(o),o=null)}))}}(this.requestCount))}}_loadMpkOnDemandByConditions(e,t,i,r){var n=this;this.manager.traverseModels((function(a){n.isValidModel(a)&&a._getHandler().loadMpkOnDemand(e,t,i,r)}))}getBoundingBoxOnDemand(){var e=new THREE.Box3,t=this;return this.manager.traverseModels((function(i){if(t.isValidModel(i)){var r=i._getHandler().getLayerProvider().getUnionBoundingBoxOnDemand();if(r){var n=i.getVertexOffsetMatrix();n&&r.applyMatrix4(n),e.union(r)}}})),e.isEmpty()?null:e}isLoading(){return this.loading}getBoundingBoxForUsedComponent(){var e=this.manager,t=new THREE.Box3;return e.traverseModels((function(i){var r=i.getLoadedUserIdsObject();r&&t.union(e.getBoundingBoxByIds(Object.keys(r)))})),t.isEmpty()?null:t}},function(){class e extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.occlusionVisibleOctant=[],this.usedNodeInfoMap={},this.lineNodes={},this.activeMeshMap={}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.occlusionVisibleOctant=null,this.usedNodeInfoMap=null,this.lineNodes=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this.usedNodeInfoMap={},this.occlusionVisibleOctant.length=0}updateNode(e,t,i){var n,a=this,s=e.getFilter()._hasOverrideMaterialFilter(),o=e.selectedMaterial;n=0===i?a._getUsableMaterial(e,t,o,s):a._getUsableMaterial(e,t,null,s),r.ModelView.BaseDescriptor.isLineNode(t)?a._dealLineSegments(e,t,n):a._dealMeshes(e,t,n),n=null}cullNodes(e,t,i){var r=this._getUsedNodeInfosByOctantId(t),n=this;if(r||(this.manager.traverseNodeInfoMapByOctantId(t,(function(t,i){n._isSatisfied(e,i)&&n._cacheToUsedNodeInfoMap(t,i)})),r=this._getUsedNodeInfosByOctantId(t)),!r)return i;for(var a=0,s=r.length;a<s&&(i=this.collectNodeInfo(e,r[a],i),!this.manager.isFull(e,i));a++);return i}_getUsableMaterial(e,t,i,n){var a=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):n&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[a]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}collectNodeInfo(e,t,i){var r=e.getFilter(),n=r._hasHiddenFileIdFilter(),a=r._hasOverrideMaterialFilter(),s=e.manager.sceneState.selectionSet,o=r._hasRenderPromotionFilter(),l=e.manager.getCategoriesFromHighPriority("inner");return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)||n&&r._isHiddenFileId(t)||!1===r._isVisible(t)?i:s[t.userId]||a&&r._hasHighPriorityOverrideMaterial(t)?(this.manager.addToPriorityNodesSet(0,t),++i):o&&r._isRenderPromotion(t)||t.userData&&t.userData.categoryId&&l[t.userData.categoryId]?(this.manager.addToPriorityNodesSet(1,t),++i):(this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,t),i++),i)}getMeshesByUserIds(e,t,i){const r=e.pool._pool,n=t.toString(),a=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==n||i.name==a){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}_getUsedGeometry(e,t){if(!r.GlobalData.Instance&&t.uvArrayBuffer){var i,n=t.geometryId+"|"+t.nodeId;if(i=this.getGeometryById(n))return i;var a=this._createGeometryByNodeInfo(e,t);a instanceof Array||(a=[a]),i=[];for(var s=new THREE.Matrix3,o=new THREE.Vector3,l=t.uvArrayBuffer,d=0,h=a.length;d<h;d++){var c=new THREE.BufferGeometry;c.setIndex(a[d].index),c.setAttribute("position",a[d].attributes.position),c.setAttribute("normal",a[d].attributes.normal),s.set(l[6*d],l[6*d+2],l[6*d+4],l[6*d+1],l[6*d+3],l[6*d+5],0,0,1);for(var u=[],p=a[d].attributes.uv.array,m=0,f=p.length;m<f;m+=2)o.set(p[m],p[m+1],1),o.applyMatrix3(s),u.push(o.x),u.push(o.y);c.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),i.push(c)}this._cacheGeometry(n,i)}else i=this.getGeometryByNodeInfo(e,t);return i}_dealMeshes(e,t,i){const n=this._getNodeGroupRenderOrder(t,i);let a=this._getUsedGeometry(e,t);a instanceof Array||(a=[a]);for(var s=0,o=a.length;s<o;s++){const o=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:a[s],matrix:t.matrix,material:i,isMesh:!0,isLine:!1,isLineSegments:!1,groupOrder:n.groupRenderOrder,renderOrder:n.renderOrder});o&&(o.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,o),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,o)))}}_dealLineSegments(e,t,i){const n=this.getGeometryByNodeInfo(e,t);if(!n)return;const a=this._getNodeGroupRenderOrder(t,i),s=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:n,matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,groupOrder:a.groupRenderOrder,renderOrder:a.renderOrder});s&&(s.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,s),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,s)))}_getUsedNodeInfosByOctantId(e){return this.usedNodeInfoMap[e]}_cacheToUsedNodeInfoMap(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}traverseUsedNodeInfoMap(e,t){const i=this.usedNodeInfoMap[e];for(let r=0,n=i.length;r<n;r++)t(e,i[r])}_isSatisfied(e,t){const i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,n=this.occlusionVisibleOctant.length;if(n>0)for(var a=e.manager.getFrustumFromOcclusionCamera(),s=0;s<n;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,a)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var n=e.manager.acquireMaterial(),a=n.material;i.color?a.color.copy(i.color):n.resetColor(),a.opacity=r.GlobalData.OcclusionOpacity,t.material=a,t.material.needsUpdate=!0}}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var n=[],a=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return n}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var n=e[i];if(this.activeMeshMap[n])for(var a=Object.keys(this.activeMeshMap[n]),s=0,o=a.length;s<o;s++){var l=a[s];t(n,l,this.activeMeshMap[n][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementedMeshManager=e}(),r.ModelView.IncrementedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.usedNodeInfoMap={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._disposeGeometries(),this.wireframeGeometryMap=null,this.usedNodeInfoMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._disposeGeometries(),this.wireframeGeometryMap={},this.usedNodeInfoMap={}}cullNodes(e,t,i){var r=this,n=this._getUsedNodeInfosByOctantId(t);if(n||(this.manager.traverseNodeInfoMapByOctantId(t,(function(t,i){r._isSatisfied(e,i)&&r._cacheToUsedNodeInfoMap(t,i)})),n=this._getUsedNodeInfosByOctantId(t)),!n)return i;for(var a=0,s=n.length;a<s&&(i=this._collectNodeInfo(e,n[a],i),!this.manager.isFull(e,i));a++);return i}updateNode(e,t){const i=e.getFilter()._getOverrideWireFrameMaterial(t)||e.getWireframeMaterial(),r=this._getWireframeGeometryByNodeInfo(e,t),n=this._getNodeGroupRenderOrder(t,i);for(let a=0,s=r.length;a<s;a++)e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,geometry:r[a],matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,pickable:!1,groupOrder:n.groupRenderOrder,renderOrder:n.renderOrder})}_getUsedNodeInfosByOctantId(e){return this.usedNodeInfoMap[e]}_cacheToUsedNodeInfoMap(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}_collectNodeInfo(e,t,i){var r=e.getFilter(),n=r._hasHiddenFileIdFilter();return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)||n&&r._isHiddenFileId(t)||!1===r._isVisible(t)||this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,{nodeInfo:t,wireframe:!0}),i++),i}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var i,n,a=[];if(t instanceof Array)for(var s=0,o=t.length;s<o;s++)n=r.BuildEdge(t[s].attributes.position.array,t[s].index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(n,1)),i.setAttribute("position",t[s].attributes.position,3),a.push(i);else n=r.BuildEdge(t.attributes.position.array,t.index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(n,1)),i.setAttribute("position",t.attributes.position,3),a.push(i);return this.wireframeGeometryMap[e]=a,this.wireframeGeometryMap[e]}_traverseWireframeGeometryMap(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,r=t.length;i<r;i++){var n=this.wireframeGeometryMap[t[i]];if(n)for(var a=0,s=n.length;a<s;a++)e(n[a])}}_disposeGeometries(){this._traverseWireframeGeometryMap((function(e){e.dispose()}))}_isSatisfied(e,t){if(!this.manager.isNeedWireframing(t.userId))return!1;var i=e.getLoadedUserIdsObject();return!(i&&!i[t.userId])}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}},function(){class e extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.instanceGeometryMap={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.matrixInfoMapFromUserId={},this.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{}},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.mgIdMapFromOctantId={},this.activeMeshMap={}}destroy(){if(super.destroy(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.cachedInstance=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.mgIdMapFromOctantId=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache()}clearInstanceCache(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}getBufferAttributesBy(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,!1,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,!1,1),n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,!1,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,!1,1),s=[],o=[];if(t.muvCol0[e])for(var l=0,d=t.muvCol0[e].length;l<d;l++)s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][l]),4,!1,1)),o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][l]),2,!1,1));return this.bufferAttributeMap[e]={attributeMcol0:i,attributeMcol1:r,attributeMcol2:n,attributeMcol3:a,attributeMuvCol0Array:s,attributeMuvCol1Array:o},this.bufferAttributeMap[e]}resetInstanceMaterial(){var e=this;this.traverseInstanceGeometryMap((function(t,i){for(var n=0,a=i.length;n<a;++n)e._hasStateAttribute(i[n])&&(i[n].getAttribute("vState").array.fill(r.EnumElementState.NONE),i[n].getAttribute("vState").needsUpdate=!0,i[n].getAttribute("vState2").array.fill(r.EnumElementState.HIDDEN),i[n].getAttribute("vState2").needsUpdate=!0)}))}clearInstanceStateByUserId(e){function t(e,t,i,r){for(var n=e.getAttribute("vState").array,a=e.getAttribute("vState2").array,s=0;s<t.length;++s){var o=t[s];n[4*o]=i,a[4*o]=r}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var i=this,n=r.EnumElementState.NONE,a=r.EnumElementState.HIDDEN;this.traverseNodeIdxMapByUserId(e,(function(e,r){var s=i.getInstanceGeometries(e);if(s)for(var o=0,l=s.length;o<l;o++)i._hasStateAttribute(s[o])&&t(s[o],r,n,a)}))}updateInstanceStateByUserId(e,t,i,n){function a(e,t,i,r,n){for(var a=e.getAttribute("vState").array,s=e.getAttribute("vState2").array,o=e.getAttribute("aColor"),l=o?o.array:null,d=0;d<t.length;++d){var h=t[d];a[4*h]=i,s[4*h]=r,null!==l&&null!==n&&(l[4*h]=n[0],l[4*h+1]=n[1],l[4*h+2]=n[2],l[4*h+3]=n[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,o&&(o.needsUpdate=!0)}var s=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,(function(l,d){var h=o.getInstanceGeometries(l);if(h){var c=o.manager.getMaterialIdByMeshId(l),u=o.getUsableMaterialColorParamsBy(e,c,i,n),p=u.rgbaColor,m=i;i===r.EnumElementState.TRANSPARENT&&(m=r.EnumElementState.OVERRIDED),i===r.EnumElementState.SELECTED&&o.cacheSelectedObjectIds(t,l);var f,g,v=s.getInstanceMaterialById(c,e)[0];v.transparent===u.transparent?(f=m,g=r.EnumElementState.HIDDEN):(f=r.EnumElementState.HIDDEN,g=m),m===r.EnumElementState.BLINK&&v.setBlinkColor(e.manager.blinkManager.getBlinkColor(e.id));for(var y=0,M=h.length;y<M;y++)o._hasStateAttribute(h[y])&&a(h[y],d,f,g,p)}}))}getUsableMaterialColorParamsBy(e,t,i,n){var a,s,o=e.selectedMaterial,l=e.getFilter()._getMaterialByName("scene"),d=e.materialManager,h=e.manager.getOverrideMaterialByName(t)||d.getMaterialById(t);switch(i){case r.EnumElementState.HOVER:n?(a=e.getFilter()._getMaterialByName(n),s=e.manager.sceneState.getHoverColorByMaterial(a)):s=e.manager.sceneState.getHoverColorByMaterial(h);break;case r.EnumElementState.SELECTED:s=r.MaterialUtil.getColorParamsByMaterial(o);break;case r.EnumElementState.TRANSPARENT:s=r.MaterialUtil.getColorParamsByMaterial(l);break;case r.EnumElementState.OVERRIDED:case r.EnumElementState.BLINK:n?(a=e.getFilter()._getMaterialByName(n),s=r.MaterialUtil.getColorParamsByMaterial(a)):s=r.MaterialUtil.getColorParamsByMaterial(h);break;default:s=r.MaterialUtil.getColorParamsByMaterial(h)}return s}getInstanceGeometries(e){return this.instanceGeometryMap[e]}_cacheInstanceGeometries(e,t){if(!this.instanceGeometryMap[e]){t instanceof Array||(t=[t]);for(var i=this.instanceGeometryMap[e]=[],r=0,n=t.length;r<n;++r)i[r]=new THREE.InstancedBufferGeometry,i[r].setIndex(t[r].index),i[r].setAttribute("position",t[r].attributes.position),i[r].setAttribute("normal",t[r].attributes.normal),i[r].setAttribute("uv",t[r].attributes.uv)}}traverseInstanceGeometryMap(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}traverseInstanceGeometryMapById(e,t){var i=this.instanceGeometryMap[e];if(i)for(var r=0,n=i.length;r<n;r++)t(i[r],e)}disposeInstanceGeometries(){this.traverseInstanceGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}cacheInstanceAttributeStateBy(e,t,i,r,n){var a=r.materialId,s=r.uvArrayBuffer;i instanceof Array||(i=[i]);var o=i.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[];for(var d=0;d<o;++d)l.muvCol0[t][d]=[],l.muvCol1[t][d]=[]}var h=n||e.materialManager.getMaterialById(a);l.vColor[t].push(h.color.r,h.color.g,h.color.b,h.opacity),l.vState[t].push(0,0,0,0);var c=r.matrix.elements;if(l.mcol0[t].push(c[0],c[1],c[2]),l.mcol1[t].push(c[4],c[5],c[6]),l.mcol2[t].push(c[8],c[9],c[10]),l.mcol3[t].push(c[12],c[13],c[14]),s)for(d=0;d<o;++d)l.muvCol0[t][d].push(s[6*d],s[6*d+1]),l.muvCol0[t][d].push(s[6*d+2],s[6*d+3]),l.muvCol1[t][d].push(s[6*d+4],s[6*d+5]);else for(d=0;d<o;++d)l.muvCol0[t][d].push(1,0),l.muvCol0[t][d].push(0,1),l.muvCol1[t][d].push(0,0);return l.vState[t].length/4-1}_cacheNodeIdxByUserId(e,t,i){var r=this.nodeIdxMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}getNodeIdxMapByUserId(e){return this.nodeIdxMapFromUserId[e]}traverseNodeIdxMapByUserId(e,t){var i=this.nodeIdxMapFromUserId[e];for(var r in i)t(r,i[r])}traverseNodeIdxMap(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),r=0,n=i.length;r<n;r++){var a=i[r];if(!t||!t(a)){var s=this.nodeIdxMapFromUserId[a];for(var o in s)e(o,s[o])}}}_cacheMatrixInfoByUserId(e,t,i){var r=this.matrixInfoMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}traverseMatrixInfoMapByUserId(e,t){var i=this.matrixInfoMapFromUserId[e];for(var r in i)t(r,i[r])}getMeshesByUserId(e,t){var i=this;this.traverseMatrixInfoMapByUserId(t,(function(r,n){for(var a=i.getInstanceNodesById(r),s=0,o=n.length;s<o;s++)for(var l=0,d=a.length;l<d;l++){var h={};if(h.matrix=n[s].matrix,h.mesh=a[l],1===d)h.boundingBox=n[s].boundingBox;else{var c=h.mesh.geometry.boundingBox;c?c=c.clone():(h.mesh.geometry.computeBoundingBox(),c=h.mesh.geometry.boundingBox.clone()),c.applyMatrix4(h.matrix),h.boundingBox=c}e.minDistanceObjects[t].push(h)}}))}clearSelectedObjectIds(){}cacheSelectedObjectIds(e,t){}adjustVisibility(e,t){}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){}_cacheToMgIdMapFromOctantId(e,t,i){this.mgIdMapFromOctantId[e]||(this.mgIdMapFromOctantId[e]={}),this.mgIdMapFromOctantId[e][i]||(this.mgIdMapFromOctantId[e][i]={cellId:e,cellDepth:t,mgId:i})}traverseMgIdMapByOctantId(e,t,i){if(this.mgIdMapFromOctantId[e])for(var r=this.mgIdMapFromOctantId[e],n=Object.keys(r),a=0,s=n.length;a<s;a++){var o=r[n[a]];if(i&&i(o.mgId))break;t(e,o)}}_createGeometryById(e){if(this.geometryMap||(this.geometryMap={}),!this.geometryMap[e]){this.geometryMap[e]=!0;for(var t=this.cachedInstance,i=this.getBufferAttributesBy(e),n=this.getInstanceGeometries(e),a=0,s=n.length;a<s;a++){n[a].setAttribute("mcol0",i.attributeMcol0),n[a].setAttribute("mcol1",i.attributeMcol1),n[a].setAttribute("mcol2",i.attributeMcol2),n[a].setAttribute("mcol3",i.attributeMcol3),i.attributeMuvCol0Array.length>0&&(n[a].setAttribute("muvCol0",i.attributeMuvCol0Array[a]),n[a].setAttribute("muvCol1",i.attributeMuvCol1Array[a])),n[a].setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(t.vColor[e]),4,!1,1)),n[a].setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),4,!1,1));var o=n[a].getAttribute("vState").array,l=n[a].getAttribute("vState2").array;o.fill(r.EnumElementState.NONE),l.fill(r.EnumElementState.HIDDEN);var d=n[a].index;n[a].addGroup(0,d.count,0),n[a].addGroup(0,d.count,1)}}}cullNodes(e,t,i){var r=this;return this.traverseMgIdMapByOctantId(t,(function(e,t){r.manager.addToPriorityNodesSet(2,t)}),(function(t){return i+=1,!!r.manager.isFull(e,i)&&(i-=1,!0)})),i}updateNode(e,t){const i=this,n=this.manager.getMaterialIdByMeshId(t.mgId),a=e.materialManager.getInstanceMaterialById(n,e),s=this._getNodeGroupRenderOrder(t,a[0]);this._createGeometryById(t.mgId),this.traverseInstanceGeometryMapById(t.mgId,(function(n,o){const l=e.pool.get({databagId:e.databagId,meshId:o,geometry:n,material:a,isMesh:!0,isLine:!1,isLineSegments:!1,instanceOrNot:!0,groupOrder:s.groupRenderOrder,renderOrder:s.renderOrder});l&&(i._cacheActiveMesh(t.mgId,l),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),o,new r.InstancedCapsuleObject(o,l)))}))}createInstanceNodeInfo(e,t,i){var r=this;this.octantIdMap||(this.octantIdMap={}),this.octantIdMap[t]||(this.octantIdMap[t]=!0,this.manager.traverseNodeInfoMapByOctantId(t,(function(t,n){var a=r.getGeometryByNodeInfo(e,n),s=e.manager.getOverrideMaterialByNodeInfo(n,e.materialManager.getMaterialById(n.materialId));s&&(n.materialId=s.name);var o=r.manager.getMeshIdByNodeInfo(n),l=r.cacheInstanceAttributeStateBy(e,o,a,n,s);r._cacheNodeIdxByUserId(n.userId,o,l),r._cacheMatrixInfoByUserId(n.userId,o,{matrix:n.matrix,boundingBox:n.boundingBox}),r._cacheInstanceGeometries(o,a),r._cacheToMgIdMapFromOctantId(t,i,o)})))}getCachedInstanceData(){return this.cachedInstance}_hasStateAttribute(e){return!!e.attributes.vState}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var n=[],a=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return n}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var n=e[i];if(this.activeMeshMap[n])t(n,this.activeMeshMap[n])}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t){this.activeMeshMap[e]||(this.activeMeshMap[e]=[]),this.activeMeshMap[e].push(t)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingIncrementInstancedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementInstancedMeshManager=e}(),r.ModelView.IncrementInstancedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeBufferMap={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.disposeGeometries(),this.wireframeGeometryMap=null,this.wireframeBufferMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this.disposeGeometries(),this.wireframeGeometryMap={},this.wireframeBufferMap={}}disposeGeometries(){this._traverseWireframeGeometryMap((function(e){e.dispose()}))}cullNodes(e,t,i){var r=this;return this.manager.getMeshManager().traverseMgIdMapByOctantId(t,(function(e,t){r.manager.addToPriorityNodesSet(2,{wireframe:!0,nodeInfo:t})}),(function(t){return i+=1,!!r.manager.isFull(e,i)&&(i-=1,!0)})),i}updateNode(e,t){const i=e.pool,r=e.getInstanceWireframeMaterial(),n=this._getNodeGroupRenderOrder(t,r);this._createGeometryById(t.mgId),this._traverseWireframeGeometryMapById(t.mgId,(function(t,a){i.get({databagId:e.databagId,meshId:a,geometry:t,material:r,isMesh:!1,isLine:!0,isLineSegments:!0,groupOrder:n.groupRenderOrder,renderOrder:n.renderOrder})}))}resetInstanceMaterial(){var e=r.EnumElementState.NONE,t=this;this._traverseWireframeGeometryMap((function(i){if(t._hasStateAttribute(i)){for(var r=i.getAttribute("vState").array,n=0,a=r.length;n<a;n++)r[n]=e;i.getAttribute("vState").needsUpdate=!0}})),this._updateNoWireframingState()}updateInstanceWireframeByUserId(e,t){if(t===r.EnumElementState.HIDDEN||t===r.EnumElementState.NONE){var i=this;this.manager.traverseNodeIdxMapByUserId(e,(function(e,r){i._setInstanceWireframeState(e,r,t)}))}}_getWireframeBufferById(e){var t=this.manager.getCombinedKeys(e).geometryId;if(this.wireframeBufferMap[t])return this.wireframeBufferMap[t];var i=this.manager.getMeshManager().getInstanceGeometries(e);if(!i)return[];for(var n=this.wireframeBufferMap[t]=[],a=0,s=i.length;a<s;a++){var o=i[a];n.push({index:r.BuildEdge(i[a].attributes.position.array,o.index.array),position:o.attributes.position})}return n}_traverseWireframeGeometryMap(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,r=t.length;i<r;i++)this._traverseWireframeGeometryMapById(t[i],e)}_traverseWireframeGeometryMapById(e,t){var i=this.wireframeGeometryMap[e];if(i)for(var r=0,n=i.length;r<n;r++)t(i[r],e)}_createGeometryById(e){if(!this.wireframeGeometryMap[e])for(var t=this.wireframeGeometryMap[e]=[],i=this.manager.getMeshManager().getBufferAttributesBy(e),r=this.manager.getMeshManager().getCachedInstanceData(),n=this._getWireframeBufferById(e),a=0,s=n.length;a<s;a++){var o=new THREE.InstancedBufferGeometry;o.setIndex(n[a].index),o.setAttribute("position",n[a].position),o.setAttribute("vState",new THREE.InstancedBufferAttribute(new Int8Array(r.vState[e]),4,!1,1)),o.setAttribute("mcol0",i.attributeMcol0),o.setAttribute("mcol1",i.attributeMcol1),o.setAttribute("mcol2",i.attributeMcol2),o.setAttribute("mcol3",i.attributeMcol3),t.push(o)}}_updateNoWireframingState(){var e=this,t=r.EnumElementState.HIDDEN;this.manager.traverseNodeIdxMap((function(i,r){e._setInstanceWireframeState(i,r,t)}),(function(t){return e.manager.isNeedWireframing(t)}))}_setInstanceWireframeState(e,t,i){var r=this;this._traverseWireframeGeometryMapById(e,(function(e){if(r._hasStateAttribute(e)){for(var n=e.getAttribute("vState").array,a=0,s=t.length;a<s;++a)n[t[a]]=i;e.getAttribute("vState").needsUpdate=!0}}))}adjustVisibility(e,t){}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){}_hasStateAttribute(e){return!!e.attributes.vState}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingIncrementInstancedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}},r.ModelView.IncrementInstancedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementInstancedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementInstancedWireframeManager(this),this.nodeInfoMapFromOctant={}}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null}clearData(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}traverseInstanceGeometryMap(e){this.meshManager.traverseInstanceGeometryMap(e)}traverseNodeIdxMapByUserId(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}traverseNodeIdxMap(e,t){this.meshManager.traverseNodeIdxMap(e,t)}getMeshesByUserId(e,t){this.meshManager.getMeshesByUserId(e,t)}_updateInstanceMaterialByUserId(e,t,i,r){this.meshManager.updateInstanceStateByUserId(e,t,i,r),this.wireframeManager.updateInstanceWireframeByUserId(t,i)}_updateInstanceMaterial(e){r.Logger.time("update instance material");var t=r.EnumElementState;for(var i in this.clearSelectedObjectIds(),this.filteredIds){var n=this.filteredIds[i];if(n[t.HIDDEN])this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.HIDDEN);else if(n[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(n[t.SELECTED]){r.GlobalData.PickingEffect?n[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.OVERRIDED,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.SELECTED);continue}if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.BLINK);continue}}else{if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.BLINK);continue}if(n[t.SELECTED]){r.GlobalData.PickingEffect?n[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.OVERRIDED,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.SELECTED);continue}}n[t.HOVER]?n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.HOVER,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.HOVER):n[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumElementState.OVERRIDED,n[t.OVERRIDED])}}r.Logger.timeEnd("update instance material")}_resetInstanceMaterial(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}_collectFilteredUserIds(e,t,i){var n=e.getFilter(),a=n._hasHiddenFileIdFilter(),s=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),l=n._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.filteredIds={};if(a||s||o||l||d||h)for(var u=r.EnumElementState,p=0;p<t.length;++p){var m=t[p],f=i[m];if(f&&f.length){var g=f[0];if(a&&n._isHiddenFileId(g)||s&&!1===n._isVisible(g)||e.isReplacedUserId(m)||e.isHiddenSourceObjectUserId(m))c[m]||(c[m]={}),c[m][u.HIDDEN]=!0;else if(l&&n._isTransparent(g))c[m]||(c[m]={}),c[m][u.TRANSPARENT]=!0;else if(o&&n._hasOverrideMaterial(g)){var v=n._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(c[m]||(c[m]={}),c[m][u.OVERRIDED]=y)}}}}_collectSelectedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},n=r.EnumElementState,a={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][n.SELECTED]=!0,a[s]=!0);this.selectedUserIds=Object.keys(a)}_clearSelectedState(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var n=this.selectedUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][r.EnumElementState.SELECTED])}this.selectedUserIds=null}}_collectHoveredUserIds(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][r.EnumElementState.HOVER]=!0,this.hoverdUserId=e)}_clearHoveredState(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][r.EnumElementState.HOVER],this.hoverdUserId=void 0)}_collectBlinkedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},n=r.EnumElementState,a={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][n.BLINK]=!0,a[s]=!0);this.blinkUserIds=Object.keys(a)}_clearBlinkedState(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var n=this.blinkUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][r.EnumElementState.BLINK])}this.blinkUserIds=null}}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;this.updateNodes(e),this._resetInstanceMaterial(),i=t||e.getModelDescriptor().getInstancedUserIds();var r=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._updateInstanceMaterial(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._updateInstanceMaterial(e),this.updateNodes(e)}updateNode(e,t){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo):this.meshManager.updateNode(e,t)}updateNodes(e){}createMeshNodes(e,t,i){this.meshManager.createMeshNodes(e,t,i)}clearCachedData(){this.meshManager.disposeGeometries()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}clearSelectedObjectIds(){this.meshManager.clearSelectedObjectIds()}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}cullNodes(e,t,i,r,n){return this.hasOctantId(t)?(this.meshManager.createInstanceNodeInfo(e,t,i),0===r?this.meshManager.cullNodes(e,t,n):1===r?this.wireframeManager.cullNodes(e,t,n):n):n}clearNodeInfoMap(){this.nodeInfoMapFromOctant={}}cacheToNodeInfoMap(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}traverseNodeInfoMapByOctantId(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,r=this.nodeInfoMapFromOctant[e].length;i<r;i++)t(e,this.nodeInfoMapFromOctant[e][i])}traverseNodeInfoMap(e){for(var t=Object.keys(this.nodeInfoMapFromOctant),i=0,r=t.length;i<r;i++)this.traverseNodeInfoMapByOctantId(t[i],e)}traverseNodeInfoMapByIds(e,t){if(e)for(var i=Object.keys(this.nodeInfoMapFromOctant),r=0,n=i.length;r<n;r++)for(var a=i[r],s=this.nodeInfoMapFromOctant[a],o=0,l=s.length;o<l;o++)e[s[o].userId]&&t(a,s[o]);else this.traverseNodeInfoMap(t)}hasNodeInfo(){return!r.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}hasOctantId(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}addToPriorityNodesSet(e,t){this.handler.addToPriorityNodesSet(e,t)}isFull(e,t){return this.handler.isFull(e,t)}isNeedWireframing(e){return this.handler.isNeedWireframing(e)}getMeshIdByNodeInfo(e){return r.Utils.getCombinedKeyString([e.materialId,e.geometryId,e.cellId])}getMaterialIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[0]}getCombinedKeys(e){var t=r.Utils.splitCombinedKeyString(e);return{materialId:t[0],geometryId:t[1],cellId:t[2]}}getNodeInfoCountById(e){var t=this.meshManager.getCachedInstanceData();return t.vState[e]?t.muvCol0&&t.muvCol0[e]&&t.muvCol0[e].length?t.muvCol0[e].length*t.vState[e].length/4:t.vState[e].length/4:0}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}isPickableNode(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],i=r.EnumElementState;return!t[i.HIDDEN]&&!t[i.TRANSPARENT]}isHiddenNode(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][r.EnumElementState.HIDDEN])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},r.ModelView.IncrementedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementedWireframeManager(this),this.nodeInfoMapFromOctant={},this.handler=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null,this.handler=null}clearData(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}clearNodeInfoMap(){this.nodeInfoMapFromOctant={}}cacheToNodeInfoMap(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}traverseNodeInfoMapByOctantId(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,r=this.nodeInfoMapFromOctant[e].length;i<r;i++)t(e,this.nodeInfoMapFromOctant[e][i])}hasNodeInfo(){return!r.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}hasOctantId(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}cullNodes(e,t,i,r,n){return this.hasOctantId(t)?0===r?this.meshManager.cullNodes(e,t,n):1===r?this.wireframeManager.cullNodes(e,t,n):n:n}updateNode(e,t,i){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo,i):this.meshManager.updateNode(e,t,i)}updateNodes(e){}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getLoader(e){return e.loader}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}addToPriorityNodesSet(e,t){this.handler.addToPriorityNodesSet(e,t)}isFull(e,t){return this.handler.isFull(e,t)}isNeedWireframing(e){return this.handler.isNeedWireframing(e)}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}isPickableNode(e){return!0}isHiddenNode(e){return!1}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},r.ModelView.IncrementCompositedManager=class{constructor(){this.defaultManager=new r.ModelView.IncrementedManager,this.instancedManager=new r.ModelView.IncrementInstancedManager,this.defaultManager.handler=this,this.instancedManager.handler=this,this.priorityNodesSet=[[],[],[]],this.octantManager=new r.OctantManager,this.noNeedWireframingIdMap={}}destroy(){this.defaultManager.handler=null,this.instancedManager.handler=null,this.defaultManager=null,this.instancedManager=null,this.clearPriorityNodesSet(),this.priorityNodesSet=null,this.octantManager.destroy(),this.octantManager=null,this.noNeedWireframingIdMap=null}clearData(){this.clearNoNeedWireframingIdMap(),this.defaultManager.clearData(),this.instancedManager.clearData()}settleData(e,t){var i=this.octantManager.getAllOctants(e);i.length>0?this._parseItemDataByOctants(e,i,(function(){t&&t()})):t&&t()}cullNodes(e,t){this.clearPriorityNodesSet(),this._collectNoWireframingIds(e);var i=this.octantManager.getVisibleOctants(e,t,!0);if(i.length){var r=0;if(!e.isOnlyWireframe())return e.isActivateWireframe()?(r=this._cullNodesByVisibleOctant(e,i,0,r),void this._cullNodesByVisibleOctant(e,i,1,r)):void this._cullNodesByVisibleOctant(e,i,0,r);this._cullNodesByVisibleOctant(e,i,1,r)}}_cullNodesByVisibleOctant(e,t,i,r){for(var n=0,a=t.length;n<a;++n){var s=t[n].octantId,o=t[n].depth;if(r=this.defaultManager.cullNodes(e,s,o,i,r),r=this.instancedManager.cullNodes(e,s,o,i,r),this.isFull(e,r))break}return r}updateNodes(e){var t=this;this.traversePriorityNodesSet((function(i,r){t._isInstanceNode(r)?t.instancedManager.updateNode(e,r):t.defaultManager.updateNode(e,r,i)})),r.GlobalData.DEBUG&&this.octantManager.showOctreeBox(e)}_collectNoWireframingIds(e){if(!this.wireframingIdCollected){this.wireframingIdCollected=!0;var t=this,i=e.getFilter();e.getModelDescriptor().traverseNodeInfosByCell((function(e,n){(nodeInfos&&i.getWireFrameVisibilityCondition()&&!i._isRenderWithWireFrame(n)||n.type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE||i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(n))&&(t.noNeedWireframingIdMap[n.userId]=!0)}))}}isNeedWireframing(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}clearNoNeedWireframingIdMap(){this.wireframingIdCollected=!1,this.noNeedWireframingIdMap={}}disposeBufferAfterVbo(){this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo()}isFull(e,t){return!(t<e.getRenderableCount())}clearPriorityNodesSet(){this.priorityNodesSet[0]=[],this.priorityNodesSet[1]=[],this.priorityNodesSet[2]=[]}addToPriorityNodesSet(e,t){e=e<0||e>2?2:e,this.priorityNodesSet[e].push(t)}traversePriorityNodesSet(e){for(var t=this.priorityNodesSet,i=0,r=t.length;i<r;++i)for(var n=t[i],a=0,s=Object.keys(n).length;a<s;++a)e(i,n[a])}_parseItemDataByOctants(e,t,i){var r=this,n=t.length;requestAnimationFrame(function a(s){var o=s;return function(){var s=t[o].octantId,l=t[o].depth;r._parseItemDataByOctantId(e,s,l),o<n-1?requestAnimationFrame(a(o+1)):i&&i()}}(0))}_parseItemDataByOctantId(e,t,i){e.getModelDescriptor().parseItemDataByCellId(t);var r=e.getModelDescriptor().getNodeInfosByCellId(t);if(r)for(var n,a=0,s=r.length;a<s;a++)(n=r[a]).cellDepth=i,n.instanceOrNot?this.instancedManager.cacheToNodeInfoMap(t,n):this.defaultManager.cacheToNodeInfoMap(t,n),e.manager.addNodeInfoToOctantMap(e.getEncodedDatabagId(),t,n)}_isInstanceNode(e){return!!(e.mgId||e.nodeInfo&&e.nodeInfo.mgId)}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.DefaultLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}prepareData(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,(function(){t.dataReady=!0,t.settleData(e)}))}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}isAllReady(){return!(!this.isLoaded()||this.isHidden())}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}}r.ModelView.IncrementHandler=e}(),function(){let e=new THREE.Vector3;class t extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.nodePriority={high:[],medium:[],low:[]},this.visibleOctant=[],this.occlusionVisibleOctant=[],this.usedNodeInfosObject={},this.lineNodes={},this.blinkMaterials=[],this.activeMeshMap={},this._priorityRange={max:0,min:0}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}update(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}cullNodes(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var i=0;i=r.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,i)}getPriorityNodes(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}_cullNodesWithInnerAndOuterOctree(e,t){var i=0,r=0,n=e.getModelDescriptor().getOctreeRootNode(),a=n.inner,s=n.outer;if(this.manager.getContainsCamera(e)||!s)return this.visibleOctant.length=0,a&&this._frustumCull(e,t,a),s&&this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,r)),i;s&&(this.visibleOctant.length=0,this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!1,i,r)));var o=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||o._hasRenderPromotionFilter())&&a&&(this.visibleOctant.length=0,this._frustumCull(e,t,a),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),i=this._logicCull(e,!0,!1,i,r))),i}_cullNodesWithLayerOctree(e,t){var i=0;this.visibleOctant.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;r._isLayerOctree=!0,this._frustumCull(e,t,r),r._isLayerOctree=void 0;var n=this.visibleOctant.length;return n>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,n)),i}_cullNodesWithOctant(e,t){return this._resetMaxAndMinPriority(),e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}_cullNodesWithFull(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}_calcPrioritizedNodeCount(e,t){var i=t+this.nodePriority.high.length+this.nodePriority.medium.length;return i>this.manager.getRenderableCount(e)&&(i=this.manager.getRenderableCount(e)),i}_updateMeshNodes(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),this.filter=e.getFilter(),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var i=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],n=null;i[0].length>0&&(n=e.selectedMaterial);var a=e.getFilter()._hasOverrideMaterialFilter(),s={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,l=0,d=0,h=i.length;d<h;++d)for(var c=i[d],u=0,p=Object.keys(c).length;u<p&&!(o>t);++u){l++;var m,f=c[u];m=0===d?this._getUsableMaterial(e,f,n,a):this._getUsableMaterial(e,f,null,a);var g=!f.instanceOrNot;if(r.ModelView.BaseDescriptor.isLineNode(f))this._dealLineSegments(e,f,g,m);else{var v=e.pool.counter;this._dealMeshes(e,f,g,m,s);var y=e.pool.counter-v;o+=y,t+=y-1}m=null}return n=null,i=null,l}_getUsableMaterial(e,t,i,n){var a=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):n&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[a]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}getMeshesByUserIds(e,t,i){const r=e.pool._pool,n=t.toString(),a=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==n||i.name==a){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}explode(e){for(var t=e.pool._pool,i=0;i<t.length;i++){var r=t[i],n=e.modelExplosion.getExplosionTranslation(r.name);r.translateZ(n.z),r.updateMatrix(),r.updateMatrixWorld()}}_getUsedGeometry(e,t){if(!r.GlobalData.Instance&&t.uvArrayBuffer){var i,n=t.geometryId+"|"+t.nodeId;if(i=this.getGeometryById(n))return i;var a=this._createGeometryByNodeInfo(e,t);a instanceof Array||(a=[a]),i=[];for(var s=new THREE.Matrix3,o=new THREE.Vector3,l=t.uvArrayBuffer,d=0,h=a.length;d<h;d++){var c=new THREE.BufferGeometry;c.setIndex(a[d].index),c.setAttribute("position",a[d].attributes.position),c.setAttribute("normal",a[d].attributes.normal),s.set(l[6*d],l[6*d+2],l[6*d+4],l[6*d+1],l[6*d+3],l[6*d+5],0,0,1);for(var u=[],p=a[d].attributes.uv.array,m=0,f=p.length;m<f;m+=2)o.set(p[m],p[m+1],1),o.applyMatrix3(s),u.push(o.x),u.push(o.y);c.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),i.push(c)}this._cacheGeometry(n,i)}else i=this.getGeometryByNodeInfo(e,t);return i}_dealMeshes(e,t,i,n,a){const s=e.pool,o=this._getNodeGroupRenderOrder(t,n);let l=this._getUsedGeometry(e,t);l instanceof Array||(l=[l]);for(let a=0,d=l.length;a<d;a++){const d=s.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:l[a],matrix:t.matrix,material:n,groupOrder:o.groupRenderOrder,renderOrder:o.renderOrder,visible:i});d&&(d.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,d),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,d)))}}_dealLineSegments(e,t,i,n){var a=this.getGeometryByNodeInfo(e,t);if(a){var s=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||((o=new r.LineSegmentsEx(a,n)).databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,t.matrix&&(o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1),this.lineNodes[t.nodeId]=o),o.material=n,o.visible=i,s.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,o)}}_frustumCull(t,i,n){var a=t.manager,s=i.getFrustum(),o=n._isLayerOctree?r.GlobalData.MaximumDepth+1:r.GlobalData.OctantDepth,l=i.projScreenMatrix,d=new THREE.Box3;function h(t,i,r,n,a){var s;if(i&&t.depth<r&&(d.set(t.min,t.max),s=i.intersectsBox(d)),s){if(n){var o=d.applyMatrix4(l),c=o.getSize(e).length(),u=o.getCenter(e).z;u=u>1e-6?u:1e-6,t.priority=c}a.push(t);for(var p=0,m=t.childOctants.length;p<m;++p)h(t.childOctants[p],i,r,n,a)}}(r.GlobalData.DEBUG&&a.showOctreeBox(n),h(n,s,o,!0,this.visibleOctant),r.GlobalData.OcclusionTranslucentEnabled)&&h(n,this.manager.getFrustumFromOcclusionCamera(),o,!1,this.occlusionVisibleOctant);return!0}_logicCull(e,t,i,n,a){var s=e.manager,o=e.getFilter(),l=o._hasHiddenFileIdFilter(),d=o._hasOverrideMaterialFilter(),h=s.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),u=this.nodePriority.high,p=this.nodePriority.medium,m=this.nodePriority.low,f=this.nodePriority.low.length,g=e.getModelDescriptor().getNodeInfosWithCellId();function v(t,i){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(l&&o._isHiddenFileId(t)||!1===o._isVisible(t)))if(h.hasOwnProperty(t.userId)||d&&o._hasHighPriorityOverrideMaterial(t))u.push(t);else{var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),i){var a=t.userData,s=a?a.categoryId:void 0;s&&i[s]&&(r=!0)}r?p.push(t):n<f&&(m[n]=t,n++)}}var y=s.getCategoriesFromHighPriority("outer");!0===i&&(y=s.getCategoriesFromHighPriority("inner"));for(var M,E=0,x=0;x<a;++x){var _,b=0;t?(_=this.visibleOctant[x].octantId,b=this.visibleOctant[x].depth):_=x;var I=g[_];if(I){var T=this._getUsedNodeInfosByCellId(_);if(!T){for(M=0,E=I.length;M<E;++M){(C=I[M]).octantId=_,C.cellDepth=b,C._measurement=this._calcNodeMeasurement(C),this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(_,C)}T=this._getUsedNodeInfosByCellId(_)}if(T){var S=T.default;for(M=0,E=S.length;M<E;M++){var C=S[M];this._updateMaxAndMinPriority(C),v(C,y)}}}}return r.Logger.timeEnd("collectNodeInfo"),n}_clearUsedNodeInfosObject(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}_getUsedNodeInfosByCellId(e){return this.usedNodeInfosObject[e]}_cacheUsedNodeInfosByCellId(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}_isSatisfied(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_logicCullWithFull(e,t){return this._logicCull(e,!1,!0,0,t)}_sortVisibleOctant(e,t){var i=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var n=new r.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);i=n.getAncestorAndNeighbors()}this.visibleOctant.sort((function(e,t){if(null!=i){if(null!=i[e.octantId])return-1;if(null!=i[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0}))}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,n=this.occlusionVisibleOctant.length;if(n>0)for(var a=e.manager.getFrustumFromOcclusionCamera(),s=0;s<n;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,a)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var n=e.manager.acquireMaterial(),a=n.material;i.color?a.color.copy(i.color):n.resetColor(),a.opacity=r.GlobalData.OcclusionOpacity,t.material=a,t.material.needsUpdate=!0}}_clearNodePriorityData(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}_adjustLowNodePriorityLength(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}_clearLineSegmentsNodeGroup(e){this._getLineSegmentsNodeGroup(e).clear()}_getLineSegmentsNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}getBlinkMaterials(){return this.blinkMaterials}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var n=[],a=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++){var p=d[c].getAttribute("uv");n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix,uv:p?p.array:null})}else{p=d.getAttribute("uv");n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix,uv:p?p.array:null})}}}return n}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var n=e[i];if(this.activeMeshMap[n])for(var a=Object.keys(this.activeMeshMap[n]),s=0,o=a.length;s<o;s++){var l=a[s];t(n,l,this.activeMeshMap[n][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}isPickableNode(e){return!this.filter||this.filter._isPickable({name:e})}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:this._getNodePriority(e)}}_calcNodeMeasurement(e){return e.boundingBox.getSize(r.Utils.scratchVector_1).length()}_resetMaxAndMinPriority(){this._priorityRange.min=Number.MAX_VALUE,this._priorityRange.max=-Number.MAX_VALUE}_updateMaxAndMinPriority(e){let t=this._priorityRange;t.min=Math.min(e._measurement,t.min),t.max=Math.max(e._measurement,t.max)}_getNodePriority(e){if(void 0===e._measurement)return e.octantId;const t=this._priorityRange.min,i=this._priorityRange.max;return e._priority=r.Math.isolateDigits(r.Math.normalize(i-e._measurement,t,i),4,0),e._priority}}r.ModelView.FreeIncrementedMeshManager=t}(),r.ModelView.FreeIncrementedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearWireframeLineMeshes(),this._disposeGeometries()}update(e,t){0!==t?this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e):this._clearWireframeGroupNode(e)}_disposeGeometries(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}_disposeGeometry(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}_clearWireframeLineMeshes(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}_clearWireframeGroupNode(e){this._getWireWireframeGroupNode(e).clear()}_removeWireframeGroupNode(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}isActivateWireframe(e){return e.isActivateWireframe()}_getWireWireframeGroupNode(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var i,n,a=[];if(t instanceof Array)for(var s=0,o=t.length;s<o;s++)n=r.BuildEdge(t[s].attributes.position.array,t[s].index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(n,1)),i.setAttribute("position",t[s].attributes.position,3),a.push(i);else n=r.BuildEdge(t.attributes.position.array,t.index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(n,1)),i.setAttribute("position",t.attributes.position,3),a.push(i);return this.wireframeGeometryMap[e]=a,this.wireframeGeometryMap[e]}_makeWireframeLineMeshes(e,t,i){if(t.type!==r.ModelView.BaseDescriptor.EnumNodeItemType.LINE){var n=this.wireframeLineMeshes[t.nodeId];if(!n){n=this.wireframeLineMeshes[t.nodeId]=[];for(var a=this._getWireframeGeometryByNodeInfo(e,t),s=0,o=a.length;s<o;s++){var l=new THREE.LineSegments(a[s],this._getWireframeMaterial(e));l.name=t.nodeId+"_"+s,l.applyMatrix4(t.matrix),n.push(l)}}var d=!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return!(r.GlobalData.Instance&&(e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX||e.geometryId==r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M)||(e&&t.getWireFrameVisibilityCondition()?!t._isRenderWithWireFrame(e):t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e)))}(t,this._getFilter(e));if(d)for(var h=this._getFilter(e)._getOverrideWireFrameMaterial(t)||this._getWireframeMaterial(e),c=0,u=n.length;c<u;c++)n[c].material=h,i.add(n[c])}}_generateWireframeNodes(e,t){for(var i=this._getWireWireframeGroupNode(e),r=this.manager.getPriorityNodes(),n=0,a=0,s=r.length;a<s;++a)for(var o=r[a],l=0,d=Object.keys(o).length;l<d&&!(++n>t);++l){var h=o[l];this._makeWireframeLineMeshes(e,h,i)}}_getWireframeGroupName(e){return e._getWireframeGroupName()}_getWireframeMaterial(e){return e.getWireframeMaterial()}_getFilter(e){return e.getFilter()}explode(e){for(var t=new THREE.Matrix4,i=e.getModelDescriptor().getAllNodeInfos(),r=Object.keys(i),n=0,a=r.length;n<a;n++){var s=r[n],o=i[s],l=e.modelExplosion.getExplosionTranslation(s);t.makeTranslation(l.x,l.y,l.z);for(var d=0,h=o.length;d<h;d++){var c=this.wireframeLineMeshes[o[d].nodeId];if(c)for(var u=0;u<c.length;u++)c[u].applyMatrix4(t)}}}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.FreeIncrementedManager=class{constructor(){this.meshManager=new r.ModelView.FreeIncrementedMeshManager(this),this.wireframeManager=new r.ModelView.FreeIncrementedWireframeManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}cullNodes(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}updateNodes(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getPriorityNodes(){return this.meshManager.getPriorityNodes()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getRenderableCount(e){return e.getRenderableCount()}getLoader(e){return e.getLoader()}getContainsCamera(e){return e.containsCamera}getFilter(e){return e.getFilter()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}isHiddenNode(e){return!1}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.DefaultLoader(this)}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIds();if(0===t.length)return this.loaded=!0,void(e&&e());this.instancedManager.asyncCreateMeshNodes(this.model,t,(()=>{this.loaded=!0,e&&e()}))}disposeBufferAfterVbo(){}}r.ModelView.FreeIncrementHandler=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e){super(e),this.tag="layer",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerLoader(this)}prepare(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}disposeBufferAfterVbo(){}}r.ModelView.FreeLayerIncrementHandler=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e){super(e),this.tag="layer",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerSceneLoader(this)}prepare(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}disposeBufferAfterVbo(){}}r.ModelView.FreeLayerSceneIncrementHandler=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e){super(e),this.tag="layer",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.LayerLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}prepareData(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,(function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}addNodeInfoToOctantMap(){}dealMeshNodes(e){e&&e()}disposeBufferAfterVbo(){}}r.ModelView.LayerIncrementHandler=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e){super(e),this.tag="layer",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.LayerSceneLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}initData(e){var t=this;this.compositedManager.settleData(this.model,(function(){t.model.getModelDescriptor().classifyAllNodeInfo(),t.getLayerProvider().cacheNodeInfosWithLayerKey(),t.addNodeInfoToOctantMap(),t.loadedUserIdsObject=t.getLayerProvider().getUserIdsOnDemand(),t.loadedUserIds=Object.keys(t.loadedUserIdsObject),e&&e()}))}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}addNodeInfoToOctantMap(){}clearData(){this.model.removeAllFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.compositedManager.clearData(),this.clearLoadedState()}dealMeshNodes(e){e&&e()}disposeBufferAfterVbo(){}}r.ModelView.LayerSceneIncrementHandler=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super(),this.bufferDataObjectMap={},this.bufferDataObjectIdMap={},this.parameterizedBufferMap={},this.geometryIdMapOnBufferDataObjectId={},this.mpkIdMapOnCellId={}}destroy(){super.destroy(),this.geometryIdMapOnbufferDataObjectId=void 0}setToBufferDataObjectMap(e,t){if(!this.bufferDataObjectMap[e]){var i=null;if(t){var n=t.bufferData,a=t.positionOffsetMap;return(i=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(n.index,1)),i.setAttribute("position",new THREE.BufferAttribute(n.position,3)),n.normal?i.setAttribute("normal",new THREE.BufferAttribute(n.normal,3)):i.computeVertexNormals(),n.uv&&i.setAttribute("uv",new THREE.BufferAttribute(n.uv,2)),void(this.bufferDataObjectMap[e]=new r.ModelView.BatchedBufferDataObject(e,a,i))}var s=r.ModelView.BaseDescriptor.parameterizedNodeType;switch(e){case s.PIPE:i=r.GeomUtil.UnitCylinderInstance;break;case s.PIPE_M:i=r.GeomUtil.getUnitTextureCylinder();break;case s.BOX:i=r.GeomUtil.UnitBoxInstance;break;case s.BOX_M:i=r.GeomUtil.getUnitTextureBox()}i&&(i.clearGroups&&i.clearGroups(),this.bufferDataObjectMap[e]=new r.ModelView.BatchedBufferDataObject(e,void 0,i))}}removeFromBufferDataObjectMap(e){var t=this.bufferDataObjectMap[e];t&&(t.destroy(),delete this.bufferDataObjectMap[e])}getBufferDataObjectById(e){return this.bufferDataObjectMap[e]}getBufferDataObjectByGeometryId(e){var t=this.getBufferDataObjectIdByGeometryId(e);return void 0!==t?this.getBufferDataObjectById(t):void 0}setToBufferDataObjectIdMap(e,t){this.bufferDataObjectIdMap[e]=t}_isParameterizedNodeType(e){return r.ModelView.BaseDescriptor.isParameterizedNodeType(e)}getBufferDataObjectIdByGeometryId(e){var t=this.bufferDataObjectIdMap[e];if(void 0!==t)return t;if(this._isParameterizedNodeType(e)){var i=r.ModelView.BaseDescriptor.parameterizedNodeType;return t=e===i.TUBE?i.PIPE:e,this.setToBufferDataObjectMap(t),this.setToBufferDataObjectIdMap(e,t),this.setToGeometryIdMap(t,e),this.bufferDataObjectIdMap[e]}}setToGeometryIdMap(e,t){this.geometryIdMapOnBufferDataObjectId[e]||(this.geometryIdMapOnBufferDataObjectId[e]={}),this.geometryIdMapOnBufferDataObjectId[e][t]=!0}getGeometryIdsByBufferDataObjectId(e){return this.geometryIdMapOnBufferDataObjectId[e]}_classifyNodeInfo(e){super._classifyNodeInfo(e),this._cacheMpkIdsByCellId(e)}_cacheMpkIdsByCellId(e){void 0===this.mpkIdMapOnCellId[e.cellId]&&(this.mpkIdMapOnCellId[e.cellId]={});var t=this.getBufferDataObjectIdByGeometryId(e.geometryId);void 0!==t&&(this.mpkIdMapOnCellId[e.cellId][t]=!0)}getMpkIdsByCellId(){return this.mpkIdMapOnCellId[nodeInfo.cellId]}}r.ModelView.IncrementBatchedDescriptor=e,r.ModelView.BatchedBufferDataObject=class{constructor(e,t,i){this.id=e,this.positionOffsetMap=t,this.geometry=i,this.object=new r.MeshEx(i)}destroy(){this.positionOffsetMap=null,this.geometry.dispose(),this.geometry=null}getPositionAndIndexOffset(e){return this.positionOffsetMap?this.positionOffsetMap[e]:null}}}(),function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.IncrementBatchedDescriptor}_parseMpkWithNoBatch(e,t){var i,n,a,s,o,l,d,h,c=new r.Loader.MPKReader(e),u=new THREE.Matrix4,p=[],m=0,f=0,g=[],v=0,y=0;for(i=0,n=c.header.meshCount;i<n;++i){var M=c.getPtBuffer(i),E=c.getIdxBuffer(i),x=c.getNormalBuffer(i);if(null!=M&&null!=E&&null!=x){var _=c.getMeshData(i),b=c.getUVBuffer(i);0!==_.baseScale&&(M=new Float32Array(M),u.identity(),u.setPosition(new THREE.Vector3(_.baseX,_.baseY,_.baseZ)),u.scale(new THREE.Vector3(_.baseScale,_.baseScale,_.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(u,M)),E instanceof Uint16Array&&(E=Uint32Array.from(E)),b&&b.length?(g.push({meshId:_.mesh_id,position:M,index:E,normal:x,uv:b,positionOffset:v,indexOffset:y}),v+=M.length,y+=E.length):(p.push({meshId:_.mesh_id,position:M,index:E,normal:x,positionOffset:m,indexOffset:f}),m+=M.length,f+=E.length)}else r.Logger.log("Error Geometry!")}var I={},T={};if(g.length){for(s=new Uint32Array(y),a=new Float32Array(v),o=new Float32Array(v),l=new Float32Array(v),i=0,n=g.length;i<n;i++){var S=(A=g[i]).meshId,C=A.positionOffset,w=A.position.length,R=A.indexOffset,B=A.index.length;for(d=0,h=A.index.length;d<h;d++)A.index[d]+=C/3;a.set(A.position,C),s.set(A.index,R),o.set(A.normal,C),l.set(A.uv,2*C/3),I[S]={positionStart:C,positionCount:w,indexStart:R,indexCount:B,uvStart:2*C/3,uvCount:2*w/3},this.descriptor.setToGeometryIdMap(t,S),this.descriptor.setToBufferDataObjectIdMap(S,t)}T={index:new Uint32Array(s),position:new Float32Array(a),normal:new Float32Array(o),uv:new Float32Array(l)}}else{for(s=new Uint32Array(f),a=new Float32Array(m),o=new Float32Array(m),i=0,n=p.length;i<n;i++){var A;S=(A=p[i]).meshId,C=A.positionOffset,R=A.indexOffset,w=A.position.length,B=A.index.length;for(A.index instanceof Uint16Array&&(A.index=Uint32Array.from(A.index)),d=0,h=A.index.length;d<h;d++)A.index[d]+=C/3;a.set(A.position,C),s.set(A.index,R),o.set(A.normal,C),I[S]={positionStart:C,positionCount:w,indexStart:R,indexCount:B},this.descriptor.setToGeometryIdMap(t,S),this.descriptor.setToBufferDataObjectIdMap(S,t)}T={index:new Uint32Array(s),position:new Float32Array(a),normal:new Float32Array(o)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:T,positionOffsetMap:I}),c=null}_parseMpk(e,t){var i,n,a,s,o=new r.Loader.BMPKReader(e),l={},d={};if(o.tBuffer.byteLength){for(i=0,n=o.header.meshCount;i<n;++i)l[s=(a=o.getMeshData(i)).mesh_id]={positionStart:a.vOffset/4,positionCount:3*a.ptCount,indexStart:a.iOffset/4,indexCount:a.idxCount,uvStart:a.tOffset/4,uvCount:2*a.ptCount},this.descriptor.setToGeometryIdMap(t,s),this.descriptor.setToBufferDataObjectIdMap(s,t);d={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer),uv:new Float32Array(o.tBuffer)}}else{for(i=0,n=o.header.meshCount;i<n;++i)l[s=(a=o.getMeshData(i)).mesh_id]={positionStart:a.vOffset/4,positionCount:3*a.ptCount,indexStart:a.iOffset/4,indexCount:a.idxCount},this.descriptor.setToGeometryIdMap(t,s),this.descriptor.setToBufferDataObjectIdMap(s,t);d={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:d,positionOffsetMap:l}),o=null}}r.ModelView.IncrementBatchedLoader=e}(),function(){let e=new THREE.Vector3,t=new THREE.Vector3;class i extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.nodePriority={high:[],medium:[],low:[]},this.visibleOctant=[],this.occlusionVisibleOctant=[],this.usedNodeInfosObject={},this.lineNodes={},this.blinkMaterials=[],this.activeMeshMap={}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}update(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}cullNodes(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var i=0;i=r.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,i)}getPriorityNodes(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}_cullNodesWithInnerAndOuterOctree(e,t){var i=0,r=0,n=e.getModelDescriptor().getOctreeRootNode(),a=n.inner,s=n.outer;if(this.manager.getContainsCamera(e)||!s)return this.visibleOctant.length=0,a&&this._frustumCull(e,t,a),s&&this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,r)),i;s&&(this.visibleOctant.length=0,this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!1,i,r)));var o=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||o._hasRenderPromotionFilter())&&a&&(this.visibleOctant.length=0,this._frustumCull(e,t,a),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),i=this._logicCull(e,!0,!1,i,r))),i}_cullNodesWithLayerOctree(e,t){var i=0;this.visibleOctant.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;this._frustumCull(e,t,r);var n=this.visibleOctant.length;return n>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,n)),i}_cullNodesWithOctant(e,t){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}_cullNodesWithFull(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}_calcPrioritizedNodeCount(e,t){var i=t+this.nodePriority.high.length+this.nodePriority.medium.length;return i>this.manager.getRenderableCount(e)&&(i=this.manager.getRenderableCount(e)),i}_updateMeshNodes(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var i=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],n=null;i[0].length>0&&(n=e.selectedMaterial);var a=e.getFilter()._hasOverrideMaterialFilter(),s={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,l=0,d=0,h=i.length;d<h;++d)for(var c=i[d],u=0,p=Object.keys(c).length;u<p&&!(o>t);++u){l++;var m,f=c[u];m=0===d?this._getUsableMaterial(e,f,n,a):this._getUsableMaterial(e,f,null,a);var g=!f.instanceOrNot;if(r.ModelView.BaseDescriptor.isLineNode(f))this._dealLineSegments(e,f,g,m);else{var v=e.pool.counter;this._dealMeshes(e,f,g,m,s);var y=e.pool.counter-v;o+=y,t+=y-1}m=null}return n=null,i=null,l}_getUsableMaterial(e,t,i,n){var a=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):n&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[a]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}getMeshesByUserIds(e,t,i){const r=e.pool._pool,n=t.toString(),a=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==n||i.name==a){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}explode(e){for(var t=e.pool._pool,i=0;i<t.length;i++){var r=t[i],n=e.modelExplosion.getExplosionTranslation(r.name);r.translateZ(n.z),r.updateMatrix(),r.updateMatrixWorld()}}getGeometryByNodeInfo(e,t){var i=!!e.getModelDescriptor()._isParameterizedNodeType(t.geometryId),n=i?t.geometryId+"|"+t.nodeId:t.nodeId;if(this._hasGeometry(n))return this.getGeometryById(n);if(r.ModelView.BaseDescriptor.isLineNode(t))return this._createGeometryForLineNodeByNodeInfo(e,t);var a=i?this._createGeometryForParameterizedNodeByNodeInfo(e,t):this._createGeometryByNodeInfo(e,t);return a?(this._cacheGeometry(n,a),a):null}_createGeometryForParameterizedNodeByNodeInfo(e,t){if(t.instanceOrNot)return null;var i=e.getModelDescriptor().getBufferDataObjectByGeometryId(t.geometryId);if(!i)return null;if(!t.uvArrayBuffer)return i.geometry;var r=[],n=i.geometry;n instanceof Array||(n=[n]);for(var a=new THREE.Matrix3,s=new THREE.Vector3,o=t.uvArrayBuffer,l=0,d=n.length;l<d;l++){var h=new THREE.BufferGeometry;h.setIndex(n[l].index),h.setAttribute("position",n[l].attributes.position),h.setAttribute("normal",n[l].attributes.normal),a.set(o[6*l],o[6*l+2],o[6*l+4],o[6*l+1],o[6*l+3],o[6*l+5],0,0,1);for(var c=[],u=n[l].attributes.uv.array,p=0,m=u.length;p<m;p+=2)s.set(u[p],u[p+1],1),s.applyMatrix3(a),c.push(s.x),c.push(s.y);h.setAttribute("uv",new THREE.Float32BufferAttribute(c,2)),r.push(h)}return r}_createGeometryByNodeInfo(e,t){var i=t.geometryId,r=e.getModelDescriptor().getBufferDataObjectByGeometryId(i);if(!r)return null;var n=new THREE.BufferGeometry;n.setIndex(r.geometry.getIndex()),n.setAttribute("position",r.geometry.getAttribute("position"));var a=r.geometry.getAttribute("normal");a&&n.setAttribute("normal",a);var s=r.geometry.getAttribute("uv");s&&n.setAttribute("uv",s);var o=r.getPositionAndIndexOffset(i);return n.setDrawRange(o.indexStart,o.indexCount),n._withDrawRange=!0,n._positionOffset=o,n}_createGeometryForLineNodeByNodeInfo(e,t){return this._createGeometryByNodeInfo(e,t)}_dealMeshes(e,t,i,n,a){let s=this.getGeometryByNodeInfo(e,t);if(!s)return;s instanceof Array||(s=[s]);const o=e.pool,l=this._getNodeGroupRenderOrder(t,n);for(var d=0,h=s.length;d<h;d++){const a=o.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:s[d],matrix:t.matrix,material:n,groupOrder:l.groupRenderOrder,renderOrder:l.renderOrder,visible:i});a&&(a.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,a),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObjectWithDrawRange(t.nodeId,a)))}}_dealLineSegments(e,t,i,n){var a=this.getGeometryByNodeInfo(e,t);if(a){var s=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||((o=new r.LineSegmentsEx(a,n)).databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,t.matrix&&(o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1),this.lineNodes[t.nodeId]=o),o.material=n,o.visible=i,s.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,new r.SingleCapsuleObject(o))}}_frustumCull(i,n,a){var s=i.manager,o=n.getFrustum(),l=r.GlobalData.OctantDepth,d=n.projScreenMatrix,h=new THREE.Box3;function c(i,r,n,a,s){var o;if(r&&i.depth<n&&(h.set(i.min,i.max),o=r.intersectsBox(h)),o){if(a){var l=h.applyMatrix4(d),u=l.getSize(e).length();l.getCenter(t);var p=t.z;p=p>1e-6?p:1e-6,i.priority=u/p,s.push(i)}else s.push(i);for(var m=0,f=i.childOctants.length;m<f;++m)c(i.childOctants[m],r,n,a,s)}}(r.GlobalData.DEBUG&&s.showOctreeBox(a),c(a,o,l,!0,this.visibleOctant),r.GlobalData.OcclusionTranslucentEnabled)&&c(a,this.manager.getFrustumFromOcclusionCamera(),l,!1,this.occlusionVisibleOctant);return!0}_logicCull(e,t,i,n,a){var s=e.manager,o=e.getFilter(),l=o._hasHiddenFileIdFilter(),d=o._hasOverrideMaterialFilter(),h=s.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),u=this.nodePriority.high,p=this.nodePriority.medium,m=this.nodePriority.low,f=this.nodePriority.low.length,g=e.getModelDescriptor().getNodeInfosWithCellId();function v(t,i){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(l&&o._isHiddenFileId(t)||!1===o._isVisible(t)))if(h.hasOwnProperty(t.userId)||d&&o._hasHighPriorityOverrideMaterial(t))u.push(t);else{var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),i){var a=t.userData,s=a?a.categoryId:void 0;s&&i[s]&&(r=!0)}r?p.push(t):n<f&&(m[n]=t,n++)}}var y=s.getCategoriesFromHighPriority("outer");!0===i&&(y=s.getCategoriesFromHighPriority("inner"));for(var M,E=0,x=0;x<a;++x){var _,b=0;t?(_=this.visibleOctant[x].octantId,b=this.visibleOctant[x].depth):_=x;var I=g[_];if(I){var T=this._getUsedNodeInfosByCellId(_);if(!T){for(M=0,E=I.length;M<E;++M){(C=I[M]).octantId=_,C.cellDepth=b,this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(_,C)}T=this._getUsedNodeInfosByCellId(_)}if(T){var S=T.default;for(M=0,E=S.length;M<E;M++){var C;v(C=S[M],y)}}}}return r.Logger.timeEnd("collectNodeInfo"),n}_clearUsedNodeInfosObject(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}_getUsedNodeInfosByCellId(e){return this.usedNodeInfosObject[e]}_cacheUsedNodeInfosByCellId(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}_isSatisfied(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_logicCullWithFull(e,t){return this._logicCull(e,!1,!0,0,t)}_sortVisibleOctant(e,t){var i=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var n=new r.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);i=n.getAncestorAndNeighbors()}this.visibleOctant.sort((function(e,t){if(null!=i){if(null!=i[e.octantId])return-1;if(null!=i[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0}))}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,n=this.occlusionVisibleOctant.length;if(n>0)for(var a=e.manager.getFrustumFromOcclusionCamera(),s=0;s<n;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,a)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var n=e.manager.acquireMaterial(),a=n.material;i.color?a.color.copy(i.color):n.resetColor(),a.opacity=r.GlobalData.OcclusionOpacity,t.material=a,t.material.needsUpdate=!0}}_clearNodePriorityData(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}_adjustLowNodePriorityLength(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}_clearLineSegmentsNodeGroup(e){this._getLineSegmentsNodeGroup(e).clear()}_getLineSegmentsNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}getBlinkMaterials(){return this.blinkMaterials}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var n=[],a=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else n.push({isLines:h,databagId:a,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return n}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var n=e[i];if(this.activeMeshMap[n])for(var a=Object.keys(this.activeMeshMap[n]),s=0,o=a.length;s<o;s++){var l=a[s];t(n,l,this.activeMeshMap[n][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementBatchedMeshManager=i}(),r.ModelView.IncrementBatchedWireFrameManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearWireframeLineMeshes(),this._disposeGeometries()}update(e,t){0!==t?this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e):this._clearWireframeGroupNode(e)}_disposeGeometries(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}_disposeGeometry(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}_clearWireframeLineMeshes(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}_clearWireframeGroupNode(e){this._getWireWireframeGroupNode(e).clear()}_removeWireframeGroupNode(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}isActivateWireframe(e){return e.isActivateWireframe()}_getWireWireframeGroupNode(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_buildGeometryEdge(e){var t,i=e.attributes.position.array,n=e.index.array;if(e._withDrawRange){var a=e._positionOffset,s=n.slice(a.indexStart,a.indexStart+a.indexCount),o=i.slice(a.positionStart,a.positionStart+a.positionCount),l=a.positionStart/3;s.forEach((function(e,t,i){i[t]-=l})),(t=r.BuildEdge(o,s)).forEach((function(e,t,i){i[t]+=l}))}else t=r.BuildEdge(i,n);return t}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];Array.isArray(t)||(t=[t]);for(var i,r=[],n=0,a=t.length;n<a;n++){var s=t[n],o=this._buildGeometryEdge(s);(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(o,1)),i.setAttribute("position",s.getAttribute("position")),r.push(i)}return this.wireframeGeometryMap[e]=r,this.wireframeGeometryMap[e]}_makeWireframeLineMeshes(e,t,i){if(!r.ModelView.BaseDescriptor.isLineNode(t)){var n=this.wireframeLineMeshes[t.nodeId];if(!n){n=this.wireframeLineMeshes[t.nodeId]=[];for(var a=this._getWireframeGeometryByNodeInfo(e,t),s=0,o=a.length;s<o;s++){var l=new THREE.LineSegments(a[s],this._getWireframeMaterial(e));l.name=t.nodeId+"_"+s,l.applyMatrix4(t.matrix),n.push(l)}}var d=!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return!(r.GlobalData.Instance&&(e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX||e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M)||(t.getWireFrameVisibilityCondition()?!t._isRenderWithWireFrame(e):t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e)))}(t,this._getFilter(e));if(d)for(var h=0,c=n.length;h<c;h++)i.add(n[h])}}_generateWireframeNodes(e,t){for(var i=this._getWireWireframeGroupNode(e),r=this.manager.getPriorityNodes(),n=0,a=0,s=r.length;a<s;++a)for(var o=r[a],l=0,d=Object.keys(o).length;l<d&&!(++n>t);++l){var h=o[l];this._makeWireframeLineMeshes(e,h,i)}}_getWireframeGroupName(e){return e._getWireframeGroupName()}_getWireframeMaterial(e){return e.getWireframeMaterial()}_getFilter(e){return e.getFilter()}explode(e){for(var t=new THREE.Matrix4,i=e.getModelDescriptor().getAllNodeInfos(),r=Object.keys(i),n=0,a=r.length;n<a;n++){var s=r[n],o=i[s],l=e.modelExplosion.getExplosionTranslation(s);t.makeTranslation(l.x,l.y,l.z);for(var d=0,h=o.length;d<h;d++){var c=this.wireframeLineMeshes[o[d].nodeId];if(c)for(var u=0;u<c.length;u++)c[u].applyMatrix4(t)}}}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.IncrementBatchedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementBatchedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementBatchedWireFrameManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}cullNodes(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}updateNodes(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getPriorityNodes(){return this.meshManager.getPriorityNodes()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getRenderableCount(e){return e.getRenderableCount()}getLoader(e){return e.getLoader()}getContainsCamera(e){return e.containsCamera}getFilter(e){return e.getFilter()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}isHiddenNode(e){return!1}isParameterizedNode(e){}},function(){class e extends r.ModelView.InstancedMeshManager{constructor(e){super(e)}}r.ModelView.IncrementInstanceBatchedMeshManager=e}(),function(){class e extends r.ModelView.InstancedWireframeManager{constructor(e){super(e)}}r.ModelView.IncrementInstanceBatchedWireFrameManager=e}(),function(){class e extends r.ModelView.InstancedBaseManager{constructor(){super(),this.meshManager=new r.ModelView.IncrementInstanceBatchedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementInstanceBatchedWireFrameManager(this)}}r.ModelView.IncrementInstanceBatchedManager=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=new r.ModelView.IncrementBatchedManager,this.instancedManager=new r.ModelView.IncrementInstanceBatchedManager,this.loader=new r.ModelView.IncrementBatchedLoader(this)}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this,i=this.model.getModelDescriptor().getInstancedUserIds();if(0===i.length)return t.loaded=!0,void(e&&e());r.Utils.asyncProcess(i,i.length,500,(function(e,i){t.instancedManager.meshManager._createInstanceGeometries(t.model,[e[i]])}),(function(){t.instancedManager.meshManager._makeInstanceNodes(t.model),t.loaded=!0,e&&e()}))}disposeBufferAfterVbo(){}}r.ModelView.IncrementBatchedHandler=e}(),(()=>{let e=new THREE.Vector3;r.OctantNeighborUtil=function(e,t){this.camera=e,this.root=t,this.searchNeighborOfNeighbor=!1,this.containChildOfNeighbor=!1,this.containedOctants=[],this.father=function(e){return++e<this.containedOctants.length?this.containedOctants[e]:null},this.adjFace=function(e,t){return i[8*e+t]},this.adjEdge=function(e,t){return r[8*e+t]},this.adjVertex=function(e,t){return e==t},this.refelectFace=function(e,t){return n[8*e+t]},this.refelectEdge=function(e,t){return a[8*e+t]},this.refelectVertex=function(e,t){return this.OctType.MAXTYPEID-t},this.common_face_edge=function(e,t){return s[8*e+t]},this.common_face_vertex=function(e,t){return o[8*e+t]},this.common_edge=function(e,t){return l[8*e+t]},this.son=function(e,t){var i,r=e.childOctants.length;for(i=0;i<r;i++)if(e.childOctants[i].octType==t)return e.childOctants[i];return null},this.FaceType={L:0,R:1,D:2,U:3,B:4,F:5,UNKNOWN:6},this.EdgeType={LD:0,LU:1,LB:2,LF:3,RD:4,RU:5,RB:6,RF:7,DB:8,DF:9,UB:10,UF:11,UNKNOWN:12},this.OctType={RUF:0,LUF:1,RDF:2,LDF:3,RUB:4,LUB:5,RDB:6,LDB:7,MAXTYPEID:7};var i=[!1,!0,!1,!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!0,!0,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1],r=[!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1],n=[1,0,3,2,5,4,7,6,1,0,3,2,5,4,7,6,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3],a=[3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1],s=[6,0,2,6,6,0,2,6,3,6,6,0,3,6,6,0,6,0,6,0,4,6,4,6,5,6,5,6,6,0,6,0,1,6,6,2,1,6,6,2,6,3,1,6,6,3,1,6,1,6,1,6,6,4,6,4,6,5,6,5,1,6,1,6,6,6,2,2,4,4,6,6,5,5,6,6,6,6,2,2,3,3,6,6,6,6,4,4,6,6,5,5,3,3,6,6],o=[6,6,6,5,6,3,1,6,6,6,5,6,3,6,6,0,6,5,6,6,1,6,6,2,5,6,6,6,6,0,2,6,6,3,1,6,6,6,6,4,3,6,6,0,6,6,4,6,1,6,6,2,6,4,6,6,6,0,2,6,1,6,6,6],l=[12,11,7,12,5,12,12,12,11,12,12,3,12,1,12,12,7,12,12,9,12,12,4,12,12,3,9,12,12,12,12,0,5,12,12,12,12,10,6,12,12,1,12,12,10,12,12,2,12,12,4,12,6,12,12,8,12,12,12,0,12,2,8,12]},r.OctantNeighborUtil.prototype.findFaceNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,n=r[e];if(e>=r.length)return i;if(this.father(e)&&this.adjFace(t,n.octType)?i=this.findFaceNeighborImpl(e+1,t):(i.node=this.father(e),i.cont=!0),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectFace(t,n.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findFaceNeighbor=function(e,t){var i=this.findFaceNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findEdgeNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,n=r[e];if(e>=r.length)return i;if(this.father(e)&&(this.adjEdge(t,n.octType)?i=this.findEdgeNeighborImpl(e+1,t):this.common_face_edge(t,n.octType)!==this.FaceType.UNKNOWN?i=this.findFaceNeighborImpl(e+1,this.common_face_edge(t,n.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectEdge(t,n.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findEdgeNeighbor=function(e,t){var i=this.findEdgeNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findVertexNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,n=r[e];if(e>=r.length)return i;if(this.father(e)&&(this.adjVertex(t,n.octType)?i=this.findVertexNeighborImpl(e+1,t):this.common_edge(t,n.octType)!==this.EdgeType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_edge(t,n.octType)):this.common_face_vertex(t,n.octType)!=this.FaceType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_face_vertex(t,n.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectVertex(t,n.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findVertexNeighbor=function(e,t){var i=this.findVertexNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findContainNode=function(e){var t,i=this.camera.position;if(!(i.x<e.min.x||i.x>e.max.x||i.y<e.min.y||i.y>e.max.y||i.z<e.min.z||i.z>e.max.z)){var r,n;if(0!=e.childOctants.length)for(r=0,n=e.childOctants.length;r<n&&(t=e.childOctants[r],!this.findContainNode(t));++r);return this.containedOctants.push(e),!0}return!1},r.OctantNeighborUtil.prototype.findNeighborNode=function(){var t,i=this.searchNeighborOfNeighbor,r=this.containChildOfNeighbor,n=this.camera,a=this.containedOctants,s=this.OctType,o=this.EdgeType,l=[];if(0==a.length)return l;var d,h,c,u,p,m,f,g,v=n.frustum,y=a[0];f=y.min,g=y.max;var M=n.target,E=n.position,x=new THREE.Vector3(M.x-E.x,M.y-E.y,M.z-E.z),_=new THREE.Ray(E,x),b=[],I=new THREE.Box3(f,g),T=_.intersectBox(I,e);if(T&&(T.y==f.y||T.y==g.y?T.x<=g.x&&T.x>=f.x&&T.z<=g.z&&T.z>=f.z&&(T.y==f.y?b.push(2):b.push(3)):T.z==f.z||T.z==g.z?T.x<=g.x&&T.x>=f.x&&T.y<=g.y&&T.y>=f.y&&(T.z==f.z?b.push(4):b.push(5)):T.x!=f.x&&T.x!=g.x||T.z<=g.z&&T.z>=f.z&&T.y<=g.y&&T.y>=f.y&&(T.x==f.x?b.push(0):b.push(1))),0==b.length)return l;u=g.x-f.x,(p=g.y-f.y)>u&&(u=p),(m=g.z-f.z)>u&&(u=m);var S=u,C=new THREE.Vector3;for(d=0;d<6;d++)if(d!=b[0]){switch(C.copy(y.center),d){case 0:C.x-=S;break;case 1:C.x+=S;break;case 2:C.y-=S;break;case 3:C.y+=S;break;case 4:C.z-=S;break;case 5:C.z+=S}var w=S/2,R=new THREE.Box3(new THREE.Vector3(C.x-w,C.y-w,C.z-w),new THREE.Vector3(C.x+w,C.y+w,C.z+w));v.intersectsBox(R)&&b.push(d)}if(b.length>1&&b.sort(),b.length>2){var B=0;for(d=0;d<b.length;d++)for(h=d+1;h<b.length;h++)for(c=h+1;c<b.length;c++){if(1==b[d]&&3==b[h]&&5==b[c])B=s.RUF;else if(0==b[d]&&3==b[h]&&5==b[c])B=s.LUF;else if(1==b[d]&&2==b[h]&&5==b[c])B=s.RDF;else if(0==b[d]&&2==b[h]&&5==b[c])B=s.LDF;else if(1==b[d]&&3==b[h]&&4==b[c])B=s.RUB;else if(0==b[d]&&3==b[h]&&4==b[c])B=s.LUB;else if(1==b[d]&&2==b[h]&&4==b[c])B=s.RDB;else{if(0!=b[d]||2!=b[h]||4!=b[c])continue;B=s.LDB}(t=this.findVertexNeighbor(0,B))&&(l.push(t),r&&this.getChildOfOctant(t,2,B,l),i&&(t=this.getNeighborOfSecondLevel(t,2,B))&&l.push(t))}}if(b.length>1){var A=0;for(d=0;d<b.length;d++)for(h=d+1;h<b.length;h++){if(0==b[d]&&2==b[h])A=o.LD;else if(0==b[d]&&3==b[h])A=o.LU;else if(0==b[d]&&4==b[h])A=o.LB;else if(0==b[d]&&5==b[h])A=o.LF;else if(1==b[d]&&2==b[h])A=o.RD;else if(1==b[d]&&3==b[h])A=o.RU;else if(1==b[d]&&4==b[h])A=o.RB;else if(1==b[d]&&5==b[h])A=o.RF;else if(2==b[d]&&4==b[h])A=o.DB;else if(2==b[d]&&5==b[h])A=o.DF;else if(3==b[d]&&4==b[h])A=o.UB;else{if(3!=b[d]||5!=b[h])continue;A=o.UF}(t=this.findEdgeNeighbor(0,A))&&(l.push(t),r&&this.getChildOfOctant(t,1,A,l),i&&(t=this.getNeighborOfSecondLevel(t,1,A))&&l.push(t))}}for(d=0;d<b.length;d++)(t=this.findFaceNeighbor(0,b[d]))&&(l.push(t),r&&this.getChildOfOctant(t,0,b[d],l),i&&(t=this.getNeighborOfSecondLevel(t,0,b[d]))&&l.push(t));return l.sort((function(e,t){return e.octantId<t.octantId?-1:1})),l},r.OctantNeighborUtil.prototype.getChildOfOctant=function(e,t,i,r){if(!(0==e.childOctants.length||e.depth<4)){var n=this.FaceType,a=[];switch(t){case 0:a.push(i%2==0?i+1:i-1);break;case 1:var s=this.EdgeType;switch(i){case s.LD:a.push(n.R),a.push(n.U);break;case s.LU:a.push(n.R),a.push(n.D);break;case s.LB:a.push(n.R),a.push(n.F);break;case s.LF:a.push(n.R),a.push(n.B);break;case s.RD:a.push(n.L),a.push(n.U);break;case s.RU:a.push(n.L),a.push(n.D);break;case s.RB:a.push(n.L),a.push(n.F);break;case s.RF:a.push(n.L),a.push(n.B);break;case s.DB:a.push(n.U),a.push(n.F);break;case s.DF:a.push(n.U),a.push(n.B);break;case s.UB:a.push(n.D),a.push(n.F);break;case s.UF:a.push(n.D),a.push(n.B)}break;case 2:var o=this.OctType;switch(i){case o.RUF:a.push(n.L),a.push(n.D),a.push(n.B);break;case o.LUF:a.push(n.R),a.push(n.D),a.push(n.B);break;case o.RDF:a.push(n.L),a.push(n.U),a.push(n.B);break;case o.LDF:a.push(n.R),a.push(n.U),a.push(n.B);break;case o.RUB:a.push(n.L),a.push(n.D),a.push(n.F);break;case o.LUB:a.push(n.R),a.push(n.D),a.push(n.F);break;case o.RDB:a.push(n.L),a.push(n.U),a.push(n.F);break;case o.LDB:a.push(n.R),a.push(n.U),a.push(n.F)}}for(var l=0;l<a.length;l++)this.getFaceChildOfOctant(e,a[l],r)}},r.OctantNeighborUtil.prototype.getFaceChildOfOctant=function(e,t,i){for(var r,n,a=0,s=e.childOctants.length;a<s;a++)if(r=e.childOctants[a],this.adjFace(t,r.octType))i.push(r),this.getFaceChildOfOctant(r,t,i);else{n=this.refelectFace(t,r.octType);for(var o=0;o<s&&e.childOctants[o].octType!=n;o++);o==s&&(i.push(r),this.getFaceChildOfOctant(r,t,i))}},r.OctantNeighborUtil.prototype.getNeighborOfSecondLevel=function(e,t,i){var n=[],a=[];a[0]=e,this.getAncestorNodes(this.root,a,0,[],n);var s=new r.OctantNeighborUtil(this.camera,this.root);s.containedOctants=n;var o=null;switch(t){case 0:o=s.findFaceNeighbor(0,i);break;case 1:o=s.findEdgeNeighbor(0,i);break;case 2:o=s.findVertexNeighbor(0,i)}return o},r.OctantNeighborUtil.prototype.getAncestorAndNeighbors=function(){this.searchNeighborOfNeighbor=!0,this.containChildOfNeighbor=!0;var e=this.containedOctants;this.findContainNode(this.root);var t=this.findNeighborNode(this.camera,e),i=[];this.getAncestorNodes(this.root,t,0,[],i);var r,n,a={};for(r=0,n=e.length;r<n;r++)a[e[r].octantId]=1;for(r=0,n=t.length;r<n;r++)a[t[r].octantId]=1;for(r=0,n=i.length;r<n;r++)a[i[r].octantId]=1;return a},r.OctantNeighborUtil.prototype.getAncestorNodes=function(e,t,i,r,n){var a,s,o;for(a=0,s=e.childOctants.length;a<s&&i<t.length;a++){if(o=e.childOctants[a],r.push(o),o.octantId==t[i].octantId){for(var l=r.length-1;l>=0;l--)n.push(r[l]);i++}else(a==s-1||e.childOctants[a+1].octantId>t[i].octantId)&&(i=this.getAncestorNodes(o,t,i,r,n));r.pop()}return i},r.OctantNeighborUtil.prototype.outputOctants=function(e,t){console.group(),console.log("Node that contains camera: %d",t.octantId);var i="",r=0;for(var n in e)i+=n,i+="  ",r%9==0&&(i+="\n"),r++;console.log("nodes: %s",i),console.groupEnd()},r.OctantNeighborUtil.prototype.outputOctree=function(e,t){var i;console.group();var r="";for(i=0;i<e.depth;i++)r+="  ";console.log("%sNode id: %i, depth: %i, octType: %i, parent: %i",r,e.octantId,e.depth,e.octType,t),console.log("%s  size: %f, center: %f, %f, %f",r,e.size,e.center.x,e.center.y,e.center.z),console.log("%s  child number: %i",r,e.childOctants.length);var n="";for(i=0;i<e.childOctants.length;i++)n+=e.childOctants[i].octantId,n+="  ";for(console.log("%s  children: %i",r,n),i=0;i<e.childOctants.length;i++)this.outputOctree(e.childOctants[i],e.octantId);console.groupEnd()}})(),r.Loader.OctreeNode=function(e,t){void 0===e&&alert("Invalid Octant Id"),this.octantId=e,this.childOctants=new Array,this.min=null,this.max=null,this.depth=t||0,this.center=null,this.size=-1,this.priority=-1,this.octType=-1},r.Loader.OctreeNode.prototype.isRoot=function(){return 0==this.depth},r.Loader.OctreeNode.prototype.add=function(e){e.depth=this.depth+1,this.childOctants.push(e)},r.Loader.OctreeNode.prototype.updateMaxDepth=function(){this.depth>r.GlobalData.MaximumDepth&&(r.GlobalData.MaximumDepth=this.depth)},function(){let e=new THREE.Vector3;r.OctantManager=class{constructor(){this.visibleOctantList=[]}destroy(){this.visibleOctantList=null}_getVisibleOctantsWithInnerAndOuterOctree(e,t,i){this.visibleOctantList.length=0;var n=e.getModelDescriptor().getOctreeRootNode(),a=n.inner,s=n.outer;if(!a&&!s)return[];var o=null;if(e.containsCamera)a&&(o=new r.OctantNeighborUtil(t,a).getAncestorAndNeighbors(),this._frustumCull(t,a,i,this.visibleOctantList)),s&&this._frustumCull(t,s,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList,o);else{var l=[],d=[];s&&(this._frustumCull(t,s,!0,l),this._sortOctantList(l,o)),a&&(o=new r.OctantNeighborUtil(t,a).getAncestorAndNeighbors(),this._frustumCull(t,a,i,d),this._sortOctantList(d,o));var h,c=l.length,u=d.length;for(h=0;h<c;h++)this.visibleOctantList[h]=l[h];for(h=0;h<u;h++)this.visibleOctantList[c+h]=d[h]}return this.visibleOctantList}_getVisibleOctantsWithLayerOctree(e,t,i){this.visibleOctantList.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;return this._frustumCull(t,r,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList),this.visibleOctantList}getVisibleOctants(e,t,i){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._getVisibleOctantsWithInnerAndOuterOctree(e,t,i):this._getVisibleOctantsWithLayerOctree(e,t,i)}_sortOctantList(e,t){e.sort((function(e,i){if(null!=t){if(null!=t[e.octantId])return-1;if(null!=t[i.octantId])return 1}return e.priority>i.priority?-1:e.priority<i.priority?1:0}))}showOctreeBox(e){if(r.GlobalData.DEBUG){var t=e.getModelDescriptor().getOctreeRootNode();e.getModelDescriptor().isUseInnerAndOuterOctree()?(t.inner&&e.manager.showOctreeBox(t.inner),t.outer&&e.manager.showOctreeBox(t.outer)):t.layer&&e.manager.showOctreeBox(t.layer)}}_frustumCull(t,i,n,a){var s=t.getFrustum(),o=r.GlobalData.OctantDepth,l=t.projScreenMatrix,d=new THREE.Box3,h=1e-6;!function t(i,r,n,a,s){var o;if(r&&i.depth<n&&(d.set(i.min,i.max),o=r.intersectsBox(d)),o){if(a){var c=d.applyMatrix4(l),u=c.getCenter(e).z;u=u>h?u:h;var p=c.getSize(e).length();i.priority=p/u,s.push(i)}else s.push(i);for(var m=0,f=i.childOctants.length;m<f;++m){t(i.childOctants[m],r,n,a,s)}}}(i,s,o,n,a)}_traverseOctants(e,t){!function e(t,i){i.push(t);for(var r=0,n=t.childOctants.length;r<n;++r){e(t.childOctants[r],i)}}(e,t)}getAllOctants(e){var t=[],i=e.getModelDescriptor().getOctreeRootNode();return e.getModelDescriptor().isUseInnerAndOuterOctree()?(i.inner&&this._traverseOctants(i.inner,t),i.outer&&this._traverseOctants(i.outer,t)):i.layer&&this._traverseOctants(i.layer,t),t}}}(),r.MaterialSelector=class{constructor(){const e=[{name:"scene",param:{name:"scene",color:8947848,opacity:.4,transparent:!0,side:THREE.DoubleSide}},{name:"darkRed",param:{name:"darkRed",color:10496040,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"lightBlue",param:{name:"lightBlue",color:1275840,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"black",param:{name:"black",color:0,opacity:.3,transparent:!0,side:THREE.DoubleSide}},{name:"add",param:{name:"add",color:65280,opacity:1,transparent:!0,side:THREE.DoubleSide}},{name:"delete",param:{name:"delete",color:16711680,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"beforeEdit",param:{name:"beforeEdit",color:16432389,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"afterEdit",param:{name:"afterEdit",color:16432389,opacity:1,transparent:!0,side:THREE.DoubleSide}}];this._materials={},this._materials.selection=r.MaterialUtil.createHighlightMaterial(),this._materials.selection.name="selection",this._materials.selection.setDisableHemiLight(!0);for(let t=0,i=e.length;t<i;++t){const i=e[t],n=i.name,a=i.param;this._materials[n]=r.MaterialUtil.createStandardMaterial(a),this._materials[n].setDisableHemiLight(!0)}this._materials.red=this._materials.delete,this._materials.green=this._materials.add,this._materials.yellow=this._materials.beforeEdit,this._materials.blue=this._materials.selection,this._isolateMaterialDefaultParams={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},this._isolateMaterial=r.MaterialUtil.createStandardMaterial(this._isolateMaterialDefaultParams),this._isolateMaterial.name="isolate",this._isolateMaterial.setDisableHemiLight(!0),this._frozenMaterialDefaultParams={color:8947848,opacity:.4,transparent:!0,side:THREE.DoubleSide,useBCOutline:!0,borderLineVisible:!0},this._frozenMaterial=r.MaterialUtil.createStandardMaterial(this._frozenMaterialDefaultParams),this._frozenMaterial.name="frozen",this._frozenMaterial.setDisableHemiLight(!0),this._frozenMaterial.setUnLight(!0),this._frozenMaterialV3=r.MaterialUtil.createStandardMaterialV3(this._frozenMaterialDefaultParams),this._frozenMaterialV3.setBorderLineVisible(!1),this._frozenMaterialV3.name="frozen",this._frozenMaterialV3.setDisableHemiLight(!0),this._frozenMaterialV3.setUnLight(!0),this._frozenMaterialV3OneSide=this._frozenMaterialV3.clone(),this._frozenMaterialV3OneSide.side=0,this._frozenMaterialV3WithOutline=r.MaterialUtil.createStandardMaterialV3(this._frozenMaterialDefaultParams),this._frozenMaterialV3WithOutline.setBorderLineVisible(!0),this._frozenMaterialV3WithOutline.name="frozen",this._frozenMaterialV3WithOutline.setDisableHemiLight(!0),this._frozenMaterialV3WithOutline.setUnLight(!0),this._frozenMaterialV3WithOutlineOneSide=this._frozenMaterialV3WithOutline.clone(),this._frozenMaterialV3WithOutlineOneSide.side=0,this._selectedMaterialDefaultParams={color:15293,side:THREE.DoubleSide},this._selectedMaterial=r.MaterialUtil.createStandardMaterial(this._selectedMaterialDefaultParams),this._selectedMaterial.name="selected",this._selectedMaterial.setDisableHemiLight(!0),this._selectedMaterial.setUnLight(!0),this._instanceMaterialsForClip={},this._materialsForClip={},this._materialsForModifyOpacity={}}getDefaultMaterialName(){return"lightBlue"}get(e){return this._materials[e]}getAll(){return this._materials}add(e){let t,i,n={};return e&&e.hasOwnProperty("uuid")?(t="override_"+e.uuid,delete e.uuid,i=this._materials[t],i||(e.name=t,i=r.MaterialUtil.createStandardMaterial(e),i.setDisableHemiLight(!0),i.overrideColor=!0,this._materials[t]=i),t):(e&&e.hasOwnProperty("color")&&(n.color=e.color,e.hasOwnProperty("opacity")&&(n.opacity=e.opacity,n.transparent=1!=e.opacity),e.hasOwnProperty("map")&&(n.map=e.map,e.hasOwnProperty("bumpMap")&&(n.bumpMap=e.bumpMap))),t=this._getMaterialName(e),i=this._materials[t],i||(n.name=t,i=r.MaterialUtil.createStandardMaterial(n),i.setDisableHemiLight(!0),i.overrideColor=!0,this._materials[t]=i),e.useVertexColor&&(i.vertexColors=!0),t)}remove(e){let t,i;t=this._getMaterialName(e),i=this._materials[t],i&&delete this._materials[t]}has(e){return!!this._materials[e]}getMaterialNameByColor(e){let t,i;return t=this._getMaterialName(e),i=this._materials[t],i?t:this.add(e)}addOverrideMaterial(e){if(!e)return;const t=e.name;e.overrideColor=!0,this._materials[t]||(this._materials[t]=e)}getMaterialParamsFromName(e){let t={};const i=e.split("_");return"mat"==i[0]?(t.color=parseInt(i[1]),t.opacity=1):(t.color=parseInt(i[0]),t.opacity=parseFloat(i[1])),t}_getMaterialName(e){let t;return e&&e.hasOwnProperty("color")?(t=e.hasOwnProperty("opacity")?e.color+"_"+e.opacity:"mat_"+e.color,e.hasOwnProperty("map")&&(t+="_"+e.map.uuid),e.hasOwnProperty("setByOpacity")&&(t+="_opacity"),e.hasOwnProperty("useVertexColor")&&(t+="_"+e.useVertexColor)):t="mat_"+e,t}setFrozonMaterial(e){this._setFrozonMaterial(this._frozenMaterial,e),this._setFrozonMaterial(this._frozenMaterialV3,e),this._setFrozonMaterial(this._frozenMaterialV3WithOutline,e),this._setFrozonMaterial(this._frozenMaterialV3WithOutlineOneSide,e),this._setFrozonMaterial(this._frozenMaterialV3OneSide,e)}_setFrozonMaterial(e,t){void 0!==t.color?e.color.setHex(t.color):e.color.setHex(this._frozenMaterialDefaultParams.color),void 0!==t.opacity?e.opacity=t.opacity:e.opacity=this._frozenMaterialDefaultParams.opacity,void 0!==t.transparent?e.transparent=t.transparent:e.transparent=this._frozenMaterialDefaultParams.transparent,void 0!==t.side?e.side=t.side:e.side=this._frozenMaterialDefaultParams.side,e.needsUpdate=!0}getFrozonMaterial(){return this._frozenMaterial}getFrozonMaterials(){return[this._frozenMaterial]}getFrozonMaterialV3(e,t){return 1==e?0===t?this._frozenMaterialV3WithOutlineOneSide:this._frozenMaterialV3WithOutline:0===t?this._frozenMaterialV3OneSide:this._frozenMaterialV3}setSelectedMaterial(e){void 0!==e.color?this._selectedMaterial.color.setHex(e.color):this._selectedMaterial.color.setHex(this._selectedMaterialDefaultParams.color),void 0!==e.opacity?this._selectedMaterial.opacity=e.opacity:this._selectedMaterial.opacity=this._selectedMaterialDefaultParams.opacity,void 0!==e.transparent?this._selectedMaterial.transparent=e.transparent:this._selectedMaterial.transparent=this._selectedMaterialDefaultParams.transparent,void 0!==e.side?this._selectedMaterial.side=e.side:this._selectedMaterial.side=this._selectedMaterialDefaultParams.side,this._selectedMaterial.needsUpdate=!0}getSelectedMaterial(){return this._selectedMaterial}setIsolateMaterial(e){void 0!==e.color?this._isolateMaterial.color.setHex(e.color):this._isolateMaterial.color.setHex(this._isolateMaterialDefaultParams.color),void 0!==e.opacity?this._isolateMaterial.opacity=e.opacity:this._isolateMaterial.opacity=this._isolateMaterialDefaultParams.opacity,void 0!==e.transparent?this._isolateMaterial.transparent=e.transparent:this._isolateMaterial.transparent=this._isolateMaterialDefaultParams.transparent,void 0!==e.side?this._isolateMaterial.side=e.side:this._isolateMaterial.side=this._isolateMaterialDefaultParams.side,this._isolateMaterial.needsUpdate=!0}getIsolateMaterial(){return this._isolateMaterial}resetIsolateMaterial(){this._isolateMaterial.color.setHex(this._isolateMaterialDefaultParams.color),this._isolateMaterial.opacity=this._isolateMaterialDefaultParams.opacity,this._isolateMaterial.transparent=this._isolateMaterialDefaultParams.transparent,this._isolateMaterial.side=this._isolateMaterialDefaultParams.side,this._isolateMaterial.needsUpdate=!0}addInstanceMaterialForClip(e,t){void 0===this._instanceMaterialsForClip[e]&&(this._instanceMaterialsForClip[e]={}),this._instanceMaterialsForClip[e].instanceMaterial=t}getAllInstanceMaterialsForClip(){return this._instanceMaterialsForClip}clearInstanceMaterialsForClip(){this._instanceMaterialsForClip={}}addMaterialForClip(e){const t=this.getMaterialNameBy(e);let i=this._materialsForClip[t];if(!i){let n={};e.hasOwnProperty("color")&&(n.color=e.color),e.hasOwnProperty("opacity")&&(n.opacity=e.opacity,n.transparent=1!=e.opacity),e.hasOwnProperty("map")&&(n.map=e.map),n.side=r.Utils.isDefined(e.side)?e.side:THREE.DoubleSide,n.name=t,i=r.MaterialUtil.createStandardMaterial(n),i.setDisableHemiLight(!0),this._materialsForClip[t]=i}return i}getMaterialForClipBy(e,t){let i=this._materialsForClip[e];return i||t&&(i=t.clone(),i.name=e,this._materialsForClip[e]=i),i}getAllMaterialsForClip(){return this._materialsForClip}clearMaterialsForClip(){for(const e in this._materialsForClip)this._materialsForClip[e].dispose();this._materialsForClip={}}getMaterialForModifyOpacityBy(e,t){let i=this._materialsForModifyOpacity[e];return i||t&&(i=t.clone(),i.name=e,this._materialsForModifyOpacity[e]=i),i}clearMaterialsForModifyOpacity(){for(const e in this._materialsForModifyOpacity)this._materialsForModifyOpacity[e].dispose();this._materialsForModifyOpacity={}}getMaterialNameBy(e){let t="";return e.hasOwnProperty("color")&&(t+=e.color),e.hasOwnProperty("opacity")&&(t+="_"+e.opacity),e.hasOwnProperty("map")&&(t+="_"+e.map.uuid),t}getAllTypeMaterial(){let e=Object.values(this._materials);return e.push(this._isolateMaterial,this._frozenMaterial,this._selectedMaterial),e}getCustomizedMaterials(e){let t=Object.values(this._materials);const i=e.override;return t=t.filter((function(e){return i&&!0===e.overrideColor})),e.isolate&&t.push(this._isolateMaterial),e.frozen&&t.push(this._frozenMaterial),e.selected&&t.push(this._selectedMaterial),t}},function(){r.EnumConditionType={HIDDEN_OTHERS:0,TRANSLUCENT_OTHERS:1,OVERRIDE:2,BORDERLINE:3},r.EnumIdBasedType={FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6},r.EnumUserType={HIDDEN_DATA:0,OVERRIDE_DATA:1},r.EnumIsolateState={HIDDEN:0,HIDDEN_OTHERS:1,TRANSLUCENT:2,TRANSLUCENT_OTHERS:3},r.EnumSceneState={DISABLED:0,TRANSLUCENT:1,HIDDEN:2},r.EnumChangedState={NONE:-1,START:1,END:1e4};r.FilterManager=class{constructor(e){this.model=e,this.sceneStateHelper=null,this._filterImpl=new r.FilterManager2,this.filterActionList=[],this.isolateFilterAction=null,this.materialSelector=this._filterImpl.getMaterialSelector(),this.objectInfoManager=new r.ObjectInfoManager,this.filterManagerIO=new r.FilterManagerIO(this.materialSelector),this.observerForSceneState=null,this._stateChanged=!1,this._visibleStateChanged=!1,this._visibleStateActionMap={TransparentIdsFA:!0,TransparentConditionFA:!0,VisibleIdsFA:!0,VisibleConditionFA:!0},this._colorStateChanged=!1,this._colorStateActionMap={OverrideIdsFA:!0,OverrideConditionFA:!0}}destroy(){}setObserverForSceneState(e){this.observerForSceneState=e}setSceneStateHelper(e){this.sceneStateHelper=e}getFilterActionList(){return this.filterActionList}clearFilterActionList(){this.filterActionList=[]}initFilterManager(e){this.objectInfoManager.init(e)}reinitFilterManager(e){this.objectInfoManager.reinit(e)}clearFilterManager(){this.objectInfoManager.clearData()}isStateChanged(){return this._stateChanged}enableStateChanged(){this._stateChanged=!0}disableStateChanged(){this._stateChanged=!1}isVisibleStateChanged(){return this._visibleStateChanged}disableVisibleStateChanged(){this._visibleStateChanged=!1}enableVisibleStateChanged(){this._visibleStateChanged=!0}isColorStateChanged(){return this._colorStateChanged}disableColorStateChanged(){this._colorStateChanged=!1}enableColorStateChanged(){this._colorStateChanged=!0}getIsolateFilterAction(){return this.isolateFilterAction}setIsolateAction(e){this.isolateFilterAction=e,this.isolateFilterAction.apply()}getVisibleComponentsBbox(){return this.objectInfoManager.getVisibleComponentsBbox()}getIdsWithConditions(e){let t=[];var i=this.objectInfoManager.getObjectsMap();for(var r in i){for(var n=[],a=[],s=i[r],o=this.objectInfoManager.getObjectIds(r),l=0,d=o.length;l<d;l++){var h=o[l],c=s[h][0].userData||{};c.elementId=s[h][0].userId,this.objectInfoManager.isMatchConditions(c,e)?n.push(h):a.push(h)}t.push(n)}return t}pushBack(e){this.staticIsolateTimeStart();var t=e.getClassName();"IsolateIdsFA"==t||"IsolateConditionFA"==t?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[t]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[t]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilter(this.objectInfoManager,this),this.staticIsolateTimeEnd()}pushBackNoApply(e){var t=e.getClassName();"IsolateIdsFA"==t||"IsolateConditionFA"==t?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[t]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[t]&&this.enableColorStateChanged(!0)}pushBackByIds(e,t){this.staticOverrideTimeStart();var i=e.getClassName();"IsolateIdsFA"==i||"IsolateConditionFA"==i?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[i]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[i]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilterByIds(this.objectInfoManager,this,t),this.staticOverrideTimeEnd()}pushBackWithFilterMng(e){this.staticOverrideTimeStart();var t=e.getClassName();"IsolateIdsFA"==t||"IsolateConditionFA"==t?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[t]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[t]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilterWithFilterMng(this.objectInfoManager,this),this.staticOverrideTimeEnd()}staticOverrideTimeStart(){this.model instanceof r.BimTilesModel&&(this.staticOverrideTimeInit(),this.model.overrideColorInfoStatic.start())}staticOverrideTimeEnd(){this.model instanceof r.BimTilesModel&&this.model.overrideColorInfoStatic.end()}removeFilterActionByName(e){for(var t=0;t<this.filterActionList.length;){e==this.filterActionList[t].getClassName()?this.filterActionList.splice(t,1):t++}}showAll(){this.staticIsolateTimeStart(),this.removeFilterActionByName("VisibleIdsFA"),this.removeFilterActionByName("VisibleConditionFA"),this.objectInfoManager.clearVisible(),this.objectInfoManager.calculateVisibleComponentsBbox(),this.enableStateChanged(),this.enableVisibleStateChanged(!0),this.staticIsolateTimeEnd()}staticIsolateTimeStart(){this.model instanceof r.BimTilesModel&&this.model.changeStateTime.userIdInfoTimeStart()}staticIsolateTimeEnd(){this.model instanceof r.BimTilesModel&&this.model.changeStateTime.userIdInfoTimeEnd()}hideAll(){var e=new r.VisibleIdsFA(!1,!1);e.ids=[],this.pushBack(e)}getObjectInfoManager(){return this.objectInfoManager}getMatchIds(e){return this.objectInfoManager.getMatchIds(e)}_isVisible(e){var t=e.name;return!this.objectInfoManager.isHidden(t)}isHidden(e){return this.objectInfoManager.isHidden(e)}isFrozen(e){return this.objectInfoManager.isFrozen(e)}_isTransparent(e){var t=e.name;return this.objectInfoManager.isTransparent(t)}_isClipped(e){var t=e.name;return this.objectInfoManager.isClipped(t)}_isPickable(e){var t=e.name;return this.isComponentActive(t)&&!this.objectInfoManager.isFrozen(t)}_getOverrideMaterial(e){var t=e.name;return this._getOverrideMaterialById(t)}_getOverrideMaterials(e){var t=e.name;return this._getOverrideMaterialsById(t)}_getOverrideMaterialById(e){return this.objectInfoManager.isFrozen(e)?this._filterImpl.getFrozonMaterial():this.objectInfoManager.getMaterial(e)}_getOverrideMaterialsById(e){return this.objectInfoManager.isFrozen(e)?this._filterImpl.getFrozonMaterials():this.objectInfoManager.getMaterials(e)}_getMaterialName(e){return this._filterImpl._getMaterialName(e)}_getMaterialByName(e){return this._filterImpl._getMaterialByName(e)}_hasOverrideMaterial(e){var t=e.name;return this.objectInfoManager.hasOverrideMaterial(t)}_hasHighPriorityOverrideMaterial(e){return this._filterImpl._hasHighPriorityOverrideMaterial(e)}_isHiddenFileId(e){return this._filterImpl._isHiddenFileId(e)}_isRenderPromotion(e){return this._filterImpl._isRenderPromotion(e)}_isRenderWithBoardline(e){return this._filterImpl._isRenderWithBoardline(e)}_hasHiddenFileIdFilter(){return this._filterImpl._hasHiddenFileIdFilter()}_hasVisibleFilter(){return this.objectInfoManager.hasObjectHidden()}_hasPickableFilter(){return this.objectInfoManager.hasObjectCantSelected()}_hasTransparentFilter(){return this.objectInfoManager.hasObjectTransparent()}_hasClippingFilter(){return this.objectInfoManager.hasObjectClipped()}_hasOverrideMaterialFilter(){return this.objectInfoManager.hasOverrideMaterial()}_hasLowPriorityOverride(){return this._filterImpl._hasLowPriorityOverride()}_hasRenderPromotionFilter(){return this._filterImpl._hasRenderPromotionFilter()}_hasRenderWithBoardlineFilter(){return this._filterImpl._hasRenderWithBoardlineFilter()}saveState(){return this.filterManagerIO.saveState(this)}loadState(e){if(e.actions&&!(this instanceof r.BimTileFilterManager))for(const t of e.actions){let e=t.ids;"OverrideIdsFA"!=t.className&&"OverrideIdsForWireFrameFA"!=t.className||0!=e.length||(e=this.model.getAllUserIds(),t.manipulateAllElement=!0,t.ids=e)}this.filterManagerIO.loadState(e,this)}clear(){this.objectInfoManager.resetAll(),this._stateChanged=!0}clearAll(){return this.enableStateChanged(),this._filterImpl.clearAll()}clearIsolate(){this.objectInfoManager.clearIsolates()}clearFrozenList(){return this.enableStateChanged(),this._filterImpl.clearFrozenList()}addToFrozenList(e){return this.enableStateChanged(),this._filterImpl.addToFrozenList(e)}removeFromFrozenList(e){return this.enableStateChanged(),this._filterImpl.removeFromFrozenList(e)}setFrozenList(e){return this.enableStateChanged(),this._filterImpl.setFrozenList(e)}setFrozenConditions(e){this.enableStateChanged(),this._filterImpl.setFrozenConditions(e)}getFrozenConditions(){return this._filterImpl.getFrozenConditions()}clearFrozenConditions(){this.enableStateChanged(),this._filterImpl.clearFrozenConditions()}clearFrozen(){this.enableStateChanged(),this.clearFrozenList(),this.clearFrozenConditions()}clearAllIdList(){return this.enableStateChanged(),this._filterImpl.clearAllIdList()}clearIdList(e){return this.enableStateChanged(),this._filterImpl.clearIdList(e)}addToIdList(e,t){return this.enableStateChanged(),this._filterImpl.addToIdList(e,t)}removeFromIdList(e,t){return this.enableStateChanged(),this._filterImpl.removeFromIdList(e,t)}setIdList(e,t){return this.enableStateChanged(),this._filterImpl.setIdList(e,t)}clearAllOverrideList(){this.removeFilterActionByName("OverrideIdsFA"),this.removeFilterActionByName("OverrideConditionFA"),this.removeFilterActionByName("OverrideIdsForWireFrameFA"),this.removeFilterActionByName("OverrideConditionForWireFrameFA"),this.objectInfoManager.clearMaterial(),this.clearModifyOpacityList(),this.enableStateChanged()}clearAllComponentsOverrideList(){this.removeFilterActionByName("OverrideIdsFA"),this.removeFilterActionByName("OverrideConditionFA"),this.objectInfoManager.clearAllComponentsMaterial(),this.clearModifyOpacityList(),this.enableStateChanged()}clearOverrideList(e){return this.enableStateChanged(),this._filterImpl.clearOverrideList(e)}addToOverrideList(e,t,i){return this.enableStateChanged(),this._filterImpl.addToOverrideList(e,t,i)}removeFromOverrideList(e,t){return this.enableStateChanged(),this._filterImpl.removeFromOverrideList(e,t)}setOverrideList(e,t,i){return this.enableStateChanged(),this._filterImpl.setOverrideList(e,t,i)}addToOverrideListByColor(e,t){var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var a=new r.OverrideIdsFA(!0,i);a.ids=e,this.pushBackWithFilterMng(a)}staticOverrideTimeInit(){this.model.overrideColorInfoStatic.init()}findColorMap(e,t,i){let r={};for(let n=0;n<e.length;n++){let a={},s=!0;const o=e[n],l=t._handler.getGeometryBuffersByUserId(o),d=t.getFilter().getObjectInfoManager().getMaterials(o);if(d&&d.length>0)for(let e=0;e<l.length;e++){const t=l[e];let i=!1,r=null;for(let e=0;e<d.length;e++){r=d[e],r.originOpacity=r.opacity;let n=String(t.nodeId);if(i=!0,r.nodeIds&&r.nodeIds.includes(n))break}i&&(a[t.nodeId]={material:r,map:r.map})}else if(l&&l.length>0)for(let e=0;e<l.length;e++){const i=l[e],r=t.manager.getMaterialByNodeId(i.databagId,o,i.nodeId);a[i.nodeId]={material:r,map:r.map},r.dispose()}if(a)for(const e in a){const t=a[e],n=t.material.color.getHex();t.material.dispose();let l=n+"";t.map&&(l+="_"+t.map.uuid),l+="_opacity",r[l]?(r[l].ids.push(o),r[l].color.nodeIds.push(e)):(r[l]={color:{color:n,opacity:i,nodeIds:[e]},ids:[o]},r[l].color.setByOpacity=s,t.map&&(r[l].color.map=t.map)),t.map&&(t.map&&t.map.dispose(),t.map=null)}}return r}overrideComponentsOpacity(e,t,i,n){let a=[];if(n.forEach((e=>{let t=this._filterImpl.getMaterialNameByColor(e),i=this._filterImpl.getMaterialByName(t);e.nodeIds&&(i.nodeIds=e.nodeIds),a.push(i)})),"conditions"==e.type){let n=new r.OverrideConditionFA(!0);n.conditions=e.param,n.opacity=t,this.pushBackByArryOfIdsAndMaterial(n,i,a)}else{let n=new r.OverrideIdsFA(!0);n.ids=e.param,n.opacity=t,this.pushBackByArryOfIdsAndMaterial(n,i,a)}}pushBackByArryOfIdsAndMaterial(e,t,i){var r=e.getClassName();"IsolateIdsFA"==r||"IsolateConditionFA"==r?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[r]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[r]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilterByArryOfIdsAndMaterial(this.objectInfoManager,this,t,i)}addToOverrideListByOpacityAndConditions(e,t){var i=new r.OverrideConditionFA(!0);i.conditions=e,i.opacity=t,this.pushBackNoApply(i)}addToOverrideListByOpacity(e,t){var i=new r.OverrideIdsFA(!0);i.ids=e,i.opacity=t,this.pushBackNoApply(i)}addToOverrideListWithAllIdsByColor(e,t){this.staticOverrideTimeStart();var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var a=new r.OverrideIdsFA(!0,i);a.ids=[],this.pushBackByIds(a,e),this.staticOverrideTimeEnd()}addToOverrideListByConditions(e,t){this.staticOverrideTimeStart();var i=this;i.addToOpacityListByConditions(e,((n,a)=>{if(a){var s=null;if(t){var o=i._filterImpl.getMaterialNameByColor(t);"cloudStandard"!==(s=i._filterImpl.getMaterialByName(o)).type&&"cloudStandardV3"!=s.type||s.setDisableHemiLight(!0)}var l=new r.OverrideConditionFA(!0,s);l.conditions=e,i.pushBackByIds(l,n)}})),this.staticOverrideTimeEnd()}pushBackByMaterials(e,t){var i=e.getClassName();this.filterActionList.push(e),this._visibleStateActionMap[i]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[i]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilterByMaterials(this.objectInfoManager,this,t)}findMaterialWithModelByIds(e,t,i){let r=[];for(let n=0;n<i.length;n++){let a=!0;const s=i[n];let o=null,l=null;const d=e.getFilter().getObjectInfoManager().getMaterial(s);if(d)o=d,o.originOpacity=d.opacity,o.name.indexOf("_opacity")<0&&(a=!1),o.map&&(l=o.map);else{const t=e._handler.getGeometryBuffersByUserId(s);if(t&&t.length>0){l=null;for(let i=0;i<t.length;i++){const r=t[i],n=e.manager.getMaterialByNodeId(r.databagId,s,r.nodeId);if(n&&n.map){l=n.map,o=n;break}n&&n.dispose()}const i=t[0];o||(o=e.manager.getMaterialByNodeId(i.databagId,s,i.nodeId))}}if(o){const e=o.color.getHex();o.dispose();let i=e+"";l&&(i+="_"+l.uuid),a&&(i+="_opacity");let n={color:e,opacity:t};a&&(n.setByOpacity=a),l&&(n.map=l),r.push(n),l&&l.dispose(),l=null}}let n=[];for(let e=0;e<r.length;e++){let t=this._filterImpl.getMaterialNameByColor(r[e]),i=this._filterImpl.getMaterialByName(t);n.push(i)}return n}findOriginOpacityMaterialsMatchIds(e,t){let i=[];for(let r=0;r<t.length;r++){const n=t[r];let a={};const s=e.getFilter().getObjectInfoManager().getMaterials(n);if(s.length>0&&s.forEach((t=>{e._handler.getGeometryBuffersByUserId(n).forEach((i=>{let r=String(i.nodeId);if(t.nodeIds&&t.nodeIds.includes(r)){const r=e.manager.getMaterialByNodeId(i.databagId,n,i.nodeId);a[i.nodeId]={material:t,opacity:r.opacity}}if(!t.nodeIds){const r=e.manager.getMaterialByNodeId(i.databagId,n,i.nodeId);a[i.nodeId]={material:t,opacity:r.opacity}}}))})),a)for(const e in a){const t=a[e];let r={color:t.material.color.getHex(),opacity:t.opacity,nodeId:e};t.material.transparent?r.setByOpacity=!0:r.setByOpacity=!1,i.push(r),t.material.dispose()}}let r=[];for(let e=0;e<i.length;e++){let t=this._filterImpl.getMaterialNameByColor(i[e]),n=this._filterImpl.getMaterialByName(t);n.nodeIds||(n.nodeIds=[]),n.nodeIds.push(i[e].nodeId),r.push(n)}return r}restoreComponentsOpacityWithIds(e,t){this.objectInfoManager.removeModifyOpacityList(t);let i=this.findOriginOpacityMaterialsMatchIds(e,t);var n=new r.OverrideIdsFA(!0);n.ids=t,n.originOpacity=!0,this.pushBackByMaterials(n,i)}restoreComponentsOpacityWithConditions(e,t,i){this.objectInfoManager.removeModifyOpacityList(t);let n=this.findOriginOpacityMaterialsMatchIds(i,t);var a=new r.OverrideConditionFA(!0);a.conditions=e,a.originOpacity=!0,this.pushBackByMaterials(a,n)}findOriginOpacityMaterialsMatchConditions(e,t,i){var r=e.getModel(t);let n=[];for(let t=0;t<i.length;t++){const a=i[t];let s=null,o=null;const l=r.getFilter().getObjectInfoManager().getMaterial(a);if(l){l.map&&(o=l.map);const t=r._handler.getGeometryBuffersByUserId(a);if(t&&t.length>0){for(let i=0;i<t.length;i++){const r=t[i],n=e.getMaterialByNodeId(r.databagId,a,r.nodeId);if(n&&n.map){s=n;break}}const i=t[0];s||(s=e.getMaterialByNodeId(i.databagId,a,i.nodeId))}}if(s){let e={color:l.color.getHex(),opacity:s.opacity};l.transparent?e.setByOpacity=!0:e.setByOpacity=!1,o&&(e.map=o),n.push(e),o&&o.dispose(),o=null}}let a=[];for(let e=0;e<n.length;e++){let t=this._filterImpl.getMaterialNameByColor(n[e]),i=this._filterImpl.getMaterialByName(t);a.push(i)}return a}findMaterialsByIndexIdsMatchConditions(e,t,i,r){var n=e.getModel(t);let a=[];for(let t=0;t<r.length;t++){let s=!0;const o=r[t];let l=null,d=null;const h=n.getFilter().getObjectInfoManager().getMaterial(o);if(h)l=h,l.originOpacity=h.opacity,l.name.indexOf("_opacity")<0&&(s=!1),l.map&&(d=l.map);else{const t=n._handler.getGeometryBuffersByUserId(o);if(t&&t.length>0){d=null;for(let i=0;i<t.length;i++){const r=t[i],n=e.getMaterialByNodeId(r.databagId,o,r.nodeId);if(n&&n.map){d=n.map,l=n;break}n&&n.dispose()}const i=t[0];l||(l=e.getMaterialByNodeId(i.databagId,o,i.nodeId))}}if(l){const e=l.color.getHex();l.dispose();let t={color:e,opacity:i};s&&(t.setByOpacity=s),d&&(t.map=d),a.push(t),d&&d.dispose(),d=null}}let s=[];for(let e=0;e<a.length;e++){let t=this._filterImpl.getMaterialNameByColor(a[e]),i=this._filterImpl.getMaterialByName(t);s.push(i)}return s}addToOverrideListByMaterial(e,t){this._filterImpl.addOverrideMaterial(t);var i=new r.OverrideConditionFA(!0,t);i.conditions=e,this.pushBack(i)}addToOverrideListByMaterialAndId(e,t){t&&(t.vertexColors=!1),this._filterImpl.addOverrideMaterial(t);var i=new r.OverrideIdsFA(!0,t);i.ids=e,t&&t.map&&(i.textureName=t.name),this.pushBackByIds(i,e)}setOverrideListByColor(e,t,i){for(var r=0;r<t.length;r++){var n=this._filterImpl.getMaterialNameByColor(i),a=this._filterImpl.getMaterialByName(n);this.objectInfoManager.setMaterial(t[r],a)}}getVisibleComponentArray(e){let t=[];const i=[...e.keys()];for(var r=0;r<i.length;r++)this._isVisible({name:i[r]})&&t.push(i[r]);return t}clearAllUserList(){return this.enableStateChanged(),this._filterImpl.clearAllUserList()}clearUserListByType(e){return this.enableStateChanged(),this._filterImpl.clearUserListByType(e)}clearUserList(e,t){return this.enableStateChanged(),this._filterImpl.clearUserList(e,t)}addToUserList(e,t,i,r){return this.enableStateChanged(),this._filterImpl.addToUserList(e,t,i,r)}removeFromUserList(e,t,i){this.enableStateChanged(),this._filterImpl.removeFromUserList(e,t,i)}setUserList(e,t,i,r){this.enableStateChanged(),this._filterImpl.setUserList(e,t,i,r)}isIsolate(){var e=this.objectInfoManager.getObjectsMap();for(var t in e){if(e.hasOwnProperty(t))var i=e[t];for(var r in i){var n=this.objectInfoManager.isIsolateHide(r);if(n|=this.objectInfoManager.isIsolateTransparent(r))return!0}}return!1}isFiltering(){var e=this.filterActionList.length>0;return this.isIsolate()||e}getFrozonMaterial(){return this._filterImpl.getFrozonMaterial()}getFrozonMaterials(){return this._filterImpl.getFrozonMaterials()}setIsolateMaterial(e){this.enableStateChanged(),this._filterImpl.setIsolateMaterial(e)}getIsolateMaterial(){return this._filterImpl.getIsolateMaterial()}resetIsolateMaterial(){this.enableStateChanged(),this._filterImpl.resetIsolateMaterial()}clearAllIsolateList(){this.objectInfoManager.clearIsolates(),this.enableStateChanged()}clearIsolation(){this.objectInfoManager.clearIsolates(),this.isolateFilterAction=null,this.enableStateChanged()}setIsolationByIds(e,t){var i="HideOthers"==t;this.setIsolateList(e,i)}clearIsolationByIds(e){var t=new r.IsolateIdsFA;t.isolatePartialClear=!0,t.ids=e,this.pushBack(t),this.enableVisibleStateChanged(!0)}addToIsolateList(e,t){var i="HideOthers"==t,n=new r.IsolateIdsFA(i);n.ids=e,this.pushBack(n),i&&this.enableVisibleStateChanged(!0)}removeFromIsolateList(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)}setIsolateList(e,t){var i=new r.IsolateIdsFA(t);i.ids=e,this.pushBack(i),t&&this.enableVisibleStateChanged(!0)}removeFromIsolateList(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)}setIsolateConditions(e,t){var i=t==r.EnumIsolateState.HIDDEN_OTHERS,n=new r.IsolateConditionFA(i);n.conditions=e,this.pushBack(n),i&&this.enableVisibleStateChanged(!0)}getIsolateConditions(e){return this._filterImpl.getIsolateConditions(e)}clearIsolateConditions(e){this.enableStateChanged(),this._filterImpl.clearIsolateConditions(e)}clearAllIsolateConditions(){this.enableStateChanged(),this._filterImpl.clearAllIsolateConditions()}setConditions(e,t){if(0==e){this.objectInfoManager.hideAll();var i=new r.VisibleConditionFA(!0,!0);i.conditions=t,this.pushBack(i)}3==e&&this._filterImpl.setConditions(e,t)}getConditions(e){return this._filterImpl.getConditions(e)}clearConditions(e){this.enableStateChanged(),this._filterImpl.clearConditions(e)}clearAllConditions(){this.enableStateChanged(),this._filterImpl.clearAllConditions()}makeSceneTranslucent(){this.enableStateChanged(),this._filterImpl.makeSceneTranslucent()}cancelSceneTranslucent(){this.enableStateChanged(),this._filterImpl.cancelSceneTranslucent()}hideScene(){this.enableStateChanged(),this._filterImpl.hideScene()}showScene(){this.enableStateChanged(),this._filterImpl.showScene()}setSceneState(e){this.enableStateChanged(),this._filterImpl.setSceneState(e)}getSceneState(){return this._filterImpl.getSceneState()}cancelHidden(){this.enableStateChanged(),this._filterImpl.cancelHidden()}cancelTranslucent(){this.enableStateChanged(),this._filterImpl.cancelTranslucent()}hideByIds(e){var t=new r.VisibleIdsFA(!0,!1);t.ids=e,this.pushBackByIds(t,e)}hideByConditions(e){var t=new r.VisibleConditionFA(!0,!1);t.conditions=e,this.pushBackWithFilterMng(t)}hideOthersByConditions(e){var t=new r.VisibleConditionFA(!1,!1);t.conditions=e,this.pushBack(t)}showByIds(e){var t=new r.VisibleIdsFA(!0,!0);t.ids=e,this.pushBackByIds(t,e)}showByConditions(e){var t=new r.VisibleConditionFA(!0,!0);t.conditions=e,this.pushBackWithFilterMng(t)}makeTranslucentByIds(e){var t=new r.TransparentIdsFA(!0,!1);t.ids=e,this.pushBackByIds(t,e)}makeTranslucentByConditions(e){var t=new r.TransparentConditionFA(!0,!1);t.conditions=e,this.pushBack(t)}opaqueByIds(e){var t=new r.TransparentIdsFA(!0,!0);t.ids=e,this.pushBack(t)}opaqueByConditions(e){var t=new r.TransparentConditionFA(!0,!0);t.conditions=e,this.pushBack(t)}setFrozonMaterial(e){this._filterImpl.setFrozonMaterial(e),this.enableStateChanged()}makeTranslucentOthersByIds(e){var t=new r.TransparentIdsFA(!1,!1);t.ids=e,this.pushBack(t)}opaqueAll(){this.removeFilterActionByName("TransparentIdsFA"),this.removeFilterActionByName("TransparentConditionFA"),this.objectInfoManager.clearTransparent(),this.enableStateChanged()}deactivateByIds(e){this.objectInfoManager.deactivateByIds(e),this.observerForSceneState&&this.observerForSceneState(e)}clearInactivatedIdMap(){this.objectInfoManager.clearInactivatedIdMap()}getInactivatedIdMap(){return this.objectInfoManager.getInactivatedIdMap()}deactivateAll(){this.objectInfoManager.deactivateAll()}activateAll(){this.objectInfoManager.activateAll()}isComponentActive(e){return this.objectInfoManager.isActive(e)}getFilterType(){return this._filterImpl.getFilterType()}_hasOverrideMaterialForWireFrame(e){var t=e.name;return this.objectInfoManager.hasOverrideMaterialForWireFrame(t)}_hasOverrideMaterialFilterForWireFrame(){return this.objectInfoManager.hasOverrideMaterialForWireFrame()}_getOverrideMaterialForWireFrame(e){return this.objectInfoManager.getWireFrameMaterial(e.name)}_getOverrideWireFrameMaterial(e){return this.objectInfoManager.getWireFrameMaterial(e.name)}addToOverrideListForWireFrameByColor(e,t){var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var a=new r.OverrideIdsForWireFrameFA(!0,i);a.ids=e,this.pushBackByIds(a,e)}addToOverrideListForAllWireFrameByColor(e,t){var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var a=new r.OverrideIdsForWireFrameFA(!0,i);a.ids=[],this.pushBackByIds(a,e)}addToOverrideListForWireFrameByConditions(e,t){var i=this;i.addToOpacityListByConditions(e,((n,a)=>{if(a){var s=null;if(t){var o=i._filterImpl.getMaterialNameByColor(t);s=i._filterImpl.getMaterialByName(o)}var l=new r.OverrideConditionForWireFrameFA(!0,s);l.conditions=e,i.pushBackByIds(l,n)}}))}needUpdateBoxAfterExplode(){this.getObjectInfoManager().needUpdateBoxAfterExplode()}addToOpacityListByConditions(e,t){this.getObjectInfoManager().matchConditions(e,t)}addToModifyOpacityList(e,t){this.isComponentActive(e)&&this.getObjectInfoManager().addToModifyOpacityList(e,t)}removeModifyOpacityList(e){this.getObjectInfoManager().removeModifyOpacityList(e)}getModifyOpacityList(){return this.objectInfoManager.modifyOpacityList}clearModifyOpacityList(){this.objectInfoManager.clearModifyOpacityList(),this._filterImpl.clearMaterialsForModifyOpacity()}_hasModifyOpacityList(){return this.objectInfoManager.hasModifyOpacityList}getMaterialForModifyOpacityFrom(e,t){if(e){var i={};i.color=e.color.getHex(),i.opacity=t,i.side=e.side,e.map&&(i.map=e.map);var r=this._filterImpl.getMaterialNameBy(i),n=this._filterImpl.getMaterialForModifyOpacityBy(r,e);return n.opacity=t,n.transparent=t<1,n}}addToLocalClippingListByConditions(e,t){this.getObjectInfoManager().matchConditions(e,t)}addToLocalClippingList(e,t,i,r){if(t&&i){this.addMaterialForClip(t),this.addMaterialForClip(i);var n=this._filterImpl.getMaterialNameBy(t),a=this._filterImpl.getMaterialNameBy(i);this.objectInfoManager.addToLocalClippingList(e,n,a,r)}else this.objectInfoManager.addToLocalClippingList(e);this.enableStateChanged(),this.enableVisibleStateChanged(!0)}getLocalClippingList(){return this.objectInfoManager.localClippingList}clearLocalClippingList(){this.objectInfoManager.clearLocalClippingList(),this._filterImpl.clearInstanceMaterialsForClip(),this._filterImpl.clearMaterialsForClip(),this.enableStateChanged(),this.enableVisibleStateChanged(!0)}_hasLocalClipping(){return this.objectInfoManager.hasLocalClipping}addInstanceMaterialForClip(e,t){this._filterImpl.addInstanceMaterialForClip(e,t)}getAllInstanceMaterialsForClip(){return this._filterImpl.getAllInstanceMaterialsForClip()}addMaterialForClip(e){this._filterImpl.addMaterialForClip(e)}getMaterialForClipBy(e,t){return this._filterImpl.getMaterialForClipBy(e,t)}getMaterialForClipFrom(e){if(e){var t={};t.color=e.color.getHex(),t.opacity=e.opacity,t.side=e.side,e.map&&(t.map=e.map);var i=this._filterImpl.getMaterialNameBy(t);return this._filterImpl.getMaterialForClipBy(i,e)}}getAllMaterialsForClip(){return this._filterImpl.getAllMaterialsForClip()}setWireFrameVisibilityCondition(e){this._filterImpl.setWireFrameVisibilityCondition(e)}getWireFrameVisibilityCondition(){return this._filterImpl.getWireFrameVisibilityCondition()}_isRenderWithWireFrame(e){return this._filterImpl._isRenderWithWireFrame(e)}}}(),r.FilterManager2=function(){var e,t,i=r.EnumIdBasedType,n=r.EnumSceneState,a=r.FilterResultMode,s={IDFILTER_OFFSET:0,FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6,IDFILTER_ENDOFFSET:6,ISOLATEFILTER_OFFSET:7,ISOLATE_HIDDEN:7,ISOLATE_HIDDEN_OTHERS:8,ISOLATE_TRANSLUCENT:9,ISOLATE_TRANSLUCENT_OTHERS:10,ISOLATEFILTER_ENDOFFSET:10,USERFILTER_OFFSET:11,USER_HIDDEN:11,USER_OVERRIDE:12,USERFILTER_ENDOFFSET:12,CONDITIONFILTER_OFFSET:13,CONDITION_HIDDEN_OTHERS:13,CONDITION_TRANSLUCENT_OTHERS:14,CONDITION_OVERRIDE:15,CONDITION_BORDERLINE:16,CONDITIONFILTER_ENDOFFSET:16,ISOLATECONDITIONFILTER_OFFSET:17,ISOLATE_CONDITION_HIDDEN:17,ISOLATE_CONDITION_HIDDEN_OTHERS:18,ISOLATE_CONDITION_TRANSLUCENT:19,ISOLATE_CONDITION_TRANSLUCENT_OTHERS:20,ISOLATECONDITIONFILTER_ENDOFFSET:20,FROZENFILTER:21,FROZENCONDITIONFILTER:22,OVERRIDEFILTER:23,BASICFILTER_COUNT:23},o=new r.CompoundFilter(!0),l=new r.CompoundFilter(!0),d=new r.CompoundFilter(!1),h=new r.CompoundFilter(!0),c=new r.CompoundFilter(!1),u=new r.CompoundFilter(!1),p=new r.CompoundFilter(!1),m=[],f=n.DISABLED,g=new r.MaterialSelector,v=null;!function(){var i;m[s.FILE_VISIBLE]=new r.FileIdFilter(s.FILE_VISIBLE,"FILE_VISIBLE"),m[s.FILE_HIDDEN]=new r.FileIdFilter(s.FILE_HIDDEN,"FILE_HIDDEN"),m[s.VISIBLE]=new r.GeneralIdFilter(s.VISIBLE,"VISIBLE"),m[s.HIDDEN]=new r.GeneralIdFilter(s.HIDDEN,"HIDDEN"),m[s.TRANSLUCENT]=new r.GeneralIdFilter(s.TRANSLUCENT,"TRANSLUCENT"),m[s.TRANSLUCENT_OTHERS]=new r.GeneralIdFilter(s.TRANSLUCENT_OTHERS,"TRANSLUCENT_OTHERS"),m[s.RENDER_PROMOTION]=new r.GeneralIdFilter(s.RENDER_PROMOTION,"RENDER_PROMOTION"),m[s.ISOLATE_HIDDEN]=new r.GeneralIdFilter(s.ISOLATE_HIDDEN,"ISOLATE_HIDDEN"),m[s.ISOLATE_HIDDEN_OTHERS]=new r.GeneralIdFilter(s.ISOLATE_HIDDEN_OTHERS,"ISOLATE_HIDDEN_OTHERS"),m[s.ISOLATE_TRANSLUCENT]=new r.GeneralIdFilter(s.ISOLATE_TRANSLUCENT,"ISOLATE_TRANSLUCENT"),m[s.ISOLATE_TRANSLUCENT_OTHERS]=new r.GeneralIdFilter(s.ISOLATE_TRANSLUCENT_OTHERS,"ISOLATE_TRANSLUCENT_OTHERS"),m[s.USER_HIDDEN]=new r.UserListFilter(s.USER_HIDDEN,"USER_HIDDEN"),m[s.USER_OVERRIDE]=new r.UserListFilter(s.USER_OVERRIDE,"USER_OVERRIDE"),m[s.CONDITION_HIDDEN_OTHERS]=new r.ConditionFilter(s.CONDITION_HIDDEN_OTHERS,"CONDITION_HIDDEN_OTHERS"),m[s.CONDITION_TRANSLUCENT_OTHERS]=new r.ConditionFilter(s.CONDITION_TRANSLUCENT_OTHERS,"CONDITION_TRANSLUCENT_OTHERS"),m[s.CONDITION_OVERRIDE]=new r.MultiConditionFilter(s.CONDITION_OVERRIDE,"CONDITION_OVERRIDE"),m[s.CONDITION_BORDERLINE]=new r.ConditionFilter(s.CONDITION_BORDERLINE,"CONDITION_BORDERLINE"),m[s.ISOLATE_CONDITION_HIDDEN]=new r.ConditionFilter(s.ISOLATE_CONDITION_HIDDEN,"ISOLATE_CONDITION_HIDDEN"),m[s.ISOLATE_CONDITION_HIDDEN_OTHERS]=new r.ConditionFilter(s.ISOLATE_CONDITION_HIDDEN_OTHERS,"ISOLATE_CONDITION_HIDDEN_OTHERS"),m[s.ISOLATE_CONDITION_TRANSLUCENT]=new r.ConditionFilter(s.ISOLATE_CONDITION_TRANSLUCENT,"ISOLATE_CONDITION_TRANSLUCENT"),m[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=new r.ConditionFilter(s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS,"ISOLATE_CONDITION_TRANSLUCENT_OTHERS"),t=new r.GeneralIdFilter(s.FROZENFILTER,"FROZENFILTER"),m[s.FROZENCONDITIONFILTER]=new r.ConditionFilter(s.FROZENCONDITIONFILTER,"FROZENCONDITIONFILTER"),m[s.FROZENFILTER]=t,e=new r.OverrideListFilter(s.OVERRIDEFILTER,"OVERRIDEFILTER"),m[s.OVERRIDEFILTER]=e;var n={};for(i in n[s.HIDDEN]=a.MATCH_RETURN_FALSE,n[s.VISIBLE]=a.NOMATCH_RETURN_FALSE,n[s.USER_HIDDEN]=a.MATCH_RETURN_FALSE,n[s.CONDITION_HIDDEN_OTHERS]=a.NOMATCH_RETURN_FALSE,n[s.ISOLATE_HIDDEN]=a.MATCH_RETURN_FALSE,n[s.ISOLATE_HIDDEN_OTHERS]=a.NOMATCH_RETURN_FALSE,n[s.ISOLATE_CONDITION_HIDDEN_OTHERS]=a.NOMATCH_RETURN_FALSE,o.setFilterMode(n),n)m[i].registerToCompoundFilter(o);var f={};for(i in f[s.FROZENFILTER]=a.MATCH_RETURN_FALSE,f[s.FROZENCONDITIONFILTER]=a.MATCH_RETURN_FALSE,f[s.TRANSLUCENT]=a.MATCH_RETURN_FALSE,f[s.TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_FALSE,f[s.CONDITION_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_FALSE,f[s.ISOLATE_TRANSLUCENT]=a.MATCH_RETURN_FALSE,f[s.ISOLATE_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_FALSE,f[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_FALSE,h.setFilterMode(f),f)m[i].registerToCompoundFilter(h);var g={};g[s.ISOLATE_TRANSLUCENT]=a.MATCH_RETURN_TRUE,g[s.ISOLATE_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_TRUE,g[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_TRUE,g[s.CONDITION_TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_TRUE,g[s.TRANSLUCENT]=a.MATCH_RETURN_TRUE,g[s.TRANSLUCENT_OTHERS]=a.NOMATCH_RETURN_TRUE,g[s.OVERRIDEFILTER]=a.MATCH_RETURN_TRUE,g[s.USER_OVERRIDE]=a.MATCH_RETURN_TRUE,g[s.CONDITION_OVERRIDE]=a.MATCH_RETURN_TRUE,g[s.FROZENFILTER]=a.MATCH_RETURN_TRUE,g[s.FROZENCONDITIONFILTER]=a.MATCH_RETURN_TRUE;var v={};for(i in v[s.ISOLATE_TRANSLUCENT]=5,v[s.ISOLATE_TRANSLUCENT_OTHERS]=5,v[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=5,v[s.CONDITION_TRANSLUCENT_OTHERS]=5,v[s.TRANSLUCENT]=5,v[s.TRANSLUCENT_OTHERS]=5,v[s.OVERRIDEFILTER]=0,v[s.USER_OVERRIDE]=0,v[s.CONDITION_OVERRIDE]=0,v[s.FROZENFILTER]=3,v[s.FROZENCONDITIONFILTER]=3,l.setFilterMode(g),l.setFilterPriority(v),g)m[i].registerToCompoundFilter(l);var y={};for(i in y[s.OVERRIDEFILTER]=a.MATCH_RETURN_TRUE,y[s.USER_OVERRIDE]=a.MATCH_RETURN_TRUE,y[s.CONDITION_OVERRIDE]=a.MATCH_RETURN_TRUE,y[s.CONDITION_TRANSLUCENT_OTHERS]=a.MATCH_RETURN_TRUE,d.setFilterMode(y),y)m[i].registerToCompoundFilter(d);var M={};for(i in M[s.FILE_VISIBLE]=a.NOMATCH_RETURN_TRUE,M[s.FILE_HIDDEN]=a.MATCH_RETURN_TRUE,c.setFilterMode(M),M)m[i].registerToCompoundFilter(c);var E={};for(i in E[s.RENDER_PROMOTION]=a.MATCH_RETURN_TRUE,E[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=a.MATCH_RETURN_TRUE,u.setFilterMode(E),E)m[i].registerToCompoundFilter(u);var x={};for(i in x[s.CONDITION_BORDERLINE]=a.MATCH_RETURN_TRUE,p.setFilterMode(x),x)m[i].registerToCompoundFilter(p)}(),this.getMaterialSelector=function(){return g},this.getBasicFilterList=function(){return m},this.getFilterType=function(){return s},this.saveState=function(){for(var e,t={},i=0,r=m.length;i<r;i++)t[(e=m[i]).getName()]=e.getAll();return t.sceneState=this.getSceneState(),t.version="0.4",t},this.loadState=function(e){if(this.clearAll(),e.hasOwnProperty("version")){if("0.4"==e.version){for(var t={},i=0,n=m.length;i<n;i++)t[m[i].getName()]=i;for(var a in e)"sceneState"!==a&&"version"!==a&&(t.hasOwnProperty(a)?m[t[a]].setByData(e[a]):r.Logger.warn("Warning: Not supported filter '"+a+"'"))}}else for(var o in e)"sceneState"!==o&&(o<2?m[o].setByData(e[o]):o>2?o<s.BASICFILTER_COUNT+2&&m[o-1].setByData(e[o]):2==o&&r.Logger.warn("Warning: Old version filter data! The selection state is out of the filter, can not restore it."));this.setSceneState(e.sceneState)},this.clear=function(){for(var e=0,t=m.length;e<t;e++){var i=m[e].getType();i!==s.FROZENFILTER&&i!==s.CONDITION_BORDERLINE&&m[e].clearAll()}this.setSceneState(n.DISABLED)},this.clearAll=function(){for(var e=0,t=m.length;e<t;e++)m[e].clearAll();this.setSceneState(n.DISABLED)},this.clearIsolate=function(){this.clearAllIsolateList(),this.clearAllIsolateConditions()},this.clearFrozenList=function(){t.clearAll()},this.addToFrozenList=function(e){t.add(e)},this.removeFromFrozenList=function(e){t.remove(e)},this.setFrozenList=function(e){this.clearFrozenList(),this.addToFrozenList(e)},this.setFrozenConditions=function(e){m[s.FROZENCONDITIONFILTER].setByData(e)},this.getFrozenConditions=function(){return m[s.FROZENCONDITIONFILTER].getAll()},this.clearFrozenConditions=function(){m[s.FROZENCONDITIONFILTER].clear()},this.clearFrozen=function(){this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){var e;for(e=s.IDFILTER_OFFSET;e<=s.IDFILTER_ENDOFFSET;e++)m[e].clearAll()},this.clearIdList=function(e){var t=s.IDFILTER_OFFSET+e;t>=s.IDFILTER_OFFSET&&t<=s.IDFILTER_ENDOFFSET&&m[t].clear()},this.addToIdList=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].add(t)},this.removeFromIdList=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].remove(t)},this.setIdList=function(e,t){this.clearIdList(e),this.addToIdList(e,t)},this.clearAllOverrideList=function(){e.clearAll()},this.clearOverrideList=function(t){e.clear(t)},this.addToOverrideList=function(t,i,r){i&&i.length>0&&(g.has(r)||(r=g.getDefaultMaterialName()),e.add(t,i,r))},this.removeFromOverrideList=function(t,i){e.remove(t,i)},this.setOverrideList=function(e,t,i){this.clearOverrideList(e),this.addToOverrideList(e,t,i)},this.addToOverrideListByColor=function(t,i,r){var n=g.add(r);e.add(t,i,n)},this.setOverrideListByColor=function(e,t,i){this.clearOverrideList(e),this.addToOverrideListByColor(e,t,i)},this.clearAllUserList=function(){var e;for(e=s.USERFILTER_OFFSET;e<=s.USERFILTER_ENDOFFSET;e++)m[e].clearAll()},this.clearUserListByType=function(e){var t=s.USERFILTER_OFFSET+e;t>=s.USERFILTER_OFFSET&&t<=s.USERFILTER_ENDOFFSET&&m[t].clearAll()},this.clearUserList=function(e,t){var i=s.USERFILTER_OFFSET+e;i>=s.USERFILTER_OFFSET&&i<=s.USERFILTER_ENDOFFSET&&m[i].clear(t)},this.addToUserList=function(e,t,i,r){var n=s.USERFILTER_OFFSET+e;n>=s.USERFILTER_OFFSET&&n<=s.USERFILTER_ENDOFFSET&&m[n].add(t,i,r)},this.removeFromUserList=function(e,t,i){var r=s.USERFILTER_OFFSET+e;r>=s.USERFILTER_OFFSET&&r<=s.USERFILTER_ENDOFFSET&&m[r].remove(t,i)},this.setUserList=function(e,t,i,r){this.clearUserList(e,t),this.addToUserList(e,t,i,r)},this.isIsolate=function(){var e;for(e=s.ISOLATEFILTER_OFFSET;e<=s.ISOLATEFILTER_ENDOFFSET;e++)if(!m[e].isEmpty())return!0;return!1},this.isFiltering=function(){return!!this.isIsolate()||!(m[s.HIDDEN].isEmpty()&&m[s.VISIBLE].isEmpty()&&m[s.TRANSLUCENT].isEmpty()&&m[s.TRANSLUCENT_OTHERS].isEmpty()&&this.getSceneState()===n.DISABLED)},this.setFrozonMaterial=function(e){g.setFrozonMaterial(e)},this.getFrozonMaterial=function(){return g.getFrozonMaterial()},this.getFrozonMaterials=function(){return g.getFrozonMaterials()},this.getFrozonMaterialV3=function(e,t){return g.getFrozonMaterialV3(e,t)},this.setSelectedMaterial=function(e){g.setSelectedMaterial(e)},this.getSelectedMaterial=function(){return g.getSelectedMaterial()},this.setIsolateMaterial=function(e){g.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return g.getIsolateMaterial()},this.resetIsolateMaterial=function(){g.resetIsolateMaterial()},this.clearAllIsolateList=function(){var e;for(e=s.ISOLATEFILTER_OFFSET;e<=s.ISOLATEFILTER_ENDOFFSET;e++)m[e].clear()},this.clearIsolateList=function(e){var t=s.ISOLATEFILTER_OFFSET+e;t>=s.ISOLATEFILTER_OFFSET&&t<=s.ISOLATEFILTER_ENDOFFSET&&m[t].clear()},this.addToIsolateList=function(e,t){var i=s.ISOLATEFILTER_OFFSET+e;i>=s.ISOLATEFILTER_OFFSET&&i<=s.ISOLATEFILTER_ENDOFFSET&&m[i].add(t)},this.removeFromIsolateList=function(e,t){var i=s.ISOLATEFILTER_OFFSET+e;i>=s.ISOLATEFILTER_OFFSET&&i<=s.ISOLATEFILTER_ENDOFFSET&&m[i].remove(t)},this.setIsolateList=function(e,t){this.clearIsolateList(e),this.addToIsolateList(e,t)},this.setIsolateConditions=function(e,t){var i=s.ISOLATECONDITIONFILTER_OFFSET+t;i>=s.ISOLATECONDITIONFILTER_OFFSET&&i<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&m[i].setByData(e)},this.getIsolateConditions=function(e){var t=null,i=s.ISOLATECONDITIONFILTER_OFFSET+e;return i>=s.ISOLATECONDITIONFILTER_OFFSET&&i<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&(t=m[i].getAll()),t},this.clearIsolateConditions=function(e){var t=s.ISOLATECONDITIONFILTER_OFFSET+e;t>=s.ISOLATECONDITIONFILTER_OFFSET&&t<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&m[t].clear()},this.clearAllIsolateConditions=function(){var e;for(e=s.ISOLATECONDITIONFILTER_OFFSET;e<=s.ISOLATECONDITIONFILTER_ENDOFFSET;e++)m[e].clearAll()},this.setConditions=function(e,t){var i=s.CONDITIONFILTER_OFFSET+e;i>=s.CONDITIONFILTER_OFFSET&&i<=s.CONDITIONFILTER_ENDOFFSET&&m[i].setByData(t)},this.getConditions=function(e){var t=null,i=s.CONDITIONFILTER_OFFSET+e;return i>=s.CONDITIONFILTER_OFFSET&&i<=s.CONDITIONFILTER_ENDOFFSET&&(t=m[i].get()),t},this.clearConditions=function(e){var t=s.CONDITIONFILTER_OFFSET+e;t>=s.CONDITIONFILTER_OFFSET&&t<=s.CONDITIONFILTER_ENDOFFSET&&m[t].clearAll()},this.clearAllConditions=function(){var e;for(e=s.CONDITIONFILTER_OFFSET;e<=s.CONDITIONFILTER_ENDOFFSET;e++)m[e].clear()},this.makeSceneTranslucent=function(){this.setSceneState(n.TRANSLUCENT)},this.cancelSceneTranslucent=function(){this.setSceneState(n.DISABLED)},this.hideScene=function(){this.setSceneState(n.HIDDEN)},this.showScene=function(){this.setSceneState(n.DISABLED)},this.setSceneState=function(e){f=e},this.getSceneState=function(){return f},this.cancelTranslucent=function(){this.clearIdList(i.TRANSLUCENT),this.clearIdList(i.TRANSLUCENT_OTHERS)},this._addIdsToFilter=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].add(t)},this.hideByIds=function(e){this._addIdsToFilter(i.HIDDEN,e)},this.showByIds=function(e){this._addIdsToFilter(i.VISIBLE,e)},this.makeTranslucentByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT,e)},this.makeTranslucentOthersByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT_OTHERS,e)},this._isVisible=function(e){return this.getSceneState()!==n.HIDDEN&&o.apply(e)},this._isSelectable=function(e){return this.getSceneState()!==n.TRANSLUCENT&&h.apply(e,this.getSceneState())},this.getMaterialNameByColor=function(e){return g.getMaterialNameByColor(e)},this.addOverrideMaterial=function(e){g.addOverrideMaterial(e)},this.getMaterialByName=function(e){return g.get(e)},this._getOverrideMaterial=function(e){if(this.getSceneState()===n.TRANSLUCENT)return g.get("scene");var t=l.getApplyFilterId(e),i=null,r="";switch(t){case s.ISOLATE_TRANSLUCENT:case s.ISOLATE_TRANSLUCENT_OTHERS:case s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial();break;case s.CONDITION_TRANSLUCENT_OTHERS:case s.TRANSLUCENT:case s.TRANSLUCENT_OTHERS:i=g.get("scene");break;case s.FROZENFILTER:case s.FROZENCONDITIONFILTER:break;case s.OVERRIDEFILTER:case s.USER_OVERRIDE:case s.CONDITION_OVERRIDE:var a=m[t].getMatchItem(e);r=a.hasOwnProperty("color")?g.getMaterialNameByColor(a.color):a.material?a.material:a}return i||""===r||(g.has(r)||(r=g.getDefaultMaterialName()),i=g.get(r)),i},this._getMaterialName=function(e){if(this.getSceneState()===n.TRANSLUCENT)return"scene";var t=l.getApplyFilterId(e),i="";switch(t){case s.ISOLATE_TRANSLUCENT:case s.ISOLATE_TRANSLUCENT_OTHERS:case s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial().name;break;case s.CONDITION_TRANSLUCENT_OTHERS:case s.TRANSLUCENT:case s.TRANSLUCENT_OTHERS:i="scene";break;case s.FROZENFILTER:case s.FROZENCONDITIONFILTER:break;case s.OVERRIDEFILTER:case s.USER_OVERRIDE:case s.CONDITION_OVERRIDE:var r=m[t].getMatchItem(e);i=r.hasOwnProperty("color")?g.getMaterialNameByColor(r.color):r.material?r.material:r}return i},this._getMaterialByName=function(e){return"isolate"==e?g.getIsolateMaterial():"frozen"==e||"scene"==e?g.getFrozonMaterial():"selected"==e?g.getSelectedMaterial():g.get(e)},this._hasHighPriorityOverrideMaterial=function(e){return this.getSceneState()===n.TRANSLUCENT||d.apply(e)},this._hasOverrideMaterial=function(e){return this.getSceneState()===n.TRANSLUCENT||d.apply(e)||l.apply(e)},this._isHiddenFileId=function(e){return c.apply(e)},this._hasHiddenFileIdFilter=function(){return!c.isEmpty()},this._hasVisibleFilter=function(){return this.getSceneState()===n.HIDDEN||!o.isEmpty()},this._hasSelectableFilter=function(){return this.getSceneState()===n.TRANSLUCENT||!h.isEmpty()},this._hasOverrideMaterialFilter=function(){return this.getSceneState()===n.TRANSLUCENT||!l.isEmpty()},this._hasLowPriorityOverride=function(){return l.hasFilterNotIn(d)},this._isRenderPromotion=function(e){return u.apply(e)},this._hasRenderPromotionFilter=function(){return!u.isEmpty()},this._isRenderWithBoardline=function(e){return p.apply(e)},this._hasRenderWithBoardlineFilter=function(){return!p.isEmpty()},this.addInstanceMaterialForClip=function(e,t){g.addInstanceMaterialForClip(e,t)},this.clearInstanceMaterialsForClip=function(){g.clearInstanceMaterialsForClip()},this.getAllInstanceMaterialsForClip=function(){return g.getAllInstanceMaterialsForClip()},this.addMaterialForClip=function(e){g.addMaterialForClip(e)},this.getMaterialForClipBy=function(e,t){return g.getMaterialForClipBy(e,t)},this.getAllMaterialsForClip=function(){return g.getAllMaterialsForClip()},this.clearMaterialsForClip=function(){g.clearMaterialsForClip()},this.getMaterialForModifyOpacityBy=function(e,t){return g.getMaterialForModifyOpacityBy(e,t)},this.clearMaterialsForModifyOpacity=function(){g.clearMaterialsForModifyOpacity()},this.getMaterialNameBy=function(e){return g.getMaterialNameBy(e)},this.setWireFrameVisibilityCondition=function(e){e.condition&&e.condition.ids&&(e.userIdMap={},e.condition.ids.map((t=>{e.userIdMap[t]=!0})),delete e.condition.ids),e.condition&&e.condition.objectData&&(e.objectData=e.condition.objectData,delete e.condition.objectData),e.condition&&void 0!==e.condition.all&&(e.all=e.condition.all,delete e.condition.all),delete e.condition,v=e},this.getWireFrameVisibilityCondition=function(){return v},this._isRenderWithWireFrame=function(e){const t=v.isVisible;if(!0===v.all)return t;if(!1===v.all)return!t;if(!v.userIdMap&&!v.objectData)return t;if(v.userIdMap&&!0===v.userIdMap[e.userId])return t;const i=e.userData,r=v.objectData;return i&&r?((e,t,i)=>{let r;const n=e.length;for(let s=0;s<n;++s){r=!0;var a=e[s];for(const e in a){if(!(a[e]instanceof Array)&&t[e]!==a[e]){r=!1;break}if(a[e]instanceof Array&&-1==a[e].indexOf(t[e])){r=!1;break}}if(r)return i}return!i})(r,i,t):!t}},r.BasicFilter=function(e,t){this._type=e,this._name=t,this._enabled=!1,this._items={},this._relatedCompoundFilterList=[]},r.BasicFilter.prototype.getType=function(){return this._type},r.BasicFilter.prototype.getName=function(){return this._name},r.BasicFilter.prototype.get=function(){return this._items},r.BasicFilter.prototype.getAll=function(){return this._items},r.BasicFilter.prototype.clearAll=function(){var e=this;e._items={},e._enabled&&(e._enabled=!1,e.enableStateChanged())},r.BasicFilter.prototype.clear=function(){this.clearAll()},r.BasicFilter.prototype.isEmpty=function(){return!this._enabled},r.BasicFilter.prototype.forceEnable=function(){this._enabled||(this._enabled=!0,this.enableStateChanged())},r.BasicFilter.prototype.setByData=function(e){var t=this;!function(e){if(null==e)return!0;if("object"!=typeof e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)?(t._items=e,t._enabled||(t._enabled=!0,t.enableStateChanged())):(t._items={},t._enabled&&(t._enabled=!1,t.enableStateChanged()))},r.BasicFilter.prototype.match=function(e){return!1},r.BasicFilter.prototype.registerToCompoundFilter=function(e){this._relatedCompoundFilterList.push(e)},r.BasicFilter.prototype.enableStateChanged=function(){for(var e=this,t=0,i=e._relatedCompoundFilterList.length;t<i;t++)e._enabled?e._relatedCompoundFilterList[t].addBaseFilter(e):e._relatedCompoundFilterList[t].removeBaseFilter(e)},r.BasicIdFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.BasicIdFilter.prototype=Object.create(r.BasicFilter.prototype),r.BasicIdFilter.prototype.constructor=r.BasicIdFilter,r.BasicIdFilter.prototype.add=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var r=0,n=e.length;r<n;++r)i[e[r]]=!0;t._enabled||(t._enabled=!0,t.enableStateChanged())}},r.BasicIdFilter.prototype.remove=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var r=0,n=e.length;r<n;++r){var a=e[r];i.hasOwnProperty(a)&&delete i[a]}0===i.length&&t._enabled&&(t._enabled=!1,t.enableStateChanged())}},r.ListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.ListFilter.prototype=Object.create(r.BasicFilter.prototype),r.ListFilter.prototype.constructor=r.ListFilter,r.ListFilter.prototype.remove=function(e,t){var i=this,n=i._items[e];if(n&&t&&t.length>0){for(var a=0,s=t.length;a<s;++a){var o=t[a];n.hasOwnProperty(o)&&delete n[o]}r.Utils.isEmptyObject(i._items)&&i._enabled&&(i._enabled=!1,i.enableStateChanged())}},r.ListFilter.prototype.add=function(e,t,i){var r=this,n=r._items,a=n[e];if(t&&t.length>0){void 0===i&&(i=!0),a||(a=n[e]={});for(var s=0,o=t.length;s<o;++s)a[t[s]]=i;r._enabled||(r._enabled=!0,r.enableStateChanged())}},r.ListFilter.prototype.clear=function(e){var t=this,i=t._items;i.hasOwnProperty(e)&&(delete i[e],r.Utils.isEmptyObject(i)&&t._enabled&&(t._enabled=!1,t.enableStateChanged()))},r.UserListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.UserListFilter.prototype=Object.create(r.ListFilter.prototype),r.UserListFilter.prototype.constructor=r.UserListFilter,r.UserListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.UserListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.userData;if(i)for(var r in t){var n=t[r],a=i[r];if(a&&void 0!==n[a])return n[a]}return null},r.OverrideListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.OverrideListFilter.prototype=Object.create(r.ListFilter.prototype),r.OverrideListFilter.prototype.constructor=r.OverrideListFilter,r.OverrideListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.OverrideListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.name;for(var r in t){var n=t[r];if(n[i])return n[i]}return null},r.ConditionFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.ConditionFilter.prototype=Object.create(r.BasicFilter.prototype),r.ConditionFilter.prototype.constructor=r.ConditionFilter,r.ConditionFilter.prototype.match=function(e){var t=e.userData;return!!t&&function(e,t){for(var i,r=0,n=e.length;r<n;++r){i=!0;var a=e[r];for(var s in a){if(!(a[s]instanceof Array)&&t[s]!=a[s]){i=!1;break}if(a[s]instanceof Array&&-1==a[s].indexOf(t[s])){i=!1;break}}if(i)return!0}return!1}(this._items,t)},r.MultiConditionFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.MultiConditionFilter.prototype=Object.create(r.BasicFilter.prototype),r.MultiConditionFilter.prototype.constructor=r.MultiConditionFilter,r.MultiConditionFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.MultiConditionFilter.prototype.getMatchItem=function(e){var t,i=this._items,r=e.userData;if(r)for(var n=i.length,a=0;a<n;++a){var s=i[a],o=s.condition;for(var l in t=!0,o)if(o[l]!=r[l]){t=!1;break}if(t)return s}return null},r.FileIdFilter=function(e,t){r.BasicIdFilter.call(this,e,t)},r.FileIdFilter.prototype=Object.create(r.BasicIdFilter.prototype),r.FileIdFilter.prototype.constructor=r.FileIdFilter,r.FileIdFilter.prototype.match=function(e){var t=e.name;if(t){var i=t.indexOf(".");if(-1!==i){var r=t.substring(0,i);return!!this._items[r]}}var n=e.userData;if(n&&(r=n.sceneId))return!!this._items[r];return!1},r.GeneralIdFilter=function(e,t){r.BasicIdFilter.call(this,e,t)},r.GeneralIdFilter.prototype=Object.create(r.BasicIdFilter.prototype),r.GeneralIdFilter.prototype.constructor=r.GeneralIdFilter,r.GeneralIdFilter.prototype.match=function(e){return!!this._items[e.name]},r.FilterResultMode={MATCH_RETURN_TRUE:0,MATCH_RETURN_FALSE:1,NOMATCH_RETURN_TRUE:2,NOMATCH_RETURN_FALSE:3},r.CompoundFilter=function(e){this._activeFilterList=[],this._filterResultModes={},this._defaultRetValue=e,this._filterPriority=null},r.CompoundFilter.prototype.setFilterMode=function(e){this._filterResultModes=e},r.CompoundFilter.prototype.setFilterPriority=function(e){this._filterPriority=e},r.CompoundFilter.prototype.addBaseFilter=function(e){var t=this._activeFilterList,i=t.indexOf(e);if(null===this._filterPriority)-1===i?t.push(e):i!==t.length-1&&(t.splice(i,1),t.push(e));else if(0===t.length)t.push(e);else{-1!==i&&i!==t.length-1&&t.splice(i,1);for(var r=this._filterPriority[e.getType()],n=0,a=t.length;n<a;n++)if(this._filterPriority[t[n].getType()]>r){t.splice(n,0,e);break}n===a&&t.push(e)}},r.CompoundFilter.prototype.removeBaseFilter=function(e){var t=this._activeFilterList.indexOf(e);-1!==t&&this._activeFilterList.splice(t,1)},r.CompoundFilter.prototype.isEmpty=function(){return 0===this._activeFilterList.length},r.CompoundFilter.prototype.hasFilterNotIn=function(e){for(var t=this._activeFilterList,i=t.length-1;i>=0;i--){var r=t[i];if(void 0===e._filterResultModes[r.getType()])return!0}return!1},r.CompoundFilter.prototype.apply=function(e){for(var t,i=this,n=r.FilterResultMode,a=i._activeFilterList.length-1;a>=0;a--)switch(t=i._activeFilterList[a],i._filterResultModes[t.getType()]){case n.MATCH_RETURN_TRUE:if(t.match(e))return!0;break;case n.MATCH_RETURN_FALSE:if(t.match(e))return!1;break;case n.NOMATCH_RETURN_TRUE:if(!t.match(e))return!0;break;case n.NOMATCH_RETURN_FALSE:if(!t.match(e))return!1}return i._defaultRetValue},r.CompoundFilter.prototype.getApplyFilterId=function(e){for(var t,i=this,n=r.FilterResultMode,a=i._activeFilterList.length-1;a>=0;a--)switch(t=i._activeFilterList[a],i._filterResultModes[t.getType()]){case n.MATCH_RETURN_TRUE:case n.MATCH_RETURN_FALSE:if(t.match(e))return t.getType();break;case n.NOMATCH_RETURN_TRUE:case n.NOMATCH_RETURN_FALSE:if(!t.match(e))return t.getType()}return-1},r.FilterAction=function(){this.className="FilterAction"},r.FilterAction.prototype.getClassName=function(){return this.className},r.FilterAction.prototype.applyFilter=function(e){},r.IdsFilterAction=function(){r.FilterAction.call(this),this.className="IdsFilterAction",this.ids=[]},r.IdsFilterAction.prototype=Object.create(r.FilterAction.prototype),r.IdsFilterAction.prototype.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];t[r]=r}return t},r.IdsFilterAction.prototype.constructor=r.IdsFilterAction,r.VisibleIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="VisibleIdsFA",this.flag=e,this.isVisible=t},r.IdsFilterAction.prototype.setIds=function(e){this.ids=e},r.VisibleIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.VisibleIdsFA.prototype.constructor=r.VisibleIdsFA,r.VisibleIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.setVisible(this.ids,this.isVisible,this.flag),e.calculateVisibleComponentsBbox()):console.warn("Ids should be type of array.")},r.VisibleIdsFA.prototype.applyFilterByIds=function(e,t,i){i instanceof Array?(e.setVisible(this.ids,this.isVisible,this.flag,t),e.calculateVisibleComponentsBbox()):console.warn("Ids should be type of array.")},r.OverrideIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="OverrideIdsFA",this.flag=e,null!=t&&(this.material=t)},r.OverrideIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.OverrideIdsFA.prototype.constructor=r.OverrideIdsFA,r.OverrideIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsFA.prototype.applyFilterByIds=function(e,t,i){i instanceof Array?e.setMaterial(i,this.material,this.flag,t):console.warn("Ids should be type of array.")},r.OverrideIdsFA.prototype.applyFilterByMaterials=function(e,t,i){this.ids instanceof Array?e.setMaterials(this.ids,i,this.flag,t):console.warn("Ids should be type of array.")},r.OverrideIdsFA.prototype.applyFilterWithFilterMng=function(e,t){this.ids instanceof Array?e.setMaterial(this.ids,this.material,this.flag,t):console.warn("Ids should be type of array.")},r.OverrideIdsFA.prototype.applyFilterByArryOfIdsAndMaterial=function(e,t,i,r){this.ids instanceof Array?e.setMaterialByArrays(r,i,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsForWireFrameFA=function(e,t){r.IdsFilterAction.call(this),this.className="OverrideIdsForWireFrameFA",this.flag=e,this.material=t},r.OverrideIdsForWireFrameFA.prototype=Object.create(r.IdsFilterAction.prototype),r.OverrideIdsForWireFrameFA.prototype.constructor=r.OverrideIdsForWireFrameFA,r.OverrideIdsForWireFrameFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setWireFrameMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsForWireFrameFA.prototype.applyFilterByIds=function(e,t,i){i instanceof Array?e.setWireFrameMaterial(i,this.material,this.flag,t):console.warn("Ids should be type of array.")},r.IsolateIdsFA=function(e){r.IdsFilterAction.call(this),this.className="IsolateIdsFA",this.isolateHide=e,this.isolatePartialClear=!1},r.IsolateIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.IsolateIdsFA.prototype.constructor=r.IsolateIdsFA,r.IsolateIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?this.isolateHide?(e.setIsolateHideAfterClear(this.ids,!0,!1),e.calculateVisibleComponentsBbox()):this.isolatePartialClear&&e.clearIsolatesByIds?e.clearIsolatesByIds(this.ids):e.setIsolateTransparentAfterClear(this.ids,!0,!1):console.warn("Ids should be type of array.")},r.TransparentIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="TransparentIdsFA",this.flag=e,this.isOpaque=t},r.TransparentIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.TransparentIdsFA.prototype.constructor=r.TransparentIdsFA,r.TransparentIdsFA.prototype.applyFilter=function(e,t){this.ids instanceof Array?e.setTransparent(this.ids,!this.isOpaque,this.flag,t):console.warn("Ids should be type of array.")},r.TransparentIdsFA.prototype.applyFilterByIds=function(e,t,i){i instanceof Array?e.setTransparent(i,!this.isOpaque,this.flag,t):console.warn("Ids should be type of array.")},r.ConditionFilterAction=function(){r.FilterAction.call(this),this.className="ConditionFilterAction",this.conditions=null},r.ConditionFilterAction.prototype=Object.create(r.FilterAction.prototype),r.ConditionFilterAction.prototype.constructor=r.ConditionFilterAction,r.VisibleConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="VisibleConditionFA",this.flag=e,this.isVisible=t},r.VisibleConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.VisibleConditionFA.prototype.constructor=r.VisibleConditionFA,r.VisibleConditionFA.prototype.applyFilter=function(e){var t=this;this.conditions instanceof Array?(e.matchConditions(this.conditions,(function(i,r){t.flag==r&&(e.setVisible(i,t.isVisible),i=null)})),e.calculateVisibleComponentsBbox()):console.warn("Conditions should be type of array.")},r.VisibleConditionFA.prototype.applyFilterWithFilterMng=function(e,t){var i=this;this.conditions instanceof Array?(e.matchConditionsWithFilterMng(this.conditions,t,(function(t,r){i.flag==r&&(e.setVisible(t,i.isVisible),t=null)})),e.calculateVisibleComponentsBbox()):console.warn("Conditions should be type of array.")},r.OverrideConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="OverrideConditionFA",this.flag=e,null!=t&&(this.material=t)},r.OverrideConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.OverrideConditionFA.prototype.constructor=r.OverrideConditionFA,r.OverrideConditionFA.prototype.applyFilter=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(r,n){i.flag==n&&(e.setMaterial(r,i.material,i.flag,t,!1),r=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionFA.prototype.applyFilterWithFilterMng=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditionsWithFilterMng(this.conditions,t,(function(r,n){i.flag==n&&(e.setMaterial(r,i.material,i.flag,t),r=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionFA.prototype.applyFilterByIds=function(e,t,i){var r=this;this.conditions instanceof Array?e.matchConditionsWithFilterMng(this.conditions,t,(function(n,a){r.flag==a&&e.setMaterial(i,r.material,r.flag,t)})):console.warn("Conditions should be type of array.")},r.OverrideConditionFA.prototype.applyFilterByArryOfIdsAndMaterial=function(e,t,i,r){var n=this;this.conditions instanceof Array?e.matchConditionsWithFilterMng(this.conditions,t,(function(t,a){n.flag==a&&e.setMaterialByArrays(r,i,n.flag)})):console.warn("Conditions should be type of array.")},r.OverrideConditionFA.prototype.setOpacity=function(e){this.opacity=e},r.OverrideConditionFA.prototype.applyFilterByMaterials=function(e,t,i){var r=this;this.conditions instanceof Array?e.matchConditionsWithFilterMng(this.conditions,t,(function(t,n){r.flag==n&&(e.setOpacity(t,i),t=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionForWireFrameFA=function(e,t){r.ConditionFilterAction.call(this),this.className="OverrideConditionForWireFrameFA",this.flag=e,this.material=t},r.OverrideConditionForWireFrameFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.OverrideConditionForWireFrameFA.prototype.constructor=r.OverrideConditionForWireFrameFA,r.OverrideConditionForWireFrameFA.prototype.applyFilter=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(t,r){i.flag==r&&(e.setWireFrameMaterial(t,i.material),t=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionForWireFrameFA.prototype.applyFilterByIds=function(e,t,i){var r=this;this.conditions instanceof Array?e.matchConditionsWithFilterMng(this.conditions,t,(function(n,a){r.flag==a&&e.setWireFrameMaterial(i,r.material,r.flag,t)})):console.warn("Conditions should be type of array.")},r.TransparentConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="TransparentConditionFA",this.flag=e,this.isOpaque=t},r.TransparentConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.TransparentConditionFA.prototype.constructor=r.TransparentConditionFA,r.TransparentConditionFA.prototype.applyFilter=function(e,t){var i=this;if(this.conditions instanceof Array){var n=this.conditions;t&&t instanceof r.BimTileFilterManager&&(n=t._parseConditions(this.conditions)),e.matchConditions(n,(function(t,r){i.flag==r&&(e.setTransparent(t,!i.isOpaque),t=null)}))}else console.warn("Conditions should be type of array.")},r.IsolateConditionFA=function(e){r.ConditionFilterAction.call(this),this.className="IsolateConditionFA",this.isolateHide=e},r.IsolateConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.IsolateConditionFA.prototype.constructor=r.IsolateConditionFA,r.IsolateConditionFA.prototype.applyFilter=function(e,t){e.clearIsolates();var i=this.isolateHide;if(this.conditions instanceof Array){var n=this.conditions;t&&t instanceof r.BimTileFilterManager&&(n=t._parseConditions(this.conditions)),e.matchConditions(n,(function(t,r){1!=r?(i?(e.setIsolateHide(t,!r),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(t,!r),t=null):t=null}))}else console.warn("Conditions should be type of array.")},r.EnumObjectState={Visible:1,HideByIsolate:2,Transparent:4,TransparentByIsolate:8},r.ObjectInfo={userData:null,state:r.EnumObjectState.Visible,material:null},r.ObjectInfoDict=function(){var e={},t={};this.init=function(i){for(var r in e=i)t.hasOwnProperty(r)||void 0===e[r]||(t[r]=Object.keys(e[r]))},this.reinit=function(i){for(var r in e=i)t[r]=Object.keys(i[r])},this.clear=function(){e={},t={}},this.getObjectsMap=function(){return e},this.getObjectIds=function(e){return t.hasOwnProperty(e)?t[e]:[]}},r.ObjectInfoManager=function(){var e=new r.ObjectInfoDict,t=!1,i=!1,n=!1,a=!1,s=!1,o=!1,l=new THREE.Box3,d=!1;this.inactivatedIdMap={},this.inactivatedIds=[],this.bIsInactivateAll=!1,this.localClippingList=new Map,this.hasLocalClipping=!1,this.mapClippingIds=new Map,this.modifyOpacityList=new Map,this.hasModifyOpacityList=!1,this.init=function(t){e.init(t)},this.reinit=function(t){e.reinit(t)},this.clearData=function(){e.clear()},this.getObjectsMap=function(){return e.getObjectsMap()},this.getObjectIds=function(t){return e.getObjectIds(t)},this.calculateVisibleComponentsBbox=function(){l.makeEmpty();var t=e.getObjectsMap();for(var i in t)for(var r=t[i],n=e.getObjectIds(i),a=0,s=n.length;a<s;a++){var o=n[a];this.isHidden(o)||r[o].map((e=>{const t=e.boundingBox;t&&!t.isEmpty()?(l.expandByPoint(t.min),l.expandByPoint(t.max)):console.warn("Object has no boundingBox, id is "+o)}))}d=!1},this.getVisibleComponentsBbox=function(){return(d||l.isEmpty())&&this.calculateVisibleComponentsBbox(),l.clone()},this.needUpdateBoxAfterExplode=function(){d=!0},this.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];t[r]=r}return t},this.matchConditionsWithFilterMng=function(t,i,r,n,a){var s=e.getObjectsMap();for(var o in s){for(var l=[],d=[],h=s[o],c=e.getObjectIds(o),u=0,p=c.length;u<p;u++){var m=c[u],f=h[m][0].userData||{};this.isMatchConditions(f,t)?l.push(m):d.push(m)}n&&a?(r&&r(n,a,l,!0),r&&r(n,a,d,!1)):(r&&r(l,!0),r&&r(d,!1))}},this.isMatchConditions=function(e,t){for(var i=!0,r=0,n=t.length;r<n;r++){var a=t[r];for(var s in a){if(void 0===e[s]){i=!1;break}if(!(a[s]instanceof Array)&&e[s]!=a[s]){i=!1;break}if(a[s]instanceof Array&&-1==a[s].indexOf(e[s])){i=!1;break}}if(1==i)break;r<t.length-1&&(i=!0)}return i},this.matchConditions=function(t,i,r,n){var a=e.getObjectsMap();for(var s in a){for(var o=[],l=[],d=a[s],h=e.getObjectIds(s),c=0,u=h.length;c<u;c++){var p=h[c],m=d[p][0].userData||{};this.isMatchConditions(m,t)?o.push(p):l.push(p)}r&&n?(i&&i(r,n,o,!0),i&&i(r,n,l,!1)):(i&&i(o,!0),i&&i(l,!1))}},this.getMatchIds=function(t){var i=e.getObjectsMap(),r=[];for(var n in i)for(var a=i[n],s=e.getObjectIds(n),o=0,l=s.length;o<l;o++){var d=s[o],h=a[d][0].userData||{};h.elementId=a[d][0].userId,1==this.isMatchConditions(h,t)&&r.push(d)}return r},this.setVisible=function(t,i,a){var s=function(e){i?e.state=e.state|r.EnumObjectState.Visible:(n=!0,e.state=e.state&~r.EnumObjectState.Visible)},o=e.getObjectsMap();for(var l in o){var d=o[l];if(null==a||!0===a)for(var h=0,c=t.length;h<c;h++){var u=t[h];if(d.hasOwnProperty(u)){var p=d[u][0];s(p)}}else{for(var m=this.arrayToMap(t),f=e.getObjectIds(l),g=0,v=f.length;g<v;g++){u=f[g];m.hasOwnProperty(u)||s(p=d[u][0])}m=null}}},this.isVisible=function(t){var i=e.getObjectsMap();for(var n in i){var a=i[n];if(a.hasOwnProperty(t))return a[t][0].state&r.EnumObjectState.Visible>0}},this.clearVisible=function(){var t=e.getObjectsMap();for(var i in n=!1,t)for(var a=t[i],s=e.getObjectIds(i),o=0,l=s.length;o<l;o++){var d=a[s[o]][0];d.state=d.state|r.EnumObjectState.Visible}},this.hideAll=function(){var t=e.getObjectsMap();for(var i in n=!0,t)for(var a=t[i],s=e.getObjectIds(i),o=0,l=s.length;o<l;o++){var d=a[s[o]][0];d.state=d.state&~r.EnumObjectState.Visible}},this.setTransparent=function(i,n,a){var o=function(e){n?(e.state=e.state|r.EnumObjectState.Transparent,t=!0,s=!0):e.state=e.state&~r.EnumObjectState.Transparent},l=e.getObjectsMap();for(var d in l){var h=l[d];if(null==a||!0===a)for(var c=0,u=i.length;c<u;c++){var p=i[c];if(this.isActive(p)&&h.hasOwnProperty(p)){var m=h[p][0];o(m)}}else{for(var f=this.arrayToMap(i),g=e.getObjectIds(d),v=0,y=g.length;v<y;v++){p=g[v];this.isActive(p)&&!f.hasOwnProperty(p)&&o(m=h[p][0])}f=null}}},this.isTransparent=function(t){var i=e.getObjectsMap();for(var n in i){var a=i[n];if(a.hasOwnProperty(t)){var s=a[t][0],o=(s.state&r.EnumObjectState.Transparent)>0;return o=o||(s.state&r.EnumObjectState.TransparentByIsolate)>0}}},this.clearTransparent=function(){var t=e.getObjectsMap();for(var i in s=!1,t)for(var n=t[i],a=e.getObjectIds(i),o=0,l=a.length;o<l;o++){var d=a[o];if(this.isActive(d)){var h=n[d][0];h.state=h.state&~r.EnumObjectState.Transparent}}},this.setOpacity=function(i,r,n){let a=e.getObjectsMap();for(let e in a){let s=a[e];if(null==n||!0===n)for(let e=0,n=i.length;e<n;e++){let n=i[e];if(this.isActive(n)&&s.hasOwnProperty(n)){t=!0;let e=s[n];for(let t=0;t<e.length;t++){let i=e[t],n=!1,a=null;for(let e=0;e<r.length;e++){a=r[e];let t=String(i.nodeId);if(a.nodeIds&&a.nodeIds.includes(t)){n=!0;break}if(!a.nodeIds){n=!0;break}}n&&a&&(i.material=a)}}}}},this.setMaterials=function(i,r,n,a){var s=e.getObjectsMap();for(var o in s){let a=s[o];if(null==n||!0===n)for(var l=0,d=i.length;l<d;l++){var h=i[l];if(this.isActive(h)&&a.hasOwnProperty(h)){t=!0;let e=a[h];for(let t=0;t<e.length;t++){let i=e[t],n=!1,a=null;for(let e=0;e<r.length;e++){a=r[e];let t=String(i.nodeId);if(a.nodeIds&&a.nodeIds.includes(t)){n=!0;break}if(!a.nodeIds){n=!0;break}}n&&a&&(i.material=a)}}}else{for(var c=this.arrayToMap(i),u=e.getObjectIds(o),p=0,m=u.length;p<m;p++){h=u[p];if(this.isActive(h)&&!c.hasOwnProperty(h)){t=!0;let e=a[h];for(let t=0;t<e.length;t++){let i=e[t],n=!1,a=null;for(let e=0;e<r.length;e++){a=r[e];let t=String(i.nodeId);if(a.nodeIds&&a.nodeIds.includes(t)){n=!0;break}if(!a.nodeIds){n=!0;break}}n&&a&&(i.material=a)}}}c=null}}},this.setMaterialByArrays=function(i,r,n){for(let f=0;f<r.length;f++){let g=r[f];var a=e.getObjectsMap();for(var s in a){var o=a[s];if(null==n||!0===n)for(var l=0,d=g.length;l<d;l++){var h=g[l];if(this.isActive(h)&&o.hasOwnProperty(h)){t=!0;let e=o[h];for(let t=0;t<e.length;t++){let r=e[t],n=!1,a=null;for(let e=0;e<i.length;e++){a=i[e];let t=String(r.nodeId);if(a.nodeIds&&a.nodeIds.includes(t)){n=!0;break}if(!a.nodeIds){n=!0;break}}n&&a&&(r.material=a)}}}else{for(var c=this.arrayToMap(g),u=e.getObjectIds(s),p=0,m=u.length;p<m;p++){h=u[p];if(this.isActive(h)&&!c.hasOwnProperty(h)){t=!0;let e=o[h];for(let t=0;t<e.length;t++){let r=e[t],n=!1,a=null;for(let e=0;e<i.length;e++){a=i[e];let t=String(r.nodeId);if(a.nodeIds&&a.nodeIds.includes(t)){n=!0;break}if(!a.nodeIds){n=!0;break}}n&&a&&(r.material=a)}}}c=null}}}},this.setMaterial=function(i,r,n){var a=e.getObjectsMap();for(var s in a){var o=a[s];if(null==n||!0===n)for(var l=0,d=i.length;l<d;l++){var h=i[l];if(this.isActive(h)&&o.hasOwnProperty(h)){t=!0;let e=o[h];for(let t=0;t<e.length;t++){e[t].material=r}}}else{for(var c=this.arrayToMap(i),u=e.getObjectIds(s),p=0,m=u.length;p<m;p++){h=u[p];if(this.isActive(h)&&!c.hasOwnProperty(h)){t=!0;let e=o[h];for(let t=0;t<e.length;t++){e[t].material=r}}}c=null}}},this.getMaterial=function(t){var i=e.getObjectsMap();for(var r in i){var n=i[r];if(n.hasOwnProperty(t))return n[t][0].material}},this.getMaterials=function(t){let i=e.getObjectsMap();for(let e in i){let r=i[e];if(r.hasOwnProperty(t)){let e=r[t],i=[];return e.forEach((e=>{e.material&&i.push(e.material)})),i}}},this.clearMaterial=function(){var t=e.getObjectsMap();for(var i in t){var r=t[i];for(var n in r)if(this.isActive(n)){r[n].forEach((e=>{e.material=null,e.wireFrameMaterial=null}))}}},this.clearAllComponentsMaterial=function(){let t=e.getObjectsMap();for(let e in t){let i=t[e];for(let e in i)if(this.isActive(e)){i[e].forEach((e=>{e.material=null}))}}},this.setWireFrameMaterial=function(t,r,n){var a=e.getObjectsMap();for(var s in a){var o=a[s];if(null==n||!0===n)for(var l=0,d=t.length;l<d;l++){var h=t[l];if(o.hasOwnProperty(h)){var c=o[h][0];c.wireFrameMaterial=r,i=!0}}else{for(var u=this.arrayToMap(t),p=e.getObjectIds(s),m=0,f=p.length;m<f;m++){h=p[m];u.hasOwnProperty(h)||((c=o[h][0]).wireFrameMaterial=r,i=!0)}u=null}}},this.getWireFrameMaterial=function(t){var i=e.getObjectsMap();for(var r in i){var n=i[r];if(n.hasOwnProperty(t))return n[t][0].wireFrameMaterial}},this.clearWireFrameMaterial=function(){var t=e.getObjectsMap();for(var i in t){var r=t[i];for(var n in r)r[n][0].wireFrameMaterial=null}},this.setIsolateHide=function(t,i,n){var s=function(e){i?(a=!0,e.state=e.state|r.EnumObjectState.HideByIsolate):e.state=e.state&~r.EnumObjectState.HideByIsolate},o=e.getObjectsMap();for(var l in o){var d=o[l];if(null==n||!0===n)for(var h=0,c=t.length;h<c;h++){var u=t[h];if(d.hasOwnProperty(u)){var p=d[u][0];s(p)}}else{for(var m=this.arrayToMap(t),f=e.getObjectIds(l),g=0,v=f.length;g<v;g++){u=f[g];m.hasOwnProperty(u)||s(p=d[u][0])}m=null}}},this.isIsolateHide=function(t){var i=e.getObjectsMap();for(var n in i){return(i[n][t][0].state&r.EnumObjectState.HideByIsolate)>0}},this.setIsolateTransparent=function(i,n,a){var s=function(e){n?(e.state=e.state|r.EnumObjectState.TransparentByIsolate,t=!0,o=!0):e.state=e.state&~r.EnumObjectState.TransparentByIsolate},l=e.getObjectsMap();for(var d in l){var h=l[d];if(null==a||!0===a)for(var c=0,u=i.length;c<u;c++){var p=i[c];if(this.isActive(p)&&h.hasOwnProperty(p)){var m=h[p][0];s(m)}}else{for(var f=this.arrayToMap(i),g=e.getObjectIds(d),v=0,y=g.length;v<y;v++){p=g[v];this.isActive(p)&&!f.hasOwnProperty(p)&&s(m=h[p][0])}f=null}}},this.isIsolateTransparent=function(t){var i=e.getObjectsMap();for(var n in i){var a=i[n];if(a.hasOwnProperty(t))return(a[t][0].state&r.EnumObjectState.TransparentByIsolate)>0}},this.clearIsolateHide=function(){var t=e.getObjectsMap();for(var i in a=!1,t){var r=e.getObjectIds(i);r.length>0&&this.setIsolateHide(r,!1)}},this.clearIsolates=function(){var t=e.getObjectsMap();for(var i in o=!1,a=!1,t){var r=e.getObjectIds(i);r.length>0&&(this.setIsolateHide(r,!1),this.setIsolateTransparent(r,!1))}},this.setIsolateHideAfterClear=function(e,t,i){this.clearIsolates(),this.setIsolateHide(e,t,i)},this.setIsolateTransparentAfterClear=function(e,t,i){this.clearIsolates(),this.setIsolateTransparent(e,t,i)},this.clearTransparentByIsolate=function(){var t=e.getObjectsMap();for(var i in o=!1,t)for(var n=t[i],a=e.getObjectIds(i),s=0,l=a.length;s<l;s++){var d=a[s];if(this.isActive(d)){var h=n[d][0];h.state=h.state&~r.EnumObjectState.TransparentByIsolate}}},this.isHidden=function(t){var i=e.getObjectsMap();for(var n in i){var a=i[n];if(a&&a.hasOwnProperty(t)){var s=a[t][0],o=0==(s.state&r.EnumObjectState.Visible);return o=o||(s.state&r.EnumObjectState.HideByIsolate)>0}}},this.isFrozen=function(t){var i=e.getObjectsMap();for(var n in i){var a=i[n];if(a.hasOwnProperty(t)){var s=a[t][0],o=(s.state&r.EnumObjectState.Transparent)>0;return o=o||(s.state&r.EnumObjectState.TransparentByIsolate)>0}}},this.resetAll=function(){var i=e.getObjectsMap();for(var l in i)for(var d=i[l],h=e.getObjectIds(l),c=0,u=h.length;c<u;c++){var p=h[c];if(d[p][0].state|=r.EnumObjectState.Visible,this.isActive(p)){d[p].forEach((e=>{e.material=null}))}}t=!1,n=a=!1,s=o=!1},this.hasOverrideMaterial=function(i){var r=e.getObjectsMap();if(null==i)return t;for(var n in r){var a=r[n];if(a.hasOwnProperty(i))return null!=a[i][0].material||this.isTransparent(i)}},this.hasOverrideMaterialForWireFrame=function(t){var r=e.getObjectsMap();if(null==t)return i;for(var n in r){var a=r[n];if(a.hasOwnProperty(t))return null!=a[t][0].wireFrameMaterial}},this.hasObjectInactivated=function(){return this.inactivatedIds.length>0},this.hasObjectHidden=function(){return n||a},this.hasObjectCantSelected=function(){return this.hasObjectHidden()||this.hasObjectTransparent()||this.hasObjectInactivated()},this.hasObjectTransparent=function(){if(this.hasObjectInactivated()){var e=!1;for(const t of this.inactivatedIds)if(this.isTransparent(t)){e=!0;break}return e}return s||o},this.deactivateByIds=function(e){for(const t of e)this.inactivatedIdMap[t]=!0;this.inactivatedIds=Object.keys(this.inactivatedIdMap)},this.clearInactivatedIdMap=function(){this.inactivatedIdMap={},this.inactivatedIds=[]},this.isActive=function(e){return 0==this.bIsInactivateAll&&!(1==this.inactivatedIdMap[e])},this.deactivateAll=function(){this.bIsInactivateAll=!0},this.activateAll=function(){this.bIsInactivateAll=!1},this.getInactivatedIdMap=function(){return this.inactivatedIdMap},this.addToModifyOpacityList=function(e,t){var i=this.modifyOpacityList;void 0===i.get(e)&&i.set(e,{}),i.get(e).opacity=t,this.hasModifyOpacityList=!0},this.removeModifyOpacityList=function(e){let t=this.modifyOpacityList;e.map((e=>{t.delete(e)})),0===Object.keys(t)&&(this.hasModifyOpacityList=!1)},this.clearModifyOpacityList=function(){this.modifyOpacityList=new Map,this.hasModifyOpacityList=!1},this.addToLocalClippingList=function(e,t,i,n){var a=this.localClippingList;void 0===a.get(e)&&a.set(e,{}),r.Utils.isDefined(n)&&(null==a.get(e).nodeMap&&(a.get(e).nodeMap=new Map),a.get(e).nodeMap.set(n.toString(),t)),i&&(a.get(e).wireframeMaterialName=i),this.hasLocalClipping=!0},this.clearLocalClippingList=function(){this.localClippingList=new Map,this.hasLocalClipping=!1},this.activeLocalClipping=function(){this.hasLocalClipping=!0},this.setClippingIds=function(e){this.mapClippingIds=e},this.clearClippingIds=function(){this.mapClippingIds.clear()},this.hasObjectClipped=function(){return this.mapClippingIds.size>0},this.isClipped=function(e){return this.mapClippingIds.has(e)}},r.FilterManagerIO=function(e){this.materialSelector=e;var t=function(e){var t=[];for(var i in e)1==e[i]&&t.push(i);return t};this.saveState=function(e){const t=e.getIsolateFilterAction(),i=e.getFilterActionList(),r=JSON.parse(JSON.stringify(t)),n=JSON.parse(JSON.stringify(i));((t,i)=>{if(!e._parseIndexIds)return;t&&t.ids&&t.ids.length>0&&(r.ids=e._parseIndexIds(t.ids));const a=i.length;for(let t=0;t<a;++t){if(!(i[t].ids&&i[t].ids.length>0))return;n[t].ids=e._parseIndexIds(i[t].ids)}})(t,i),(e=>{const t=e.length;for(let i=0;i<t;++i){if(!(e[i].ids&&e[i].ids.length>0))return;n[i].material=e[i].material,n[i].ids=e[i].ids}})(i);return{isolateAction:r,actions:n,sceneState:e.getSceneState(),version:"1.0"}},this.addOverrideCondition=function(e,t,i,n){if(null!=e.opacity)if(i&&i instanceof r.BimTileFilterManager){var a=(t,r)=>{if(r){for(let r=0;r<t.length;r++)i.addToModifyOpacityList(t[r],e.opacity);i.addToOverrideListByOpacityAndConditions(e.conditions,e.opacity)}};i.addToOpacityListByConditions(e.conditions,a)}else{i.getIdsWithConditions(e.conditions).forEach((t=>{const r={type:"conditions",param:e.conditions};let n=i.findColorMap(t,i.model,e.opacity),a=[],s=[];for(const e in n){const t=n[e];a.push(t.ids),s.push(t.color)}i.overrideComponentsOpacity(r,e.opacity,a,s)}))}else if(e.originOpacity){a=(t,a)=>{if(a){i.objectInfoManager.removeModifyOpacityList(t);let a=i.findOriginOpacityMaterialsMatchIds(i.model,t);n=new r.OverrideConditionFA(!0),e.originOpacity&&(n.originOpacity=e.originOpacity),n.conditions=e.conditions,i.pushBackByMaterials(n,a)}};i.addToOpacityListByConditions(e.conditions,a)}else{a=(a,s)=>{s&&((n=new r.OverrideConditionFA(e.flag,t)).conditions=e.conditions,i.pushBackByIds(n,a))};i.addToOpacityListByConditions(e.conditions,a)}},this.createAction=function(e,t){var i=e.className,n=null;switch(i){case"IsolateIdsFA":(n=new r.IsolateIdsFA(e.isolateHide)).ids=e.ids;break;case"VisibleIdsFA":(n=new r.VisibleIdsFA(e.flag,e.isVisible)).ids=e.ids;break;case"OverrideIdsFA":case"OverrideIdsForWireFrameFA":if(o=e.material){var a={color:o.color};if(o.hasOwnProperty("opacity")&&(a.opacity=o.opacity),o.hasOwnProperty("transparent")&&(a.setByOpacity=o.transparent),o.hasOwnProperty("vertexColors")&&(a.useVertexColor=o.vertexColors),e.textureName)o=this.materialSelector.get(e.textureName);else{var s=this.materialSelector.getMaterialNameByColor(a);o=this.materialSelector.get(s)}}"OverrideIdsFA"===i?(n=new r.OverrideIdsFA(e.flag,o),e.manipulateAllElement?n.ids=[]:n.ids=e.ids,e.opacity&&(n.opacity=e.opacity),e.originOpacity&&(n.originOpacity=e.originOpacity),e.textureName&&(n.textureName=e.textureName)):(n=new r.OverrideIdsForWireFrameFA(e.flag,o),e.manipulateAllElement?n.ids=[]:n.ids=e.ids);break;case"TransparentIdsFA":(n=new r.TransparentIdsFA(e.flag,e.isOpaque)).ids=e.ids;break;case"VisibleConditionFA":(n=new r.VisibleConditionFA(e.flag,e.isVisible)).conditions=e.conditions;break;case"OverrideConditionFA":case"OverrideConditionForWireFrameFA":var o;if(o=e.material){a={opacity:o.opacity,color:o.color},s=this.materialSelector.getMaterialNameByColor(a);o=this.materialSelector.get(s)}"OverrideConditionFA"===i?this.addOverrideCondition(e,o,t,n):(n=new r.OverrideConditionForWireFrameFA(e.flag,o)).conditions=e.conditions;break;case"TransparentConditionFA":(n=new r.TransparentConditionFA(e.flag,e.isOpaque)).conditions=e.conditions;break;case"IsolateConditionFA":(n=new r.IsolateConditionFA(e.isolateHide)).conditions=e.conditions;break;default:r.Logger.warn("Warning: Not supported filterAction '"+i+"'")}return n},this.createActionByOldFilter=function(e,i){var n=[];switch(e){case"CONDITION_OVERRIDE":for(var a=[],s=0;s<i.length;s++){var o=i[s];a.push(o.condition)}var l=o.color,d=this.materialSelector.add(l),h=this.materialSelector.get(d);(f=new r.OverrideConditionFA(!0,h)).conditions=a,n.push(f);break;case"CONDITION_TRANSLUCENT_OTHERS":(f=new r.TransparentConditionFA(!1,!1)).conditions=i,n.push(f);break;case"ISOLATE_CONDITION_HIDEEN_OTHERS":(f=new r.IsolateConditionFA(!0)).conditions=i,n.push(f);break;case"ISOLATE_CONDITION_TRANSLUCENT_OTHERS":(f=new r.IsolateConditionFA(!1)).conditions=i,n.push(f);break;case"ISOLATE_HIDDEN_OTHERS":(f=new r.IsolateIdsFA(!0)).ids=t(i),n.push(f);break;case"ISOLATE_TRANSLUCENT_OTHERS":(f=new r.IsolateIdsFA(!1)).ids=t(i),n.push(f);break;case"OVERRIDEFILTER":for(var c in i)if(i.hasOwnProperty(c)){var u=[],p=i[c];for(var m in p)u.push(m);l=this.materialSelector.getMaterialParamsFromName(p[m]),d=this.materialSelector.add(l),h=this.materialSelector.get(d);(f=new r.OverrideIdsFA(!0,h)).ids=u,n.push(f)}break;case"TRANSLUCENT":(f=new r.TransparentIdsFA(!0,!1)).ids=t(i),n.push(f);break;case"TRANSLUCTANT_OTHERS":(f=new r.TransparentIdsFA(!1,!1)).ids=t(i),n.push(f);break;case"VISIBLE":var f;(f=new r.VisibleIdsFA(!0,!0)).ids=t(i),n.push(f);break;default:r.Logger.warn("Warning: Not supported filter '"+e+"'")}return n},this.pushBackAction=function(e,t,i){switch(e.className){case"OverrideIdsFA":if(e.manipulateAllElement)i.pushBackByIds(t,e.ids);else if(e.opacity)if(i&&i instanceof r.BimTileFilterManager){for(let t=0;t<e.ids.length;t++)i.addToModifyOpacityList(e.ids[t],e.opacity);i.pushBackNoApply(t)}else{const t={type:"ids",param:e.ids};let r=i.findColorMap(e.ids,i.model,e.opacity),n=[],a=[];for(const e in r){const t=r[e];n.push(t.ids),a.push(t.color)}i.overrideComponentsOpacity(t,e.opacity,n,a)}else if(e.originOpacity){i.objectInfoManager.removeModifyOpacityList(e.ids);let r=i.findOriginOpacityMaterialsMatchIds(i.model,e.ids);i.pushBackByMaterials(t,r)}else i.pushBackWithFilterMng(t);break;case"OverrideIdsForWireFrameFA":case"TransparentIdsFA":case"VisibleIdsFA":i.pushBackByIds(t,e.ids);break;case"VisibleConditionFA":i.pushBackWithFilterMng(t);break;case"OverrideConditionForWireFrameFA":i.addToOpacityListByConditions(e.conditions,((e,r)=>{r&&i.pushBackByIds(t,e)}));break;case"OverrideConditionFA":break;default:i.pushBack(t)}},this.loadState=function(e,t){t.clearFilterActionList(),t.getObjectInfoManager().resetAll();var i=e;if(i.hasOwnProperty("version"))if("1.0"==i.version){var r=i.isolateAction;if(r){var n=this.createAction(r);t.pushBack(n)}for(var a=i.actions,s=0;s<a.length;s++){n=this.createAction(a[s],t);this.pushBackAction(a[s],n,t)}}else if("0.4"==i.version){for(var o={},l=t._filterImpl.getBasicFilterList(),d=(s=0,l.length);s<d;s++)o[l[s].getName()]=s;for(var h in i)if("sceneState"!==h&&"version"!==h&&o.hasOwnProperty(h)){if("{}"==JSON.stringify(i[h])||"[]"==JSON.stringify(i[h]))continue;var c=this.createActionByOldFilter(h,i[h]);for(s=0;s<c.length;s++)t.pushBack(c[s])}}t.setSceneState(i.sceneState)}},function(){class e extends r.BaseModel{constructor(e,t,i,n,a,s){super(t,i),this.viewer=e,this.unitScale=1,this.pntLoader=new r.PntLoader(5,this.unitScale),this.index=n,this.parseCfgFinish=a,this.debut=s,this.url=i.serverUrl+""+i.databagId+"/tileset.json"}destroy(){super.destroy(),this.pntLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START}),this.pntLoader.loadPntTotalJson(this.url,(function(e){var i=new THREE.Vector3(e[0],e[1],e[2]),r=new THREE.Vector3(e[3],e[4],e[5]),n=new THREE.Vector3(e[6],e[7],e[8]),a=new THREE.Vector3(e[9],e[10],e[11]),s=r.clone().add(n).add(a);t.getTransforms().boundingBox=new THREE.Box3(i.clone().sub(s),i.clone().add(s)),t.manager.updateScene(t)})).then((e=>{let i=t.viewer.getScene().getRawMatrixGlobal(),n=new THREE.Matrix4;n.copy(i).invert();let a=t.viewer.getScene(),s=(new THREE.Matrix4).makeScale(t.unitScale,t.unitScale,t.unitScale);for(const t of e)t.matrix.copy(i).multiply(s),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0),a.children[0].add(t);t.viewer.addRenderCallback((function(){let e=t.viewer.domElement.offsetHeight;t.pntLoader.updatePreSse(t.viewer.camera,e),t.pntLoader.ProcessTileIndexs(t.viewer.camera,n)})),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t)}))}}r.PointCloudModel=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,n,a){super(t,i),this._viewer=e,this._configLoadCb=n,this._modelLoadCb=a,this._loader=new r.GeoJsonModelLoader,this._crs=null,this.features=[],this._parser=new r.GeoJsonParser(e);const s=`${i.serverUrl}${i.databagId}`;this.url=`${s}/../../../metadata/Points.json.gz`}load(e){this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this._configLoadCb&&this._configLoadCb();const t=this;this._loader.loadModel(t.url).then((e=>{t._getBoundingBox(e),t._parser.parse(e,t),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t)})).catch((()=>{console.log(`load model ${t.url} failed`)}))}getFeatureByID(e){if(r.Utils.isDefined(this.features[e]))return this.features[e]}getAllFeature(){return this.features}select(e){if(!r.Utils.isDefined(e.key))return this.getAllFeature();const t=e.key+"",i=e.value+"";let n=[];for(let e=0;e<this.features.length;++e){let r=this.features[e];r.properties[t]===i&&n.push(r)}return n}_getBoundingBox(e){const t=this._viewer;let i=new THREE.Vector3;if(r.Utils.isDefined(t.basePointPositionOnLonLat)&&r.Utils.isDefined(e.center)){const n=new THREE.Vector3;r.Projection.lonLatToGauss(new THREE.Vector2(t.basePointPositionOnLonLat[0],t.basePointPositionOnLonLat[1]),r.geoCoordinateSystem.WGS84,n,{span:3,withLineCode:!1});const a=new THREE.Vector3;r.Projection.lonLatToGauss(new THREE.Vector2(e.center[0],e.center[1]),r.geoCoordinateSystem.WGS84,a,{span:3,withLineCode:!1});const s=new THREE.Vector2;s.subVectors(a,n),i.setX(s.x),i.setY(s.y)}let n=r.Utils.box3FromSize(i,new THREE.Vector3(e.size[0],e.size[1],e.size[2]));this.getTransforms().boundingBox=n,this.manager.updateScene(this)}}r.PointModel=e}(),function(){class e extends r.PointModel{constructor(e,t,i){super(t,t,i),this.id=i.modelId,this.databagId=this.id,this._viewer=e,this.features={};const n=`${i.serverUrl}/${i.databagId}`;i.rootPath?this.url=`${n}/${i.rootPath}`:this.url=`${n}/../../../metadata/Points.json.gz`;const a=`${this.id}_${r.ObjectGroupType.GEOJSONGROUP}`;this.objectGroup=e.getScene().getOrCreateObjectGroup(a,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroup.renderOrder=r.EnumRenderOrder.WireFrame}destroy(){this._loader=null,this._parser=null,this.features=null,this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.GEOJSONGROUP),super.destroy()}setVisible(e){this.visible=e,this.objectGroup&&(this.objectGroup.visible=e)}load(e){this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this._configLoadCb&&this._configLoadCb();const t=this;this._loader.loadModel(t.url).then((e=>{t._getBoundingBox(e),t._parser.parse(e,t),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t)})).catch((()=>{console.log(`load model ${t.url} failed`)}))}addFeature(e,t){this.features[e]=t}createLineMesh(e,t){let i=null;i=!0===t.useLineWidth?new r.MeshLineMaterial({color:t.color,opacity:t.opacity,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),linewidth:t.lineWidth,sizeAttenuation:!0,depthWrite:!1,transparent:!0}):new r.LineBasicMaterial({color:t.color});for(const n in e){let a,s,o=e[n];!0===t.useLineWidth?(a=new r.MeshLineGeometry,a.setPositions(o),s=new r.MeshLine(a,i)):(a=new THREE.BufferGeometry,a.setAttribute("position",new THREE.Float32BufferAttribute(o,3)),s=new THREE.Line(a,i)),this.getFeatureByID(n).addMesh(s),this.objectGroup.add(s),s.updateMatrixWorld(!0),o.length=0}e=null}getFeatureByID(e){if(r.Utils.isDefined(this.features[e]))return this.features[e]}getAllFeature(){return this.features}select(e){if(!r.Utils.isDefined(e.key))return this.getAllFeature();const t=e.key+"",i=e.value+"";let n=[];return this.features.map((e=>{e.properties[t]===i&&n.push(e)})),n}updateMaterialByFeatureIds(e,t){const i=new r.MeshLineMaterial({color:t.color,opacity:t.opacity,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),linewidth:t.lineWidth,sizeAttenuation:!0,depthWrite:!1,transparent:!0});e.map((e=>{const t=this.getFeatureByID(e);if(!t)return;t.meshList.map((e=>{e.material=i}))}))}}r.LineModel=e}(),r.GeoJsonModelLoader=class{constructor(){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json")}loadModel(e){return new Promise(((t,i)=>{this.jsonLoader.load(e,(function(e){t(e)}),void 0,(function(){i()}))}))}},function(){class e{constructor(){this._geometryLngLat=null,this._geometryWorld=null,this._properties=null,this._id=null,this.type="point"}get properties(){return this._properties}set properties(e){this._properties=e}get geometry(){return this._geometryLngLat}get geometryWorld(){return this._geometryWorld}get id(){return this._id}set id(e){this._id=e}}function t(e,t,i,n){if(r.Utils.isDefined(e.geometry)){var a=e.geometry.type,o=s[a];r.Utils.isDefined(o)?o(e,t,i,n):console.log("Unknown geometry type")}}function i(e,t,i,n){!function(e,t,i,n,a){const s=new r.LineFeature;s.id=e.id,s._geometryLngLat=[];for(let e=0;e<t.length;e++){const i=t[e];let r=[];for(let e=0;e<i.length;e++){const t=i[e],n=new THREE.Vector2(t[0],t[1]);r.push(n)}s._geometryLngLat.push(r)}const o=e.properties;r.Utils.isDefined(o)&&(s.properties=o);n.addFeature(e.id,s)}(e,e.geometry.coordinates,0,i)}function n(e,t,i,n,a){const s=new r.PointFeature;s.id=e.id;new THREE.Vector2;let o=new THREE.Vector2(t[0],t[1]);s._geometryLngLat=o,s.geometry.crsFunction=i;var l=e.properties;r.Utils.isDefined(l)&&(s.properties=l),n.features.push(s)}var a={FeatureCollection:function(e,i,r,n){for(var a=e.features,s=0,o=a.length;s<o;s++)t(a[s],i,r,n)}},s={Point:function(e,t,i,r){n(e,e.geometry.coordinates,t,i,r)},MultiPoint:function(e,t,i,r){for(var a=e.geometry.coordinates,s=0;s<a.length;s++)n(e,a[s],t,i,r)},Polygon:i,MultiPolygon:function(e,t,i,n){!function(e,t,i,n,a){const s=new r.LineFeature;s.id=e.id,s._geometryLngLat=[],t.map((e=>{e.map((e=>{let t=[];e.map((e=>{const i=new THREE.Vector2(e[0],e[1]);t.push(i)})),s._geometryLngLat.push(t)}))}));const o=e.properties;r.Utils.isDefined(o)&&(s.properties=o);n.addFeature(e.id,s)}(e,e.geometry.coordinates,0,i)},LineString:i},o={"EPSG:4549":"CGCS_GAUSS_3_ZONE_40","EPSG:4326":"EPSG:4326"};r.PointFeature=e,r.LineFeature=class extends e{constructor(){super(),this.type="Line",this._meshList=[]}get meshList(){return this._meshList}addMesh(e){this._meshList.push(e)}clearMesh(){this._meshList.length=0}},r.GeoJsonParser=class{constructor(e){this._viewer=e}parse(e,t){let i=a[e.type];if(!r.Utils.isDefined(i))return void console.log("Unsupported GeoJSON object type: "+e.type);let n=e.crs,s=null;if(r.Utils.isDefined(n)){if(!r.Utils.isDefined(n.properties))return void console.log("crs.properties is undefined.");if(s=function(e){const t=e.properties;let i=null;"name"===e.type?(i=o[t.name],r.Utils.isDefined(i)||console.log(`Unknown crs name: ${t.name}`)):"EPSG"===e.type?(i=o["EPSG:"+t.code],r.Utils.isDefined(i)||console.log(`Unknown crs EPSG code: ${t.code}`)):console.log(`Unknown crs type: ${e.type}`);return i}(n),!r.Utils.isDefined(s))return void console.log("Unknown crs type")}return i(e,s,t,this._viewer),this.features}}}();r.BatchTable=class{constructor(e,t,i){void 0!==t&&console.warn("Binary batch table content not supported yet."),this.content=e,null!=i?this.batchLength=i:0===Object.keys(this.content).length?(console.warn("Batch table is empty."),this.batchLength=0):this.batchLength=this.content[Object.keys(this.content)[0]].length,this.extensions={}}getPickingInfo(e){const t={};if(0===this.batchLength)return;if(e<0)throw new Error(`Batch Id (${e}) must be positive to access\n            feature properties from the batch table.`);if(!(e<this.batchLength))throw new Error(`Batch Id (${e}) must be inferior to batch length\n                (${this.batchLength}) to access feature properties in batch\n                table.`);Object.keys(this.content).forEach((i=>{t[i]=this.content[i][e]}));const i={BatchTable:t};return this.extensions&&Object.keys(this.extensions).forEach((t=>{const r={[t]:this.extensions[t].getPickingInfo(e)};Object.assign(i,r)})),i}removeExtensionFromContent(e){this.content.extensions[e]&&delete this.content.extensions[e],0===Object.keys(this.content.extensions).length&&delete this.content.extensions}};class U{constructor(){}}U.parse=function(e,t,i){let n,a=e;t>0&&(n=e.slice(e.byteLength-t),a=e.slice(0,e.byteLength-t));const s=new TextDecoder("utf-8").decode(new Uint8Array(a)),o=JSON.parse(s),l=new r.BatchTable(o,n,i);return Promise.all([]).then((()=>l))},r.BatchTableParser=U,r.B3dmParser=class{constructor(){this.utf8Decoder=new TextDecoder("utf-8"),this.glTFLoader=new THREE.GLTFLoader,this.glTF2Loader=new THREE.GLTF2Loader,this.matrixChangeUpVectorZtoY=(new THREE.Matrix4).makeRotationX(Math.PI/2),this.matrixChangeUpVectorZtoX=(new THREE.Matrix4).makeRotationZ(-Math.PI/2)}b3dmToMesh(e,t){var i={gltfUpAxis:void 0,urlBase:THREE.LoaderUtils.extractUrlBase(t),overrideMaterials:!1,doNotPatchMaterial:void 0,opacity:1};return this.parse(e,i).then((function(e){return{batchTable:e.batchTable,object3d:e.gltf.scene}}))}filterUnsupportedSemantics(e){const t=["MODELVIEW","MODELVIEWINVERSETRANSPOSE","PROJECTION","JOINTMATRIX"];if(e.gltfShader){const i=[];for(const t in e.gltfShader.boundUniforms)i.push(t);for(const r of i){const i=e.gltfShader.boundUniforms[r].semantic;t.includes(i)||delete e.gltfShader.boundUniforms[r]}}}parse(e,t){var i=this;const n=t.gltfUpAxis,a=t.urlBase;if(!e)throw new Error("No array buffer provided.");const s=new DataView(e,4);let o=0;const l={};if(l.magic=i.utf8Decoder.decode(new Uint8Array(e,0,4)),l.magic){l.version=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.byteLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.FTJSONLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.FTBinaryLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.BTJSONLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.BTBinaryLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT;const d=o+4,h=[];let c={};const u=new THREE.Vector3;if(l.FTJSONLength>0){const t=d,r=e.slice(t,l.FTJSONLength+t),n=i.utf8Decoder.decode(new Uint8Array(r));c=JSON.parse(n),c.RTC_CENTER?u.fromArray(c.RTC_CENTER):u.set(0,0,0)}if(l.FTBinaryLength>0&&console.warn("3D Tiles feature table binary not supported yet."),l.BTJSONLength>0){const t=d+l.FTJSONLength+l.FTBinaryLength;h.push(r.BatchTableParser.parse(e.slice(t,l.BTJSONLength+t),l.BTBinaryLength,c.BATCH_LENGTH))}else h.push(Promise.resolve({}));const p=d+l.FTJSONLength+l.FTBinaryLength+l.BTJSONLength+l.BTBinaryLength,m=e.slice(p),f=new DataView(m,0,20);return h.push(new Promise((e=>{const r=r=>{for(const e of r.scenes)e.traverse(i.filterUnsupportedSemantics);void 0===n||"Y"===n?r.scene.applyMatrix4(i.matrixChangeUpVectorZtoY):"X"===n&&r.scene.applyMatrix4(i.matrixChangeUpVectorZtoX),r.scene.position.copy(u);const a=new Uint8Array(m,20,f.getUint32(12,!0)),s=i.utf8Decoder.decode(new Uint8Array(a)),o=JSON.parse(s);o.extensions&&o.extensions.CESIUM_RTC&&(r.scene.position.fromArray(o.extensions.CESIUM_RTC.center),r.scene.updateMatrixWorld(!0)),r.scene.traverse((function(e){if(e.frustumCulled=!1,e.material){if(t.overrideMaterials){if(Array.isArray(e.material))for(const t of e.material)t.dispose();else e.material.dispose();"object"==typeof t.overrideMaterials&&t.overrideMaterials.isMaterial?e.material=t.overrideMaterials:e.material=new THREE.MeshLambertMaterial({color:16777215})}e.material.transparent=t.opacity<1,e.material.opacity=t.opacity}})),e(r)};1===f.getUint32(4,!0)?i.glTFLoader.parse(m,r,a):i.glTF2Loader.parse(m,r,a)}))),Promise.all(h).then((e=>({gltf:e[1],batchTable:e[0]})))}throw new Error("Invalid b3dm file.")}parseFeatureBinary(e,t,i){const r=new THREE.BufferGeometry,n=this.utf8Decoder.decode(new Uint8Array(e,t,i)),a=JSON.parse(n);let s;if(a.POINTS_LENGTH&&(s=a.POINTS_LENGTH),a.POSITION){const i=a.POSITION.byteOffset+n.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("position",new THREE.BufferAttribute(o,3))}if(a.RGB){const i=a.RGB.byteOffset+n.length+t,o=new Uint8Array(e,i,3*s);r.setAttribute("color",new THREE.BufferAttribute(o,3,!0))}if(a.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(a.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(a.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(a.NORMAL){const i=a.RGB.byteOffset+n.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(a.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(a.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:r,offset:a.RTC_CENTER?(new THREE.Vector3).fromArray(a.RTC_CENTER):void 0}}},function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._loader=e._loader}destroy(){super.destroy(),this._loader=void 0}parseTileContent(e){this._loader.parseTileContent(this._tile,this._contentBuffer,(function(t){e(t)}))}attachToTilesGroup(e){e.object3d?this._addB3dmMesh(e.object3d):this._addPointMesh(e.point)}_addB3dmMesh(e){const t=this._tile._tileset._objectGroup,i=this.meshes;for(let t=0,r=e.children.length;t<r;++t)i.add(e.children[0]);t.add(i),t.updateMatrixWorld(!0)}_addPointMesh(e){const t=this._tile._tileset._objectGroup,i=this.meshes,r=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),n=new THREE.Points(e.geometry,r);e.offset&&n.position.copy(e.offset),i.add(n),t.add(i),t.updateMatrixWorld(!0)}}r.$3dTileContent=e}(),function(){class e extends r.AbstractTile{constructor(e,t,i,r){super(e,t),this._loader=e._loader,this._header=i,this._contentFolder=r,this.matrix=null,this.initialize()}destroy(){super.destroy(),this.matrix=void 0,this._loader=void 0,this._header=void 0,this._contentFolder=void 0}initialize(){this._parseTile(this._tileset,this,this._header,this._contentFolder)}_parseTile(e,t,i,n){if(t.boundingBox=r.TilesUtil.getBox(i.boundingVolume),i.refine?("replace"!==i.refine&&"add"!==i.refine||console.warn("lowercase-refine",'This tile uses a lowercase refine "'+i.refine+'". Instead use "'+i.refine.toUpperCase()+'".'),t.refineReplace="REPLACE"===i.refine.toUpperCase()):t.parent?t.refineReplace=t.parent.refineReplace:t.refineReplace=!0,t.geometricError=i.geometricError,i.content?(t.contentUrl=i.content.uri||i.content.url,t.contentUrl.endsWith(".b3dm")?t.contentType=r.TileContentType.DATA_B3DM:t.contentUrl.endsWith(".json")?t.contentType=r.TileContentType.DATA_TILE:t.contentUrl.endsWith(".pnts")?t.contentType=r.TileContentType.DATA_POINT:t.contentType=r.TileContentType.DATA_NULL,t.contentIndex=n+t.contentUrl):t.contentType=r.TileContentType.DATA_NULL,t.contentTypeEmpty&&(t._contentState=r.TileContentState.READY),i.transform&&(t.matrix=(new THREE.Matrix4).fromArray(i.transform)),i.children)for(const a of i.children)new r.$3dTileNode(e,t,a,n)}fetchContentBlock(e,t,i){this._loader.loadArrayBufferImmediately(e,(function(e){t(e)}),(function(e){i(e)}))}createContent(e){return new r.$3dTileContent(this,e)}}r.$3dTileNode=e}(),r.$3dTileLoader=class{constructor(){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json"),this.arrayBufferLoader=new THREE.FileLoader,this.arrayBufferLoader.setResponseType("arraybuffer"),this.taskRunner=new r.LoadTaskRunner(6),this.utf8Decoder=new TextDecoder("utf-8"),this.b3dmParser=new r.B3dmParser,this.pntParser=new r.PntsParser}destroy(){this.jsonLoader=null,this.arrayBufferLoader=null,this.taskRunner=null,this.utf8Decoder=null,this.b3dmParser=null,this.pntParser=null}loadJson(e,t,i){this.taskRunner.push(this.jsonLoader,e,t,(function(e){i&&i(e)}))}loadArrayBuffer(e,t,i){this.taskRunner.push(this.arrayBufferLoader,e,t,(function(e){i&&i(e)}))}loadArrayBufferImmediately(e,t,i){this.arrayBufferLoader.load(e,(function(e){t(e)}),void 0,(function(){i&&i(event)}))}parseTileContent(e,t,i){if(!t)return;const r=this,n=r.utf8Decoder.decode(new Uint8Array(t,0,4));if("{"!==n[0])if("b3dm"==n){console.log("b3dm is load");const n=e.getAbsoluteContentUrl();r.b3dmParser.b3dmToMesh(t,n).then((e=>{i(e)}))}else"pnts"==n?(console.log("pnts is load"),r.pntParser.parse(t).then((e=>{i(e)}))):console.log("Unsupported magic code:"+n)}},function(){class e extends r.AbstractTileset{constructor(e){super(e),this._loader=e.loader,this.maximumScreenSpaceError=void 0}destroy(){super.destroy(),this._loader=void 0}loadTileset(e,t){const i=this;this._loader.loadJson(e,void 0,(function(n){const a=e.slice(0,e.lastIndexOf("/")+1),s=i.createTile(a,n.context);void 0===s&&r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Tile data error!"),i.root=s,i._boundingBox=s.boundingBox.clone(),i.maximumScreenSpaceError=s.geometricError*r.TilesUtil.OP_GEOMETRIC_ERROR_COEFFICIENT,t&&t(i)}))}createTile(e,t,i){if(t.root&&t.root.boundingVolume)return new r.$3dTileNode(this,i,t.root,e)}loadChildrenOfTile(e,t,i){const r=this,n=e.getAbsoluteContentUrl(),a=n.slice(0,n.lastIndexOf("/")+1);this._loader.loadJson(n,t,(function(t){if(r.isDestroyed())return;const n=r.createTile(a,t.context,e);i&&i(n)}))}updateFrameState(e){e.transformMatrixUpdated=!1,e.maximumScreenSpaceError=this.maximumScreenSpaceError}updateGlobalMatrix(e){this._objectGroup.matrix.copy(e),this._objectGroup.matrix.multiplyMatrices(e,this._transformMatrix),this._objectGroup.matrixAutoUpdate=!1,this._objectGroup.updateMatrixWorld(!0)}statisticsMeshInformation(){for(var e={meshCount:0,visibleCount:0},t=this._objectGroup.children,i=0,n=t.length;i<n;i++){var a=t[i];r.Utils.isGroupObject(a)&&(e.meshCount++,a.visible&&e.visibleCount++)}return e}hideAllMesh(){for(var e in this._objectGroup.children)this._objectGroup.children[e].visible=!1}}r.$3dTileset=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,n,a,s){super(t,i),this.viewer=e,this.index=n,this.parseCfgFinish=a,this.debut=s,this.url=i.serverUrl+""+i.databagId+"/tileset.json",this.tilesLoader=new r.$3dTileLoader,this.objectGroup=t.getScene().getOrCreateObjectGroup(r.GlobalData.TdTileGroupName,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),i.loadConfig&&i.loadConfig.transformMatrix?(this.setTransformMatrix(i.loadConfig.transformMatrix),this.objectGroup.transformMatrix=this.transformMatrix):(this.setTransformMatrix(new THREE.Matrix4),this.objectGroup.transformMatrix=this.transformMatrix),this._tileset=new r.$3dTileset({loader:this.tilesLoader,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,tilesCacheScheduler:this.manager.tilesCacheScheduler,debugShowBoundingBox:e._options.debugShowBoundingBox,debugShowStatistics:e._options.debugShowStatistics,databagId:this.databagId}),this._modelMatrix=new THREE.Matrix4}destroy(){super.destroy(),this._tileset=this._tileset&&this._tileset.destroy(),this.manager.scene.removeObjectGroupByName(r.GlobalData.TdTileGroupName),this.objectGroup=null,this.tilesLoader.destroy(),this.tilesLoader=null,this._modelMatrix=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});const i=new Promise(((e,i)=>{this._tileset.loadTileset(this.url,(function(i){t.getTransforms().boundingBox=i._boundingBox.clone(),t.manager.updateScene(t);var n=t.viewer.getScene().getRawMatrixGlobal();i.updateGlobalMatrix(n),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t),e()}))}));return i}updateMatrix(){const e=this.viewer.getScene().getRawMatrixGlobal();this._tileset.updateGlobalMatrix(e)}hasTransforms(){return!0}preUpdate(e){this._tileset.preUpdate(e)}update(e){this._tileset.update(e)}postUpdate(e){this._tileset.postUpdate(e)}setVisible(e){this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,this.objectGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0))}get sequence(){return this._tileset.sequence}set sequence(e){this._tileset.sequence=e}}r.$3dTilesModel=e}(),r.Tile=r.Tile||{};r.Tile.DemUrl=class{constructor(e){if(this.terrainPath=e,-1===e.indexOf("terrain.")){this.terrainPath=`${e}{z}/{x}/{y}.${r.GlobalData.TerrainZipResourceFileName}`;!0===e.indexOf("srtm/v1")>-1&&(this.terrainPath=`${e}{z}/{x}/{y}/${r.GlobalData.TerrainResourceFileName}`)}}terrainUrl(e,t,i){return r.Layer.ImageryProvider.getRequestMapUrl(this.terrainPath,t,i,e)}},function(){class e extends r.BaseModel{constructor(e,t){super(e.modelManager,{modelId:"earthModel"}),t=r.Utils.defaultValue(t,{}),this.radius=r.Utils.defaultValue(t.radius,5e3),this.autoRotation=r.Utils.defaultValue(t.autoRotation,!0),this.rotationSpeed=r.Utils.defaultValue(t.rotationSpeed,2*Math.PI/360),this.earthResource=r.Utils.defaultValue(t.earthResource,"earth_0_satellite_ch.basis"),this.isBasisResource=null==t.earthResource,this.spherePrecision=r.Utils.defaultValue(t.spherePrecision,100),this.animationTime=r.Utils.defaultValue(t.animationTime,5),this._baseGeoCoordinates=t._baseGeoCoordinates,this.focusLonLat=r.Utils.defaultValue(t.focusLonLat,{lon:null,lat:20,height:null}),this.viewer=e,this._rotationAngle=0,this._globeHomeCameraInfo=null,this.earth=null,this.earthMaterial=null,this.animator=null,this._maxRotationLon=Math.PI/THREE.Math.DEG2RAD,this._initEarthRatio=1.5}destroy(){this.earth=null,this.earthMaterial=null}get homeCameraInfo(){return this._globeHomeCameraInfo}setupEarth(){const e=this.viewer,t=this.earthGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.GLOBALEARTH,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!1});var i=new THREE.TextureLoader;const a=this;i.crossOrigin=!0,this.isBasisResource&&(i=r.MaterialUtil.getBasisTextureLoader()).detectSupport(new THREE.WebGLRenderer({antialias:!0}));const s=`${e._staticResourcesHost}/Earth/${this.earthResource}`;return new Promise(((r,o)=>{i.load(s,(i=>{i.encoding=THREE.GammaEncoding;var s=new THREE.SphereBufferGeometry(a.radius,a.spherePrecision,a.spherePrecision),o=a.earthMaterial=new THREE.MeshLambertMaterial({map:i,color:16777215}),l=a.earth=new THREE.Mesh(s,o);s.computeBoundingBox();const d=s.boundingBox;t.add(l),t.updateMatrixWorld(!0),a.getTransforms().boundingBox=d.clone(),a.modelLoaded=!0,this._setCamera(),a._globeHomeCameraInfo={position:e.camera.position.clone(),target:e.camera.target.clone(),up:e.camera.realUp.clone()||e.camera.up.clone(),zoom:e.camera.zoom},a.autoRotation?n(this,(()=>{r()})):r()}),void 0,(e=>{o()}))}))}_setCamera(){let e=this._baseGeoCoordinates.lon+Math.PI/THREE.Math.DEG2RAD;e>Math.PI/THREE.Math.DEG2RAD&&(e-=2*Math.PI/THREE.Math.DEG2RAD);const t=this.viewer.camera;this.focusLonLat.lon=r.Utils.defaultValue(this.focusLonLat.lon,e);const i=this.radius*this._initEarthRatio/Math.sin(.5*THREE.Math.DEG2RAD*t.fov),n=i-this.radius,a=r.Tile.TileMath.fromDegreesYUp(this.focusLonLat.lon,this.focusLonLat.lat,n,this.radius),s=new THREE.Vector3(-a.x,-a.y,-a.z);t.LookAt(new THREE.Vector3,s,THREE.Object3D.DefaultUp),this.focusLonLat.height=r.Utils.defaultValue(this.focusLonLat.height,i),this._maxRotationLat=this._baseGeoCoordinates.lat-this.focusLonLat.lat,this._maxRotationLat=this._maxRotationLat>180?180:this._maxRotationLat}_autoRotationAnimation(e){const t=this;let i=t._globeHomeCameraInfo.position.clone();const r=new THREE.Vector3(0,1,0),n=new THREE.Vector3(0,0,0);window.requestAnimationFrame((function a(){let s=i.clone();s.applyAxisAngle(r,t.rotationSpeed),s.multiplyScalar(.998),i=s;const o=new THREE.Vector3(-s.x,-s.y,-s.z);t.viewer.camera.LookAt(n,o,THREE.Object3D.DefaultUp),t._rotationAngle<=1.5*Math.PI?(t._rotationAngle+=t.rotationSpeed,window.requestAnimationFrame(a)):e&&e()}))}_animation(e){const t=this.viewer,i=t.camera,n=this._globeHomeCameraInfo.position.clone(),a=Math.tan(.5*THREE.Math.DEG2RAD*i.fov),s=r.Tile.TileMath.fromDegreesYUp(this._baseGeoCoordinates.lon,this._baseGeoCoordinates.lat,a,this.radius);let o=new THREE.Vector3(0,0,0);const l={position:s,target:o,up:THREE.Object3D.DefaultUp,zoom:i.zoom};var d={position:n,target:o,up:THREE.Object3D.DefaultUp,zoom:i.zoom};this.animator.active(d,l,t,(function(e){t.cameraControl.update(!0,!0)}),(function(){e&&e()}))}}let t=1,i=new THREE.Vector3(0,0,0);function n(e,a){const s=e.viewer,o=s.cameraControl,l=o.camera,d=l.position.clone(),h=1-t/e.animationTime,c=h*(e.focusLonLat.height-e.focusLonLat.height/e._initEarthRatio)+e.focusLonLat.height/e._initEarthRatio-e.radius;let u=e.focusLonLat.lon+(1-h)*e._maxRotationLon;u>Math.PI/THREE.Math.DEG2RAD&&(u-=2*Math.PI/THREE.Math.DEG2RAD);let p=e.focusLonLat.lat+(1-h)*e._maxRotationLat;const m={position:r.Tile.TileMath.fromDegreesYUp(u,p,c,e.radius),target:i,up:THREE.Object3D.DefaultUp,zoom:l.zoom};var f={position:d,target:i,up:THREE.Object3D.DefaultUp,zoom:l.zoom};t++;const g=new r.CameraAnimator;g.setDuration(1e3),g.active(f,m,s,(function(e){o.update(!0,!0)}),(function(){t<=e.animationTime?n(e,a):a&&a()}))}r.VirtualEarth=e}();r.Tile.TextureLayer=class{constructor(e,t){this._url=t.url,this.imageryProviderType=r.Utils.defaultValue(t.imageryProviderType,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[this.imageryProviderType]({mapUrl:this._url}),this.id=t.layerId||r.Utils.getEncodedString(this._url),this.hasTileMapResource=t.hasTileMapResource||!1,this.layerName=void 0===t.layerName?r.ObjectGroupType.ROADNETWORK:t.layerName,this.tileGroup=e.getScene().getOrCreateObjectGroup(this.layerName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0}),this._priority=0,this.materialMap={},this.meshNodeMap={},this.loadStateMap={},this._opacity=1,this.mapStyle={},this._fetchMetadata()}destroy(){this.url=void 0,this.priority=void 0,this.opacity=void 0,this.disposeMaterial(),this.disposeMeshNode(),this.loadStateMap=null,this.tileGroup.clear(),this.tileGroup=null,this.imageryProviderType=void 0,this.imageryProvider=null,this.mapStyle=null}_fetchMetadata(){if(!this.hasTileMapResource)return;const e=this._url.substring(0,this._url.indexOf("{")),t=r.DomUtil.loadXMLDoc(e+"tilemapresource.xml",!1);if(!t)return;const i=r.DomUtil.getXMLAttributeValues(t,"BoundingBox");this.boundingBox=i?new THREE.Box2(new THREE.Vector2(parseFloat(i.minx),parseFloat(i.miny)),new THREE.Vector2(parseFloat(i.maxx),parseFloat(i.maxy))):void 0;const n=r.DomUtil.getXMLAttributeValues(t,"TileFormat");this.tileFormat=n?{mimeType:n["mime-type"],extension:n.extension}:void 0;const a=r.DomUtil.getXMLAttributeValuesByAttrName(t,"TileSet","order");this.minLevel=1/0,this.maxLevel=-1/0,a.forEach((e=>{const t=parseInt(e);t>this.maxLevel&&(this.maxLevel=t),t<this.minLevel&&(this.minLevel=t)}))}getRequestUrl(e,t,i){return this.imageryProvider.getImageryUrl(e,t,i)}isAvailableTile(e,t,i){if(this.maxLevel&&(i<this.minLevel||i>this.maxLevel))return!1;if(this.boundingBox){const n=r.Tile.TileMath.long2tile(this.boundingBox.min.x,i),a=r.Tile.TileMath.long2tile(this.boundingBox.max.x,i),s=r.Tile.TileMath.lat2tile(this.boundingBox.min.y,i),o=r.Tile.TileMath.lat2tile(this.boundingBox.max.y,i),l=Math.min(s,o),d=Math.max(s,o);if(e<n||e>a||t<l||t>d)return!1}return!0}contentLoaded(e,t,i){return this.loadStateMap[e]&&this.loadStateMap[e][t]&&this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.LOADED}contentUnLoad(e,t,i){return void 0===this.loadStateMap[e]?(this.loadStateMap[e]={},this.loadStateMap[e][t]={},this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t]?(this.loadStateMap[e][t]={},this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t][i]?(this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}contentUnLoading(e,t,i){return this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}setContentUnLoad(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}setContentLoaded(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.LOADED}setContentLoading(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}disposeMeshNode(){for(var e in this.meshNodeMap)for(var t in this.meshNodeMap[e])for(var i in this.meshNodeMap[e][t])this.meshNodeMap[e][t][i]&&this.meshNodeMap[e][t][i].parent.remove(this.meshNodeMap[e][t][i]);this.meshNodeMap=null}disposeMaterial(){for(var e in this.materialMap)for(var t in this.materialMap[e])for(var i in this.materialMap[e][t])this.materialMap[e][t][i]&&this.materialMap[e][t][i].dispose();this.materialMap=null}get opacity(){return this._opacity}set opacity(e){this._opacity=e}get url(){return this._url}set url(e){this._url=e}get priority(){return this._priority}set priority(e){this._priority=e}show(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}hide(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}setStyle(e){for(var t in this.mapStyle=e,this.materialMap){var i=this.materialMap[t];i.updateStyle&&i.updateStyle(e)}}updateMeshRenderOrder(e){for(let t in this.meshNodeMap)for(let i in this.meshNodeMap[t])for(let r in this.meshNodeMap[t][i])this.meshNodeMap[t][i][r]&&(this.meshNodeMap[t][i][r].renderOrder=e)}},function(){class e{constructor(){}}e.LOAD_STATE={UNLOADED:0,GEO_LOADING:1,GEO_LOADED:2,MAT_PARSING:3,LOADED:4,FAILED:5},e.TWO_ACCURACY=.01,e.InvalidTerrainValue=-32768,e.isTransparent=function(t){return 1-t>e.TWO_ACCURACY},r.Tile.DemTilesUtil=e}();r.Tile.DemTile=class{constructor(e,t,i){this.zoom=e,this.x=t,this.y=i,this.longLatBox=r.Tile.TileMath.tile2boundingBox(t,i,e),this.box=null,this.meshNode=null,this.meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null,this.needUpdateTexture=!1}destroy(){this.zoom=null,this.x=null,this.y=null,this.longLatBox=null,this.box=null,this.geometryLoadState=null,this.skirt&&this.skirt.parent.remove(this.skirt),this.meshNode&&(this.meshNode.parent.remove(this.meshNode),this.material.dispose(),this.texture.dispose()),this.geometry&&this.geometry.dispose(),this.skirtGeometry&&this.skirtGeometry.dispose(),this.meshNode=null,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null,this.needUpdateTexture=void 0}},function(){r.Tile=r.Tile||{};class e{constructor(){}}e.earthRadius=6371e3,e.mercatorPerimeter=20037508.3427892,e.unitScale=1e3,e.earthHighestAltitude=8865.43*e.unitScale*2,e.isLongitude=function(e){return e>=-180&&e<=180},e.isLatitude=function(e){return e>=-85.0511&&e<=85.0511},e.long2tile=function(e,t){return Math.floor((e+180)/360*Math.pow(2,t))},e.lat2tile=function(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))},e.tile2long=function(e,t){return e/Math.pow(2,t)*360-180},e.tile2lat=function(e,t){var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},e.tile2boundingBox=function(e,t,i){return{north:this.tile2lat(t,i),south:this.tile2lat(t+1,i),west:this.tile2long(e,i),east:this.tile2long(e+1,i)}},e.boundingBox2Tiles=function(t,i,r,n,a){var s,o,l,d,h=[],c=e.long2tile(t,a),u=e.long2tile(i,a),p=e.lat2tile(r,a),m=e.lat2tile(n,a);s=Math.min(c,u),l=Math.max(c,u),o=Math.min(p,m),d=Math.max(p,m);for(var f=s;f<=l;f++)for(var g=o;g<=d;g++)h.push({tileX:f,tileY:g});return h},e.getMercatorPerimeterByLat=function(e,t){return(t=r.Utils.defaultValue(t,r.GIS.Ellipsoid.WGS84)).getPerimeterByLat(e)/2},e.wgs84ToGCJ02=function(t,i){var r=.006693421622965943,n=(i=+i,t=+t,e._transformLat(t-105,i-35)),a=e._transformLng(t-105,i-35),s=i/180*Math.PI,o=Math.sin(s);o=1-r*o*o;var l=Math.sqrt(o);return n=180*n/(e.earthRadius*(1-r)/(o*l)*Math.PI),[t+(a=180*a/(e.earthRadius/l*Math.cos(s)*Math.PI)),i+n]},e._transformLat=function(e,t){var i=2*(e=+e)-100+3*(t=+t)+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return i+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,i+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,i+=2*(160*Math.sin(t/12*Math.PI)+320*Math.sin(t*Math.PI/30))/3},e._transformLng=function(e,t){var i=300+(e=+e)+2*(t=+t)+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return i+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,i+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,i+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3},e.lonLat2Mercator=function(t,i,r,n){r=r||e.mercatorPerimeter,n=n||e.unitScale;var a=new THREE.Vector2,s=t*r/180,o=Math.log(Math.tan((90+i)*Math.PI/360))/(Math.PI/180);return o=o*r/180,a.x=s*n,a.y=o*n,a},e.mercator2lonLat=function(t,i,r){i=i||e.mercatorPerimeter,r=r||e.unitScale;var n=new THREE.Vector2,a=t.x/(r*i)*180,s=t.y/(r*i)*180;return s=180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),n.x=a,n.y=s,n},e.toRadians=function(e){return e*Math.PI/180},e.fromDegreesYUp=function(t,i,n,a){a=r.Utils.defaultValue(a,e.earthRadius);const s=(t+90)*(Math.PI/180),o=(90-i)*(Math.PI/180),l=Math.pow(a,2),d=new THREE.Vector3(l,l,l),h=Math.sin(o);var c=new THREE.Vector3;c.x=h*Math.sin(s),c.y=Math.cos(o),c.z=h*Math.cos(s),c.normalize();var u=new THREE.Vector3;u.multiplyVectors(d,c);var p=Math.sqrt(c.dot(u));return u.divideScalar(p),c.multiplyScalar(n),u.add(c)},e.fromDegrees=function(e,t,i,n){i=null==i?0:i,e=this.toRadians(e),t=this.toRadians(t);var a=new THREE.Vector3,s=new THREE.Vector3,o=r.Utils.isDefined(n)?n.radiiSquared:r.GIS.Ellipsoid.WGS84.radiiSquared,l=Math.cos(t);a.x=l*Math.cos(e),a.y=l*Math.sin(e),a.z=Math.sin(t),a.normalize(),s.multiplyVectors(o,a);var d=Math.sqrt(a.dot(s));return s.divideScalar(d),a.multiplyScalar(i),s.add(a)},e.createHeightArray=function(e,t){for(var i=new Array(t+1),r=0;r<i.length;r++)i[r]=new Array(t+1);var n=e.length,a=t/(n-1);for(r=0;r<n-1;++r)for(var s=0;s<n-1;++s)for(var o=[e[r][s],e[r][s+1],e[r+1][s],e[r+1][s+1]],l=this.sampleSquare(o,a),d=r*a;d<=(r+1)*a;++d)for(var h=s*a;h<=(s+1)*a;++h)i[d][h]=l[d-r*a][h-s*a];return i},e.sampleSquare=function(e,t){for(var i=new Array(t+1),r=0;r<i.length;r++)i[r]=new Array(t+1);for(r=0;r<=t;++r)i[0][r]=(t-r)/t*e[0]+(1-(t-r)/t)*e[1],i[t][r]=(t-r)/t*e[2]+(1-(t-r)/t)*e[3],i[r][0]=(t-r)/t*e[0]+(1-(t-r)/t)*e[2],i[r][t]=(t-r)/t*e[1]+(1-(t-r)/t)*e[3];for(r=1;r<t;++r)for(var n=1;n<t;++n)i[r][n]=i[r][0]+(i[r][t]-i[r][0])/t*n;return i},e.generateHeight=function(e,t){for(var i=e*t,r=new Uint8Array(i),n=this.improvedNoise(),a=1,s=100*Math.random(),o=0;o<4;o++){for(var l=0;l<i;l++){var d=l%e,h=~~(l/e);r[l]+=Math.abs(n.noise(d/a,h/a,s)*a*1.75)}a*=5}return r},e.improvedNoise=function(){for(var e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],t=0;t<256;t++)e[256+t]=e[t];function i(e){return e*e*e*(e*(6*e-15)+10)}function r(e,t,i){return t+e*(i-t)}function n(e,t,i,r){var n=15&e,a=n<8?t:i,s=n<4?i:12==n||14==n?t:r;return(0==(1&n)?a:-a)+(0==(2&n)?s:-s)}return{noise:function(t,a,s){var o=Math.floor(t),l=Math.floor(a),d=Math.floor(s),h=255&o,c=255&l,u=255&d,p=(t-=o)-1,m=(a-=l)-1,f=(s-=d)-1,g=i(t),v=i(a),y=i(s),M=e[h]+c,E=e[M]+u,x=e[M+1]+u,_=e[h+1]+c,b=e[_]+u,I=e[_+1]+u;return r(y,r(v,r(g,n(e[E],t,a,s),n(e[b],p,a,s)),r(g,n(e[x],t,m,s),n(e[I],p,m,s))),r(v,r(g,n(e[E+1],t,a,f),n(e[b+1],p,a,s-1)),r(g,n(e[x+1],t,m,f),n(e[I+1],p,m,f))))}}},r.Tile.TileMath=e}(),function(){r.Tile=r.Tile||{};class e extends r.Tile.TileMath{constructor(){super()}}e.isLatitude=function(e){return e>=-90&&e<=90},e.long2tile=function(t,i){return Math.floor(Math.pow(2,i-26)*t*Math.PI*e.earthRadius/180)},e.lat2tile=function(t,i){return Math.floor(Math.pow(2,i-26)*e.earthRadius*Math.log(Math.tan(t*Math.PI/180)+Math.cos(t*Math.PI/180)))},r.Tile.TileMathBd=e}();r.Tile.TerrainScheduler=class{constructor(e,t){this.limit=e,this.bufferSize=t,this.store=[],this.active=0,this.taskInfo={},this.terrainLoader=new THREE.FileLoader,this.terrainLoader.setResponseType("arraybuffer"),this.terrainLoader.crossOrigin=!0}destroy(){this.limit=null,this.store=null,this.active=null,this.taskInfo=null,this.bufferSize=null,this.terrainLoader=null}clear(){this.taskInfo={}}next(){if(this.store.length){var e=this.store.shift(),t=e[0],i=e[1],r=e[2];this.taskInfo[t].added?this.taskInfo[t].data?"failure"==scope.taskInfo[t].data?r():i(this.taskInfo[t].data):(this.taskInfo[t].successCallbackList.push(i),this.taskInfo[t].failureCallbackList.push(r)):this.runTask(t)}}runTask(e){var t=this;t.active++,t.taskInfo[e].added=!0,t.terrainLoader.load(e,(function(i){t.active--,t.taskInfo[e].data=i;for(var r=0,n=t.taskInfo[e].successCallbackList.length;r<n;++r)t.taskInfo[e].successCallbackList[r](i);t.next()}),void 0,(function(i){t.active--,t.taskInfo[e].data="failure";for(var r=0,n=t.taskInfo[e].failureCallbackList.length;r<n;++r)t.taskInfo[e].failureCallbackList[r]();t.next()}))}push(e,t,i){this.taskInfo[e]?this.taskInfo[e].data?t(this.taskInfo[e].data):(this.taskInfo[e].successCallbackList.push(t),this.taskInfo[e].failureCallbackList.push(i)):(this.taskInfo[e]={},this.taskInfo[e].successCallbackList=[t],this.taskInfo[e].failureCallbackList=[i],this.active<this.limit?this.runTask(e):this.store.push([e,t,i]))}};r.Tile.TileBuilder=class{constructor(){this.indexMap={},this.uvMap={}}destroy(){this.indexMap=null,this.uvMap=null}getIndexBySeg(e){if(this.indexMap[e])return this.indexMap[e];for(var t=[],i=[],r=0,n=0;n<=e;n++){for(var a=[],s=0;s<=e;s++)a.push(r),r++;i.push(a)}for(n=0;n<e;n++)for(s=0;s<e;s++){const e=i[n][s+1],r=i[n][s],a=i[n+1][s],o=i[n+1][s+1];this.bufferize(o,r,e,t),this.bufferize(o,a,r,t)}return this.indexMap[e]=t,t}bufferize(e,t,i,r){r.push(e),r.push(t),r.push(i)}computeBuffer(){}createSkirt(e,t,i,r,n,a){e=e.concat(t.reverse());var s=[];const o=(new THREE.Vector3).fromArray(n.position).distanceTo((new THREE.Vector3).fromArray(n.position,3));for(var l=0;l<e.length;l++){const t=e[l],a=3*i,d=3*t;n.position[a+0]=n.position[d+0]-n.normal[d+0]*o,n.position[a+1]=n.position[d+1]-n.normal[d+1]*o,n.position[a+2]=n.position[d+2]-n.normal[d+2]*o,n.normal[a+0]=n.normal[d+0],n.normal[a+1]=n.normal[d+1],n.normal[a+2]=n.normal[d+2],n.uvs[2*i+0]=n.uvs[2*t+0],n.uvs[2*i+1]=n.uvs[2*t+1];const h=(l+1)%e.length,c=t,u=i,p=0===h?r:i+1,m=e[h];this.bufferize(c,u,p,s),this.bufferize(c,p,m,s),i++}return a=a.concat(s)}createSkirt2(e,t,i,r,n,a){e=e.concat(t.reverse());var s=[];const o=(new THREE.Vector3).fromArray(n.position).distanceTo((new THREE.Vector3).fromArray(n.position,3));var l={index:null,position:null,normal:null,uvs:[],center:null};const d=4*(e.length/4)*2;l.position=new Float32Array(3*d),l.normal=new Float32Array(3*d),l.uvs=new Float32Array(3*d);for(var h=0;h<e.length;h++){const t=e[h],i=6*h,r=4*h,a=3*t;l.position[i+0]=n.position[a+0],l.position[i+1]=n.position[a+1],l.position[i+2]=n.position[a+2],l.position[i+3]=n.position[a+0]-n.normal[a+0]*o,l.position[i+4]=n.position[a+1]-n.normal[a+1]*o,l.position[i+5]=n.position[a+2]-n.normal[a+2]*o,l.normal[i+0]=n.normal[a+0],l.normal[i+1]=n.normal[a+1],l.normal[i+2]=n.normal[a+2],l.normal[i+3]=n.normal[a+0],l.normal[i+4]=n.normal[a+1],l.normal[i+5]=n.normal[a+2],l.uvs[r+0]=n.uvs[2*t+0],l.uvs[r+1]=n.uvs[2*t+1],l.uvs[r+2]=n.uvs[2*t+0],l.uvs[r+3]=n.uvs[2*t+1];const d=(h+1)%e.length,c=2*h,u=2*h+1,p=0===d?1:2*h+3,m=0===d?0:2*h+2;this.bufferize(c,u,p,s),this.bufferize(c,p,m,s)}l.index=s;var c=new THREE.BufferGeometry;return c.setIndex(l.index),c.setAttribute("position",new THREE.BufferAttribute(l.position,3)),c.setAttribute("uv",new THREE.BufferAttribute(l.uvs,2)),c.setAttribute("normal",new THREE.Float32BufferAttribute(l.normal,3)),c.computeVertexNormals(),c}},(()=>{let e=new THREE.Vector3,t=new THREE.Matrix4,i=new THREE.Vector2,n=new THREE.Vector2;class a extends r.Tile.TileBuilder{constructor(){super()}destroy(){}computePlaneGeometry(e,t,i,n,a,s){s=s||r.Tile.TileMath.unitScale;const o={index:null,position:null,normal:null,uvs:[],center:null},l=((i=null==i?16:i)+1)*(i+1);o.position=new Float32Array(3*l),o.normal=new Float32Array(3*l),o.uvs=new Float32Array(2*l);let d=[];const h=[];let c=0;for(var u=e/2,p=t/2,m=e/i,f=t/i,g=0;g<=i;++g){const e=[];for(var v=g*f-p,y=0;y<=i;++y){var M=y*m-u;o.position[3*c]=M,o.position[3*c+1]=v,o.position[3*c+2]=n[i-g][y]*s*r.GlobalData.TerrainScale,o.normal[3*c]=0,o.normal[3*c+1]=0,o.normal[3*c+2]=1,o.uvs[2*c]=y/i,o.uvs[2*c+1]=g/i,a||0!==g&&g!==i&&(y===i?d.push(c):0===y&&h.push(c)),e.push(c),c++}0===g?d=d.concat(e):g===i&&(d=d.concat(e.slice().reverse()))}var E=this.getIndexBySeg(i);const x=c;var _=null;a||(_=this.createSkirt2(d,h,c,x,o,E)),o.index=E;var b=new THREE.BufferGeometry;return b.setIndex(o.index),b.setAttribute("position",new THREE.BufferAttribute(o.position,3)),b.setAttribute("uv",new THREE.BufferAttribute(o.uvs,2)),b.setAttribute("normal",new THREE.Float32BufferAttribute(o.normal,3)),b.computeVertexNormals(),[b,_]}getTileGeometryTriangular(t,i,r){if(r){var n,a;null!=r.prePositionArray?(n=[...r.prePositionArray],a=[...r.preIndexArray]):(n=[...r.attributes.position.array],a=[...r.index.array]);for(var s=[],o=[],l=[],d=0;d<a.length;d+=3){var h=n[3*a[d]],c=n[3*a[d]+1],u=n[3*a[d]+2],p=n[3*a[d+1]],m=n[3*a[d+1]+1],f=n[3*a[d+1]+2],g=n[3*a[d+2]],v=n[3*a[d+2]+1],y=n[3*a[d+2]+2],M=0;e.set(h,c,u),e.applyMatrix4(i);var E=t.isInRegionDrawing(e);E&&M++,e.set(p,m,f),e.applyMatrix4(i);var x=t.isInRegionDrawing(e);if(x&&M++,e.set(g,v,y),e.applyMatrix4(i),t.isInRegionDrawing(e)&&M++,1==M){var _=[];if(E?(T={x:h,y:c,z:u},_.push({x:p,y:m,z:f}),_.push({x:g,y:v,z:y})):x?(T={x:p,y:m,z:f},_.push({x:h,y:c,z:u}),_.push({x:g,y:v,z:y})):(T={x:g,y:v,z:y},_.push({x:h,y:c,z:u}),_.push({x:p,y:m,z:f})),2==(I=t.getIntersectPos(T,_)).length&&I[0].index!=I[1].index&&null!=I[0].point){var b=I[0].point;t.checkHighLowTerrain([T.x,T.y,T.z],[I[0].x,I[0].y,I[0].z],[b.x,b.y,b.z],s,o,l),t.checkHighLowTerrain([T.x,T.y,T.z],[I[1].x,I[1].y,I[1].z],[b.x,b.y,b.z],s,o,l)}else 2==I.length&&t.checkHighLowTerrain([T.x,T.y,T.z],[I[0].x,I[0].y,I[0].z],[I[1].x,I[1].y,I[1].z],s,o,l)}else if(2==M){var I,T=[];if(E?x?(_={x:g,y:v,z:y},T.push({x:h,y:c,z:u}),T.push({x:p,y:m,z:f})):(_={x:p,y:m,z:f},T.push({x:h,y:c,z:u}),T.push({x:g,y:v,z:y})):(_={x:h,y:c,z:u},T.push({x:p,y:m,z:f}),T.push({x:g,y:v,z:y})),2==(I=t.getIntersectPos(_,T)).length&&I[0].index!=I[1].index&&null!=I[0].point){b=I[0].point;t.checkHighLowTerrain([T[0].x,T[0].y,T[0].z],[T[1].x,T[1].y,T[1].z],[b.x,b.y,b.z],s,o,l),t.checkHighLowTerrain([T[0].x,T[0].y,T[0].z],[I[0].x,I[0].y,I[0].z],[b.x,b.y,b.z],s,o,l),t.checkHighLowTerrain([T[1].x,T[1].y,T[1].z],[I[1].x,I[1].y,I[1].z],[b.x,b.y,b.z],s,o,l)}else 2==I.length&&(t.checkHighLowTerrain([T[0].x,T[0].y,T[0].z],[T[1].x,T[1].y,T[1].z],[I[0].x,I[0].y,I[0].z],s,o,l),t.checkHighLowTerrain([I[0].x,I[0].y,I[0].z],[I[1].x,I[1].y,I[1].z],[T[1].x,T[1].y,T[1].z],s,o,l))}else 3==M&&t.checkHighLowTerrain([h,c,u],[p,m,f],[g,v,y],s,o,l)}}return[s,o,l]}updateGeometryForFlatten(a,s,o,l,d,h,c,u,p,m,f){o=null==o?16:o;let g=0;if(t.copy(u).invert(),p){p.prePositionArray||(p.prePositionArray=[...p.attributes.position.array],p.preNormalArray=[...p.attributes.normal.array],p.preUVArray=[...p.attributes.uv.array],p.preIndexArray=[...p.index.array]);var v=[...p.prePositionArray],y=[...p.preNormalArray],M=[...p.preUVArray],E=[...p.preIndexArray],x={};if(!f)for(var _=[...E],b=0;b<_.length;b+=3){var I=v[3*_[b]],T=v[3*_[b]+1],S=p.prePositionArray[3*_[b]+2],C=v[3*_[b+1]],w=v[3*_[b+1]+1],R=p.prePositionArray[3*_[b+1]+2],B=v[3*_[b+2]],A=v[3*_[b+2]+1],P=p.prePositionArray[3*_[b+2]+2];e.set(I,T,S),e.applyMatrix4(u),e.y=e.z;var L=0;(de=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++,e.set(C,w,R),e.applyMatrix4(u),e.y=e.z,(he=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++,e.set(B,A,P),e.applyMatrix4(u),e.y=e.z,(ce=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++;var O=M[2*_[b]],D=M[2*_[b]+1],N=M[2*_[b+1]],H=M[2*_[b+1]+1],U=M[2*_[b+2]],F=M[2*_[b+2]+1];if(1==L)if(de){v[3*_[b]+2]=de.elevation*h*r.GlobalData.TerrainScale,(ue=x[de.id])||(ue=de.transformPolygon(t),x[de.id]=ue),i.set(I,T),n.set(C,w);var k=r.Utils.linePolygonIntersection(i,n,ue);i.set(B,A),n.set(I,T);var G=r.Utils.linePolygonIntersection(i,n,ue);if(!k||!G)continue;v.push(k.x),v.push(k.y),v.push(R),v.push(G.x),v.push(G.y),v.push(P),v.push(k.x),v.push(k.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(G.x),v.push(G.y),v.push(de.elevation*h*r.GlobalData.TerrainScale);var V=(k.x-I)/(C-I+r.Math.EPSILON6),z=(k.y-T)/(w-T+r.Math.EPSILON6),j=(G.x-B)/(I-B+r.Math.EPSILON6),W=(G.y-A)/(T-A+r.Math.EPSILON6);M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(U+(O-U)*j),M.push(F+(D-F)*W),M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(U+(O-U)*j),M.push(F+(D-F)*W),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);var q=v.length/3;E.push(q-4),E.push(q-3),E.push(q-1),E.push(q-4),E.push(q-1),E.push(q-2),E.push(E[b+1]),E.push(E[b+2]),E.push(q-3),E.push(E[b+1]),E.push(q-3),E.push(q-4),E[b+1]=q-2,E[b+2]=q-1}else if(he){v[3*_[b+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,(ue=x[he.id])||(ue=he.transformPolygon(t),x[he.id]=ue),i.set(I,T),n.set(C,w);k=r.Utils.linePolygonIntersection(i,n,ue);i.set(C,w),n.set(B,A);var X=r.Utils.linePolygonIntersection(i,n,ue);if(!k||!X)continue;v.push(k.x),v.push(k.y),v.push(S),v.push(X.x),v.push(X.y),v.push(P),v.push(k.x),v.push(k.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(X.x),v.push(X.y),v.push(he.elevation*h*r.GlobalData.TerrainScale);V=(k.x-I)/(C-I+r.Math.EPSILON6),z=(k.y-T)/(w-T+r.Math.EPSILON6);var Y=(X.x-C)/(B-C+r.Math.EPSILON6),K=(X.y-w)/(A-w+r.Math.EPSILON6);M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(q-2),E.push(q-1),E.push(q-3),E.push(q-2),E.push(q-3),E.push(q-4),E.push(E[b]),E.push(q-4),E.push(q-3),E.push(E[b]),E.push(q-3),E.push(E[b+2]),E[b]=E[b+1],E[b+1]=q-1,E[b+2]=q-2}else{v[3*_[b+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(ue=x[ce.id])||(ue=ce.transformPolygon(t),x[ce.id]=ue),i.set(I,T),n.set(B,A);var Z=r.Utils.linePolygonIntersection(i,n,ue);i.set(B,A),n.set(C,w);var Q=r.Utils.linePolygonIntersection(i,n,ue);if(!Z||!Q)continue;v.push(Z.x),v.push(Z.y),v.push(S),v.push(Q.x),v.push(Q.y),v.push(R),v.push(Z.x),v.push(Z.y),v.push(ce.elevation*h*r.GlobalData.TerrainScale),v.push(Q.x),v.push(Q.y),v.push(ce.elevation*h*r.GlobalData.TerrainScale);var J=(Z.x-I)/(B-I+r.Math.EPSILON6),$=(Z.y-T)/(A-T+r.Math.EPSILON6),ee=(Q.x-B)/(C-B+r.Math.EPSILON6),te=(Q.y-A)/(w-A+r.Math.EPSILON6);M.push(O+(U-O)*J),M.push(D+(F-D)*$),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),M.push(O+(U-O)*J),M.push(D+(F-D)*$),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(q-4),E.push(q-1),E.push(q-2),E.push(q-4),E.push(q-3),E.push(q-1),E.push(E[b]),E.push(E[b+1]),E.push(q-3),E.push(E[b]),E.push(q-3),E.push(q-4),E[b]=E[b+2],E[b+1]=q-2,E[b+2]=q-1}else if(2==L)if(de)if(he){if(v[3*_[b]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*_[b+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,(fe=x[de.id])||(fe=de.transformPolygon(t),x[de.id]=fe),(me=x[he.id])||(me=he.transformPolygon(t),x[he.id]=me),i.set(I,T),n.set(B,A),(Z=r.Utils.linePolygonIntersection(i,n,fe))||(Z=r.Utils.linePolygonIntersection(i,n,me)),i.set(B,A),n.set(C,w),(Q=r.Utils.linePolygonIntersection(i,n,fe))||(Q=r.Utils.linePolygonIntersection(i,n,me)),!Z||!Q)continue;v.push(Z.x),v.push(Z.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(Q.x),v.push(Q.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(Z.x),v.push(Z.y),v.push(P),v.push(Q.x),v.push(Q.y),v.push(P);J=(Z.x-I)/(B-I+r.Math.EPSILON6),$=(Z.y-T)/(A-T+r.Math.EPSILON6),ee=(Q.x-B)/(C-B+r.Math.EPSILON6),te=(Q.y-A)/(w-A+r.Math.EPSILON6);M.push(O+(U-O)*J),M.push(D+(F-D)*$),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),M.push(O+(U-O)*J),M.push(D+(F-D)*$),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(E[b]),E.push(q-3),E.push(q-4),E.push(q-4),E.push(q-3),E.push(q-1),E.push(q-4),E.push(q-1),E.push(q-2),E.push(E[b+2]),E.push(q-2),E.push(q-1),E[b+2]=q-3}else{if(v[3*_[b]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*_[b+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(fe=x[de.id])||(fe=de.transformPolygon(t),x[de.id]=fe),(ge=x[ce.id])||(ge=ce.transformPolygon(t),x[ce.id]=ge),i.set(I,T),n.set(C,w),(k=r.Utils.linePolygonIntersection(i,n,fe))||(k=r.Utils.linePolygonIntersection(i,n,ge)),i.set(C,w),n.set(B,A),(X=r.Utils.linePolygonIntersection(i,n,fe))||(X=r.Utils.linePolygonIntersection(i,n,ge)),!k||!X)continue;v.push(k.x),v.push(k.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(X.x),v.push(X.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(k.x),v.push(k.y),v.push(R),v.push(X.x),v.push(X.y),v.push(R);V=(k.x-I)/(C-I+r.Math.EPSILON6),z=(k.y-T)/(w-T+r.Math.EPSILON6),Y=(X.x-C)/(B-C+r.Math.EPSILON6),K=(X.y-w)/(A-w+r.Math.EPSILON6);M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(E[b+2]),E.push(q-4),E.push(q-3),E.push(q-2),E.push(q-3),E.push(q-4),E.push(q-2),E.push(q-1),E.push(q-3),E.push(E[b+1]),E.push(q-1),E.push(q-2),E[b+1]=q-4}else{if(v[3*_[b+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,v[3*_[b+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(me=x[he.id])||(me=he.transformPolygon(t),x[he.id]=me),(ge=x[ce.id])||(ge=ce.transformPolygon(t),x[ce.id]=ge),i.set(I,T),n.set(C,w),(k=r.Utils.linePolygonIntersection(i,n,me))||(k=r.Utils.linePolygonIntersection(i,n,ge)),i.set(B,A),n.set(I,T),(G=r.Utils.linePolygonIntersection(i,n,me))||(G=r.Utils.linePolygonIntersection(i,n,ge)),!k||!G)continue;v.push(k.x),v.push(k.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(G.x),v.push(G.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(k.x),v.push(k.y),v.push(S),v.push(G.x),v.push(G.y),v.push(S);var V=(k.x-I)/(C-I+r.Math.EPSILON6),z=(k.y-T)/(w-T+r.Math.EPSILON6);j=(G.x-B)/(I-B+r.Math.EPSILON6),W=(G.y-A)/(T-A+r.Math.EPSILON6);M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(U+(O-U)*j),M.push(F+(D-F)*W),M.push(O+(N-O)*V),M.push(D+(H-D)*z),M.push(U+(O-U)*j),M.push(F+(D-F)*W),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);var q=v.length/3;E.push(E[b+1]),E.push(E[b+2]),E.push(q-3),E.push(q-4),E.push(q-1),E.push(q-2),E.push(q-4),E.push(q-3),E.push(q-1),E.push(E[b]),E.push(q-2),E.push(q-1),E[b]=E[b+1],E[b+1]=q-3,E[b+2]=q-4}else 3==L&&(v[3*_[b]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*_[b+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,v[3*_[b+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale)}p.setIndex(E),p.deleteAttribute("position"),p.deleteAttribute("uv"),p.deleteAttribute("normal"),p.setAttribute("position",new THREE.Float32BufferAttribute(v,3)),p.setAttribute("uv",new THREE.Float32BufferAttribute(M,2)),p.setAttribute("normal",new THREE.Float32BufferAttribute(y,3)),p.computeBoundingBox(),p.computeBoundingSphere()}if(m){m.prePositionArray||(m.prePositionArray=[...m.attributes.position.array]);var ie=[...m.prePositionArray];if(!f){let a=[];const s=[];for(var re=0;re<=o;++re){const e=[];for(var ne=0;ne<=o;++ne)d||0!==re&&re!==o&&(ne===o?a.push(g):0===ne&&s.push(g)),e.push(g),g++;0===re?a=a.concat(e):re===o&&(a=a.concat(e.slice().reverse()))}var ae=y.slice(0,p.preNormalArray.length),se=v.slice(0,p.prePositionArray.length);a=a.concat(s.reverse());const l=(new THREE.Vector3).fromArray(se).distanceTo((new THREE.Vector3).fromArray(se,3));for(b=0;b<a.length;b++){const e=6*b,t=3*a[b];ie[e+2]=se[t+2],ie[e+5]=se[t+2]-ae[t+2]*l}var oe=m.index.array,le=[...ie];for(b=0;b<oe.length;b+=3){I=ie[3*oe[b]],T=ie[3*oe[b]+1],S=m.prePositionArray[3*oe[b]+2],C=ie[3*oe[b+1]],w=ie[3*oe[b+1]+1],R=m.prePositionArray[3*oe[b+1]+2],B=ie[3*oe[b+2]],A=ie[3*oe[b+2]+1],P=m.prePositionArray[3*oe[b+2]+2];e.set(I,T,S),e.applyMatrix4(u),e.y=e.z;var de,he,ce;L=0;if((de=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++,e.set(C,w,R),e.applyMatrix4(u),e.y=e.z,(he=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++,e.set(B,A,P),e.applyMatrix4(u),e.y=e.z,(ce=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&L++,1==L){if(de)(ue=x[de.id])||(ue=de.transformPolygon(t),x[de.id]=ue),i.set(I,T),n.set(C,w),pe=r.Utils.linePolygonIntersection(i,n,ue);else if(he){(ue=x[he.id])||(ue=he.transformPolygon(t),x[he.id]=ue),i.set(I,T),n.set(C,w),pe=r.Utils.linePolygonIntersection(i,n,ue)}else{var ue;(ue=x[ce.id])||(ue=ce.transformPolygon(t),x[ce.id]=ue),i.set(I,T),n.set(B,A),pe=r.Utils.linePolygonIntersection(i,n,ue)}pe&&(le[3*oe[b]]=pe.x,le[3*oe[b]+1]=pe.y,le[3*oe[b+1]]=pe.x,le[3*oe[b+1]+1]=pe.y,le[3*oe[b+2]]=pe.x,le[3*oe[b+2]+1]=pe.y)}else if(2==L){var pe;if(de)if(he){var me;(fe=x[de.id])||(fe=de.transformPolygon(t),x[de.id]=fe),(me=x[he.id])||(me=he.transformPolygon(t),x[he.id]=me),i.set(I,T),n.set(B,A),(pe=r.Utils.linePolygonIntersection(i,n,fe))||(pe=r.Utils.linePolygonIntersection(i,n,me))}else{var fe,ge;(fe=x[de.id])||(fe=de.transformPolygon(t),x[de.id]=fe),(ge=x[ce.id])||(ge=ce.transformPolygon(t),x[ce.id]=ge),i.set(I,T),n.set(C,w),(pe=r.Utils.linePolygonIntersection(i,n,fe))||(pe=r.Utils.linePolygonIntersection(i,n,ge))}else(me=x[he.id])||(me=he.transformPolygon(t),x[he.id]=me),(ge=x[ce.id])||(ge=ce.transformPolygon(t),x[ce.id]=ge),i.set(I,T),n.set(C,w),(pe=r.Utils.linePolygonIntersection(i,n,me))||(pe=r.Utils.linePolygonIntersection(i,n,ge));pe&&(le[3*oe[b]]=pe.x,le[3*oe[b]+1]=pe.y,le[3*oe[b+1]]=pe.x,le[3*oe[b+1]+1]=pe.y,le[3*oe[b+2]]=pe.x,le[3*oe[b+2]+1]=pe.y)}}ie=le}m.deleteAttribute("position"),m.setAttribute("position",new THREE.Float32BufferAttribute(ie,3))}}computeSideNormal(e,t,i,r){for(var n=t.length,a=0;a<n;++a){var s=t[a],o=r[a],l=(e.attributes.normal.array[3*s]+i.attributes.normal.array[3*o])/2;e.attributes.normal.array[3*s]=l,i.attributes.normal.array[3*o]=l;var d=(e.attributes.normal.array[3*s+1]+i.attributes.normal.array[3*o+1])/2;e.attributes.normal.array[3*s+1]=d,i.attributes.normal.array[3*o+1]=d;var h=(e.attributes.normal.array[3*s+2]+i.attributes.normal.array[3*o+2])/2;e.attributes.normal.array[3*s+2]=h,i.attributes.normal.array[3*o+2]=h}}computeNearNormal(e,t,i,r){for(var n=0,a=1,s=new Array(i+1),o=0;o<=i;++o)s[o]=n+a*o;n=0,a=i+1;var l=new Array(i+1);for(o=0;o<=i;++o)l[o]=n+a*o;n=i,a=i+1;var d=new Array(i+1);for(o=0;o<=i;++o)d[o]=n+a*o;n=i*(i+1),a=1;var h=new Array(i+1);for(o=0;o<=i;++o)h[o]=n+a*o;"left"===r&&this.computeSideNormal(e,l,t,d),"right"===r&&this.computeSideNormal(e,d,t,l),"top"===r&&this.computeSideNormal(e,s,t,h),"bottom"===r&&this.computeSideNormal(e,h,t,s)}}r.Tile.PlaneTileBuilder=a})();class F extends r.Tile.TileBuilder{constructor(){super()}destroy(){}computeBuffer(e,t,i,n,a,s,o){o=o||r.Tile.TileMath.unitScale;const l={index:null,position:null,normal:null,uvs:[],center:null};n=null==n?16:n;var d=r.Tile.TileMath.tile2boundingBox(e,t,i),h=(d.east+d.west)/2,c=(d.north+d.south)/2,u=r.Tile.TileMath.fromDegrees(h,c),p=(d.east-d.west)/n,m=(d.north-d.south)/n;l.center=u;const f=(n+1)*(n+1)+(a?0:4*n);l.position=new Float32Array(3*f),l.normal=new Float32Array(3*f),l.uvs=new Float32Array(3*f);let g=[];const v=[];let y=0;for(var M,E,x,_=1/n,b=0;b<=n;++b){const e=[];E=d.south+m*b;for(var I=0;I<=n;++I){M=d.west+p*I,x=r.Tile.TileMath.fromDegrees(M,E),l.position[3*y]=(x.x-u.x)*o,l.position[3*y+1]=(x.y-u.y)*o,l.position[3*y+2]=(x.z-u.z)*o;var T=x.clone().normalize();l.normal[3*y]=T.x,l.normal[3*y+1]=T.y,l.normal[3*y+2]=T.z,s&&(l.position[3*y]+=T.x*s[n-b][I]*o*r.GlobalData.TerrainScale,l.position[3*y+1]+=T.y*s[n-b][I]*o*r.GlobalData.TerrainScale,l.position[3*y+2]+=T.z*s[n-b][I]*o*r.GlobalData.TerrainScale);var S=b*_,C=I*_;l.uvs[2*y]=C,l.uvs[2*y+1]=S,a||0!==b&&b!==n&&(I===n?g.push(y):0===I&&v.push(y)),e.push(y),y++}0===b?g=g.concat(e):b===n&&(g=g.concat(e.slice().reverse()))}var w=this.getIndexBySeg(n);const R=y;return a||(w=this.createSkirt(g,v,y,R,l,w)),l.index=w,l}}r.Tile.GlobeTileBuilder=F,(()=>{let e=new THREE.Vector3;r.Tile.TileTextureManager=class{constructor(e,t){this.viewer=e,!this.viewer||!this.viewer instanceof r.Viewer?console.log("ERROR::viewer must not be empty or viewer2d."):!t.startPosition||t.startPosition<2?console.log("ERROR::startPosition must not be empty or less than 2 in length."):!t.endPosition||t.endPosition<2?console.log("ERROR::endPosition must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.startPosition[0])&&r.Tile.TileMath.isLongitude(t.endPosition[0])&&r.Tile.TileMath.isLatitude(t.startPosition[1])&&r.Tile.TileMath.isLatitude(t.startPosition[1])?t.startPosition[0]>t.endPosition[0]||t.startPosition[1]>t.endPosition[1]?console.log("ERROR::range definition error."):Math.abs(t.startPosition[0]-t.endPosition[0])>.2||Math.abs(t.startPosition[1]-t.endPosition[1])>.2?console.log(" Longitude or latitude range is too big."):(r.GlobalData.EnableGisMap=!0,r.GlobalData.ConstraintZoom=!1,this.westEdge=t.startPosition[0],this.eastEdge=t.endPosition[0],this.northEdge=t.endPosition[1],this.southEdge=t.startPosition[1],this.mapCount=0,this.externalObjectId="tilePlane",this.geometry=null,this.tileMaterials=new Array,!t.modelPosition||t.modelPosition<2?console.log("ERROR::model position must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1])?(this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.modelLongitude<this.westEdge||this.modelLongitude>this.eastEdge||this.modelLatitude<this.southEdge||this.modelLatitude>this.northEdge?console.log("ERROR::the input position must in range"):(this.zoom=t.zoom,this.zoom<0||this.zoom>18?console.log("ERROR::the input zoom is invalid"):(this.height=0,this.externalComponentManager=new r.ExternalComponentManager(e)))):console.log("ERROR::number exceeds normal latitude and longitude range.")):console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.viewer=null,this.westEdge=null,this.eastEdge=null,this.northEdge=null,this.southEdge=null,this.mapCount=null,this.externalObjectId=null,this.geometry=null,this.tileMaterials=null,this.modelLongitude=null,this.modelLatitude=null,this.zoom=null,this.height=null,this.externalComponentManager=null,this.tileLength=null,this.topTile=null,this.leftTile=null,this.bottomTile=null,this.rightTile=null,this.planeWidth=null,this.planeHeight=null,this.mapCount=null,this.geometry=null,this.tilesMesh=null,this.tileArray[xIndex]=null}loadMapsByZoom(e,t){this.zoom=e,this.tileLength=r.Tile.TileMath.mercatorPerimeter/Math.pow(2,this.zoom)*r.Tile.TileMath.unitScale*2,this.tileArray=new Array,this.topTile=r.Tile.TileMath.lat2tile(this.northEdge,this.zoom),this.leftTile=r.Tile.TileMath.long2tile(this.westEdge,this.zoom),this.bottomTile=r.Tile.TileMath.lat2tile(this.southEdge,this.zoom),this.rightTile=r.Tile.TileMath.long2tile(this.eastEdge,this.zoom),this.planeWidth=this.rightTile-this.leftTile+1,this.planeHeight=this.bottomTile-this.topTile+1,this.mapCount=this.planeWidth*this.planeHeight,this.geometry=new THREE.PlaneGeometry(this.tileLength*this.planeWidth,this.tileLength*this.planeHeight,this.planeWidth,this.planeHeight),this.tilesMesh=null;var i=this,n=0;for(let e=i.leftTile;e<=i.rightTile;++e){let o=e-i.leftTile;i.tileArray[o]=new Array;for(let l=i.topTile;l<=i.bottomTile;++l){let d=l-i.topTile;if(i.tileArray[o][d]={},i.tileArray[o][d].x=o*i.tileLength,i.tileArray[o][d].y=-d*i.tileLength,i.tileArray[o][d].center=new THREE.Vector3((o+.5)*i.tileLength,-(d+.5)*i.tileLength,i.height),i.tileArray[o][d].bound=r.Tile.TileMath.tile2boundingBox(e,l,i.zoom),!(e>i.rightTile||l>i.bottomTile)){var a=`https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=${e}&y=${l}&z=${i.zoom}`,s=new THREE.TextureLoader;s.crossOrigin=!0,s.load(a,(function(e){var r=new THREE.MeshBasicMaterial({map:e,transparent:!0,side:THREE.DoubleSide}),a=o+d*(i.rightTile-i.leftTile+1);i.geometry.faces[2*a].materialIndex=a,i.geometry.faces[2*a+1].materialIndex=a,i.geometry.faceVertexUvs[0][2*a]=[new THREE.Vector2(0,1),new THREE.Vector2(0,0),new THREE.Vector2(1,1)],i.geometry.faceVertexUvs[0][2*a+1]=[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],i.tileMaterials[a]=r,++n>=i.mapCount&&i.onTextureLoaded(t)}))}}}}onTextureLoaded(t){this.tilesMesh=new THREE.Mesh(this.geometry,this.tileMaterials);var i=this.externalComponentManager.objectIds;null!=i&&-1!=i.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tilesMesh),this.positionX=0,this.positionY=0;for(var r=0,n=this.tileArray.length;r<n;r++)for(var a=0,s=this.tileArray[r].length;a<s;a++)if(this.tileArray[r][a].bound.west<=this.modelLongitude&&this.modelLongitude<this.tileArray[r][a].bound.east&&this.tileArray[r][a].bound.south<=this.modelLatitude&&this.modelLatitude<this.tileArray[r][a].bound.north){var o=(this.modelLongitude-this.tileArray[r][a].bound.west)/(this.tileArray[r][a].bound.east-this.tileArray[r][a].bound.west),l=(this.modelLatitude-this.tileArray[r][a].bound.south)/(this.tileArray[r][a].bound.north-this.tileArray[r][a].bound.south);this.positionX=-(r+o)*this.tileLength+this.planeWidth/2*this.tileLength,this.positionY=-(s-a-1+l)*this.tileLength+this.planeHeight/2*this.tileLength;break}var d=new THREE.Quaternion,h=this.viewer.getScene().getBoundingBoxWorld(),c=h.getCenter(e);this.externalComponentManager.setTransform(this.externalObjectId,new THREE.Vector3(this.positionX+c.x,this.positionY+c.y,h.min.z),new THREE.Vector3(1,1,1),d),this.viewer.render(),t&&t()}}})(),function(){let e=new THREE.Vector3;r.Tile.TileDemandManager=class{constructor(e,t){if(this.viewer=e,!this.viewer||!this.viewer instanceof r.Viewer)console.log("ERROR::viewer must not be empty or viewer2d.");else if(!t.modelPosition||t.modelPosition<2)console.log("ERROR::model position must not be empty or less than 2 in length.");else if(r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1]))if(this.zoom=t.zoom?t.zoom:17,this.zoom<1||this.zoom>18)console.log("ERROR::the input zoom is invalid");else{this.zoom<11&&console.warn("Tile resolution may be too low"),r.GlobalData.EnableGisMap=!0,r.GlobalData.ConstraintZoom=!1,this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.tileArray={},this.tileArray[this.zoom]={},this.externalObjectId="tileDemandPlane",this.tileLimit=t.tileLimit?t.tileLimit:40,this.modelOffset=t.modelOffset,this.allGroup=new THREE.Group,this.groupArray={},this.groupArray[this.zoom]=new THREE.Group,this.allGroup.add(this.groupArray[this.zoom]),this.externalComponentManager=new r.ExternalComponentManager(e);var i=this.externalComponentManager.objectIds;null!=i&&-1!=i.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.allGroup),this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=new THREE.Matrix4,this.globalMatrixInverse.copy(this.globalMatrix).invert(),this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.modelBox=this.viewer.getScene().getBoundingBoxWorld();var n=this;this.loader.load("https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=0&y=0&z=0",(function(e){n.groupArray[0]=new THREE.Group;var t=new THREE.SphereGeometry(r.Tile.TileMath.earthRadius,200,200);t.translate(5517447847.510659,3185499999.9999995,0);var i=new THREE.MeshLambertMaterial({map:e,overdraw:.5}),a=new THREE.Mesh(t,i);n.groupArray[0].add(a)}));n=this;this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,(function(e){var t=n.viewer.rendererManager.renderer.domElement.height,i=n.viewer.camera.position.clone().applyMatrix4(n.globalMatrixInverse),r=n.calculateZoom(i,t);if(r!=n.zoom){if(n.allGroup.remove(n.groupArray[n.zoom]),0==r)return n.allGroup.add(n.groupArray[0]),n.allGroup.updateMatrixWorld(!0),void(n.zoom=r);null==n.groupArray[r]&&(n.groupArray[r]=new THREE.Group),n.allGroup.add(n.groupArray[r])}0!=r&&(n.zoom=r,n.updateZoom(r))}))}else console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.viewer=null,this.zoom=null,this.modelLongitude=null,this.modelLatitude=null,this.tileArray=null,this.externalObjectId=null,this.modelOffset=null,this.tileLimit=null,this.allGroup=null,this.groupArray=null,this.tileMaterials=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.loader=null,this.modelBox=null,this.tileLength=null,this.modelTileX=null,this.modelTileY=null,this.offset=null,this.inGeometry=null,this.tileBox=null,this.externalComponentManager=null}calculateZoom(e,t){return this.zoom}updateZoom(t){null==this.tileArray[t]&&(this.tileArray[t]={}),this.tileLength=r.Tile.TileMath.mercatorPerimeter/Math.pow(2,t)*r.Tile.TileMath.unitScale*2,this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,t),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,t);var i=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,t),n=(this.modelLongitude-i.west)/(i.east-i.west),a=(this.modelLatitude-i.north)/(i.north-i.south);this.modelBox.getCenter(e);var s=-n*this.tileLength+.5*this.tileLength+e.x,o=-a*this.tileLength-.5*this.tileLength+e.y;this.offset=new THREE.Vector3(s,o,this.modelBox.min.z-this.modelOffset*r.Tile.TileMath.unitScale);var l=new THREE.Quaternion;this.externalComponentManager.setTransform(this.externalObjectId,this.offset,new THREE.Vector3(1,1,1),l),this.inGeometry=new THREE.PlaneBufferGeometry(this.tileLength,this.tileLength),this.inGeometry.computeBoundingBox(),this.tileBox=this.inGeometry.boundingBox,this.addTile(this.modelTileX,this.modelTileY,new THREE.Vector3(0),t),this.updateGroup(t)}addTile(e,t,i,r,n){var a=this;return a.tileArray[r][e]&&a.tileArray[r][e][t]?(a.tileArray[r][e][t].visible=!0,void a.allGroup.updateMatrixWorld(!0)):new Promise((function(s,o){var l=`https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=${e}&y=${t}&z=${r}`;a.loader.load(l,(function(o){o.wrapS=THREE.ClampToEdgeWrapping,o.wrapT=THREE.ClampToEdgeWrapping;var l=new THREE.MeshBasicMaterial({map:o,transparent:!0,side:THREE.DoubleSide}),d=a.inGeometry.clone();d.translate(i.x,i.y,i.z);var h=new THREE.Mesh(d,l);null==a.tileArray[r][e]&&(a.tileArray[r][e]={}),a.tileArray[r][e][t]||(a.tileArray[r][e][t]=h,h.name=`${r}-${e}-${t}`,a.groupArray[r].add(h),a.allGroup.updateMatrixWorld(!0)),s(n)}))}))}updateGroup(e){var t=this,i=t.viewer.camera;i.updateMatrix(),i.updateMatrixWorld(),this.frustum=new THREE.Frustum,this.frustum.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse));for(var r=t.modelTileX,n=t.modelTileY,a=2;a<t.tileLimit;){for(var s=1;s<a;s++)r+=1,t.addNode(r,n,e);for(s=1;s<a;s++)n+=1,t.addNode(r,n,e);a++;for(s=1;s<a;s++)r-=1,t.addNode(r,n,e);for(s=1;s<a;s++)n-=1,t.addNode(r,n,e);a++}}addNode(e,t,i){if(!(e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0)){var r=this,n=(e-r.modelTileX)*r.tileLength,a=-(t-r.modelTileY)*r.tileLength,s=new THREE.Vector3(n+r.offset.x,a+r.offset.y,r.offset.z);this.tileBox=this.inGeometry.boundingBox;var o=this.tileBox.clone();if(o.translate(s),o.applyMatrix4(r.globalMatrix),r.frustum.intersectsBox(o)){var l=new THREE.Vector3(n,a,0);r.addTile(e,t,l,i,void 0)}else null!=r.tileArray[i][e]&&null!=r.tileArray[i][e][t]&&(r.tileArray[i][e][t].visible=!1)}}}}();r.Tile.TileManager=class{constructor(e,t,i){this.modelLayer=e,this.viewer=e.viewer,!this.viewer||!this.viewer instanceof r.Viewer?console.log("ERROR::viewer must not be empty or viewer2d."):!t.modelPosition||t.modelPosition<2?console.log("ERROR::model position must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1])?(r.GlobalData.EnableGisMap=!0,this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.tileAroundNum=8,this.maxZoom=t.maxZoom,this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.basePoint=t.basePoint,this.modelRotationZ=t.modelRotationZ,this.modelAltitude=t.modelAltitude,this.globalLayer={},this.tileGroup=i,this.tileGroup.altitudeOffset=this.modelAltitude,this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=new THREE.Matrix4,this.globalMatrixInverse.copy(this.globalMatrix).invert(),this.frustum=new THREE.Frustum,this.earthMatrix=this.tileGroup.matrixWorld,t.terrainOnlineConfig&&this.dealOnlineTerrainConfig(t.terrainOnlineConfig),this.useTerrain=t.useTerrain,this.renderFunction=null,this.tileOpacity=t.opacity,this.mapStyle=t.mapStyle||{},this.mapExcavation=t.mapExcavation||{},this.materialMap={},this.disableSkirt=!1,this.mapUrl=t.mapUrl,this.layerList=[],this.baseRenderOrder=10,this.seg=16,this.terrainScheduler=new r.Tile.TerrainScheduler(6,(this.seg+1)*(this.seg+1)*2),t.maxTerrainLevel&&t.useTerrain&&(this.maxTerrainLevel=t.maxTerrainLevel,this.minTerrainLevel=t.minTerrainLevel,this.maxTerrainLevel+4<this.maxZoom&&(this.maxZoom=this.maxTerrainLevel+4)),this.modelTileAttitude=0,t.terrainPath?this.dataUrl=new r.Tile.DemUrl(t.terrainPath):this.dataUrl=t.dataUrl,this.isCreated=!1,this.terrainTileCount=0,this.tileCount=0,this.useClipping=t.useClipping,this.imageryProviderType=r.Utils.defaultValue(t.imageryProviderType,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[this.imageryProviderType]({mapUrl:t.mapUrl}),this._contentReadyDeferred=void 0,this._requestCount=-1):console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.clearTiles(),this.terrainScheduler.destroy(),this.terrainScheduler=null,this.modelLongitude=null,this.modelLatitude=null,this.tileAroundNum=null,this.maxZoom=null,this.modelTileX=null,this.modelTileY=null,this.globalLayer=null,this.tileGroup.clear(),this.tileGroup=null,this.loader=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.frustum=null,this.earthMatrix=null,this.useTerrain=null,this.modelRotationZ=null,this.basePoint=null,this.modelAltitude=null,this.tileOpacity=null,this.mapStyle=null,this.mapExcavation=null,this.materialMap=null,this.disableSkirt=null,this.mapUrl=null,this.layerList=null,this.baseRenderOrder=void 0,this.seg=void 0,this.maxTerrainLevel=void 0,this.modelTileAttitude=void 0,this.dataUrl=null,this.isCreated=void 0,this.terrainTileCount=void 0,this.tileCount=void 0,this.modelLayer=void 0,this.removeRenderCallback(),this._contentReadyDeferred&&(this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0),this.viewer=void 0,this.imageryProviderType=void 0,this.imageryProvider=null,this._requestCount=-1,r.GlobalData.EnableGisMap=!1}getLayer(){return this.modelLayer}dealOnlineTerrainConfig(e){(this.modelLongitude<e.longitude[0]||this.modelLongitude>e.longitude[1]||this.modelLatitude<e.latitude[0]||this.modelLatitude>e.latitude[1])&&console.warn("the model LongLat not in online terrain Scale"),this.terrainZoomScale=e.zoom;const t=e.boundary,i=t.leftX,r=t.rightX,n=t.upY,a=t.bottomY;this.textureXYZScale={};const s=this.terrainZoomScale[0];this.textureXYZScale[s]={},this.textureXYZScale[s].leftX=i+1,this.textureXYZScale[s].rightX=r-1,this.textureXYZScale[s].upY=n+1,this.textureXYZScale[s].bottomY=a-1;for(let e=this.terrainZoomScale[0]+1;e<=this.terrainZoomScale[1]+4;++e)this.textureXYZScale[e]={},this.textureXYZScale[e].leftX=2*this.textureXYZScale[e-1].leftX,this.textureXYZScale[e].rightX=2*this.textureXYZScale[e-1].rightX,this.textureXYZScale[e].upY=2*this.textureXYZScale[e-1].upY,this.textureXYZScale[e].bottomY=2*this.textureXYZScale[e-1].bottomY}addExternalObject(){var e=this.externalComponentManager.objectIds;null!=e&&-1!=e.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tileGroup)}onLoadTerrain(){!1===this.isCreated&&(!1===this.useTerrain||this.terrainTileCount<=0)&&(this.isCreated=!0,this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_CREATED}))}addRenderCallback(){var e=this;this.renderFunction=function(){e.updateEarth(),e.tileGroup.updateMatrixWorld(!0);for(var t=e.layerList.length,i=0;i<t;++i){e.layerList[i].tileGroup.updateMatrixWorld(!0)}},e.viewer.addCallbacks(r.EnumRenderCallbackType.PRE_RENDER,e.renderFunction),e.viewer.render()}removeRenderCallback(){this.renderFunction&&(this.viewer.removeCallbacks(r.EnumRenderCallbackType.PRE_RENDER,this.renderFunction),this.renderFunction=null)}updateModelLngLatByBasePoint(){}updateEarthMatrix(){}show(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}hide(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}hideAllLayers(){this.hide();for(const e of this.layerList)e.hide()}showAllLayers(){this.show();for(const e of this.layerList)e.show()}getModelRotationZ(){return this.modelRotationZ}setModelRotationZ(e){this.modelRotationZ=e,this.updateEarthMatrix()}getBasePoint(){return this.basePoint}getModelPosition(){return[this.modelLongitude,this.modelLatitude]}setModelPosition(e){this.clearTiles(),this.modelLongitude=e[0],this.modelLatitude=e[1],this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateEarthMatrix()}getModelAltitude(){return this.modelAltitude}setModelAltitude(e){this.modelAltitude=e,this.tileGroup.altitudeOffset=this.modelAltitude,this.updateEarthMatrix()}setModelRotationZ(e){this.modelRotationZ=e,this.updateEarthMatrix()}getLayerById(e){for(const t of this.layerList)if(t.id===e)return t}getOpacity(e){if(void 0===e)return this.tileOpacity;return this.getLayerById(e).opacity}setOpacity(e,t){if(void 0===t)this.tileOpacity=e;else{this.getLayerById(t).opacity=e}for(var i in this.materialMap)this.materialMap[i].opacity=this.tileOpacity,1-this.tileOpacity>r.Tile.DemTilesUtil.TWO_ACCURACY?this.materialMap[i].transparent=!0:this.materialMap[i].transparent=!1;1-this.tileOpacity>r.Tile.DemTilesUtil.TWO_ACCURACY?this.hideSkirt():this.showSkirt()}setStyle(e,t){if(e)if(t){const i=this.getLayerById(t);if(void 0===i)return;i.setStyle(e)}else for(var i in this.mapStyle=e,this.materialMap){var r=this.materialMap[i];r.updateStyle&&r.updateStyle(e)}}setExcavation(e){if(e)for(var t in this.mapExcavation=e,this.materialMap){var i=this.materialMap[t];i.updateExcavation&&i.updateExcavation(e),i.updateSide&&i.updateSide({isExcavation:e&&e.isExcavation})}}updateMaterialsSide(){for(var e in this.materialMap){var t=this.materialMap[e];t.updateSide&&t.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation})}}clearTiles(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].destroy();this.globalLayer={},this.tileGroup.clear()}hideSkirt(){for(var e in this.disableSkirt=!0,this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].skirt&&(this.globalLayer[e][t][i].skirt.visible=!1)}showSkirt(){for(var e in this.disableSkirt=!1,this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].skirt&&(this.globalLayer[e][t][i].skirt.visible=!0)}hideAllNodes(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].meshNode&&(this.globalLayer[e][t][i].meshNode.visible=!1)}_increaseRequestCount(){this._deferContentUpdate(),++this._requestCount}_decreaseRequestContent(){--this._requestCount,this._resolveContentUpdate()}_deferContentUpdate(){this._contentReadyDeferred||(this._requestCount=0,this._contentReadyDeferred=new r.Deferred,this._contentReadyDeferred.promise.then((()=>{this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0,this.viewer.render()})).catch((()=>{this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0,this.viewer.render()})))}_resolveContentUpdate(){0===this._requestCount&&this._contentReadyDeferred&&this._contentReadyDeferred.resolve()}updateEarth(){if(this.mapUrl){var e=this.viewer.camera;e.updateMatrix(),e.updateMatrixWorld(),this.frustum.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateModelLngLatByBasePoint();for(var t=(this.modelTileX,this.modelTileX),i=(this.modelTileY,this.modelTileY),n=this.tileAroundNum,a=this.maxZoom,s=(t=this.modelTileX-this.modelTileX%n,i=this.modelTileY-this.modelTileY%n,t);s<t+n;++s)for(var o=i;o<i+n;++o)this.addNode(s,o,a);this.updateTile(t,i,a,n)}}updateTile(e,t,i,r){var n=e/2,a=t/2;if((n=Math.floor(n-r/4))%2==1&&n--,(a=Math.floor(a-r/4))%2==1&&a--,!((i=i-1)<0)){for(var s=n;s<n+r;++s)for(var o=a;o<a+r;++o)s>=e/2&&s<e/2+r/2&&o>=t/2&&o<t/2+r/2||s>=Math.pow(2,i)||s<0||o>=Math.pow(2,i)||o<0||this.addNode(s,o,i);this.updateTile(n,a,i,r)}}getTerrainData(e,t,i,n,a){var s=this,o=this.seg,l=Math.pow(2,i-s.maxTerrainLevel),d=parseInt(e/l),h=parseInt(t/l),c=e%l,u=t%l,p=s.dataUrl.terrainUrl(i,e,t);i>s.maxTerrainLevel&&(p=s.dataUrl.terrainUrl(s.maxTerrainLevel,d,h)),s.terrainScheduler.push(p,(function(a){for(var d=Array.prototype.slice.call(new Int16Array(a)),h=new Array(o+1),p=0;p<h.length;p++){h[p]=new Array(o+1);for(var m=0;m<o+1;m++)d[p*(o+1)+m]!==r.Tile.DemTilesUtil.InvalidTerrainValue?h[p][m]=d[p*(o+1)+m]:h[p][m]=0}if(s.modelTileX==e&&s.modelTileY==t){var f=d[0],g=d.length;for(p=0;p<g;p++)d[p]<f&&(f=d[p]);s.modelTileAttitude=f}var v=h;if(i>s.maxTerrainLevel){var y=c*(o/l),M=u*(o/l),E=o/l,x=new Array(E+1);for(p=0;p<x.length;p++){x[p]=new Array(E+1);for(m=0;m<=E;++m)x[p][m]=h[M+p][y+m]}v=r.Tile.TileMath.createHeightArray(x,o)}n&&n(v)}),(function(){a&&a()}))}addNode(e,t,i){if(!(e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0)){var n=this;if(null==n.globalLayer[i]&&(n.globalLayer[i]={}),null==n.globalLayer[i][e]&&(n.globalLayer[i][e]={}),null==n.globalLayer[i][e][t]&&(n.globalLayer[i][e][t]=new r.Tile.DemTile(i,e,t)),n.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED)this.tileCount++,n.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,n.createTileGeometry(e,t,i,!0,(function(){n.createTileGeometryFinished(e,t,i)}));else if(n.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.LOADED||n.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED){n.globalLayer[i][e][t].geometry.computeBoundingBox();var a=n.globalLayer[i][e][t].geometry.boundingBox.clone();a.applyMatrix4(n.earthMatrix),n.globalLayer[i][e][t].box=a,n.createTileGeometryFinished(e,t,i)}}}createTileGeometryFinished(e,t,i){if(this.frustum.intersectsBox(this.globalLayer[i][e][t].box)){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[i][e][t].meshNode.visible=!0),this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var n=this.layerList.length,a=0;a<n;++a){(s=this.layerList[a]).contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}else{this.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[i][e][t].meshNode.visible=!1);for(n=this.layerList.length,a=0;a<n;++a){var s;(s=this.layerList[a]).contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!1)}}}createTileGeometry(e,t,i){}createLayerMaterial(e,t,i,n){if(!e.isAvailableTile(t,i,n))return;var a=this;e.setContentLoading(n,t,i),this._increaseRequestCount();const s=e.getRequestUrl(t,i,n);a.loader.load(s,(function(s){var o=new r.MapTileMaterial({map:s,transparent:!0,side:THREE.FrontSide});a.useClipping&&(o.defines.USE_CLIPPING=""),o.updateStyle(e.mapStyle),o.updateExcavation(a.mapExcavation),o.updateSide({isExcavation:a.mapExcavation&&a.mapExcavation.isExcavation});var l=`${n}-${t}-${i}`;o.opacity=e.opacity,null==e.materialMap[n]&&(e.materialMap[n]={}),null==e.materialMap[n][t]&&(e.materialMap[n][t]={}),e.materialMap[n][t][i]=o;var d=new THREE.Mesh(a.globalLayer[n][t][i].geometry,o);if(null==e.meshNodeMap[n]&&(e.meshNodeMap[n]={}),null==e.meshNodeMap[n][t]&&(e.meshNodeMap[n][t]={}),e.meshNodeMap[n][t][i]=d,d.name=l,a.globalLayer[n][t][i].skirtGeometry){const s=`Skirt-${n}-${t}-${i}`,l=new THREE.Mesh(a.globalLayer[n][t][i].skirtGeometry,o);l.name=s,l.renderOrder=a.baseRenderOrder+1+e.priority,e.tileGroup.add(l),l.onBeforeRender=function(e,t,i,n,a,s){r.GroundDrawingManager.onBeforeRenderFunc(a,this)}}(a.tileOpacity<1||a.disableSkirt)&&a.globalLayer[n][t][i].skirt&&(skirtMeshNode.visible=!1),d.renderOrder=a.baseRenderOrder+1+e.priority,e.tileGroup.add(d),e.tileGroup.updateMatrixWorld(!0),e.setContentLoaded(n,t,i),a._decreaseRequestContent()}))}updateMaterialTexture(e,t,i){const n=this;this._increaseRequestCount(),this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING;const a=n.imageryProvider.getImageryUrl(e,t,i);this.loader.load(a,(a=>{this.globalLayer[i][e][t].needUpdateTexture=!1,this.globalLayer[i][e][t].texture=a,this.globalLayer[i][e][t].material.map=a,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,n._decreaseRequestContent()}))}createMaterial(e,t,i,n){var a=this;if(!1!==a.imageryProvider.ready)return a.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING,new Promise((function(s,o){a._increaseRequestCount();const l=a.imageryProvider.getImageryUrl(e,t,i);a.loader.load(l,(function(o){if(n===a.mapUrl){o.encoding=THREE.GammaEncoding;var l=new r.MapTileMaterial({map:o,transparent:!1,side:THREE.FrontSide});a.useClipping&&(l.defines.USE_CLIPPING=""),l.updateStyle(a.mapStyle),l.updateExcavation(a.mapExcavation),l.updateSide({isExcavation:a.mapExcavation&&a.mapExcavation.isExcavation});var d=`${i}-${e}-${t}`;if(l.opacity=a.tileOpacity,a.tileOpacity<1&&(l.transparent=!0),a.globalLayer[i][e][t].meshNode)return a.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,s(a.globalLayer[i][e][t]),void a._decreaseRequestContent();if(a.materialMap[d]=l,a.globalLayer[i][e][t].texture=o,a.globalLayer[i][e][t].material=l,a.globalLayer[i][e][t].meshNode=new THREE.Mesh(a.globalLayer[i][e][t].geometry,a.materialMap[d]),a.globalLayer[i][e][t].meshNode.name=d,a.globalLayer[i][e][t].meshNode.renderOrder=a.baseRenderOrder,a.tileGroup.add(a.globalLayer[i][e][t].meshNode),a.globalLayer[i][e][t].skirtGeometry){var h=`Skirt-${i}-${e}-${t}`;a.globalLayer[i][e][t].skirt=new THREE.Mesh(a.globalLayer[i][e][t].skirtGeometry,a.materialMap[d]),a.globalLayer[i][e][t].skirt.name=h,a.globalLayer[i][e][t].skirt.renderOrder=a.baseRenderOrder,a.tileGroup.add(a.globalLayer[i][e][t].skirt)}(a.tileOpacity<1||a.disableSkirt)&&a.globalLayer[i][e][t].skirt&&(a.globalLayer[i][e][t].skirt.visible=!1),a.globalLayer[i][e][t].skirt&&(a.globalLayer[i][e][t].skirt.onBeforeRender=function(e,t,i,n,s,o){r.GroundDrawingManager.onBeforeRenderFunc(s,this,a.modelLayer)}),a.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,a.onLoadTerrain(),s(a.globalLayer[i][e][t]),a._decreaseRequestContent(),a.tileCount--}else a._decreaseRequestContent()}),void 0,(e=>{console.log(e),a._decreaseRequestContent(),a.tileCount--}))}))}setMapLayer(e){this.mapUrl=`https://mt3.google.cn/vt/lyrs=${e}&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}`,this.clearTiles()}setMapUrl(e,t){this.mapUrl=e,this.imageryProviderType=r.Utils.defaultValue(t,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[t]({mapUrl:e}),this.imageryProvider.setReadyCallback((()=>{this.viewer.render()})),this.clearTiles()}isUseTerrain(){return this.useTerrain}applyTerrain(e){this.useTerrain=e,this.clearTiles()}addRoad(e,t){const i=new r.Tile.TextureLayer(this.viewer,{url:e});return i.priority=t,this.layerList[0]=i,this.updateEarthMatrix(),i}removeRoad(e){(e||this.layerList[0]).destroy(),this.layerList=[]}addImageryLayer(e,t){const i=e.mapUrl||e.url,n=e.imageryProviderType,a=e.hasTileMapResource,s=void 0===e.layerName?r.Utils.getEncodedId(i):e.layerName,o=this.layerList,l=t>=0&&t<o.length?t:o.length;let d,h=-1;for(let e=0,t=o.length;e<t;++e)if(o[e].url===i){h=e;break}return-1!==h?(d=o[h],o.splice(h,1)):d=new r.Tile.TextureLayer(this.viewer,{url:i,imageryProviderType:n,hasTileMapResource:a,layerName:s}),o.splice(l,0,d),this._updateLayerList(),this.updateEarthMatrix(),d.id}removeImageryLayer(e){const t=this.layerList,i=this.getLayerById(e);if(!i)return;const r=t.indexOf(i);-1!==r&&(t.splice(r,1),i.destroy(),this._updateLayerList(),this.updateEarthMatrix())}_updateLayerList(){const e=this.baseRenderOrder+1,t=this.layerList;for(let i=0,r=t.length;i<r;i++){const r=t[i];if(r.priority=i,r.meshNodeMap){const t=e+r.priority;r.updateMeshRenderOrder(t)}}}getMaxLevel(){return this.maxZoom}setMaxLevel(e){this.maxZoom=e,this.clearTiles()}},(()=>{let e=new THREE.Box3,t=new THREE.Matrix4,i=new THREE.Vector3;class n extends r.Tile.TileManager{constructor(e,t,i){super(e,t,i),this.mercatorPerimeter=r.Tile.TileMath.mercatorPerimeter,this.updateEarthMatrix(),this.tileGroup.name=r.GlobalData.TilePlaneGroupName,this.tileBuilder=new r.Tile.PlaneTileBuilder,this.terrainTileCount=this.tileAroundNum**2+(this.tileAroundNum**2-(this.tileAroundNum/2)**2)*(this.maxZoom-this.minTerrainLevel)}destroy(){this.viewer.modelManager.scene.removeObjectGroupByName(r.GlobalData.TilePlaneGroupName),this.offset=null,this.mercatorPerimeter=null,this.terrainLoader=null,this.tileBuilder=null,super.destroy()}updateModelLngLatByBasePoint(){let e=this.viewer.getBoundingBoxWorld().getCenter(i);const t=(new THREE.Matrix4).makeTranslation(-this.basePoint.x,-this.basePoint.y,0),n=(new THREE.Matrix4).makeRotationZ(this.modelRotationZ),a=(new THREE.Matrix4).makeTranslation(this.basePoint.x,this.basePoint.y,0);e.applyMatrix4(t),e.applyMatrix4(n),e.applyMatrix4(a);const s=this.mercator2lonLat(e);this.modelTileX=r.Tile.TileMath.long2tile(s.x,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(s.y,this.maxZoom)}updateEarthMatrix(){this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateModelLngLatByBasePoint();var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),n=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,a=-t*n+.5*n-.5*n,s=-i*n-.5*n+.5*n,o=(new THREE.Matrix4).makeTranslation(a+this.basePoint.x,s+this.basePoint.y,-this.modelAltitude*r.Tile.TileMath.unitScale),l=(new THREE.Matrix4).makeTranslation(a,s,0),d=(new THREE.Matrix4).makeRotationZ(-this.modelRotationZ),h=(new THREE.Matrix4).makeTranslation(-a,-s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(l),this.tileGroup.applyMatrix4(d),this.tileGroup.applyMatrix4(h),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var c=this.layerList.length,u=0;u<c;++u){var p=this.layerList[u];p.tileGroup.matrix.identity(),p.tileGroup.applyMatrix4(l),p.tileGroup.applyMatrix4(d),p.tileGroup.applyMatrix4(h),p.tileGroup.applyMatrix4(o),p.tileGroup.applyMatrix4(this.globalMatrix),p.tileGroup.matrixAutoUpdate=!1,p.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}createTerrainGeometry(e,t,i,r,n,a,s){var o=this.tileBuilder.computePlaneGeometry(i,i,t,a,!1),l=o[0];return s&&(this.globalLayer[e][r-1]&&this.globalLayer[e][r-1][n]&&this.globalLayer[e][r-1][n].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r-1][n].geometry,t,"left"),this.globalLayer[e][r+1]&&this.globalLayer[e][r+1][n]&&this.globalLayer[e][r+1][n].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r+1][n].geometry,t,"right"),this.globalLayer[e][r]&&this.globalLayer[e][r][n-1]&&this.globalLayer[e][r][n-1].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r][n-1].geometry,t,"bottom"),this.globalLayer[e][r]&&this.globalLayer[e][r][n+1]&&this.globalLayer[e][r][n+1].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r][n+1].geometry,t,"top")),o}updateTileMeshForFlatten(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this._updateTileMeshForFlatten(this.globalLayer[e][t][i])}_updateTileMeshForFlatten(i){if(i.box&&i.terrainData){var n=i.x,a=i.y,s=i.zoom,o=i.terrainData,l=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,d=(n*Math.pow(2,this.maxZoom-s)-this.modelTileX)*l+Math.pow(2,this.maxZoom-s)/2*l,h=-(a*Math.pow(2,this.maxZoom-s)-this.modelTileY)*l-Math.pow(2,this.maxZoom-s)/2*l;t.makeTranslation(d,h,0),t.multiplyMatrices(this.earthMatrix,t);var c=this.mercatorPerimeter/Math.pow(2,s)*r.Tile.TileMath.unitScale*2,u=this.seg,p=i.geometry,m=i.skirtGeometry;e.copy(i.box),e.min.y=e.max.y=0;var f=this.viewer.terrainOperationManager.isIntersectFlattenBboxDrawing(e,r.ObjectGroupType.TILEGROUP);if(!f&&i.isFlattened)return p.translate(-d,-h,0),m.translate(-d,-h,0),this.tileBuilder.updateGeometryForFlatten(c,c,u,o,!1,r.Tile.TileMath.unitScale,this.viewer.terrainOperationManager,t,p,m,!0),p.translate(d,h,0),m.translate(d,h,0),void(i.isFlattened=!1);f&&(p.translate(-d,-h,0),m.translate(-d,-h,0),this.tileBuilder.updateGeometryForFlatten(c,c,u,o,!1,r.Tile.TileMath.unitScale,this.viewer.terrainOperationManager,t,p,m,!1),p.translate(d,h,0),m.translate(d,h,0),i.isFlattened=!0)}}translateGeometry(e,t,i,n,a,s){var o=this;null==a&&(a=0);var l=o.mercatorPerimeter/Math.pow(2,o.maxZoom)*r.Tile.TileMath.unitScale*2,d=(i*Math.pow(2,o.maxZoom-t)-o.modelTileX)*l+Math.pow(2,o.maxZoom-t)/2*l,h=-(n*Math.pow(2,o.maxZoom-t)-o.modelTileY)*l-Math.pow(2,o.maxZoom-t)/2*l;e.translate(d,h,a),o.globalLayer[t][i][n].geometry=e,e.computeBoundingBox();var c=e.boundingBox.clone();c.applyMatrix4(o.earthMatrix),o.globalLayer[t][i][n].box=c,o.globalLayer[t][i][n].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}translateGeometryWithSkirt(e,t,i,n,a,s,o){var l=e[0],d=e[1],h=this;null==a&&(a=0);var c=h.mercatorPerimeter/Math.pow(2,h.maxZoom)*r.Tile.TileMath.unitScale*2,u=(i*Math.pow(2,h.maxZoom-t)-h.modelTileX)*c+Math.pow(2,h.maxZoom-t)/2*c,p=-(n*Math.pow(2,h.maxZoom-t)-h.modelTileY)*c-Math.pow(2,h.maxZoom-t)/2*c;l.translate(u,p,a),d.translate(u,p,a),h.globalLayer[t][i][n].geometry=l,h.globalLayer[t][i][n].skirtGeometry=d,l.computeBoundingBox();var m=l.boundingBox.clone();m.applyMatrix4(h.earthMatrix),h.globalLayer[t][i][n].box=m,h.globalLayer[t][i][n].terrainData=s,h.globalLayer[t][i][n].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,o&&o(),h._updateTileMeshForFlatten(h.globalLayer[t][i][n])}getTerrainGeometry(e,t,i,r,n,a,s){this.getTerrainData(e,t,i,(o=>{let l=this.createTerrainGeometry(i,r,n,e,t,o,a);this.translateGeometryWithSkirt(l,i,e,t,null,o,s),this.terrainTileCount--,this.onLoadTerrain()}),(()=>{this.terrainTileCount--,this.onLoadTerrain();let a=new THREE.PlaneBufferGeometry(n,n,r);this.translateGeometry(a,i,e,t,null,s)}))}createTileGeometry(e,t,i,n,a){const s=this.mercatorPerimeter/Math.pow(2,i)*r.Tile.TileMath.unitScale*2,o=this.seg;if(this.useTerrain&&this.textureXYZScale&&this.textureXYZScale[i]&&this.textureXYZScale[i].leftX<=e&&this.textureXYZScale[i].rightX>=e&&this.textureXYZScale[i].upY<=t&&this.textureXYZScale[i].bottomY>=t)this.getTerrainGeometry(e,t,i,o,s,n,a);else if(this.useTerrain&&!this.textureXYZScale&&i>=this.minTerrainLevel)this.getTerrainGeometry(e,t,i,o,s,n,a);else{var l=new THREE.PlaneBufferGeometry(s,s,o);this.translateGeometry(l,i,e,t,null,a)}}worldPositionToLngLat(e){return this.mercator2lonLat(e)}lngLatToWorldPositionWithObj(e,t){const i=e.lon,r=e.lat,n=e.id,a=e.order;var s=this.lonLat2Mercator(i,r);return this.useTerrain&&t?this.getTileIntersectPoint([i,r],s,t):t&&t({worldPosition:s,id:n,order:a}),s}lngLatToWorldPosition(e,t){var i=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain&&t?this.getTileIntersectPoint(e,i,t):t&&t(i),i}_lngLatToWorldPosition2(e){var t=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain?this.getTerrainHeight(t):t}getTerrainHeight(e){var t,i=e.applyMatrix4(this.globalMatrix),n=new r.Raycaster(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(0,-1,0)),a=[];return this.raycast(this.tileGroup,n,a),a.length>0?((t=a[0].point.clone()).applyMatrix4(this.globalMatrixInverse),t):(n=new r.Raycaster(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(0,1,0)),a=[],this.raycast(this.tileGroup,n,a),a.length>0?((t=a[0].point.clone()).applyMatrix4(this.globalMatrixInverse),t):void 0)}raycast(e,t,i){for(var n=0,a=e.children.length;n<a;n++){var s=e.children[n];if(r.Utils.isGroupObject(s))this.raycast(s,t,i);else{if(-1!=s.name.indexOf("Skirt"))continue;s.raycast(t,i)}}}lonLat2Mercator(e,t){var i=new THREE.Vector3,n=r.Tile.TileMath.lonLat2Mercator(e,t,this.mercatorPerimeter),a=r.Tile.TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter).sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return i.x=n.x-a.x,i.y=n.y-a.y,i.z=-this.modelAltitude*r.Tile.TileMath.unitScale,i}mercator2lonLat(e){var t=r.Tile.TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter).sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return r.Tile.TileMath.mercator2lonLat(new THREE.Vector2(e.x+t.x,e.y+t.y),this.mercatorPerimeter)}getTileIntersectPoint(e,t,i){e[0],e[1];let n=!1;var a=this;t.z=r.Tile.TileMath.earthHighestAltitude;var s=t.clone().applyMatrix4(this.globalMatrix);for(let e=this.maxZoom;e>=3;e--){var o=this.globalLayer[e];for(let l in o)for(let d in o[l]){let h=o[l][d].box;null!==h&&(s.x<=h.max.x&&s.x>=h.min.x&&s.z<=h.max.z&&s.z>=h.min.z&&(n=!0,a.globalLayer[e][l][d].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,a.createTileGeometry(l,d,e,!0,(function(){a.createMaterial(l,d,e,a.mapUrl).then((function(e){var n=new r.Raycaster(new THREE.Vector3(s.x,s.y,s.z),new THREE.Vector3(0,-1,0)),o=[];e.meshNode.raycast(n,o);var l=void 0;if(o.length>0)return(l=o[0].point.clone()).applyMatrix4(a.globalMatrixInverse),l.x=t.x,l.y=t.y,void(i&&i(l))}))}))))}}0==n&&(t.z=-a.modelAltitude*r.Tile.TileMath.unitScale,i&&i(t))}_getOnlineTerrainHeight2(e,t){var i=r.Tile.TileMath.long2tile(e,this.maxZoom),n=r.Tile.TileMath.lat2tile(t,this.maxZoom),a=Math.pow(2,this.maxZoom-this.maxTerrainLevel),s=parseInt(i/a),o=parseInt(n/a),l=i%a,d=n%a,h=new THREE.FileLoader;h.setResponseType("arraybuffer");var c=this.dataUrl.terrainUrl(this.maxTerrainLevel,s,o),u=this;h.load(c,(function(a){for(var s=Array.prototype.slice.call(new Uint16Array(a)),o=new Array(17),h=0;h<o.length;h++){o[h]=new Array(17);for(var c=0;c<17;c++)o[h][c]=s[17*h+c]}var p=o[d][l],m=o[d][l+1],f=o[d+1][l],g=o[d+1][l+1],v=r.Tile.TileMath.tile2boundingBox(i,n,u.maxZoom),y=p+(f-p)*(v.north-t)/(v.north-v.south),M=y+(m+(g-m)*(v.north-t)/(v.north-v.south)-y)*(e-v.west)/(v.east-v.west);console.log(M)}))}}r.Tile.TilePlaneManager=n})();class k extends r.Tile.TileManager{constructor(e,t,i){super(e,t,i),this.tileGroup.name=r.GlobalData.TileGlobalGroupName,this.tileBuilder=new r.Tile.GlobeTileBuilder,this.updateEarthMatrix()}destroy(){this.offset=null,this.tileBuilder=null,super.destroy()}updateEarthMatrix(){this.earthPos=r.Tile.TileMath.fromDegrees(this.modelLongitude,this.modelLatitude),this.offset=new THREE.Vector3(this.basePoint.x*r.Tile.TileMath.unitScale/1e3,this.basePoint.y*r.Tile.TileMath.unitScale/1e3,-r.Tile.TileMath.earthRadius*r.Tile.TileMath.unitScale-this.modelAltitude*r.Tile.TileMath.unitScale);var e=this.earthPos.clone().normalize(),t=(new THREE.Quaternion).setFromUnitVectors(e,new THREE.Vector3(0,0,1)),i=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,0,1),THREE.Math.degToRad(270-this.modelLongitude)-this.modelRotationZ);t.premultiply(i);var n=(new THREE.Matrix4).makeRotationFromQuaternion(t),a=(new THREE.Matrix4).makeTranslation(this.offset.x,this.offset.y,this.offset.z);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(n),this.tileGroup.applyMatrix4(a),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var s=this.layerList.length,o=0;o<s;++o){var l=this.layerList[o];l.tileGroup.matrix.identity(),l.tileGroup.applyMatrix4(n),l.tileGroup.applyMatrix4(a),l.tileGroup.applyMatrix4(this.globalMatrix),l.tileGroup.matrixAutoUpdate=!1,l.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}translateGeometry(e,t,i,n){var a=new THREE.BufferGeometry;a.setIndex(n.index),a.setAttribute("position",new THREE.BufferAttribute(n.position,3)),a.setAttribute("uv",new THREE.BufferAttribute(n.uvs,2)),a.translate(n.center.x*r.Tile.TileMath.unitScale,n.center.y*r.Tile.TileMath.unitScale,n.center.z*r.Tile.TileMath.unitScale),this.globalLayer[i][e][t].geometry=a,a.computeBoundingBox();var s=a.boundingBox.clone();s.applyMatrix4(this.earthMatrix),this.globalLayer[i][e][t].box=s,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED}createStandardGlobalGeometry(e,t,i){var r=this.tileBuilder.computeBuffer(e,t,i,void 0,!1);this.translateGeometry(e,t,i,r)}createTerrainGlobalGeometry(e,t,i,r){const n=this.tileBuilder.computeBuffer(e,t,i,void 0,!1,r);this.translateGeometry(e,t,i,n)}createTileGeometry(e,t,i,r,n){this.seg;var a=this;a.useTerrain&&i>=a.minTerrainLevel?a.getTerrainData(e,t,i,(function(r){a.createTerrainGlobalGeometry(e,t,i,r),n&&n()}),(function(){a.createStandardGlobalGeometry(e,t,i),n&&n()})):(a.createStandardGlobalGeometry(e,t,i),n&&n())}}r.Tile.TileGlobalManager=k,r.Tile.TileManagerFactory={TilePlaneManager:function(e,t,i){return new r.Tile.TilePlaneManager(e,t,i)},TileGlobalManager:function(e,t,i){return new r.Tile.TileGlobalManager(e,t,i)}},function(){class e extends r.BaseModel{constructor(e,t,i,n,a,s){super(t,i),this.isDemLayer=!0,this.id=r.ObjectGroupType.TILEGROUP,this.databagId=this.id,this.viewer=e,this.parseCfgFinish=a,this.debut=s,this.dataUrl=new r.Loader.Url(i),this.tileManager=null,this.loadTileConfig=i.loadConfig,this.ObjectGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.TILEGROUP,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0})}destroy(){this.manager.removeModel(this.id,!1),this.tileManager.destroy(),this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.TILEGROUP),this.parseCfgFinish=null,this.debut=null,this.viewer=null,super.destroy()}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});var i=new THREE.FileLoader;i.setResponseType("json"),i.load(this.dataUrl.projectUrl(),(function(e){var i=e.metadata.longitude,n=e.metadata.latitude,a=e.metadata.zoom;r.GlobalData.ConstraintZoom=!0;t.viewer.cameraControl.setMaximalRangeofCamera(100),t.viewer.lockAxisZ("Z",[.1,Math.PI/2.01]),t.loadTile(t.viewer,t.loadTileConfig,i,n,a),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t)}))}loadTile(e,t){e.getScene().geometryGroup.boundingBox||(this.getTransforms().boundingBox=new THREE.Box3(new THREE.Vector3(-r.GlobalData.SceneSize,-r.GlobalData.SceneSize,-r.GlobalData.SceneSize),new THREE.Vector3(r.GlobalData.SceneSize,r.GlobalData.SceneSize,r.GlobalData.SceneSize)),this.manager.updateScene(this));var i=e.getScene().getRawMatrixGlobal();(new THREE.Matrix4).copy(i).invert();var n={};if(t&&"[object Number]"===Object.prototype.toString.call(t.modelAltitude)?n.modelAltitude=t.modelAltitude:(console.log("modelAltitude not in loadConfig, default 0"),n.modelAltitude=0),t&&"[object Number]"===Object.prototype.toString.call(t.modelRotationZ)?n.modelRotationZ=t.modelRotationZ:(console.log("modelRotationZ not in loadConfig, default 0"),n.modelRotationZ=0),t&&t.basePoint?n.basePoint=t.basePoint:(console.log("basePoint not in loadConfig, default (0,0)"),n.basePoint=new THREE.Vector3(0,0,0)),t&&t.modelPosition){n.modelPosition=t.modelPosition,n.useTerrain=t&&t.useTerrain,n.terrainPath=t.terrainPath,n.opacity=t.opacity,n.mapUrl=t.mapUrl,n.terrainOnlineConfig=t.terrainOnlineConfig,n.mapStyle=t.mapStyle,n.useClipping=t.sectionable,n.dataUrl=this.dataUrl,n.maxTerrainLevel=void 0===t.maxTerrainLevel?14:t.maxTerrainLevel,n.minTerrainLevel=void 0===t.minTerrainLevel?10:t.minTerrainLevel,n.maxZoom=void 0===t.maxLevel?18:t.maxLevel,n.imageryProviderType=void 0===t.imageryProviderType?"UrlTemplate":t.imageryProviderType;var a="TilePlaneManager";n.useUnitMeter=t&&t.useUnitMeter,!0===n.useUnitMeter?r.Tile.TileMath.unitScale=1:"global"===n.useUnitMeter&&(a="TileGlobalManager",r.Tile.TileMath.unitScale=1),n.mapLayer=t.mapLayer,this.tileManager=r.Tile.TileManagerFactory[a](this,n,this.ObjectGroup),this.tileManager.addRenderCallback()}else console.log("modelPosition not in loadConfig")}updateMatrix(){this.tileManager&&this.tileManager.updateEarthMatrix()}}r.DemModel=e}(),function(){class e extends r.Tile.TilePlaneManager{constructor(e,t,i){super(e,t,i),this.loadAll=!1}destroy(){this.loadAll=void 0}update(){this.updateEarthMatrix(),this.updateEarth(),this.viewer.render(),this.onLoadTile()}updateEarthMatrix(){this.globalMatrix=this.viewer.getScene().getRawMatrixGlobal(),this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),n=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,a=-t*n+.5*n-.5*n,s=-i*n-.5*n+.5*n,o=(new THREE.Matrix4).makeTranslation(a,s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var l=this.layerList.length,d=0;d<l;++d){var h=this.layerList[d];h.tileGroup.matrix.identity(),h.tileGroup.applyMatrix4(o),h.tileGroup.applyMatrix4(this.globalMatrix),h.tileGroup.matrixAutoUpdate=!1,h.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}updateModelLngLatByBasePoint(){}onLoadTile(){!1===this.loadAll&&this.tileCount<=3&&(this.loadAll=!0,this.viewer.modelManager.setRenderStateChanged(!0),this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL}))}createTileGeometryFinished(e,t,i){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var n=this.layerList.length,a=0;a<n;++a){var s=this.layerList[a];s.contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}}r.Tile.FullPlaneTileManager=e}(),function(){class e extends r.Tile.TilePlaneManager{constructor(e,t,i){super(e,t,i),this.loadAll=!1;const n=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2;this.commonGeometry=new THREE.PlaneBufferGeometry(n,n,1),this.commonBox=(new THREE.Box3).setFromArray([-n/2,-n/2,0,n/2,n/2,0])}destroy(){this.loadAll=void 0}update(){this.updateEarthMatrix(),this.updateEarth(),this.onLoadTile()}updateEarthMatrix(){this.globalMatrix=this.viewer.getScene().getRawMatrixGlobal(),this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),n=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,a=-t*n+.5*n-.5*n,s=-i*n-.5*n+.5*n,o=(new THREE.Matrix4).makeTranslation(a,s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var l=this.layerList.length,d=0;d<l;++d){var h=this.layerList[d];h.tileGroup.matrix.identity(),h.tileGroup.applyMatrix4(o),h.tileGroup.applyMatrix4(this.globalMatrix),h.tileGroup.matrixAutoUpdate=!1,h.tileGroup.updateMatrixWorld(!0)}}updateModelLngLatByBasePoint(){}onLoadTile(){!1===this.loadAll&&this.tileCount<=3&&(this.loadAll=!0,this.viewer.modelManager.setRenderStateChanged(!0),this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL}))}addNode(e,t,i){e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0||(null==this.globalLayer[i]&&(this.globalLayer[i]={}),null==this.globalLayer[i][e]&&(this.globalLayer[i][e]={}),null==this.globalLayer[i][e][t]&&(this.globalLayer[i][e][t]=new r.Tile.DemTile(i,e,t)),this.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED?(this.tileCount++,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,this.createTileGeometry(e,t,i,!0,(()=>{this.createTileGeometryFinished(e,t,i)}))):this.globalLayer[i][e][t].meshLoadState!=r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.globalLayer[i][e][t].meshLoadState!=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED||this.createTileGeometryFinished(e,t,i))}createTileGeometry(e,t,i,n,a){const s=this.mercatorPerimeter/Math.pow(2,i)*r.Tile.TileMath.unitScale*2,o=this.seg;this.useTerrain&&this.textureXYZScale&&this.textureXYZScale[i]&&this.textureXYZScale[i].leftX<=e&&this.textureXYZScale[i].rightX>=e&&this.textureXYZScale[i].upY<=t&&this.textureXYZScale[i].bottomY>=t||this.useTerrain&&!this.textureXYZScale&&i>=this.minTerrainLevel?this.getTerrainGeometry(e,t,i,o,s,n,a):this.translateGeometry(this.commonGeometry,i,e,t,null,a)}translateGeometry(e,t,i,n,a,s){null==a&&(a=0);const o=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,l=Math.pow(2,this.maxZoom-t),d=(i*l-this.modelTileX)*o+l/2*o,h=-(n*l-this.modelTileY)*o-l/2*o;let c=new THREE.Matrix4;c.compose(new THREE.Vector3(d,h,1),new THREE.Quaternion,new THREE.Vector3(l,l,l)),this.globalLayer[t][i][n].tileMatrix=c;let u=this.commonBox.clone().applyMatrix4(c);u.applyMatrix4(this.earthMatrix),this.globalLayer[t][i][n].box=u,this.globalLayer[t][i][n].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}translateGeometryWithSkirt(e,t,i,n,a,s){null==a&&(a=0);let o=e[0],l=e[1];const d=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,h=Math.pow(2,this.maxZoom-t),c=(i*h-this.modelTileX)*d+h/2*d,u=-(n*h-this.modelTileY)*d-h/2*d;let p=new THREE.Matrix4;p.compose(new THREE.Vector3(c,u,1),new THREE.Quaternion,new THREE.Vector3(1,1,1)),this.globalLayer[t][i][n].tileMatrix=p,this.globalLayer[t][i][n].geometry=o,this.globalLayer[t][i][n].skirtGeometry=l,o.computeBoundingBox();var m=o.boundingBox.clone().applyMatrix4(p);m.applyMatrix4(this.earthMatrix),this.globalLayer[t][i][n].box=m,this.globalLayer[t][i][n].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}createTileGeometryFinished(e,t,i){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var n=this.layerList.length,a=0;a<n;++a){var s=this.layerList[a];s.contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}createMaterial(e,t,i){this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING;var n=this;return new Promise(((a,s)=>{const o=n.imageryProvider.getImageryUrl(e,t,i);this.loader.load(o,(s=>{let o=new r.MapTileMaterial({map:s,transparent:!1,side:THREE.FrontSide});this.useClipping&&(o.defines.USE_CLIPPING=""),o.updateStyle(n.mapStyle);let l=`${i}-${e}-${t}`;if(o.opacity=this.tileOpacity,this.tileOpacity<1&&(o.transparent=!0),this.globalLayer[i][e][t].meshNode)return this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,void a(this.globalLayer[i][e][t]);this.materialMap[l]=o,this.globalLayer[i][e][t].texture=s,this.globalLayer[i][e][t].material=o;let d=null;if(d=this.useTerrain&&this.globalLayer[i][e][t].geometry?new THREE.Mesh(this.globalLayer[i][e][t].geometry,this.materialMap[l]):new THREE.Mesh(this.commonGeometry,this.materialMap[l]),this.globalLayer[i][e][t].meshNode=d,this.globalLayer[i][e][t].meshNode.name=l,this.globalLayer[i][e][t].meshNode.renderOrder=this.baseRenderOrder,this.globalLayer[i][e][t].meshNode.matrix=this.globalLayer[i][e][t].tileMatrix,this.globalLayer[i][e][t].meshNode.matrixAutoUpdate=!1,this.tileGroup.add(this.globalLayer[i][e][t].meshNode),this.globalLayer[i][e][t].skirtGeometry){var h=`Skirt-${i}-${e}-${t}`;this.globalLayer[i][e][t].skirt=new THREE.Mesh(this.globalLayer[i][e][t].skirtGeometry,this.materialMap[l]),this.globalLayer[i][e][t].skirt.name=h,this.globalLayer[i][e][t].skirt.renderOrder=this.baseRenderOrder,this.globalLayer[i][e][t].skirt.matrix=this.globalLayer[i][e][t].tileMatrix,this.globalLayer[i][e][t].skirt.matrixAutoUpdate=!1,this.tileGroup.add(this.globalLayer[i][e][t].skirt)}(this.tileOpacity<1||this.disableSkirt)&&this.globalLayer[i][e][t].skirt&&(this.globalLayer[i][e][t].skirt.visible=!1),this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,this.viewer.render(),this.onLoadTerrain(),a(this.globalLayer[i][e][t]),this.tileCount--}),void 0,(()=>{this.tileCount--}))}))}}r.Tile.FullPlaneTileManager2=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,n,a,s){super(t,i),this.id=r.ObjectGroupType.TILEGROUP,this.databagId=this.id,this.viewer=e,this.index=n,this.parseCfgFinish=a,this.debut=s,this.dataUrl=new r.Loader.Url(i),this.loadTileConfig=i.loadConfig,this.tileBuilder=new r.Tile.GlobeTileBuilder,this.objectGroup=t.getScene().getOrCreateObjectGroup(r.GlobalData.TileGlobalGroupName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0}),this.manager.addModel(this),this.tileManager=null,this._modelMatrix=new THREE.Matrix4}destroy(){this._modelMatrix=null,this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.TILEGROUP),this.tileManager.destroy(),this.tileBuilder.destroy(),this.tileBuilder=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null,this.dataUrl=null,this.loadTileConfig=null,super.destroy()}load(e){this.manager.setDrawableModel(!0),this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.viewer.rendererManager.setupRenderer(this.viewer.renderSettings),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});const t=r.GlobalData.SceneSize;this.getTransforms().boundingBox=(new THREE.Box3).setFromArray([-t,-t,-t,t,t,t]),this.manager.updateScene(this),this.loadModelConfig(this.viewer,this.loadTileConfig),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE})}loadModelConfig(e,t){r.Tile.TileMath.unitScale=1,t.dataUrl=this.dataUrl,this.tileManager=new r.Tile.FullPlaneTileManager2(this,t,this.objectGroup)}hasTransforms(){return!0}preUpdate(e){}update(e){this.tileManager&&this.tileManager.update()}postUpdate(e){}isUserIdExist(e){return!1}}r.Tile.FullPlaneTileModel=e}(),r.Layer.Imagery=class{constructor(e){e=e||{},this.imageryLayer=e.layer,this.x=e.x,this.y=e.y,this.level=e.level,this.request=void 0,this.state=r.Layer.ImageryState.UNLOADED,this.imageUrl=void 0,this.image=void 0,this.texture=void 0,this._destroyed=!1,this.referenceCount=0,this._retryTimes=r.Utils.defaultValue(e.retryTimes,2),this._retryCount=0}destroy(){this._destroyed=!0,this.image&&this.image.destroy&&this.image.destroy(),this.image=void 0,this.texture&&this.texture.destroy&&this.texture.destroy(),this.texture=void 0,this.request&&(this.request.destroy(),this.request=void 0),this.imageryLayer.removeImagery(this),this.imageryLayer=void 0}isDestroyed(){return this._destroyed}addReference(){++this.referenceCount}releaseReference(){return--this.referenceCount,0!==this.referenceCount?this.referenceCount:(this.destroy(),0)}retryOnError(){return!(this._retryCount>=this._retryTimes||(++this._retryCount,0))}get contentUnloaded(){return this.state===r.Layer.ImageryState.UNLOADED}get contentFailed(){return this.state===r.Layer.ImageryState.FAILED}get contentReady(){return this.state===r.Layer.ImageryState.READY}},function(){class e{constructor(e){this.imageryProvider=e.imageryProvider,this.show=r.Utils.defaultValue(e.show,!0),this.lastShow=!0,this.layerIndex=-1,this.baseLayer=!1,this._imageryCache={},this._destroyed=!1,this._skeleton=new r.Layer.Imagery({layer:this,x:0,y:0,level:0})}destroy(){this._destroyed=!0,this._skeleton.destroy(),this._skeleton=void 0,this.destroyAllImagery(),this._imageryCache=void 0,this.imageryProvider&&this.imageryProvider.destroy&&this.imageryProvider.destroy(),this.imageryProvider=void 0}isDestroyed(){return this._destroyed}static getImageryCacheKey(e,t,i){return`${e}-${t}-${i}`}_createTileImagerySkeletons(e,t,i){if(r.Utils.defined(this._minTerrainLevel)&&e.level<this._minTerrainLevel)return!1;if(r.Utils.defined(this._maxTerrainLevel)&&e.level>this._maxTerrainLevel)return!1;const n=this.imageryProvider;return r.Utils.defined(i)||(insertionPoint=e.imageries.length),n.ready?void 0:(this._skeleton.addReference(),e.imageries.splice(i,0,this._skeleton),!0)}getImagery(t,i,n){const a=e.getImageryCacheKey(t,i,n);let s=this._imageryCache[a];return r.Utils.defined(s)||(s=new r.Layer.Imagery({layer:this,x:t,y:i,level:n}),this._imageryCache[a]=s),s.addReference(),s}destroyAllImagery(){Object.keys(this._imageryCache).forEach((e=>{let t=this._imageryCache[e];t.isDestroyed()||t.destroy(),delete this._imageryCache[e]}))}removeImagery(t){if(!this._imageryCache)return;const i=e.getImageryCacheKey(t.x,t.y,t.level);delete this._imageryCache[i]}}r.Layer.ImageryLayer=e}(),r.Layer.ImageryLayerCollection=class{constructor(){this._layers=[],this.layerAdded=new r.Event,this.layerRemoved=new r.Event,this.layerMoved=new r.Event,this.layerShownOrHidden=new r.Event,this._destroyed=!1}destroy(){this._destroyed=!0,this.removeAll(!0),this._layers=void 0,this.layerAdded=void 0,this.layerRemoved=void 0,this.layerShownOrHidden=void 0}isDestroyed(){return this.destroyed}get length(){return this._layers.length}add(e,t){void 0===t?(t=this._layers.length,this._layers.push(e)):this._layers.splice(t,0,e),this.update(),this.layerAdded.fireEvent(e,t)}addImageryLayer(e,t){const i=new r.Layer.ImageryLayer({imageryProvider:e});return this.add(i,t),i}traverse(e,t){const i=t?Array.from(this._layers):this._layers;t&&i.sort(((e,t)=>e.sequence-t.sequence)),i.forEach((t=>e(t)))}remove(e,t){t=r.Utils.defaultValue(t,!0);const i=this._layers.indexOf(e);return-1!==i&&(this._layers.splice(i,1),this.update(),this.layerRemoved.fireEvent(e,i),t&&e.destroy(),!0)}removeAll(e){e=r.Utils.defaultValue(e,!0),this._layers.forEach(((t,i)=>{this.layerRemoved.fireEvent(t,i),e&&t.destroy()})),this._layers=[]}contains(e){return-1!==this._layers.indexOf(e)}get(e){return this._layers[e]}getByFilter(e){const t=[];return this._layers.forEach((i=>{e&&!e(i)||t.push(i)})),t}update(){const e=this._layers;let t,i=!0;e.forEach(((e,n)=>{e.layerIndex=n,e.show?(e.baseLayer=i,i=!1):e.baseLayer=!1,e.show!==e.lastShow&&(r.Utils.defined(e.lastShow)&&(r.Utils.defined(t)||(t=[]),t.push(e)),e.lastShow=e.show)})),r.Utils.defined(t)&&t.forEach((e=>{this.layerShownOrHidden.fireEvent(e,e.layerIndex,e.show)}))}getLayerIndex(e){return this._layers.indexOf(e)}moveToTop(e){const t=this._layers,i=this.getLayerIndex(e);i!==t.length-1&&(t.splice(i,1),t.push(e),this.update(),this.layerMoved.fireEvent(e,t.length-1,i))}moveToBottom(e){const t=this._layers,i=this.getLayerIndex(e);0!==i&&(t.splice(i,1),t.splice(0,0,e),this.update(),this.layerMoved.fireEvent(e,0,i))}moveToIdx(e,t){const i=this._layers,r=this.getLayerIndex(e);r!==t&&(t<0||t>i.length-1||(i.splice(r,1),i.splice(t,0,e),this.update(),this.layerMoved.fireEvent(e,t,r)))}},function(){class e{constructor(e){e=r.Utils.defaultValue(e,{}),this._option=e,this.mapUrl=e.mapUrl,this.id=e.layerId||r.Utils.getEncodedString(this.mapUrl),this.useClipping=e.useClipping,this._destroyed=!1,this._textureLoader=new THREE.TextureLoader,this._textureLoader.crossOrigin=!0,this.ready=!0,this._readyPromise=void 0,this.maxLimitedLevel=void 0}get readyPromise(){return this._readyPromise}destroy(){this._destroyed=!0,this._textureLoader=void 0,this._readyPromise=void 0}isDestroyed(){return this._destroyed}isAvailableTile(e,t,i){return void 0===this.maxLimitedLevel||i<=this.maxLimitedLevel}getImageryUrl(t,i,r){return e.getRequestMapUrl(this.mapUrl,t,i,r)}getTileMaterial(e){if(!e.texture)return;e.texture.encoding=THREE.GammaEncoding;const t=new r.MapTileMaterial({map:e.texture,transparent:!e.imageryLayer.baseLayer,side:THREE.FrontSide});t._originalTransparent=t.transparent;const i=r.MaterialUtil.getImageByteSize(e.texture.image);return t._imageByteSize+=i,this.useClipping&&(t.defines.USE_CLIPPING=""),t}loadArrayBufferImmediately(e,t,i){if(!this.isDestroyed())if(r.EnableStorage)r.storageManager.getTexture(e).then((e=>t(e))).catch((n=>{if(this.isDestroyed())return;this._textureLoader.load(e,(function(i){t(i),r.storageManager.addTexture(i,e).catch((e=>{}))}),void 0,(function(e){i(e)}))}));else{this._textureLoader.load(e,(function(e){t(e)}),void 0,(function(e){i(e)}))}}cloneParameters(){return Object.assign(this._option)}setReadyCallback(e){}getQuadX(e,t){return e}getQuadY(e,t){return e}static getRequestMapUrl(e,t,i,r){var n={"{x}":t.toString(),"{y}":i.toString(),"{z}":r.toString()},a=new RegExp(Object.keys(n).join("|"),"gi");return e=e.replace(a,(function(e){return n[e]}))}}r.Layer.ImageryProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){return r.Layer.ImageryProvider.getRequestMapUrl(this.mapUrl,e,t,i)}}r.Layer.UrlTemplateImageryProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const n=i%8;var a={"{x}":t.toString(),"{y}":e.toString(),"{z}":i.toString()},s=new RegExp(Object.keys(a).join("|"),"gi");if(r=r.replace(s,(function(e){return a[e]})),r.indexOf("tianditu.gov.cn")>=0){let e=/http[s]?(:\/\/t[1]?[0-9].)/.exec(r);if(e){let t=e[1];r=r.replace(t,`://t${n}.`)}}return r}}r.Layer.WebMapTileServiceTDUImageryProvider=e}(),function(){let e=new THREE.Vector2,t=new THREE.Vector2,i=new THREE.Box2;class n extends r.Layer.ImageryProvider{constructor(e){super(e),this._jsonLoader=new THREE.FileLoader,this._jsonLoader.setResponseType("json"),this._imagePostfix=void 0,this._urlTemplate=void 0,this.ready=!1,this._availableTilesChecked=!1,this._readyCallback=null,this.checkIfReady()}destroy(){this._jsonLoader=void 0,this._readyCallback=null,super.destroy()}setReadyCallback(e){this._readyCallback=e}checkIfReady(){this._readyPromise=this._fetchMetadata().then((()=>{this.ready=!0,this._readyCallback&&this._readyCallback()})).catch((()=>{this.ready=!1}))}_fetchMetadata(){const e=this._textureLoader,t=this._jsonLoader,i=this.mapUrl,r=[],n=new Promise(((e,r)=>{const n=`${i}/meta.json`;t.load(n,(t=>{this._parseMetaConfig(t),e()}),void 0,(()=>{r()}))})),a=new Promise(((e,r)=>{const n=`${i}/layer.json`;t.load(n,(t=>{this._parseLayerConfig(t),e()}),void 0,(()=>{r()}))}));return r.push(n),r.push(a),new Promise(((t,i)=>{Promise.all(r).then((()=>{const r=this.getImageryUrl(0,0,0);r?e.load(r,(function(){t()}),void 0,(function(){i()})):i()})).catch((e=>{console.log(e)}))}))}_parseMetaConfig(e){const t=e.contentType?e.contentType.split("/")[1]:void 0;this._imagePostfix=r.Utils.defaultValue(t,"png"),this._bounds=e.bounds,this._maxzoom=e.maxzoom,this._minzoom=e.minzoom}_parseLayerConfig(i){this._projection=i.projection,this._scheme=i.scheme;const n=i.tiles?i.tiles[0].split(".")[0]:void 0;if(this._urlTemplate=r.Utils.defaultValue(n,"{z}/{x}/{y}"),this._availableTiles=i.available,this._availableTiles&&this._availableTiles.length){this._availableTileBounds=new THREE.Box2;const i=this._availableTileBounds;this._availableTiles.forEach((r=>{r.forEach((r=>{i.expandByPoint(e.set(r.startX,r.startY)),i.expandByPoint(t.set(r.endX,r.endY))}))}))}}isAvailableTile(n,a,s){if(void 0!==this.maxLimitedLevel&&s>this.maxLimitedLevel)return!1;if(this._maxzoom&&(s<this._minzoom||s>this._maxzoom))return!1;const o=this._bounds;if(o){const e=r.Tile.TileMath.long2tile(o.west,s),t=r.Tile.TileMath.long2tile(o.east,s),i=r.Tile.TileMath.lat2tile(o.south,s),l=r.Tile.TileMath.lat2tile(o.north,s),d=Math.min(i,l),h=Math.max(i,l);if(n<e||n>t||a<d||a>h)return!1}if(this._availableTilesChecked){const r=this._availableTileBounds;if(r&&!r.containsPoint({x:n,y:a}))return!1;const s=this._availableTiles;if(s){return s.some((r=>r.some((r=>(i.makeEmpty(),i.expandByPoint(e.set(r.startX,r.startY)),i.expandByPoint(t.set(r.endX,r.endY)),i.containsPoint({x:n,y:a}))))))}}return!0}getImageryUrl(e,t,i){if(!this._imagePostfix||!this._urlTemplate)return;let n=`${this.mapUrl}/${this._urlTemplate}.${this._imagePostfix}`;return r.Layer.ImageryProvider.getRequestMapUrl(n,e,t,i)}}r.Layer.SpecificMapServiceImageryProvider=n}(),r.Layer.ImageryProviderFactory={UrlTemplate:function(e){return new r.Layer.UrlTemplateImageryProvider(e)},WebMapTileServiceTDU:function(e){return new r.Layer.WebMapTileServiceTDUImageryProvider(e)},SpecificMapService:function(e){return new r.Layer.SpecificMapServiceImageryProvider(e)},TileMapBingMapService:function(e){return new r.Layer.TileMapBingMapServiceProvider(e)},TileMapTencentMapService:function(e){return new r.Layer.TileMapTencentMapServiceProvider(e)},TileMapService:function(e){return new r.Layer.TileMapServiceProvider(e)},WebMapService:function(e){return new r.Layer.WebMapServiceProvider(e)},WebMapTileService:function(e){return new r.Layer.WebMapTileServiceTDUImageryProvider(e)},BdMapService:function(e){return new r.Layer.BdImageryProvider(e)}},function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const n=i%8;let a="";for(let r=i;r>0;r--){let i=0,n=1<<r-1;0!=(e&n)&&i++,0!=(t&n)&&(i++,i++),a+=i.toString()}""===a&&(a="0");var s={"{x}":a},o=new RegExp(Object.keys(s).join("|"),"gi");r=r.replace(o,(function(e){return s[e]}));let l=/http[s]?(:\/\/ecn.t[1]?[0-9].)/.exec(r);if(l){let e=l[1];r=r.replace(e,`://t${n}.`)}return r}}r.Layer.TileMapBingMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const n=i%4,a=(1<<i)-t-1;var s={"{x}":e,"{y}":a,"{sx}":e>>4,"{sy}":a>>4,"{z}":i},o=new RegExp(Object.keys(s).join("|"),"gi");r=r.replace(o,(function(e){return s[e]}));let l=/http[s]?(:\/\/p[1]?[0-9].)/.exec(r);if(l){let e=l[1];r=r.replace(e,`://p${n}.`)}return r}}r.Layer.TileMapTencentMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){const n=(1<<i)-t-1;return r.Layer.ImageryProvider.getRequestMapUrl(this.mapUrl,e,n,i)}getQuadY(e,t){return(1<<t)-e-1}}r.Layer.TileMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){const n=r.Tile.TileMath.tile2boundingBox(e,t,i);return this.mapUrl+`&bbox=${n.west}%2C${n.south}%2C${n.east}%2C${n.north}`}}r.Layer.WebMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const n=1<<i,a=1<<i,s=i+1,o=(e+t)%4;if(r.indexOf("bdimg.com")>=0){let e=/http[s]?(:\/\/maponline[1]?[0-9].)/.exec(r);if(e){let t=e[1];r=r.replace(t,`://maponline${o}.`)}}return r=r.replace("{x}",e-n/2).replace("{y}",a/2-t-1).replace("{z}",s),r}}r.Layer.BdImageryProvider=e}(),r.Layer.Terrain=class{constructor(e){e=e||{},this.state=r.Layer.TerrainState.UNLOADED,this.terrainData=void 0,this.request=void 0,this._retryTimes=r.Utils.defaultValue(e.retryTimes,2),this._retryCount=0}destroy(){this.terrainData=void 0,this.request&&(this.request.destroy(),this.request=void 0)}unload(){this.state=r.Layer.TerrainState.UNLOADED,this.terrainData=void 0,this.request&&(this.request.destroy(),this.request=void 0)}retryOnError(){return!(this._retryCount>=this._retryTimes||(++this._retryCount,0))}get contentUnloaded(){return this.state===r.Layer.TerrainState.UNLOADED}get contentFailed(){return this.state===r.Layer.TerrainState.FAILED}get contentReady(){return this.state===r.Layer.TerrainState.READY}},r.Layer.TerrainProvider=class{constructor(e){this._levelZeroXTilesNumber=r.Utils.defaultValue(e.levelZeroXTilesNumber,1),this._levelZeroYTilesNumber=r.Utils.defaultValue(e.levelZeroYTilesNumber,1);const t=e.terrainMetadata;this.updateTerrainMetadata(t),this.terrainDataUrl=e.terrainPath?new r.Tile.DemUrl(e.terrainPath):void 0,this.useTerrain=!!this.terrainDataUrl&&r.Utils.defaultValue(e.useTerrain,!1),this.tileGeometrySegments=r.Utils.defaultValue(e.tileGeometrySegments,16),this.maxLimitedLevel=r.Utils.defaultValue(e.maxLevel,18),this._heightmapQuality=.25,this._maximumRadius=6378137,this._unitScale=r.Utils.defaultValue(e.unitScale,1),this._levelZeroMaxGeometricError=this._unitScale*this.getLevelZeroGeometricError(64,this.getXTilesNumber(0)),this.mercatorPerimeter=this._unitScale*r.Utils.defaultValue(e.mercatorPerimeter,2*r.Tile.TileMath.mercatorPerimeter),this.tileBuilder=new r.Tile.PlaneTileBuilder,this.defaultTileGeometry=new THREE.PlaneBufferGeometry(1,1,this.tileGeometrySegments),this.defaultTileGeometry._onlyShared=!0,this.ready=!1,this.getTerrainMetadata(),this.terrainLoader=new THREE.FileLoader,this.terrainLoader.setResponseType("arraybuffer"),this.terrainLoader.crossOrigin=!0,this.terrainSeamThreshold=.5*this._unitScale,this.planeSeamThreshold=1*this._unitScale}destroy(){this.tileBuilder.destroy(),this.tileBuilder=void 0,this.defaultTileGeometry.dispose(),this.defaultTileGeometry=void 0,this.terrainLoader=void 0}setSource(e,t){return this.terrainDataUrl.terrainPath=e.url,this.getTerrainMetadata(t)}getSource(){return this.terrainDataUrl.terrainPath}getXTilesNumber(e){return this._levelZeroXTilesNumber<<e}getYTilesNumber(e){return this._levelZeroYTilesNumber<<e}getLevelZeroGeometricError(e,t){return 2*this._maximumRadius*Math.PI*this._heightmapQuality/(e*t)}getLevelMaxGeometricError(e){return this._levelZeroMaxGeometricError/(1<<e)}createTerrain(e,t,i,n){return new r.Layer.Terrain({})}updateTerrainMetadata(e){this.terrainBoundary=e.boundary,this._minTerrainLevel=e.minLevel,this._maxTerrainLevel=e.maxLevel}getTerrainMetadata(e){if(!1===this.useTerrain)return void(this.ready=!0);const t=this.terrainDataUrl.terrainPath,i=t.indexOf("{z}"),r=`${t.slice(0,i)}layer.json.gz`;let n=new THREE.FileLoader;return n.setResponseType("json"),new Promise(((t,i)=>{n.load(r,(i=>{this.terrainMetadata=i,this.updateTerrainMetadata(this.terrainMetadata),this.ready=!0,e&&e(),t()}),void 0,(()=>{this.ready=!0,e&&e(),i()}))}))}isAvailableTile(e,t,i){if(!this.useTerrain)return!0;if(i<this._minTerrainLevel)return!1;let r=this.terrainBoundary[i];if(!r){const e=this.terrainBoundary[this._maxTerrainLevel],t=1<<i-this._maxTerrainLevel,n=e.leftX*t+0,a=e.upY*t+0,s=e.rightX*t+1,o=e.bottomY*t+1;this.terrainBoundary[i]={},this.terrainBoundary[i].leftX=n,this.terrainBoundary[i].upY=a,this.terrainBoundary[i].rightX=s,this.terrainBoundary[i].bottomY=o,r=this.terrainBoundary[i]}return e>=r.leftX&&e<=r.rightX&&t>=r.upY&&t<=r.bottomY}getAvailableTile(e,t,i,r){if(0===i)return;const n=(i/r|0)*r,a=1<<i-n;return{level:n,x:e/a|0,y:t/a|0}}getTileAvailable(e,t,i){}getTileBoundingBox(e,t,i){const r=this.mercatorPerimeter/Math.pow(2,i),n=-.5*this.mercatorPerimeter+e*r,a=n+r,s=.5*this.mercatorPerimeter-t*r,o=s-r;return new THREE.Box3(new THREE.Vector3(n,o,-1),new THREE.Vector3(a,s,1))}isOverMaxLevel(e){return!!this.useTerrain&&e>this._maxTerrainLevel}getLevelXYOfDataSource(e,t,i){const r=this._maxTerrainLevel;if(i>r)return this.getParentLevelXY(e,t,i,r)}getParentLevelXY(e,t,i,r){const n=1<<i-r;return{x:e/n|0,y:t/n|0,level:r,divisor:n,xIndex:e%n,yIndex:t%n}}getTerrainUrlWithoutOpenTerrain(e,t,i){return this.terrainDataUrl.terrainUrl(i,e,t)}getTerrainUrl(e,t,i){if(this.useTerrain)return this.terrainDataUrl.terrainUrl(i,e,t)}getTileGeometry(e){if(!this.useTerrain)return e.updateTerrainHeight(1,-1),{geometry:this.defaultTileGeometry,matrix:this._getTileTransformMatrix(e,!0)};const{x:t,y:i,level:r}=e,n=e.tileTerrain.terrainData,a=this.getTileGeometryByData(n,t,i,r,!1),s=a.geometry;return s.computeBoundingBox(),e.updateTerrainHeight(s.boundingBox.max.z,s.boundingBox.min.z),a}getTileGeometryByData(e,t,i,r,n){const a=this.tileGeometrySegments,s=this.mercatorPerimeter/Math.pow(2,r)+this.terrainSeamThreshold,o=this.tileBuilder.computePlaneGeometry(s,s,a,e,n,this._unitScale);return{geometry:o[0],skirtGeometry:o[1],matrix:this._getTileTransformMatrix({x:t,y:i,level:r},!1)}}updateTileGeometryForFlatten(e,t,i,r,n,a){if(!this.useTerrain)return;const s=this.tileGeometrySegments,o=e.tileTerrain.terrainData,l=this.mercatorPerimeter/Math.pow(2,e.level)+this.terrainSeamThreshold;this.tileBuilder.updateGeometryForFlatten(l,l,s,o,!1,this._unitScale,t,i,r,n,a)}getTerrainDataArray(e){const t=this.tileGeometrySegments,i=Array.prototype.slice.call(new Int16Array(e));let n=new Array(t+1);for(let e=0,a=n.length;e<a;e++){n[e]=new Array(t+1);for(let a=0,s=t+1;a<s;a++)i[e*(t+1)+a]!==r.Tile.DemTilesUtil.InvalidTerrainValue?n[e][a]=i[e*(t+1)+a]:n[e][a]=0}return n}getTerrainDataArrayOutOfLevel(e){if(e.parent&&e.parent.tileTerrain.terrainData)return this.getTerrainDataArrayFromParent(e)}getTerrainDataArrayWithTerrainLevel(e,t,i,n,a){const s=this.tileGeometrySegments,{divisor:o,xIndex:l,yIndex:d}=this.getParentLevelXY(e,t,i,n),h=s/o,c=l*h,u=d*h;let p=new Array(h+1);for(let e=0,t=p.length;e<t;e++){p[e]=new Array(h+1);for(let t=0;t<=h;++t)p[e][t]=a[u+e][c+t]}return r.Tile.TileMath.createHeightArray(p,s)}getTerrainDataArrayFromParent(e){const t=e._parent.tileTerrain.terrainData,i=this.tileGeometrySegments,{divisor:n,xIndex:a,yIndex:s}=this.getParentLevelXY(e.x,e.y,e.level,e._parent.level),o=i/n,l=a*o,d=s*o;let h=new Array(o+1);for(let e=0,i=h.length;e<i;e++){h[e]=new Array(o+1);for(let i=0;i<=o;++i)h[e][i]=t[d+e][l+i]}return r.Tile.TileMath.createHeightArray(h,i)}_getTileTransformMatrix(e,t){const{x:i,y:r,level:n}=e,a=n>0?Math.pow(2,n)/2:0,s=this.mercatorPerimeter/Math.pow(2,n),o=s+this.planeSeamThreshold,l=t?(new THREE.Matrix4).makeScale(o,o,1):new THREE.Matrix4,d=i*s+.5*s-a*s,h=-(r*s+.5*s-a*s),c=(new THREE.Matrix4).makeTranslation(d,h,0),u=new THREE.Matrix4;return u.premultiply(l).premultiply(c),u}loadArrayBufferImmediately(e,t,i){this.terrainLoader.load(e,(function(e){t(e)}),void 0,(function(e){i(e)}))}getMaxMinTerrainLevel(){return{maxLevel:this._maxTerrainLevel,minLevel:this._minTerrainLevel}}setMercatorPerimeter(e){this.mercatorPerimeter=this._unitScale*e}},function(){let e=new THREE.Box3,t=new THREE.Matrix4;r.Layer.GlobeTileProvider=class{constructor(e){if(this.imageryLayers=new r.Layer.ImageryLayerCollection,this.terrainProvider=new r.Layer.TerrainProvider(e.loadConfig),this.terrainOperationManager=e.terrainOperationManager,this.globeLayer=e.globeLayer,this.mapExcavation=e.loadConfig.mapExcavation||{},this.mapStyle={},this.presetOpacity=1,this.tileOpacity={},this.tileVisible={},this.show=!0,this.skirtShow=!0,this._layerOrderChanged=!1,this._materialCache={},this._skirtMeshCache={},this._isGlobeLayerTransparent=!1,!1!==e.loadConfig.useDefaultImagery&&e.loadConfig.mapUrl){this.baseLayerId=this.addImageryLayer({imageryProviderType:e.loadConfig.imageryProviderType,useClipping:e.loadConfig.sectionable,mapLayer:e.loadConfig.mapLayer,mapUrl:e.loadConfig.mapUrl});const t=e.loadConfig.opacity||1;this.tileOpacity[this.baseLayerId]=t,this.tileVisible[this.baseLayerId]=!0,this.mapStyle[this.baseLayerId]=e.loadConfig.mapStyle||{}}}destroy(){this.terrainProvider.destroy(),this.terrainProvider=void 0,this.imageryLayers.destroy(),this.ImageryLayers=void 0,this._materialCache=void 0,this._skirtMeshCache=void 0,this.terrainOperationManager=void 0,this.baseLayerId=void 0,this.presetOpacity=void 0}static getTileCacheKey(e,t,i){return`${e}-${t}-${i}`}get isGlobeLayerTransparent(){return this._isGlobeLayerTransparent}setPresetOpacity(e){this.presetOpacity=e}getPresetOpacity(){return this.presetOpacity}get ready(){return this.terrainProvider.ready&&this.imageryLayers.length&&this.imageryLayers.get(0).imageryProvider.ready}canRefine(e){return!!e.terrainData||void 0!==this.terrainProvider.getTileDataAvailable(2*e.x,2*e.y,e.level+1)}_onLayerAdded(e,t){this._layerOrderChanged=!0}_onLayerRemoved(e,t){this._layerOrderChanged=!0}_onLayerMoved(e,t,i){this._layerOrderChanged=!0}parseTileContent(e,t){e.isDestroyed()||(this._createTileMesh(e),t(e))}_createTileMesh(e){const t=e.content.meshes,i=this.terrainProvider.getTileGeometry(e),n=r.EnumLayerBaseRenderOrder.MAP;e.imageries.forEach(((a,s)=>{const o=a.imageryLayer.imageryProvider,l=o.id,d=o.getTileMaterial(a);if(!d)return;d.name=e.name,this.updateTileMaterial(d,l);const h=n+s;let c=new r.MeshEx(i.geometry,d);if(c.name=e.name,c.renderOrder=h,c.layerId=l,i.matrix&&c.matrix.copy(i.matrix),r.GlobalData.EnableShadowMap&&(c.castShadow=this.globeLayer.castShadow,c.receiveShadow=this.globeLayer.receiveShadow),t.add(c),this.updateTileMesh(c,l),i.skirtGeometry){let n=new r.MeshEx(i.skirtGeometry,d);n.name=`Skirt-${e.name}`,n.renderOrder=h,n.layerId=l,i.matrix&&n.matrix.copy(i.matrix),r.GlobalData.EnableShadowMap&&(n.castShadow=this.globeLayer.castShadow,n.receiveShadow=this.globeLayer.receiveShadow),t.add(n),this.updateSkirtVisible(n,l),this._cacheSkirtMesh(l,n)}this._cacheMaterial(l,d)})),this.updateTileMeshForFlatten(e)}setBaseLayerId(e){this.baseLayerId=e}getBaseLayerId(){return this.baseLayerId}getAllLayerIds(){const e=this.imageryLayers.getByFilter();let t=[];for(const i of e)t.push(i.imageryProvider.id);return t}updateTileMeshForFlatten(i){if(i.content){var n=i.content.meshes;if(n&&n.children.length>=2){var a=n.children[0],s=n.children[1],o=this.terrainOperationManager,l=i._tileset._objectGroup.matrix,d=!1;if(i.boundingBox&&(e.copy(i.boundingBox),e.applyMatrix4(l),e.min.y=0,e.max.y=0,d=o.isIntersectFlattenBboxDrawing(e,r.ObjectGroupType.TILEGROUP)),!d&&i.isFlattened)return this.terrainProvider.updateTileGeometryForFlatten(i,o,t,a.geometry,s.geometry,!0),void(i.isFlattened=!1);if(d){var h=a.matrix;t.multiplyMatrices(l,h),this.terrainProvider.updateTileGeometryForFlatten(i,o,t,a.geometry,s.geometry,!1),i.isFlattened=!0}}}}clearMaterialAndSkirtCache(){for(let e in this._materialCache)delete this._materialCache[e];for(let e in this._skirtMeshCache)delete this._skirtMeshCache[e]}removeFromMaterialAndSkirtCache(e){this._materialCache[e]&&delete this._materialCache[e],this._skirtMeshCache[e]&&delete this._skirtMeshCache[e]}_removeCachedMaterialsAndSkirtsByTile(e){const t=`Skirt-${e.name}`,i=e.name;e.imageries.forEach((e=>{const r=e.imageryLayer;if(!r||r.isDestroyed())return;const n=e.imageryLayer.imageryProvider.id;this._removeFromMaterialCache(n,i),this._removeFromSkirtMeshCache(n,t)}))}_cacheMaterial(e,t){this._materialCache[e]||(this._materialCache[e]={}),this._materialCache[e][t.name]=t}_removeFromMaterialCache(e,t){const i=this._materialCache[e];i&&i[t]&&delete i[t]}_traverseCachedMaterialsById(e,t){const i=this._materialCache[e];if(!i)return;Object.keys(i).forEach((e=>{const r=i[e];t(r)}))}_traverseCachedMaterials(e,t){for(const i in this._materialCache)t&&t(i)||this._traverseCachedMaterialsById(i,e)}_cacheSkirtMesh(e,t){this._skirtMeshCache[e]||(this._skirtMeshCache[e]={}),this._skirtMeshCache[e][t.name]=t}_removeFromSkirtMeshCache(e,t){const i=this._skirtMeshCache[e];i&&i[t]&&delete i[t]}_traverseCachedSkirtMeshes(e,t){for(const i in this._skirtMeshCache)t&&t(i)||this._traverseCachedSkirtMeshesById(i,e)}_traverseCachedSkirtMeshesById(e,t){const i=this._skirtMeshCache[e];if(!i)return;Object.keys(i).forEach((e=>{const r=i[e];t(r)}))}setOpacity(e,t){this.tileOpacity[t]=e;const i=r.Tile.DemTilesUtil.isTransparent(e);this._traverseCachedMaterialsById(t,(e=>{this.updateTileMaterialOpacity(e,t)})),this._isGlobeLayerTransparent=!1,i||!0!==this.tileVisible[t]?(this._isGlobeLayerTransparent=!0,this.hideSkirt()):this.showSkirt()}getOpacity(e){return this.tileOpacity[e]}setImageryLayerVisible(e,t){this.tileVisible[e]=t,this.globeLayer.setImageryLayerVisible(e,t)}hasImageryLayerVisible(){return Object.keys(this.tileVisible).some((e=>!0===this.tileVisible[e]))}setStyle(e,t){this.mapStyle[t]=e,this._traverseCachedMaterialsById(t,(e=>{this.updateTileMaterialStyle(e,t)}))}setExcavation(e){this.mapExcavation=e,this._traverseCachedMaterials((e=>{this.updateTileMaterialExcavation(e),this.updateTileMaterialSide(e)}),(t=>e.cullImageLayerIds&&!e.cullImageLayerIds.includes(t)))}setPolygonClimpGroundInfo(e){this._traverseCachedMaterials((t=>{this.updateTileMaterialAboutPolygonInfo(t,e)}))}updateTileMaterialAboutPolygonInfo(e,t){e.updatePolygonClimpGroundInfo(t)}closePolygonClimpGround(){this._traverseCachedMaterials((e=>{this.updateTileMaterials(e)}))}updateTileMaterials(e){e.closePolygonClimpGround()}updateMaterialsSide(){const e=this.getBaseLayerId();this._traverseCachedMaterialsById(e,(e=>{this.updateTileMaterialSide(e)}))}updateTileMaterialStyle(e,t){e.updateStyle&&this.mapStyle[t]&&e.updateStyle(this.mapStyle[t])}updateTileMaterialExcavation(e){e.updateExcavation&&e.updateExcavation(this.mapExcavation)}updateTileMaterialSide(e){e.updateSide&&e.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation})}updateTileMaterial(e,t){this.updateTileMaterialStyle(e,t),this.updateTileMaterialOpacity(e,t)}updateTileMesh(e,t){const i=this.tileVisible[t];e.visible=i}updateTileMaterialOpacity(e,t){const i=this.tileOpacity[t];e.opacity=i,e._originalTransparent||(e.transparent=r.Tile.DemTilesUtil.isTransparent(i))}updateMaterialsValue(e,t,i,r){this._traverseCachedMaterials((e=>{if(e&&e.hasOwnProperty(t)){if(r&&0==e.receiveIBL)return;e[t]=i,void 0!==e.refreshUniforms&&e.refreshUniforms(),e.needsUpdate=!0}}))}hideSkirt(){this.skirtShow=!1,this._traverseCachedSkirtMeshes((e=>{e.visible=!1}))}showSkirt(){this.skirtShow=!0,this._traverseCachedSkirtMeshes((e=>{e.visible=!0}))}updateSkirtVisible(e,t){if(this.tileVisible[t]){r.Tile.DemTilesUtil.isTransparent(this.tileOpacity[t])&&this.skirtShow&&(this.skirtShow=!1),e.visible=this.skirtShow}else e.visible=!1}getMaxLimitedLevel(){return this.terrainProvider.maxLimitedLevel}setMaxLimitedLevel(e){this.terrainProvider.maxLimitedLevel=e}isUseTerrain(){return this.terrainProvider.useTerrain}setTerrainEnabled(e){return this.terrainProvider.terrainDataUrl?this.terrainProvider.useTerrain!==e&&(this.terrainProvider.useTerrain=e,!0):(console.log("No terrain data is set, cannot switch terrain!"),!1)}setTerrainProvider(e,t){return this.terrainProvider.setSource(e,t)}getTerrainUrl(){return this.terrainProvider.getSource()}getMaxImageryLevel(e){const t=this.getImageryLayerById(e);return t?t.imageryProvider.maxLimitedLevel:this.terrainProvider.maxLimitedLevel}setMaxImageryLevel(e,t){const i=this.getImageryLayerById(e);i&&(i.imageryProvider.maxLimitedLevel=t)}createDefaultImageryProvider(e){return void 0===e.imageryProviderType&&(e.imageryProviderType="UrlTemplate"),new r.Layer.ImageryProviderFactory[e.imageryProviderType](e)}getBaseImageryLayer(){const e=this.imageryLayers.getByFilter();return e.length>0?e[0]:void 0}getImageryLayerById(e){const t=this.imageryLayers.getByFilter((t=>t.imageryProvider.id===e));return t.length>0?t[0]:void 0}getImageryLayerByMapUrl(e){const t=this.imageryLayers.getByFilter((t=>t.imageryProvider.mapUrl===e));return t.length>0?t[0]:void 0}addImageryLayer(e,t){const i=this.imageryLayers.addImageryLayer(this.createDefaultImageryProvider(e),t).imageryProvider.id;return this.tileOpacity[i]=e.opacity||this.presetOpacity,this.tileVisible[i]=r.Utils.defaultValue(e.visible,!0),i}removeImageryLayer(e){delete this.tileOpacity[e],delete this.tileVisible[e],this.removeFromMaterialAndSkirtCache(e);const t=this.getImageryLayerById(e);t&&this.imageryLayers.remove(t)}adjustImageryLayer(e,t){const i=this.getImageryLayerById(e);i&&this.imageryLayers.moveToIdx(i,t)}getImageryLayerIndex(e){const t=this.getImageryLayerById(e);return t?this.imageryLayers.getLayerIndex(t):-1}}}(),function(){class e{static makeRequest(e,t){e.requestCallback=function(){const i=new r.Deferred;return t(e.url,(function(e){i.resolve(e)}),(function(e){i.reject(e)})),e.cancelCallback=function(){},i.promise};const i=r.GlobeTileRequestScheduler.request(e);if(i)return i.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}static processTerrain(e,t){}static requestTerrain(t){const i=t.tileTerrain;if(!i.contentUnloaded)return;const n=r.Layer.TerrainState,a=t._tileset.tileProvider.terrainProvider,s=a.getTerrainUrl(t.x,t.y,t.level);function o(e){i.terrainData=e,i.state=n.READY,i.request=void 0}function l(){i.state=n.FAILED,i.request=void 0}if(a.isAvailableTile(t.x,t.y,t.level))if(s)if(a.isOverMaxLevel(t.level)){const e=a.getTerrainDataArrayOutOfLevel(t);e&&o(e)}else!function(){const a=new r.Request({url:s,type:r.RequestType.TERRAIN,priorityCallback:t._createPriorityCallback(t)});i.request=a,i.state=n.RECEIVING;const h=e.makeRequest(a,d);if(!h)return i.state=n.UNLOADED,void(i.request=void 0);h.then((function(e){t.isDestroyed()?l():o(e)})).catch((function(e){!function(){if(i.request&&i.request.state===r.RequestState.CANCELLED)return i.terrainData=void 0,i.state=n.UNLOADED,void(i.request=void 0);if(i.retryOnError())i.terrainData=void 0,i.state=n.UNLOADED,i.request=void 0;else{i.state=n.FAILED,i.request=void 0;const e=`Failed to obtain terrain tile X: ${t.x} Y: ${t.y} Level: ${t.level}.`;console.log(e)}}()}))}();else o();else l();function d(e,i,r){a.loadArrayBufferImmediately(e,(function(e){i(a.getTerrainDataArray(e))}),(function(){const e=a.getTerrainDataArrayOutOfLevel(t);e?i(e):r()}))}}static requestImageries(t){const i=t._tileset.tileProvider.imageryLayers._layers;t.imageries.length=0,i.forEach((i=>{const r=i.getImagery(t.x,t.y,t.level);t.imageries.push(r),e.requestImagery(t,r)}))}static requestImagery(t,i){const n=i.imageryLayer.imageryProvider;if(!i.contentUnloaded||!n.ready||!n.mapUrl)return;const a=r.Layer.ImageryState;function s(){i.state=a.FAILED,i.request=void 0}if(!n.isAvailableTile(t.x,t.y,t.level))return void s();const o=n.getImageryUrl(t.x,t.y,t.level);function l(e,t,i){n.loadArrayBufferImmediately(e,t,i)}!function(){const n=new r.Request({url:o,type:r.RequestType.IMAGERY,priorityCallback:t._createPriorityCallback(t)});i.request=n,i.state=a.TRANSITIONING;const d=e.makeRequest(n,l);if(!d)return i.state=a.UNLOADED,void(i.request=void 0);d.then((function(e){var r;t.isDestroyed()?s():(r=e,i.texture=r,i.state=a.READY,i.request=void 0)})).catch((function(e){!function(){if(i.request&&i.request.state===r.RequestState.CANCELLED)return i.state=a.UNLOADED,void(i.request=void 0);if(i.retryOnError())i.state=a.UNLOADED,i.request=void 0;else{i.state=a.FAILED,i.request=void 0;const e=`Failed to obtain image tile X: ${i.x} Y: ${i.y} Level: ${i.level}.`;console.log(e)}}()}))}()}static processImageries(t,i){let r=!1,n=!0;return t.imageries.forEach((a=>{const s=e.processImagery(t,a,i);n=n&&s,r=r||s})),t.renderable=t.renderable&&(r||n),n}static processImagery(t,i,n){const a=r.Layer.ImageryState;return i.state===a.UNLOADED&&(i.state=a.TRANSITIONING,e.requestImagery(t,i)),i.state===a.RECEIVED&&(i.state=a.TRANSITIONING,i.imageryLayer._createTexture(i,n)),i.state===a.TEXTURE_LOADED&&(i.state=a.TRANSITIONING,i.imageryLayer._reprojectTexture(i,n)),i.state===a.READY||(i.state===a.FAILED||i.state===a.INVALID)}}r.Layer.GlobeTileScheduler=e}(),function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._geometryByteLength=0}destroy(){super.destroy()}getTexturesByteLength(){const e=this._meshes.children;for(let t of e)if(t.children&&t.children.length>0)for(let e of t){const t=e.material;t&&t._imageByteSize&&!t._sizeCached&&(this._texturesByteLength+=t._imageByteSize,t._sizeCached=!0)}else if(t.material){const e=t.material;e._imageByteSize&&!e._sizeCached&&(this._texturesByteLength+=e._imageByteSize,e._sizeCached=!0)}}_disposeMesh(e){const t=e.geometry;t._onlyShared||(t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0),this._disposeMaterial(e.material),e.geometry=void 0,e.material=void 0}parseTileContent(e){this._tile._tileset.tileProvider.parseTileContent(this._tile,(function(t){e(t)}))}disposeContentBuffer(){}_disposeMaterial(e){const t=e._imageByteSize;t&&(this._texturesByteLength+=t),r.Utils.isDefined(e.map)&&(e.map.dispose(),e.map=null),e.dispose()}}r.Layer.GlobeTileContent=e}(),function(){new THREE.Box3;class e extends r.AbstractTile{constructor(e,t){super(e,t.parent),this.x=t.x,this.y=t.y,this.level=t.level,this.name=`${this.x}-${this.y}-${this.level}`,this.refineReplace=!0,this.isGlobeTile=!0,this._contentType=r.TileContentType.DATA_MESH,this._contentIndex=this.name,this._debugLodLevel=this._parent?this._parent._debugLodLevel+1:0;const i=e.tileProvider.terrainProvider;this._boundingBox=i.getTileBoundingBox(this.x,this.y,this.level),this.geometricError=i.getLevelMaxGeometricError(this.level),this.invalid=!1,this.tileTerrain=new r.Layer.Terrain,this.renderable=!1,this.terrainMaxHeight=this._boundingBox.max.z,this.terrainMinHeight=this._boundingBox.min.z,this.imageries=[]}destroy(){super.destroy(),this.tileTerrain.destroy(),this.tileTerrain=null,this.imageries=null}get needsLoading(){return!this.isTerrainFailed()&&(!this.isTerrainReady()||this._isAnyImageryNoReady())}get contentDataAvailable(){return!this.contentTypeEmpty&&this.contentReady&&this._isAnyImageryReady()}fetchContentBlock(e,t,i){t()}createContent(e){return new r.Layer.GlobeTileContent(this,e)}isTerrainReady(){return this.tileTerrain.contentReady}isTerrainFailed(){return this.tileTerrain.contentFailed}_isAnyImageryNoReady(){return 0===this.imageries.length||this.imageries.some((e=>!e.contentFailed&&!e.contentReady))}_isAnyImageryReady(){return this.imageries.some((e=>e.contentReady))}_isAllImageryReady(){if(0===this.imageries.length)return!1;let e=!0,t=!1;return this.imageries.forEach((i=>{e=e&&(i.contentReady||i.contentFailed),t=t||i.contentReady})),e&&t}_checkIfTerrainLoadingDone(){return this.renderable=!1,this.tileTerrain.contentFailed?(this._contentType=r.TileContentType.DATA_TILE,this._contentState=r.TileContentState.READY,!1):!!this.tileTerrain.contentReady&&(this.renderable=!0,!0)}_checkIfImageryLoadingDone(){return this._isAllImageryReady()}requestContent(){if(r.Layer.GlobeTileScheduler.requestTerrain(this),!this._checkIfTerrainLoadingDone())return!1;if(r.Layer.GlobeTileScheduler.requestImageries(this),!this._checkIfImageryLoadingDone()||!this.contentUnloaded)return!1;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const e=this._tileset.statistics;e.incrementNumberOfPendingRequests();const t=this._handleFailedContent(this,this._tileset),i=this;return Promise.resolve(this.tileTerrain.terrainData).then((function(r){i.isDestroyed()?t():(e.decrementNumberOfPendingRequests(),i._initialContent(r))})).catch((function(e){i._contentState=r.TileContentState.UNLOADED,t(e)})),!0}updateTerrainHeight(e,t){this.terrainMaxHeight=e,this.terrainMinHeight=t,this._boundingBox.max.z=Math.max(1,this.terrainMaxHeight),this._boundingBox.min.z=Math.min(-1,this.terrainMinHeight)}_removeCachedMaterialsAndSkirts(){const e=this._tileset.tileProvider;e&&e._removeCachedMaterialsAndSkirtsByTile(this)}_unloadContent(){super.unloadContent()}unloadContent(){this._contentType=r.TileContentType.DATA_MESH,this.tileTerrain.unload(),this._unloadImageryContent()}_unloadImageryContent(){this._removeCachedMaterialsAndSkirts(),this.imageries.forEach((e=>{e.isDestroyed()||e.destroy()})),this.imageries.length=0,this._unloadContent()}resetImageryContent(){this._unloadImageryContent()}resetTerrainContent(){this._contentType=r.TileContentType.DATA_MESH,this.tileTerrain.unload(),this._unloadContent()}resetBoundingBox(){const e=this._tileset.tileProvider.terrainProvider;this._boundingBox=e.getTileBoundingBox(this.x,this.y,this.level),this.terrainMaxHeight=this._boundingBox.max.z,this.terrainMinHeight=this._boundingBox.min.z}computeDistanceToCamera(e){const t=this._transformedBoundingBox;this._distance=t.distanceToPoint(e.cameraPositionWc)}culling(e,t){return(e.globalMatrixUpdated||t||e.useTerrain)&&(this._globaledBoundingBox.copy(this._transformedBoundingBox),e.useTerrain&&(this._globaledBoundingBox.max.z=Math.max(this._globaledBoundingBox.max.z,e.cameraPositionWc.z))),!!e.frustumWc.intersectsBox(this._globaledBoundingBox)}computePriority(){const e=this._tileset,t=e._priorityRange.max,i=e._priorityRange.min,n=r.Math.isolateDigits(r.Math.normalize(e.type,0,10),1,16),a=r.Math.isolateDigits(r.Math.normalize(e.sequence,0,100),1,14),s=e._skipLodEnabled?t.depth-this._depth:this._depth,o=r.Math.isolateDigits(r.Math.normalize(s,i.depth,t.depth),2,4),l=r.Math.isolateDigits(r.Math.normalize(this._distance,i.distance,t.distance),4,0);this._priority=n,this._priority+=a,this._priority+=o,this._priority+=l,this.parent&&(this.parent._minChildPriority=Math.min(this.parent._minChildPriority,this._priority))}getTerrainHeightRange(){return{max:this._transformedBoundingBox.max.z,min:this._transformedBoundingBox.min.z}}isPassSSEBecauseOfSpecialConditions(){return!1}}r.Layer.GlobeTile=e}(),function(){class e extends r.AbstractTileset{constructor(e){super(e),this.maximumScreenSpaceError=e.maximumScreenSpaceError||2,this.tileProvider=new r.Layer.GlobeTileProvider(e),this._lastReady=void 0,this._ready=void 0,this._heightRangeOfVisibleTiles={max:-1/0,min:1/0},this._objectGroup.heightRange=this._heightRangeOfVisibleTiles}destroy(){this._lastReady=void 0,this._ready=void 0,this.tileProvider.destroy(),this.tileProvider=void 0,this._objectGroup.heightRange=void 0,this._heightRangeOfVisibleTiles=void 0,super.destroy()}get ready(){return this._ready}_isReady(){return!(!this._root||!this.tileProvider.ready)}checkReadyPreUpdate(e){void 0===this._lastReady&&(this._lastReady=this._isReady()),this._ready=this._lastReady}checkReadyPostUpdate(e){this._lastReady=this._isReady(),this._lastReady&&!this._ready&&e.afterRenderFns.push((function(){}))}createTile(e){return new r.Layer.GlobeTile(this,e)}loadTileset(e,t,i){this.root=this.createTile({x:0,y:0,level:0})}updateFrameState(e){e.transformMatrixUpdated=!1,e.maximumScreenSpaceError=this.maximumScreenSpaceError,e.geoErrScaleFactor=1,e.oldUseTerrain!=this.tileProvider.terrainProvider.useTerrain&&(e.transformMatrixUpdated=!0,e.useTerrain=this.tileProvider.terrainProvider.useTerrain,e.oldUseTerrain=e.useTerrain)}_fetchChildrenOfTile(e,t){this.needLoadChildrenOfTile(e)&&(e._childrenState=r.TileContentState.READY,this.loadChildrenOfTile(e))}needLoadChildrenOfTile(e){return e.childrenUnload&&e.level<this.tileProvider.getMaxLimitedLevel()}_isAvailableLevel(e){return e.level<this.tileProvider.getMaxLimitedLevel()}loadChildrenOfTile(e,t,i){e.isDestroyed()||(this.createTile({x:2*e.x,y:2*e.y,level:e.level+1,parent:e}),this.createTile({x:2*e.x+1,y:2*e.y,level:e.level+1,parent:e}),this.createTile({x:2*e.x,y:2*e.y+1,level:e.level+1,parent:e}),this.createTile({x:2*e.x+1,y:2*e.y+1,level:e.level+1,parent:e}),i&&i())}_canBeTraverse(e,t){return 0!==e.childrenTree.length&&e.sse>t.maximumScreenSpaceError}_addTileToRequestedQueue(e,t){e._requestedFrame!==t.frameNumber&&(e._requestedFrame=t.frameNumber,this._requestedTiles.push(e))}requestTiles(e){let t=!1,i=this._requestedTiles;i.sort(r.AbstractTileset.sortByPriority);for(let e=0,r=i.length;e<r;++e)t=this.requestContent(i[e])||t;t&&e.afterRenderFns.push((function(){}))}updateTiles(e){const t=this.statistics,i=this._selectedTiles;this._clearHeightRange();for(let r=0,n=i.length;r<n;++r){let n=i[r];n.update(e),this._updateHeightRange(n),t.incrementSelectionCount(n.content),++t.selected}this.debugShowStatistics(e)}_clearHeightRange(){this._heightRangeOfVisibleTiles.max=-1/0,this._heightRangeOfVisibleTiles.min=1/0}_updateHeightRange(e){if(!this.tileProvider.isUseTerrain())return;const t=this._heightRangeOfVisibleTiles,i=e.getTerrainHeightRange();i.max>t.max&&(t.max=i.max),i.min<t.min&&(t.min=i.min)}requestContent(e){if(e.contentTypeEmpty)return!1;const t=this.statistics;return e.requestContent()?(this._requestedTilesInFlight.push(e),e.contentProcessPromise.then(this._addTileToProcessingQueue(this,e)).catch((function(e){})),e.contentReadyPromise.then(this._handleTileContentSuccess(this,e)).catch(this._handleTileContentFailure(this,e)),!1):(t.incrementNumberOfAttemptedRequests(),e.needsLoading)}clearLoadedTilesCache(){}invalidateImageryOfAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetImageryContent()}))}invalidateTerrainOfAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetTerrainContent()}))}resetAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetBoundingBox(),e.resetTerrainContent()}))}updateTileMeshForFlatten(){const e=this.tileProvider;this._traverseAllTiles((t=>{e.updateTileMeshForFlatten(t)}))}getTileMesh(){const e=[];return this._traverseAllTiles((t=>{e.push(t)})),e}_traverseAllTiles(e){if(!this._root)return;const t=[];for(t.push(this._root);t.length>0;){const i=t.pop(),r=i.childrenTree;for(let e=0,i=r.length;e<i;++e)t.push(r[e]);e(i)}}_createTraversalController(e){this._traversalController=new r.GlobeTilesetTraversal}_updatePriorityForRequestedTiles(){const e=this._requestedTiles;for(let t=0,i=e.length;t<i;++t)e[t].clearPriority();for(let t=0,i=e.length;t<i;++t)e[t].computePriority();for(let t=0,i=e.length;t<i;++t)e[t].updatePriority()}}r.Layer.GlobeTileset=e}(),function(){class e extends r.BaseModel{constructor(e,t){super(t.manager,t),this.viewer=e,this.isDemLayer=!0,this.objectGroupName=r.GlobalData.TilePlaneGroupName,this.objectGroup=this._createObjectGroup(),this.objectGroup.transformMatrix=this.transformMatrix,this.objectGroup.altitudeOffset=this.basePointAltitude;const i=Object.assign({},t,{id:this.id,type:r.RequestType.IMAGERY,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,debugShowBoundingBox:e._options.debugShowBoundingBox,terrainOperationManager:e.terrainOperationManager,tilesCacheScheduler:this.manager.tilesCacheScheduler,skipLodEnabled:t.loadConfig?t.loadConfig.skipLodEnabled:void 0,globeLayer:this});this._tileset=new r.Layer.GlobeTileset(i),this.tileManager=new r.Layer.GlobeTileManager(this),this.viewer.basePointPositionOnLonLat=this.basePointPositionOnLonLat,this.viewer._globeTileManager=this.tileManager,this.onSkirtMeshVisible=()=>{if(!this.tileManager.isUseTerrain())return;if(this.tileManager.tileProvider.isGlobeLayerTransparent)return;if(this.objectGroup.children.length<16)return;const e=this.viewer.camera.position,t=this.tileManager.tileProvider.skirtShow;r.Utils.defined(this._lastCameraHeight);const i=new r.Raycaster(e,new THREE.Vector3(0,-1,0));let n=!1;this._tileset._traverseAllTiles((e=>{if(!e||1==n||!e._content||!e._content._meshes||!1===e._content._meshes.visible)return;e._content._meshes.traverse((e=>{if("MeshEx"!==e.type)return;const t=[];e.raycast(i,t),t.length>0&&(n=!0)}))})),!1===n&&1==t?this.tileManager.tileProvider.hideSkirt():!0===n&&0==t&&this.tileManager.tileProvider.showSkirt(),this._lastCameraHeight=e.y},this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.onSkirtMeshVisible),this._lastCameraHeight=null}destroy(){this.manager.removeModel(this.id,!1),this.tileManager.destroy(),this.tileManager=void 0,this._tileset.destroy(),this._tileset=null,this._removeObjectGroup(),this.objectGroup=null,this.viewer.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.onSkirtMeshVisible),this.onSkirtMeshVisible=null,this.viewer=null,this.manager.setDemLoadedState(!1),r.GlobalData.EnableGisMap=!1,super.destroy()}setValues(e){this._setupParameters(e),super.setValues(e)}_setupParameters(e){e.modelId=r.Utils.defaultValue(e.modelId,r.ObjectGroupType.TILEGROUP);const t=e.loadConfig;e.priority=r.Utils.defaultValue(t.priority,0),this.unitScale=r.Tile.TileMath.unitScale,t.unitScale=this.unitScale;const i=r.Utils.defaultValue(t.modelPosition,[0,0]);this.semiMercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(i[1]),t.mercatorPerimeter=2*this.semiMercatorPerimeter,this.basePointPositionOnLonLat=i,this.basePointAltitude=r.Utils.defaultValue(t.modelAltitude,0),this.basePointRotationZ=r.Utils.defaultValue(t.modelRotationZ,0),this.basePoint=r.Utils.defaultValue(t.basePoint,{x:0,y:0})}setupTransformMatrix(){const e=this.basePointPositionOnLonLat,t=this.basePointAltitude,i=this.basePointRotationZ,n=this.basePoint,a=this.unitScale,s=this.semiMercatorPerimeter,o=r.Tile.TileMath.lonLat2Mercator(e[0],e[1],s,a),l=(new THREE.Matrix4).makeTranslation(-o.x,-o.y,-t*a),d=new THREE.Matrix4;i&&d.makeRotationFromEuler((new THREE.Euler).fromArray([0,0,-i]));const h=(new THREE.Matrix4).makeTranslation(n.x,n.y,0),c=(new THREE.Matrix4).premultiply(l).premultiply(d).premultiply(h);this.setTransformMatrix(c)}transformLayer(){const e=this.basePointPositionOnLonLat;this.semiMercatorPerimeter=r.Tile.TileMath.mercatorPerimeter*Math.cos(e[1]*Math.PI/180),this._tileset.tileProvider.terrainProvider.setMercatorPerimeter(2*this.semiMercatorPerimeter),this._tileset.resetAllTiles(),this.setupTransformMatrix(),this._updateObjectGroup(),this.manager.setRenderStateChanged(!0)}_createObjectGroup(){return this.viewer.getScene().getOrCreateObjectGroup(this.objectGroupName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0})}_removeObjectGroup(){this.viewer.getScene().removeObjectGroupByName(this.objectGroupName)}_updateObjectGroup(){const e=this.viewer.getScene().getRawMatrixGlobal(),t=this.objectGroup;t.matrix.multiplyMatrices(e,t.transformMatrix),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0)}load(e){const t=this.viewer,i=this.manager,n=!t.getScene().hasBoundingBox();if(n){i.dispatchEvent({type:r.EVENTS.ON_LOAD_START}),i.setDrawableModel(!0),i.chooseRendering(this.statistics.memoeryInfo,!0),t.rendererManager.setupRenderer(t.renderSettings);const e=.5*r.GlobalData.SceneSize;this.getTransforms().boundingBox=(new THREE.Box3).setFromArray([-e,-e,-e,e,e,e]),i.updateScene(this)}i.setDemLoadedState(!0);let a=t.getScene().getRawMatrixGlobal();this.updateMatrixOfObjectGroup(a),r.GlobalData.EnableGisMap=!0,this._tileset.loadTileset(),this.loaded=!0,n&&i.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:this.id}),Promise.resolve().then((()=>{i.setRenderStateChanged(!0),i.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL})}))}updateMatrixOfObjectGroup(e){const t=this.objectGroup;t.matrix.copy(t.transformMatrix),t.matrix.multiplyMatrices(e,t.matrix),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0)}preUpdate(e){this._tileset.checkReadyPreUpdate(e),this._tileset.preUpdate(e)}update(e){this._tileset.update(e)}postUpdate(e){this._tileset.postUpdate(e),this._tileset.checkReadyPostUpdate(e)}addImageryLayer(e){return this._tileset.addImageryLayer(e)}traverseMeshByLayerId(e,t){this.objectGroup.traverse((i=>{"MeshEx"===i.type&&i.layerId===e&&t&&t(i)}))}setImageryLayerVisible(e,t){this.traverseMeshByLayerId(e,(e=>{e.visible=t}))}setAllLayerVisible(e,t){let i=!0!==t;this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,i&&this.manager.setRenderStateChanged(!0))}setRenderStateChanged(e){this.manager.setRenderStateChanged(e)}getRawTransformMatrix(){return this.transformMatrix}getTransformMatrixInverse(){return this.transformMatrixInverse}updateMaterialsValue(e,t,i){this.tileManager&&this.tileManager.tileProvider&&this.tileManager.tileProvider.updateMaterialsValue(this,e,t,i)}setCastShadow(e){super.setCastShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}setReceiveShadow(e){super.setReceiveShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}rayCastVertical(e){const t=this.objectGroup,i=this.viewer.getScene().getInverseMatrixGlobal(),n=(new THREE.Box3).setFromObject(t);n.applyMatrix4(i);const a=this.viewer.getScene().getRawMatrixGlobal(),s=new THREE.Vector3(e.x,e.y,n.max.z+10);s.applyMatrix4(a);const o=new r.Raycaster(s,new THREE.Vector3(0,-1,0)),l=[];if(this._tileset._traverseAllTiles((e=>{if(!e||!e._content||!e._content._meshes||!1===e._content._meshes.visible)return;e._content._meshes.traverse((e=>{if("MeshEx"!==e.type||e.name.indexOf("Skirt")>-1)return;const t=[];e.raycast(o,t),t.length>0&&l.push(t[0])}))})),0===l.length)return;const d=l[0].point;return d.applyMatrix4(i),d}}r.Layer.GlobeLayer=e}(),r.Layer.GlobeTileManager=class{constructor(e){this.globeLayer=e,this.tileProvider=e._tileset.tileProvider,this.layerList=[]}destroy(){this.layerList=void 0,this.tileProvider=void 0,this.globeLayer=void 0}getLayer(){return this.globeLayer}lonLat2Mercator(e,t){const i=.5*this.tileProvider.terrainProvider.mercatorPerimeter,n=r.Tile.TileMath.lonLat2Mercator(e,t,i,1),a=this.globeLayer.getRawTransformMatrix();return new THREE.Vector3(n.x,n.y,0).applyMatrix4(a)}mercator2lonLat(e){const t=.5*this.tileProvider.terrainProvider.mercatorPerimeter,i=this.globeLayer.getTransformMatrixInverse(),n=new THREE.Vector3(e.x,e.y,0).applyMatrix4(i);return r.Tile.TileMath.mercator2lonLat(n,t,1)}worldPositionToLngLat(e){return this.mercator2lonLat(e)}lngLatToWorldPositionWithoutOpenTerrain(e,t){const i=e[0],n=e[1];function a(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let s=a(this,i,n);if(!t){const e=this.globeLayer.rayCastVertical(s);return void 0===e?(delete s.z,s):e}const o=this.tileProvider.terrainProvider,l=o.getMaxMinTerrainLevel().maxLevel,d=r.Tile.TileMath.long2tile(i,l),h=r.Tile.TileMath.lat2tile(n,l),c=o.getTerrainUrlWithoutOpenTerrain(d,h,l);if(null==c||null==c)return s;const u=.5*o.mercatorPerimeter,p=r.Tile.TileMath.lonLat2Mercator(i,n,u,1),m=new THREE.Vector3(p.x,p.y,r.Tile.TileMath.earthHighestAltitude),f=new r.Raycaster(m,new THREE.Vector3(0,0,-1)),g=this.globeLayer.getRawTransformMatrix();o.loadArrayBufferImmediately(c,(e=>{const c=o.getTerrainDataArray(e);let u=l,p=c,m=d,v=h;for(let e=0;e<o.maxLimitedLevel-l;e++){let e=u+1,t=u;m=r.Tile.TileMath.long2tile(i,e),v=r.Tile.TileMath.lat2tile(n,e),p=o.getTerrainDataArrayWithTerrainLevel(m,v,e,t,p),u+=1}const y=o.getTileGeometryByData(p,m,v,u,!0),M=new r.MeshEx(y.geometry);M.name=`${d}-${h}-${u}`,y.matrix&&M.matrix.copy(y.matrix),M.updateMatrixWorld(!0);const E=[];M.raycast(f,E),s=E.length>0?E[0].point.applyMatrix4(g):a(this,i,n),t(s)}),(()=>{s=a(this,i,n),t(s)}))}lngLatToWorldPositionWithObj(e,t){const i=e.lon,n=e.lat,a=e.id,s=e.order;function o(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let l=o(this,i,n);const d=this.tileProvider.terrainProvider,h=d.getMaxMinTerrainLevel().maxLevel,c=r.Tile.TileMath.long2tile(i,h),u=r.Tile.TileMath.lat2tile(n,h),p=d.getTerrainUrlWithoutOpenTerrain(c,u,h);if(null==p||null==p)return l;const m=.5*d.mercatorPerimeter,f=r.Tile.TileMath.lonLat2Mercator(i,n,m,1),g=new THREE.Vector3(f.x,f.y,r.Tile.TileMath.earthHighestAltitude),v=new r.Raycaster(g,new THREE.Vector3(0,0,-1)),y=this.globeLayer.getRawTransformMatrix();d.loadArrayBufferImmediately(p,(e=>{const p=d.getTerrainDataArray(e),m=d.getTileGeometryByData(p,c,u,h,!0),f=new r.MeshEx(m.geometry);f.name=`${c}-${u}-${h}`,m.matrix&&f.matrix.copy(m.matrix),f.updateMatrixWorld(!0);const g=[];f.raycast(v,g),l=g.length>0?g[0].point.applyMatrix4(y):o(this,i,n),t(l,a,s)}),(()=>{l=o(this,i,n),t(l,a,s)}))}lngLatToWorldPosition(e,t){const i=e[0],n=e[1];function a(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let s=a(this,i,n);if(!this.isUseTerrain())return s;if(!t){const e=this.globeLayer.rayCastVertical(s);return void 0===e?(delete s.z,s):e}const o=this.tileProvider.terrainProvider,l=o.getMaxMinTerrainLevel().maxLevel,d=r.Tile.TileMath.long2tile(i,l),h=r.Tile.TileMath.lat2tile(n,l),c=o.getTerrainUrl(d,h,l),u=.5*o.mercatorPerimeter,p=r.Tile.TileMath.lonLat2Mercator(i,n,u,1),m=new THREE.Vector3(p.x,p.y,r.Tile.TileMath.earthHighestAltitude),f=new r.Raycaster(m,new THREE.Vector3(0,0,-1)),g=this.globeLayer.getRawTransformMatrix();o.loadArrayBufferImmediately(c,(e=>{const c=o.getTerrainDataArray(e),u=o.getTileGeometryByData(c,d,h,l,!0),p=new r.MeshEx(u.geometry);p.name=`${d}-${h}-${l}`,u.matrix&&p.matrix.copy(u.matrix),p.updateMatrixWorld(!0);const m=[];p.raycast(f,m),s=m.length>0?m[0].point.applyMatrix4(g):a(this,i,n),t(s)}),(()=>{s=a(this,i,n),t(s)}))}get modelRotationZ(){return this.globeLayer.basePointRotationZ}set modelRotationZ(e){this.globeLayer.basePointRotationZ=e,this.globeLayer.transformLayer()}getModelRotationZ(){return this.modelRotationZ}setModelRotationZ(e){this.modelRotationZ=e}get modelPosition(){return this.globeLayer.basePointPositionOnLonLat}set modelPosition(e){this.globeLayer.basePointPositionOnLonLat=e,this.globeLayer.transformLayer()}setModelPosition(e){this.modelPosition=e}getModelPosition(){return this.modelPosition}get modelAltitude(){return this.globeLayer.basePointAltitude}set modelAltitude(e){this.globeLayer.basePointAltitude=e,this.globeLayer.objectGroup.altitudeOffset=e,this.globeLayer.transformLayer()}setModelAltitude(e){this.modelAltitude=e}getModelAltitude(){return this.modelAltitude}get basePoint(){return this.globeLayer.basePoint}getBasePoint(){return this.globeLayer.basePoint}clearTiles(){}addRenderCallback(){}setOpacity(e,t){if(void 0!==t)return void this.tileProvider.setOpacity(e,t);const i=this.getAllLayerIds();0!==i.length?i.map((t=>{this.tileProvider.setOpacity(e,t)})):this.tileProvider.setPresetOpacity(e)}getOpacity(e){return this.tileProvider.getOpacity(e)}setMapLayer(e){let t;const i=this.tileProvider.getImageryLayerByMapLayer(e);if(i)t=i.imageryProvider.id,this.tileProvider.adjustImageryLayer(t,0);else{let i={};const r=this.tileProvider.getBaseImageryLayer();r&&(i=r.imageryProvider.cloneParameters(),this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r)),i.mapLayer=e,t=this.tileProvider.addImageryLayer(i,0)}return this.tileProvider.setBaseLayerId(t),t}getBaseLayerId(){return this.tileProvider.getBaseLayerId()}getAllLayerIds(){return this.tileProvider.getAllLayerIds()}getMapUrl(e){const t=this.tileProvider.getImageryLayerById(e);if(t)return t.imageryProvider.mapUrl}setMapUrl(e,t){return this.setImageryLayer({mapUrl:e,imageryProviderType:t})}setImageryLayer(e){if(void 0===e.mapUrl)return void console.log("options.mapUrl is required.");let t;const i=this.tileProvider.getImageryLayerByMapUrl(e.mapUrl),r=this.tileProvider.getBaseImageryLayer();return i?(r&&r!==i&&(this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r.imageryProvider.id)),t=i.imageryProvider.id,this.tileProvider.adjustImageryLayer(t,0)):(r&&(this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r.imageryProvider.id)),t=this.tileProvider.addImageryLayer(e,0)),this.tileProvider.setBaseLayerId(t),t}addImageryLayer(e,t){if(void 0===e.mapUrl)return void console.log("options.mapUrl is required.");let i;const r=this.tileProvider.getImageryLayerByMapUrl(e.mapUrl);return r?(i=r.imageryProvider.id,this.tileProvider.adjustImageryLayer(i,t)):(this.globeLayer._tileset.invalidateImageryOfAllTiles(),i=this.tileProvider.addImageryLayer(e,t)),0===t&&this.tileProvider.setBaseLayerId(i),i}removeImageryLayer(e){this.tileProvider.removeImageryLayer(e),this.globeLayer._tileset.invalidateImageryOfAllTiles()}adjustImageryLayer(e,t){this.tileProvider.adjustImageryLayer(e,t)}updateImageryLayer(e,t){if(void 0===t.mapUrl)return void console.log("options.mapUrl is required.");const i=this.tileProvider.getImageryLayerIndex(e);if(-1===i)return;let r;this.removeImageryLayer(e);const n=this.tileProvider.getImageryLayerByMapUrl(t.mapUrl);return n?(r=n.imageryProvider.id,t.imageryProviderType&&n.imageryProviderType!==t.imageryProviderType?(this.removeImageryLayer(r),r=this.tileProvider.addImageryLayer(t,i)):this.tileProvider.adjustImageryLayer(r,i)):r=this.tileProvider.addImageryLayer(t,i),0===i&&this.tileProvider.setBaseLayerId(r),r}getImageryLayerIndex(e){return this.tileProvider.getImageryLayerIndex(e)}setTerrain(e,t){return this.tileProvider.setTerrainProvider(e,(()=>{this.tileProvider.clearMaterialAndSkirtCache(),this.globeLayer._tileset.invalidateTerrainOfAllTiles(),t&&t()}))}getTerrain(){return this.tileProvider.getTerrainUrl()}applyTerrain(e){this.tileProvider.setTerrainEnabled(e)&&(this.tileProvider.clearMaterialAndSkirtCache(),this.globeLayer._tileset.invalidateTerrainOfAllTiles())}isUseTerrain(){return this.tileProvider.terrainProvider.useTerrain}setStyle(e,t){e&&(void 0===t?this.getAllLayerIds().forEach((t=>{this.tileProvider.setStyle(e,t)})):this.tileProvider.setStyle(e,t))}setExcavation(e){e&&this.tileProvider.setExcavation(e)}setPolygonClimpGroundInfo(e){e&&this.tileProvider.setPolygonClimpGroundInfo(e)}closePolygonClimpGround(){this.tileProvider.closePolygonClimpGround()}updateMaterialsSide(){this.tileProvider.updateMaterialsSide()}updateTileMeshForFlatten(){this.globeLayer._tileset.updateTileMeshForFlatten()}show(e){this.tileProvider.setImageryLayerVisible(e,!0),this.tileProvider.hasImageryLayerVisible()&&this.globeLayer.setVisible(!0),this.globeLayer.setRenderStateChanged(!0)}hide(e){this.tileProvider.setImageryLayerVisible(e,!1),this.tileProvider.hasImageryLayerVisible()||this.globeLayer.setVisible(!1),this.globeLayer.setRenderStateChanged(!0)}hideAllLayers(e){this.globeLayer.setAllLayerVisible(!1,e)}showAllLayers(e){this.globeLayer.setAllLayerVisible(!0,e)}getMaxLevel(e){this.getMaxTerrainLevel(maxLevel)}setMaxLevel(e,t){this.setMaxTerrainLevel(e)}getMaxTerrainLevel(){return this.tileProvider.getMaxLimitedLevel()}setMaxTerrainLevel(e){this.tileProvider.setMaxLimitedLevel(e)}getMaxImageryLevel(e){return this.tileProvider.getMaxImageryLevel(e)}setMaxImageryLevel(e,t){this.tileProvider.setMaxImageryLevel(e,t),this.globeLayer._tileset.invalidateImageryOfAllTiles()}},function(){class e extends r.TilesetTraversal{constructor(){super()}traverseTiles(e,t,i){const r=this.traversalStack;for(r.push(t);r.length>0;){const t=r.pop(),n=t.refineReplace,a=!t.parent||t.parent._refines;let s=!1;if(e._isAvailableLevel(t)&&(e._fetchChildrenOfTile(t,i),e._canBeTraverse(t,i)&&(s=this.subdivideTile(e,t,i),s=s&&a)),n){const r=!s&&a;this._selectRefiningTile(e,t,i,r)}else e._addTileToRequestedQueue(t,i),e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=s}}subdivideTile(e,t,i){return e._skipLodEnabled?this._subdivideTileBySkippingLod(e,t,i):super.subdivideTile(e,t,i)}_selectRefiningTile(e,t,i,r){e._skipLodEnabled?r&&(e._addTileToRequestedQueue(t,i),e._addTileToSelectedQueue(t,i)):(e._addTileToRequestedQueue(t,i),r&&e._addTileToSelectedQueue(t,i))}_subdivideTileBySkippingLod(e,t,i){const n=this.traversalStack,a=t.childrenTree;let s=!1;if(a.forEach((t=>{e.updateTile(t,i),s=s||t.passSSE(i)})),a.sort(r.TilesetTraversal.sortByDistanceToCamera),!s)return!1;const o=t.refineReplace&&!t.contentTypeEmpty;let l=!0,d=!1;return a.forEach((t=>{t.visible?(n.push(t),d=!0):o&&(e.visitTile(t,i),e.touchTile(t,i))})),d||(l=!1),l}}r.GlobeTilesetTraversal=e}(),r.BimtileDescriptor=class{constructor(){this.mapNodeInfoByBatched=new Map,this.mapNodeInfoByInstance=new Map,this.onNodeInfoChangedCallback=[]}destroy(){this.mapNodeInfoByBatched.clear(),this.mapNodeInfoByInstance.clear(),this.mapNodeInfoByBatched=null,this.mapNodeInfoByInstance=null,this.onNodeInfoChangedCallback=[]}_classifyNodeInfo(e){const t=e.userId,i=e.nodeId;if(!1===e.instanceOrNot)return!1===this.mapNodeInfoByBatched.has(t)&&this.mapNodeInfoByBatched.set(t,new Map),void this.mapNodeInfoByBatched.get(t).set(i,e);!1===this.mapNodeInfoByInstance.has(t)&&this.mapNodeInfoByInstance.set(t,new Map),!1===this.mapNodeInfoByInstance.get(t).has(i)&&this.mapNodeInfoByInstance.get(t).set(i,new Map),this.mapNodeInfoByInstance.get(t).get(i).set(e.index,e)}getAllNodeInfos(){return[this.mapNodeInfoByBatched,this.mapNodeInfoByInstance]}getAllNodeInfosCallback(e){for(const t of this.mapNodeInfoByBatched.values())for(const i of t.values())e&&e(i);for(const t of this.mapNodeInfoByInstance.values())for(const i of t.values())for(const t of i.values())e&&e(t)}getBatchedUserIds(){let e=new Map,t=new THREE.Vector3;for(const[i,r]of this.mapNodeInfoByBatched){let n=new THREE.Box3;if(!this.mapNodeInfoByInstance.has(i)){for(const e of r.values()){const t=e.boundingBox;n.union(t)}n.getSize(t),e.set(i,t.length())}}let i=Array.from(e);return i.sort((function(e,t){return t[1]-e[1]})),[...new Map(i.map((e=>[e[0],e[1]]))).keys()]}getInstanceUserIds(){let e=new Map,t=new THREE.Vector3;for(const[i,r]of this.mapNodeInfoByInstance){let n=new THREE.Box3;for(const e of r.values())for(const t of e.values()){const e=t.boundingBox;n.union(e)}n.getSize(t),e.set(i,t.length())}let i=Array.from(e);return i.sort((function(e,t){return t[1]-e[1]})),[...new Map(i.map((e=>[e[0],e[1]]))).keys()]}getAllUserIds(){let e=new Map([...this.mapNodeInfoByBatched,...this.mapNodeInfoByInstance]);const t=[...e.keys()];return e=null,t}hasNodeInfo(){return this.mapNodeInfoByBatched.size>0||this.mapNodeInfoByInstance.size>0}getBatchedNodeInfos(){return this.mapNodeInfoByBatched}getInstanceNodeInfos(){return this.mapNodeInfoByInstance}addOnNodeInfoChanged(e){this.onNodeInfoChangedCallback.push(e)}removeOnNodeInfoChanged(e){for(let t=0;t<this.onNodeInfoChangedCallback.length;++t)if(this.onNodeInfoChangedCallback[t]===e){this.onNodeInfoChangedCallback.splice(t,1);break}}onNodeInfoChanged(e){for(let t=0;t<this.onNodeInfoChangedCallback.length;++t)this.onNodeInfoChangedCallback[t](this,e)}patchBatchedMeshNodeInfo(e,t,i){const r=parseInt(e),n=this.mapNodeInfoByBatched.get(r);if(!n)return;const a=n.get(t);a&&(a.parent=i.parent,a.materialId=i.materialId,a.matrix=i.matrix,a.explodeMatrix&&(a.matrix=i.matrix.clone(),a.matrix.multiplyMatrices(a.explodeMatrix,a.matrix)),a.type=i.type,a.cellId=null)}patchInstanceNodeInfo(e,t,i){const r=parseInt(e),n=this.mapNodeInfoByInstance.get(r);if(!n)return;const a=n.get(i.bufferId);if(!a)return;const s=a.get(i.instanceIndex);s.geometryId=t,s.parent=t,s.matrix=i.entityMatrix.clone(),s.explodeMatrix&&(s.matrix=i.entityMatrix.clone(),s.matrix.multiplyMatrices(s.explodeMatrix,s.matrix)),s.type=i.type,s.cellId=null}getInstanceMatrixListByUserIdAndMeshId(e,t){let i=[];const r=this.mapNodeInfoByInstance.get(e);if(!r)return i;const n=r.get(t);if(!n)return i;for(const e of n.values())e.matrix&&i.push(e.matrix);return i}getNodeInfosByUserId(e){let t=[];return this.getNodeInfoByUserIdCallback(e,(e=>{t.push(e.nodeInfo)})),t}isUserIdExist(e){const t=parseInt(e);return this.mapNodeInfoByBatched.has(t)||this.mapNodeInfoByInstance.has(t)}getUserTileIdMap(e,t){const i=this.mapNodeInfoByBatched.get(e);if(i)for(const e of i.values())t[e.tileId]=null;const r=this.mapNodeInfoByInstance.get(e);if(r)for(const e of r.values())for(const i of e.values())t[i.tileId]=null}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.mapNodeInfoByBatched.get(i);if(r)for(const[e,i]of r){const r={instanceOrNot:!1,meshId:e,parent:i.parent,nodeInfo:i};t&&t(r)}}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.mapNodeInfoByInstance.get(i);if(r){const e={instanceOrNot:!0};for(const[i,n]of r){e.meshId=i;for(const[i,r]of n)e.parent=r.parent,e.index=i,e.nodeInfo=r,t&&t(e)}}}getNodeInfoByUserIdCallback(e,t){this.getBatchedNodeInfoByUserIdCallback(e,t),this.getInstanceNodeInfoByUserIdCallback(e,t)}getAnyUserData(){for(const e of this.mapNodeInfoByBatched.values())for(const t of e.values())return t.userData}getUserDataByUserId(e){const t=parseInt(e),i=this.mapNodeInfoByBatched.get(t);if(i)for(const[e,t]of i)return t.userData;const r=this.mapNodeInfoByInstance.get(t);if(r)for(const[e,t]of r)for(const[e,i]of t)return i.userData}verifyNodeInfos(){for(const e of this.mapNodeInfoByBatched.values())for(const t of e.values())void 0===t.parent&&console.log(t);for(const e of this.mapNodeInfoByInstance.values())for(const t of e.values())for(const e of t.values())void 0===e.parent&&console.log(e)}updateMaxUserIDIndex(){}},function(){r.BimtilesObjectInfoDict=class{constructor(){this.nodeInfos=null}init(e){this.nodeInfos||(this.nodeInfos=e)}reInit(e){this.nodeInfos=e}getNodeInfoCallback(e){for(const t of this.nodeInfos[0].values())for(const i of t.values())e&&e(i.userId,i);for(const t of this.nodeInfos[1].values())for(const i of t.values())for(const t of i.values())e&&e(t.userId,t)}getUserDataCallback(e){let t=!0;for(const i of this.nodeInfos[0].values()){t=!0;for(const r of i.values())!0===t&&e&&e(r.userId,r),t=!1}for(const i of this.nodeInfos[1].values()){t=!0;for(const r of i.values())for(const i of r.values())!0===t&&e&&e(i.userId,i),t=!1}}setIdsState2(e,t,i,r){if(!0!==i&&void 0!==i){for(const t of this.nodeInfos[0].values()){const i=t.userId;e.has(i)||r&&r(t)}for(const t of this.nodeInfos[1].values()){const i=t.userId;e.has(i)||r&&r(t)}}else{let i=0;for(const n of e.keys()){let e=this.nodeInfos[0].get(n),a=t[i];if(e&&e instanceof Map){for(const[t,i]of e)r&&r(i,a);if(e=this.nodeInfos[1].get(n),e)for(const[t,i]of e)r&&r(i,a)}else e&&r&&r(e,a),e=this.nodeInfos[1].get(n),e&&r&&r(e,a);i++}}}setIdsState(e,t,i){if(!0!==t&&void 0!==t){for(const t of this.nodeInfos[0].values())for(const r of t.values()){const t=r.userId;e.has(t)||i&&i(r)}for(const t of this.nodeInfos[1].values())for(const r of t.values())for(const t of r.values()){const r=t.userId;e.has(r)||i&&i(t)}}else for(const t of e.keys()){let e=this.nodeInfos[0].get(t);if(e)for(const t of e.values())i&&i(t);if(e=this.nodeInfos[1].get(t),e)for(const t of e.values())for(const e of t.values())i&&i(e)}}getNodeInfoById(e){const t=parseInt(e);if(this.nodeInfos[0].has(t)){const e=this.nodeInfos[0].get(t);for(const t of e.values())return t}if(this.nodeInfos[1].has(t)){const e=this.nodeInfos[1].get(t);for(const t of e.values())for(const e of t.values())return e}}clear(){this.nodeInfos=null}getNodeInfos(){return this.nodeInfos}};r.BimtileObjectInfoManager=class{constructor(){this.objectInfoDict=new r.BimtilesObjectInfoDict,this.hasMaterial=!1,this.hasWireFrameMaterial=!1,this.isHasObjectHidden=!1,this.hasObjectHiddenByIsolate=!1,this.hasTransparent=!1,this.hasTransparentByIsolate=!1,this._boundingBox=new THREE.Box3,this.explodeBoxNeedUpdate=!1,this.inactivatedIdMap={},this.inactivatedIds=[],this.bIsInactivateAll=!1,this.localClippingList=new Map,this.hasLocalClipping=!1,this.modifyOpacityList=new Map,this.hasModifyOpacityList=!1}setOpacity(e,t,i){let r=this.arrayToMap(e);this.objectInfoDict.setIdsState2(r,t,true,((e,t)=>{this.isActive(e.userId)&&(e.material=t,this.hasMaterial=!0)})),r=null}setTileReader(e){this.tileReader=e}init(e){this.objectInfoDict.init(e)}reinit(e){this.objectInfoDict.reInit(e)}clearData(){this.objectInfoDict.clear()}getNodeInfos(){return this.objectInfoDict.getNodeInfos()}calculateVisibleComponentsBbox(){this._boundingBox.makeEmpty();this.objectInfoDict.getNodeInfoCallback(((e,t)=>{if(this.isHidden(e))return;const i=t.boundingBox;i&&!i.isEmpty()?(this._boundingBox.expandByPoint(i.min),this._boundingBox.expandByPoint(i.max)):console.warn("Object has no this._boundingBox, id is "+e)})),this.explodeBoxNeedUpdate=!1}getVisibleComponentsBbox(){return(this.explodeBoxNeedUpdate||this._boundingBox.isEmpty())&&this.calculateVisibleComponentsBbox(),this._boundingBox.clone()}needUpdateBoxAfterExplode(){this.explodeBoxNeedUpdate=!0}arrayToMap(e){let t=new Map;for(let i=0;i<e.length;i++){const r=e[i];t.set(r,r)}return t}isMatchConditions(e,t){let i=!0;for(let r=0,n=t.length;r<n;r++){const n=t[r];for(const t in n){if(void 0===e[t]){i=!1;break}if(!(n[t]instanceof Array)&&e[t]!=n[t]){i=!1;break}if(n[t]instanceof Array&&-1==n[t].indexOf(e[t])){i=!1;break}}if(1==i)break;r<t.length-1&&(i=!0)}return i}matchConditionsWithFilterMng(e,t,i,r,n){let a=t._parseConditions(e),s=[],o=[];this.objectInfoDict.getUserDataCallback(((e,t)=>{const i=t.userData,r=this.tileReader.getUserDataByIndex(i)||{};r.elementId=t.userId;this.isMatchConditions(r,a)?s.push(e):o.push(e)})),r&&n?(i&&i(r,n,s,!0),i&&i(r,n,o,!1)):(i&&i(s,!0),i&&i(o,!1))}matchConditions(e,t,i,r){let n=[],a=[];this.objectInfoDict.getUserDataCallback(((t,i)=>{const r=i.userData,s=this.tileReader.getUserDataByIndex(r)||{};s.elementId=i.userId;this.isMatchConditions(s,e)?n.push(t):a.push(t)})),i&&r?(t&&t(i,r,n,!0),t&&t(i,r,a,!1)):(t&&t(n,!0),t&&t(a,!1))}getMatchIds(e){let t=[];return this.objectInfoDict.getUserDataCallback(((i,r)=>{const n=r.userData,a=this.tileReader.getUserDataByIndex(n)||{};a.elementId=r.userId;this.isMatchConditions(a,e)&&t.push(i)})),t}setVisible(e,t,i,n){e.length>0&&n&&(e=n._parseIds(e));let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{t?e.state=e.state|r.EnumObjectState.Visible:(this.isHasObjectHidden=!0,e.state=e.state&~r.EnumObjectState.Visible)}))}isVisible(e){return this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.Visible>0}clearVisible(){this.isHasObjectHidden=!1,this.setVisible([],!0,!1)}hideAll(){this.isHasObjectHidden=!0,this.setVisible([],!1,!1)}setTransparent(e,t,i,n){e.length>0&&n&&(e=n._parseIds(e));let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{this.isActive(e.userId)&&(t?(e.state=e.state|r.EnumObjectState.Transparent,this.hasMaterial=!0,this.hasTransparent=!0):e.state=e.state&~r.EnumObjectState.Transparent)})),a=null}isTransparent(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}clearTransparent(){this.hasTransparent=!1,this.setTransparent([],!1,!1)}setMaterials(e,t,i,r){const n=r._parseIds(e);let a=this.arrayToMap(n);this.objectInfoDict.setIdsState2(a,t,true,((e,t)=>{this.isActive(e.userId)&&(e.material=t,this.hasMaterial=!0)})),a=null}setMaterial(e,t,i,r,n=!0){const a=n?r._parseIds(e):e;let s=this.arrayToMap(a);this.objectInfoDict.setIdsState(s,i,(e=>{this.isActive(e.userId)&&(e.material=t,this.hasMaterial=!0)})),s=null}getMaterial(e){let t=this.objectInfoDict.nodeInfos[0].get(e);if(t&&t instanceof Map){for(const[e,i]of t){if(!(i instanceof Map))return i.material;for(const[e,t]of i)return t.material}if(t=this.objectInfoDict.nodeInfos[1].get(e),t&&t&&t instanceof Map)for(const[e,i]of t){if(!(i instanceof Map))return i.material;for(const[e,t]of i)return t.material}return null}if(t)return t.material;if(t=this.objectInfoDict.nodeInfos[1].get(e),t&&!(t instanceof Map))return t.material;if(t)for(const[e,i]of t)if(i instanceof Map)for(const[e,t]of i)return t.material;else if(i.material)return i.material;return null}clearMaterial(){let e=this.arrayToMap([]);this.objectInfoDict.setIdsState(e,!1,(e=>{this.isActive(e.userId)&&(e.material=null,e.wireFrameMaterial=null,this.hasMaterial=!0)})),e=null}clearAllComponentsMaterial(){let e=this.arrayToMap([]);this.objectInfoDict.setIdsState(e,!1,(e=>{this.isActive(e.userId)&&(e.material=null,this.hasMaterial=!0)})),e=null}setWireFrameMaterial(e,t,i,r){const n=r._parseIds(e);let a=this.arrayToMap(n);this.objectInfoDict.setIdsState(a,i,(e=>{e.wireFrameMaterial=t,this.hasWireFrameMaterial=!0})),a=null}getWireFrameMaterial(e){return this.objectInfoDict.getNodeInfoById(e).wireFrameMaterial}clearWireFrameMaterial(){this.setWireFrameMaterial([],null,!1)}setIsolateHide(e,t,i){let n=this.arrayToMap(e);this.objectInfoDict.setIdsState(n,i,(e=>{t?(this.hasObjectHiddenByIsolate=!0,e.state=e.state|r.EnumObjectState.HideByIsolate):e.state=e.state&~r.EnumObjectState.HideByIsolate})),n=null}isIsolateHide(e){return(this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.HideByIsolate)>0}setIsolateTransparent(e,t,i){let n=this.arrayToMap(e);this.objectInfoDict.setIdsState(n,i,(e=>{this.isActive(e.userId)&&(t?(e.state=e.state|r.EnumObjectState.TransparentByIsolate,this.hasMaterial=!0,this.hasTransparentByIsolate=!0):e.state=e.state&~r.EnumObjectState.TransparentByIsolate)})),n=null}isIsolateTransparent(e){return(this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.TransparentByIsolate)>0}clearIsolateHide(){this.setIsolateTransparent([],!1,!1)}clearIsolates(){this.hasTransparentByIsolate=!1,this.hasObjectHiddenByIsolate=!1,this.setIsolateHide([],!1,!1),this.setIsolateTransparent([],!1,!1)}setIsolateHideAfterClear(e,t,i){this.clearIsolates(),this.setIsolateHide(e,t,i)}setIsolateTransparentAfterClear(e,t,i){this.clearIsolates(),this.setIsolateTransparent(e,t,i)}clearTransparentByIsolate(){this.hasTransparentByIsolate=!1,this.setIsolateTransparent([],!1,!1)}isHidden(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=0==(t.state&r.EnumObjectState.Visible);return i=i||(t.state&r.EnumObjectState.HideByIsolate)>0,i}isFrozen(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}resetAll(){this.objectInfoDict.setIdsState(new Map,!1,(e=>{e.state|=r.EnumObjectState.Visible,this.isActive(e.userId)&&(e.material=null)})),this.hasMaterial=!1,this.isHasObjectHidden=this.hasObjectHiddenByIsolate=!1,this.hasTransparent=this.hasTransparentByIsolate=!1}hasOverrideMaterial(e){if(null==e)return this.hasMaterial;return null!=this.objectInfoDict.getNodeInfoById(e).material||this.isTransparent(e)}hasOverrideMaterialForWireFrame(e){if(null==e)return this.hasWireFrameMaterial;return null!=this.objectInfoDict.getNodeInfoById(e).wireFrameMaterial}hasObjectInactivated(){return this.inactivatedIds.length>0}hasObjectHidden(){return this.isHasObjectHidden||this.hasObjectHiddenByIsolate}hasObjectCantSelected(){return this.hasObjectHidden()||this.hasObjectTransparent()||this.hasObjectInactivated()}hasObjectTransparent(){if(this.hasObjectInactivated()){var e=!1;for(const t of this.inactivatedIds)if(this.isTransparent(t)){e=!0;break}return e}return this.hasTransparent||this.hasTransparentByIsolate}deactivateByIds(e){for(const t of e)this.inactivatedIdMap[t]=!0;this.inactivatedIds=Object.keys(this.inactivatedIdMap)}clearInactivatedIdMap(){this.inactivatedIdMap={},this.inactivatedIds=[]}isActive(e){return 0==this.bIsInactivateAll&&!(1==this.inactivatedIdMap[e])}deactivateAll(){this.bIsInactivateAll=!0}activateAll(){this.bIsInactivateAll=!1}getInactivatedIdMap(){return this.inactivatedIdMap}addToModifyOpacityList(e,t){var i=this.modifyOpacityList;void 0===i.get(e)&&i.set(e,{}),i.get(e).opacity=t,this.hasModifyOpacityList=!0}removeModifyOpacityList(e){let t=this.modifyOpacityList;e.map((e=>{t.delete(e)})),0===Object.keys(t)&&(this.hasModifyOpacityList=!1)}clearModifyOpacityList(){this.modifyOpacityList=new Map,this.hasModifyOpacityList=!1}addToLocalClippingList(e,t,i,n){var a=this.localClippingList;void 0===a.get(e)&&a.set(e,{}),r.Utils.isDefined(n)&&(null==a.get(e).nodeMap&&(a.get(e).nodeMap=new Map),a.get(e).nodeMap.set(n.toString(),t)),i&&(a.get(e).wireframeMaterialName=i),this.hasLocalClipping=!0}clearLocalClippingList(){this.localClippingList=new Map,this.hasLocalClipping=!1}activeLocalClipping(){this.hasLocalClipping=!0}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModelExplosion{constructor(e){super(e),this.explosionBegin=!1,this.explosionOffset={}}destroy(){this.explosionOffset=null,super.destroy()}explode(){this.model._tileset.explode(this)}preFloorExplode(e,t,i){this.explosionBegin=!0;let n={},a={};for(var s=0,o=t.length;s<o;s++){let e=t[s].explodedHeight-t[s].elevation,r=new THREE.Vector3(i.x*e,i.y*e,i.z*e);n[t[s].name]=r;let o=null;o=t[s].preExplodedTranslation?r.clone().sub(t[s].preExplodedTranslation):r.clone(),a[t[s].name]=o,t[s].preExplodedTranslation=r}let l=this.explosionTranslation;const d=this.model.getDescriptor();let h=new THREE.Matrix4,c=new THREE.Matrix4,u=3;const p=this.model.tilesLoader.tileReader;if(d.hasNodeInfo()){const e=d.getAnyUserData(),t=p.getUserDataByIndex(e);for(const e in t){"levelName"===p.getUserDataStringMapByIndex(e)[0]&&(u=e)}}let m={true:{},false:{}};d.getAllNodeInfosCallback((t=>{const i=t.userId,s=t.userData;let o=p.getUserDataByIndex(s)[u],f=p.getUserDataStringMapByIndex(u,o)[1],g=n[f]||new THREE.Vector3;l[i]=g,h.makeTranslation(g.x,g.y,g.z);let v=a[f]||new THREE.Vector3;if(c.makeTranslation(v.x,v.y,v.z),d instanceof r.BimtileNodeIdDescriptor&&1==m[t.instanceOrNot][i])return;const y=c.clone();if(d.patchBoxExplodeMatrix?(d.patchBoxExplodeMatrix(y,i,t.instanceOrNot),t.boundingBox.applyMatrix4(c)):t.loadedExplodeMatrix=y,t.matrix)t.matrix.multiplyMatrices(c,t.matrix),d.patchLoadedTileExplodeMatrix&&d.patchLoadedTileExplodeMatrix(t.matrix,i,t.nodeId,t.index,t.instanceOrNot),e.union(t.boundingBox),m[t.instanceOrNot][i]=!0;else{const e=h.clone();d.patchExplodeMatrix?d.patchExplodeMatrix(e,i,t.instanceOrNot):t.explodeMatrix=e}})),m=null,e.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}preElementExplode(i,n,a){this.explosionBegin=!0;const s=this.model.getBoundingBoxWorld();if(!s)return;const o=n-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==o)return;let l=new THREE.Matrix4,d=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert(),a?t.copy(a):s.getCenter(t),t.applyMatrix4(e);const h=this.model.getDescriptor(),c=h.getAllUserIds();let u=this.explosionTranslation,p={true:{},false:{}};for(let e=0,a=c.length;e<a;e++){let a=c[e],s=new THREE.Box3;h.getNodeInfoByUserIdCallback(a,(e=>{const t=e.nodeInfo;t.originBox||(t.originBox=t.boundingBox.clone()),s.union(t.originBox)}));let m=r.Utils.computeExplodeTranslation(t,s,n);u[a]=m,l.makeTranslation(m.x,m.y,m.z);let f=r.Utils.computeExplodeTranslation(t,s,o);d.makeTranslation(f.x,f.y,f.z),this.explosionOffset[a]=f,h.getNodeInfoByUserIdCallback(a,(e=>{const t=e.nodeInfo;if(h instanceof r.BimtileNodeIdDescriptor&&1==p[t.instanceOrNot][a])return;const n=d.clone();if(h.patchBoxExplodeMatrix?(h.patchBoxExplodeMatrix(n,a,t.instanceOrNot),t.boundingBox.applyMatrix4(d)):t.loadedExplodeMatrix=n,t.matrix)t.matrix.multiplyMatrices(d,t.matrix),h.patchLoadedTileExplodeMatrix&&h.patchLoadedTileExplodeMatrix(t.matrix,a,t.nodeId,t.index,t.instanceOrNot),i.union(t.boundingBox),p[t.instanceOrNot][a]=!0;else{const e=l.clone();h.patchExplodeMatrix?h.patchExplodeMatrix(e,a,t.instanceOrNot):t.explodeMatrix=e}}))}p=null,i.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}getExplosionTranslation(e){return this.explosionTranslation[e]||new THREE.Vector3}getExplosionTranslationByObjId(e){const t=this.model.tilesLoader.tileReader.getIndexByUserId(e);return this.explosionOffset[t]||new THREE.Vector3}getLevelNameByObjId(e){const t=this.model.getDescriptor().getUserDataByUserId(e);let i=this.model.tilesLoader.tileReader.getUserDataByIndex(t)[3];return this.model.tilesLoader.tileReader.getUserDataStringMapByIndex(3,i)[1]}standardExplode(e){function t(e,t,n,a,s){for(var o=e.getAttribute("position").array,l=t;l<n;l+=3)i.set(o[l],o[l+1],o[l+2]),i.applyMatrix4(s),i.add(a),r.copy(s).invert(),i.applyMatrix4(r),o[l]=i.x,o[l+1]=i.y,o[l+2]=i.z;e.getAttribute("position").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;let i=new THREE.Vector3,r=new THREE.Matrix4;const n=e._content.meshes,a=e._content._outlineContent.outlineMeshes;new THREE.Matrix4,new THREE.Matrix4;let s=new THREE.Vector3,o=new THREE.Vector3(0),l=e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.frustumCulled=!1;let i=e.geometry;const r=e.indexGroups;for(const[a,l]of r)for(const[r,d]of l){let r=this.getExplosionTranslation(a),l=d.preTranslation?d.preTranslation:o;if(s.set(r.x-l.x,r.y-l.y,r.z-l.z),0!=s.x||0!=s.y||0!=s.z){var n=d.positionStart;t(i,n,n+d.positionCount,s,e.matrix),d.preTranslation=r}}};n.traverse((e=>{l(e)})),a.traverse((e=>{l(e)})),e.explodeCount=this.model.manager.explosionManager.explodeCount}instanceExplode(e){function t(e,t,i,r){var n=e.getAttribute("mcol3").array;n[3*t]+=i.x,n[3*t+1]+=i.y,n[3*t+2]+=i.z,e.getAttribute("mcol3").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;const i=e.instanceInfo.entityInfoArray;let r=new THREE.Vector3,n=new THREE.Vector3(0);const a=e._content.meshes.children[0],s=e._content._outlineContent.outlineMeshes.children[0];a.frustumCulled=!1;for(let e=0,o=i.length;e<o;e++){const o=i[e].userID;let l=this.getExplosionTranslation(o),d=n;i[e].preTranslation&&(d=i[e].preTranslation),r.set(l.x-d.x,l.y-d.y,l.z-d.z),0==r.x&&0==r.y&&0==r.z||(t(a.geometry,e,r),s&&s.geometry&&t(s.geometry,e,r),i[e].preTranslation=l)}e.explodeCount=this.model.manager.explosionManager.explodeCount}}r.BimTilesModelExplosion=i}(),r.BimTileNodeManager=class{constructor(){this._nodeMap={}}destroy(){this._nodeMap=null}addNode(e){this._nodeMap[e.nodeId]=e}getNode(e){return this._nodeMap[e]}},function(){class e{constructor(){this._owner=0,this._bufferGeometries=[],this._id=null,this._state=r.SharedGeometryState.UNLOADED,this._byteLength=0}get owner(){return this._owner}set owner(e){this._owner=e}get bufferGeometry(){return this._bufferGeometries}get id(){return this._id}set id(e){this._id=e}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}get state(){return this._state}set state(e){this._state=e}addBufferGeometry(e){this._bufferGeometries.push(e)}destroy(){this._bufferGeometries=[],this._state=r.SharedGeometryState.DESTROYED,this._id=null,this._byteLength=0}}class t{constructor(){this._geometryMap={}}destroy(){this._geometryMap=null}setByteLength(e,t){r.Utils.defined(this._geometryMap[e])&&(this._geometryMap[e].byteLength=t)}addGeometryById(t,i){let n=this._geometryMap[t];return r.Utils.defined(n)||(n=this._geometryMap[t]=new e),r.Utils.defined(i)&&n.addBufferGeometry(i),n}removeGeometryById(e){const t=this._geometryMap[e];r.Utils.defined(t)&&0===t.owner&&t.state!==r.SharedGeometryState.DESTROYED&&(t.destroy(),delete this._geometryMap[e])}setGeometryByteLength(e,t){const i=this._geometryMap[e];r.Utils.defined(i)&&(i.byteLength=t)}getGeometry(e){return this._geometryMap[e]}addGeometryOwner(e){const t=this._geometryMap[e];r.Utils.defined(t)&&(t.owner+=1)}removeGeometryOwner(e){const t=this._geometryMap[e];r.Utils.defined(t)&&(t.owner-=1)}resetGeometryOwner(){for(const[e,t]of Object.entries(this._geometryMap)){const e=t;r.Utils.defined(e)&&(e.owner=0)}}setShareGeometryState(e,t){const i=this.getGeometry(e);r.Utils.defined(i)&&(i.state=t)}disposeShareGeometry(e){const t=this.getGeometry(e);return!r.Utils.defined(t)||(t.state===r.SharedGeometryState.PROCESSING?(t.destroy(),delete this._geometryMap[e],!1):(t.owner-=1,0===t.owner&&(t.destroy(),delete this._geometryMap[e],!0)))}createMesh(e,t,n){const a=e.bufferGeometry;e.owner+=1,a.forEach((e=>{e.instance?function(e,t,n){const a=e.pbfNodeInfo,s=i(e.bufferGeometry,!0,a);var o=new r.MeshEx(s,e.material);o.frustumCulled=!1,o.name=a.nodeIndexId,o.indexGroups=a.indexGroups,o.indexCount=a.indexCount,o.databagId=a.databagId,o.isInstanceMeshNode=!0,e.tileMatrix&&o.applyMatrix4(e.tileMatrix);t.content.meshes.add(o),n.addInstanceMeshIdMap(a.nodeIndexId,0,o),n.addInstanceInfo(a.nodeIndexId,a.instanceInfo),n.renderableCount++}(e,t,n):function(e,t,n){const a=e.pbfNodeInfo,s=i(e.bufferGeometry,!1,a);let o=new r.MeshEx(s,[e.material.clone()]);a.indexInfos||(a.indexInfos=new Map);o.applyMatrix4(a.matrix),o.name=a.nodeIndexId,o.indexGroups=a.indexInfos;for(const e of a.indexInfos.key())t.userIndexMap.set(e,!0);o.databagId=t._tileset._databagId,o.indexCount=e.bufferGeometry.index.couwdnt,n.addMeshIdMap(o.name,o),function(e,t){const i=e.nodeInfos,n=e.indexInfos;for(const[e,a]of Object.entries(n)){const n=i[e],s=t.getDescriptor().getAllNodeInfos()[e];for(let e=0;e<a.length;++e){const t=a[e];if(r.Utils.defined(n))for(let e=0;e<n.length;++e){const i=n[e];if(i.nodeId===t.meshId){const t=s[e];r.Utils.defined(t)&&(t.parent=i.parent,t.materialId=i.materialId,t.matrix=i.matrix.clone(),r.Utils.defined(t.explodeMatrix)&&(t.explodeMatrix=i.explodeMatrix.clone),t.type=i.type,t.cellId=i.cellId)}}}}}(a,n),t.content.meshes.add(o),a.userIdMapIndex&&n.addUserIdMapIndices(a.userIdMapIndex,o.name)}(e,t,n)})),t.needUpdateFilter=!0}}function i(e,t,i){let n;(t=r.Utils.defaultValue(t,!1))?(n=new THREE.InstancedBufferGeometry,n.groups.push({start:0,count:i.indexCount,materialIndex:0}),n.groups.push({start:0,count:i.indexCount,materialIndex:1})):(n=new THREE.BufferGeometry,n.groups.push({start:0,count:i.iAccInfoCount,materialIndex:0}));for(const[t,i]of Object.entries(e.attributes))n.setAttribute(t,i);const a=e.boundingBox;null!==a&&(n.boundingBox=a.clone());const s=e.boundingSphere;return null!==s&&(n.boundingSphere=s.clone()),n.drawRange.start=e.drawRange.start,n.drawRange.count=e.drawRange.count,n.index=e.index,n}t.SharedGeometry=e,r.BimTileGeometryManager=t}(),function(){let e=new THREE.Matrix4,t=new THREE.Box3;class i extends r.BaseModel{constructor(e,t,i,n,a,s){super(t,i),this.viewer=e,this.parseCfgFinish=a,this.debut=s,this.dataVersion=i.dataVersion,r.Utils.isDefined(this._config)&&r.Utils.isDefined(this._config.metadata)&&(this.datetime=this._config.metadata.datetime),this.url=i.serverUrl+""+i.databagId,i.rootPath?this.url+="/"+i.rootPath:this.url+="/bimtiles.json",this.objectGroup=t.getScene().getOrCreateObjectGroup(`${r.ObjectGroupType.BIMTILESGROUP}|${this.databagId}`,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroup.transformMatrix=this.transformMatrix,this._getNodeGroup(r.ObjectGroupType.GEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.WIREFRAME,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!0}),this._errorCoefficient=r.TilesUtil.BMD_GEOMETRIC_ERROR_COEFFICIENT;let o=r.TilesUtil.MODEL_SSE_Threshold_MAP[i.resourceType.toLowerCase()];i.resourceType&&o&&(this._errorCoefficient=o),this.disableUserData=i.disableUserData,this._enableBorderLine=i.enableBorderLine,this._maxDetailLevel=i.maxDetailLevel,this._detailLevelList=i.detailLevelList,this._visualRange=i.visualRange,this._onDemand=i.onDemand,this._hasLayerInfo=i.hasLayerInfo,!0===i.onDemand&&!1===i.hasLayerInfo&&console.warn("the model has no layer info, will show nothing on demand"),this.delayLoadTexture=r.GlobalData.DelayLoadTexture,this.sceneState=e.modelManager.sceneState,this.isOsgb=this._config.metadata&&"osgb"===this._config.metadata.content,this.isBim=this._config.metadata&&"bim"===this._config.metadata.content,this.is2D=this._config.metadata&&"dwg"===this._config.metadata.content,this.filter=this._crateFilterManger(),this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.sceneState.transparentMaterial=this.getFilter()._getMaterialByName("scene"),this.sceneState.frozonMaterial=this.getFilter().getFrozonMaterial(),this.materialManager=this._crateMaterialManger({viewer:e,lightmapServerUrl:i.lightmapServerUrl,lightmapDatabagId:i.lightmapDatabagId,disableHemiSphereLight:this.is2D}),this.materialManager._updateIBL(this),this.modelExplosion=new r.BimTilesModelExplosion(this);const l=this._config.metadata&&"point"===this._config.metadata.FeatureType&&"shp"===this._config.metadata.content;this._createLoader({batchMergeEnabled:!0,sceneState:this.sceneState,delayLoadTexture:this.delayLoadTexture,materialManager:this.materialManager,enableBorderLine:this._enableBorderLine,filter:this.filter,disableUserData:this.disableUserData,modelExplosion:this.modelExplosion,wireFrameVisibilityOption:i.wireFrameVisibilityOption,renderFunction:()=>{this.manager.setRenderStateChanged(!0)},isShpPoint:l,dataVersion:this.dataVersion,datetime:this.datetime}),this.filter.setTileReader(),this.tilesLoader.tileReader.searchTreeManager.setIs2D(this.is2D),this.filter.enableWireFrameStateChanged(),!0===l&&(this.objectGroup.pickableType=r.PICKABLETYPE.Marker3d,this.objectGroup.hoverEnabled=!0),this._onDemandConditions=void 0===i.demandConditions?[]:i.demandConditions,this.onDemandManager=new r.BimTileOnDemandManager(this),this.modelLoaded=!1,this._shellModel=null,this.minDistanceObjects={},this.blinkStartTimeMap={},this.blinkLastTimeMap={},this.positiveSequenceMap={},this.blinkColorMap={},this.blinkTimesMap={},this.exposureShift=0,this._tileSequence=0,this._parameters=i,this._cloneCursor=0,this.mapClippingIds=new Map,this.mapClippingIdsBox=[new Map,new Map,new Map,new Map,new Map,new Map],this.plugins=[],this._setStatistics(this._config),this.lastHoverId=void 0;const d=e.rendererManager.getPickingEffecter();d.enableUpdateScene(!1),this.pickingManager=new r.BimTilesPickingManager(this,d),this.changeStateTime=new r.IsolateInfoStatics,this.overrideColorInfoStatic=new r.overrideColorInfoStatic,this.initTileLoaded=!1,this.forceLoad=!1}destroy(){this._tileset=this._tileset&&this._tileset.destroy(),this.clearGroups(),this.manager.scene.removeObjectGroupByName(`${r.ObjectGroupType.BIMTILESGROUP}|${this.databagId}`),this.objectGroup.transformMatrix=void 0,this.objectGroup=null,this.manager.scene.removeObjectGroupByName(`${r.ObjectGroupType.BIMTILESWIREFRAMEGROUP}|${this.databagId}`),this.tilesLoader.destroy(),this.tilesLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null,this.delayLoadTexture=void 0,this.sceneState=null,this.materialManager.destroy(),this.materialManager=null,this.blinkStartTimeMap=null,this.blinkLastTimeMap=null,this.positiveSequenceMap=null,this.blinkColorMap=null,this.blinkTimesMap=null,super.destroy(),this._shellModel=null,this.disableUserData=void 0,this._maxDetailLevel=void 0,this._detailLevelList=null,this._visualRange=null,this._parameters=null;for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].destroy(),this.plugins[e]=null;this.plugins=null,this.lastHoverId=void 0,this.pickingManager.destroy(),this.pickingManager=null}_createLoader(e){r.BimTilesVersionControl.isVersion_3(this.dataVersion)?this.tilesLoader=new r.BimTilesLoaderV3(e):this.tilesLoader=new r.BimTilesLoader(e)}getLoader(){return this.tilesLoader}clearGroups(){let e=this._getNodeGroup(r.ObjectGroupType.GEOMETRY);e.clear(),e=this._getNodeGroup(r.ObjectGroupType.WIREFRAME),e.clear(),e=this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY),e.clear(),e=this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),e.clear()}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START_NO_PROGRESS});const i=this._config.count&&this._config.count.element;this._createTileSet();const n=new Promise(((e,n)=>{this._tileset.loadTileset(this.url,(function(i){t.getTransforms().boundingBox=i._boundingBox.clone(),t.modelLoaded=!0,t.manager.updateScene(t),t.filter._updateFilterManager();const n=t.viewer.getScene().getRawMatrixGlobal();i.updateGlobalMatrix(n),t.updateModelMaximumScreenSpaceError(),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t),t._onDemand&&t._tileset.updateOnDemandConditions(t._onDemandConditions),!1===t.disableUserData&&t.tilesLoader.praseWireFrameVisibilityOption(t._parameters.wireFrameVisibilityOption),e()}),(function(){if(void 0===t._tileset.root)return t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE,modelId:t.id}),console.warn("The scene is Empty!"),t.debut&&t.debut(t),void e();t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE,modelId:t.id}),n()}),i)}));return n}_createTileSet(){if(!this._tileset)return this._tileset=this._createNewTileset({loader:this.tilesLoader,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,batchMergeEnabled:!0,tilesCacheScheduler:this.manager.tilesCacheScheduler,onDemandManager:this.onDemandManager,enableBorderLine:this._enableBorderLine,maxDetailLevel:this._maxDetailLevel,visualRange:this._visualRange,hasLayerInfo:this._hasLayerInfo,errorCoefficient:this._errorCoefficient,debugShowBoundingBox:this.viewer._options.debugShowBoundingBox,debugShowStatistics:this.viewer._options.debugShowStatistics,debugShowGeometricErrorHelper:new r.LabelCollection(this.viewer),databagId:this.databagId,fileId:this.fileId,disableUserData:this.disableUserData,sequence:0,materialManager:this.materialManager,skipLodEnabled:this._parameters.skipLodEnabled,foveatedConeLimit:this.viewer._foveatedConeLimit,userInputWorking:this.isBim,forceLoad:this.forceLoad}),this._tileset}_getNodeGroup(e,t){const i=this.objectGroup.children;for(let t=0,r=i.length;t<r;t++)if(i[t].name==e)return i[t];const n=new r.ObjectGroup(e,t);return this.objectGroup.add(n),n.globalSpace&&(n.matrixAutoUpdate=!1,n.updateMatrixWorld(!0)),n}_removeNodeGroup(e){this._rootNodeGroup.removeByName(e)}_createNewTileset(e){return new r.BimTileset(e)}clone(e,t){let i=(e=r.Utils.defaultValue(e,{})).transformMatrix;r.Utils.defined(i)||(i=new THREE.Matrix4),i=this.transformMatrix.clone().multiply(i),this._cloneCursor++;const n=r.Utils.defaultValue(e.modelId,`${this.id}_${this._cloneCursor}`);if(!r.Utils.defined(t)){const e={serverUrl:this._parameters.serverUrl,databagId:this._parameters.databagId,rootPath:this._parameters.rootPath,resourceType:this._parameters.resourceType,onDemand:this._parameters.onDemand,hasLayerInfo:this._parameters.hasLayerInfo,loadConfig:{transformMatrix:i},modelId:n};t=this._createNewModel(this.viewer,this.manager,e)}const a=t;return super.clone(a),a._copy(this),this._cloneTileSet(a),this.manager.addModel(a),this.manager.updateFilterManager(),this.manager.getFilter().calculateVisibleComponentsBbox(),this.manager.updateScene(this),this.viewer.render(),t}_createNewModel(e,t,r){return new i(e,t,r)}_copy(e){super._copy(e),this.modelLoaded=e.modelLoaded,this._shellModel=null}_cloneTileSet(e){this._tileset||console.log(`there is not tileset in model ${this.id}, please check it`);const t=e._createTileSet();this._tileset.clone(t,e.tilesLoader)}loadOnDemand(e){this._tileset.updateOnDemandConditions(e),this.manager.setRenderStateChanged(!0)}isEmptyScene(){return!this.modelLoaded}updateModelMaximumScreenSpaceError(){const e=this.viewer,t=e.domElement.offsetHeight;this._tileset.updateMaximumScreenSpaceError({camera:e.camera,globalMatrix:e.getScene().getRawMatrixGlobal(),globalInverseMatrix:e.getScene().getInverseMatrixGlobal(),transformMatrix:this.transformMatrix,cameraPreSSE:t/e.camera.frustumHeightFactor})}updateMaterialsValue(e,t,i){this.materialManager.updateMaterialsValue(this,e,t,i)}changeAllMaterials(e){this.materialManager.changeAllMaterials(this,e),this.tilesLoader.batchedMeshManager.changeAllMaterials(this.materialManager.materialMap),this.tilesLoader.instancedMeshManager.changeAllMaterials(this.materialManager.materialMap)}getBoundingBoxWorld(){return this.getTransforms().boundingBox.clone().applyMatrix4(this.getTransformMatrix())}setModelMaximumScreenSpaceError(e){this._tileset.setMaximumScreenSpaceError(e)}setDetailRatio(e){this._tileset.setGeoErrScaleFactor(e),this.manager.setRenderStateChanged(!0)}getDetailRatio(e){return this._tileset.getGeoErrScaleFactor()}getMeshesByUserIds(e,t){e&&t&&(this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[],this.getMeshesByUserId(e),this.getMeshesByUserId(t))}getMeshesByUserId(e){const t=this.getLengthUnitsMatrix(),i=this.tilesLoader.tileReader.getIndexByUserId(e),r=this.getTransformMatrix();this.getDescriptor().getNodeInfoByUserIdCallback(i,(n=>{const a=n.nodeInfo,s=a.parent||a.nodeId;let o={};if(o.boundingBox=a.boundingBox,o.unitsMatrix=t,!1===a.instanceOrNot){const t=this.tilesLoader.getMeshNodeById(s);if(!t)return;o.mesh=t;let n=(new THREE.Matrix4).copy(r).multiply(a.matrix);o.matrix=n;const l=o.mesh.indexGroups.get(i);for(const t of l.values())o.indexInfo=t,this.minDistanceObjects[e].push(o)}else{const t=this.tilesLoader.getInstanceMeshNodeById(s);if(!t)return;for(const[i,n]of t){o.mesh=n.mesh;let t=(new THREE.Matrix4).copy(r).multiply(n.matrix).multiply(a.matrix);n.mesh.matrixRoot&&t.multiply(n.mesh.matrixRoot),o.matrix=t,this.minDistanceObjects[e].push(o)}}}))}calculateClippingIds(e,i){const n=this.manager.scene,a=r.FillClipPlaneManager.getInstance(n),s=a&&a.isEnabled(),o=n.clipPlanes;let l=s?a:o;if(!l)return;let d=l.renderClipPlane.clone(),h=s?l.capsIntersectPosition:l.capsIntersectPosition[l.selectIndex];if(!h)return;let c=s?l.capsIntersectPositionGroup:l.capsIntersectPositionGroup[l.selectIndex];c.set(this,new Map);let u=s?-1:l.selectIndex,p=this.getFilter().getLocalClippingList(),m=this.viewer.getRenderer().localClippingEnabled&&p.size>0;const f=n.getMatrixGlobal();if(f.multiply(this.transformMatrix),this.mapClippingIds=new Map,i)this.mapClippingIdsBox.forEach((e=>{e.clear()}));else{let e=[],i=[];this.tilesLoader.getDescriptor().getAllNodeInfosCallback((n=>{if(0==(n.state&r.EnumObjectState.Visible)||(n.state&r.EnumObjectState.HideByIsolate)>0)return;const a=this.tilesLoader.tileReader.getUserIdByIndex(n.userId);if(!m||m&&p.get(a)){const r=n.boundingBox,a=n.instanceOrNot;t.copy(r).applyMatrix4(f),d.intersectsBox(t)&&(a?i.push(n):e.push(n),this.mapClippingIds.set(n.userId,!0))}})),this.tilesLoader.batchedMeshManager.calculateClippingIds(d,h,c,this,e),this.tilesLoader.instancedMeshManager.calculateClippingIds(d,h,c,this,i)}if(u>=0){this.mapClippingIdsBox[u]=this.mapClippingIds,this.mapClippingIds=new Map;for(let e=0;e<this.mapClippingIdsBox.length;++e)this.mapClippingIdsBox[e].forEach(((e,t)=>{this.mapClippingIds.set(t,e)}))}this.filter.enableStateChanged()}calculateClippingContours(t){const i=this.manager.scene;let n=r.FillClipPlaneManager.getInstance(i),a=n.renderClipPlane;n.planeMesh;const s=r.FillClipPlaneManager.getFillClipPlaneBoundingBoxWorld(i);e.copy(this.transformMatrix).invert();const o=s.clone().applyMatrix4(e),l=this.id;n.capsIntersectContour[l]={};const d=this.manager.getScene().getInverseMatrixGlobal();let h=a.clone().applyMatrix4(d);const c=this.tilesLoader.getDescriptor();t.map((e=>{const t=this.tilesLoader.tileReader.getIndexByUserId(e);c.getNodeInfoByUserIdCallback(t,(i=>{const r=i.nodeInfo,d=r.boundingBox.clone().applyMatrix4(this.transformMatrix);(d.intersectsPlane(h)||d.intersectsBox(o))&&(r.instanceOrNot?this.tilesLoader.instancedMeshManager.calculateClippingContours(l,a,s,t,e,r,this.transformMatrix,n.capsIntersectContour):this.tilesLoader.batchedMeshManager.calculateClippingContours(l,a,s,t,e,r,this.transformMatrix,n.capsIntersectContour))}))}))}getUserIdMapByFrustum(e){let t={},i=new THREE.Box3;var r=this.viewer.getScene().getRawMatrixGlobal();const n=this.transformMatrix,a=this.tilesLoader.tileReader.getSearchTreeBuffer(),s=this.manager.explosionManager.isExploded(this.id);for(const o in a){const l=a[o].searchTreeBlob,d=a[o].box;i.copy(d),i.applyMatrix4(n).applyMatrix4(r),(e.intersectsBox(i)||s)&&this.tilesLoader.tileReader.searchTreeManager.getUserIdsInFrustum(l,e,t,n,r,s)}return t}getRealUserId(e){return this.tilesLoader.tileReader.getUserIdByIndex(parseInt(e))}getGeometryBuffersByUserId(e){let t=[],i=new Set;return this.getDescriptor().getNodeInfoByUserIdCallback(e,(r=>{const n=r.nodeInfo,a=n.parent||n.nodeId;i.has(a)||(!1===n.instanceOrNot?this.tilesLoader.batchedMeshManager.getGeometryBuffersByNodeInfo(a,e,this.databagId,t):this.tilesLoader.instancedMeshManager.getGeometryBuffersByNodeInfo(a,n,this.databagId,t),i.add(a))})),t}getNodeInfosByUserIndex(e){let t=[],i=new THREE.Box3;return this.getDescriptor().getNodeInfoByUserIdCallback(e,(e=>{const r=e.nodeInfo,n=r.clone?r.clone():r;n.transformMatrix=this.getTransformMatrix();const a=r.userData,s=this.tilesLoader.tileReader.getUserDataByIndex(a);let o={};for(let e in s){const[t,i]=this.tilesLoader.tileReader.getUserDataStringMapByIndex(e,s[e]);o[t]=i}n.userData=o;const l=r.boundingBox;i.union(l),t.push(n)})),t}getNodeInfosByUserId(e){const t=this.tilesLoader.tileReader.getIndexByUserId(e);let i=[],r=new THREE.Box3;return this.getDescriptor().getNodeInfoByUserIdCallback(t,(e=>{const t=e.nodeInfo,n=t.clone?t.clone():t;n.transformMatrix=this.getTransformMatrix();const a=t.userData,s=this.tilesLoader.tileReader.getUserDataByIndex(a);let o={};for(let e in s){const[t,i]=this.tilesLoader.tileReader.getUserDataStringMapByIndex(e,s[e]);o[t]=i}n.userData=o;const l=t.boundingBox;r.union(l),i.push(n)})),i}getMaterialByMaterialId(e,t){if(e)return this.materialManager.materialMap[e];const i=t.nodeId,r=this.tilesLoader.getInstanceMeshNodeById(i);return r?r.entries().next().value[1].mesh.material[0]:void 0}getPickingMeshes(e,t,i,n,a){let s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1;var o=!(!a||"string"!=typeof a||!a.startsWith("glow"));this._dealNonInstancedNodesForPicking(e,t[s],i,n,o),this._dealInstancedNodesForPicking(e,t[s],i,n,o)}_dealNonInstancedNodesForPicking(e,t,i,n,a){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getBatchedNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo;this.filter._isPickable(i)&&(this.tilesLoader.batchedMeshManager.updatePickingMeshes(i,t,o,s,a),this.tilesLoader.batchedWireframeManager.updatePickingMeshes(i.lineId,t,o,s))}))}t.add(s)}}_dealInstancedNodesForPicking(e,t,i,n,a){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){if(a){const e={bimtileDescriptor:d,instanceMeshGroup:s,selectedIds:i};return this.tilesLoader.instancedMeshManager.updatePickingMeshesByIds(e),void t.add(s)}for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getInstanceNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo,r=i.parent;this.tilesLoader.instancedMeshManager.updatePickingMeshes(r,o,i.matrix,s,a,i.index),this.tilesLoader.instancedWireframeManager.updatePickingMeshes(i.lineId,t,o,i.matrix,s)}))}t.add(s)}}isHiddenSourceObjectUserId(e){return this.manager.isHiddenSourceObjectUserId(e,this.id)}hasHiddenSourceObjectUserId(){return this.manager.hasHiddenSourceObjectUserId(this.id)}getModelMaximumScreenSpaceError(){return this._tileset.getMaximumScreenSpaceError()}updateMatrix(){const e=this.viewer.getScene().getRawMatrixGlobal();this._tileset.updateGlobalMatrix(e)}hasTransforms(){return!0}preUpdate(e){this._tileset.preUpdate(e)}update(e){this._tileset.update(e),this.TimeStaticDispatchEvent()}postUpdate(e){this._tileset.postUpdate(e)}updateUnitScale(e){e.unitScale=this.unitScale}isCulled(){return!!this.isUseable()&&this._tileset.root.visible}_hasNode(){return 0!==this.objectGroup.children.length}getDescriptor(){return this.tilesLoader.getDescriptor()}getAllNodeInfos(){return this.getDescriptor().getAllNodeInfos()}applyFilter(){}applySelection(){this.pickingManager.setSelectedIdMap(this.sceneState.selectionSet[this.getId()]),this.pickingManager.enableSelectionStateChanged()}clearSelection(){this.pickingManager.setSelectedIdMap(null),this.pickingManager.enableSelectionStateChanged()}clearHover(){this.sceneState.hoverId=void 0,this.lastHoverId=this.sceneState.hoverId,this.filter.enableStateChanged()}applyHover(){this.sceneState.hoverId!==this.lastHoverId&&(this.lastHoverId=this.sceneState.hoverId,this.filter.enableStateChanged())}setVisible(e){this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,this.objectGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0),0==e&&this.pickingManager.clearDrawable())}isUserIdExist(e){const t=this.tilesLoader.tileReader.getIndexByUserId(e);return this.getDescriptor().isUserIdExist(t)}getBlinkMaterials(){return this.filter.getBlinkMaterials()}updateBlinkMaterial(e){var t=this.sceneState.getBlinkComponentsIdMap(this.id),i=(this.filter.blinkMaterials,this.manager.blinkManager);for(var n in t){var a=t[n],s=this.tilesLoader.tileReader.getIndexByUserId(n);if(!r.Utils.defined(s))continue;const p=this.filter.getBlinkMaterialsByUserId(s);if(p){a.color&&(this.blinkColorMap[n]=this.blinkColorMap[n]||new THREE.Vector4,this.blinkColorMap[n].set(a.color.red/255,a.color.green/255,a.color.blue/255,a.color.alpha));var o=this.blinkColorMap[n]||i.getBlinkColor(this.id),l=0,d=r.EnumShaderColorState.BLINK,h=a.interval||e||600,c=Date.now();if(this.blinkTimesMap[n]=null==this.blinkTimesMap[n]?0:this.blinkTimesMap[n],void 0===this.blinkStartTimeMap[n]&&(this.positiveSequenceMap[n]=!0,this.blinkStartTimeMap[n]=c,this.blinkLastTimeMap[n]=c),c-this.blinkLastTimeMap[n]<=100)return;if(c-this.blinkStartTimeMap[n]>h&&(this.positiveSequenceMap[n]=!this.positiveSequenceMap[n],this.blinkStartTimeMap[n]=c,this.blinkLastTimeMap[n]=c,a.times&&(this.blinkTimesMap[n]++,this.blinkTimesMap[n]==2*a.times)))return this.blinkTimesMap[n]=0,void this.sceneState.clearBlinkComponentsById([n],this.id);var u=(c-this.blinkStartTimeMap[n])/h;l=this.positiveSequenceMap[n]?u:1-u,this.blinkLastTimeMap[n]=c;for(const e of p)e.updateBlinkUniformValue(d,o,l)}}}setExposureShift(e){this.exposureShift=e,r.GlobalData.ToneMapping=1;const t=e>0?-.4*e+.5:-4*e+.5;this.materialManager.updateMaterialsValue(this,"shift",t),this.manager.setRenderStateChanged(!0)}getExposureShift(){return this.exposureShift}setColorSaturation(e){this.materialManager.updateMaterialsValue(this,"saturation",shift),this.manager.setRenderStateChanged(!0)}setColorTemperature(e,t){this.materialManager.updateMaterialsValue(this,"temperature",e),this.materialManager.updateMaterialsValue(this,"temperatureStrength",t),this.manager.setRenderStateChanged(!0)}setColorContrast(e){this.materialManager.updateMaterialsValue(this,"contrast",contrast),this.manager.setRenderStateChanged(!0)}setBorderLineVisible(e){this._enableBorderLine=e,this._getNodeGroup(r.ObjectGroupType.WIREFRAME).visible=e,this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY).visible=e,this.tilesLoader&&this.tilesLoader.setBorderLineVisible(e)}isBorderLineVisible(){return this._enableBorderLine}_setStatistics(e){e&&e.count&&(this.statistics.numOfElements=e.count.element,this.statistics.numOfTriangles=e.count.mesh_face,this.statistics.numOfVertices=e.count.mesh_vertex)}_recoverIndexInfo(e){this.tilesLoader.recoverIndexInfo((()=>{this.tilesLoader.recoverNodeInfo(),this.tilesLoader.recoverLineNode(),this.filter._updateFilterManager(),this.tilesLoader.praseWireFrameVisibilityOption(this._parameters.wireFrameVisibilityOption),this.disableUserData=!1,this._tileset.disableUserData=!1,this.tilesLoader.disableUserData=!1,e&&e()}))}loadBusinessResources(e){!1!==this.disableUserData&&this._tileset.loadUserIdResources((()=>{this._recoverIndexInfo(e)}))}debugShowGeometricError(e){this._tileset&&this._tileset.debugShowGeometricError(e)}get sequence(){return this._tileSequence}set sequence(e){this._tileSequence=e}set shellModel(e){this._shellModel=e}get shellModel(){return this._shellModel}set config(e){this._config=e}get config(){return this._config}setRequestSequencePriority(e){this._tileset.sequence=e}setCastShadow(e){super.setCastShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}setReceiveShadow(e){super.setReceiveShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}enableLocalClippingMode(e){this.localClippingMode=e,this.tilesLoader.instancedMeshManager.updateInstanceClipping(e);if(this.tilesLoader.instancedWireframeManager.updateInstanceClipping(e),!e)for(var t in this.localClippingPlanes=null,this.materialManager.materialMap){this.materialManager.materialMap[t].clippingPlanes=null}}isVisibleMesh(e){const t=this.tilesLoader.batchedMeshManager.getMeshNodeById(e);if(t&&!0===t.visible&&t.parent&&!0===t.parent.visible)return!0;const i=this.tilesLoader.instancedMeshManager.getInstanceMeshNodeById(e);if(i)for(const[e,t]of i){const e=t.mesh;if(!r.TilesUtil.isInstanceNodeInVisible(e))return!0}return!1}setMaxDetailLevel(e){if(this._detailLevelList.length>0){const t=this._detailLevelList[0];if(e<t)return console.log(`${this.id} minDetailLevel  is ${t}, ${e} set`),void(this._tileset.maxDetailLevel=t)}this._tileset.maxDetailLevel=e}getMaxDetailLevel(){return this._tileset.maxDetailLevel}setVisualRange(e){this._tileset.visualRange=e}getVisualRange(){return this._tileset.visualRange}getRootGeoErrDistance(){const e=this.viewer.domElement.offsetHeight/this.viewer.camera.frustumHeightFactor;return this._tileset.getRootGeoErrDistance(e)}rayCastVertical(e){const t=new THREE.Vector3(e.x,e.y,this.getBoundingBoxWorld().max.z+10),i=this.viewer.getScene().getRawMatrixGlobal();t.applyMatrix4(i);const n=new r.Raycaster(t,new THREE.Vector3(0,-1,0)),a=[];if(this._tileset.traverseContentAvailableNode((e=>{if(!e.contentVisible)return;e._content._meshes.traverse((e=>{if("MeshEx"!==e.type)return;const t=[];e.raycast(n,t),t.length>0&&a.push(t[0])}))})),0===a.length)return;a.sort(((e,t)=>e.distance-t.distance));const s=a[0].point,o=this.viewer.getScene().getInverseMatrixGlobal();return s.applyMatrix4(o),s}setReplacedUserIdMap(e){r.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}hasReplacedUserId(){return!r.Utils.isEmptyObject(this.replacedUserIdMap)}isReplacedUserId(e){const t=this.tilesLoader.tileReader.getUserIdByIndex(e);return!(!this.replacedUserIdMap||!this.replacedUserIdMap[t])}registerPlugin(e){this.plugins.push(e)}getModelDescriptor(){return this.getDescriptor()}_getNodeGroup(e,t){const i=this.objectGroup.children;for(let t=0,r=i.length;t<r;t++)if(i[t].name==e)return i[t];const n=new r.ObjectGroup(e,t);return this.objectGroup.add(n),n.globalSpace&&(n.matrixAutoUpdate=!1,n.updateMatrixWorld(!0)),n}getWireframeMaterial(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().wireframeMaterial}getInstanceWireframeMaterial(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().instanceWireframeMaterial}setWireframeColor(e,t){this.tilesLoader.bimTileOutlineBlobParser.getLineParser().setWireframeColor(e,t)}getWireframeColor(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().getWireframeColor()}restoreWireframeColor(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().restoreWireframeColor()}getAllWireframeGroupNames(){return[r.ObjectGroupType.WIREFRAME,r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY]}adjustVisibility(e){this._getNodeGroup(r.ObjectGroupType.GEOMETRY).visible=e;var t=this._getNodeGroup(r.ObjectGroupType.WIREFRAME);this._isActiveNodeGroup(t)&&(t.visible=e)}adjustInstanceVisibility(e){this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY).visible=e;var t=this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY);this._isActiveNodeGroup(t)&&(t.visible=e)}applyBlink(){this.filter.enableStateChanged()}clearBlink(){this.filter.enableStateChanged()}setExcavation(e){}setPolygonClimpGroundInfo(e){this.materialManager.setPolygonClimpGroundInfo(e)}closePolygonClimpGround(){this.materialManager.closePolygonClimpGround()}_crateFilterManger(){return r.BimTilesVersionControl.isVersion_3(this.dataVersion)?new r.BimTileFilterManagerV3(this):new r.BimTileFilterManager(this)}_crateMaterialManger(e){return new r.BimTileMaterialManager(e)}getAllUserIds(){return this.getDescriptor().getAllUserIds().map((e=>this.getRealUserId(e)))}isUserIdDataReady(){return this._tileset._userIdReady}getUserIdTileMap(e){let t={};const i=e.length;for(let r=0;r<i;++r){const i=this.tilesLoader.tileReader.getIndexByUserId(e[r]);t[e[r]]={},this.getDescriptor().getUserTileIdMap(i,t[e[r]])}return t}getUserIdTileMapVisibility(e){for(const t in e)for(const i in e[t])this.objectGroup.traverse((r=>{r.tileId===parseInt(i)&&(e[t][i]=r.visible)}))}updateTransformMatrix(){super.updateTransformMatrix(),this.pickingManager.enableSelectionStateChanged()}isUserIdVisible(e){let t=this.getNodeInfosByUserId(e),i=t[0].nodeId;return null==this.tilesLoader.getMeshNodeById(i)&&null==this.tilesLoader.getInstanceMeshNodeById(i)&&(i=t[0].parent),this.isVisibleMesh(i)}getBatchedUserIdArray(){return this.getDescriptor().getBatchedUserIds().map((e=>this.getRealUserId(e)))}getInstanceUserIdArray(){return this.getDescriptor().getInstanceUserIds().map((e=>this.getRealUserId(e)))}getRepeatPending(){return this._tileset.repeatPendingList}getInit_DescriptorCount(){return this.changeStateTime.descriptorCount}_disPatchIsolateEvent(){let e=this.changeStateTime.meshChangeTime+this.changeStateTime.useridInfoChangeTime;this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_ISOLATE,event:event,timeInfo:{modelId:this.id,meshChangeTime:this.changeStateTime.meshChangeTime+" ms",userInfoChangeTime:this.changeStateTime.useridInfoChangeTime+" ms",totalChangeTime:e+" ms"}}),this.changeStateTime.isPatch=!1}_disPatchOverrideColorEvent(){this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_OVERRIDE_CHANGED,event:event,timeInfo:{modelId:this.id,overrideComponentsColorTime:this.overrideColorInfoStatic.overrideComponentsColorTime}}),this.overrideColorInfoStatic.isPatch=!1}TimeStaticDispatchEvent(){this.changeStateTime.isPatch&&this._disPatchIsolateEvent(),this.overrideColorInfoStatic.isPatch&&this._disPatchOverrideColorEvent()}isUseCompressedNormal(){return this.materialManager.useCompressedNormal}applyReplacement(){this.filter.enableStateChanged()}traversePluginModels(e,t){this.plugins.forEach((i=>{t&&i.preUpdate&&i.preUpdate(),i.traversePluginModels((t=>{e&&e(t)})),t&&i.update&&i.update()}))}_downloadPMTexture(){}setForceLoadModel(e){this.forceLoad=r.Utils.defaultValue(e,!1)}}r.BimTilesModel=i}(),function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._initOutlineContent(),this._loader=e._loader,this.contentBufferNum=0,this._copyMeshes=null,this._hasLine=!1,this._lodMeshMap={},this._instanceCopyMeshes={}}destroy(){this._outlineContent&&(this._outlineContent.destroy(),this._outlineContent=void 0),super.destroy(),this._loader=null,this.clearCopyMeshes(),this._lodMeshMap=null}_initOutlineContent(){this._outlineContent=new r.BimTileOutlineContent(this._tile)}update(e){this._state===r.TileContentProcessState.PENDING&&(this._state=r.TileContentProcessState.PROCESSING,this._isSharedInstanceBlobMarked()?this._parseSharedContentBlock(e):this._parseContentBlock(e)),this._state===r.TileContentProcessState.SUB_PROCESSED&&this._updateLodContent(e),this._state,r.TileContentProcessState.PROCESSED,this._updateOutlineContent()}_updateLodContent(e){const t=this._tile,i=t._tileset.instanceLodMeshPool;if(i.isModelReady(t.instanceId,t.insLodLevel,t.contentId))return void(i.isAllModelReady(t.instanceId,t.contentId)&&(this._state,r.TileContentProcessState.PROCESSED));this._state=r.TileContentProcessState.SUB_PROCESSING;const n=t._loader,a=n.bimTileParser[r.TileContentType.DATA_INSTANCE],s=i.getLodMeshInfo(t.instanceId,t.insLodLevel).modelUrl;if(void 0!==t.isInstanceLodMeshLoaded(s))return;const o=t.nodeIndexId,l=t.entityInfos;l.curInsLodLevel=t.insLodLevel,l.entityID=s,a._parseInstanceMeshBlob(s,l,t,o,n,(()=>{this._state=r.TileContentProcessState.SUB_PROCESSED,i.setModelState(t.instanceId,l.curInsLodLevel,t.contentId,r.TileContentState.READY),i.isAllModelReady(t.instanceId,t.contentId)&&(this._state,r.TileContentProcessState.PROCESSED),e.afterRenderFns.push((function(){}))}))}_updateOutlineContent(){this._outlineContent&&this._ready&&this._tile.isOutlineActivated()&&this._outlineContent.update()}parseTileContent(e){const t=this;if(this._tile.contentTypeInstance)this._loader.parseTileContent(this._tile,(i=>{r.Utils.defined(t._tile)&&e(i)}));else{this.contentBufferNum=Object.keys(this._contentBuffer).length;for(const i in this._contentBuffer)i===this._tile.getAbsoluteContentUrl()?this._loader.parseTileContent(this._tile,(i=>{this.contentBufferNum--,0===this.contentBufferNum&&r.Utils.defined(t._tile)&&e(i)})):this._loader.parseTileLineContent(this._tile,(i=>{this.contentBufferNum--,0===this.contentBufferNum&&r.Utils.defined(t._tile)&&e(i)}))}}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}attachToTilesGroup(e){const t=e.contentType===r.TileContentType.DATA_INSTANCE?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.GEOMETRY);t.add(this.meshes),t.updateMatrixWorld(!0)}getCopyMeshes(){if(r.Utils.defined(this._copyMeshes))return this._copyMeshes;this._copyMeshes=new THREE.Group,this._copyMeshes.name=this._meshes.name,this._copyMeshes.castShadowIgnoreVisible=this._meshes.castShadowIgnoreVisible;return(this._tile.contentTypeInstance?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.GEOMETRY)).add(this._copyMeshes),this._copyMeshes.matrix.copy(this._meshes.matrix),this._copyMeshes.matrixAutoUpdate=!1,this._copyMeshes.updateMatrixWorld(!0),this._copyMeshes}clearCopyMeshes(){this._copyMeshes&&this._copyMeshes.clear()&&this._copyMeshes.parent.remove(this._copyMeshes),this._copyMeshes=null,this._instanceCopyMeshes={}}disposeGeometryRelatedResource(){const e=this._tile;if(!e.isInstanceTile)return;const t=e.contentInsModel;e._tileset._loader.getInstanceParser().disposeSharedGeometryAttributes(t)}disposeGeometryAttributes(e,t){const i=this._tile;if(!i.isInstanceTile)return;const r=i.contentInsModel,n=i._tileset._loader.getInstanceParser();if(!n.isUseSharedGeometryAttributesByOthers(r))return;const a=n.getSharedGeometryAttributeNames(r,t);if(!a)return;const s=e.geometry;a.forEach((e=>{"index"===e&&s.index?s.index=null:s.hasAttribute(e)&&s.deleteAttribute(e)}))}isOutlineContentReady(){return this._outlineContent.contentReady}get hasLine(){return this._hasLine}set hasLine(e){this._hasLine=e}_createContentMesh(e){const t=this._tile,i=t.insLodLevel;this.parseTileContent((n=>{if(this._ready=!0,this._tile.enableDynamicInstanceLod()){this._state=r.TileContentProcessState.SUB_PROCESSED,this.attachToTilesGroup(n),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0;t._tileset.instanceLodMeshPool.setModelState(t.instanceId,i,t.contentId,r.TileContentState.READY)}else this._state=r.TileContentProcessState.PROCESSED,this.attachToTilesGroup(n),this.disposeContentBuffer(),t._clearMeshBuffer(),t._clearLineBuffer(),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0,e.afterRenderFns.push((function(){}))}))}_parseContentBlock(e){const t=this._tile;t.parseContentBlock(this._contentBuffer,(()=>{t.handleSharedInstanceBlob(),this._createContentMesh(e)}))}_parseSharedContentBlock(e){this._createContentMesh(e)}_isSharedInstanceBlobMarked(){return this._sharedInstanceBlobMarked}markSharedInstanceBlob(){this._sharedInstanceBlobMarked=!0}getLodVisibleMeshList(){const e=this._tile;if(!e.enableDynamicInstanceLod())return this._meshes.children;const t=e.realLodLevel,i=this._lodMeshMap,r=i[t];if(r)return r;for(const e in i)if(Object.hasOwnProperty.call(i,e)){const t=i[e];if(t)return t}return console.log("[BIMFACE ERROR]: Failed to get lod visible mesh list, the current tile content is not loaded."),null}updateRealLodLevel(e){const t=e._tileset.instanceLodMeshPool;if(!t)return;const i=e.instanceId,r=e.insLodLevel,n=t.getRealLodLevel(i,r);this._lodMeshMap[n]&&(e.realLodLevel=n,this._loader.setLodMeshVisibleInfo(e.nodeIndexId,n))}updateInstanceLodVisible(e){const t=this._tile;this.updateRealLodLevel(t);let i=t.realLodLevel;this._meshes.children.forEach((e=>{e.visible=!1,!0===e.insLodLevels[i]&&(1!=t.isTransparentByFilter?(void 0!==t.meshLevelVisibleMap[e.uuid]&&(e.visible=t.meshLevelVisibleMap[e.uuid]),e.isCopyMesh||(e.visible=!0)):1==e.material.transparent&&(e.visible=!0))}))}addLodMeshNode(e,t,i,r){const n=this._tile;this._lodMeshMap[i]||(this._lodMeshMap[i]=[]),e.insLodLevels||(e.insLodLevels={}),e.insLodLevels[i]=!0,this._lodMeshMap[i].push(e),r&&this._meshes.add(e),this._loader.setLodMeshVisibleInfo(n.nodeIndexId,i);n._tileset.instanceLodMeshPool.insId_lodInfo_map[this._tile.instanceId]}}r.BimTileContent=e}(),r.BimTileOutlineContent=class{constructor(e){this._tile=e,this._url=void 0,this._state=r.TileContentProcessState.PENDING,this._request=void 0,this._destroyed=!1,this._buffer=void 0,this._outlineMeshes=new THREE.Group,this._outlineMeshes.name=r.Utils.getEncodedString(this._tile.getAbsoluteContentUrl())||e.name,this._outlineMeshes.databagId=e._databagId,this._outlineMeshes.fileId=e._fileId,this._outlineMeshes.matrixAutoUpdate=!1}destroy(){this._destroyed=!0,this._request&&(this._request.destroy(),this._request=void 0),this.disposeLineGeometry(),this._buffer=void 0,this._outlineMeshes=void 0,this._tile=void 0}isDestroyed(){return this._destroyed}get contentReady(){return this._state===r.TileContentProcessState.READY}get outlineMeshes(){return this._outlineMeshes}set visible(e){this._outlineMeshes.visible=e}disposeLineGeometry(){this._outlineMeshes.parent&&this._outlineMeshes.parent.remove(this._outlineMeshes);const e=this._outlineMeshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t],r=i.geometry;r.dispose(),r.groups=void 0,r.index=void 0,r.attributes=void 0,i.geometry=void 0,i.material=void 0}}requestContent(){const e=this._tile,t=new r.Request({throttle:!0,type:e._tileset.type,url:e.getOutlineContentUrl(),priorityCallback:e._createPriorityCallback(e)});this._request=t;const i=this._fetchContent(t);if(!i)return!1;const n=this._state;this._state=r.TileContentProcessState.LOADING;const a=this._handleFailedContent(this,e._tileset),s=e._tileset.statistics;return s.incrementNumberOfPendingRequests(),i.then((e=>{if(this.isDestroyed())return void a();s.decrementNumberOfPendingRequests(),this._state=r.TileContentProcessState.LOADED;const t=Object.keys(e);this._buffer=e[t[0]]})).catch((e=>{if(t.state===r.RequestState.CANCELLED)return this._state=n,this.handleAfterRequestCancelled(),s.decrementNumberOfPendingRequests(),void s.incrementNumberOfAttemptedRequests();a(e)})),!0}handleAfterRequestCancelled(){}_fetchContent(e){const t=this;e.requestCallback=function(){const i=new r.Deferred;return t._loadArrayBuffer(e.url,i),i.promise},e.cancelCallback=function(){};const i=r.RequestScheduler.request(e);if(i)return i.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}_handleFailedContent(e,t){return function(i){e._state===r.TileContentProcessState.PROCESSING?t.statistics.decrementNumberOfTilesProcessing():t.statistics.decrementNumberOfPendingRequests(),e._state=r.TileContentProcessState.FAILED}}_loadArrayBuffer(e,t){this._tile.fetchContentBlock([e],(function(e){t.resolve(e)}),(function(e){t.reject(e)}))}parseContentBlock(){this._state=r.TileContentProcessState.PROCESSING,this._tile.parseOutlineContentBlock(this._buffer,(()=>{this._state=r.TileContentProcessState.PROCESSED}))}createMesh(){const e=this._tile,t=e._loader;this._state=r.TileContentProcessState.CONSTRUCTING,t.parseTileOutlineContent(e,(()=>{if(this.isDestroyed())return this._state=r.TileContentProcessState.FAILED,void this.disposeContentBuffer();this._state=r.TileContentProcessState.READY,this.updateContentLength(),this.attachToTilesGroup(e),this.disposeContentBuffer()}))}disposeContentBuffer(){this._buffer=void 0}attachToTilesGroup(e){const t=e.contentType===r.TileContentType.DATA_INSTANCE?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.WIREFRAME);t.add(this.outlineMeshes),t.updateMatrixWorld(!0)}updateContentLength(){this._tile.updateContentLength(this._buffer.byteLength)}processState(){this._state===r.TileContentProcessState.PENDING&&this.requestContent(),this._state===r.TileContentProcessState.LOADED&&this.parseContentBlock(),this._state===r.TileContentProcessState.PROCESSED&&this.createMesh(),this._state,r.TileContentProcessState.READY}update(){this.processState()}},function(){class e extends r.AbstractTile{constructor(e,t,i,n){super(e,t),this._loader=e._loader,this._header=i,this._contentFolder=n,this.matrix=new THREE.Matrix4,this.localIndexList=[],this.userIndexMap=new Map,this.isInstanceTile=!1,this.explodeCount=0,this.needUpdateFilter=!1,this._resource=void 0,this.loadedCount=0,this.loadedLineCount=0,this.loadedOutlineCount=0,this._fetchContentBlockBind=this.fetchContentBlock.bind(this),this._getTilesetContentCallbackBind=this._getTilesetContentCallback.bind(this),this.subBimTilesType=null,this.refineStop=!1,this._isHideByFilter=!1,this.childMaxGeoFactor=1,this.instanceId=void 0,this.maxNodeLen=void 0,this.maxNodeSSE=void 0,this.insLodLevel=void 0,this.stateLodChangedRenderer=new Array(5).fill(r.EnumChangedState.NONE),this.stateLodWireFrameChangedRenderer=new Array(5).fill(r.EnumChangedState.START),this.selectionLodChangedRenderer=new Array(5).fill(r.EnumChangedState.NONE),this.explodeLodCount=new Array(5).fill(0),this.entityIDLodLevelMap={},this.meshLevelVisibleMap={},r.Utils.defined(i.isExterior)&&(this._isExterior=i.isExterior),r.Utils.defined(i.isShadowExterior)&&(this._isShadowExterior=i.isShadowExterior),this.contentRootId=void 0,this.forceLoad=r.Utils.defaultValue(e.forceLoad,!1)}destroy(){super.destroy(),this.matrix=void 0,this._loader=void 0,this._header=void 0,this._contentFolder=void 0,this.localIndexList=void 0,this._resource&&(this._resource.destroy(),this._resource=void 0),this._fetchContentBlockBind=void 0,this._getTilesetContentCallbackBind=void 0,this.stateLodChangedRenderer=null,this.explodeLodCount=null,this.stateLodWireFrameChangedRenderer=null,this.selectionLodChangedRenderer=null,this.entityIDLodLevelMap=null,this.meshLevelVisibleMap=null,this.contentRootId=void 0}build(){this._parseTile(this._tileset,this,this._header,this._contentFolder)}_parseTile(e,t,i,n){i.meshFileMap&&(e.instanceLodMeshPool=new r.BimTileInstanceLodMeshPool(e,i.meshFileMap,n),this._loader.enableDynamicInstanceLod=!0),t.boundingBox=r.TilesUtil.getBox(i.boundingVolume),i.refine?("replace"!==i.refine&&"add"!==i.refine||console.warn("lowercase-refine",'This tile uses a lowercase refine "'+i.refine+'". Instead use "'+i.refine.toUpperCase()+'".'),t.refineReplace="REPLACE"===i.refine.toUpperCase()):t.parent?t.refineReplace=t.parent.refineReplace:t.refineReplace=!0,t.geometricError=i.geometricError<r.TilesUtil.SIX_ACCURACY?t._parent?t._parent.geometricError:1/r.TilesUtil.Minimum_Setting_SSEHold:i.geometricError,i.geScale&&(t.geScale_instanceLeafTile=i.geScale),t.contentIndex=null;let a=Boolean(i.refineStop);if(t.refineStop=!!r.Utils.defined(i.refineStop)&&a,t.childMaxGeoFactor=r.Utils.defined(i.childMaxGeoFactor)?i.childMaxGeoFactor:1,i.content?(t.contentId=i.content.id,t.contentUrl=i.content.uri||i.content.url,t.contentType=i.content.type,t.blobId=i.content.blobId,t.contentIndex=n+t.contentUrl,t.contentInsModel=r.Utils.isDefined(i.content.model)?i.content.model:null,t.contentType===r.TileContentType.DATA_INSTANCE&&(t.isInstanceTile=!0,t.maxNodeLen=i.content.maxNodeLen,t.instanceId=i.content.instanceId,t.contentUrl&&null===t.contentInsModel&&(t.contentInsModel=e.instanceLodMeshPool&&e.instanceLodMeshPool.getLodMeshInfoRecursive(t.instanceId,4).modelUrl)),t._contentInsModelIndex=r.Utils.isDefined(t.contentInsModel)?n+t.contentInsModel:null,void 0!==i.content.index&&(t.contentCMPTIndex=i.content.index),void 0!==i.content.offset&&(t.contentCMPTOffset=i.content.offset),void 0!==i.content.size&&(t.contentCMPTSize=i.content.size),t.contentRootId=t.parent&&void 0!==t.parent.contentRootId?t.parent.contentRootId:t.uniqueTileId):(t.contentType=r.TileContentType.DATA_NULL,t.contentRootId=t.parent&&t.parent.contentRootId),i.outline&&(t.contentOutlineId=i.outline,t.contentOutlineUrl=n+i.outline),r.Utils.isDefined(i.visibilityPriority)?t._visibilityPriority=i.visibilityPriority:r.Utils.isDefined(t.parent)&&(t._visibilityPriority=t.parent._visibilityPriority),t.detailLevel=r.Utils.isDefined(i.detailLevel)?i.detailLevel:4,t.contentTypeNull&&(t._content=t.createEmptyContent(),t._contentState=r.TileContentState.READY),t.contentTypeTile&&(t.isTilesetContent=!0),i.transform&&16===i.transform.length&&t.matrix.fromArray(i.transform),void 0!==i.castShadow&&(t.castShadow=i.castShadow),t._parent&&void 0!==t._parent.castShadow&&(t.castShadow=t._parent.castShadow),t._parent&&1==t._parent.isExterior&&(t.isExterior=!0),t._parent&&1==t._parent.isShadowExterior&&(t.isShadowExterior=!0),t._parent?t.matrix=t._parent.matrix.clone().multiply(t.matrix):t.matrix.identity(),t.boundingBox=r.TilesUtil.getBox(i.boundingVolume,t.matrix),t._parent&&t._parent.refineReplace?t._parent.contentTypeEmpty?t._debugLodLevel=t._parent._debugLodLevel:t._debugLodLevel=t._parent._debugLodLevel+1:t.refineReplace&&(t._debugLodLevel=0),t.level=t.refineReplace?t._debugLodLevel:t.detailLevel,i.visibilityBoxs)for(let e of i.visibilityBoxs)this.visibilityBoxs.push(r.TilesUtil.getBox(e.visbox));if(i.shadowVisibilityBoxs&&(t.isShadowExterior=!0),i.properties&&i.properties.LocalIndex){i.properties.LocalIndex.map((e=>{const t={box:r.TilesUtil.getBox(e.boundingVolume),url:n+e.content.url};this.localIndexList.push(t),this._loader.addSearchTree(t.url,t.box)}))}if(i.properties&&i.properties.layerKey&&(this.layerInfo[i.properties.layerKey]&&console.warn("repeated Key"),this.layerInfo[i.properties.layerKey]=i.properties.layerValue),t.contentTypeMeshAvailable&&e.contenEntiyNum++,i.children)for(const r of i.children){const i=this._createNewTile(e,t,r,n);i.build(),i._generateNodeId()}}clone(e,t,i){return r.Utils.defined(i)||(i=this._createNewTile(e,t)),super.clone(i),i._loader=e._loader,i._header=this._header,i._contentFolder=this._contentFolder,i.matrix=this.matrix.clone(),i.localIndexList=this.localIndexInfo,i.userIndexMap=this.userIndexMap,i.isInstanceTile=this.isInstanceTile,i.isTilesetContent=this.isTilesetContent,i._id=this._id,i.forceLoad=options.forceLoad,i._tileset=e,i}fetchContentBlock(e,t,i){let n=e.length,a={};for(let s=0;s<n;++s){const o=r.RequestSpliter.splitByUrlMd5(e[s]);this.contentTypeCMPT?this._loader.loadCMPTArrayBufferImmediately(o,(function(i){n--,a[e[s]]=i,0===n&&t(a)}),(function(e){i(e)})):this._loader.loadArrayBufferImmediately(o,(function(i){n--,a[e[s]]=i,0===n&&t(a)}),(function(e){i(e)}))}}parseCMPTContentBlock(e,t){const i=this._loader.tileReader;this.arrayBufferNum=1;for(const n in e){const a={node:this,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH,url:this.getAbsoluteContentUrl()},s=r.RequestSpliter.splitByUrlMd5(n);let o=this._loader.CMPTUrlMap[s].buffer.slice(this.contentCMPTOffset,this.contentCMPTOffset+this.contentCMPTSize);i.parseBlock(o,a,(()=>{this.arrayBufferNum--,o=null,0===this.arrayBufferNum&&t(e)}))}}parseContentBlock(e,t){if("CMPT"===this.contentType)return this.parseCMPTContentBlock(e,t);const i=this._loader.tileReader;this.arrayBufferNum=Object.keys(e).length;for(const r in e){let n=i.getBlockType(this.contentType),a=this.getAbsoluteContentUrl();r!==a&&(n=proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,a=this.getOutlineContentUrl());const s={node:this,type:n,url:a};i.parseBlock(e[r],s,(()=>{this.arrayBufferNum--,0===this.arrayBufferNum&&t(e)}))}}parseLineContentBlock(e,t){const i=this._loader.tileReader,r={node:this,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,url:this.getAbsoluteContentUrl()};i.parseBlock(e,r,(function(){t(e)}))}parseOutlineContentBlock(e,t){const i=this._loader.tileReader,r={node:this,outline:!0,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,url:this.getOutlineContentUrl()};i.parseBlock(e,r,(function(){t(e)}))}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):new r.BimTileContent(this,e)}getAbsoluteContentFolder(){return this._contentFolder}computeMeshNodeCount(e){this.loadedCount=0,this.loadedLineCount=0;for(let c in this.buffer){var t=this.getBuffer(c);if(t.type==proto.BlockHeader.BlockType.BT_MESH){var i=t.content;if(i)for(var r=i.getScenesList(),n=r.length,a=0;a<n;++a)for(var s=r[a].getNodesList(),o=s.length,l=0;l<o;++l){var d=s[l],h=i.getNodesList()[d];this.getNodeCount(h,i,e)}}}}getNodeCount(e,t,i){const r=e.getPrimitivesList();e.getPrimitivesList().length;var n=e.getNodeType();(!0===i&&n!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE||!1===i&&n!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_MAIN_NODE)&&r.map((e=>{switch(t.getPrimitivesList()[e].getMode()){case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES:case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_POINTS:this.loadedCount++;break;case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES:this.loadedLineCount++}}));var a=e.getChildrenList();if(0!==a.length)for(const e of a){var s=t.getNodesList()[e];this.getNodeCount(s,t,i)}}computePointNodeCount(){this.loadedCount=0;for(let r in this.buffer){var e=this.getBuffer(r);if(e.type==proto.BlockHeader.BlockType.BT_POINT){var t=e.content;if(t){var i=t.getPointsList();this.loadedCount=i.length}}}}computeLineNodeCount(){this.loadedLineCount=0;for(let e in this.lineBuffer){const t=this.getLineBuffer(e);if(t.type!=proto.BlockHeader.BlockType.BT_LINE)continue;const i=t.content;if(!i)continue;const r=i.getScenesList();for(let e=0,t=r.length;e<t;++e){const t=r[e].getNodesList();this.loadedLineCount+=t.length}}}computeOutlineNodeCount(){this.loadedOutlineCount=0;for(let e in this.outlineBuffer){const t=this.getOutlineBuffer(e);if(t.type!=proto.BlockHeader.BlockType.BT_LINE)continue;const i=t.content;if(!i)continue;const r=i.getScenesList();for(let e=0,t=r.length;e<t;++e){const t=r[e].getNodesList();this.loadedOutlineCount+=t.length}}}_clearAllBuffer(){this._clearMeshBuffer(),this._clearLineBuffer(),this._clearOutlineBuffer()}_clearBufferData(e){for(let t in e)e[t].content&&(e[t].content=null),e[t]=null}_clearMeshBuffer(){this.buffer&&(this._clearBufferData(this.buffer),this.buffer=null)}_clearLineBuffer(){this.lineBuffer&&(this._clearBufferData(this.lineBuffer),this.lineBuffer=null)}_clearOutlineBuffer(){this.outlineBuffer&&(this._clearBufferData(this.outlineBuffer),this.outlineBuffer=null)}getBuffer(e){return this.buffer[e]}getLineBuffer(e){return this.lineBuffer[e]}getOutlineBuffer(e){return this.outlineBuffer[e]}disposeMeshNodeById(e){this._loader.disposeMeshNodeById(e)}disposeInstanceMeshNodeById(e){this._loader.disposeInstanceMeshNodeById(e)}disposeLineNodeById(e){this._loader.disposeLineNodeById(e)}disposeInstanceLineNodeById(e){this._loader.disposeInstanceLineNodeById(e)}onSelectionChanged(){const e=this._loader.tileReader,t=this._loader.filter.model.id,i=this._loader.sceneState.selectionSet[t];if(this.selection={},void 0===i||0===i.size)return!1;for(const t of this.userIndexMap.keys()){const r=e.getUserIdByIndex(t);i.get(r)&&(this.selection[r]=!0)}if(Object.keys(this.selection).length===Object.keys(this.preSelection).length){for(const e in this.selection)if(!this.preSelection[e])return this.preSelection=Object.assign(this.selection),!0;return!1}return this.preSelection=Object.assign(this.selection),!0}applyGlowEffect(){if(this.stateChangedRenderer!==r.EnumChangedState.NONE)return;const e=this._loader.filter.model,t=e.viewer.rendererManager.renderer.composer;t&&t.applyGlowEffectByModel(e,this)}applyFilter(){if(this._loader.disableUserData)return;const e=this._loader.filter;this.stateChangedRenderer===r.EnumChangedState.NONE&&(this.stateChangedRenderer=r.EnumChangedState.START,e.enableTileLoadedStateChanged());let t=this._loader.filter.model.changeStateTime;t.meshTimeStart(),this.isInstanceTile?this.enableDynamicInstanceLod()?(this.stateLodChangedRenderer[this.insLodLevel]===r.EnumChangedState.NONE&&(this.stateLodChangedRenderer[this.insLodLevel]=r.EnumChangedState.START,e.enableTileLoadedStateChanged()),e.instanceLodApply(this),e.wireFrameInstanceLodApply(this)):(e.instanceApply(this),e.wireFrameInstanceApply(this)):(e.standardApply(this),e.wireFrameStandardApply(this)),t.meshTimeEnd(),e.applyTileMeshForFlatten(this)}applySelection(){if(this._loader.disableUserData)return;const e=this._loader.filter.model.pickingManager;e.selectionChangedRenderer!==r.EnumChangedState.NONE&&(e.updatePickingMeshes(this),e.updatePickingWireFrame(this))}applyOnDemand(){if(!this.isInstanceTile)return;const e=this._tileset.onDemandManager;!1!==e.onDemand&&e.instanceApply(this)}explode(){if(this.isOutlineLoading())return;const e=this._loader.modelExplosion;this.isInstanceTile?(this.content.updateRealLodLevel(this),e.instanceExplode(this)):e.standardExplode(this)}_generateNodeId(e){let t=e;if(!r.Utils.defined(t)){const e=this._header.content;if(r.Utils.defined(e)){const i=e.uri||e.url;t=`${this._contentFolder}_${i}`,this.contentCMPTIndex&&(t+=`_${this.contentCMPTIndex}`)}else t=`${this._contentFolder}_root`}return this._id=r.Utils.getEncodedString(t),this._id}setByteLength(e){}requestContent(){if(this._requestContentWithSharedInstanceBlob())return!0;return this._requestContent()}_requestContent(){const e=new r.Request({throttle:!0,type:this._tileset.type,priorityCallback:this._createPriorityCallback(this)});this._request=e;const t=this._getResource();t.setRequest(e);const i=t.fetch({fetchCallback:this._getContentBlockCallback()});if(!i)return!1;this._initSharedInstanceBlob();const n=this._contentState;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const a=this._tileset.statistics;a.incrementNumberOfPendingRequests();const s=this._handleFailedContent(this,this._tileset),o=this;return i.then((function(e){if(!o.isDestroyed())return o._content=o.createContent(e),o._contentState=r.TileContentState.PROCESSING,o._contentProcessDeferred.resolve(o._content),a.decrementNumberOfPendingRequests(),o._content.readyPromise.then((function(e){o._contentState=r.TileContentState.READY,o._contentReadyDeferred.resolve(e)}));s()})).catch((function(i){if(o._contentProcessDeferred.destroy(),o._contentProcessDeferred=void 0,o._contentReadyDeferred.destroy(),o._contentReadyDeferred=void 0,e.state===r.RequestState.CANCELLED)return o._contentState=n,a.decrementNumberOfPendingRequests(),void a.incrementNumberOfAttemptedRequests();s(i),t.retryOnError()&&(o._disposeSharedInstanceBlob(),e.state=r.RequestState.UNISSUED,e.deferred=void 0,o._contentState=n)})),!0}_getResource(){const e=this._resource;if(e)return e;const t=this.getAbsoluteContentUrl();return this._resource=r.Resource.create({url:this.isTilesetContent?t:[t]}),this._resource}_getContentBlockCallback(){return this.isTilesetContent?this._getTilesetContentCallbackBind:this._fetchContentBlockBind}unloadContent(){this._resource&&(this._resource.destroy(),this._resource=void 0),this.userIndexMap&&(this.userIndexMap=new Map),this._contentState!==r.TileContentState.UNLOADED&&this._disposeSharedInstanceBlob(),this.stateLodChangedRenderer.fill(r.EnumChangedState.NONE),this.stateLodWireFrameChangedRenderer.fill(r.EnumChangedState.START),super.unloadContent()}_getTilesetContentCallback(e,t,i){this._loader.loadJsonImmediately(e,t,i)}checkIfProcessingTileAvailable(){if(this.isDestroyed())return!1;if(!this.content)return!1;if(this.enableDynamicInstanceLod()){if(!this.content._state===r.TileContentProcessState.SUB_PROCESSING)return!1}else if(!this.contentProcessing)return!1;return!0}checkIfTileAvailable(){return!this.isDestroyed()&&!(!this.content||!this.contentAvailable)}_createNewTile(e,t,i,n){return new r.BimTileNode(e,t,i,n)}isOutlineActivated(){return!!this.getOutlineContentUrl()&&this._tileset.isOutlineEnabled()}get needsLoading(){return!this.contentReady||this.isOutlineLoading()}isOutlineLoading(){return!!this.isOutlineActivated()&&!this._content.isOutlineContentReady()}createEmptyContent(){return new r.TileEmptyContent(this)}_getInstanceBlobManager(){return this._loader.getInstanceParser().getSharedInstanceManager()}_requestContentWithSharedInstanceBlob(){if(!this._isSharedInstanceTile())return!1;const e=this._getSharedInstanceBlobId(),t=this._getInstanceBlobManager();if(!t.hasInstance(e))return!1;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const i=this._tileset.statistics;i.incrementNumberOfPendingRequests();const n=this._handleFailedContent(this,this._tileset);return t.parseInstance(e).then((e=>{if(!this.isDestroyed()&&e)return this._content=this.createContent(),this._content.markSharedInstanceBlob(),this._setInstanceBlob(e),this._content.geometryByteLength=e.byteLength,this._contentState=r.TileContentState.PROCESSING,this._contentProcessDeferred.resolve(this._content),i.decrementNumberOfPendingRequests(),this._content.readyPromise.then((e=>{this._contentState=r.TileContentState.READY,this._contentReadyDeferred.resolve(e)}));n()})).catch((e=>{console.log(e),this._contentProcessDeferred.destroy(),this._contentProcessDeferred=void 0,this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0,n(e)})),!0}_getSharedInstanceBlobId(){return this._contentUrl}_disposeSharedInstanceBlob(){if(!this._isSharedInstanceTile())return;const e=this._getSharedInstanceBlobId();this._getInstanceBlobManager().disposeInstance(e)}_isSharedInstanceTile(){if(!this.isInstanceTile)return!1;return!!this._loader.getInstanceParser().getSharedInstanceManager}_initSharedInstanceBlob(){if(!this._isSharedInstanceTile())return;const e=this._getSharedInstanceBlobId();this._getInstanceBlobManager().initInstance(e)}handleSharedInstanceBlob(){if(!this._isSharedInstanceTile())return;const e=this._getSharedInstanceBlobId(),t=this._getInstanceBlobManager(),i={contentBlob:this.buffer.content,contentType:this.buffer.type,byteLength:0};t.handleInstance(e,i)}_setInstanceBlob(e){this.buffer={content:e.contentBlob,type:e.contentType}}get isHideByFilter(){return this._isHideByFilter}set isHideByFilter(e){this._isHideByFilter=e}activateRenderables(){this._isHideByFilter||(this.contentVisible=!0,this.enableDynamicInstanceLod()&&this.content.updateInstanceLodVisible(this.insLodLevel))}_isFirstCountMeshChangedTime(){let e=this._loader.filter.model;return e.isStateChangeTimeRecord()&&e.changeStateTime.isPatch}passSSE_forTraverse(e){return!!this._isExploded()||this.sse*this.childMaxGeoFactor>=e.maximumScreenSpaceError}updateVisibilityV3(e,t){if(this.numberOfUpdateVisibilityFrame==e.frameNumber)return;this.numberOfUpdateVisibilityFrame=e.frameNumber;const i=this.computeTransformedBoundingBox(e);this.visible=this.culling(e,i),this.visible?(this.computeVisibility(e),this.computeAvailableDepth(),this.contentTypeEmpty&&!this.refineStop?(this.sse=0,this._distance=9999,this.priorityDegradation=!0):(this.computeDistanceToCamera(e),this.computeSSE_And_InsLod(e),this.priorityDegradation=this.isPriorityDegradation(e),this.adjustSseIfNeededV3(t))):(this.sse=0,this._distance=9999,this.priorityDegradation=!0,void 0!==this.maxNodeLen&&(this.insLodLevel=4))}adjustSseIfNeededV3(e){this._tileset.degradeEnabled&&1!==this._tileset.degradedFactor&&this.priorityDegradation&&!e&&(this.sse=this.sse*this._degradedFactor)}updateVisibility_onlyVis(e){if(this.numberOfUpdateVisibilityFrame==e.frameNumber)return this.visible;const t=this.computeTransformedBoundingBox(e);this.visible=this.culling(e,t),this.visible||(this.sse=0,this._distance=9999,this.priorityDegradation=!0)}computeSSE_And_InsLod(e){const t=void 0!==e.geoErrScaleFactor?e.geoErrScaleFactor:1,i=e.cameraPreSSE/this._distance;if(this.sse=i*this.geometricError,void 0===this.maxNodeLen)return void(this.sse*=t);this.maxNodeSSE=i*this.maxNodeLen*t;const r=[400,200,80,30],n=r.length;this.insLodLevel=0;let a=r[0];for(;this.maxNodeSSE<a&&this.insLodLevel<n;)++this.insLodLevel,a=r[this.insLodLevel]}enableDynamicInstanceLod(){return void 0!==this.insLodLevel}isInstanceLodTileContentAllReady(){const e=tileNode._tileset.instanceLodMeshPool.getLodMeshInfoRecursive(tileNode.instanceId,tileNode.insLodLevel);entityID=e.modelUrl}updateInstanceLodLevelInfo(e,t){return this.realLodLevel=t,this.entityIDLodLevelMap[e]?(this.entityIDLodLevelMap[e][t]=!0,!1):(this.entityIDLodLevelMap[e]={},this.entityIDLodLevelMap[e][t]=!0,!0)}isInstanceLodMeshLoaded(e){if(this.entityIDLodLevelMap[e])for(const t in this.entityIDLodLevelMap[e])return t}getRepeatedInstanceLodLevel(e){for(const t in this.entityIDLodLevelMap){const i=this.entityIDLodLevelMap[t];if(i[e])return Object.keys(i)}}getActualBoundingBoxWorld(){return this._tileset.isDataVersion3()?this._globaledBoundingBox:this._transformedBoundingBox}culling(e,t){if(!this._tileset.isDataVersion3())return super.culling(e,t);const i=this._isExploded(),r=this._isExplosionStateChanged(i);if(this._holdExplosionState(i),!i)return(e.globalMatrixUpdated||t||r)&&this._globaledBoundingBox.copy(this._transformedBoundingBox),!!this.forceLoad||e.frustumWc.intersectsBox(this._globaledBoundingBox);const n=this._getExplodedBoundingBox();return n&&this._globaledBoundingBox.copy(n),!0}_getExplodedBoundingBox(){if(this.contentTypeEmpty)return;const e=this.contentId,t=this._loader.filter.model.id;return this._loader.filter.model.manager.explosionManager.getExplosedTileBoundingBox(t,e)}_holdExplosionState(e){this._explosionStateLast=e}_isExplosionStateChanged(e){return this._explosionStateLast!==e}}r.BimTileNode=e}(),r.BimTileMeshParser=class{constructor(e){this.materialManager=e.materialManager,this.batchMergeEnabled=e.batchMergeEnabled,this.delayLoadTexture=e.delayLoadTexture,this.renderFunction=e.renderFunction}destroy(){this.materialManager=null,this.renderFunction=null}loadMesh(e,t){}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getAccColorArray(e,t,i,r){const n=e._getAccInfo(t,r.getAccColor()),a=i.slice(n.offset,n.offset+n.length).buffer;return new Uint8Array(a)}_getAccVertexArray(e,t,i,r){const n=e._getAccInfo(t,r.getAccVertices()),a=i.slice(n.offset,n.offset+n.length).buffer;return new Float32Array(a)}_getAccIndicesArray(e,t,i,r){const n=e._getAccInfo(t,r.getAccIndices()),a=i.slice(n.offset,n.offset+n.length).buffer;let s=null;return s=n.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT?new Uint16Array(a):new Uint32Array(a),s}_getMeshBuffer(e,t,i){var r=i.meshBlob.getBlobHeader(),n=r.getBufferBlockId(),a=r.getMaterialBlockId(),s=(r.getUserdataBlockId(),e.tileReader.getBuffer(t,n,proto.BlockHeader.BlockType.BT_BUFFER)),o=e.tileReader.getBuffer(t,a,proto.BlockHeader.BlockType.BT_MATERIAL);i.buffer=s,i.materialBlockId=a,i.material=o,s&&(i.bufferData=s.getBuffer())}createMeshNode(e,t,i,n,a,s,o){if(!this.checkIfTileAvailable(n))return void this._deleteNodeBuffer(t,n);let l=null;l=i.mode===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES?new r.LineSegmentsEx(a,[s]):new r.MeshEx(a,[s]),i.indexInfos||(i.indexInfos=new Map),l.applyMatrix4(i.matrix),l.name=i.nodeIndexId;var d=e.filter.model;r.GlobalData.EnableShadowMap&&(l.castShadow=d.castShadow,l.receiveShadow=d.receiveShadow),l.indexGroups=i.indexInfos,l.indexCount=a.index.count;for(const e of l.indexGroups.keys())n.userIndexMap.set(e,!0);return e.addMeshIdMap(l.name,l),n.content.meshes.add(l),l.databagId=n.content.meshes.databagId,l.fileId=n.content.meshes.fileId,i.userIdMapIndex&&e.addUserIdMapIndices(i.userIdMapIndex,l.name),e.renderableCount++,this.decreaseLoadedCount(n),this.checkIfTileParseFinish(n)&&(o&&o(n),this.delayLoadTexture||this._deleteNodeBuffer(t,n)),l}createMeshMaterial(e){this.delayLoadTexture?this.createMeshTextureDelay(e):this.createMeshTextureImmediately(e)}createMeshTextureDelay(e){let{that:t,loader:i,meshBufferObject:r,pbfNodeInfo:n,treeNode:a,primitive:s,bufferGeometry:o,onTileContentReadyCallback:l,callback:d}=e,h=t.createMeshNode(i,r,n,a,o,this.materialManager.globalMaterial,l);d&&d(),h&&new Promise((e=>{t.materialManager&&t.materialManager.getMaterial(i,r,s,(t=>{e(t)}))})).then((e=>{void 0!==h.material&&(h.material[0]=e,a._tileset.updateTextureMemoryUsage(a),t.renderFunction())}))}createMeshTextureImmediately(e){let{that:t,loader:i,meshBufferObject:r,pbfNodeInfo:n,treeNode:a,primitive:s,bufferGeometry:o,onTileContentReadyCallback:l,callback:d}=e;new Promise((e=>{t.materialManager&&t.materialManager.getMaterial(i,r,s,(t=>{e(t)}))})).then((e=>{t.createMeshNode(i,r,n,a,o,e,l),d&&d()}))}_deleteNodeBuffer(e,t){e.materialBlockId=void 0,e.contentIndex=void 0,e.bufferId=void 0,e.material=null,e.bufferData=null,e.buffer=null,e.meshBlob=null,e.matrix=null;var i=this.getFullBuffer(t);for(const e in i)i[e].content=null}getFullBuffer(e){return e.buffer}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}decreaseLoadedCount(e){e.loadedCount--}checkIfTileParseFinish(e){return e.loadedCount<=0&&e.loadedLineCount<=0&&e.loadedOutlineCount<=0}getLoadedCount(e){return e.loadedCount}static getBufferData(e){return e._bufferData?e._bufferData:e.getBuffer()}static convertVertexArray(e,t,i){if(!t)return new Float32Array(e);let r;if(i&&i.length>0){let t=new BigUint64Array(e);r=new Float32Array(3*t.length);const n=i[0],a=i[1],s=i[2],o=(BigInt(1)<<BigInt(n))-BigInt(1),l=(BigInt(1)<<BigInt(a))-BigInt(1),d=(BigInt(1)<<BigInt(s))-BigInt(1);for(let e=0,i=t.length;e<i;++e){const i=t[e];let s=i,h=Number(s&o);r[3*e+0]=h,s=i>>BigInt(n),h=Number(s&l),r[3*e+1]=h,s=i>>BigInt(n+a),h=Number(s&d),r[3*e+2]=h}}else{let t=new Uint16Array(e);r=new Float32Array(3*t.length/4);for(let e=0,i=t.length/4;e<i;++e)r[3*e]=t[4*e],r[3*e+1]=t[4*e+1],r[3*e+2]=t[4*e+2]}return r}},function(){class e extends r.BimTileMeshParser{constructor(e){super(e)}_getSubNodeInfo(e,t,i,r,n,a){const s=n.nodeIndex,o=`${r.bufferId}_${s}`;if(n.nodeIndexId=o,i.clearGroups(),i.groups.push({start:0,count:n.iAccInfoCount,materialIndex:0}),t.pbfNodeInfoMap[o]){let e=t.pbfNodeInfoMap[o];return e.userIdMapIndex=[],e}const l=r.meshBlob.getNodesList()[s],d=l.getChildrenList(),h=r.meshBlob;let c=new Map;if(n.userIdMapIndex=[],r.primitiveMaterialId=a.getMaterialId(),d.map(((i,a)=>{const s=h.getNodesList()[i],o=s.getPrimitivesList(),l=o.length;for(let d=0;d<l;d++){const l=o[d],u=h.getPrimitivesList()[l],p=e._addNodeInfo(e,t,h,r,s,u,n,i,a);!1===c.has(p.userId)&&c.set(p.userId,new Map),c.get(p.userId).set(p.meshId,p.subIndexInfo)}})),0===c.size){const i=e._addNodeInfo(e,t,h,r,l,a,n,s,0);c.set(i.userId,new Map),c.get(i.userId).set(i.meshId,i.subIndexInfo)}return n.indexInfos=c,t.pbfNodeInfoMap[o]=n,n}_createIndexGroup(e){return{start:e.indexStart,count:e.indexCount,materialIndex:0,userId:e.userId}}_addNodeInfo(e,t,i,n,a,s,o,l,d){const h=o.nodeIndexId,c=this._getAccInfo(i,s.getAccVertices()),u=this._getAccInfo(i,s.getAccIndices()),p=this._getAccInfo(i,s.getAccTexcoords()),m=`${n.bufferId}_${l}`,f=a.getUserId(),g=(c.offset-o.vAccInfoStart)/4,v=3*c.count;let y=0;if(u.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT)y=(u.offset-o.iAccInfoStart)/2;else y=(u.offset-o.iAccInfoStart)/4;const M=u.count,E=(p.offset-o.tAccInfoStart)/4,x=2*p.count,_=s.getAccColor(),b=this._getAccInfo(i,_),I=(b.offset-o.cAccInfoStart)/4,T=b.count;let S,C;const w=this._getAccInfo(i,s.getAccNormals());w.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE&&(S=(w.offset-o.nAccInfoStart)/2,C=w.count);let R={userId:f,meshId:m,subIndexInfo:{positionStart:g,positionCount:v,indexStart:y,indexCount:M,uvStart:E,uvCount:x,colorStart:I,colorCount:T,cNormalStart:S,cNormalCount:C,preTranslation:void 0}};o.userIdMapIndex.push({userId:f,index:d});const B=r.BimTileMaterialManager.generateMaterialName(n,n.primitiveMaterialId,!1),A={parent:h,matrix:o.matrix,materialId:B,type:proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE,cellId:null};return t.disableUserData?(t.addNoUserDataMeshNodeInfo(f,m,A),R):(t.patchMeshNodeInfo(f,m,A),R)}loadMesh(e,i){let{that:r,loader:n,meshBufferObject:a,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if((o.getAccVertices()<0||o.getAccIndices()<0)&&o.getAccArchive()<0)return void console.warn("invalid acc info");if(r._getMeshBuffer(n,l,a),!a.buffer)return;let h=new THREE.BufferGeometry;const c=a.meshBlob,u=a.bufferData;this._createNormalBuffer(s,h,u,c,o);const p=r._getAccInfo(c,o.getAccVertices()),m=r._getAccVertexArray(r,c,u,o);h.setAttribute("position",new THREE.BufferAttribute(m,3)),s.vAccInfoStart=p.offset;const f=r._getAccInfo(c,o.getAccIndices()),g=r._getAccIndicesArray(r,c,u,o);h.setIndex(new THREE.BufferAttribute(g,1)),s.iAccInfoStart=f.offset,s.iAccInfoCount=f.count,s.tAccInfoStart=0,o.useCompressedUv=!1;t(r._getAccInfo(c,o.getAccTexcoords()),u,o,a,h,s,1);t(r._getAccInfo(c,o.getAccTexcoords2()),u,o,a,h,s,2),this._createColorBuffer(s,h,u,c,o),s=Object.assign(r._getSubNodeInfo(r,n,h,a,s,o)),h.getAttribute("uv2")?o.hasLightMap=!0:o.hasLightMap=!1;const v={that:r,loader:n,meshBufferObject:a,pbfNodeInfo:s,treeNode:l,primitive:o,bufferGeometry:h,onTileContentReadyCallback:d,callback:i};r.createMeshMaterial(v)}_createNormalBuffer(e,t,i,r,n){n.useCompressedNormal=!1;const a=this._getAccInfo(r,n.getAccNormals());if(a.count>0){let r;const s=i.slice(a.offset,a.offset+a.length).buffer;switch(a.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:r=new Uint8Array(s),t.setAttribute("cNormal",new THREE.BufferAttribute(r,2)),e.nAccInfoStart=a.offset,e.nAccInfoCount=a.count,n.useCompressedNormal=!0;break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:r=new Float32Array(s),t.setAttribute("normal",new THREE.BufferAttribute(r,3)),e.nAccInfoStart=a.offset,e.nAccInfoCount=a.count,n.useCompressedNormal=!1}}}_createColorBuffer(e,t,i,r,n){const a=n.getAccColor(),s=this._getAccInfo(r,a);if(s.count<=0||a<=0)return n.vertexColors=!1,!1;const o=this._getAccColorArray(this,r,i,n);let l=s.length/s.count,d=new THREE.Uint8BufferAttribute(o,l);return d.normalized=!0,t.setAttribute("color",d),e.cAccInfoStart=s.offset,e.cAccInfoCount=s.count,n.vertexColors=!0,!0}}function t(e,t,i,r,n,a,s){if(e.count<=0)return;const o=t.slice(e.offset,e.offset+e.length).buffer;let l=null;e.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(i.useCompressedUv=!0,l=new Int16Array(o)):(i.useCompressedUv=!1,l=new Float32Array(o));const d=1===s?"uv":`uv${s}`;n.setAttribute(d,new THREE.BufferAttribute(l,2)),a.tAccInfoStart=e.offset}r.BimTileMeshNodeParser=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){super(e)}destroy(){super.destroy()}loadMesh(e,t){let{that:i,loader:n,meshBufferObject:a,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if((o.getAccVertices()<0||o.getAccIndices()<0)&&o.getAccArchive()<0)return void console.warn("invalid acc info");if(i._getMeshBuffer(n,l,a),!a.buffer)return;const h=a.meshBlob,c=a.bufferData,u=a.material,p=h.getBufferaccsList()[o.getAccArchive()];if(!r.Utils.isDefined(p))return;const m=p.getByteOffset(),f=p.getByteLength(),g=(p.getCount(),c.slice(m,m+f).buffer);r.TilesUtil.getDracoLoader().decodeDracoFile(g,(function(e){if(!(u&&o.getMaterialId()>=-1))return;e.clearGroups(),e.groups.push({start:0,count:e.index.count,materialIndex:0});const r={that:i,loader:n,meshBufferObject:a,pbfNodeInfo:s,treeNode:l,primitive:o,bufferGeometry:e,onTileContentReadyCallback:d,callback:t};i.createMeshMaterial(r)}))}}r.BimTileDracoParser=e}(),function(){let e=new THREE.Matrix4;class t extends r.BimTileMeshNodeParser{constructor(e){super(e)}loadMesh(e,t){let{that:i,loader:r,meshBufferObject:n,pbfNodeInfo:a,primitive:s,treeNode:o,onTileContentReadyCallback:l}=e;if((s.getAccVertices()<0||s.getAccIndices()<0)&&s.getAccArchive()<0)return void console.warn("invalid acc info");if(i._getMeshBuffer(r,o,n),!n.buffer)return;if(!i.checkIfTileAvailable(o))return void i._deleteNodeBuffer(n,o);let d=i._createBatchGeometry(i,r,n,a,s);if(!(n.material&&s.getMaterialId()>=-1))return;const h=i.materialManager.getLineMaterial(r,n,s);i.createMeshNode(r,n,a,o,d,h,l),t&&t()}loadLineInstanceMesh(e,t){let{that:i,loader:n,meshBufferObject:a,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if(!i.checkIfTileAvailable(l))return void i._deleteNodeBuffer(a,l);let h=new THREE.InstancedBufferGeometry;const c=a.meshBlob,u=a.bufferData,p=i._getAccVertexArray(i,c,u,o),m=i._getAccIndicesArray(i,c,u,o);h.setAttribute("position",new THREE.BufferAttribute(p,3)),h.setIndex(new THREE.BufferAttribute(m,1));let f=new r.LineSegmentsEx(h,i.instanceWireframeMaterial);f.name=s.nodeIndexId,f.tileId=s.tileId,f.frustumCulled=!1,h.addGroup(0,h.index.count,0),l.wireFrameVisibilityOption=n.wireFrameVisibilityOption,f.isInstanceMeshNode=!0;const g=this.getContentMeshGroup(l);f.visible=n.isBorderLineVisible(),f.renderOrder=r.EnumRenderOrder.WireFrame,n.disableUserData&&(f.visible=!1),f.databagId=g.databagId,f.fileId=g.fileId,i.setInstanceLineAttributeBuffer(n,l,f);const v=function(e,t){const i=e.geometry,n=new THREE.InstancedBufferGeometry;n.setAttribute("position",i.getAttribute("position")),i.getAttribute("normal")&&n.setAttribute("normal",i.getAttribute("normal")),i.getAttribute("cNormal")&&n.setAttribute("cNormal",i.getAttribute("cNormal")),i.getAttribute("color")&&n.setAttribute("color",i.getAttribute("color")),i.getAttribute("barycentric")&&n.setAttribute("barycentric",i.getAttribute("barycentric")),i.getAttribute("uv")&&n.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&n.setAttribute("uv2",i.getAttribute("uv2")),i.getAttribute("uv3")&&n.setAttribute("uv3",i.getAttribute("uv3")),n.setAttribute("mcol0",i.getAttribute("mcol0")),n.setAttribute("mcol1",i.getAttribute("mcol1")),n.setAttribute("mcol2",i.getAttribute("mcol2")),n.setAttribute("mcol3",i.getAttribute("mcol3")),i.getAttribute("muvCol0")&&(n.setAttribute("muvCol0",i.getAttribute("muvCol0")),n.setAttribute("muvCol1",i.getAttribute("muvCol1"))),i.getAttribute("id")&&n.setAttribute("id",i.getAttribute("id")),n.setAttribute("aColor",i.getAttribute("aColor")),n.setAttribute("vClipping",i.getAttribute("vClipping")),i.getAttribute("pointColorState")&&n.setAttribute("pointColorState",i.getAttribute("pointColorState")),n.setAttribute("vState",i.getAttribute("vState").clone()),n.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),n.setIndex(i.getIndex());let a=null;return a="LineSegmentsEx"===e.type?new r.LineSegmentsEx(n,t):new r.MeshEx(n,t),a.databagId=e.databagId,a.fileId=e.fileId,a.frustumCulled=e.frustumCulled,a.name=`${e.name}_copy`,a.indexGroups=e.indexGroups,a.indexCount=e.indexCount,a.isInstanceMeshNode=!0,a.isCopyMesh=!0,a.matrixRoot=e.matrixRoot,e.customDepthMaterial&&(a.customDepthMaterial=e.customDepthMaterial,a.castShadow=e.castShadow,a.receiveShadow=e.receiveShadow),e.matrix&&(a.matrix=e.matrix,a.matrixAutoUpdate=!1,a.updateMatrixWorld()),a}(f,i.instanceWireframeMaterial);v.visible=!1,g.add(f),g.add(v),i.decreaseLoadedCount(l),this.checkIfTileParseFinish(l)&&(g.updateMatrixWorld(!0),d&&d(l),i._deleteNodeBuffer(a,l))}setInstanceLineAttributeBuffer(t,i,n){const a=t.getInstanceMeshNodeById(i.nodeIndexId);if(a.size<1)return void console.log("no instance mesh!");const s=i.instanceInfo.entityInfoArray;let o=n.geometry;const l=a.entries().next().value[1],d=l.mesh.matrixRoot,h=l.matrix,c=function(e){const t=r.MaterialUtil.DefaultWireframeColor,i=[];for(let r=0;r<e;++r)i.push(t.color.r,t.color.g,t.color.b,t.opacity);return new THREE.InstancedBufferAttribute(new Float32Array(i),4,!1,1)}(s.length);o.setAttribute("aColor",c);const u=function(t,i){const r={column0:[],column1:[],column2:[],column3:[]};for(let n=0;n<t.length;++n){let a=e.copy(t[n].entityMatrix);i&&(a=a.multiply(i));const s=a.elements;r.column0.push(s[0],s[1],s[2]),r.column1.push(s[4],s[5],s[6]),r.column2.push(s[8],s[9],s[10]),r.column3.push(s[12],s[13],s[14])}const n=[];for(let e=0;e<4;++e){const t=r["column"+e.toString()],i=new THREE.InstancedBufferAttribute(new Float32Array(t),3,!1,1);n.push(i)}return n}(s,d);for(let e=0;e<u.length;++e)o.setAttribute("mcol"+e.toString(),u[e]);const p=function(e,t){const i=e.length,n=new Array(4*i),a=(e[0].userData,e[0].userID);return r.TilesUtil.matchWireFrameVisibilityOption(a,t.wireFrameVisibilityOption)?n.fill(r.EnumElementState.NONE):n.fill(r.EnumElementState.HIDDEN),new THREE.InstancedBufferAttribute(new Float32Array(n),4,!1,1)}(s,i);o.setAttribute("vState",p);const m=t.filter.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE,f=function(e,t){const i=new Array(e);return i.fill(t),new THREE.InstancedBufferAttribute(new Float32Array(i),1,!1,1)}(s.length,m);o.setAttribute("vClipping",f),n.applyMatrix4(h),t.addInstanceLineNodeById(n.tileId,n)}loadLineMesh(e,t){let{that:i,loader:n,meshBufferObject:a,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if(!i.checkIfTileAvailable(l))return void i._deleteNodeBuffer(a,l);let h=i._createBatchGeometry(i,n,a,s,o),c=new r.LineSegmentsEx(h,[i.wireframeMaterial]);c.applyMatrix4(s.matrix),c.name=s.nodeIndexId,c.tileId=s.tileId,c.indexGroups=s.indexInfos,n.addLineNodeById(c.tileId,s.nodeIndexId,c),s.userIdMapIndex&&n.addUserIdMapIndices(s.userIdMapIndex,c.name);const u=this.getContentMeshGroup(l);n.dealLineMeshVisible(c),u.add(c),c.databagId=u.databagId,c.fileId=u.fileId,c.renderOrder=r.EnumRenderOrder.WireFrame,i.decreaseLoadedCount(l),this.checkIfTileParseFinish(l)&&(u.updateMatrixWorld(!0),d&&d(l),i._deleteNodeBuffer(a,l))}_deleteNodeBuffer(e,t){e.bufferData=null,e.bufferBlob=null,e.blobHeader=null,e.meshBlob=null,e.buffer=null;var i=this.getFullBuffer(t);for(var r in i)i[r].content=null}_createBatchGeometry(e,t,i,r,n){let a=new THREE.BufferGeometry;const s=i.meshBlob,o=i.bufferData,l=e._getAccVertexArray(e,s,o,n),d=e._getAccIndicesArray(e,s,o,n),h=e._getAccInfo(s,n.getAccIndices()),c=e._getAccInfo(s,n.getAccVertices());return r.vAccInfoStart=c.offset,r.iAccInfoStart=h.offset,r.iAccInfoCount=h.count,r=Object.assign(r,e._getSubNodeInfo(e,t,a,i,r,n)),a.setAttribute("position",new THREE.BufferAttribute(l,3)),a.setIndex(new THREE.BufferAttribute(d,1)),e._createColorBuffer(r,a,o,s,n),a}loadLineGeometryBuffer(e,t,i,r,n,a,s,o){if(!e.checkIfTileAvailable(a))return void e._deleteNodeBuffer(i,a);const l=e._createBatchGeometry(e,t,i,r,n);a.geometry=l,a.indexGroups=r.indexInfos,a.matrix.copy(r.matrix),e._deleteNodeBuffer(i,a),s&&s()}getContentMeshGroup(e){return e.content.meshes}getFullBuffer(e){return e.lineBuffer}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}decreaseLoadedCount(e){e.loadedLineCount--}getLoadedCount(e){return e.loadedLineCount}}r.BimTileLineParser=t}(),function(){class e extends r.BimTileLineParser{constructor(e){super(e),this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),this.wireframeMaterial.defines.USE_NO_SSAO="",this.wireframeMaterial.transparent=!0,this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),this.instanceWireframeMaterial.transparent=!0,this.instanceWireframeMaterial.defines.USE_NO_SSAO=""}destroy(){this.defaultWireframeColor=void 0,this.wireframeMaterial=void 0,this.instanceWireframeMaterial=void 0,super.destroy()}getContentMeshGroup(e){return e._content._outlineContent.outlineMeshes}getFullBuffer(e){return e.outlineBuffer}checkIfTileAvailable(e){return e.checkIfTileAvailable()}decreaseLoadedCount(e){e.loadedOutlineCount--}getLoadedCount(e){return e.loadedOutlineCount}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){let e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){const e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}}r.BimTileOutlineParser=e}(),r.BimTileBatchBlobParser=class{constructor(e){this.options=Object.assign({},e),this.taskRunner=new r.TaskRunner,this.blockType=null}destroy(){this.taskRunner=null,this.blockType=null,this.options=null}parseBlobs(e,t,i){this.computeNodeCount(t,e.batchMergeEnabled);const r=this.blockType,n=this.getFullBuffer(t);for(let o in n){if(null===this.getFullBuffer(t))return;var a=this.getBufferByIdx(t,o);if(a.type==r){var s=a.content;s&&this.parseBlob(e,s,t,o,i)}}}parseBlob(e,t,i,n,a){if(!t)return;let s={};s.contentIndex=this.getContentIndex(i),s.meshBlob=t;const o=t.getScenesList(),l=o.length;if(0===l)return;const d=t.getBlobHeader(),h=d.getBufferBlockId(),c=this.getBufferBlock(e,i,h);if(!c)return;const u=c.getBuffer();s.buffer=c,s.bufferData=u;const p=this.getTileId(i,d),m=t.getNodesList();s.bufferId=`${p}_${n}`;for(let t=0;t<l;++t){const l=o[t].getNodesList(),d=l.length;for(let t=0;t<d;++t){const o=m[l[t]];let d={};d.tileId=p,d.nodeIndex=l[t],d.nodeIndexId=`${i.contentId}_${n}`,d.lineTileId=`${p}_${d.nodeIndex}`;let h=new THREE.Matrix4;if(16==o.getMatrixList().length){h.fromArray(o.getMatrixList());let e=o.getTranslationList();r.Utils.isDefined(e)&&3===e.length&&h.setPosition(e[0],e[1],e[2])}d.matrix=h.multiply(i.matrix),this.parseNode(e,s,o,d,i,a)}}}parseNode(e,t,i,r,n,a){const s=t.meshBlob,o=i.getPrimitivesList(),l=o.length,d=i.getNodeType(),h=i.getBboxList();let c=new THREE.Vector2(0,0),u=new THREE.Vector2(0,0);if(h.length>=10&&(c.x=(h[6]+h[7])/2,c.y=(h[8]+h[9])/2,u.x=(h[7]-h[6])/2,u.y=(h[9]-h[8])/2),d!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE)for(let i=0;i<l;i++){const l=o[i],d=s.getPrimitivesList()[l];d.uvCenter=c,d.uvHalfExtent=u;let h=this.chooseParser(d,d.getMode());const p=this.getLoadCallback(n,h);r.mode=d.getMode();const m={that:h,loader:e,meshBufferObject:t,pbfNodeInfo:r,primitive:d,treeNode:n,onTileContentReadyCallback:a};this.taskRunner.runTask(p,m,(function(){}))}}getLoadCallback(e,t){}chooseParser(e,t){}getBufferBlock(e,t,i){}getTileId(e){}getContentIndex(e){return e.contentIndex}isBufferDeleted(e){}computeNodeCount(e){}getFullBuffer(e){}getBufferByIdx(e,t){}},function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_MESH}destroy(){super.destroy(),this.bimtileMeshNodeParser&&this.bimtileMeshNodeParser.destroy(),this.bimtileMeshNodeParser=void 0,this.bimtileDracoParser&&this.bimtileDracoParser.destroy(),this.bimtileDracoParser=void 0,this.bimtileLineParser&&this.bimtileLineParser.destroy(),this.bimtileLineParser=void 0,this.bimtilePointParser&&this.bimtilePointParser.destroy(),this.bimtilePointParser=void 0}getLoadCallback(e,t){return t.loadMesh}chooseParser(e,t){switch(t){case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES:return e.getAccArchive()>=0?this.getDracoParser():this.getMeshParser();case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES:return this.getLineParser();case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_POINTS:return this.getPointParser()}}getBufferBlock(e,t,i){return e.tileReader.getBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.contentIndex}getTileId(e,t){return t.getTileId()}getDracoParser(){return this.bimtileDracoParser||(this.bimtileDracoParser=new r.BimTileDracoParser(this.options)),this.bimtileDracoParser}getMeshParser(){return this.bimtileMeshNodeParser||(this.bimtileMeshNodeParser=new r.BimTileMeshNodeParser(this.options)),this.bimtileMeshNodeParser}getLineParser(){return this.bimtileLineParser||(this.bimtileLineParser=new r.BimTileLineParser(this.options)),this.bimtileLineParser}getPointParser(){return this.bimtilePointParser||(this.bimtilePointParser=new r.BimTilePointParser(this.options)),this.bimtilePointParser}computeNodeCount(e,t){e.computeMeshNodeCount(t)}getFullBuffer(e){return e.buffer}getBufferByIdx(e,t){return e.getBuffer(t)}}r.BimTileMeshBlobParser=e}(),function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_LINE}destroy(){this.bimtileLineParser&&this.bimtileLineParser.destroy(),super.destroy()}getLoadCallback(e,t){return e.contentTypeBufferOnly?t.loadLineGeometryBuffer:!0===e.contentTypeInstance?t.loadLineInstanceMesh:t.loadLineMesh}chooseParser(){return this.getLineParser()}getTileId(e){return`line_${e.contentId}`}getBufferBlock(e,t,i){return e.tileReader.getLineBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.contentIndex}computeNodeCount(e){e.computeLineNodeCount()}getFullBuffer(e){return e.lineBuffer}getBufferByIdx(e,t){return e.getLineBuffer(t)}}r.BimTileLineBlobParser=e}(),function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_POINT}destroy(){this.bimTilePointParser&&this.bimTilePointParser.destroy(),super.destroy()}parseBlob(e,t,i,r,n){if(!t)return;var a={};if(a.pointBlob=t,0===t.getPointsList().length)return;var s=t.getBlobHeader();(s.getTranslationList().length>0||s.getMatrixList().length>0)&&console.log("Translation"),a.blobHeader=s;var o=s.getBufferBlockId(),l=this.getBufferBlock(e,i,o);if(a.bufferBlob=l,!l)return;var d=l.getBuffer();a.bufferData=d;var h=l.getBlobHeader(),c=h.getBufferTypeList(),u=h.getBufferSizeList(),p=h.getBufferOffsetList(),m=p.length;this.setLoadedCount(i,m);for(var f=0;f<m;++f){var g=p[f],v=u[f],y=d.slice(g,g+v).buffer;switch(c[f]){case proto.BufferBlobHeader.BufferType.BT_UNKNOW:const t={that:M,loader:e,pointBufferObject:a,subPointBuffer:y,treeNode:i,onTileContentReadyCallback:n};this.taskRunner.runTask(this.loadDracoPoint,t,(function(){}));break;case proto.BufferBlobHeader.BufferType.BT_VERTEX:a.vertexArray=new Float32Array(y);break;case proto.BufferBlobHeader.BufferType.BT_COLOR:const r=new Uint8Array(y),s=a.blobHeader.getAttributeDataList()[f];let o=[];if(s==proto.PointBlobHeader.AttributeData.AD_COLOR_RGBA_I)r.forEach((e=>o.push(e/255)));else if(s==proto.PointBlobHeader.AttributeData.AD_COLOR_565_S)for(let e=0;e<r.length;e+=2){const t=r[e+0],i=r[e+1],n=(t>>3)/255,a=((3&t)<<3&i>>5)/255,s=(31&i)/255,l=1;o.push(n,a,s,l)}a.colorArray=new Float32Array(o);break;case proto.BufferBlobHeader.BufferType.BT_NORMAL:a.normalArray=new Float32Array(y)}}if(!a.vertexArray)return;const M=this.chooseParser(),E=this.getLoadCallback(i,M),x={that:M,loader:e,pointBufferObject:a,treeNode:i,onTileContentReadyCallback:n};this.taskRunner.runTask(E,x,(function(){}))}getPointParser(){return this.bimtilePointParser||(this.bimtilePointParser=new r.BimTilePointParser(this.options)),this.bimtilePointParser}getLoadCallback(e,t){return t.loadBufferPointMesh}chooseParser(){return this.getPointParser()}computeNodeCount(e){e.computePointNodeCount()}getBufferBlock(e,t,i){return e.tileReader.getBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getFullBuffer(e){return e.buffer}getBufferByIdx(e,t){return e.getBuffer(t)}setLoadedCount(e,t){e.loadedCount=t}}r.BimTilePointBlobParser=e}(),function(){class e extends r.BimTileLineBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_LINE,this.lineParser=new r.BimTileOutlineParser(e)}destroy(){this.lineParser.destroy(),this.lineParser=void 0,super.destroy()}getLineParser(){return this.lineParser}getTileId(e){return`outline_${e.contentId}`}getBufferBlock(e,t,i){return e.tileReader.getOutlineBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.getOutlineContentUrl()}computeNodeCount(e){e.computeOutlineNodeCount()}getFullBuffer(e){return e.outlineBuffer}getBufferByIdx(e,t){return e.getOutlineBuffer(t)}}r.BimTileOutlineBlobParser=e}(),function(){class e{constructor(e){this.loader=e,this.reader=e.reader}destroy(){}travelLineMesh(e,t,i){}updatePickingMeshes(){}}e.selectedMaterial=new r.MeshBasicClipMaterial({color:1170103,opacity:1,transparent:!1}),r.BimTileWireframeManager=e}(),r.BimTileBatchedMeshManager=class{constructor(e){this.loader=e,this.reader=e.reader,this.batchMeshIdNodeMap=new Map,this.noUserDataMeshNodeInfoMap={}}destroy(){this.batchMeshIdNodeMap.clear(),this.noUserDataMeshNodeInfoMap=null}addMeshIdMap(e,t){this.batchMeshIdNodeMap.get(e)||this.batchMeshIdNodeMap.set(e,t)}getMeshNodeById(e){return this.batchMeshIdNodeMap.get(e)}disposeMeshNodeById(e){this.batchMeshIdNodeMap.delete(e)}addNoUserDataMeshNodeInfo(e,t,i){void 0===this.noUserDataMeshNodeInfoMap[e]&&(this.noUserDataMeshNodeInfoMap[e]={}),this.noUserDataMeshNodeInfoMap[e][t]=i}patchMeshNodeInfo(e,t,i){this.loader.getDescriptor().patchBatchedMeshNodeInfo(e,t,i)}recoverNodeInfo(){for(const e in this.noUserDataMeshNodeInfoMap){const t=this.noUserDataMeshNodeInfoMap[e];for(const i in t)this.patchMeshNodeInfo(e,i,t[i])}this.noUserDataMeshNodeInfoMap=null}getGeometryBuffersByNodeInfo(e,t,i,r){const n=this.getMeshNodeById(e);if(!n||!1===n.visible)return;const a=n.geometry,s=a.getIndex().array,o=a.getAttribute("position").array,l=a.getAttribute("uv"),d=l?l.array:null,h=a.getAttribute("color"),c=h?h.array:null,u=a.getAttribute("cNormal"),p=u?u.array:null,m=n.indexGroups.get(t);for(const t of m.values()){let a=t.indexStart,l=t.indexStart+t.indexCount;const h=s.slice(a,l);let u,m,f=null;d&&(a=t.positionStart/3*2,l=a+t.positionCount/3*2,f=d.slice(a,l)),c&&(a=t.positionStart/3*4,l=a+t.positionCount/3*4,u=c.slice(a,l)),p&&(a=t.cNormalStart,l=a+t.cNormalCount,m=p.slice(a,l)),a=t.positionStart,l=t.positionStart+t.positionCount;const g=o.slice(a,l);a/=3,h.forEach((function(e,t,i){i[t]-=a})),r.push({isLines:!1,databagId:i,nodeId:e,position:g,index:h,uv:f,matrix:n.matrix,color:u,cNormal:m,isInstance:!1})}}updatePickingMeshes(e,t,i,n,a){const s=e.parent,o=this.getMeshNodeById(s);if(!o||!o.indexGroups||!1===o.visible||!1===o.parent.visible||null!=o.parent.parent&&0==o.parent.parent.visible)return;const l=o.geometry,d=o.indexGroups;let h=new THREE.BufferGeometry;h.setAttribute("position",l.getAttribute("position"));let c=l.getAttribute("uv");a&&c&&h.setAttribute("uv",c),l.getAttribute("color")&&h.setAttribute("color",l.getAttribute("color")),h.setIndex(l.getIndex());let u="LineSegmentsEx"===o.type?new THREE.LineSegments(h,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(h,r.MaterialUtil.DefaultMaterial);u.name=o.name,u.frustumCulled=!1,u.renderOrder=r.EnumRenderOrder.Component,u._indicesGroup=d,u.material=i?[i]:o.material,u.matrix.copy(o.matrix),u.matrixAutoUpdate=!1;const p=d.get(parseInt(t));let m={};i||l.groups.map((e=>{m[e.start]=e.materialIndex}));for(const e of p.values()){let t=0;i||(t=m[e.indexStart]),u.geometry.addGroup(e.indexStart,e.indexCount,t),n.add(u)}}calculateClippingIds(e,t,i,n,a){if(!r.GlobalData.CalculateClippingLine)return;var s=this;let o=new Map;a.forEach((e=>{o.has(e.userId)?o.get(e.userId).push(e):o.set(e.userId,[e])})),o.forEach(((a,o)=>{let l=[];a.forEach((t=>{var i=t.parent||t.nodeId,a=s.getMeshNodeById(i);if(!a||"LineSegmentsEx"==a.type)return;const d=a.indexGroups.get(o).get(t.nodeId);d.box=t.boundingBox;const h=r.ClippingBorderLineUtil.calculateIntersection(e,a,d,n);delete d.box,l=l.concat(h)})),r.ClippingBorderLineUtil.push(n,l,t,i,o)}))}calculateClippingContours(e,t,i,r,n,a,s,o){const l=a.parent,d=this.getMeshNodeById(l);if(!d||!d.indexGroups||"MeshEx"!==d.type||!1===d.visible||!1===d.parent.visible)return;const h=d.indexGroups,c=d.matrix,u=h.get(parseInt(r)).get(a.nodeId);let p=[];if(d.getIntersectionContours(t,u,p),0===p.length)return;let m=[];if(p.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(c).applyMatrix4(s),i.containsPoint(e)&&t.push(e)})),t.length>0&&m.push(t)})),0===m.length)return;const f=d.material[0].color,g={red:parseInt(255*f.r),green:parseInt(255*f.g),blue:parseInt(255*f.b)};void 0===o[e][n]?o[e][n]={clippingContours:[m],colors:[g]}:(o[e][n].clippingContours.push(m),o[e][n].colors.push(g))}changeAllMaterials(e){for(let[t,i]of this.batchMeshIdNodeMap){let t=i.material;if(!t)return;for(let i=0;i<t.length;i++){if(!t[i])continue;let r=t[i].name;e[r]&&(t[i]=e[r])}}}},r.BimTileInstancedMeshManager=class{constructor(e){this.loader=e,this.reader=e.tileReader,this.instanceMeshIdNodeMap=new Map,this.instanceInfoMap={},this.noUserDataInstanceNodeInfoMap={},this.overrideMaterialMap={}}destroy(){this.instanceMeshNodeMap=null,this.InstanceInfoMap=null,this.noUserDataInstanceNodeInfoMap=null,this.overrideMaterialMap=null}addInstanceInfo(e,t){this.instanceInfoMap[e]||(this.instanceInfoMap[e]=t)}getInstanceInfoById(e){return this.instanceInfoMap[e]}addInstanceMeshIdMap(e,t,i,r){this.instanceMeshIdNodeMap.get(e)&&this.instanceMeshIdNodeMap.get(e).get(t)||(void 0===this.instanceMeshIdNodeMap.get(e)&&(this.instanceMeshIdNodeMap.set(e,new Map),this.instanceMeshIdNodeMap.get(e).set(t,{})),void 0===this.instanceMeshIdNodeMap.get(e).get(t)&&this.instanceMeshIdNodeMap.get(e).set(t,{}),this.instanceMeshIdNodeMap.get(e).get(t).mesh=i,this.instanceMeshIdNodeMap.get(e).get(t).matrix=r)}getInstanceMeshNodeById(e){return this.instanceMeshIdNodeMap.get(e)}disposeInstanceMeshNodeById(e){this.instanceMeshIdNodeMap.delete(e)}addNoUserDataInstanceNodeInfo(e,t,i){if(void 0===this.noUserDataInstanceNodeInfoMap[e])return this.noUserDataInstanceNodeInfoMap[e]={},void(this.noUserDataInstanceNodeInfoMap[e][t]=[i]);void 0!==this.noUserDataInstanceNodeInfoMap[e][t]?this.noUserDataInstanceNodeInfoMap[e][t].push(i):this.noUserDataInstanceNodeInfoMap[e][t]=[i]}recoverNodeInfo(){for(const e in this.noUserDataInstanceNodeInfoMap){const t=this.noUserDataInstanceNodeInfoMap[e];for(const i in t)t[i].map((t=>{this.patchInstanceNodeInfo(e,i,t)}))}this.noUserDataInstanceNodeInfoMap=null}patchInstanceNodeInfo(e,t,i){this.loader.getDescriptor().patchInstanceNodeInfo(e,t,i)}getGeometryBuffersByNodeInfo(e,t,i,n){const a=this.getInstanceMeshNodeById(e);if(a)for(const[s,o]of a){const a=o.matrix,s=o.mesh;if(r.TilesUtil.isInstanceNodeInVisible(s))continue;let l=t.matrix.clone();l=a.clone().multiply(l);const d=s.geometry,h=d.getAttribute("uv"),c=r.ModelView.BaseDescriptor.isLineNode(t);n.push({isLines:c,databagId:i,nodeId:e,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l,uv:h?h.array:null,isInstance:!0})}}_createInstanceMaterial(e,t,i){const n=e.getAttribute("aColor").array,a=e.getAttribute("vState").array,s=n[4*t],o=n[4*t+1],l=n[4*t+2];let d=Math.floor(100*n[4*t+3])/100;const h=new THREE.Color(s,o,l);0===a[4*t]&&(d=i);let c=!1;d<1&&(c=!0);const u={color:h.getHex(),opacity:d,transparent:c},p=`${u.color}_${d}`;let m=this.overrideMaterialMap[p];return m||(m=r.MaterialUtil.createStandardMaterial(u),this.overrideMaterialMap[p]=m,m)}updatePickingMeshes(e,t,i,n,a,s){const o=this.getInstanceMeshNodeById(e);if(o)for(const[e,a]of o){const e=a.matrix,o=a.mesh;if(r.TilesUtil.isInstanceNodeInVisible(o))continue;const l=o.geometry;let d=new THREE.BufferGeometry;d.setAttribute("position",l.getAttribute("position")),d.setIndex(l.getIndex());let h=null;h="LineSegmentsEx"===o.type?new THREE.LineSegments(d,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(d,t||this._createInstanceMaterial(l,s,o.material[0].opacity)),h.name=o.name,h.frustumCulled=!1,h.matrix.copy(e).multiply(i),h.matrixAutoUpdate=!1,n.add(h)}}calculateClippingIds(e,t,i,n,a){if(!r.GlobalData.CalculateClippingLine)return;var s=this;let o=new Map;a.forEach((e=>{o.has(e.userId)?o.get(e.userId).push(e):o.set(e.userId,[e])})),o.forEach(((a,o)=>{let l=[];a.forEach((t=>{var i=t.parent||t.nodeId,a=s.getInstanceMeshNodeById(i);if(a&&t.matrix)for(const[i,s]of a){const i=s.mesh;if(!i||"LineSegmentsEx"==i.type)continue;const a={matrix:t.matrix,box:t.boundingBox},o=r.ClippingBorderLineUtil.calculateIntersection(e,i,a,n);l=l.concat(o)}})),r.ClippingBorderLineUtil.push(n,l,t,i,o)}))}calculateClippingContours(e,t,i,n,a,s,o,l){const d=this.getInstanceMeshNodeById(s.nodeId);if(d)for(const[n,h]of d){const n=h.matrix,d=h.mesh;if(r.TilesUtil.isNodeInVisible(d))continue;let c=s.matrix.clone();c=n.clone().multiply(c);let u=[],p={matrix:c,isInstance:!0};d.getIntersectionContours(t,p,u);let m=[];u.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(o),i.containsPoint(e)&&t.push(e)})),t.length>0&&m.push(t)}));const f=d.material[0].color,g={red:parseInt(255*f.r),green:parseInt(255*f.g),blue:parseInt(255*f.b)};if(0===m.length)return;void 0===l[e][a]?l[e][a]={clippingContours:[m],colors:[g]}:(l[e][a].clippingContours.push(m),l[e][a].colors.push(g))}}updateInstanceClipping(e){var t=e?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;for(var[i,n]of this.instanceMeshIdNodeMap)for(var[a,s]of n){var o=s.mesh.geometry;const e=o.getAttribute("vClipping").array;e&&(e.fill(t),o.getAttribute("vClipping").needsUpdate=!0)}}updatePickingMeshesByIds(e){let t={};const{bimtileDescriptor:i,instanceMeshGroup:n,selectedIds:a}=e,s=a.length,o=this.loader.filter;for(let e=0;e<s;++e){const r=this.reader.getIndexByUserId(a[e]);o.isPickable(r)&&i.getInstanceNodeInfoByUserIdCallback(r,(e=>{const i=e.nodeInfo,r=i.parent;t[r]||(t[r]={}),t[r][i.index]=!0}))}for(const e in t){const i=this.getInstanceMeshNodeById(e);if(!i)continue;let a=(e,t)=>{const i=e.length/4;for(let r=0;r<i;++r)!0!==t[r]&&(e[4*r]=-1)};for(const[s,o]of i){const i=o.matrix,s=o.mesh;if(r.TilesUtil.isInstanceNodeInVisible(s))continue;let l=s.geometry.clone();a(l.getAttribute("vState").array,t[e]);let d=new THREE.Mesh(l,s.material);d.name=s.name,d.frustumCulled=!1,d.matrix.copy(i),d.matrixAutoUpdate=!1,n.add(d)}}}changeAllMaterials(e){for(let[t,i]of this.instanceMeshIdNodeMap)for(let[t,r]in i){let t=r.mesh.material;if(!t)return;for(let i=0;i<t.length;i++){if(!t[i])continue;let r=t[i].name;e[r]&&(t[i]=e[r])}}}},function(){class e extends r.BimTileWireframeManager{constructor(e){super(e),this.batchedMeshIdNodeMap={}}destroy(){super.destroy(),this.batchedMeshIdNodeMap=null}addLineNodeById(e,t,i){this.batchedMeshIdNodeMap[e]||(this.batchedMeshIdNodeMap[e]={}),this.batchedMeshIdNodeMap[e][t]=i}getLineNodeById(e,t){return this.batchedMeshIdNodeMap[e][t]}disposeLineNodeById(e){this.batchedMeshIdNodeMap[e]=null,delete this.batchedMeshIdNodeMap[e]}travelLineMesh(e,t,i){const n=this.batchedMeshIdNodeMap[e];if(n)for(const e in n){const a=n[e];a.indexGroups.get(parseInt(t))&&(r.TilesUtil.isNodeInVisible(a)||i&&i(a))}}updatePickingMeshes(e,t,i,n){this.travelLineMesh(e,t,(e=>{const a=e.geometry,s=e.indexGroups;let o=new THREE.BufferGeometry;o.setAttribute("position",a.getAttribute("position")),o.setIndex(a.getIndex());let l=new THREE.LineSegments(o,r.BimTileWireframeManager.selectedMaterial);l.name=e.name,l.frustumCulled=!1,l.renderOrder=r.EnumRenderOrder.WireFrame,l._indicesGroup=s,l.material=[i],l.matrix.copy(e.matrix),l.matrixAutoUpdate=!1;const d=s.get(parseInt(t));for(const e of d.values())l.geometry.addGroup(e.indexStart,e.indexCount,0),n.add(l)}))}enableWireFrame(e){for(const t in this.batchedMeshIdNodeMap){const i=this.batchedMeshIdNodeMap[t];for(const t in i)i[t].visible=e}}dealLineMeshVisible(e){if(e.visible=this.loader.isBorderLineVisible(),!0===this.loader.wireFrameVisibilityOption)return;const t=e.indexGroups;let i=new Map;for(const[e,n]of t)r.TilesUtil.matchWireFrameVisibilityOption(e,this.loader.wireFrameVisibilityOption)&&i.set(e,n);e.geometry.clearGroups();const n=r.TilesUtil.nodeIndexGroupsSort(i),a=n.length;if(a<1)return;let s=n[0].indexGroup.indexStart,o=n[0].indexGroup.indexCount;for(let t=1;t<a;++t){const i=n[t].indexGroup;i.indexStart===n[t-1].indexGroup.indexStart+n[t-1].indexGroup.indexCount?o+=i.indexCount:(e.geometry.addGroup(s,o,0),s=i.indexStart,o=i.indexCount)}e.geometry.addGroup(s,o,0)}recoverLineNode(){for(const e in this.batchedMeshIdNodeMap){const t=this.batchedMeshIdNodeMap[e];for(const e in t){const i=t[e];this.dealLineMeshVisible(i)}}}}r.BimTileBatchedWireframeManager=e}(),function(){class e extends r.BimTileWireframeManager{constructor(e){super(e),this.instanceMeshIdNodeMap={}}destroy(){super.destroy(),this.instanceMeshIdNodeMap=null}addInstanceLineNodeById(e,t){this.instanceMeshIdNodeMap[e]=t}getInstanceLineNodeById(e){return this.instanceMeshIdNodeMap[e]}disposeInstanceLineNodeById(e){this.instanceMeshIdNodeMap[e]=null,delete this.instanceMeshIdNodeMap[e]}travelLineMesh(e,t,i){const n=this.instanceMeshIdNodeMap[e];n&&(r.TilesUtil.isInstanceNodeInVisible(n)||i&&i(n))}updateInstanceClipping(e){const t=e?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;for(const e in this.instanceMeshIdNodeMap){const i=this.instanceMeshIdNodeMap[e].geometry,r=i.getAttribute("vClipping").array;r&&(r.fill(t),i.getAttribute("vClipping").needsUpdate=!0)}}updatePickingMeshes(e,t,i,n,a){this.travelLineMesh(e,t,(e=>{const t=e.geometry;let i=new THREE.BufferGeometry;i.setAttribute("position",t.getAttribute("position")),i.setIndex(t.getIndex());let s=new THREE.LineSegments(i,r.BimTileWireframeManager.selectedMaterial);s.name=e.name,s.frustumCulled=!1,s.renderOrder=r.EnumRenderOrder.WireFrame,s.matrix.copy(e.matrix).multiply(n),s.matrixAutoUpdate=!1,a.add(s)}))}enableWireFrame(e){for(const t in this.instanceMeshIdNodeMap)this.instanceMeshIdNodeMap[t].visible=e}recoverLineNode(){for(const e in this.instanceMeshIdNodeMap){const t=this.instanceMeshIdNodeMap[e],i=t.name,n=this.loader.getInstanceInfoById(i);if(t.visible=this.loader.isBorderLineVisible(),void 0===t.geometry)continue;const a=n.length,s=new Array(4*a),o=n[0].userDataID,l=n[0].userID;this.loader.tileReader.getUserDataByIndex(o);r.TilesUtil.matchWireFrameVisibilityOption(l,this.loader.wireFrameVisibilityOption)?s.fill(r.EnumElementState.NONE):s.fill(r.EnumElementState.HIDDEN);const d=new THREE.InstancedBufferAttribute(new Float32Array(s),4,!1,1);t.geometry.setAttribute("vState",d)}}}r.BimTileInstancedWireframeManager=e}(),function(){class e{constructor(e){this.materialMap={},this.globalMaterial=new THREE.MeshBasicMaterial({color:9143938}),this.settingMaterialPara={},this.materialsOpacity=null,this.viewer=e.viewer,this.isUseColorWithoutLight=e.isUseColorWithoutLight,this.isUseSameOverridePara=!0,this.IBLParams={A:!0,B:!0,C:!0,D:!0,E:!0,F:!0,IBLMaps:!0,metalness:!0,roughness:!0,scale:!0,iblFactor:!0},this.backMaterialMap={},this._useCompressedNormal=!1,void 0!==e.disableHemiSphereLight?this.disableHemiSphereLight=e.disableHemiSphereLight:this.disableHemiSphereLight=!1}get useCompressedNormal(){return this._useCompressedNormal}set useCompressedNormal(e){return this._useCompressedNormal=e}destroy(){this.materialMap=null,this.settingMaterialPara={}}getDefaultStandardMaterial(){return r.MaterialUtil.getDefaultStandardMaterial()}getDefaultInstanceMaterial(){return r.MaterialUtil.getDefaultInstanceMaterial()}getMaterial(t,i,n,a){const s=t.filter.model,o=n.getMaterialId(),l=null!=i.renderInstance&&!0===i.renderInstance,d=this._isLineMode(n),h=e.generateMaterialName(i,o,l,d),c=this.getMaterialByName(h);if(r.Utils.isDefined(c))return void a(c);if(-1===o&&!l){const e=this.getDefaultStandardMaterial();return r.MaterialUtil.setCompressParm(e,n),this.dealMaterialDefines(e),e.name=h,this.materialMap[h]=e,this.updateMaterialUseCompressedNormal(e),void a(e)}if(-1===o&&l){const e=this.getDefaultInstanceMaterial();r.MaterialUtil.setCompressParm(e,n),this.dealMaterialDefines(e),e.name=h,this.materialMap[h]=e;let t=e.clone();t.transparent=!0,t.defines.INSTANCE_STATE_SECONDARY="";const i=h+"_second";return this.materialMap[i]=t,this.updateMaterialUseCompressedNormal(e),void a(e)}const u=i.bufferData,p=i.material,m=p.getMaterialsList()[o],f=this._createMaterial(t,h,m,l,n);if(this.initMaterialOpacity(f),s.localClippingMode&&(f.clippingPlanes=s.localClippingPlanes,f.innerClipping=s.innerClippingMode,s.innerClippingMatrix&&f.orthoViewProjMatrix.copy(s.innerClippingMatrix)),this.materialMap[h]=f,l){const e=r.MaterialUtil.getMaterialParameters(f);let t=this.createInstanceSecondMaterial(e);!0===f.transparent?t.transparent=!1:t.transparent=!0,t.defines.INSTANCE_STATE_SECONDARY="",this.dealMaterialDefines(t),r.MaterialUtil.setCompressParm(t,n);const i=h+"_second";t.name=i,this.materialMap[i]=t}r.Utils.isDefined(n.uvCenter)&&(f.uvCenter=n.uvCenter,f.uvHalfExtent=n.uvHalfExtent),r.MaterialUtil.setCompressParm(f,n),this.updateMaterialUseCompressedNormal(f);const g={currentTextureParm:m.getTexturesList(),totalTextureParm:p.getTexturesList(),totalImageParm:p.getImagesList(),meshBufferData:u};this._createTextureForMaterial(t.rootUrl,f,g).then((e=>{a(e)}))}updateMaterialUseCompressedNormal(e){e.useCompressedNormal&&(this.useCompressedNormal=!0)}createInstanceSecondMaterial(e){return r.MaterialUtil.createInstanceMaterial(e,!0)}getLineMaterial(t,i,n,a){const s=n.getMaterialId();-1===i.materialBlockId||i.bufferId,i.materialBlockId;const o=e.generateMaterialName(i,s,a,!0),l=this.materialMap[o];if(l)return l._referenceCount++,l;i.bufferData;const d=i.material.getMaterialsList()[s],h=this._createLineMaterial(t,o,d,a,n);if(h.name=o,a){const e=r.MaterialUtil.getMaterialParameters(h);let t=this.createInstanceSecondMaterial(e);!0===h.transparent?t.transparent=!1:t.transparent=!0,t.defines.INSTANCE_STATE_SECONDARY="",t.defines.USE_COLORWITHOUTLIGHT="",this.dealMaterialDefines(t),r.MaterialUtil.setCompressParm(t,n);const i=o+"_second";t.name=i,this.materialMap[i]=t}return h}dealMaterialDefines(e,t){}dealMaterialParm(e){e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY),e.side=0===e.doubleSide?THREE.FrontSide:THREE.DoubleSide,e.originMetalness=e.metalness,e.originRoughness=e.roughness,e.receiveIBL=0!=e.receiveIbl,e.light=!0!==e.hasLightMap,delete e.hasLightMap}_createLineMaterial(e,t,i,n,a){const s=i.toObject(),o=!0===n?r.MaterialUtil.createInstanceMaterial(s):new r.LineBasicMaterial({linewidth:1});n&&(o.receiveIBL=!1),o._imageByteSize=0,o.vertexColors=!!r.Utils.isDefined(a.vertexColors)&&a.vertexColors,this.initMaterialOpacity(o);const l=e.filter.model;return l.localClippingMode&&(o.clippingPlanes=l.localClippingPlanes,o.innerClipping=l.innerClippingMode,l.innerClippingMatrix&&o.orthoViewProjMatrix.copy(l.innerClippingMatrix)),o.color.setHex(s.color),o.defines&&(o.defines.USE_COLORWITHOUTLIGHT=""),o.needsUpdate=!0,this.materialMap[t]=o,o._referenceCount=1,o}_createMaterial(e,t,i,n,a){const s=i.toObject();r.Utils.isDefined(s.tintColor)&&0==s.tintColor&&(s.tintColor=16777215),s.hasLightMap=a.hasLightMap,s.vertexColors=!!r.Utils.isDefined(a.vertexColors)&&a.vertexColors,s.useEnvLight=!0,this.dealMaterialParm(s);let o=n?r.MaterialUtil.createInstanceMaterial(s,!0,s.receiveIBL&&r.GlobalData.IBL):r.MaterialUtil.createStandardMaterial(s,s.receiveIBL&&r.GlobalData.IBL);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e]);return void 0!==o.refreshUniforms&&o.refreshUniforms(),o}_isIBLParams(e){return this.IBLParams[e]}_createTextureForMaterial(e,t,i){i=r.Utils.defaultValue(i,{});return new Promise(((n,a)=>{const s=i.currentTextureParm;r.Utils.isDefined(s)||n();const o=i.totalTextureParm,l=i.totalImageParm,d=[];for(let n=0;n<s.length;++n){const a=new Promise(((a,d)=>{const h=s[n],c=o[h];(!r.Utils.isDefined(c)||c.getImage()<0)&&a();const u=l[c.getImage()],p=c.getAlpha()>0?proto.bimtile_pbf.Texture.TextureType.TT_ALPHA:c.getType(),m=u.getUrl(),f=u.getType();let g=c.getName();const v=JSON.stringify(c.toObject());if(m){const i=`${e}${m}`;g=g||r.Utils.getEncodedString(i+v),this.viewer.TextureManager.getTextureFromURL(i,g,{textureParm:c,imageType:f}).then((e=>{this._setTexture(p,t,e),a()}))}else if(u.getBufferId()>=0){const s=this._getImageBuffer(i.meshBufferData,u);g=g||r.Utils.getEncodedString(`${e}${t.name}_${n}_texture_${v}`),this.viewer.TextureManager.getTextureFromBuffer(s,g,{textureParm:c,imageType:f}).then((e=>{this._setTexture(p,t,e),a()})).catch((()=>{d()}))}else a()}));d.push(a)}Promise.all(d).then((()=>{n(t)}))}))}_setTexture(e,t,i){const n=r.MaterialUtil.getImageByteSize(i.image);switch(t._imageByteSize+=n,e){case proto.bimtile_pbf.Texture.TextureType.TT_DIFFUSE:t.map=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_SPECULAR:t.specularMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_EMISSIVE:t.emissiveMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_ENVIRONMENT:t.envMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_ALPHA:t.useAlphaMap=!0,t.map=i,t.transparent=!0,t.alphaTest=.01;break;case proto.bimtile_pbf.Texture.TextureType.TT_RELIEF:case proto.bimtile_pbf.Texture.TextureType.TT_BUMP:t.bumpMap=i,t.bumpScale=i.bumpScale,t.bumpUvTransform=i.matrix;break;case proto.bimtile_pbf.Texture.TextureType.TT_LIGHT:t.lightMap=i,t.defines.USE_COMPONENT_LIGHTMAP="",t.lightMapIntensity=r.GlobalData.LightmapIntensity}if(t.refreshUniforms(),t.needsUpdate=!0,""===t.defines.USE_INSTANCE){const r=t.name+"_second";let n=this.materialMap[r];if(!n)return;i._referenceCount++,this._setTexture(e,n,i)}}_dealInstanceSecondMaterialAlpha(e){const t=e.name+"_second";let i=this.materialMap[t];i&&(i.transparent=!e.transparent)}_updateIBL(e){if(r.GlobalData.IBL){this.settingMaterialPara.IBLMaps=e.manager.scene.IBLMaps,this.settingMaterialPara.iblFactor=10;var t=e.manager.viewer.getIBLManager().IBLParams;for(var i in t)this.settingMaterialPara[i]=t[i]}}_getImageBuffer(e,t){const i=t.getByteOffset(),r=t.getByteLength();return e.slice(i,i+r).buffer}delayUpdateTexturePkgMapping(){}updateMaterialsValue(e,t,i,r){this.settingMaterialPara[t]=i;const n=this.materialMap;for(const e in n){let a=n[e];if(a&&a.hasOwnProperty(t)){if(r&&0==a.receiveIBL)continue;a[t]=i,void 0!==a.refreshUniforms&&a.refreshUniforms(),a.needsUpdate=!0}}}changeAllMaterials(e,t){const i=this.materialMap;for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];if(!a.receiveIBL)continue;var s,o=r.MaterialUtil.getMaterialParameters(a);""!=a.defines.USE_INSTANCE&&""!=a.defines.USE_INSTANCE_NORMAL||(o.defines=a.defines),t?(delete o.textureColor,delete o.pureColor,delete o.imageFade,delete o.tintColor,o.lights=!0,(s=new H.IBLMaterial(o)).type="IBL",s.refreshUniforms()):(delete o.iblProbe,o.lights=!e.lightmap,(s=r.MaterialUtil.createStandardMaterial(o)).roughness=o.originRoughness,s.metalness=o.originMetalness,s.refreshUniforms()),s.name=n,i[n]=s,o=null}if(!t)for(let e in this.IBLParams)delete this.settingMaterialPara[e]}setMaterialsOpacity(e){for(var t in this.materialsOpacity=e,this.materialMap){var i=this.materialMap[t];i.opacity=i.srcOpacity*this.materialsOpacity,i.transparent=!(i.opacity>1-r.TilesUtil.TWO_ACCURACY)}}initMaterialOpacity(e){e.srcOpacity=e.opacity,e.defines&&void 0!==e.defines.INSTANCE_STATE_SECONDARY||null!=this.materialsOpacity&&(e.opacity=e.srcOpacity*this.materialsOpacity,e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY))}disposeMaterial(e){return e._referenceCount--,!e._referenceCount&&(e.dispose(),this._disposeTextures(e),delete this.materialMap[e.name],e=null,!0)}_disposeTextures(e){r.Utils.isDefined(e.map)&&(this.viewer.TextureManager.disposeTexture(e.map),e.map=null),r.Utils.isDefined(e.alphaMap)&&(this.viewer.TextureManager.disposeTexture(e.alphaMap),e.alphaMap=null),r.Utils.isDefined(e.bumpMap)&&(this.viewer.TextureManager.disposeTexture(e.bumpMap),e.bumpMap=null),r.Utils.isDefined(e.lightMap)&&(this.viewer.TextureManager.disposeTexture(e.lightMap),e.lightMap=null)}getMaterialByName(e){let t=this.materialMap[e];return r.Utils.isDefined(t)?(t._referenceCount++,t):null}hasMaterial(e){return void 0!==this.materialMap[e]}getMaterialByNameOnly(e){return this.materialMap[e]}getMaterialById(e){return this.getMaterialByName(e)}setExcavation(e){}setPolygonClimpGroundInfo(e){if(e)for(const t in this.materialMap){const i=this.materialMap[t];i.updatePolygonClimpGroundInfo&&(i.updatePolygonClimpGroundInfo(e),i.needsUpdate=!0)}}closePolygonClimpGround(){for(const e in this.materialMap){const t=this.materialMap[e];t.closePolygonClimpGround&&(t.closePolygonClimpGround(),t.needsUpdate=!0)}}createNewMaterialFrom(e){const t=e.name+"_copy";let i=this.materialMap[t];return i||(i=e.clone(),i.name+="_copy",this.materialMap[i.name]=i,i)}getBackMaterial(e){const t=e.name;if(this.backMaterialMap[t])return this.backMaterialMap[t];const i=e.clone();return delete i.defines.USE_BC_OUTLINE,delete i.defines.CNORMAL,i.transparent=!1,i.useForCap=!0,i.uniforms.useForCap.value=!0,i.side=THREE.BackSide,i.shift=.5,i.uniforms.shift.value=.5,this.backMaterialMap[t]=i,i}enableOverrideWithSameParameter(e){for(const t in this.materialMap){const i=this.materialMap[t];"cloudStandardBatchedV3"===i.type2&&(e?i.defines.USE_SAME_OVERRIDE_PARAM="":delete i.defines.USE_SAME_OVERRIDE_PARAM,i.needsUpdate=!0)}this.isUseSameOverridePara=e}_isLineMode(e){return e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES}}e.generateMaterialName=function(e,t,i,r){if(-1===t)return i?"-1_instance":"-1_standard";let n=-1===e.materialBlockId?e.materialBlockId:`${e.bufferId}+${e.materialBlockId}`;n=i?`${n}_instance`:`${n}_standard`;let a=`${n}_${t}`;return r&&(a+="_line"),a},r.BimTileMaterialManager=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){if(super(r.Utils.defaultValue(e,{})),this.taskRunner=new r.TaskRunner(5),this.pointAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Uint8Array",uv:"Float32Array"},this.pointSize=.5,this.shpPointMaterial=null,e&&e.isShpPoint){this.shpPointMaterial=new r.PointsMaterial({size:20,sizeAttenuation:!1,positionOffset:!1,sizeAttribute:!0,depthTest:!0,alphaTest:.001,transparent:!0});const e="https://static.bimface.com/attach/9cc8aabfabd0467bad0206bad79c349e_shp-point.png";(new THREE.TextureLoader).load(e,(e=>{this.shpPointMaterial.map=e,this.shpPointMaterial.needsUpdate=!0}))}}destroy(){this.taskRunner=null,this.pointAttributeTypes=null,this.shpPointMaterial&&this.shpPointMaterial.dispose(),this.shpPointMaterial=null}loadDracoPoint(e,t){const{that:i,loader:n,pointBufferObject:a,subPointBuffer:s,treeNode:o,onTileContentReadyCallback:l}=e;r.TilesUtil.getDracoLoader().decodeDracoFile(s,(function(e){e.attributes.color.normalized=!0,i.createMeshNode(n,a,o,e,l),t&&t()}),void 0,i.pointAttributeTypes)}loadMesh(e,t){let{that:i,loader:r,meshBufferObject:n,pbfNodeInfo:a,primitive:s,treeNode:o,onTileContentReadyCallback:l}=e;if((s.getAccVertices()<0||s.getAccIndices()<0)&&s.getAccArchive()<0)return void console.warn("invalid acc info");if(!this.checkIfTileAvailable(o))return this._deleteNodeBuffer(n,o),void(t&&t());let d=new THREE.BufferGeometry;const h=n.meshBlob,c=n.bufferData,u=i._getAccVertexArray(i,h,c,s),p=i._getAccIndicesArray(i,h,c,s);d.setAttribute("position",new THREE.BufferAttribute(u,3)),d.setIndex(new THREE.BufferAttribute(p,1)),i.createMeshNode(r,n,o,d,l),t&&t()}loadBufferPointMesh(e,t){const{that:i,loader:n,pointBufferObject:a,treeNode:s,onTileContentReadyCallback:o}=e,l=new THREE.BufferGeometry;l.setAttribute("position",new THREE.BufferAttribute(a.vertexArray,3)),a.colorArray&&l.setAttribute("color",new THREE.BufferAttribute(a.colorArray,4)),a.normalArray&&l.setAttribute("normal",new THREE.BufferAttribute(a.normalArray,3));const d=new THREE.PointsMaterial({size:i.pointSize});l.getAttribute("color")&&(d.vertexColors=!0);const h=new THREE.Points(l,d);h.name=s._contentIndex,s.content.meshes.add(h),o&&o(s),s.contentState=r.TileContentState.READY,s.content.meshes.matrix=s.matrix,s.content.meshes.updateMatrixWorld(!0),i._deleteNodeBuffer(a,s),t&&t()}createMeshNode(e,t,i,n,a){if(!this.checkIfTileAvailable(i))return void this._deleteNodeBuffer(t,i);let s=new r.PointsMaterial({size:this.pointSize,vertexColors:THREE.VertexColors});if(this.shpPointMaterial){const e=n.getAttribute("position").count,t=new Uint8Array,i=new Float32Array(e);for(let r=0;r<e;++r)t[r]=1,i[r]=20;n.setAttribute("attrSize",new THREE.BufferAttribute(i,1)),n.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(t,1)),s=this.shpPointMaterial}const o=new r.PointsEx(n,s);o.name=i._contentIndex,i.content.meshes.add(o),this.decreaseLoadedCount(i),this.getLoadedCount(i)<=0&&(a&&a(i),i.contentState=r.TileContentState.READY,i.content.meshes.matrix=i.matrix,i.content.meshes.updateMatrixWorld(!0),this._deleteNodeBuffer(t,i))}_deleteNodeBuffer(e,t){e.bufferData=null,e.bufferBlob=null,e.blobHeader=null,e.pointBlob=null,e.vertexArray=null,e.colorArray=null,e.normalArray=null;var i=this.getFullBuffer(t);for(var r in i)i[r].content=null}getLoadedCount(e){return e.loadedCount}decreaseLoadedCount(e){e.loadedCount--}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}}r.BimTilePointParser=e}(),function(){let e=new THREE.Matrix4,t=new THREE.Color;function i(e,t,i,r,a,s,o,l,d){o.frustumCulled=!1;let h=new THREE.Matrix4;h.copy(a.matrix),r.rootMatrix&&(h=h.multiply(r.rootMatrix)),o.applyMatrix4(h);const{meshInfo:c}=t[i];o.name=a.nodeIndexId,o.indexGroups=c.indexGroups,o.indexCount=c.iAccInfoCount,o.databagId=a.content.meshes.databagId,o.fileId=a.content.meshes.fileId,o.isInstanceMeshNode=!0,o.matrixRoot=c.matrixRoot;const u=n(o,d);u.visible=!1,a.content.meshes.add(o),a.content.meshes.add(u),s.addInstanceMeshIdMap(a.nodeIndexId,i,o,h),s.addInstanceInfo(a.nodeIndexId,r.entityInfoArray),s.renderableCount++}function n(e,t){const i=e.geometry,n=new THREE.InstancedBufferGeometry;n.setAttribute("position",i.getAttribute("position")),i.getAttribute("normal")&&n.setAttribute("normal",i.getAttribute("normal")),i.getAttribute("cNormal")&&n.setAttribute("cNormal",i.getAttribute("cNormal")),i.getAttribute("color")&&n.setAttribute("color",i.getAttribute("color")),i.getAttribute("barycentric")&&n.setAttribute("barycentric",i.getAttribute("barycentric")),i.getAttribute("uv")&&n.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&n.setAttribute("uv2",i.getAttribute("uv2")),i.getAttribute("uv3")&&n.setAttribute("uv3",i.getAttribute("uv3")),n.setAttribute("mcol0",i.getAttribute("mcol0")),n.setAttribute("mcol1",i.getAttribute("mcol1")),n.setAttribute("mcol2",i.getAttribute("mcol2")),n.setAttribute("mcol3",i.getAttribute("mcol3")),i.getAttribute("muvCol0")&&(n.setAttribute("muvCol0",i.getAttribute("muvCol0")),n.setAttribute("muvCol1",i.getAttribute("muvCol1"))),i.getAttribute("id")&&n.setAttribute("id",i.getAttribute("id")),n.setAttribute("aColor",i.getAttribute("aColor")),n.setAttribute("vClipping",i.getAttribute("vClipping")),i.getAttribute("pointColorState")&&n.setAttribute("pointColorState",i.getAttribute("pointColorState")),n.setAttribute("vState",i.getAttribute("vState").clone()),n.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),n.setIndex(i.getIndex());let a=null;return a="LineSegmentsEx"===e.type?new r.LineSegmentsEx(n,t):new r.MeshEx(n,t),a.databagId=e.databagId,a.fileId=e.fileId,a.frustumCulled=e.frustumCulled,a.name=`${e.name}_copy`,a.indexGroups=e.indexGroups,a.indexCount=e.indexCount,a.insLodLevels=e.insLodLevels,a.isInstanceMeshNode=!0,a.isCopyMesh=!0,a.matrixRoot=e.matrixRoot,e.isMeshQuantization&&(a.isMeshQuantization=e.isMeshQuantization),e.customDepthMaterial&&(a.customDepthMaterial=e.customDepthMaterial,a.castShadow=!e.castShadow,a.receiveShadow=!e.receiveShadow),e.matrix&&(a.matrix=e.matrix,a.matrixAutoUpdate=!1,a.updateMatrixWorld()),a}function a(e,t,i,a,s,o,l,d,h){l.frustumCulled=!1;let c=new THREE.Matrix4;c.copy(s.matrix),a.rootMatrix&&(c=c.multiply(a.rootMatrix)),l.applyMatrix4(c);const{meshInfo:u}=t[i];if(l.name=s.nodeIndexId,l.indexGroups=u.indexGroups,l.indexCount=u.iAccInfoCount,l.databagId=s.content.meshes.databagId,l.fileId=s.content.meshes.fileId,l.isInstanceMeshNode=!0,l.matrixRoot=u.matrixRoot,l.isMeshQuantization=!!u.isCompressedMode,l.contentId=s.tileId,function(e,t){const i=t.materialManager.lightMapManager,n=e.name,a=`${n}_0`;if(!i||!i.hasUv2Info(e.contentId,a))return;const s=e.geometry,o=e.geometry.attributes.mcol0.count,l=2*s.index.count,d=i.getInstanceUV2InfoByNodeId(e.contentId,n,o,l),h=new THREE.InstancedBufferAttribute(new Float32Array(d.offsetRepeat),4,!1,1);s.setAttribute("uv2OffsetRepeat",h);const c=new THREE.Float32BufferAttribute(d.uv2Array,2);s.setAttribute("uv2",c),r.GeomUtil.expandBufferGeometryWithUV2(s),e.material.lightMap=d.lightMapTexture,e.material.lightMapIntensity=r.GlobalData.LightmapIntensity,e.material.light=!1,e.material.refreshUniforms(),e.material.needsUpdate=!0}(l,o),r.GlobalData.EnableShadowMap){const e=o.filter.model;l.castShadow=!1===l.material.transparent&&!1!==s.castShadow&&e.castShadow,l.receiveShadow=e.receiveShadow,l.customDepthMaterial=e.manager.getInstanceDepthMaterial()}const p=n(l,h);if(p.visible=!1,s.enableDynamicInstanceLod()){const e=s._tileset.instanceLodMeshPool.getRealLodLevel(s.instanceId,s.insLodLevel),t=s.updateInstanceLodLevelInfo(a.entityID,e);s.content.addLodMeshNode(l,a.entityID,e,t),s.content.addLodMeshNode(p,a.entityID,e,t),s.content.meshes.updateMatrixWorld(!0),o.addInstanceLodMeshIdMap(l.name,i,l,c,e),o.addInstanceLodMeshIdMap(p.name,i,p,c,e)}else s.content.meshes.add(l),s.content.meshes.add(p),o.addInstanceMeshIdMap(l.name,i,l,c),o.addInstanceMeshIdMap(p.name,i,p,c);o.renderableCount++}function s(e,t,n,a,s,o){v(e,t[n],a.entityInfoArray,s,o);let l=t[n].meshMaterial;const d=o.materialManager;d.hasMaterial(l.name)&&(l=d.getMaterialByNameOnly(l.name));const h=l.name+"_second",c=o.materialManager.getMaterialByName(h);i(0,t,n,a,s,o,new r.MeshEx(e,l),0,c)}function o(e,t,i,n,s,o){v(e,t[i],n.entityInfoArray,s,o);let l=t[i].meshMaterial;const d=o.materialManager;d.hasMaterial(l.name)&&(l=d.getMaterialByNameOnly(l.name));const h=l.name+"_second",c=o.materialManager.getMaterialByName(h);a(0,t,i,n,s,o,new r.MeshEx(e,l),0,c)}function l(e,t,n,a,s,o){!function(e,t,i,n,a){var s=a.filter.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;const o=d(i,t.meshInfo.matrixRoot);for(let t=0;t<o.length;++t)e.setAttribute("mcol"+t.toString(),o[t]);const l=r.BimTilesVersionControl.isVersion_3(a.dataVersion),f=c(t.lineMaterial.color,i,l);e.setAttribute("aColor",f);const g=p(i.length,r.EnumElementState.NONE);e.setAttribute("vState",g);const v=u(i.length,s);if(e.setAttribute("vClipping",v),l){const t=h(i);e.setAttribute("id",t);const r=m(i.length);e.setAttribute("pointColorState",r)}}(e,t[n],a.entityInfoArray,0,o);const l=t[n].lineMaterial,f=l.name+"_second",g=o.materialManager.getMaterialByName(f);i(0,t,n,a,s,o,new r.LineSegmentsEx(e,l),0,g)}function d(t,i){const r={column0:[],column1:[],column2:[],column3:[]};for(let n=0;n<t.length;++n){let a=e.copy(t[n].entityMatrix);i&&(a=a.multiply(i));const s=a.elements;r.column0.push(s[0],s[1],s[2]),r.column1.push(s[4],s[5],s[6]),r.column2.push(s[8],s[9],s[10]),r.column3.push(s[12],s[13],s[14])}const n=[];for(let e=0;e<4;++e){const t=r["column"+e.toString()],i=new THREE.InstancedBufferAttribute(new Float32Array(t),3,!1,1);n.push(i)}return n}function h(e){const t=e.length,i=new Uint8Array(4*t);for(let n=0;n<t;++n){const t=r.Utils.UInt32ToVec4(e[n].userID);i[4*n]=t[0],i[4*n+1]=t[1],i[4*n+2]=t[2],i[4*n+3]=t[3]}return new THREE.InstancedBufferAttribute(i,4,!0,1)}function c(e,i,r){const n=i.length,a=[];for(let s=0;s<n;++s){const n=null!=e.opacity?e.opacity:1;-1===i[s].color||0===i[s].color&&!0!==r?a.push(e.r,e.g,e.b,n):(t.setHex(i[s].color),a.push(t.r,t.g,t.b,n))}return new THREE.InstancedBufferAttribute(new Float32Array(a),4,!1,1)}function u(e,t){const i=new Array(e);i.fill(t);return new THREE.InstancedBufferAttribute(new Float32Array(i),1,!1,1)}function p(e,t){const i=new Array(4*e);i.fill(t);return new THREE.InstancedBufferAttribute(new Float32Array(i),4,!1,1)}function m(e){const t=new Array(4*e);t.fill(0);return new THREE.InstancedBufferAttribute(new Uint8Array(t),4,!0,1)}function f(e,t){let i=null;i=t?new THREE.BufferGeometry:new THREE.InstancedBufferGeometry;const n=e.meshMaterial;return r.Utils.isDefined(n)&&n.useCompressedNormal?e.normal&&i.setAttribute("cNormal",e.normal):e.normal&&i.setAttribute("normal",e.normal),i.setAttribute("position",e.position),e.uv&&i.setAttribute("uv",e.uv),e.uv3&&i.setAttribute("uv3",e.uv3),e.barycentric&&i.setAttribute("barycentric",e.barycentric),e.color&&i.setAttribute("color",e.color),i.setIndex(e.index),i.clearGroups(),i.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:0}),i.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:1}),i}function g(e){let t=new THREE.InstancedBufferGeometry;const i=e.lineMaterial;return r.Utils.isDefined(i)&&i.useCompressedNormal?e.normal&&t.setAttribute("cNormal",e.normal):e.normal&&t.setAttribute("normal",e.normal),e.barycentric&&t.setAttribute("barycentric",e.barycentric),t.setAttribute("position",e.position),t.setIndex(e.index),t.clearGroups(),t.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:0}),t}function v(e,t,i,n,a){var s=a.filter.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;const o=d(i,t.meshInfo.matrixRoot);for(let t=0;t<o.length;++t)e.setAttribute("mcol"+t.toString(),o[t]);const l=function(e){const t={column0:[],column1:[]},i=new THREE.Matrix3;for(let r=0;r<e;++r){const e=i.elements;t.column0.push(e[0],e[1]),t.column0.push(e[3],e[4]),t.column1.push(e[6],e[7])}const r=[],n=t.column0,a=new THREE.InstancedBufferAttribute(new Float32Array(n),4,!1,1);r.push(a);const s=t.column1,o=new THREE.InstancedBufferAttribute(new Float32Array(s),2,!1,1);return r.push(o),r}(i.length);for(let t=0;t<l.length;++t)e.setAttribute("muvCol"+t.toString(),l[t]);const f=h(i);e.setAttribute("id",f);const g=r.BimTilesVersionControl.isVersion_3(a.dataVersion),v=c(t.meshMaterial.color,i,g);e.setAttribute("aColor",v);const y=function(e){const t=e.length,i=[];for(let r=0;r<t;++r){const t=e[r].uv3;if(null==t)return null;null!=t&&2===t.length?i.push(t[0],t[1]):i.push(0,0)}return new THREE.InstancedBufferAttribute(new Float32Array(i),2,!1,1)}(i);y&&e.setAttribute("uv3",y);const M=u(i.length,s);if(e.setAttribute("vClipping",M),g){const t=m(i.length);e.setAttribute("pointColorState",t);const r=function(e){const t=new Array(4*e);return t.fill(0),new THREE.InstancedBufferAttribute(new Float32Array(t),4,!1,1)}(i.length);e.setAttribute("vState",r)}else{const t=p(i.length,r.EnumElementState.NONE);e.setAttribute("vState",t)}}r.InstanceRenderManager=class{constructor(){}static attachToNode(e,t,i,n,a){null!=a.renderDirectly&&!0===a.renderDirectly?function(e,t,i,r){for(let n=0;n<r.length;++n)for(let n=0;n<e.length;++n){s(f(e[n],!0),e,n,r,t,i)}}(e,t,i,n):function(e,t,i,n){for(let a=0;a<e.length;++a)if(e[a].meshMaterial){const l=f(e[a],!1);r.BimTilesVersionControl.isVersion_3(i.dataVersion)?o(l,e,a,n,t,i):s(l,e,a,n,t,i)}else if(e[a].lineMaterial){l(g(e[a]),e,a,n,t,i)}}(e,t,i,n)}}}();r.SharedGeometryLoader=class{constructor(e){this._loader=e,this._entityMap={},this._waitingTaskMap={}}destroy(){this._entityMap=null,this._waitingTaskMap=null}loadArrayBuffer(e,t,i){return new Promise(((r,n)=>{const a=this._entityMap[e];if(void 0!==a)if("loaded"===a.status){const s=a.geoArrayBuffer;r(s)}else if("loading"===a.status){function o(e){r(e)}this._waitingTaskMap[e].push(o)}else"failed"===a.status&&n("load entity failed");else{function l(e){r(e)}this._entityMap[e]={status:"loading",geoArrayBuffer:null},this._waitingTaskMap[e]=[l];(function(e,t){const i=new Promise(((i,r)=>{t.loadArrayBufferImmediately(e,(e=>{i(e)}),(e=>{r(e)}))}));return i})(t+e,i).then((t=>{this._entityMap[e].geoArrayBuffer=t,this._entityMap[e].status="loaded";const i=this._waitingTaskMap[e];for(let e=0;e<i.length;++e)i[e](t);this._waitingTaskMap[e]=null})).catch((()=>{this._entityMap[e].status="failed",this._waitingTaskMap[e]=null}))}}))}},function(){const e=Object.freeze({UNLOADED:"unloaded",LOADING:"loading",LOADED:"loaded",FAILED:"failed"});class t{constructor(){this._id=null,this._byteLength=0,this._refCount=0,this._attrs=null,this._status=e.UNLOADED}destroy(){this._attrs=null}get refCount(){return this._refCount}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}set attributes(e){this._attrs=e}get attributes(){return this._attrs}set status(e){this._status=e}get status(){return this._status}resetRef(){this._refCount=0}ref(){++this._refCount}unRef(){--this._refCount}isUnloaded(){return this._status===e.UNLOADED}isLoading(){return this._status===e.LOADING}isLoaded(){return this._status===e.LOADED}isFailed(){return this._status===e.FAILED}}r.SharedGeometryAttributesManager=class{constructor(){this._entityMap={},this._waitingTaskMap={}}destroy(){this._entityMap={},this._waitingTaskMap={}}getGeometryAttributes(e){return this._entityMap[e]}isUseGeometryAttributesByOthers(e){const t=this.getGeometryAttributes(e);return!(!t||!t.attributes)&&(t.refCount,1!==t.refCount)}getGeometryAttributeNames(e,t){const i=this.getGeometryAttributes(e);if(!i)return null;const r=i.attributes;if(t>=r.length)return null;const n=r[t],a=Object.keys(n).filter((e=>!!n[e]));return a.length?a:null}disposeGeometryAttributes(e){let t=this._entityMap[e];t&&(t.refCount>0&&t.unRef(),0===t.refCount&&(t.destroy(),this._entityMap[e]=void 0,delete this._entityMap[e]))}parseGeometryAttributes(t,i,r,n){return new Promise(((a,s)=>{function o(e){a(e)}let l=this.getGeometryAttributes(r);if(void 0!==l)l.isLoaded()?(l.ref(),a({attributes:l.attributes,byteLength:l.byteLength})):l.isLoading()?(l.ref(),this._addResolvedFn(r,o)):l.isFailed()&&s("load entity failed");else{l=this._createGeometryAttributes(r),l.status=e.LOADING,l.ref(),this._setResolvedFn(r,o);const a=n+r;i.loadArrayBufferToPromise(a).then((n=>{this._hasGeometryAttributes(r)?t.loadInstanceEntityCallBack(i,n).then((t=>{this._hasGeometryAttributes(r)?(this._setGeometryAttributes(r,{id:r,attributes:t,byteLength:n.byteLength,status:e.LOADED}),this._fireResolvedFn(r,{attributes:t,byteLength:n.byteLength}),n=null,t=null):this._fireResolvedFn(r,null)})).catch((e=>{console.log("parse failed:",e),this._handleFailedLoad(r)})):this._fireResolvedFn(r,null)})).catch((e=>{console.log("load failed:",e),this._handleFailedLoad(r)}))}}))}_hasGeometryAttributes(e){return!!this.getGeometryAttributes(e)}_createGeometryAttributes(e){return this._entityMap[e]=new t,this._entityMap[e]}_setGeometryAttributes(t,i){const r=this.getGeometryAttributes(t);void 0!==i.attributes&&(r.attributes=i.attributes),void 0!==i.byteLength&&(r.byteLength=i.byteLength),void 0!==i.id&&(r.id=i.id),r.status=i.status,void 0!==i.status&&i.status===e.FAILED&&r.resetRef()}_fireResolvedFn(e,t){const i=this._waitingTaskMap[e];if(i){for(let e=0;e<i.length;++e)i[e](t);this._removeResolvedFn(e)}}_setResolvedFn(e,t){this._waitingTaskMap[e]=[t]}_addResolvedFn(e,t){this._waitingTaskMap[e].push(t)}_removeResolvedFn(e){this._waitingTaskMap[e]=null,delete this._waitingTaskMap[e]}_handleFailedLoad(t){this._hasGeometryAttributes(t)&&this._setGeometryAttributes(t,{status:e.FAILED}),this._fireResolvedFn(t,null)}}}(),function(){const e=Object.freeze({UNLOADED:"unloaded",LOADING:"loading",LOADED:"loaded",FAILED:"failed"});class t{constructor(){this._id=null,this._byteLength=0,this._refCount=0,this._contentType=0,this._contentBlob=null,this._status=e.UNLOADED,this._readyDeferred=new r.Deferred}destroy(){this._contentBlob=null,this._readyDeferred.destroy(),this._readyDeferred=null}get readyPromise(){return this._readyDeferred.promise}get refCount(){return this._refCount}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}set contentBlob(e){this._contentBlob=e}get contentBlob(){return this._contentBlob}set contentType(e){this._contentType=e}get contentType(){return this._contentType}set status(e){this._status=e}get status(){return this._status}resetRef(){this._refCount=0}ref(){++this._refCount}unRef(){--this._refCount}isUnloaded(){return this._status===e.UNLOADED}isLoading(){return this._status===e.LOADING}isLoaded(){return this._status===e.LOADED}isFailed(){return this._status===e.FAILED}resolveDeferred(e){this._readyDeferred.resolve(e)}}r.SharedInstanceManager=class{constructor(){this._entityMap={},this._waitingTaskMap={},this._callbacks={}}destroy(){this._entityMap={},this._waitingTaskMap={}}getInstance(e){return this._entityMap[e]}disposeInstance(e){let t=this._entityMap[e];t&&(t.refCount>0&&t.unRef(),0===t.refCount&&(t.destroy(),this._entityMap[e]=void 0,delete this._entityMap[e]))}parseInstance(e){return new Promise(((t,i)=>{let r=this.getInstance(e);r?r.isLoaded()?(r.ref(),t({contentBlob:r.contentBlob,contentType:r.contentType,byteLength:r.byteLength})):r.isLoading()?(r.ref(),this._addResolvedFn(e,(function(e){t(e)}))):r.isFailed()&&i("load entity failed"):i("no instance content blob!")}))}hasInstance(e){return!!this.getInstance(e)}_createInstance(e){return this._entityMap[e]=new t,this._entityMap[e]}_setInstance(t,i){const r=this.getInstance(t);void 0!==i.id&&(r.id=i.id),void 0!==i.contentBlob&&(r.contentBlob=i.contentBlob),void 0!==i.contentType&&(r.contentType=i.contentType),void 0!==i.byteLength&&(r.byteLength=i.byteLength),r.status=i.status,void 0!==i.status&&i.status===e.FAILED&&r.resetRef()}_fireResolvedFn(e,t){const i=this._waitingTaskMap[e];if(i){for(let e=0;e<i.length;++e)i[e](t);this._removeResolvedFn(e)}}_initResolvedFn(e){this._waitingTaskMap[e]=[]}_addResolvedFn(e,t){this._waitingTaskMap[e].push(t)}_removeResolvedFn(e){this._waitingTaskMap[e]=null,delete this._waitingTaskMap[e]}_handleFailedLoad(t){this.hasInstance(t)&&this._setInstance(t,{status:e.FAILED}),this._fireResolvedFn(t,null)}initInstance(t){const i=this._createInstance(t);i.status=e.LOADING,i.ref(),this._initResolvedFn(t),i.readyPromise.then((i=>{this.hasInstance(t)?(this._setInstance(t,{id:t,contentBlob:i.contentBlob,contentType:i.contentType,byteLength:i.byteLength,status:e.LOADED}),this._fireResolvedFn(t,{contentBlob:i.contentBlob,contentType:i.contentType,byteLength:i.byteLength}),i=null):this._fireResolvedFn(t,null)})).catch((e=>{console.log("load failed:",e),this._handleFailedLoad(t)}))}handleInstance(e,t){this.getInstance(e).resolveDeferred(t)}}}(),r.BimTileInstanceParser=class{constructor(e){this._contentFolder,this._delayLoadTexture=e.delayLoadTexture,this._renderDirectly=null!=e.renderDirectly&&!0===e.renderDirectly&&e.renderDirectly,this._sharedAttributesManager=new r.SharedGeometryAttributesManager,this.materialManager=e.materialManager}set contentFolder(e){this._contentFolder=e}get contentFolder(){return this._contentFolder}destroy(){this._sharedAttributesManager.destroy(),this._sharedAttributesManager=void 0,this.materialManager=null}parseBlobs(e,t,i){t.isInstanceTile=!0,t.userIndexMap=new Map;const r=proto.BlockHeader.BlockType.BT_INSTANCE;for(let s in t.buffer){var n=t.getBuffer(s);if(n.type==r){var a=n.content;a&&this.parseBlob(e,a,t,i)}}}parseBlob(e,t,i,n){if(!t)return;const a=t.getBlobHeader();let s=r.Utils.isDefined(i.contentInsModel)?i.contentInsModel:a.getEntityUrl();const o=`${r.Utils.isDefined(i.contentId)?i.contentId:a.getTileId()}_${a.getBlockId()}`,l=this._parseInstanceBlob(e,i,t,o),d={entityID:s,entityInfoArray:l.entityInfoArray};i.instanceInfo=d,this._parseInstanceMeshBlob(s,l,i,o,e,n)}_parseInstanceMeshBlob(e,t,i,n,a,s){this._sharedAttributesManager.parseGeometryAttributes(this,a,e,i._contentFolder).then((e=>{i.checkIfProcessingTileAvailable()&&e&&(i.nodeIndexId=n,i.updateContentLength(e.byteLength),r.InstanceRenderManager.attachToNode(e.attributes,i,a,t,{renderDirectly:this._renderDirectly}),s&&s(i))})).catch((e=>{console.log(e)}))}_addInstanceNodeInfo(e,t,i,r,n,a,s){const o=i.userID,l=r,d={bufferId:r,instanceIndex:n,entityMatrix:i.entityMatrix,type:proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE};e.disableUserData?e.addNoUserDataInstanceNodeInfo(o,l,d):e.patchInstanceNodeInfo(o,l,d,s)}createInstanceMeshBlobParser(e){return new r.BimTileInstanceMeshBlobParser(e)}_loadInstanceEntityCallBack(e,t,i,r){return new Promise(((n,a)=>{const s=this._parseInstanceEntityBlob(e,t.tileReader);s.contentIndex=i;let o=this.createInstanceMeshBlobParser({_delayLoadTexture:null,renderDirectly:r,materialManager:t.materialManager});o.parse(t,s).then((()=>{const e=this._bufferGeometry(o);o.destroy(),o=null,n(e)})).catch((e=>{a(e)}))}))}loadInstanceEntityCallBack(e,t){return this._loadInstanceEntityCallBack(t,e,void 0,this._renderDirectly)}_parseInstanceEntityBlob(e,t){const i={parent:!0},r={node:i,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH};return t.parseBlock(e,r),i}_parseInstanceBlob(e,t,i,n){const a=i.getBlobHeader(),s=new THREE.Matrix4,o=[],l=a.getMatrixList();let d=a.getPackingUvList();if(16===l.length){s.fromArray(l);let e=a.getTranslationList();r.Utils.isDefined(e)&&3===e.length&&s.setPosition(e[0],e[1],e[2])}const h=i.getInstancesList(),c=n;for(let i=0;i<h.length;++i){const r=h[i],n=new THREE.Matrix4,a=r.getMatrixList();16===a.length&&n.fromArray(a);const l=r.getUserId(),u=r.getColor();t.userIndexMap.set(l,!0);const p=r.getUserdataId(),m=e.tileReader.getUserDataByIndex(p);let f=new Array(2).fill(0),g=r.getPackingUvList();null!=g&&2===g.length&&(f=g),null!=d&&2===d.length&&(f=d),null==d&&null==g&&(f=null),null!=d&&0===d.length&&null!=g&&0===g.length&&(f=null);const v={userID:l,userDataID:p,userData:m,entityMatrix:n,color:u,uv3:f};o.push(v),e.pbfNodeInfoMap[c]||this._addInstanceNodeInfo(e,r,v,c,i,s,t.contentId)}return e.pbfNodeInfoMap[c]={},{entityInfoArray:o,rootMatrix:s}}_bufferGeometry(e){const t=[];for(const[i,r]of Object.entries(e._geoBuffers)){const e=r;for(let i=0;i<e.length;++i)if(e[i].meshInfo.useDraco){const r=this._getAttributeBufferFromDracoGeoBuffer(e[i].bufferGeometry);r.meshInfo=e[i].meshInfo,r.meshMaterial=e[i].meshMaterial,t.push(r)}else t.push(e[i])}return t}_getAttributeBufferFromDracoGeoBuffer(e){const t={};for(const[i,r]of Object.entries(e.attributes))t[i]=r;return t.index=e.index,t}disposeSharedGeometryAttributes(e){this._sharedAttributesManager.disposeGeometryAttributes(e)}isUseSharedGeometryAttributesByOthers(e){return this._sharedAttributesManager.isUseGeometryAttributesByOthers(e)}getSharedGeometryAttributeNames(e,t){return this._sharedAttributesManager.getGeometryAttributeNames(e,t)}},r.BimTileInstanceMeshBlobParser=class{constructor(e){this._geoBuffers={},this.materialManager=e.materialManager,this._renderDirectly=null!=e.renderDirectly&&!0===e.renderDirectly,this._parsePromiseArray=[]}get renderDirectly(){return this._renderDirectly}destroy(){this._parsePromiseArray=null,this._geoBuffers=null,this.materialManager=null}parse(e,t){if(!t||!t.buffer)return;const i=this._getBufferInfo(e,t);if(!i)return;const r=i.meshBlob.getScenesList();if(!r.length)return;this._traverseScenes(r,i);const n=this;return new Promise(((e,t)=>{Promise.all(n._parsePromiseArray).then((()=>{n._parsePromiseArray=null,e()})).catch((()=>{n._parsePromiseArray=null,t("some error when paser mesh block "+i.bufferId)}))}))}_getBufferInfo(e,t){const i=t.buffer[0].content,r=i.getBlobHeader(),n=r.getBufferBlockId(),a=t.buffer[n].content;if(!a)return null;const s=a.getBuffer();let o={};return o.contentIndex=t.contentIndex,o.meshBlob=i,o.buffer=a,o.bufferData=s,o.bufferId=`${r.getTileId()}_${n}`,o.loader=e,o.node=t,o.renderInstance=!this._renderDirectly,o}_traverseScenes(e,t){const i=e.length;for(let r=0;r<i;++r){const i=e[r],n=i.getNodesList(),a=i.getName();this._traverseNodesPerScene(n,t,a)}}_traverseNodesPerScene(e,t,i){const r=e.length;for(let n=0;n<r;++n){const r=e[n],a=t.meshBlob.getNodesList()[r];let s=new THREE.Matrix4;16==a.getMatrixList().length&&s.fromArray(a.getMatrixList());const o={};o.nodeIndex=r,o.matrix=s,o.sceneName=i,this._parseBufferNode(a,o,t)}}_parseBufferNode(e,t,i){const r=e.getPrimitivesList();return e.getNodeType()!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE&&this._traversePrimitivesPerNode(r,t,i),!0}_traversePrimitivesPerNode(e,t,i){const r=e.length;if(!r)return;++this._meshCount;const n=new Promise((n=>{let a=0;for(let s=0;s<r;s++){const o=e[s],l=i.meshBlob.getPrimitivesList()[o];if(l.quantizebits=t.quantizebits,l.isCompressedMode=t.isCompressedMode,l.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES||l.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES){let e=null;if(e=l.getAccArchive()>=0?this._getBufferByPrimitive_Draco(l,t,i):this._getBufferByPrimitive(l,t,i),e){const t=this;e.then((e=>{++a,t._geoBuffers[e.meshInfo.sceneName]?t._geoBuffers[e.meshInfo.sceneName].push(e):t._geoBuffers[e.meshInfo.sceneName]=[e],a===r&&n()})).catch((e=>{console.log(e)}))}}}}));return this._parsePromiseArray.push(n),n}_getBufferByPrimitive(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return;if(this._resetMeshBuffer(i),!i.buffer)return;const{meshBlob:r,bufferData:n}=i,a={nodeIndex:t.nodeIndex,matrixRoot:t.matrix,sceneName:t.sceneName,isCompressedMode:t.isCompressedMode,useDraco:!1},s=this._getNormal(r,n,a,e),o=this._getVertex(r,n,a,e),l=this._getIndex(r,n,a,e),d=this._getTextureCoord(r,n,a,e),h=this._getTextureCoord3(r,n,a,e),c=this._getColor(r,n,a,e),u=this._getBarycentric(r,n,a,e),p=this;return new Promise(((t,r)=>{if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES)p.materialManager.getMaterial(i.loader,i,e,(i=>{if(e.hasUV3=!!h,i){const e={normal:s||null,position:o.vertexBufferAttribute,index:l.indexBufferAttribute,uv:d?d.uvBufferAttribute:null,meshMaterial:i,meshInfo:a,color:c,barycentric:u||null};h&&(e.uv3=h.uvBufferAttribute),t(e)}else r("get material faild")}));else if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES){const r=p.materialManager.getLineMaterial(i.loader,i,e,!0),n={normal:s||null,position:o.vertexBufferAttribute,index:l.indexBufferAttribute,barycentric:u||null,lineMaterial:r,meshInfo:a};t(n)}}))}_getBufferByPrimitive_Draco(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return;if(this._resetMeshBuffer(i),!i.buffer)return;const{meshBlob:n}=i,{bufferData:a}=i,{material:s}=i,o=n.getBufferaccsList()[e.getAccArchive()],l=o.getByteOffset(),d=o.getByteLength(),h=a.slice(l,l+d).buffer,c=this,u={nodeIndex:t.nodeIndex,matrixRoot:t.matrix,sceneName:t.sceneName,useDraco:!0};return new Promise((t=>{r.TilesUtil.getDracoLoader().decodeDracoFile(h,(function(r){s&&e.getMaterialId()>=-1&&(r.clearGroups(),r.groups.push({start:0,count:r.index.count,materialIndex:0}),u.iAccInfoCount=r.index.count,c.materialManager.getMaterial(i.loader,i,e,(e=>{t({bufferGeometry:r,meshMaterial:e,meshInfo:u})})))}))}))}_resetMeshBuffer(e){const t=e.meshBlob.getBlobHeader(),i=t.getBufferBlockId(),r=t.getMaterialBlockId(),n=t.getUserdataBlockId(),a=e.node.buffer[i].content,s=-1===r?e.loader.tileReader.globalMaterialBuffer:e.node.buffer[r].content;e.buffer=a,e.materialBlockId=r,e.material=s,e.userdataBlockId=n,a&&(e.bufferData=a.getBuffer())}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getNormal(e,t,i,r){const n=this._getAccInfo(e,r.getAccNormals());if(n.count>0){let e,a;const s=t.slice(n.offset,n.offset+n.length).buffer;switch(i.nAccInfoStart=n.offset,i.nAccInfoCount=n.count,n.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:e=new Uint8Array(s),r.useCompressedNormal=!0,a=new THREE.BufferAttribute(e,2);break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:e=new Float32Array(s),r.useCompressedNormal=!1,a=new THREE.BufferAttribute(e,3)}return a}return null}_getBarycentric(e,t,i,r){const n=this._getAccInfo(e,r.getAccBarycentric());if(r.useBCOutline=!1,n.count>0){let e,a;const s=t.slice(n.offset,n.offset+n.length).buffer;return i.bcAccInfoStart=n.offset,i.bcAccInfoCount=n.count,e=new Uint8Array(s),r.useBCOutline=!0,a=new THREE.BufferAttribute(e,3),a}return null}_getVertex(e,t,i,r){const n=this._getAccInfo(e,r.getAccVertices()),a=t.slice(n.offset,n.offset+n.length).buffer,s=8==n.length/n.count,o=r.quantizebits;let l=this._convertVertexArray(a,s,o);return i.vAccInfoStart=n.offset,{vertexBufferData:a,vertexBufferAttribute:new THREE.BufferAttribute(l,3)}}_getColor(e,t,i,r){const n=this._getAccInfo(e,r.getAccColor());if(0===n.length||0===r.getAccColor())return null;const a=t.slice(n.offset,n.offset+n.length).buffer;let s=new Uint8Array(a);i.cAccInfoStart=n.offset,r.vertexColors=!0;const o=new THREE.BufferAttribute(s,4);return o.normalized=!0,o}_getIndex(e,t,i,r){const n=this._getAccInfo(e,r.getAccIndices()),a=t.slice(n.offset,n.offset+n.length).buffer;let s=null;return s=n.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT?new Uint16Array(a):new Uint32Array(a),i.iAccInfoStart=n.offset,i.iAccInfoCount=n.count,{indexBufferData:a,indexBufferAttribute:new THREE.BufferAttribute(s,1)}}_getTextureCoord(e,t,i,r){i.tAccInfoStart=0;const n=this._getAccInfo(e,r.getAccTexcoords());if(n.count>0){const e=t.slice(n.offset,n.offset+n.length).buffer;i.tAccInfoStart=n.offset;let r=new Float32Array(e);return{uvBufferData:e,uvBufferAttribute:new THREE.BufferAttribute(r,2)}}return null}_getTextureCoord3(e,t,i,r){i.tAccInfoStart=0;const n=this._getAccInfo(e,r.getAccTexcoords3());if(6!=n.valueType)return null;if(n.count>0){const e=t.slice(n.offset,n.offset+n.length).buffer;i.tAccInfoStart=n.offset;let r=new Float32Array(e);return{uvBufferData:e,uvBufferAttribute:new THREE.BufferAttribute(r,2)}}return null}_getBufferData(e){return r.BimTileMeshParser.getBufferData(e)}_convertVertexArray(e,t,i){return r.BimTileMeshParser.convertVertexArray(e,t,i)}},r.BimTileSearchTreeManager=class{constructor(e){this.reader=e,this.is2D=!1,this.searchTreeBuffer={}}destroy(){this.reader=null,this.searchTreeBuffer=null}setIs2D(e){this.is2D=e}addSearchTreeBuffer(e,t,i){void 0===this.searchTreeBuffer[e]&&(this.searchTreeBuffer[e]={},this.searchTreeBuffer[e].searchTreeBlob=i,this.searchTreeBuffer[e].box=t)}getSearchTreeBuffer(){return this.searchTreeBuffer}intersect(e,t,i,n,a,s){let o,l=r.Utils.scratchBoundingBox;if(!t){let t=r.Utils.scratchMatrix4_1;t.copy(n).invert(),o=e.ray.clone().applyMatrix4(i).applyMatrix4(t)}let d=t?function(e){let i=l.copy(e);return i.applyMatrix4(n),t.intersectsBox(i)?1:-1}:function(e){return o.intersectBoxWithDistance(e)},h={};const c=this.searchTreeBuffer;for(const e in c){const t=c[e].searchTreeBlob,i=c[e].box,n=d(i);if(!s&&n<0)continue;const a=t.getNodeIdsList(),o=t.getOctreeList(),l=t.getOctreeList()[0];let u=function(e,t){const i=r.TilesUtil.getBox(t.getBboxList()),n=d(i);if(!s&&n<0)return;let o=t.getNodesList();const l=o.length;for(let e=0;e<l;++e){const t=o[e],i=a[t],n=r.TilesUtil.getBox(i.getBboxList()),l=d(n);if(!s&&l<0)continue;const c=`${i.getTileId()}_${i.getBlockId()}_${i.getNodeId()}`;void 0===h[i.getUserId()]?h[i.getUserId()]=[c]:h[i.getUserId()].push(c)}t.getChildrenList().map((t=>{const i=e[t];u(e,i)}))};u(o,l)}return h}getObjectsInBoxByBimtile(e,t,i,n,a){let s=r.Utils.scratchBoundingBox,o=(e,t,r)=>{let n=s.copy(e).applyMatrix4(t).applyMatrix4(r);return!!i.intersectsBox(n)&&(a(n)?1:2)};const l=this.searchTreeBuffer,d=t.getTransformMatrix();for(const i in l){const a=l[i].searchTreeBlob,s=l[i].box;if(!o(s,d,n))continue;const h=a.getNodeIdsList(),c=a.getOctreeList(),u=a.getOctreeList()[0];let p=function(i,a){const s=r.TilesUtil.getBox(a.getBboxList());if(!o(s,d,n))return;let l=a.getNodesList();for(let i=0,a=l.length;i<a;++i){const a=l[i],s=h[a],c=r.TilesUtil.getBox(s.getBboxList());if(2!==o(c,d,n))continue;const u=s.getUserId(),p=t.getRealUserId(u);e[p]=!0}a.getChildrenList().map((e=>{const t=i[e];p(i,t)}))};p(c,u)}}getUserIdsInFrustum(e,t,i,n,a,s){const o=e.getNodeIdsList(),l=e.getOctreeList(),d=e.getOctreeList()[0];let h=new THREE.Box3,c=(e,l)=>{const d=r.TilesUtil.getBox(l.getBboxList());if(h.copy(d),h.applyMatrix4(n).applyMatrix4(a),!t.intersectsBox(h)&&!s)return;let u=l.getNodesList();const p=u.length;for(let e=0;e<p;++e){const l=u[e],d=o[l],c=r.TilesUtil.getBox(d.getBboxList());if(h.copy(c),h.applyMatrix4(n).applyMatrix4(a),!t.intersectsBox(h)&&!s)continue;const p=`${d.getTileId()}_${d.getBlockId()}_${d.getNodeId()}`;void 0===i[d.getUserId()]?i[d.getUserId()]=[p]:i[d.getUserId()].push(p)}l.getChildrenList().map((t=>{const i=e[t];c(e,i)}))};c(l,d)}},r.BimTileNodeIdInfo=class{constructor(){this._index=void 0,this._userId=void 0,this._boundingBox=null,this._instanceOrNot=!1,this._tileId=void 0,this._lineId=void 0,this._parent=void 0,this._matrix=void 0,this._materialId=void 0,this._type=void 0,this._owner=void 0}clone(){return{index:this.index,userId:this.userId,boundingBox:this.boundingBox,instanceOrNot:this.instanceOrNot,tileId:this.tileId,lineId:this.lineId,nodeId:this.nodeId,parent:this.parent,geometryId:this.geometryId,matrix:this.matrix,materialId:this.materialId}}destroy(){this._userId=void 0,this._boundingBox=null,this._instanceOrNot=void 0,this._index=void 0,this._lineId=void 0,this._tileId=void 0,this._parent=void 0,this._matrix=void 0,this._materialId=void 0,this._explodeMatrix=void 0,this._type=void 0,this._owner=void 0}get index(){return this._index}set index(e){this._index=e}get name(){return this._userId}set name(e){this._userId=e}get userId(){return this._userId}set userId(e){this._userId=e}get tileId(){return parseInt(this._tileId)}set tileId(e){this._tileId=e.toString()}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}get nodeId(){return this.instanceOrNot?`${this._tileId}_0`:`${this._tileId}_0_${this._index}`}get instanceOrNot(){return this._instanceOrNot}set instanceOrNot(e){this._instanceOrNot=e}get lineId(){return`outline_${this._tileId}`}get parent(){return this._parent}set parent(e){this._parent=e}get matrix(){return this._matrix}set matrix(e){this._matrix=e}get type(){return this._type}set type(e){this._type=e}get materialId(){return this._materialId}set materialId(e){this._materialId=e}get geometryId(){return this.nodeId}get geometryId(){return this.nodeId}set geometryId(e){this._nodeId=e}set owner(e){this._owner=e}get owner(){return this._owner}get state(){return this._owner?this._owner._state:void 0}get material(){return this._owner?this._owner._material:void 0}get explodeMatrix(){return this._owner?this._owner._explodeMatrix:void 0}get loadedExplodeMatrix(){return this._owner?this._owner._loadedExplodeMatrix:void 0}get userData(){return this._owner?this._owner._userData:void 0}update(e,t){this.owner=e,this.originBox=t.getNodeBoxByIndex(this.boundingBox),this.boundingBox=this.originBox.clone(),e.loadedExplodeMatrix&&this.boundingBox.applyMatrix4(e.loadedExplodeMatrix)}},function(){class e extends r.BimTileNodeIdInfo{constructor(){super(),this._userId=void 0,this._userData=void 0,this._blockId=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._state=r.EnumObjectState.Visible,this._material=void 0}clone(){return{index:this.index,userId:this.userId,userData:this.userData,boundingBox:this.boundingBox,tileId:this.tileId,blockId:this.blockId,nodeId:this.nodeId,lineId:this.lineId,state:this.state,parent:this.parent,geometryId:this.geometryId,matrix:this.matrix,materialId:this.materialId,explodeMatrix:this.explodeMatrix}}destroy(){super.destroy(),this._userId=void 0,this._userData=void 0,this._state=void 0,this._blockId=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}get name(){return this._userId}set name(e){this._userId=e}get explodeMatrix(){return this._explodeMatrix}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get state(){return this._state}set state(e){this._state=e}get userId(){return this._userId}set userId(e){this._userId=e}get blockId(){return parseInt(this._blockId)}set blockId(e){this._blockId=e.toString()}get boundingBox(){const e=r.TilesUtil.getBox(this._boundingBox).clone();return this._loadedExplodeMatrix?e.applyMatrix4(this._loadedExplodeMatrix):e}applyBoxMatrix(e){const t=r.TilesUtil.getBox(this._boundingBox).clone().applyMatrix4(e);this._boundingBox=[t.min.x,t.min.y,t.min.z,t.max.x,t.max.y,t.max.z]}set boundingBox(e){this._boundingBox=e}get nodeId(){return this._instanceOrNot?`${this._tileId}_${this._blockId}`:`${this._tileId}_${this._blockId}_${this._index}`}get userData(){return this._userData}set userData(e){this._userData=e}get geometryId(){return this.nodeId}set geometryId(e){this._nodeId=e}get material(){return this._material}set material(e){this._material=e}}r.BimTileNodeInfo=e}(),r.BimTileUserIdTool=class{constructor(){this.globalUserIdUrls=[],this.globalUserIdBuffers=[],this.userIndexStringMap={},this.userStringIndexMap={},this.userDataIndexMap={}}destroy(){this.globalUserIdUrls=null,this.globalUserIdBuffers=null,this.userIndexStringMap=null,this.userStringIndexMap=null,this.userDataIndexMap=null}addGlobalUserIdUrl(e){this.globalUserIdUrls.push(e)}getGlobalUserIdUrls(){return this.globalUserIdUrls}getGlobalUserIdBuffers(){return this.globalUserIdBuffers}parseUserIdBuffer(e){const t=e.getBlobHeader().getUserIdMin(),i=e.getBlobHeader().getUserIdMax(),r=e.getUserIdsList();for(let e=t;e<=i;++e){const i=r[e-t];this.userIndexStringMap[e]=i,this.userStringIndexMap[i]=e}if(e.getUserdataIdsList){const r=e.getUserdataIdsList();for(let e=t;e<=i;++e)this.userDataIndexMap[e]=r[e-t]}this.globalUserIdBuffers.push(e)}disposeBuffer(){this.globalUserIdBuffers.length=0,this.userDataIndexMap=null}getIndexByUserId(e){return this.userStringIndexMap[e]}getUserIdByIndex(e){return this.userIndexStringMap[e]}},r.BimTileUserDataTool=class{constructor(){this.userDataIndexMap={},this.keysList=null,this.valuesList=null,this.keyStringMap={},this.valueStringMap={}}destroy(){this.userDataIndexMap=null,this.keysList=null,this.valuesList=null,this.keyStringMap=null,this.valueStringMap=null}parseUserDataBuffer(e){this.keysList=e.getBlobHeader().getKeysList(),this.valuesList=e.getBlobHeader().getValuesList(),this.keysList.forEach(((e,t)=>{this.keyStringMap[e]=t})),this.valuesList.forEach(((e,t)=>{this.valueStringMap[e]=t})),e.getUserdataArrayList().map(((e,t)=>{const i=e.getValuesStringMap().getEntryList();let r={};i.map((e=>{r[e[0]]=e[1]})),this.userDataIndexMap[t]=r})),e=null}getUserDataByIndex(e){return this.userDataIndexMap[e]}getUserDataStringMapByIndex(e,t){return[this.keysList[e],this.valuesList[t]]}getUserDataIndexMapByString(e,t){if(!this.hasUserData())return;const i=this.getUserDataIndexKeyByString(e),r=this.getUserDataIndexValueByString(t);return void 0!==e&&void 0!==t?{key:i,value:r}:void 0}getUserDataIndexKeyByString(e){return this.keyStringMap[e]}getUserDataIndexValueByString(e){const t=this.valueStringMap;let i;return e instanceof Array?(i=[],e.forEach((e=>{void 0!==t[e]&&i.push(t[e])}))):i=t[e],i}hasUserData(){return this.keysList&&this.valuesList}},r.BimTileReader=class{constructor(){this.descriptor=new r.BimtileDescriptor,this.searchTreeManager=new r.BimTileSearchTreeManager,this.globalMaterialId=-1,this.globalUserdataId=-1,this.globalMaterialUrl=void 0,this.globalUserDataUrl=void 0,this.globalTileIdUrl=void 0,this.globalInstance=void 0,this.globalLodUrl=void 0,this.globalVisibilityUrl=void 0,this.userIdTool=new r.BimTileUserIdTool,this.userDataTool=new r.BimTileUserDataTool,this.globalMaterialBuffer=null,this.globalUserdataBuffer=null,this.globalTileIdBuffer=null,this.referencedMeshCache={},this.tileIdMap={}}destroy(){this.descriptor.destroy(),this.descriptor=null,this.searchTreeManager.destroy(),this.searchTreeManager=null,this.userIdTool.destroy(),this.userIdTool=null,this.userDataTool.destroy(),this.userDataTool=null,this.userIdBoxTool&&(this.userIdBoxTool.destroy(),this.userIdBoxTool=null),this.nodeIdTool&&(this.nodeIdTool.destroy(),this.nodeIdTool=null),this.nodeBoxTool&&(this.nodeBoxTool.destroy(),this.nodeBoxTool=null),this.globalMaterialBuffer=null,this.globalUserdataBuffer=null,this.globalMaterialUrl=void 0,this.globalUserDataUrl=void 0,this.globalTileIdUrl=void 0,this.globalInstance=void 0,this.referencedMeshCache=null,this.globalTileIdBuffer=null,this.tileIdMap=null}getDescriptor(){return this.descriptor}getBuffer(e,t,i){return-1===t&&i===proto.BlockHeader.BlockType.BT_MATERIAL?this.globalMaterialBuffer:-1===t&&i===proto.BlockHeader.BlockType.BT_USERDATA?this.globalUserdataBuffer:e.getBuffer(t).content}getLineBuffer(e,t,i){return e.getLineBuffer(t).content}getOutlineBuffer(e,t,i){return e.getOutlineBuffer(t).content}getUserIdByIndex(e){return this.userIdTool.getUserIdByIndex(e)}getIndexByUserId(e){return this.userIdTool.getIndexByUserId(e)}getUserDataByIndex(e){return this.userDataTool.getUserDataByIndex(e)}getUserDataStringMapByIndex(e,t){return this.userDataTool.getUserDataStringMapByIndex(e,t)}getUserDataIndexMapByString(e,t){return this.userDataTool.getUserDataIndexMapByString(e,t)}getUserDataIndexKeyByString(e){return this.userDataTool.getUserDataIndexKeyByString(e)}getUserDataIndexValueByString(e){return this.userDataTool.getUserDataIndexValueByString(e)}parseSchemaProperties(e,t){if(void 0===e)return;this.layerKey=e.layerKey,this.layerValue=e.layerValue,this.globalMaterialUrl=e.globalMaterial?t+e.globalMaterial.content.url:void 0,this.globalUserDataUrl=e.globalUserdata?t+e.globalUserdata.content.url:void 0,this.globalTileIdUrl=e.globalTileID?t+e.globalTileID.content.url:void 0,this.globalInstance=e.instanceTiles?t+e.instanceTiles.content.url:void 0,this.globalLodUrl=e.groupTiles?t+e.groupTiles.content.url:void 0,this.globalVisibilityUrl=e.visibilityTiles?t+e.visibilityTiles.content.url:void 0,this.globalShadowVisibilityUrl=e.visibilityShadowTiles?t+e.visibilityShadowTiles.content.url:void 0,this.globalShadowUrl=e.globalShadow?t+e.globalShadow.content.url:void 0;const i=e.globalUserID;i&&i.map((e=>{const i=t+e.content.url;this.userIdTool.addGlobalUserIdUrl(i),this.descriptor.updateMaxUserIDIndex(e.maxUserIDIndex)}));const r=e.globalNodeID;r&&r.map((e=>{const i=t+e.content.url;this.nodeIdTool.addGlobalNodeIdUrl(i,e.startPos)}));const n=e.globalNodeBox;n&&n.map((e=>{const i=t+e.content.url;this.nodeBoxTool.addGlobalNodeBoxUrl(i,e.startPos)}));const a=e.globalUserIDBox;a&&a.map((e=>{const i=t+e.content.url;this.userIdBoxTool.addGlobalUserIdBoxUrl(i,e.startPos)}))}getGlobalUserIdUrls(){return this.userIdTool.getGlobalUserIdUrls()}getGlobalNodeIdUrls(){return this.nodeIdTool&&this.nodeIdTool.getGlobalNodeIdUrls()}getGlobalNodeBoxUrls(){return this.nodeBoxTool&&this.nodeBoxTool.getGlobalNodeBoxUrls()}parseBlock(e,t,i){const n=t.node,a=t.type,s=(t.url,t.outline);let o=!0,l=0,d=[];n.bufferType=a;let h=0;const c=e.byteLength;for(n.buffer=r.Utils.isDefined(n.buffer)?n.buffer:{},n.lineBuffer=r.Utils.isDefined(n.lineBuffer)?n.lineBuffer:{},n.outlineBuffer=r.Utils.defaultValue(n.outlineBuffer,{});h<c;){const t=e.slice(h,h+4);let i=new Uint32Array(t)[0];h+=4;const c=new Uint8Array(e,h,i);h+=i;const p=proto.bimtile_pbf.BlockHeader.deserializeBinary(c);o&&p.getDataType(),i=p.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var u=new Uint8Array(e,h,i);if(h+=i,p.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const m=p.getDataType();let f={};switch(m){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf.SearchTreeBlob.deserializeBinary(u);f.type=m,f.content=e,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf.UserIDBlob.deserializeBinary(u);if(a===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}f.type=m,f.content=t,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_MATERIAL:const i=proto.bimtile_pbf.MaterialBlob.deserializeBinary(u);if(f.type=m,f.content=i,a===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=i;break}n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_USERDATA:const o=proto.bimtile_pbf.UserdataBlob.deserializeBinary(u);if(a===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(o);break}f.type=m,f.content=o,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_BUFFER:const d=proto.bimtile_pbf.BufferBlob.deserializeBinary(u);f.type=m,f.content=d,a===proto.BlockHeader.BlockType.BT_LINE?s?n.outlineBuffer[l]=f:n.lineBuffer[l]=f:n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_MESH:const h=proto.bimtile_pbf.MeshBlob.deserializeBinary(u);f.type=m,f.content=h,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_POINT:const c=proto.bimtile_pbf.PointBlob.deserializeBinary(u);f.type=m,f.content=c,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_TILEID:const p=proto.bimtile_pbf.TileIDBlob.deserializeBinary(u);if(f.type=m,f.content=p,a===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=p;break}n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_INSTANCE:const g=proto.bimtile_pbf.InstanceBlob.deserializeBinary(u);f.type=m,f.content=g,n.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_LINE:const v=proto.bimtile_pbf.MeshBlob.deserializeBinary(u);f.type=m,f.content=v,a===proto.BlockHeader.BlockType.BT_LINE&&s?n.outlineBuffer[l]=f:n.lineBuffer[l]=f;break;default:return void console.warn("Parse unknow block faild! ")}o&&(o=!1),d[l]=l,l++}i&&i()}getBlockType(e){switch(e){case"MESH":return proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH;case"POINT":return proto.bimtile_pbf.BlockHeader.BlockType.BT_POINT;case"INSTANCE":return proto.bimtile_pbf.BlockHeader.BlockType.BT_INSTANCE;case"LINE":return proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE}}addSearchTreeBuffer(e,t,i){this.searchTreeManager.addSearchTreeBuffer(e,t,i)}getSearchTreeBuffer(){return this.searchTreeManager.getSearchTreeBuffer()}createTileIdMap(){if(!this.globalTileIdBuffer)return;const e=this.globalTileIdBuffer.getTilePathList(),t=this.globalTileIdBuffer.getTileIdsList();e.map(((e,i)=>{this.tileIdMap[e]=t[i]}))}getTileIdByPath(e){return this.tileIdMap[e]}createNodeInfoMap(){const e=this.userIdTool.getGlobalUserIdBuffers();for(let t of e)t.getNodeIdsList().map((e=>{const t=new r.BimTileNodeInfo;t.index=e.getNodeId(),t.blockId=e.getBlockId(),t.userId=e.getUserId(),t.userData=e.getUserdataId(),t.boundingBox=e.getBboxList();const i=e.getTileId();if(t.tileId=i,this.globalTileIdBuffer){const e=this.globalTileIdBuffer.getTileIdsList()[i];-1!==this.globalTileIdBuffer.getTilePathList()[e].indexOf("instance")&&(t.instanceOrNot=!0)}this.getDescriptor()._classifyNodeInfo(t)})),t=null;this.userIdTool.disposeBuffer()}clone(e){e.globalMaterialId=this.globalMaterialId,e.globalUserdataId=this.globalUserdataId,e.globalMaterialUrl=this.globalMaterialUrl,e.globalUserDataUrl=this.globalUserDataUrl,e.globalTileIdUrl=this.globalTileIdUrl,e.globalInstance=this.globalInstance,e.globalMaterialBuffer=this.globalMaterialBuffer,e.globalUserdataBuffer=this.globalUserdataBuffer,e.globalTileIdBuffer=this.globalTileIdBuffer,e.searchTreeManager=this.searchTreeManager}getTilePathByTileId(e){const t=this.globalTileIdBuffer;if(!t)return;const i=t.getTileIdsList()[e];return t.getTilePathList()[i]}},r.BimTilesLoader=class{constructor(e){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json"),this.arrayBufferLoader=new THREE.FileLoader,this.arrayBufferLoader.setResponseType("arraybuffer"),this.taskRunner=new r.LoadTaskRunner(4),this.dataVersion=e.dataVersion,this.datetime=e.datetime,this._createTileReader(),this.batchMergeEnabled=e.batchMergeEnabled,this.filter=e.filter,this.modelExplosion=e.modelExplosion,this.wireFrameVisibilityOption=e.wireFrameVisibilityOption,this.materialManager=e.materialManager;const t={batchMergeEnabled:e.batchMergeEnabled,delayLoadTexture:e.delayLoadTexture,materialManager:this.materialManager,renderFunction:e.renderFunction,isShpPoint:e.isShpPoint};this.bimTileParser={},this.bimTileParser[r.TileContentType.DATA_MESH]=new r.BimTileMeshBlobParser(t),this.bimTileParser[r.TileContentType.DATA_CMPT]=this.bimTileParser[r.TileContentType.DATA_MESH],this.bimTileParser[r.TileContentType.DATA_INSTANCE]=new r.BimTileInstanceParser(t),delete t.isShpPoint,this.bimTileParser[r.TileContentType.DATA_POINT]=new r.BimTilePointBlobParser(t),this.bimTileOutlineBlobParser=new r.BimTileOutlineBlobParser(t),this.bimTileLineBlobParser=new r.BimTileLineBlobParser(t),this.batchedWireframeManager=new r.BimTileBatchedWireframeManager(this),this.instancedWireframeManager=new r.BimTileInstancedWireframeManager(this),this.batchedMeshManager=new r.BimTileBatchedMeshManager(this),this.instancedMeshManager=new r.BimTileInstancedMeshManager(this),this._rootUrl=void 0,this.sceneState=e.sceneState,this.userIdMapIndices={},this.pbfNodeInfoMap={},this._enableBorderLine=e.enableBorderLine,this.disableUserData=e.disableUserData,this.indexInfoMap={},this.selectionMeshIdSet={},this.lastSelectionMeshIdSet={},this.CMPTUrlMap={},this._destroyed=!1}destroy(){this._destroyed=!0,this.globalIndexId=null,this.globalMaterialId=null,this.globalUserdataId=null,this.jsonLoader=null,this.arrayBufferLoader=null,this.taskRunner=null,this.tileReader.destroy(),this.tileReader=void 0,this.filter=void 0,this.modelExplosion=void 0,this.bimTileParser[r.TileContentType.DATA_MESH].destroy(),this.bimTileParser[r.TileContentType.DATA_INSTANCE].destroy(),this.bimTileParser[r.TileContentType.DATA_POINT].destroy(),this.bimTileLineBlobParser.destroy(),this.bimTileLineBlobParser=void 0,this.bimTileOutlineBlobParser.destroy(),this.bimTileOutlineBlobParser=void 0,this.bimTileParser=void 0,this._rootUrl=void 0,this.sceneState=null,this.userIdMapIndices=null,this.materialManager=null,this.batchedWireframeManager.destroy(),this.instancedWireframeManager.destroy(),this.batchedMeshManager.destroy(),this.instancedMeshManager.destroy(),this.batchedWireframeManager=null,this.instancedWireframeManager=null,this.batchedMeshManager=null,this.instancedMeshManager=null,this.pbfNodeInfoMap=null,this._enableBorderLine=void 0,this.wireFrameVisibilityOption=null,this.indexInfoMap=null,this.noUserDataMeshNodeInfoMap=null,this.noUserDataInstanceNodeInfoMap=null,this.selectionMeshIdSet=null,this.lastSelectionMeshIdSet=null,this.CMPTUrlMap={}}isDestroyed(){return this._destroyed}set rootUrl(e){this._rootUrl=e}get rootUrl(){return this._rootUrl}_createTileReader(){r.BimTilesVersionControl.isVersion_2(this.dataVersion)?this.tileReader=new r.BimTilesNewReader:this.tileReader=new r.BimTileReader}getDescriptor(){return this.tileReader.getDescriptor()}_loadByLoader(e,t,i,n,a){const s="json"===e.responseType;i?r.RequstPoolLoader.load(e,t,(e=>{n(e),r.EnableStorage&&r.storageManager.addBimtiles(s?JSON.stringify(e):e,t).catch((e=>{}))}),(e=>{a&&a(e)})):e.load(t,(function(e){r.EnableStorage&&r.storageManager.addBimtiles(s?JSON.stringify(e):e,t).catch((e=>{})),n(e)}),void 0,(function(e){a&&a(e)}))}_loadFromStorage(e,t,i,n){r.storageManager.getBimtiles(e).then((e=>i&&i(t?JSON.parse(e):e))).catch((e=>{n&&n()}))}_loadJson(e,t,i,n){e=r.RequestSpliter.splitByUrlMd5(e);const a=()=>{this.isDestroyed()||this._loadByLoader(this.jsonLoader,e,t,i,n)};r.EnableStorage?this._loadFromStorage(e,!0,i,a):a()}loadJson(e,t,i){this._loadJson(e,!0,t,i)}loadJsonImmediately(e,t,i){this._loadJson(e,!1,t,i)}_loadArrayBuffer(e,t,i,n){const a=t=>{this.CMPTUrlMap[e]&&(this.CMPTUrlMap[e].state=r.TileContentState.READY,this.CMPTUrlMap[e].buffer=t,this.CMPTUrlMap[e].callbacks.map((e=>{e&&e(t)}))),i(t)},s=()=>{this.isDestroyed()||this._loadByLoader(this.arrayBufferLoader,e,t,a,n)};r.EnableStorage?this._loadFromStorage(e,!1,a,s):s()}loadArrayBuffer(e,t,i){this._loadArrayBuffer(e,!0,t,i)}loadArrayBufferImmediately(e,t,i){this._loadArrayBuffer(e,!1,t,i)}loadArrayBufferDirectly(e,t){const i=()=>{this.isDestroyed()||this._loadByLoader(this.arrayBufferLoader,e,!1,t)};r.EnableStorage?this._loadFromStorage(e,!1,t,i):i()}loadCMPTArrayBufferImmediately(e,t,i){void 0===this.CMPTUrlMap[e]?(this.CMPTUrlMap[e]={state:r.TileContentState.LOADING,buffer:null,callbacks:[]},this.loadArrayBufferImmediately(e,t,i)):this.CMPTUrlMap[e].state===r.TileContentState.READY?t(this.CMPTUrlMap[e].buffer):this.CMPTUrlMap[e].state===r.TileContentState.LOADING&&this.CMPTUrlMap[e].callbacks.push(t)}loadArrayBufferToPromise(e){return new Promise(((t,i)=>{this.loadArrayBufferImmediately(e,(e=>{t(e)}),(e=>{i(e)}))}))}loadBlock(e,t,i,r){const n=this.tileReader,a={node:t,type:i,url:e};this.loadArrayBuffer(e,(e=>{n.parseBlock(e,a,r)}))}loadUserIdResources(e,t){var i=this.tileReader;let n=1,a=()=>{n--,n<=0&&t()};i.globalUserDataUrl&&(n++,this.loadBlock(i.globalUserDataUrl,e,r.TileContentType.DATA_GLOBAL_USER_DATA,(()=>{a()})));const s=i.getGlobalUserIdUrls();if(s){const t=s.length;n+=t,s.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_USER_ID,(()=>{a()}))}))}const o=i.getGlobalNodeIdUrls();if(o){const t=o.length;n+=t,o.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_NODE_ID,(()=>{a()}))}))}const l=i.getGlobalNodeBoxUrls();if(l){const t=l.length;n+=t,l.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_NODE_BOX,(()=>{a()}))}))}i.globalTileIdUrl&&(n++,this.loadBlock(i.globalTileIdUrl,e,r.TileContentType.DATA_GLOBAL_TILE_ID,(()=>{a()}))),a()}loadGlobalResources(e){const{tileReader:t}=this;return new Promise((i=>{r.Utils.isDefined(t.globalMaterialUrl)?this.loadBlock(t.globalMaterialUrl,e,r.TileContentType.DATA_GLOBAL_MATERIAL,(()=>{i()})):i()}))}loadInstanceResources(e){const{tileReader:t}=this;if(!t.globalInstance)return;const i=this;return new Promise(((n,a)=>{const s=t.globalInstance;i.loadJson(s,(t=>{const a=s.slice(0,s.lastIndexOf("/")+1),o=e.createTile(a,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o.subBimTilesType=r.EnumSubBimTileType.SubBt_instance,o._childrenState=r.TileContentState.READY,n(o)}),(()=>{a("can not load intance root json")}))}))}loadLodResources(e){const{tileReader:t}=this;if(!t.globalLodUrl)return;const i=this;return new Promise(((n,a)=>{const s=t.globalLodUrl;i.loadJson(s,(t=>{t.root.visibilityPriority=9;const a=s.slice(0,s.lastIndexOf("/")+1),o=e.createTile(a,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o._childrenState=r.TileContentState.READY,n(o)}),(()=>{a("can not load group root json")}))}))}loadVisibilityResources(e){const{tileReader:t}=this;if(!t.globalVisibilityUrl)return;const i=this;return new Promise(((n,a)=>{const s=t.globalVisibilityUrl;i.loadJson(s,(t=>{const a=s.slice(0,s.lastIndexOf("/")+1);t.root.visibilityPriority=1,t.root.isExterior=!0;const o=e.createTile(a,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o.subBimTilesType=r.EnumSubBimTileType.SubBt_visibility,o._childrenState=r.TileContentState.READY,n(o)}),(()=>{a("can not load visibility root json")}))}))}loadShadowVisibilityResources(e){const{tileReader:t}=this;if(!t.globalShadowVisibilityUrl)return;const i=this;return new Promise(((n,a)=>{const s=t.globalShadowVisibilityUrl;i.loadJson(s,(t=>{const a=s.slice(0,s.lastIndexOf("/")+1);t.root.visibilityPriority=1,t.root.isShadowExterior=!0;const o=e.createTile(a,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o.subBimTilesType=r.EnumSubBimTileType.SubBt_visibility,o._childrenState=r.TileContentState.READY,n(o)}),(()=>{a("can not load visibility root json")}))}))}parseTileContent(e,t){this.bimTileParser[e.contentType].parseBlobs(this,e,t)}parseTileLineContent(e,t){this.bimTileLineBlobParser.parseBlobs(this,e,t)}parseTileOutlineContent(e,t){this.bimTileOutlineBlobParser.parseBlobs(this,e,t)}setBorderLineVisible(e){this._enableBorderLine=e}isBorderLineVisible(){return this._enableBorderLine}praseWireFrameVisibilityOption(e){if(!0===e)return void(this.wireFrameVisibilityOption=!0);if(!0===e.condition.all)return void(this.wireFrameVisibilityOption=e.isVisible);this.wireFrameVisibilityOption={ids:Object.create(null)},this.wireFrameVisibilityOption.isVisible=e.isVisible;const t=e.condition.ids;let i=e=>{e.map((e=>{this.wireFrameVisibilityOption.ids[e]=!0}))};void 0!==t&&i(this.filter._parseIds(t));const r=e.condition.objectData;void 0!==r&&i(this.filter.getMatchIndexes(r))}updateWireFrameVisibilityOption(e){this.praseWireFrameVisibilityOption(e)}addMeshIdMap(e,t){this.batchedMeshManager.addMeshIdMap(e,t)}getMeshNodeById(e){return this.batchedMeshManager.getMeshNodeById(e)}disposeMeshNodeById(e){this.batchedMeshManager.disposeMeshNodeById(e)}addInstanceMeshIdMap(e,t,i,r){this.instancedMeshManager.addInstanceMeshIdMap(e,t,i,r)}getInstanceMeshNodeById(e){return this.instancedMeshManager.getInstanceMeshNodeById(e)}disposeInstanceMeshNodeById(e){this.instancedMeshManager.disposeInstanceMeshNodeById(e)}addInstanceInfo(e,t){this.instancedMeshManager.addInstanceInfo(e,t)}getInstanceInfoById(e){return this.instancedMeshManager.getInstanceInfoById(e)}addLineNodeById(e,t,i){this.batchedWireframeManager.addLineNodeById(e,t,i)}addInstanceLineNodeById(e,t){this.instancedWireframeManager.addInstanceLineNodeById(e,t)}getLineNodeById(e,t){return this.batchedWireframeManager.getLineNodeById(e,t)}getInstanceLineNodeById(e){return this.instancedWireframeManager.getInstanceLineNodeById(e)}disposeLineNodeById(e){this.batchedWireframeManager.disposeLineNodeById(e)}disposeInstanceLineNodeById(e){this.instancedWireframeManager.disposeInstanceLineNodeById(e)}addUserIdMapIndices(e,t){e.map((e=>{const i=e.userId;void 0===this.userIdMapIndices[i]?this.userIdMapIndices[i]=[{meshId:t,indexId:e.index}]:this.userIdMapIndices[i].push({meshId:t,indexId:e.index})}))}addSearchTree(e,t){this.disableUserData?this.indexInfoMap[e]=t:this.addSearchTreeUrl(e,t)}addSearchTreeUrl(e,t,i){let r={};this.loadBlock(e,r,proto.bimtile_pbf.BlockHeader.BlockType.BT_INDEX,(()=>{this.tileReader.addSearchTreeBuffer(e,t,r.buffer[0].content),i&&i()}))}recoverIndexInfo(e){let t=Object.keys(this.indexInfoMap).length;if(0!==t)for(const i in this.indexInfoMap)this.addSearchTreeUrl(i,this.indexInfoMap[i],(()=>{t--,0===t&&e&&e()}));else e&&e()}recoverNodeInfo(){this.batchedMeshManager.recoverNodeInfo(),this.instancedMeshManager.recoverNodeInfo()}addNoUserDataMeshNodeInfo(e,t,i){this.batchedMeshManager.addNoUserDataMeshNodeInfo(e,t,i)}addNoUserDataInstanceNodeInfo(e,t,i){this.instancedMeshManager.addNoUserDataInstanceNodeInfo(e,t,i)}patchMeshNodeInfo(e,t,i){this.batchedMeshManager.patchMeshNodeInfo(e,t,i)}patchInstanceNodeInfo(e,t,i){this.instancedMeshManager.patchInstanceNodeInfo(e,t,i)}dealLineMeshVisible(e){this.disableUserData?!0===this.wireFrameVisibilityOption?e.visible=this.isBorderLineVisible():e.visible=!1:this.batchedWireframeManager.dealLineMeshVisible(e)}recoverLineNode(){this.batchedWireframeManager.recoverLineNode(),this.instancedWireframeManager.recoverLineNode()}getSelectionMeshId(){this.selectionMeshIdSet={};const e=this.sceneState.getSelectionSet(),t=this.tileReader.getDescriptor();for(const i of e.keys()){const e=this.tileReader.getIndexByUserId(i);t.getNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo;this.selectionMeshIdSet[t.parent]=!0}))}return this.selectionMeshIdSet}getLastSelectionMeshId(){return this.lastSelectionMeshIdSet=Object.assign(this.selectionMeshIdSet),this.lastSelectionMeshIdSet}clearSelectionMeshId(){this.selectionMeshIdSet={}}getInstanceParser(){return this.bimTileParser[r.TileContentType.DATA_INSTANCE]}_generatePMTexture(e){var t=new Float32Array(e);let i=t.length/4096;const r=new THREE.DataTexture(null,0,0,THREE.RGBAFormat,THREE.FloatType);return r.image.data=t,r.image.width=1024,r.image.height=i,r.needsUpdate=!0,r.generateMipmaps=!1,r.magFilter=THREE.NearestFilter,r.minFilter=THREE.NearestFilter,r}_loadPMTextureFromeURL(e){return new Promise(((t,i)=>{var r=new THREE.FileLoader;r.setResponseType("arraybuffer"),r.load(e,(e=>{t(e)}),null,(e=>{i(e)}))}))}_loadPMTextureWithIndexDB(e){return new Promise(((t,i)=>{r.storageManager.getBimtiles(e).then((e=>{t(e)})).catch((n=>{this._loadPMTextureFromeURL(e).then((i=>{r.storageManager.addBimtiles(i,e),t(i)})).catch((e=>{i(e)}))}))}))}loadPackingMatTexture(){const e=`${this.rootUrl}texture/packingMaterialTexture.png`;return new Promise(((t,i)=>{r.EnableStorage?this._loadPMTextureWithIndexDB(e).then((e=>{let i=this._generatePMTexture(e);t(i)})).catch((e=>{i(e)})):this._loadPMTextureFromeURL(e).then((e=>{let i=this._generatePMTexture(e);t(i)})).catch((e=>{i(e)}))}))}},function(){let e=new THREE.Box3,t=new THREE.Vector3,i=new THREE.Vector3;class n extends r.AbstractTileset{constructor(e){super(e=r.Utils.defaultValue(e,{})),this._loader=e.loader,this._errorCoefficient=e.errorCoefficient,this.enableBorderLine=!0===e.enableBorderLine,this.disableUserData=e.disableUserData,this.materialManager=e.materialManager,this.geoErrScaleFactor=1,this.conditions=[],this._nodeManager=new r.BimTileNodeManager,this._boundingBox=new THREE.Box3,this._userIdReady=!1,this.dataVersion=e.loader.dataVersion,this.degradeEnabled=!!this.isDataVersion3(),this.instanceLodMeshPool=null,this.enableShadowVisibility=!1,this.forceLoad=e.forceLoad,this.contenEntiyNum=0,this.contenEntiyCompleted=0,this._model=this._loader.filter.model}destroy(){super.destroy(),this._loader=void 0,this.geoErrScaleFactor=void 0,this._nodeManager=null,this.conditions=[],this.instanceLodMeshPool&&(this.instanceLodMeshPool.destroy(),this.instanceLodMeshPool=null),this.enableShadowVisibility=void 0}_clearDrawableOfTiles(){if(this._objectGroup){this._objectGroup.children.forEach((e=>{e.children.forEach((e=>{e.visible=!1}))}))}this._loader.filter.model.pickingManager.clearDrawable(),this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.hideAll()}loadChildrenOfTile(e,t,i){}_getEncodedTileNodeId(e){const t=`${e.getAbsoluteContentUrl()}_root`;return r.Utils.getEncodedString(t)}createChildrenOfTile(e,t){const i=this._loader,n=e.getAbsoluteContentUrl(),a=n.slice(0,n.lastIndexOf("/")+1),s=this.createTile(a,t,e);if(s.nodeId=this._getEncodedTileNodeId(e),this._nodeManager.addNode(s),s._childrenState=r.TileContentState.READY,s.localIndexList.length>0){const e=s.localIndexList.length;for(let t=0;t<e;++t){const e=s.localIndexList[t];i.addSearchTree(e.url,e.box)}}}createTile(e,t,i){if(!t.root||!t.root.boundingVolume)return;t.properties&&(t.root.properties=t.properties);const r=this._createNewTile(this,i,t.root,e);return r.build(),r}_createNewTile(e,t,i,n){return new r.BimTileNode(e,t,i,n)}loadUserIdResources(e){const t=this._loader.filter.model.id;console.time(`${t}_loaded`);var i=this._loader,r=i.tileReader;i.loadUserIdResources(this.root,(()=>{r.createNodeInfoMap(),i.loadGlobalUserIdBoxUrls&&i.loadGlobalUserIdBoxUrls((()=>{console.timeEnd(`${t}_loaded`),e&&e()})),r.createTileIdMap(),this._userIdReady=!0,i.loadGlobalUserIdBoxUrls||e&&e()}))}loadTileset(e,t,i,n){var a=this,s=this._loader,o=s.tileReader;0!==n?s.loadJsonImmediately(e,(function(n){var l=e.slice(0,e.lastIndexOf("/")+1),d=a.createTile(l,n);if(!d)return void(i&&i());d._childrenState=r.TileContentState.READY,o.parseSchemaProperties(n.properties,l),s.rootUrl=l;let h=1;s.loadGlobalResources(d).then((()=>{a.root=d,a._boundingBox.union(d.boundingBox),!0===a.disableUserData?m():a.loadUserIdResources((()=>{m()}))})),(s instanceof r.BimTilesLoaderV3||s instanceof r.Workers.TilesLoaderV3)&&(h++,s.loadPackingMatTexture().then((e=>{s.filter.model.getModelManager().viewer.packingMatTexture=e,a.materialManager.packingMatTexture=e,m()})).catch((()=>{console.log(`${s.rootUrl} packing material texture does not exist`),m()})));const c=s.loadInstanceResources(a);c&&(h++,c.then((e=>{d.childrenTree.push(e),d.geometricError<e.geometricError&&(d.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),d._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})));const u=s.loadVisibilityResources(a);u&&(h++,u.then((e=>{d.childrenTree.push(e),d.geometricError<e.geometricError&&(d.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),d._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})));const p=s.loadShadowVisibilityResources(a);function m(){h--,0===h&&t(a)}p&&(a.shadowMapManager.setShadowVisibility(!0),a.enableShadowVisibility=!0,h++,p.then((e=>{d.childrenTree.push(e),d.geometricError<e.geometricError&&(d.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),d._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})))}),(function(){i(a)})):i&&i()}preUpdate(e){this.isSkippingTilesUpdate(e)||super.preUpdate(e)}isCheckChildrenPassSSE(){return!0}getMaxGeoErrNode(e){var t=null,i=-1;for(var r of e)r.geometricError>i&&(i=r.geometricError,t=r);return t}updateFrameState(e){e.transformMatrixUpdated=!1,e.maximumScreenSpaceError=this.maximumScreenSpaceError,e.geoErrScaleFactor=this.geoErrScaleFactor*r.Tile.TileMath.unitScale}updateGlobalMatrix(e){this._objectGroup.matrix.copy(e),this._objectGroup.matrix.multiplyMatrices(e,this._transformMatrix),this._objectGroup.matrixAutoUpdate=!1,this._objectGroup.updateMatrixWorld(!0)}updateHomePositionWorld(r){const n=e.copy(this.root.boundingBox).applyMatrix4(this.transformMatrix).applyMatrix4(r.globalMatrix),a=n.getSize(i),s=Math.max(a.x,a.y,a.z);n.getCenter(t).sub(new THREE.Vector3(s,-s,-s)),r.cameraPositionWc=t.applyMatrix4(r.globalInverseMatrix)}updateMaximumScreenSpaceError(e){this.updateHomePositionWorld(e),e.geoErrScaleFactor=this.geoErrScaleFactor*r.Tile.TileMath.unitScale,this.maximumScreenSpaceError=this.maximumScreenSpaceError*this._errorCoefficient}setMaximumScreenSpaceError(e){this.maximumScreenSpaceError=e}getMaximumScreenSpaceError(){return this.maximumScreenSpaceError}getGeoErrScaleFactor(){return this.geoErrScaleFactor}setGeoErrScaleFactor(e){this.geoErrScaleFactor=e}statisticsMeshInformation(){var e={meshCount:0,visibleCount:0},t=this._objectGroup.children;e.meshCount=t.length;for(var i=0,n=t.length;i<n;i++){var a=t[i];r.Utils.isGroupObject(a)&&a.visible&&e.visibleCount++}return e}explode(){let e=this._selectedTiles;for(let t=0,i=e.length;t<i;t++)e[t].explode()}updateOnDemandConditions(e){this.onDemandManager.updateOnDemandConditions(e)}_createNewTileset(){return new n}clone(e,t){r.Utils.defined(e)||(e=this._createNewTileset()),super.clone(e),e._errorCoefficient=this.errorCoefficient,e.sseThreshold=this.sseThreshold,e.geoErrScaleFactor=this.geoErrScaleFactor,e._loader=t,e._loader.rootUrl=this._loader.rootUrl,e._nodeManager=this._nodeManager,e._geometryManager=this._geometryManager;const i=this._root.clone(e,void 0);return e._root=i,this._cloneChildTiles(e,this._root,i),this._loader.tileReader.clone(e._loader.tileReader),e._loader.tileReader.createNodeInfoMap(),e._loader.pbfNodeInfoMap=this._loader.pbfNodeInfoMap,e.forceLoad=this.forceLoad,e}_cloneChildTiles(e,t,i){const n=t.childrenTree;n.length&&(i._childrenState=r.TileContentState.READY,n.forEach((t=>{const r=t.clone(e,i);this._cloneChildTiles(e,t,r)})))}debugShowGeometricError(e){this._debugShowGeometricError=e}needLoadChildrenOfTile(e){return void 0!==e.detailLevel&&e.detailLevel<=2?e.childrenUnload&&e.contentReady:e.childrenUnload}traverseContentAvailableNode(e){let t=i=>{i.childrenTree.forEach((i=>{!0===i.contentAvailable&&e&&e(i),t(i)}))};t(this._root)}traverseContentReadyNode(e){let t=i=>{i.childrenTree.forEach((i=>{!0===i.contentReady&&e&&e(i),t(i)}))};t(this._root)}getRootGeoErrDistance(e){return e*this.root.geometricError/this.maximumScreenSpaceError}_createTraversalController(e){r.BimTilesVersionControl.isVersion_3(e)?this._traversalController=new r.BimTilesetTraversalV3:this._traversalController=new r.BimTilesetTraversal}_canBeTraverse(e,t){if(this.isDataVersion3()){let i=!1;return e.hasChildren&&(e.passSSE(t)||e.contentTypeEmpty&&!e.refineStop)&&(i=!0),i}return!!e.hasChildren()&&e.passSSE(t)}anyChildrenPassSSE(e,t){if(this.isDataVersion3())return!0;let i=!1;return e.childrenTree.forEach((e=>{i=i||e.passSSE(t)})),i}updateTiles(e){let t=!1;const i=this.statistics,r=this._selectedTiles,n=this._loader.filter.model.pickingManager;n.beforeUpdate(),this.shadowMapManager.init();for(let n=0,a=r.length;n<a;++n){let a=r[n];const s=a.update(e);t=a.needsLoading||t,s&&this.shadowMapManager.addCastShadowTileMap(a,e),i.incrementSelectionCount(a.content),++i.selected}n.afterUpdate(),this.debugShowStatistics(e),t&&e.afterRenderFns.push((function(){}))}replenishShadowTile(){if(!r.GlobalData.EnableReplenishShadowTile)return;const e=this.shadowMapManager.castShadowTileMap,t=this._traversalController.shadowInFrustumTileMap;if(e.size!==t.size)for(let i of t.values()){let t=!1;for(let r of i){const i=r.contentId;if(e.has(i)){t=!0;break}}0==t&&this.shadowMapManager.addShadowTile(i[0])}}calShadowTile(e){const t=this._selectedTiles,i=e.viewer.getScene().lightManager.csm;if(i&&i.castShadowTileIdSet.size>0)for(let e=0,r=t.length;e<r;++e){let r=t[e];const n=!i.castShadowTileIdSet.has(r.contentRootId);r._content.meshes.children.map((e=>{e.isLine||(e.updateShadowUniform=(t,i)=>{e.material.uniforms&&e.material.uniforms.skipShadowCal&&t.setValue(i,"skipShadowCal",n)})}))}}isOutlineEnabled(){return this._loader.isBorderLineVisible()}isDataVersion3(){return r.BimTilesVersionControl.isVersion_3(this.dataVersion)}_handleTileContentSuccess(e,t){if(t.contentTypeMeshAvailable&&e.forceLoad){e.contenEntiyCompleted++;var i={total:e.contenEntiyNum,loaded:e.contenEntiyCompleted,percent:e.contenEntiyCompleted/e.contenEntiyNum};let t=e._model;t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:i,modelId:t.id}),e.contenEntiyCompleted===e.contenEntiyNum&&t.manager.dispatchEvent({type:r.EVENTS.ON_MODEL_CACHE_COMPLETE,modelId:t.id})}return super._handleTileContentSuccess(e,t)}}r.BimTileset=n}(),r.BimTileOnDemandManager=class{constructor(e,t){this.model=e,this._filter=e.filter,this._onDemand=e._onDemand,this._hasLayerInfo=e._hasLayerInfo,this._idMap={},this.demandCount=0}destroy(){this._filter.destroy(),this._filter=null,this._onDemand=void 0,this._hasLayerInfo=void 0,this._conditions=null,this._idMap=null,this.demandCount=void 0}updateOnDemandConditions(e){this._conditions=void 0===e?[]:e,this._conditions=e,this.demandCount++}onDemandJudgment(e){if(!1===this._onDemand)return!1;if(!0===this._onDemand&&!1===this._hasLayerInfo)return!0;if(0===Object.keys(e.layerInfo).length)return!1;const t=this._conditions.length;let i=!0;for(let r=0;r<t;++r){const t=this._conditions[r];let n=!0;for(let i in t)if(e.layerInfo[i]&&t[i]!==e.layerInfo[i]){n=!1;break}n&&(i=!1)}return i}instanceApply(e){if(e.demandCount===this.demandCount)return;const t=e.userIndexMap,i=this.model.getDescriptor().getInstancedNodeInfos();this._filter._updateInstanceDemandMaterial(e,t,i),e.demandCount=this.demandCount}get onDemand(){return this._onDemand}set onDemand(e){this._onDemand=e}get hasLayerInfo(){return this._hasLayerInfo}set hasLayerInfo(e){this._hasLayerInfo=e}get conditions(){return this._conditions}set conditions(e){this._conditions=e}get idMap(){return this._idMap}},function(){class e extends r.FilterManager{constructor(e){super(e),r.BimTilesVersionControl.isVersion_2(e.dataVersion)?this.objectInfoManager=new r.BimtileObjectInfoManager2:this.objectInfoManager=new r.BimtileObjectInfoManager,this.model=e,this.mergedMeshesStates={},this.blinkMaterials={},this.idCacheMap=new Map,this.stateChangedRenderer=r.EnumChangedState.START,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this._tileLoadedStateChanged=!1}destroy(){this.mergedMeshesStates=null,this.blinkMaterials=null,super.destroy(),this.model=null}setTileReader(){this.objectInfoManager.setTileReader(this.model.tilesLoader.tileReader)}pushBackWithFilterMng(e){super.pushBackWithFilterMng(e),this.enableStateChanged()}pushBackByIds(e,t){var i=e.getClassName();"IsolateIdsFA"==i||"IsolateConditionFA"==i?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[i]&&this.enableVisibleStateChanged(!0),this._colorStateActionMap[i]&&this.enableColorStateChanged(!0),this._stateChanged=!0,e.applyFilterByIds(this.objectInfoManager,this,t),this.enableStateChanged()}pushBack(e,t){super.pushBack(e,t),this.enableStateChanged()}restoreComponentsOpacityWithIds(e,t){super.restoreComponentsOpacityWithIds(e,t),this.enableStateChanged()}restoreComponentsOpacityWithConditions(e,t,i){super.restoreComponentsOpacityWithConditions(e,t,i),this.enableStateChanged()}getIdsWithConditions(e){var t=[],i=[],r=this._parseConditions(e);for(const e of this.objectInfoManager.objectInfoDict.nodeInfos[0].values()){const n=e.userData,a=this.objectInfoManager.tileReader.getUserDataByIndex(n)||{};a.elementId=e.userId;this.objectInfoManager.isMatchConditions(a,r)?t.push(e.userId):i.push(e.userId)}for(const e of this.objectInfoManager.objectInfoDict.nodeInfos[1].values()){const n=e.userData,a=this.objectInfoManager.tileReader.getUserDataByIndex(n)||{};a.elementId=e.userId;this.objectInfoManager.isMatchConditions(a,r)?t.push(e.userId):i.push(e.userId)}return t}findMaterialWithModelByIds(e,t,i){let r=[];for(let n=0;n<i.length;n++){let a=!0;const s=i[n];let o=null,l=null;const d=e.getFilter().getObjectInfoManager().getMaterial(s);if(d)o=d,o.originOpacity=d.opacity,o.name.indexOf("_opacity")<0&&(a=!1),o.map&&(l=o.map);else{const t=e.getNodeInfosByUserIndex(s);if(t&&t.length>0){l=null;for(let i=0;i<t.length;i++){const r=t[i],n=e.getMaterialByMaterialId(r.materialId,r);if(n&&n.map){l=n.map,o=n;break}n&&n.dispose()}const i=t[0];o||(o=e.getMaterialByMaterialId(i.materialId,i))}}if(o){const e=o.color.getHex();o.dispose();let i={color:e,opacity:t,useVertexColor:o.vertexColors};a&&(i.setByOpacity=a),l&&(i.map=l),r.push(i),l&&l.dispose(),l=null}}let n=[];for(let e=0;e<r.length;e++){let t=this._filterImpl.getMaterialNameByColor(r[e]),i=this._filterImpl.getMaterialByName(t);n.push(i)}return n}findOriginOpacityMaterialsMatchConditions(e,t,i){var r=e.getModel(t);let n=[];for(let e=0;e<i.length;e++){const t=i[e];let a=null,s=null;const o=r.getFilter().getObjectInfoManager().getMaterial(t);if(o){o.map&&(s=o.map);const e=r.getNodeInfosByUserIndex(t);if(e&&e.length>0){for(let t=0;t<e.length;t++){const i=e[t],n=r.getMaterialByMaterialId(i.materialId,i);if(n&&n.map){a=n;break}}const t=e[0];a||(a=r.getMaterialByMaterialId(t.materialId,t))}}if(a){let e={color:o.color.getHex(),opacity:a.opacity,useVertexColor:o.vertexColors};o.transparent?e.setByOpacity=!0:e.setByOpacity=!1,s&&(e.map=s),n.push(e),s&&s.dispose(),s=null}}let a=[];for(let e=0;e<n.length;e++){let t=this._filterImpl.getMaterialNameByColor(n[e]),i=this._filterImpl.getMaterialByName(t);a.push(i)}return a}findOriginOpacityMaterialsMatchIds(e,t){let i=[];for(let r=0;r<t.length;r++){const n=t[r];let a=null,s=null;const o=e.getFilter()._parseIds([n])[0],l=e.getFilter().getObjectInfoManager().getMaterial(o);if(l){l.map&&(s=a.map);const t=e.getNodeInfosByUserId(n);if(t&&t.length>0){for(let i=0;i<t.length;i++){const r=t[i],n=e.getMaterialByMaterialId(r.materialId,r);if(n&&n.map){a=n;break}}const i=t[0];a||(a=e.getMaterialByMaterialId(i.materialId,i),a.defines.CNORMAL="",a.useCompressedNormal=!0)}}if(a){let e={color:l.color.getHex(),opacity:a.opacity};l.transparent?e.setByOpacity=!0:e.setByOpacity=!1,s&&(e.map=s),i.push(e),s&&s.dispose(),s=null}}let r=[];for(let e=0;e<i.length;e++){let t=this._filterImpl.getMaterialNameByColor(i[e]),n=this._filterImpl.getMaterialByName(t);r.push(n)}return r}findMaterialsByIndexIdsMatchConditions(e,t,i,r){var n=e.getModel(t);let a=[];for(let e=0;e<r.length;e++){let t=!0;const s=r[e];let o=null,l=null;const d=n.getFilter().getObjectInfoManager().getMaterial(s);if(d)o=d,o.originOpacity=d.opacity,o.name.indexOf("_opacity")<0&&(t=!1),o.map&&(l=o.map);else{const e=n.getNodeInfosByUserIndex(s);if(e&&e.length>0){l=null;for(let t=0;t<e.length;t++){const i=e[t],r=n.getMaterialByMaterialId(i.materialId,i);if(r&&r.map){l=r.map,o=r;break}r&&r.dispose()}const t=e[0];o||(o=n.getMaterialByMaterialId(t.materialId,t))}}if(o){const e=o.color.getHex();o.dispose();let r={color:e,opacity:i,useVertexColor:o.vertexColors};t&&(r.setByOpacity=t),l&&(r.map=l),a.push(r),l&&l.dispose(),l=null}}let s=[];for(let e=0;e<a.length;e++){let t=this._filterImpl.getMaterialNameByColor(a[e]),i=this._filterImpl.getMaterialByName(t);s.push(i)}return s}addToOverrideListWithAllIdsByColor(e,t){super.addToOverrideListWithAllIdsByColor(e,t)}isTileLoadedStateChanged(){return this._tileLoadedStateChanged}disableTileLoadedStateChanged(){this._tileLoadedStateChanged=!1}enableTileLoadedStateChanged(){this._tileLoadedStateChanged=!0}_parseIds(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],n=this._getIndexByUserId(i);void 0!==n&&t.push(n)}return t}_parseIndexIds(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],n=this.model.getRealUserId(i);t.push(n)}return t}_parseConditions(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],n={};for(const e in i){const t=this.model.tilesLoader.tileReader.getUserDataIndexMapByString(e,i[e]);t&&(n[t.key]=t.value)}t.push(n)}return t}loadState(e){let t=!1;if(e.actions)for(const i of e.actions){let e=i.ids;"OverrideIdsFA"!=i.className&&"OverrideIdsForWireFrameFA"!=i.className||0!=e.length||(e=this.model.getAllUserIds(),i.manipulateAllElement=!0),e&&e.length>0&&i.opacity&&"OverrideIdsFA"==i.className||e&&e.length>0&&(t=!0,i.ids=e)}if(e.isolateAction){const i=e.isolateAction.ids;if(i&&i.length>0){const r=i.map((e=>this._getIndexByUserId(e)));e.isolateAction.ids=r,!0===e.isolateAction.isolateHide&&(t=!0)}}super.loadState(e),t&&this.enableWireFrameStateChanged()}hideAll(){super.hideAll(),this.enableWireFrameStateChanged()}showAll(){super.showAll(),this.enableWireFrameStateChanged()}hideByIds(e){super.hideByIds(e),this.enableWireFrameStateChanged()}hideByConditions(e){super.hideByConditions(e),this.enableWireFrameStateChanged(),this.enableStateChanged()}hideOthersByConditions(e){const t=this._parseConditions(e);super.hideOthersByConditions(t),this.enableWireFrameStateChanged()}getMatchIndexes(e){const t=this._parseConditions(e);return super.getMatchIds(t)}getMatchIds(e){return this._parseIndexIds(this.getMatchIndexes(e))}addToFrozenList(e){const t=this._parseIds(e);super.addToFrozenList(t)}removeFromFrozenList(e){const t=this._parseIds(e);super.removeFromFrozenList(t)}setFrozenList(e){const t=this._parseIds(e);super.setFrozenList(t)}setFrozenConditions(e){const t=this._parseConditions(e);super.setFrozenConditions(t)}getFrozenConditions(){return super.getFrozenConditions()}addToIdList(e,t){const i=this._parseIds(t);super.addToIdList(e,i)}setIdList(e,t){const i=this._parseIds(t);super.setIdList(e,i)}removeFromIdList(e,t){const i=this._parseIds(t);super.removeFromIdList(e,i)}addToOverrideList(e,t,i){const r=this._parseIds(t);super.addToOverrideList(e,r,i)}removeFromOverrideList(e,t){const i=this._parseIds(t);super.removeFromOverrideList(e,i)}setOverrideList(e,t,i){const r=this._parseIds(t);super.setOverrideList(e,r,i)}addToOverrideListByOpacityAndConditions(e,t){super.addToOverrideListByOpacityAndConditions(e,t)}addToOverrideListByOpacity(e,t){super.addToOverrideListByOpacity(e,t)}addToOverrideListByColor(e,t){super.addToOverrideListByColor(e,t)}addToOverrideListByConditions(e,t){super.addToOverrideListByConditions(e,t),this.enableStateChanged()}addToOverrideListByMaterial(e,t){const i=this._parseConditions(e);super.addToOverrideListByMaterial(i,t)}addToOverrideListByMaterialAndId(e,t){super.addToOverrideListByMaterialAndId(e,t)}setOverrideListByColor(e,t,i){const r=this._parseIds(t);super.setOverrideListByColor(e,r,i)}addToOpacityListByConditions(e,t){const i=this._parseConditions(e),r=this;this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var n in this.enableStateChanged(),e){var a=e[n];e[n]=r.model.tilesLoader.tileReader.getUserIdByIndex(a)}t(e,i)}}))}removeOpacityListByConditions(e,t){const i=this._parseConditions(e);this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var r in this.enableStateChanged(),e){var n=e[r];e[r]=scope.model.tilesLoader.tileReader.getUserIdByIndex(n)}t(e,i)}}))}addToLocalClippingList(e,t,i,r){super.addToLocalClippingList(e,t,i,r),this.enableWireFrameStateChanged()}addToLocalClippingListByConditions(e,t){const i=this._parseConditions(e);this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var r in this.enableStateChanged(),this.enableWireFrameStateChanged(),e){var n=this.model.tilesLoader.tileReader.getUserIdByIndex(e[r]);e[r]=n}t(e,i)}}))}addToOverrideListForWireFrameByColor(e,t){super.addToOverrideListForWireFrameByColor(e,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}addToOverrideListForAllWireFrameByColor(e,t){super.addToOverrideListForAllWireFrameByColor(e,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}addToOverrideListForWireFrameByConditions(e,t){super.addToOverrideListForWireFrameByConditions(e,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}getVisibleComponentArray(e){let t=[];const i=[...e.keys()],r=this._parseIds(i);for(var n=0;n<r.length;n++)this._isVisible({name:r[n]})&&t.push(i[n]);return t}addToIsolateList(e,t){const i=this._parseIds(e);super.addToIsolateList(i,t),"HideOthers"==t&&this.enableWireFrameStateChanged()}removeFromIsolateList(e,t){const i=this._parseIds(e);super.removeFromIsolateList(i,t)}setIsolateList(e,t){const i=this._parseIds(e);super.setIsolateList(i,t)}clearIsolationByIds(e){const t=this._parseIds(e);super.clearIsolationByIds(t)}removeFromIsolateList(e,t){const i=this._parseIds(t);super.removeFromIsolateList(e,i)}setIsolateConditions(e,t){super.setIsolateConditions(e,t),t===r.EnumIsolateState.HIDDEN_OTHERS&&this.enableWireFrameStateChanged()}getIsolateConditions(){super.getIsolateConditions()}setConditions(e,t){const i=this._parseConditions(t);super.setConditions(e,i)}getConditions(){super.getConditions()}showByIds(e){super.showByIds(e),this.enableWireFrameStateChanged()}showByConditions(e){super.showByConditions(e),this.enableWireFrameStateChanged()}clearIsolation(){super.clearIsolation(),this.enableColorStateChanged(!0),this.enableWireFrameStateChanged()}makeTranslucentByIds(e){super.makeTranslucentByIds(e)}makeTranslucentByConditions(e){super.makeTranslucentByConditions(e)}makeTranslucentOthersByIds(e){const t=this._parseIds(e);super.makeTranslucentOthersByIds(t)}opaqueAll(){super.opaqueAll()}opaqueByIds(e){super.opaqueByIds(e)}opaqueByConditions(e){super.opaqueByConditions(e)}deactivateByIds(e){const t=this._parseIds(e);this.objectInfoManager.deactivateByIds(t),this.observerForSceneState&&this.observerForSceneState(e)}getInactivatedIdMap(){if(!0===this.objectInfoManager.bIsInactivateAll)return{all:!0};let e={};const t=this._parseIndexIds(this.objectInfoManager.inactivatedIds);return 0===t.length?{}:(t.map((t=>{e[t]=!0})),e)}isComponentUserIndexActive(e){return super.isComponentActive(e)}isComponentActive(e){const t=this._getIndexByUserId(e);return super.isComponentActive(t)}_isPickable(e){const t=e.userId;return this.isComponentUserIndexActive(t)&&!this.objectInfoManager.isFrozen(t)}getBlinkMaterials(){let e=[];for(const t in this.blinkMaterials){const i=this.blinkMaterials[t];for(const t in i)e.push(i[t])}return e}_updateFilterManager(){const e=this.model.getAllNodeInfos();if(0!==e[0].size||0!==e[1].size){var t={};t[this.model.id]=e,this.reinitFilterManager(t)}}initFilterManager(e){this.objectInfoManager.init(e[this.model.id])}reinitFilterManager(e){this.objectInfoManager.reinit(e[this.model.id])}clearFilterManager(){this.objectInfoManager.clearData()}resetWireFrameNodeStates(e){e.traverse((e=>{if("LineSegmentsEx"!==e.type)return;e.material=[e.material[0]];let t=e.geometry;t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.EnumElementState.NONE)}))}resetStandardNodeStates(e){e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.material=[e.material[0]];let t=e.geometry;t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.EnumElementState.NONE)}))}_needsUpdate(e){return 0!==e.blinkUserIdSetObject.size||0!==e.hoverUserIdSetObject.size||0!==e.clippingUserIdSetObject.size||0!==e.localClipUserIdSetObject.size||0!==e.modifyOpacityUserIdSetObject.size||0!==e.hiddenUserIdSetObject.size||0!==e.overrideUserIdSetObject.size||0!==e.transparentUserIdSetObject.size}_needsWireFrameUpdate(e){return 0!==e.hiddenUserIdSetObject.size||0!==e.overrideWireFrameUserIdSetObject.size||0!==e.hiddenWireFrameUserIdSetObject.size||0!==e.localClipUserIdSetObject.size}releaseObject(e){e.blinkUserIdSetObject=null,e.hoverUserIdSetObject=null,e.modifyOpacityUserIdSetObject=null,e.overrideUserIdSetObject=null,e.transparentUserIdSetObject=null,e.stateChangedRenderer=this.stateChangedRenderer}releaseWireFrameObject(e){e.overrideWireFrameUserIdSetObject=null,e.hiddenUserIdSetObject=null,e.clippingUserIdSetObject=null,e.localClipUserIdSetObject=null,e.hiddenWireFrameUserIdSetObject=null,e.stateWireFrameChangedRenderer=this.stateWireFrameChangedRenderer,e.forceUpdateWireFrame=!1}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=e._content.meshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectBlinkUserIds(e,i),this._collectHoverUserIds(e,i),this._collectClippingUserIds(e,i),this._collectLocalClipUserIds(e,i),this._collectModifyOpacityUserIds(e,i),this._collectFilteredUserIds(e,i,r,!1),!this._needsUpdate(e))return this.resetStandardNodeStates(t),void this.releaseObject(e);this.resetStandardNodeStates(t),this.rebuildIndices(e,r),this.releaseObject(e)}wireFrameStandardApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e._content._outlineContent.outlineMeshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectWireFrameFilteredUserIds(e,i,r),!this._needsWireFrameUpdate(e))return this.resetWireFrameNodeStates(t),void this.releaseWireFrameObject(e);this.resetWireFrameNodeStates(t),this.rebuildWireFrameIndices(e,r),this.releaseWireFrameObject(e)}instanceApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=e._content.meshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectBlinkUserIds(e,i),this._collectHoverUserIds(e,i),this._collectClippingUserIds(e,i),this._collectLocalClipUserIds(e,i),this._collectModifyOpacityUserIds(e,i),this._collectFilteredUserIds(e,i,r,!0),!this._needsUpdate(e))return this.resetInstanceMaterial(t),void this.releaseObject(e);this.resetInstanceMaterial(t),this._updateInstanceMaterial(e,r,t),this.releaseObject(e)}wireFrameInstanceApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e.userIndexMap,i=this.model.getDescriptor(),r=e._content._outlineContent.outlineMeshes;if(this._collectWireFrameFilteredUserIds(e,t,i),!this._needsWireFrameUpdate(e))return this.resetInstanceWireFrameMaterial(r),void this.releaseWireFrameObject(e);this.resetInstanceWireFrameMaterial(r),this._updateInstanceWireFrameMaterial(e,i),this.releaseWireFrameObject(e)}_isEqual(e,t){if(void 0===t)return!1;if(Object.getOwnPropertyNames(e).length!==Object.getOwnPropertyNames(t).length)return!1;for(const i in e)if(e[i]!==t[i])return!1;return!0}apply(){}traverseInstanceLineGeometryMap(e,t){e.traverse((e=>{"LineSegmentsEx"===e.type&&t(e.geometry)}))}resetInstanceMaterial(e){var t=this.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;const i=e.geometry;e.isCopyMesh?(e.visible=!1,i.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),i.getAttribute("vState").needsUpdate=!0):(i.getAttribute("vState").array.fill(r.EnumElementState.NONE),i.getAttribute("vState").needsUpdate=!0),i.getAttribute("vClipping").array.fill(t),i.getAttribute("vClipping").needsUpdate=!0}))}resetInstanceWireFrameMaterial(e){this.traverseInstanceLineGeometryMap(e,(e=>{e.getAttribute("vState").array.fill(r.EnumElementState.NONE),e.getAttribute("vState").needsUpdate=!0}))}_updateInstanceMaterial(e,t,i){for(const r of e.hiddenUserIdSetObject.keys())this._dealHideUserIndex(r,t,i);for(const n of e.clippingUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(n,(e=>{const t=e.nodeInfo;if(t.tileId!==i.tileId)return;const n=t.index,a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);if(a)for(const e in a){const t=a[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;if(!t||!1===t.visible)return;const s=r.MaterialUtil.getColorParamsByMaterial(t.material),o=r.EnumElementState.CLIPPING;this.updateInstanceGeometry(i.children,s,o,n)}}));for(const n of e.localClipUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(n,(e=>{const t=e.nodeInfo,n=t.index;if(t.tileId!==i.tileId)return;const a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);if(a)for(const[e,t]of a){const e=t.mesh;if(r.TilesUtil.isInstanceNodeInVisible(e))return;if(!e||!1===e.visible)return;const a=r.MaterialUtil.getColorParamsByMaterial(e.material),s=r.EnumElementState.LOCALCLIPPING;this.updateInstanceGeometry(i.children,a,s,n)}}));for(const n of e.transparentUserIdSetObject.keys()){const e=this._filterImpl.getFrozonMaterial(),a=r.MaterialUtil.getColorParamsByMaterial(e),s=r.EnumElementState.OVERRIDED;this.updateInstanceGeometryByNodeInfos(n,t,a,s,i)}for(const n of e.overrideUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(n,(t=>{const a=t.nodeInfo,s=a.index,o=this.model.tilesLoader.getInstanceMeshNodeById(a.parent);if(a.tileId!==i.tileId)return;const l=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(n);var d;if(o)for(const[t,a]of o){const t=a.mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;let o=1;-1!==l.indexOf("material_modifyOpacity")?(o=e.modifyOpacityUserIdSetObject.get(n).opacity,d=this.getMaterialForModifyOpacityFrom(t.material,o)):(d=this._getMaterialByName(l),e.modifyOpacityUserIdSetObject&&e.modifyOpacityUserIdSetObject.get(n)&&(o=e.modifyOpacityUserIdSetObject.get(n).opacity,d=this.getMaterialForModifyOpacityFrom(d,o))),d.srcOpacity=o,this.model.materialManager.materialMap[l]=d;const h=r.MaterialUtil.getColorParamsByMaterial(d),c=r.EnumElementState.OVERRIDED;this.updateInstanceGeometry(i.children,h,c,s)}}));for(const n of e.hoverUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(n,(e=>{const t=e.nodeInfo,n=t.index,a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);if(a)for(const[e,t]of a){const e=t.mesh;if(r.TilesUtil.isInstanceNodeInVisible(e))return;const a=this.model.sceneState.getHoverMaterial(e.material),s=r.MaterialUtil.getColorParamsByMaterial(a),o=r.EnumElementState.HOVER;this.updateInstanceGeometry(i.children,s,o,n)}}));for(const n of e.blinkUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(n,(t=>{const a=t.nodeInfo,s=a.index,o=this.model.tilesLoader.getInstanceMeshNodeById(a.parent);if(o)for(const[t,a]of o){const t=a.mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;if(!t||!1===t.visible)return;const o=r.MaterialUtil.getColorParamsByMaterial(t.material),d=r.EnumElementState.BLINK;var l=this.getBlinkMaterialName(n,t.name,e.blinkUserIdSetObject.get(n));null==this.blinkMaterials[l]&&(this.blinkMaterials[l]={}),null==this.blinkMaterials[l][t.material.uuid]&&(this.blinkMaterials[l][t.material.uuid]=t.material),this.updateInstanceGeometry(i.children,o,d,s)}}))}updateInstanceGeometry(e,t,i,n){const a=e[0].material,s=t.rgbaColor;let o,l;a.transparent===t.transparent?(o=i,l=r.EnumElementState.HIDDEN):(o=r.EnumElementState.HIDDEN,l=i),void 0===e[0].material&&(o=i,s.a>.999&&(a.transparent=!0,s.a=.999));let d=e[0].geometry;d.getAttribute("vState").array[4*n]=o,d.getAttribute("vState").needsUpdate=!0,d.getAttribute("aColor").array[4*n]=s[0],d.getAttribute("aColor").array[4*n+1]=s[1],d.getAttribute("aColor").array[4*n+2]=s[2],d.getAttribute("aColor").array[4*n+3]=s[3],d.getAttribute("aColor").needsUpdate=!0,i==r.EnumElementState.LOCALCLIPPING&&(void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").array[n]=i),void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").needsUpdate=!0),this.addInstanceMaterialForClip(e[0].material.uuid,e[0].material),this.addInstanceMaterialForClip(e[1].material.uuid,e[1].material)),d=e[1].geometry,d.getAttribute("vState").array[4*n]=l,d.getAttribute("vState").needsUpdate=!0,e[1].visible=!0}updateInstanceGeometryByNodeInfos(e,t,i,n,a){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,s=t.index;if(t.tileId!==a.tileId)return;const o=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);if(o)for(const[e,t]of o){const e=t.mesh;if(r.TilesUtil.isInstanceNodeInVisible(e))return;this.updateInstanceGeometry(a.children,i,n,s)}}))}_updateInstanceWireFrameMaterial(e,t){for(const i of e.hiddenUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.lineId,n=t.index,a=this.model.tilesLoader.getInstanceLineNodeById(i);if(r.TilesUtil.isInstanceNodeInVisible(a))return;let s=a.geometry;s.getAttribute("vState").array[4*n]=r.EnumElementState.HIDDEN,s.getAttribute("vState").needsUpdate=!0}));for(const i of e.hiddenWireFrameUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.lineId,n=t.index,a=this.model.tilesLoader.getInstanceLineNodeById(i);if(r.TilesUtil.isInstanceNodeInVisible(a))return;let s=a.geometry;s.getAttribute("vState").array[4*n]=r.EnumElementState.HIDDEN,s.getAttribute("vState").needsUpdate=!0}));for(const i of e.localClipUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.lineId,n=t.index,a=this.model.tilesLoader.getInstanceLineNodeById(i);if(r.TilesUtil.isInstanceNodeInVisible(a))return;let s=a.geometry;s.getAttribute("vClipping").array[n]=r.EnumElementState.LOCALCLIPPING,s.getAttribute("vClipping").needsUpdate=!0}));for(const i of e.overrideWireFrameUserIdSetObject.keys()){const n=e.overrideWireFrameUserIdSetObject.get(i),a=this._getMaterialByName(n);if(-1!==n.indexOf("material_modifyOpacity"))continue;const s=r.MaterialUtil.getColorParamsByMaterial(a),o=r.EnumElementState.OVERRIDED;this.updateInstanceWireFrameGeometryByNodeInfos(i,t,s,o)}}updateInstanceWireFrameGeometryByNodeInfos(e,t,i,n){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,a=t.lineId,s=this.model.tilesLoader.getInstanceLineNodeById(a);r.TilesUtil.isInstanceNodeInVisible(s)||this.updateInstanceGeometry(s.parent.children,i,n,t.index)}))}resetAllStates(){treeNode._content.meshes.traverse((e=>{if(e.isMesh){let e=mesh.geometry;e.clearGroups(),e._visible=!0,e.addGroup(0,mesh.indexCount,r.EnumElementState.NONE)}}))}isHidden(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isHidden(t)}isFrozen(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isFrozen(t)}isTransparent(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isTransparent(t)}isPickable(e){return super.isComponentActive(e)&&!this.objectInfoManager.isFrozen(e)&&!this.objectInfoManager.isHidden(e)}_insertIndexMeshes(e,t,i,n,a){void 0===e.mergedMeshesStates[t]?(e.mergedMeshesStates[t]={},e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a):void 0===e.mergedMeshesStates[t][i]?(e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a):n===r.EnumElementState.LOCALCLIPPING&&(e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a)}_collectLineMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const n=t.indexId,a=t.meshId;-1!==a.indexOf("line")&&this._insertIndexMeshes(e,a,n,i,r)}))}}_collectLineCategoryMeshState(e,t,i,n){for(let i of e.userIndexMap.keys()){const a=this.model.tilesLoader.userIdMapIndices[i];if(!a)continue;const s=a.length;for(let o=0;o<s;++o){const s=a[o],l=s.indexId,d=s.meshId;-1!==d.indexOf("line")&&(r.TilesUtil.matchWireFrameVisibilityOption(i,t)||this._insertIndexMeshes(e,d,l,n,i))}}}_collectMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const n=t.indexId,a=t.meshId;this._insertIndexMeshes(e,a,n,i,r)}))}}_collectMeshState2(e,t,i){for(const r in t){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const n=t.indexId,a=t.meshId;this._insertIndexMeshes(e,a,n,i,r)}))}}rebuildWireFrameIndices(e,t){e.mergedMeshesStates={},this._collectLineMeshState(e,e.hiddenUserIdSetObject,r.EnumElementState.HIDDEN),this._collectLineMeshState(e,e.hiddenWireFrameUserIdSetObject,r.EnumElementState.HIDDEN),this._collectLineMeshState(e,e.overrideWireFrameUserIdSetObject,r.EnumElementState.OVERRIDED),this._collectLineMeshState(e,e.localClipUserIdSetObject,r.EnumElementState.LOCALCLIPPING);const i=e._content._outlineContent.outlineMeshes;for(const t in e.mergedMeshesStates){let r=i.getObjectByName(t);r&&this.rebuildMesh(r,t,e,[])}}rebuildIndices(e,t){e.mergedMeshesStates={},this._collectMeshState(e,e.hiddenUserIdSetObject,r.EnumElementState.HIDDEN),this._collectLineCategoryMeshState(e,this.model.tilesLoader.wireFrameVisibilityOption,t,r.EnumElementState.HIDDEN),this._collectMeshState(e,e.overrideUserIdSetObject,r.EnumElementState.OVERRIDED),this._collectMeshState(e,e.transparentUserIdSetObject,r.EnumElementState.TRANSPARENT),this._collectMeshState(e,e.hoverUserIdSetObject,r.EnumElementState.HOVER),this._collectMeshState(e,e.blinkUserIdSetObject,r.EnumElementState.BLINK),this._collectMeshState(e,e.clippingUserIdSetObject,r.EnumElementState.CLIPPING),this._collectMeshState(e,e.localClipUserIdSetObject,r.EnumElementState.LOCALCLIPPING);const i=this.model.sceneState.getHoverMaterial(),n=this._filterImpl.getFrozonMaterial(),a=[];a[r.EnumElementState.HOVER]=i,a[r.EnumElementState.TRANSPARENT]=n;const s=e._content.meshes;for(const t in e.mergedMeshesStates){let i=s.getObjectByName(t);i&&this.rebuildMesh(i,t,e,a)}}rebuildMesh(e,t,i,n){if(!e)return;let a=(e,t,i,n,a)=>{let s,o=null,l=t,d=0,h=!1;switch(t>=r.EnumElementState.OVERRIDED&&(t=r.EnumElementState.OVERRIDED,n.blinkUserIdSetObject&&n.blinkUserIdSetObject.get(i)&&(t=r.EnumElementState.BLINK)),t){case r.EnumElementState.NONE:break;case r.EnumElementState.HOVER:o=this.model.sceneState.getHoverMaterial(e.material[0]),e.material[r.EnumElementState.HOVER]=o;break;case r.EnumElementState.BLINK:const c=n.overrideUserIdSetObject&&n.overrideUserIdSetObject.get(i),u=this._getMaterialByName(c);let p=e.material[0];u&&p.useCompressedNormal&&(p=u,p.defines.CNORMAL="",p.useCompressedNormal=!0),s=this.getBlinkMaterialName(i,e.name,n.blinkUserIdSetObject.get(i)),null==this.blinkMaterials[s]?(this.blinkMaterials[s]={},o=this.model.sceneState.getBlinkMaterial(p,`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):null==this.blinkMaterials[s][s]?(o=this.model.sceneState.getBlinkMaterial(p,`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):o=this.blinkMaterials[s][s],n.localClipUserIdSetObject&&n.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o),this.blinkMaterials[s]=o),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)e.material[i]&&s===e.material[i].name&&(h=!0,l=i);if(!1===h){let t=d;d===r.EnumElementState.BLINK+1&&(t=r.EnumElementState.OVERRIDED+1),e.material[t]=o,l=t}break;case r.EnumElementState.OVERRIDED:s=n.overrideUserIdSetObject&&n.overrideUserIdSetObject.get(i);let m=1;e.name.indexOf("line")>-1&&n.overrideWireFrameUserIdSetObject&&n.overrideWireFrameUserIdSetObject.get(i)&&(s=n.overrideWireFrameUserIdSetObject.get(i)),-1!==s.indexOf("material_modifyOpacity")?(m=n.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(e.material[0],m),!e.material[0].useCompressedColor||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CCOLOR="",o.useCompressedColor=!0)):(o=this._getMaterialByName(s),m=o.opacity,n.modifyOpacityUserIdSetObject&&n.modifyOpacityUserIdSetObject.get(i)&&(m=n.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(o,m))),o.srcOpacity=m,this.model.materialManager.materialMap[s]=o,n.localClipUserIdSetObject&&n.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o)),o.side=e.material[0].side,!e.material[0].useCompressedNormal||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CNORMAL="",o.useCompressedNormal=!0),r.Utils.isDefined(e.material[0].useCompressedUv)&&e.material[0].useCompressedUv&&"cloudStandard"===o.type&&(o.uvCenter=e.material[0].uvCenter,o.uvHalfExtent=e.material[0].uvHalfExtent,o.defines.USE_COMPRESS_UV="",o.useCompressedUv=!0),!e.material[0].growthAnimationPlanes||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.growthAnimationPlanes=e.material[0].growthAnimationPlanes,o.defines||(o.defines={}),o.defines.GROWTH_ANIMATION="",o.refreshUniforms()),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)s===e.material[i].name&&(h=!0,l=i);!1===h&&(e.material[d]=o,l=d);break;case r.EnumElementState.LOCALCLIPPING:o=this.getMaterialForClipFrom(e.material[0]),e.material[r.EnumElementState.LOCALCLIPPING]=o;break;case r.EnumElementState.CLIPPING:e.material[r.EnumElementState.CLIPPING]=e.material[0];break;default:a[t]&&(e.material[t]=a[t])}return l};const s=i.mergedMeshesStates[t];let o=e.geometry;o.clearGroups(),o._visible=!0;const l=e.indexGroups;let d=0;const h=r.TilesUtil.nodeIndexGroupsSort(l),c=h.length;let u=h[0].indexGroup.indexCount,p=r.EnumElementState.NONE;if(s[0]&&s[0].state!==r.EnumElementState.NONE){p=s[0].state;p=a(e,p,s[0].userId,i,n),s[0].state,r.EnumElementState.BLINK}for(let t=1;t<c;++t){const l=h[t].indexGroup;if(s[t]){const r=s[t].userId,h=a(e,s[t].state,r,i,n);h===p?u+=l.indexCount:(o.addGroup(d,u,p),p=h,d=l.indexStart,u=l.indexCount)}else if(p===r.EnumElementState.NONE)u+=l.indexCount;else{o.addGroup(d,u,p);a(e,p,s[t-1].userId,i,n),p=r.EnumElementState.NONE,d=l.indexStart,u=l.indexCount}}if(u>0&&p!==r.EnumElementState.HIDDEN){const t=a(e,p,s[c-1]&&s[c-1].userId,i,n);o.addGroup(d,u,t)}}_collectSelectUserIds(e,t){if(e.selectUserIdSetObject=new Map,this.model.sceneState.selectionSet&&this.model.sceneState.selectionSet[this.model.id]){const r=this.model.sceneState.selectionSet[this.model.id];for(var i of r.keys()){const r=this._getIndexByUserId(i);t.has(r)&&e.selectUserIdSetObject.set(r,!0)}}}_collectHoverUserIds(e,t){if(e.hoverUserIdSetObject=new Map,this.model.sceneState.hoverId){const i=this._getIndexByUserId(this.model.sceneState.hoverId);t.has(i)&&e.hoverUserIdSetObject.set(i,!0)}}_collectClippingUserIds(e,t){e.clippingUserIdSetObject=new Map;for(const i of this.model.mapClippingIds.keys())t.has(i)&&e.clippingUserIdSetObject.set(i,!0)}_collectBlinkUserIds(e,t){e.blinkUserIdSetObject=new Map;var i=this.model.sceneState.getBlinkComponentsIdMap(this.model.id);for(var r in i){var n;this.idCacheMap.get(r)?n=this.idCacheMap.get(r):(n=this._getIndexByUserId(r),this.idCacheMap.set(r,n)),t.has(n)&&e.blinkUserIdSetObject.set(n,i[r])}}_collectLocalClipUserIds(e,t){e.localClipUserIdSetObject=new Map;var i=this.getLocalClippingList();for(var[r,n]of i){var a;this.idCacheMap.get(r)?a=this.idCacheMap.get(r):(a=this._getIndexByUserId(r),this.idCacheMap.set(r,a)),t.has(a)&&e.localClipUserIdSetObject.set(a,!0)}}_collectModifyOpacityUserIds(e,t){e.modifyOpacityUserIdSetObject=new Map;var i=this.getModifyOpacityList();for(var[r,n]of i){var a;this.idCacheMap.get(r)?a=this.idCacheMap.get(r):(a=this._getIndexByUserId(r),this.idCacheMap.set(r,a)),t.has(a)&&e.modifyOpacityUserIdSetObject.set(a,i.get(r))}}getBlinkMaterialName(e,t,i){let r=e.toString()+"|"+t;return i&&(i.color&&(r+="|"+i.color.getHEX()),i.interval&&(r+="|"+i.interval.toString())),r}getBlinkMaterialsByUserId(e){let t=[];const i=e.toString();for(const e in this.blinkMaterials){if(i!==e.split("|")[0])continue;const r=this.blinkMaterials[e];for(const e in r)t.push(r[e])}return t}_collectWireFrameFilteredUserIds(e,t,i){const n=this._hasOverrideMaterialFilterForWireFrame(),a=this.model.tilesLoader.wireFrameVisibilityOption,s=!0!==a;if(e.hiddenUserIdSetObject||(e.hiddenUserIdSetObject=new Map),e.localClipUserIdSetObject||(e.localClipUserIdSetObject=new Map),e.hiddenWireFrameUserIdSetObject=new Map,e.overrideWireFrameUserIdSetObject=new Map,!n&&!s)return!1;for(const i of t.keys()){if(!this._hasOverrideMaterialForWireFrame({name:i}))continue;const t=this._getOverrideMaterialForWireFrame({name:i});e.overrideWireFrameUserIdSetObject.set(i,t.name)}for(const i of t.keys())r.TilesUtil.matchWireFrameVisibilityOption(i,a)||e.hiddenWireFrameUserIdSetObject.set(i,!0);return!0}_collectFilteredUserIds(e,t,i,n){const a=this._hasHiddenFileIdFilter(),s=this._hasVisibleFilter()||this.model.hasHiddenSourceObjectUserId(),o=this._hasOverrideMaterialFilter(),l=this._hasTransparentFilter(),d=e.blinkUserIdSetObject.size>0,h=e.clippingUserIdSetObject.size>0,c=this._hasLocalClipping(),u=this._hasModifyOpacityList();let p=this.mapMaterialIdToUserIdsForFilter={};if(e.hiddenUserIdSetObject=new Map,e.overrideUserIdSetObject=new Map,e.transparentUserIdSetObject=new Map,!(a||s||o||l||d||c||u||h))return;const m=!0===n?(e,t)=>{i.getInstanceNodeInfoByUserIdCallback(e,t)}:(e,t)=>{i.getBatchedNodeInfoByUserIdCallback(e,t)};for(const i of t.keys())m(i,(t=>{const n=t.nodeInfo;if(a&&this._isHiddenFileId(n)||s&&!1===this._isVisible(n)||this.model.isHiddenSourceObjectUserId(i))return void 0===p[n.materialId]&&(p[n.materialId]={}),void 0===p[n.materialId][r.EnumElementState.HIDDEN]&&(p[n.materialId][r.EnumElementState.HIDDEN]={}),p[n.materialId][r.EnumElementState.HIDDEN][i]=!0,void e.hiddenUserIdSetObject.set(i,!0);if(c&&e.localClipUserIdSetObject.has(i)&&(void 0===p[n.materialId]&&(p[n.materialId]={}),void 0===p[n.materialId][r.EnumElementState.LOCALCLIPPING]&&(p[n.materialId][r.EnumElementState.LOCALCLIPPING]={}),p[n.materialId][r.EnumElementState.LOCALCLIPPING][i]=!0),l&&this._isTransparent(n))return void 0===p[n.materialId]&&(p[n.materialId]={}),void 0===p[n.materialId][r.EnumElementState.TRANSPARENT]&&(p[n.materialId][r.EnumElementState.TRANSPARENT]={}),p[n.materialId][r.EnumElementState.TRANSPARENT][i]=!0,void e.transparentUserIdSetObject.set(i,!0);if(d&&e.blinkUserIdSetObject.has(i)&&(void 0===p[n.materialId]&&(p[n.materialId]={}),void 0===p[n.materialId][r.EnumElementState.BLINK]&&(p[n.materialId][r.EnumElementState.BLINK]={}),p[n.materialId][r.EnumElementState.BLINK][i]=!0),o&&this._hasOverrideMaterial(n)){var h=this._getOverrideMaterial(n);""!==(m=null!=h?h.name:"")&&(void 0===p[n.materialId]&&(p[n.materialId]={}),void 0===p[n.materialId][r.EnumElementState.OVERRIDED]&&(p[n.materialId][r.EnumElementState.OVERRIDED]={}),p[n.materialId][r.EnumElementState.OVERRIDED][i]=m,e.overrideUserIdSetObject.set(i,m))}else if(u&&e.modifyOpacityUserIdSetObject.has(i)){var m=`material_modifyOpacity_${e.modifyOpacityUserIdSetObject.get(i).opacity}`;e.overrideUserIdSetObject.set(i,m)}else;}))}_dealHideUserIndex(e,t,i){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,n=t.index;if(t.tileId!==i.tileId)return;const a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);if(a)for(const[e,t]of a){const e=t.mesh;if(r.TilesUtil.isInstanceNodeInVisible(e))return;let i=e.geometry;i.getAttribute("vState").array[4*n]=r.EnumElementState.HIDDEN,i.getAttribute("vState").needsUpdate=!0}}))}_updateInstanceDemandMaterial(e,t,i){const r=this.model.onDemandManager.idMap;for(let e of t.keys())r[e]||this._dealHideUserIndex(e,i)}decreaseStateChanged(){this.stateChangedRenderer--}enableStateChanged(){super.enableStateChanged(),this.stateChangedRenderer++,this.stateChangedRenderer>r.EnumChangedState.END&&(this.stateChangedRenderer=r.EnumChangedState.START)}enableWireFrameStateChanged(){this.stateWireFrameChangedRenderer++,this.stateWireFrameChangedRenderer>r.EnumChangedState.END&&(this.stateWireFrameChangedRenderer=r.EnumChangedState.START)}applyTileMeshForFlatten(){}_getIndexByUserId(e){return this.model.tilesLoader.tileReader.getIndexByUserId(e)}_getOverrideMaterial(e){var t=e.name;return this._getOverrideMaterialByIndexId(t)}_getOverrideMaterialById(e){const t=this._getIndexByUserId(e);this._getOverrideMaterialByIndexId(t)}_getOverrideMaterialByIndexId(e){return this.objectInfoManager.isFrozen(e)?this._filterImpl.getFrozonMaterial():this.objectInfoManager.getMaterial(e)}}r.BimTileFilterManager=e}(),function(){const e=new THREE.Box3,t=new THREE.MeshBasicMaterial({color:16711680,colorWrite:!1,depthWrite:!1,depthTest:!0}),i=new THREE.Vector3,n=new THREE.Vector3;class a extends r.TilesetTraversal{constructor(){super(),this.occlusionMap=new Map}traverseTiles(e,t,i){const r=this.traversalStack;r.push(t);const n=this._initVisibilityBoxsCondition(e,i);for(this._initOccluded(i);r.length>0;){const t=r.pop();if(!this._inVisibilityBoxs(t,i,n))continue;if(this._isOccluded(t,i))continue;const a=t.refineReplace,s=!t._parent||t._parent._refines;let o=!1;if(this.updateTileContentLinksToAncestor(t,i),e._isAvailableDetailLevel(t)){if(e._fetchChildrenOfTile(t,i),e.onDemandJudgment(t))continue;e._canBeTraverse(t,i)&&(o=this.subdivideTile(e,t,i),o=o&&s)}if(a){const r=!o&&s;e._addTileToRequestedQueue(t,i),r&&this._checkAddToSelectedQueue(e,t,i)&&e._addTileToSelectedQueue(t,i)}else e._addTileToRequestedQueue(t,i),(t.passSSE(i)||t.passSSE_instanceLeafTile(i))&&e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=o}this._endOccluded(i)}_initVisibilityBoxsCondition(e,t){if(e.forceLoad)return!1;const i=t.viewer.getScene().hasClipPlanes()||t.viewer.getScene().hasFillClipPlanes();let n=!1;if(r.GlobalData.EnableTilevisibilityBoxs&&!(e.dataVersion<"0.0.3")){let e=new Array(500);if(t.viewer.getFilter().getInvisibleComponentsBboxes(e))for(const i of e){if(!i)break;if(r.Utils.computeBoxSSE(t,i)>t.maximumScreenSpaceError){n=!0;break}}else n=!0}return!i&&!n&&r.GlobalData.EnableTilevisibilityBoxs}_inVisibilityBoxs(t,i,r){const n=t.visibilityBoxs;if(n.length>0&&r){let t=!1;for(const r of n)if(e.copy(r),e.expandByScalar(.2*e.max.distanceTo(e.min)),e.containsPoint(i.cameraPositionWc)){t=!0;break}if(!t)return!1}return!0}_checkAddToSelectedQueue(e,t,i){return!!r.BimTilesVersionControl.isVersion_3(e.dataVersion)||t.passSSE(i)}subdivideTile(e,t,i){const n=this.traversalStack,a=t.childrenTree;if(a.forEach((t=>{e.updateTile(t,i)})),e.isCheckChildrenPassSSE()&&!e.anyChildrenPassSSE(t,i))return!1;a.sort(r.TilesetTraversal.sortByDistanceToCamera);const s=t.refineReplace&&!t.contentTypeEmpty;let o=!0,l=!1;return a.forEach((t=>{if(t.visible?(n.push(t),l=!0):s&&(r.BimTilesVersionControl.isVersion_3(e.dataVersion)||e._addTileToRequestedQueue(t,i),e.visitTile(t,i),e.touchTile(t,i)),!s)return;let a=!1;a=r.BimTilesVersionControl.isVersion_3(e.dataVersion)?!t.visible||t.contentAvailable:t.contentTypeEmpty?this.traverseTileWithEmptyContent(e,t,i):t.contentAvailable,o=o&&a})),l||(o=!1),o}traverseTileWithEmptyContent(e,t,i){this.traversalDescendants.length=0;const r=this.emptyTraversalStack;r.push(t);let n=!0;for(;r.length>0;){const t=r.pop();if(t.contentTypeEmpty){if(!t.childrenReady){e._fetchChildrenOfTile(t,i),n=!1;break}if(t.contentTypeTile&&!t.hasChildren()){n=!1;break}let a=e._canBeTraverse(t,i);if(a){const n=t.childrenTree;n.forEach((t=>{e.updateTile(t,i),t.visible||(e._addTileToRequestedQueue(t,i),e.visitTile(t,i),e.touchTile(t,i))})),t.refineReplace&&(e.isCheckChildrenPassSSE()&&(e.anyChildrenPassSSE(t,i)||(a=!1)),a&&n.forEach((e=>{r.push(e)})))}}else if(!t.contentAvailable){n=!1;break}}return n}_initOccluded(e){r.GlobalData.EnableOcclusionCulling&&(r.Math.equalsEpsilonVec3(e.camera.position,i,.01)||r.Math.equalsEpsilonVec3(e.camera.target,n,.01)||(i.copy(e.camera.position),n.copy(e.camera.target),this.occlusionMap.clear()),e.viewer.rendererManager.renderer.renderer.autoClear=!1)}_endOccluded(e){if(!r.GlobalData.EnableOcclusionCulling)return;e.viewer.rendererManager.renderer.renderer.autoClear=!0}_isOccluded(i,n){if(!r.GlobalData.EnableOcclusionCulling)return!1;if(!i.contentUnloaded||i.forceLoad)return!1;if(this.occlusionMap.has(i))return this.occlusionMap.get(i);if(e.copy(i.boundingBox),e.applyMatrix4(i._transformMatrix),e.containsPoint(n.cameraPositionWc))return!1;const a=n.viewer.rendererManager.renderer.renderer,s=a.getContext();if(!i.boundingBoxMesh){const e=r.GeomUtil.computeBoundingBoxPositions(i.boundingBox),a=new THREE.BufferGeometry;a.setAttribute("position",new THREE.Float32BufferAttribute(e,3));const o=new THREE.Mesh(a,t);o.applyMatrix4(i._transformMatrix),o.applyMatrix4(n.globalMatrix),o.updateMatrixWorld(),o.userData.query=s.createQuery(),o.userData.queryInProgress=!1,o.userData.occluded=!0,i.boundingBoxMesh=o}const o=i.boundingBoxMesh,l=o.userData;return l.queryInProgress&&s.getQueryParameter(l.query,s.QUERY_RESULT_AVAILABLE)&&(s.getQueryParameter(l.query,s.QUERY_RESULT)?l.occluded=!1:l.occluded=!0,l.queryInProgress=!1,this.occlusionMap.set(i,l.occluded)),l.queryInProgress||(s.beginQuery(s.ANY_SAMPLES_PASSED_CONSERVATIVE,l.query),a.render(o,n.camera),s.endQuery(s.ANY_SAMPLES_PASSED_CONSERVATIVE),l.queryInProgress=!0),l.occluded}}r.BimTilesetTraversal=a}(),r.BimTilesPickingManager=class{constructor(e,t){this.model=e,this.pickingEffecter=t,this.selectionChangedRenderer=r.EnumChangedState.NONE,this.lastSelectionChangedRenderer=r.EnumChangedState.NONE,this.selectedIdMap=new Map,this.selectedMeshes=new r.ObjectGroup,this.selectedMeshes.pickTile=!0,this.instanceMatrixListMap=new Map,this._dirty=!1,this.stateChangedRenderer=0}destroy(){this.selectedIdMap.clear(),this.selectedIdMap=null,this.instanceMatrixListMap.clear(),this.instanceMatrixListMap=null,this.selectedMeshes.clear(),this.selectedMeshes=null,this.pickingEffecter=null,this.model=null}setSelectedIdMap(e){if(this.selectedIdMap.clear(),e)for(const t of e.keys()){const e=this.model.tilesLoader.tileReader.getIndexByUserId(t);this.model.filter.isPickable(e)&&this.selectedIdMap.set(e,!0)}}beforeUpdate(){this.lastSelectionChangedRenderer!==this.selectionChangedRenderer&&(this.lastSelectionChangedRenderer=this.selectionChangedRenderer,this.selectedMeshes.clear(),this.selectedMeshes.matrix.copy(this.model.getTransformMatrix()),this.selectedMeshes.matrixAutoUpdate=!1,this._dirty=!0)}afterUpdate(){!1!==this._dirty&&(this._dirty=!1,this.pickingEffecter._clearMeshesFromScene(),0!==this.selectedIdMap.size&&(this.pickingEffecter.selectionObjectGroup.add(this.selectedMeshes),this.pickingEffecter._updateMatrixWorldForScene()))}clearDrawable(){this.selectedMeshes.children.map((e=>{e.visible=!1}))}enableSelectionStateChanged(){this.selectionChangedRenderer++,this.selectionChangedRenderer>r.EnumChangedState.END&&(this.selectionChangedRenderer=r.EnumChangedState.START)}updatePickingMeshes(e){if(this.stateChangedRenderer!==e.stateChangedRenderer||this.selectionChangedRenderer!==e.selectionChangedRenderer)if(this.needsUpdate(e)){this.stateChangedRenderer=e.stateChangedRenderer;for(let t=0;t<e.selectionMeshes.length;++t)r.Utils.defined(e.selectionMeshes[t].selectedMeshes)&&(e.selectedMeshes[t].selectedMeshes=null);e.selectionMeshes=[],!0===e.isInstanceTile?this.updateInstancePickingMeshes(e):this.updateBatchedPickingMeshes(e),e.selectionChangedRenderer=this.selectionChangedRenderer}else e.selectionChangedRenderer=this.selectionChangedRenderer}updatePickingWireFrame(e){this.stateChangedRenderer===e.stateChangedRenderer&&this.selectionChangedRenderer===e.selectionWireFrameChangedRenderer||e.isOutlineLoading()||(this.needsUpdate(e)?(this.stateChangedRenderer=e.stateChangedRenderer,e.selectionWireFrames=[],!0===e.isInstanceTile?this.updateInstanceWireFramePickingMeshes(e):this.updateBatchedWireFramePickingMeshes(e),e.selectionWireFrameChangedRenderer=this.selectionChangedRenderer):e.selectionWireFrameChangedRenderer=this.selectionChangedRenderer)}needsUpdate(e){const t=e.userIndexMap;for(let e of this.selectedIdMap.keys())if(t.has(e))return!0;return!1}getMatchedIds(e){let t=[];if(e.size<=this.selectedIdMap.size)for(let i of e.keys())this.selectedIdMap.has(i)&&t.push(i);else for(let i of this.selectedIdMap.keys())e.has(i)&&t.push(i);return t}updateBatchedPickingMeshes(e){e.content.meshes.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,n=t.indexGroups,a=this.getMatchedIds(n);if(0===a.length)return;let s,o=new THREE.BufferGeometry;if(o.setAttribute("position",i.getAttribute("position")),i.getAttribute("growthPlaneIndex")&&o.setAttribute("growthPlaneIndex",i.getAttribute("growthPlaneIndex")),i.getAttribute("uv"),o.setIndex(i.getIndex()),"LineSegmentsEx"===t.type){let e=[];for(let t=0;t<a.length;++t){let i=n.get(a[t]);for(const t of i.values())e.push(t)}t.matrixWorld.clone();let i=new r.LineSegmentsPickGeometryCreaetor(o,e).getGeometry(),l=new r.LineSegmentsHighLightMaterial({color:3330982});s=new r.LineSegmentsPickMesh(i,l)}else s=new THREE.Mesh(o,r.MaterialUtil.DefaultMaterial),s.material=[r.MaterialUtil.getDefaultSelectedMaterial()],t.material[0].growthAnimationPlanes&&(s.material[0].growthAnimationPlanes=t.material[0].growthAnimationPlanes,s.material[0].defines||(s.material[0].defines={}),s.material[0].defines.GROWTH_ANIMATION="",s.material[0].refreshUniforms()),a.map((e=>{const t=n.get(e);for(const e of t.values()){let t=0;s.geometry.addGroup(e.indexStart,e.indexCount,t)}}));s.matrix.copy(t.matrix),s.matrixAutoUpdate=!1,s.name=t.name,s.frustumCulled=!1,s.renderOrder=r.EnumRenderOrder.Component,s._indicesGroup=n,this._dirty=!0,e.selectionMeshes.push(s),r.Utils.defined(t.selectedMeshes)||(t.selectedMeshes=[]),t.selectedMeshes.push(s),this.selectedMeshes.add(s)}))}updateBatchedWireFramePickingMeshes(e){e._content._outlineContent.outlineMeshes.traverse((t=>{if("LineSegmentsEx"===!t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,n=t.indexGroups,a=this.getMatchedIds(n);if(0===a.length)return;let s=new THREE.BufferGeometry;s.setAttribute("position",i.getAttribute("position")),i.getAttribute("growthPlaneIndex")&&s.setAttribute("growthPlaneIndex",i.getAttribute("growthPlaneIndex")),s.setIndex(i.getIndex());let o=new THREE.LineSegments(s,r.BimTileWireframeManager.selectedMaterial);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.WireFrame,o._indicesGroup=n,o.material=[r.MaterialUtil.getDefaultSelectedMaterial()],o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,a.map((e=>{const t=n.get(e);for(const e of t.values())o.geometry.addGroup(e.indexStart,e.indexCount,0)})),this._dirty=!0,r.Utils.defined(t.selectedMeshes)||(t.selectedMeshes=[]),t.selectedMeshes.push(o),e.selectionWireFrames.push(o),this.selectedMeshes.add(o)}))}updateInstancePickingMeshes(e){this.instanceMatrixListMap.clear();const t=e.content.meshes,i=e.userIndexMap,n=this.getMatchedIds(i);0!==n.length&&t.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(r.TilesUtil.isInstanceNodeInVisible(t))return;const i=t.geometry;let a=[];n.map((n=>{const s=this.model.getDescriptor().getInstanceNodeInfos().get(n).get(t.name);if(s)for(const[o,l]of s){const s=l.matrix;a.push(s);let d=new THREE.BufferGeometry;d.setAttribute("position",i.getAttribute("position")),d.setIndex(i.getIndex()),i.getAttribute("growthPlaneIndex")&&d.setAttribute("growthPlaneIndex",new THREE.BufferAttribute(new Float32Array(i.getAttribute("position").count).fill(i.getAttribute("growthPlaneIndex").array[o]),1,!1));let h=null;h="LineSegmentsEx"===t.type?new THREE.LineSegments(d,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(d,r.MaterialUtil.getDefaultSelectedMaterial());const c=t.material instanceof Array?t.material[0]:t.material;c.growthAnimationPlanes&&(h.material.growthAnimationPlanes=c.growthAnimationPlanes,h.material.refreshUniforms(),h.material.defines||(h.material.defines={}),h.material.defines.GROWTH_ANIMATION=""),h.name=`${t.name}_${n}`,h.frustumCulled=!1,h.matrix.copy(t.matrix).multiply(s),h.matrixAutoUpdate=!1,e.selectionMeshes.push(h),r.Utils.defined(t.selectedMeshes)||(t.selectedMeshes=[]),t.selectedMeshes.push(h),this.selectedMeshes.add(h)}})),this._dirty=!0,this.instanceMatrixListMap.set(t.name,a)}))}updateInstanceWireFramePickingMeshes(e){const t=e._content._outlineContent.outlineMeshes,i=e.userIndexMap,n=this.getMatchedIds(i);0!==n.length&&t.traverse((t=>{"LineSegmentsEx"===t.type&&n.map((i=>{const n=this.model.getDescriptor().getInstanceNodeInfos().get(i).get(t.name);if(!n)return;const a=t.geometry;for(const[i,s]of n){let n=new THREE.BufferGeometry;const o=s.matrix;n.setAttribute("position",a.getAttribute("position")),a.getAttribute("growthPlaneIndex")&&n.setAttribute("growthPlaneIndex",new THREE.BufferAttribute(new Float32Array(a.getAttribute("position").count).fill(a.getAttribute("growthPlaneIndex").array[i]),1,!1)),n.setIndex(a.getIndex());let l=new THREE.LineSegments(n,r.MaterialUtil.getDefaultSelectedMaterial());const d=t.material instanceof Array?t.material[0]:t.material;d.growthAnimationPlanes&&(l.material.growthAnimationPlanes=d.growthAnimationPlanes,l.material.refreshUniforms()),l.name=t.name,l.frustumCulled=!1,l.renderOrder=r.EnumRenderOrder.WireFrame,l.matrix.copy(t.matrix).multiply(o),l.matrixAutoUpdate=!1,r.Utils.defined(t.selectedMeshes)||(t.selectedMeshes=[]),t.selectedMeshes.push(l),this._dirty=!0,e.selectionWireFrames.push(l),this.selectedMeshes.add(l)}}))}))}},r.IsolateInfoStatics=class{constructor(e){this.viewer=e,this.meshChangeTime=0,this.useridInfoChangeTime=0,this.isPatch=!1,this.isfirstStatics=!0,this.descriptorCount=0,this.mesh_start=0,this.mesh_end=0,this.userInfo_start=0,this.userInfo_end=0}meshTimeStart(){this.isPatch&&this.isfirstStatics&&(this.mesh_start=performance.now())}userIdInfoTimeStart(){this.userInfo_start=performance.now()}userIdInfoTimeEnd(){this.userInfo_end=performance.now(),this.useridInfoChangeTime=this.userInfo_end-this.userInfo_start}meshTimeEnd(){this.isPatch&&this.isfirstStatics&&(this.mesh_end=performance.now(),this.meshChangeTime=this.mesh_end-this.mesh_start,this.isfirstStatics=!1)}init(){this.meshChangeTime=0,this.useridInfoChangeTime=0,this.start=0,this.end=0,this.isPatch=!0,this.isfirstStatics=!0,this.descriptorCount=0}},r.overrideColorInfoStatic=class{constructor(e){this.viewer=e,this.meshChangeTime=0,this.startTime=0,this.endTime=0,this.overrideComponentsColorTime=0,this.isPatch=!1}start(){this.startTime=performance.now()}end(){this.endTime=performance.now(),this.overrideComponentsColorTime=this.endTime-this.startTime}init(){this.overrideComponentsColorTime=0,this.isPatch=!0}},r.InsLodInfo=class{constructor(e,t,i){this.lodLevel=e,this.modelUrl=t,this.fullUrl=i+t,this.modelState={},this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred}},r.BimTileInstanceLodMeshPool=class{constructor(e,t,i){this._tileset=r.Utils.defaultValue(e,null),this.insId_lodInfo_map=[],this.insRealLodLevelMap=[],this.buildMeshMap(t,i)}destroy(){this._tileset=null,this.insId_lodInfo_map=[],this.insRealLodLevelMap=[]}buildMeshMap(e,t){for(const i of e){const e={};let n={},a={};for(const s of i.files){let i=n[s.model];void 0===i&&(i=s.lod,n[s.model]=i,e[i]=new r.InsLodInfo(i,s.model,t)),a[s.lod]=i}this.insId_lodInfo_map.push(e),this.insRealLodLevelMap.push(a)}}getLodMeshInfo(e,t){if(!this.isModelInvalided(e))return this.insId_lodInfo_map[e][this.getRealLodLevel(e,t)]}getLodMeshInfoRecursive(e,t){if(this.isModelInvalided(e))return;const i=this.insId_lodInfo_map[e];for(;t>=0;){const r=this.getRealLodLevel(e,t);if(i[r])return i[r];--t}}setModelState(e,t,i,r){if(this.isModelInvalided(e))return;const n=this.insId_lodInfo_map[e],a=this.getRealLodLevel(e,t);n[a]&&(n[a].modelState[i]=r)}isAllModelReady(e,t){if(this.isModelInvalided(e))return!1;const i=this.insId_lodInfo_map[e];for(const e in i)if(i[e].modelState[t]!==r.TileContentState.READY)return!1;return!0}isModelReady(e,t,i){return!this.isModelInvalided(e)&&this.insId_lodInfo_map[e][this.getRealLodLevel(e,t)].modelState[i]===r.TileContentState.READY}isModelInvalided(e){return e<0||e>=this.insId_lodInfo_map.length}getRealLodLevel(e,t){const i=this.insRealLodLevelMap[e],r=Object.keys(i).length;return t<r?i[t]:i[r-1]}},function(){class e extends r.BimtilesObjectInfoDict{constructor(){super()}setTileReader(e){this.tileReader=e}getNodeInfoCallback(e){for(const t of this.nodeInfos[0].values())r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(t,this.tileReader,e);for(const t of this.nodeInfos[1].values())r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(t,this.tileReader,e)}getUserDataCallback(e){for(const t of this.nodeInfos[0].values())e&&e(t.userId,t);for(const t of this.nodeInfos[1].values())e&&e(t.userId,t)}setIdsState2(e,t,i,r){if(!0!==i&&void 0!==i){for(const t of this.nodeInfos[0].values()){const i=t.userId;e.has(i)||r&&r(t)}for(const t of this.nodeInfos[1].values()){const i=t.userId;e.has(i)||r&&r(t)}}else{let i=0;for(const n of e.keys()){let e=this.nodeInfos[0].get(n),a=t[i];if(e&&e instanceof Map){for(const[t,i]of e)r&&r(i,a);if(e=this.nodeInfos[1].get(n),e)for(const[t,i]of e)r&&r(i,a)}else e&&r&&r(e,a),e=this.nodeInfos[1].get(n),e&&r&&r(e,a);i++}}}setIdsState(e,t,i){if(!0!==t&&void 0!==t){for(const t of this.nodeInfos[0].values()){const r=t.userId;e.has(r)||i&&i(t)}for(const t of this.nodeInfos[1].values()){const r=t.userId;e.has(r)||i&&i(t)}}else for(const t of e.keys()){let e=this.nodeInfos[0].get(t);e&&i&&i(e),e=this.nodeInfos[1].get(t),e&&i&&i(e)}}getNodeInfoById(e){const t=parseInt(e);return this.nodeInfos[0].has(t)?this.nodeInfos[0].get(t):this.nodeInfos[1].has(t)?this.nodeInfos[1].get(t):void 0}}e.getBatchedNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[n,a]of r){let r=t.getNodeIdByIndex(a);r&&(i&&i(e.userId,r))}},e.getBatchedNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const n=e.nodeIdMap;for(const[a,s]of n){let n=i.getNodeIdByIndex(s);n&&n.tilId===t&&(r&&r(e.userId,n))}},e.getInstanceNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[n,a]of r)for(const[r,n]of a){let r=t.getNodeIdByIndex(n);r&&(i&&i(e.userId,r))}},e.getInstanceMatrixListByUserIdAndMeshId=(e,t,i)=>{let r=[];const n=e.nodeIdMap.get(t);if(!n)return r;for(const[e,t]of n){let e=i.getNodeIdByIndex(t);e&&r.push(e.matrix)}return r},e.getInstanceNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const n=e.nodeIdMap;for(const[a,s]of n)for(const[n,a]of s){let n=i.getNodeIdByIndex(a);n&&n.tilId===t&&(r&&r(e.userId,n))}},r.BimtilesObjectInfoDict2=e;class t extends r.BimtileObjectInfoManager{constructor(){super(),this.objectInfoDict=new r.BimtilesObjectInfoDict2}setTileReader(e){this.tileReader=e,this.objectInfoDict.setTileReader(e)}}r.BimtileObjectInfoManager2=t}(),r.BimTileNewNodeInfo=class{constructor(){this._userId=void 0,this._userData=void 0,this._state=r.EnumObjectState.Visible,this.nodeIdMap=new Map,this._material=null,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0}getHeader(){return{userId:this._userId,userData:this._userData,state:this._state,name:this._userId,material:this._material,explodeMatrix:this._explodeMatrix,loadedExplodeMatrix:this._loadedExplodeMatrix}}destroy(){this._userId=void 0,this._userData=void 0,this._state=void 0,this._material=null,this.nodeIdMap.clear(),this.nodeIdMap=null,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0}get name(){return this._userId}set name(e){this._userId=e}get state(){return this._state}set state(e){this._state=e}get material(){return this._material}set material(e){this._material=e}get userId(){return this._userId}set userId(e){this._userId=e}get explodeMatrix(){return this._explodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}addNodeIdInfo(e,t){this.nodeIdMap.has(e)&&console.log(e),this.nodeIdMap.set(e,t)}addInstanceNodeIdInfo(e,t,i){this.nodeIdMap.has(e)||(this.nodeIdMap.set(e,new Map),this.nodeIdMap.get(e).set(t,i)),this.nodeIdMap.get(e).set(t,i)}get userData(){return this._userData}set userData(e){this._userData=e}},r.BimTileNodeBoxTool=class{constructor(){this.globalNodeBoxUrls={},this.globalNodeBoxBuffers=[],this.NodeBoxMap={}}destroy(){this.globalNodeBoxUrls=null,this.globalNodeBoxBuffers=null,this.NodeBoxMap=null}addGlobalNodeBoxUrl(e,t){this.globalNodeBoxUrls[e]=t}getGlobalNodeBoxUrls(){return Object.keys(this.globalNodeBoxUrls)}parseNodeBoxBuffer(e,t){const i=this.globalNodeBoxUrls[t];e.getNodeboxsList().map(((e,t)=>{this.NodeBoxMap[i+t]=(new THREE.Box3).setFromArray(e.getBboxList())})),e=null}getNodeBoxByIndex(e){return this.NodeBoxMap[e]}},r.BimTileNodeIdTool=class{constructor(){this.globalNodeIdUrls=[],this.globalNodeIdBuffers={},this.nodeIdMap={}}destroy(){this.globalNodeIdUrls=null,this.globalNodeIdBuffers=null,this.nodeIdMap=null}addGlobalNodeIdUrl(e,t){this.globalNodeIdUrls[e]=t}getGlobalNodeIdUrls(){return Object.keys(this.globalNodeIdUrls)}parseNodeIdBuffer(e,t,i){const n=this.globalNodeIdUrls[t];e.getNodeIdsList().map(((e,t)=>{const i=new r.BimTileNodeIdInfo;i.index=e.getNodeId(),i.userId=e.getUserId(),i.boundingBox=e.getBboxId(),i.tileId=e.getTileId(),this.nodeIdMap[n+t]=i})),e=null}getNodeIdByIndex(e){return this.nodeIdMap[e]}},function(){class e extends r.BimtileDescriptor{constructor(e){super(),this.tileReader=e,this.nodeIdMap=e.nodeIdTool.nodeIdMap,this.userDataIndexMap=e.userDataTool.userDataIndexMap}destroy(){this.tileReader=null,this.nodeIdMap=null,this.userDataIndexMap=null,super.destroy()}setUserData(){}_classifyNodeInfo(e){const t=this.nodeIdMap[e],i=t.tileId,n=t.userId,a=t.index;let s=!1;if(this.tileReader.globalTileIdBuffer){const e=this.tileReader.globalTileIdBuffer.getTileIdsList()[i];-1!==this.tileReader.globalTileIdBuffer.getTilePathList()[e].indexOf("instance")&&(s=!0)}t.instanceOrNot=s;const o=s?this.mapNodeInfoByInstance:this.mapNodeInfoByBatched;let l=o.get(n);l||(l=new r.BimTileNewNodeInfo,l.userId=n,l.userData=this.tileReader.userIdTool.userDataIndexMap[n],o.set(n,l)),s?l.addInstanceNodeIdInfo(t.nodeId,a,e):l.addNodeIdInfo(t.nodeId,e),t.update(l,this.tileReader)}patchBatchedMeshNodeInfo(e,t,i){const r=parseInt(e),n=this.mapNodeInfoByBatched.get(r);if(!n)return;const a=n.nodeIdMap.get(t);if(void 0===a)return;let s=this.tileReader.getNodeIdByIndex(a);s.parent=i.parent,s.materialId=i.materialId,s.matrix=i.matrix,s.explodeMatrix&&(s.matrix=i.matrix.clone(),s.matrix.multiplyMatrices(n.explodeMatrix,s.matrix)),s.type=i.type}patchInstanceNodeInfo(e,t,i){const r=parseInt(e),n=this.mapNodeInfoByInstance.get(r);if(!n)return;const a=n.nodeIdMap.get(i.bufferId);if(!a)return;const s=a.get(i.instanceIndex);let o=this.tileReader.getNodeIdByIndex(s);o.geometryId=t,o.parent=t,o.matrix=i.entityMatrix.clone(),n.explodeMatrix&&(o.matrix=i.entityMatrix.clone(),o.matrix.multiplyMatrices(n.explodeMatrix,o.matrix)),o.type=i.type}getInstanceMatrixListByUserIdAndMeshId(e,t){const i=this.mapNodeInfoByInstance.get(e);return i?r.BimtilesObjectInfoDict2.getInstanceMatrixListByUserIdAndMeshId(i,t,this.tileReader):[]}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),n=this.mapNodeInfoByBatched.get(i);n&&r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(n,this.tileReader,((e,i)=>{const r={instanceOrNot:!1,meshId:i.nodeId,parent:i.parent,nodeInfo:i};t&&t(r)}))}getBatchedNodeInfoByUserIdTileIdCallback(e,t,i){const n=parseInt(e);t=parseInt(t);const a=this.mapNodeInfoByBatched.get(n);a&&r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReaderWithTileId(a,t,this.tileReader,((e,t)=>{const r={instanceOrNot:!1,meshId:t.nodeId,parent:t.parent,nodeInfo:t};i&&i(r)}))}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),n=this.mapNodeInfoByInstance.get(i);n&&r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(n,this.tileReader,((e,i)=>{const r={instanceOrNot:!0,meshId:i.nodeId,parent:i.parent,nodeInfo:i};t&&t(r)}))}getInstanceNodeInfoByUserIdTileIdCallback(e,t,i){const n=parseInt(e);t=parseInt(t);const a=this.mapNodeInfoByInstance.get(n);a&&r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReaderWithTileId(a,t,this.tileReader,((e,t)=>{const r={instanceOrNot:!0,meshId:t.nodeId,parent:t.parent,nodeInfo:t};i&&i(r)}))}getAnyUserData(){for(const e of this.mapNodeInfoByBatched.values())return e.userData}getUserDataByUserId(e){const t=parseInt(e);let i=this.mapNodeInfoByBatched.get(t);return i?i.userData:(i=this.mapNodeInfoByInstance.get(t),i?i.userData:void 0)}getAllNodeInfosCallback(e){for(const t of this.mapNodeInfoByBatched.values())r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(t,this.tileReader,((t,i)=>{e(i)}));for(const t of this.mapNodeInfoByInstance.values())r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(t,this.tileReader,((t,i)=>{e(i)}))}patchBoxExplodeMatrix(e,t,i){const r=parseInt(t);let n=null;n=i?this.mapNodeInfoByInstance.get(r):this.mapNodeInfoByBatched.get(r),n.loadedExplodeMatrix=e}patchExplodeMatrix(e,t,i){const r=parseInt(t);let n=null;n=i?this.mapNodeInfoByInstance.get(r):this.mapNodeInfoByBatched.get(r),n.explodeMatrix=e}patchLoadedTileExplodeMatrix(e,t,i,r,n){const a=parseInt(t);if(n){const t=this.mapNodeInfoByInstance.get(a).nodeIdMap.get(i).get(r);return void(this.tileReader.getNodeIdByIndex(t).matrix=e)}const s=this.mapNodeInfoByBatched.get(a).nodeIdMap.get(i);this.tileReader.getNodeIdByIndex(s).matrix=e}verifyNodeInfos(){for(const e of this.mapNodeInfoByBatched.values()){const t=e.nodeIdMap;for(const i in t){const r=t.get(i);void 0===this.tileReader.getNodeIdByIndex(r).parent&&console.log(e)}}for(const e of this.mapNodeInfoByInstance.values()){const t=e.nodeIdMap;for(const i in t){const r=t.get(i);for(const t in r){const i=r[t];void 0===this.tileReader.getNodeIdByIndex(i).parent&&console.log(e)}}}}getBatchedUserIds(){let e=new Map,t=new THREE.Vector3;for(const[i,r]of this.mapNodeInfoByBatched){let n=new THREE.Box3;const a=r.nodeIdMap;for(const e of a.keys()){const t=a.get(e);const i=this.tileReader.getNodeIdByIndex(t).boundingBox;n.union(i)}n.getSize(t),e.set(i,t.length())}return r.Utils.SortMapByValue(e)}getInstanceUserIds(){let e=new Map,t=new THREE.Vector3;for(const[i,r]of this.mapNodeInfoByInstance){let n=new THREE.Box3;const a=r.nodeIdMap;for(const e of a.keys()){const t=a.get(e);for(const e of t.keys()){const i=t.get(e);const r=this.tileReader.getNodeIdByIndex(i).boundingBox;n.union(r)}}n.getSize(t),e.set(i,t.length())}return r.Utils.SortMapByValue(e)}getUserTileIdMap(e,t){this.getNodeInfoByUserIdCallback(e,(e=>{const i=e.nodeInfo;t[i.tileId]=null}))}}r.BimtileNodeIdDescriptor=e}(),function(){class e extends r.BimTileReader{constructor(){super(),this.searchTreeManager=new r.BimTileNewSearchTreeManager(this),this.nodeIdTool=new r.BimTileNodeIdTool,this.nodeBoxTool=new r.BimTileNodeBoxTool,this.descriptor=new r.BimtileNodeIdDescriptor(this)}getNodeIdByIndex(e){return this.nodeIdTool.getNodeIdByIndex(e)}getNodeBoxByIndex(e){return this.nodeBoxTool.getNodeBoxByIndex(e)}parseBlock(e,t,i){const n=t.node,a=t.type,s=t.url,o=t.outline;let l=!0,d=0,h=[];n.bufferType=a;let c=0;const u=e.byteLength;for(n.buffer=r.Utils.isDefined(n.buffer)?n.buffer:{},n.lineBuffer=r.Utils.isDefined(n.lineBuffer)?n.lineBuffer:{},n.outlineBuffer=r.Utils.defaultValue(n.outlineBuffer,{});c<u;){const t=e.slice(c,c+4);let i=new Uint32Array(t)[0];c+=4;const u=new Uint8Array(e,c,i);c+=i;const m=proto.bimtile_pbf.BlockHeader.deserializeBinary(u);l&&m.getDataType(),i=m.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var p=new Uint8Array(e,c,i);if(c+=i,m.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const f=m.getDataType();let g={};switch(f){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf_v2.SearchTreeBlob.deserializeBinary(p);g.type=f,g.content=e,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf_v2.UserIDBlob.deserializeBinary(p);if(a===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}g.type=f,g.content=t,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_NODEID:const i=proto.bimtile_pbf_v2.NodeIDList.deserializeBinary(p);if(a===r.TileContentType.DATA_GLOBAL_NODE_ID){this.nodeIdTool.parseNodeIdBuffer(i,s);break}break;case proto.BlockHeader.BlockType.BT_NODEBOX:const l=proto.bimtile_pbf_v2.NodeBBoxBlob.deserializeBinary(p);if(a===r.TileContentType.DATA_GLOBAL_NODE_BOX){this.nodeBoxTool.parseNodeBoxBuffer(l,s);break}break;case proto.BlockHeader.BlockType.BT_MATERIAL:const h=proto.bimtile_pbf.MaterialBlob.deserializeBinary(p);if(g.type=f,g.content=h,a===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=h;break}n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_USERDATA:const c=proto.bimtile_pbf.UserdataBlob.deserializeBinary(p);if(a===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(c);break}g.type=f,g.content=c,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_BUFFER:const u=proto.bimtile_pbf.BufferBlob.deserializeBinary(p);g.type=f,g.content=u,a===proto.BlockHeader.BlockType.BT_LINE?o?n.outlineBuffer[d]=g:n.lineBuffer[d]=g:n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_MESH:const m=proto.bimtile_pbf.MeshBlob.deserializeBinary(p);g.type=f,g.content=m,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_POINT:const v=proto.bimtile_pbf.PointBlob.deserializeBinary(p);g.type=f,g.content=v,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_TILEID:const y=proto.bimtile_pbf.TileIDBlob.deserializeBinary(p);if(g.type=f,g.content=y,a===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=y;break}n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_INSTANCE:const M=proto.bimtile_pbf.InstanceBlob.deserializeBinary(p);g.type=f,g.content=M,n.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_LINE:const E=proto.bimtile_pbf.MeshBlob.deserializeBinary(p);g.type=f,g.content=E,a===proto.BlockHeader.BlockType.BT_LINE&&o?n.outlineBuffer[d]=g:n.lineBuffer[d]=g;break;default:return void console.warn("Parse unknow block faild! ")}l&&(l=!1),h[d]=d,d++}i&&i()}createNodeInfoMap(){const e=this.nodeIdTool.nodeIdMap;for(const t in e)this.getDescriptor()._classifyNodeInfo(t);this.userIdTool.disposeBuffer()}}r.BimTilesNewReader=e}(),function(){class e extends r.BimTileSearchTreeManager{constructor(e){super(e),this.scratchVector=new THREE.Vector3,this.lineBoxScale=r.GlobalData.LineSelectRange/2*.1}intersect(e,t,i,n,a,s){let o,l=r.Utils.scratchBoundingBox,d=this.scratchVector;const h=this.is2D,c=this.lineBoxScale;if(!t){let t=r.Utils.scratchMatrix4_1;t.copy(n).invert(),o=e.ray.clone().applyMatrix4(i).applyMatrix4(t)}let u=t?function(e){let i=l.copy(e);return i.applyMatrix4(n),t.intersectsBox(i)?1:-1}:function(e){return!0===h&&(e.getSize(d),d.x<.001||d.y<.001?e.expandByScalar(c):(e.min.z-=c,e.max.z+=c)),o.intersectBoxWithDistance(e)},p={};const m=this.searchTreeBuffer;for(const e in m){const t=m[e].searchTreeBlob,i=m[e].box,n=u(i);if(!s&&n<0)continue;const a=t.getOctreeList(),o=t.getOctreeList()[0];let l=(e,t)=>{const i=r.TilesUtil.getBox(t.getBboxList()),n=u(i);if(!s&&n<0)return;let a=t.getNodesList();const o=a.length;for(let e=0;e<o;++e){const t=a[e],i=this.reader.getNodeIdByIndex(t),r=i.boundingBox,n=u(r);if(!s&&n<0)continue;const o=i.nodeId;void 0===p[i.userId]?p[i.userId]=[o]:p[i.userId].push(o)}t.getChildrenList().map((t=>{const i=e[t];l(e,i)}))};l(a,o)}return p}getObjectsInBoxByBimtile(e,t,i,n,a){let s=r.Utils.scratchBoundingBox,o=(e,t,r)=>{let n=s.copy(e).applyMatrix4(t).applyMatrix4(r);return!!i.intersectsBox(n)&&(a(n)?1:2)};const l=this.searchTreeBuffer,d=t.getTransformMatrix();for(const t in l){const i=l[t].searchTreeBlob,a=l[t].box;if(!o(a,d,n))continue;const s=i.getOctreeList(),h=i.getOctreeList()[0];let c=(t,i)=>{const a=r.TilesUtil.getBox(i.getBboxList());if(!o(a,d,n))return;let s=i.getNodesList();for(let t=0,i=s.length;t<i;++t){const i=s[t],r=this.reader.getNodeIdByIndex(i),a=r.boundingBox;if(2!==o(a,d,n))continue;const l=r.userId,h=this.reader.getUserIdByIndex(l);e[h]=!0}i.getChildrenList().map((e=>{const i=t[e];c(t,i)}))};c(s,h)}}getUserIdsInFrustum(e,t,i,n,a,s){const o=e.getOctreeList(),l=e.getOctreeList()[0];let d=new THREE.Box3,h=(e,o)=>{const l=r.TilesUtil.getBox(o.getBboxList());if(d.copy(l),d.applyMatrix4(n).applyMatrix4(a),!t.intersectsBox(d)&&!s)return;let c=o.getNodesList();const u=c.length;for(let e=0;e<u;++e){const r=c[e],o=this.reader.getNodeIdByIndex(r),l=o.boundingBox;if(d.copy(l),d.applyMatrix4(n).applyMatrix4(a),!t.intersectsBox(d)&&!s)continue;const h=o.nodeId;void 0===i[o.userId]?i[o.userId]=[h]:i[o.userId].push(h)}o.getChildrenList().map((t=>{const i=e[t];h(e,i)}))};h(o,l)}}r.BimTileNewSearchTreeManager=e}(),function(){class e{constructor(){}static isVersion_1(t){return t===e.VERSION_1}static isVersion_2(t){return t===e.VERSION_2}static isVersion_3(t){return t===e.VERSION_3}}e.VERSION_1="0.0.1",e.VERSION_2="0.0.2",e.VERSION_3="0.0.3",r.BimTilesVersionControl=e}(),function(){class e extends r.BimtilesObjectInfoDict{constructor(){super()}setTileReader(e){this.tileReader=e}getNodeInfoCallback(e){const t=this.tileReader.descriptor;for(const i of t.userIdInfoMap.keys())e&&e(i,t.userIdInfoMap.get(i));for(const i of t.userIdInstanceInfoMap.keys())e&&e(i,t.userIdInstanceInfoMap.get(i))}getUserDataCallback(e){const t=this.tileReader.descriptor;for(let i=0;i<=t.maxUserIDIndex;++i)e&&e(i,{userId:i})}setIdsState(e,t,i){const r=this.tileReader.descriptor;if(!0!==t&&void 0!==t)this.tileReader.getAllUserIndexCallback((t=>{let n=r.userIdInfoMap.get(t);n||(n=r.patchUserIdState(t)),e.has(t)||i&&i(n),n=r.userIdInstanceInfoMap.get(t),n||(n=r.patchUserIdState(t)),e.has(t)||i&&i(n)}));else for(const t of e.keys()){let e=r.userIdInfoMap.get(t);e||(e=r.patchUserIdState(t)),i&&i(e),e=r.userIdInstanceInfoMap.get(t),e||(e=r.patchUserIdState(t)),i&&i(e)}}setIdsState2(e,t,i,r){const n=this.tileReader.descriptor;if(!0!==i&&void 0!==i)this.tileReader.getAllUserIndexCallback((t=>{let i=n.userIdInfoMap.get(t);i||(i=n.patchUserIdState(t)),e.has(t)||r&&r(i),i=n.userIdInstanceInfoMap.get(t),i||(i=n.patchUserIdState(t)),e.has(t)||r&&r(i)}));else{let i=0;for(const a of e.keys()){let e=t[i],s=n.userIdInfoMap.get(a);s||(s=n.patchUserIdState(a)),r&&r(s,e),s=n.userIdInstanceInfoMap.get(a),s||(s=n.patchUserIdState(a)),r&&r(s,e),i++}}}getNodeInfoById(e){const t=this.tileReader.descriptor;return t.userIdInfoMap.has(e)?t.userIdInfoMap.get(e):t.userIdInstanceInfoMap.has(e)?t.userIdInstanceInfoMap.get(e):t.cacheUserIdStateMap[e]}}e.getBatchedNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const e of r.values()){t.getNodeIdByIndex(e)}},e.getBatchedNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const n=e.nodeIdMap;for(const a of n.values()){let n=i.getNodeIdByIndex(a);n&&n.tilId===t&&(r&&r(e.userId,n))}},e.getInstanceNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const n of r.values())for(const r of n.values()){let n=t.getNodeIdByIndex(r);n&&(i&&i(e.userId,n))}},e.getInstanceMatrixListByUserIdAndMeshId=(e,t,i)=>{let r=[];const n=e.nodeIdMap.get(t);if(!n)return r;for(const e of n.values()){let t=i.getNodeIdByIndex(e);t&&r.push(t.matrix)}return r},e.getInstanceNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const n=e.nodeIdMap;for(const a of n.values())for(const n of a.values()){let a=i.getNodeIdByIndex(n);a&&a.tilId===t&&(r&&r(e.userId,a))}},r.BimtilesObjectInfoDictV3=e;class t extends r.BimtileObjectInfoManager{constructor(){super(),this.objectInfoDict=new r.BimtilesObjectInfoDictV3}setTileReader(e){this.tileReader=e,this.objectInfoDict.setTileReader(e)}calculateVisibleComponentsBbox(){this._boundingBox.makeEmpty();this.objectInfoDict.getNodeInfoCallback(((e,t)=>{if(this.isHidden(e))return;const i=this.tileReader.getUserIdBoxByIndex(t.userId);i&&!i.isEmpty()?(this._boundingBox.expandByPoint(i.min),this._boundingBox.expandByPoint(i.max)):console.warn("Object has no this._boundingBox, id is "+e)})),this.explodeBoxNeedUpdate=!1}matchConditions(e,t){let i=[],r=[];this.objectInfoDict.getUserDataCallback(((t,n)=>{const a=this.tileReader.getUserDataIndexByUserIndex(t),s=this.tileReader.getUserDataByIndex(a)||{};s.elementId=n.userId;this.isMatchConditions(s,e)?i.push(t):r.push(t)})),t&&t(i,!0),t&&t(r,!1)}matchConditionsWithFilterMng(e,t,i,r,n){let a=t._parseConditions(e),s=[],o=[];this.objectInfoDict.getUserDataCallback(((e,t)=>{const i=this.tileReader.getUserDataIndexByUserIndex(e),r=this.tileReader.getUserDataByIndex(i)||{};r.elementId=t.userId;this.isMatchConditions(r,a)?s.push(e):o.push(e)})),r&&n?(i&&i(r,n,s,!0),i&&i(r,n,o,!1)):(i&&i(s,!0),i&&i(o,!1))}getMatchIds(e){let t=[];return this.objectInfoDict.getUserDataCallback(((i,r)=>{const n=this.tileReader.getUserDataIndexByUserIndex(i),a=this.tileReader.getUserDataByIndex(n)||{};a.elementId=r.userId;this.isMatchConditions(a,e)&&t.push(i)})),t}getMaterial(e){const t=this.objectInfoDict.getNodeInfoById(e);if(t)return t.material}clearIsolates(){this.hasTransparentByIsolate=!1,this.hasObjectHiddenByIsolate=!1,this.setIsolateHideTransparent()}clearIsolatesByIds(e){let t=this.arrayToMap(e);this.objectInfoDict.setIdsState(t,!1,(e=>{e.state=e.state&~r.EnumObjectState.HideByIsolate&~r.EnumObjectState.TransparentByIsolate}))}setIsolateHideTransparent(){this.objectInfoDict.setIdsState(new Map,!1,(e=>{e.state=e.state&~r.EnumObjectState.HideByIsolate&~r.EnumObjectState.TransparentByIsolate}))}setIsolateHideAfterClear(e,t,i){this.clearIsolates();let n=this.arrayToMap(e);this.objectInfoDict.setIdsState(n,i,(e=>{e.state=e.state&~r.EnumObjectState.HideByIsolate&~r.EnumObjectState.TransparentByIsolate,t?(this.hasObjectHiddenByIsolate=!0,e.state=e.state|r.EnumObjectState.HideByIsolate):e.state=e.state&~r.EnumObjectState.HideByIsolate})),n=null}setIsolateTransparentAfterClear(e,t,i){this.clearIsolates();let n=this.arrayToMap(e);this.objectInfoDict.setIdsState(n,i,(e=>{this.isActive(e.userId)&&(e.state=e.state&~r.EnumObjectState.HideByIsolate&~r.EnumObjectState.TransparentByIsolate,t?(e.state=e.state|r.EnumObjectState.TransparentByIsolate,this.hasMaterial=!0,this.hasTransparentByIsolate=!0):e.state=e.state&~r.EnumObjectState.TransparentByIsolate)})),n=null}isHidden(e){const t=this.objectInfoDict.getNodeInfoById(e);if(void 0===t)return!1;let i=0==(t.state&r.EnumObjectState.Visible);return i=i||(t.state&r.EnumObjectState.HideByIsolate)>0,i}isFrozen(e){const t=this.objectInfoDict.getNodeInfoById(e);if(void 0===t)return!1;let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}isTransparent(e){const t=this.objectInfoDict.getNodeInfoById(parseInt(e));if(void 0===t)return!1;let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}}r.BimtileObjectInfoManagerV3=t}(),function(){class e extends r.BimTileFilterManager{constructor(e){super(e),this.objectInfoManager=new r.BimtileObjectInfoManagerV3}destroy(){super.destroy()}_collectDeactivateUserIds(e,t){e.deactivateUserIdSetObject=new Map;const i=this.objectInfoManager.inactivatedIdMap;if(this.objectInfoManager.hasObjectInactivated())for(const r in i){const i=parseInt(r);t.has(i)&&e.deactivateUserIdSetObject.set(i,!0)}}_needsUpdate(e){return super._needsUpdate(e)||0!==e.deactivateUserIdSetObject.size}releaseObject(e){super.releaseObject(e),e.deactivateUserIdSetObject=null}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),n=this.model.getDescriptor();if(this._collectBlinkUserIds(e,r),this._collectHoverUserIds(e,r),this._collectClippingUserIds(e,r),this._collectLocalClipUserIds(e,r),this._collectModifyOpacityUserIds(e,r),this._collectDeactivateUserIds(e,r),this._collectFilteredUserIds(e,r,n,!1),this._canChangeAllMeshGroup(e,i,r,!1))this.releaseObject(e);else{if(!this._needsUpdate(e))return e._content.clearCopyMeshes(),this.resetStandardNodeStates(i),void this.releaseObject(e);e._content.clearCopyMeshes(),this.resetStandardNodeStates(i),this.rebuildIndices(e,n,i),this.releaseObject(e)}}resetStandardNodeStates(e){e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.material=[e.material[0]],e.cloneMesh=null;let t=e.geometry;t.clearGroups(),t._visible=!0,e.visible=!0,t.addGroup(0,t.index.count,r.EnumElementState.NONE),t.attributes.vState.array.fill(0),t.attributes.vState.needsUpdate=!0}))}_needsWireFrameUpdate(e){return 0!==e.overrideWireFrameUserIdSetObject.size||0!==e.hiddenWireFrameUserIdSetObject.size}resetWireFrameNodeStates(e){e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;const t=e.geometry.attributes.vState,i=t.count;for(let e=0;e<i;++e)t.array[4*e+1]=r.EnumElementState.NONE;t.needsUpdate=!0}))}wireFrameStandardApply(e){if(this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),n=this.model.getDescriptor();if(this._collectWireFrameFilteredUserIds(e,r,n),!this._needsWireFrameUpdate(e))return this.resetWireFrameNodeStates(i),void this.releaseWireFrameObject(e);this.resetWireFrameNodeStates(i),this.rebuildWireFrameIndices(e,i),this.releaseWireFrameObject(e)}instanceApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),n=this.model.getDescriptor();if(this._collectBlinkUserIds(e,r),this._collectHoverUserIds(e,r),this._collectClippingUserIds(e,r),this._collectLocalClipUserIds(e,r),this._collectModifyOpacityUserIds(e,r),this._collectDeactivateUserIds(e,r),this._collectFilteredUserIds(e,r,n,!0),this._canChangeAllMeshGroup(e,i,r,!0))this.releaseObject(e);else{if(!this._needsUpdate(e))return this.resetInstanceMaterial(i,e),void this.releaseObject(e);e._content.clearCopyMeshes(),this.resetInstanceMaterial(i,e),this._updateInstanceMaterial(e,n,i),this.releaseObject(e)}}releaseLodObject(e){e.blinkUserIdSetObject=null,e.hoverUserIdSetObject=null,e.modifyOpacityUserIdSetObject=null,e.overrideUserIdSetObject=null,e.transparentUserIdSetObject=null,e.stateLodChangedRenderer[e.realLodLevel]=this.stateChangedRenderer,e.deactivateUserIdSetObject=null}releaseLodWireFrameObject(e){e.overrideWireFrameUserIdSetObject=null,e.hiddenUserIdSetObject=null,e.clippingUserIdSetObject=null,e.localClipUserIdSetObject=null,e.hiddenWireFrameUserIdSetObject=null,e.stateLodWireFrameChangedRenderer[e.realLodLevel]=this.stateWireFrameChangedRenderer,e.forceUpdateWireFrame=!1}instanceLodApply(e){if(this.stateChangedRenderer===e.stateLodChangedRenderer[e.realLodLevel])return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),n=this.model.getDescriptor();if(this._collectBlinkUserIds(e,r),this._collectHoverUserIds(e,r),this._collectClippingUserIds(e,r),this._collectLocalClipUserIds(e,r),this._collectModifyOpacityUserIds(e,r),this._collectDeactivateUserIds(e,r),this._collectFilteredUserIds(e,r,n,!0),this._canChangeAllMeshGroup(e,i,r,!0))this.releaseLodObject(e);else{if(!this._needsUpdate(e))return this.resetInstanceMaterial(i,e),void this.releaseLodObject(e);this.resetInstanceMaterial(i,e),this._updateInstanceMaterial(e,n,i),this.releaseLodObject(e)}}wireFrameInstanceApply(e){if(this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=this.model.getDescriptor(),i=this.model.getDescriptor().tileUserIdMap,r=e._content.meshes,n=i.get(e.contentId);if(this._collectWireFrameFilteredUserIds(e,n,t),!this._needsWireFrameUpdate(e))return this.resetInstanceWireFrameMaterial(r,e),void this.releaseWireFrameObject(e);this.resetInstanceWireFrameMaterial(r,e),this.rebuildInstanceWireFrameIndices(e,t,r),this.releaseWireFrameObject(e)}wireFrameInstanceLodApply(e){if(this.stateWireFrameChangedRenderer===e.stateLodWireFrameChangedRenderer[e.realLodLevel])return;const t=this.model.getDescriptor(),i=this.model.getDescriptor().tileUserIdMap,r=e._content.meshes,n=i.get(e.contentId);if(this._collectWireFrameFilteredUserIds(e,n,t),!this._needsWireFrameUpdate(e))return this.resetInstanceWireFrameMaterial(r,e),void this.releaseLodWireFrameObject(e);this.resetInstanceWireFrameMaterial(r,e),this.rebuildInstanceWireFrameIndices(e,t,r),this.releaseLodWireFrameObject(e)}traverseInstanceGeometryMap(e,t,i){e.traverse((e=>{"MeshEx"!==e.type&&"LineSegmentsEx"!==e.type||t.enableDynamicInstanceLod()&&!e.insLodLevels[t.realLodLevel]||i(e)}))}traverseInstanceLineGeometryMap(e,t){e.traverse((e=>{"LineSegmentsEx"===e.type&&t(e.geometry)}))}resetInstanceMaterial(e,t){var i=this.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;let n=e.children[0],a=e.children[1];if(t.enableDynamicInstanceLod()){const e=t.content.getLodVisibleMeshList();n=e[0],a=e[1]}let s=n.geometry,o=a.geometry;if(s.getAttribute("vState").array.fill(r.EnumElementState.NONE),s.getAttribute("vState").needsUpdate=!0,s.getAttribute("vClipping").array.fill(i),s.getAttribute("vClipping").needsUpdate=!0,o.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),o.getAttribute("vState").needsUpdate=!0,n.visible=!0,a.visible=!1,t.meshLevelVisibleMap[n.uuid]=!0,t.meshLevelVisibleMap[a.uuid]=!1,t._content._instanceCopyMeshes[n.name]){const e=t._content._instanceCopyMeshes[n.name],a=t._content.getCopyMeshes(e).getObjectByName(n.name),s=a.geometry;s.getAttribute("vState").array.fill(r.EnumElementState.HIDDEN),s.getAttribute("vState").needsUpdate=!0,s.getAttribute("vClipping").array.fill(i),s.getAttribute("vClipping").needsUpdate=!0,a.visible=!1,t.meshLevelVisibleMap[a.uuid]=!1}}resetInstanceWireFrameMaterial(e,t){if(!0===t.isHideByFilter||!0===t.isTransparentByFilter)return;let i=e.children[0],n=e.children[1];if(t.enableDynamicInstanceLod()){const e=t.content.getLodVisibleMeshList();i=e[0],n=e[1]}let a,s=i.geometry,o=n.geometry;if("LineSegmentsEx"===i.type)return;const l=s.getAttribute("vState").array.length/4;for(let e=0;e<l;++e){let l;s.getAttribute("vState").array[4*e]!==r.EnumElementState.HIDDEN&&s.getAttribute("vState").array[4*e]!==r.EnumElementState.OVERRIDED&&s.getAttribute("vState").array[4*e]!==r.EnumElementState.TRANSPARENT&&s.getAttribute("vState").array[4*e]!==r.EnumElementState.DEACTIVATE&&s.getAttribute("vState").array[4*e]!==r.EnumElementState.HOVER&&(l=r.MaterialUtil.getColorParamsByMaterial(i.material),l.rgbaColor[3]=0,a=r.EnumElementWireFrameState.NONE,this.updateInstanceGeometry(i,l,a,e,!1),t.meshLevelVisibleMap[i.uuid]=i.visible),o.getAttribute("vState").array[4*e]!==r.EnumElementState.HIDDEN&&o.getAttribute("vState").array[4*e]!==r.EnumElementState.OVERRIDED&&o.getAttribute("vState").array[4*e]!==r.EnumElementState.TRANSPARENT&&o.getAttribute("vState").array[4*e]!==r.EnumElementState.DEACTIVATE&&o.getAttribute("vState").array[4*e]!==r.EnumElementState.HOVER&&(l=r.MaterialUtil.getColorParamsByMaterial(n.material),l.rgbaColor[3]=0,a=r.EnumElementWireFrameState.NONE,this.updateInstanceGeometry(n,l,a,e,!1),t.meshLevelVisibleMap[n.uuid]=n.visible)}}_updateInstanceMaterial(e,t,i){for(const n of e.hiddenUserIdSetObject.keys()){this._dealHideUserIndex(n,t,i,e.contentId,e);const a=i.children[0],s=e._content._instanceCopyMeshes[a.name];if(s){const i=e._content.getCopyMeshes(s).getObjectByName(a.name);i&&t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId),a=i.geometry;for(const e of n.keys())a.getAttribute("vState").array[4*e]=r.EnumElementState.HIDDEN,a.getAttribute("vState").needsUpdate=!0}))}}for(const n of e.localClipUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);let a=i.children[0],s=i.children[1];if(e.enableDynamicInstanceLod()){const t=e.content.getLodVisibleMeshList();a=t[0],s=t[1]}a.geometry,s.geometry;const o=r.MaterialUtil.getColorParamsByMaterial(a.material),l=r.EnumElementState.LOCALCLIPPING;for(const t of n.keys())this.updateInstanceGeometry(a,o,l,t,!0),e.meshLevelVisibleMap[a.uuid]=a.visible,this._updateCopyInstanceMeshes(a,o,l,t,e)}));for(const n of e.clippingUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);let a=i.children[0],s=i.children[1];if(e.enableDynamicInstanceLod()){const t=e.content.getLodVisibleMeshList();a=t[0],s=t[1]}a.geometry,s.geometry;const o=r.MaterialUtil.getColorParamsByMaterial(a.material),l=r.EnumElementState.CLIPPING;for(const t of n.keys())this.updateInstanceGeometry(a,o,l,t,!0),e.meshLevelVisibleMap[a.uuid]=a.visible,this._updateCopyInstanceMeshes(a,o,l,t,e)}));for(const n of e.transparentUserIdSetObject.keys()){const a=this._filterImpl.getFrozonMaterialV3(),s=r.MaterialUtil.getColorParamsByMaterial(a),o=r.EnumElementState.TRANSPARENT;this.updateInstanceGeometryByNodeInfos(n,t,s,o,i,e.contentId,e);const l=i.children[0],d=e._content._instanceCopyMeshes[l.name];if(d){const i=e._content.getCopyMeshes(d).getObjectByName(l.name);i&&t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId),a=i.geometry;i.material.transparent=!0;for(const e of n.keys())a.getAttribute("vState").array[4*e]=r.EnumElementState.TRANSPARENT,a.getAttribute("pointColorState").array[4*e+0]=s[0],a.getAttribute("pointColorState").array[4*e+1]=s[1],a.getAttribute("pointColorState").array[4*e+2]=s[2],a.getAttribute("pointColorState").array[4*e+3]=s[3],a.getAttribute("vState").needsUpdate=!0,a.getAttribute("pointColorState").needsUpdate=!0}))}}for(const n of e.overrideUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const a=t.tileId.get(e.contentId),s=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(n);var o;let l=r.EnumElementState.OVERRIDED;if(o=this._getMaterialByName(s),e.modifyOpacityUserIdSetObject&&e.modifyOpacityUserIdSetObject.has(n)){const t=e.modifyOpacityUserIdSetObject.get(n).opacity;if(o)o=this.getMaterialForModifyOpacityFrom(o,t);else{const e=i.children[0];o=this.getMaterialForModifyOpacityFrom(e.material,t),l=r.EnumElementState.HOVER}}this.model.materialManager.materialMap[s]=o;const d=r.MaterialUtil.getColorParamsByMaterial(o);this.traverseInstanceGeometryMap(i,e,(t=>{for(const i of a.keys())r.Utils.defined(o.map)?this._updateInstanceMaterialByOverrideMateriralMap(t,o,d,l,i,e):(this.updateInstanceGeometry(t,d,l,i,!0),e.meshLevelVisibleMap[t.uuid]=t.visible)}))}));for(const n of e.hoverUserIdSetObject.keys())e.hiddenUserIdSetObject.has(n)||t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);this.traverseInstanceGeometryMap(i,e,(t=>{const i=this.model.sceneState.getHoverMaterial(t.material),a=r.MaterialUtil.getColorParamsByMaterial(i),s=r.EnumElementState.HOVER;for(const i of n.keys())this.updateInstanceGeometry(t,a,s,i,!0),e.meshLevelVisibleMap[t.uuid]=t.visible,this._updateCopyInstanceMeshes(t,a,s,i,e)}))}));for(const n of e.deactivateUserIdSetObject.keys())e.hiddenUserIdSetObject.has(n)||t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);this.traverseInstanceGeometryMap(i,e,(e=>{let t=e.geometry;for(const e of n.keys())t.getAttribute("vState").array[4*e]!==r.EnumElementState.HIDDEN&&(t.getAttribute("vState").array[4*e]=r.EnumElementState.DEACTIVATE,t.getAttribute("vState").needsUpdate=!0)}))}));for(const n of e.blinkUserIdSetObject.keys()){if(e.hiddenUserIdSetObject.has(n))continue;if(e.deactivateUserIdSetObject.has(n))continue;const a=this.model.manager.blinkManager.blinkColorMap[this.model.id]||r.Blink.DefaultBlinkColor.color;void 0===a.w&&(a.w=1),t.getUserIdInstanceInfoCallback(n,(t=>{const s=t.tileId.get(e.contentId);this.traverseInstanceGeometryMap(i,e,(t=>{const i=r.MaterialUtil.getColorParamsByMaterial(t.material);if(a.w>.99&&!0===t.material.transparent||a.w<1&&!1===t.material.transparent){const e=t.geometry;for(const t of s.keys())e.getAttribute("vState").array[4*t]=r.EnumElementState.HIDDEN,e.getAttribute("vState").needsUpdate=!0;return}const o=r.EnumElementState.BLINK;var l=this.getBlinkMaterialName(n,t.name,e.blinkUserIdSetObject.get(n));null==this.blinkMaterials[l]&&(this.blinkMaterials[l]={}),null==this.blinkMaterials[l][t.material.uuid]&&(this.blinkMaterials[l][t.material.uuid]=t.material);for(const r of s.keys())this.updateInstanceGeometry(t,i,o,r,!0),e.meshLevelVisibleMap[t.uuid]=t.visible}))}))}}updateInstanceGeometry(e,t,i,n,a){const s=e.material;let o=e.geometry;const l=t.rgbaColor;let d=4*n;if(0==a&&(d=4*n+1),s.transparent!==t.transparent)return o.getAttribute("vState").array[d]=r.EnumElementState.HIDDEN,void(o.getAttribute("vState").needsUpdate=!0);o.getAttribute("vState").array[d]=i;let h=this._getStateByColorList(l);if(i!==r.EnumElementState.BLINK&&i!==r.EnumElementState.LOCALCLIPPING&&(o.getAttribute("vState").array[d]=i),e.isCopyMesh&&1==a&&(o.getAttribute("vState").array[d+1]=r.EnumElementWireFrameState.NONE),o.getAttribute("vState").needsUpdate=!0,o.getAttribute("pointColorState").array[4*n]=h[0],o.getAttribute("pointColorState").array[4*n+1]=h[1],o.getAttribute("pointColorState").array[4*n+2]=h[2],o.getAttribute("pointColorState").array[4*n+3]=h[3],o.getAttribute("pointColorState").needsUpdate=!0,i==r.EnumElementState.LOCALCLIPPING){if(void 0!==o.getAttribute("vClipping")&&(o.getAttribute("vClipping").array[n]=i),void 0!==o.getAttribute("vClipping")&&(o.getAttribute("vClipping").needsUpdate=!0),s)return this.addInstanceMaterialForClip(s.uuid,s),void this.addInstanceMaterialForClip(s.uuid,s);this.addInstanceMaterialForClip(e.material.uuid,e.material)}!0===a&&(e.visible=!0)}updateInstanceGeometryByNodeInfos(e,t,i,r,n,a,s){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId.get(a);this.traverseInstanceGeometryMap(n,s,(e=>{for(const n of t.keys())this.updateInstanceGeometry(e,i,r,n,!0),s.meshLevelVisibleMap[e.uuid]=e.visible}))}))}_updateInstanceWireFrameMaterial(e,t,i){for(const n of e.hiddenUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);this.traverseInstanceGeometryMap(i,e,(e=>{let t=e.geometry;for(const e of n.keys())t.getAttribute("vState").array[e]=r.EnumElementState.HIDDEN;t.getAttribute("vState").needsUpdate=!0}))}));for(const n of e.hiddenWireFrameUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);this.traverseInstanceGeometryMap(i,e,(e=>{let t=e.geometry;for(const e of n.keys())t.getAttribute("vState").array[e]=r.EnumElementState.HIDDEN;t.getAttribute("vState").needsUpdate=!0}))}));for(const n of e.overrideWireFrameUserIdSetObject.keys()){const a=e.overrideWireFrameUserIdSetObject.get(n),s=this._getMaterialByName(a);if(-1!==a.indexOf("material_modifyOpacity"))continue;const o=r.MaterialUtil.getColorParamsByMaterial(s),l=r.EnumElementState.OVERRIDED;this.updateInstanceWireFrameGeometryByNodeInfos(n,t,i,o,l,e.contentId)}}updateInstanceWireFrameGeometryByNodeInfos(e,t,i,r,n,a){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId.get(a);this.traverseInstanceGeometryMap(i,treeNode,(e=>{for(const i of t.keys())this.updateInstanceGeometry(e,r,n,i),treeNode.meshLevelVisibleMap[e.uuid]=e.visible}))}))}_insertIndexMeshes(e,t,i,n,a){void 0===e.mergedMeshesStates[t]?(e.mergedMeshesStates[t]={},e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a):void 0===e.mergedMeshesStates[t][i]?(e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a):n===r.EnumElementState.LOCALCLIPPING&&(e.mergedMeshesStates[t][i].state=n,e.mergedMeshesStates[t][i].userId=a)}_collectLineMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const n=t.indexId,a=t.meshId;-1!==a.indexOf("line")&&this._insertIndexMeshes(e,a,n,i,r)}))}}_collectLineCategoryMeshState(e,t,i,n){for(let i of e.userIndexMap.keys())meshGroup.traverse((a=>{if("MeshEx"!==a.type&&"LineSegmentsEx"!==a.type)return;if(!a.indexGroups[i])return;const s=a.name;if(-1===s.indexOf("line"))return;if(r.TilesUtil.matchWireFrameVisibilityOption(i,t))return;const o=a.indexGroups[i].stateIndex;this._insertIndexMeshes(e,s,o,n,i)}))}_collectMeshState(e,t,i,r){for(const n of i.keys())t.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t.indexGroups.has(n))return;const i=t.name,a=t.indexGroups.get(n).stateIndex;this._insertIndexMeshes(e,i,a,r,n)}))}_collectMeshState2(e,t,i){for(const r in t)meshGroup.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t.indexGroups[r])return;const n=t.name,a=t.indexGroups[r].stateIndex;this._insertIndexMeshes(e,n,a,i,r)}))}rebuildWireFrameIndices(e,t){for(const i of e.hiddenWireFrameUserIdSetObject.keys())t.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;if(!e.indexGroups.has(i))return;const t=e.indexGroups.get(i),n=t.positionStart/3,a=t.positionEnd/3;this._fillWireFrameState(e,void 0,r.EnumElementWireFrameState.HIDDEN,n,a)}));for(const[i,n]of e.overrideWireFrameUserIdSetObject)t.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;if(!e.indexGroups.has(i))return;const t=e.indexGroups.get(i),a=t.positionStart/3,s=t.positionEnd/3,o=this._getMaterialByName(n),l=this._getStateValue(o);this._fillWireFrameState(e,l,r.EnumElementWireFrameState.OVERRIDED,a,s)}))}rebuildInstanceWireFrameIndices(e,t,i){for(const n of e.hiddenWireFrameUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);i.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(e.enableDynamicInstanceLod()&&!t.insLodLevels[e.realLodLevel])return;const i=r.EnumElementWireFrameState.HIDDEN;for(const a of n.keys()){let n,s=t.geometry;s.getAttribute("vState").array[4*a]!==r.EnumElementState.HIDDEN&&s.getAttribute("vState").array[4*a]!==r.EnumElementState.TRANSPARENT&&(n=r.MaterialUtil.getColorParamsByMaterial(t.material)),n&&(this.updateInstanceGeometry(t,n,i,a,!1),e.meshLevelVisibleMap[t.uuid]=t.visible)}}))}));for(const[n,a]of e.overrideWireFrameUserIdSetObject)t.getUserIdInstanceInfoCallback(n,(t=>{const n=t.tileId.get(e.contentId);i.traverse((t=>{if(!1===t.visible)return;if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;const i=this._getMaterialByName(a),s=r.EnumElementWireFrameState.OVERRIDED,o=r.MaterialUtil.getColorParamsByMaterial(i);for(const i of n.keys()){let n=t.geometry;n.getAttribute("vState").array[4*i]!==r.EnumElementState.HIDDEN&&n.getAttribute("vState").array[4*i]!==r.EnumElementState.TRANSPARENT&&n.getAttribute("vState").array[4*i]!==r.EnumElementState.OVERRIDED&&n.getAttribute("vState").array[4*i]!==r.EnumElementState.HOVER&&(o.transparent=r.MaterialUtil.getColorParamsByMaterial(t.material).transparent,this.updateInstanceGeometry(t,o,s,i,!1),e.meshLevelVisibleMap[t.uuid]=t.visible)}}))}))}rebuildIndices(e,t,i){e.mergedMeshesStates={},this._collectMeshState(e,i,e.hiddenUserIdSetObject,r.EnumElementState.HIDDEN),this._collectLineCategoryMeshState(e,this.model.tilesLoader.wireFrameVisibilityOption,t,r.EnumElementState.HIDDEN),this._collectMeshState(e,i,e.overrideUserIdSetObject,r.EnumElementState.OVERRIDED),this._collectMeshState(e,i,e.transparentUserIdSetObject,r.EnumElementState.TRANSPARENT),this._collectMeshState(e,i,e.hoverUserIdSetObject,r.EnumElementState.HOVER),this._collectMeshState(e,i,e.blinkUserIdSetObject,r.EnumElementState.BLINK),this._collectMeshState(e,i,e.clippingUserIdSetObject,r.EnumElementState.CLIPPING),this._collectMeshState(e,i,e.localClipUserIdSetObject,r.EnumElementState.LOCALCLIPPING),this._collectMeshState(e,i,e.deactivateUserIdSetObject,r.EnumElementState.DEACTIVATE);const n=this.model.sceneState.getHoverMaterial(),a=this._filterImpl.getFrozonMaterialV3(),s=[];s[r.EnumElementState.HOVER]=n,s[r.EnumElementState.TRANSPARENT]=a;for(const t in e.mergedMeshesStates){let r=i.getObjectByName(t);this.rebuildMesh(r,t,e,s)}}_processGrowthAnimation(e,t){return r.Utils.defined(e.material[0].growthAnimationPlanes)&&((t=t.clone()).growthAnimationPlanes=e.material[0].growthAnimationPlanes,t.refreshUniforms()),t}rebuildMesh(e,t,i,n){if(!e)return;let a=(e,t,i,n,a)=>{let s,o=null,l=t,d=0,h=!1;switch(t===r.EnumElementState.OVERRIDED&&n.blinkUserIdSetObject&&n.blinkUserIdSetObject.get(i)&&(t=r.EnumElementState.BLINK),t){case r.EnumElementState.NONE:break;case r.EnumElementState.HOVER:o=this.model.sceneState.getHoverMaterial(e.material[0]),e.material[r.EnumElementState.HOVER]=o;break;case r.EnumElementState.BLINK:const c=n.overrideUserIdSetObject&&n.overrideUserIdSetObject.get(i),u=this._getMaterialByName(c);let p=e.material[0];u&&u.useCompressedNormal&&(p=u,p.defines.CNORMAL="",p.useCompressedNormal=!0),s=this.getBlinkMaterialName(i,e.name,n.blinkUserIdSetObject.get(i)),null==this.blinkMaterials[s]?(this.blinkMaterials[s]={},o=this.model.sceneState.getBlinkMaterialV3(p,this.model.id),this.blinkMaterials[s][s]=o,o.name=s):null==this.blinkMaterials[s][s]?(o=this.model.sceneState.getBlinkMaterialV3(p,this.model.id),this.blinkMaterials[s][s]=o,o.name=s):o=this.blinkMaterials[s][s],n.localClipUserIdSetObject&&n.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o),this.blinkMaterials[s]=o),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)e.material[i]&&s===e.material[i].name&&(h=!0,l=i);if(!1===h){let t=d;d===r.EnumElementState.BLINK+1&&(t=r.EnumElementState.OVERRIDED+1),e.material[t]=o,l=t}break;case r.EnumElementState.OVERRIDED:s=n.overrideUserIdSetObject&&n.overrideUserIdSetObject.get(i);let m=1;if(e.name.indexOf("line")>-1&&n.overrideWireFrameUserIdSetObject&&n.overrideWireFrameUserIdSetObject.get(i)&&(s=n.overrideWireFrameUserIdSetObject.get(i)),-1!==s.indexOf("material_modifyOpacity"))m=n.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(e.material[0],m),!e.material[0].useCompressedColor||"cloudStandardV3"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CCOLOR="",o.useCompressedColor=!0);else{if(o=this._getMaterialByName(s),r.Utils.defined(o.map)){let t=e.material[0].clone();t.vertexColors=!1,t.defines&&(t.defines.USE_MAP=""),t.map=o.map,t.bumpMap=null,t.packingMatMap=null,t.metalness=.5,t.roughness=.5,t.name=o.name,t.transparent=o.transparent,t.alphaMap=o.alphaMap,t.alphaTest=o.alphaTest,o.bindMaterial||(o.bindMaterial=[]),o.bindMaterial.push(t),o=t}n.modifyOpacityUserIdSetObject&&n.modifyOpacityUserIdSetObject.get(i)&&(m=n.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(o,m))}o.srcOpacity=m,this.model.materialManager.materialMap[s]=o,n.localClipUserIdSetObject&&n.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o)),o.side=e.material[0].side,!e.material[0].useCompressedNormal||"cloudStandardV3"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CNORMAL="",o.useCompressedNormal=!0),r.Utils.isDefined(e.material[0].useCompressedUv)&&e.material[0].useCompressedUv&&"cloudStandardV3"===o.type&&(o.uvCenter=e.material[0].uvCenter,o.uvHalfExtent=e.material[0].uvHalfExtent,o.defines.USE_COMPRESS_UV="",o.useCompressedUv=!0),o.needsUpdate=!0,d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)s===e.material[i].name&&(h=!0,l=i);!1===h&&(e.material[d]=o,l=d);break;case r.EnumElementState.LOCALCLIPPING:o=this.getMaterialForClipFrom(e.material[0]),e.material[r.EnumElementState.LOCALCLIPPING]=o;break;case r.EnumElementState.CLIPPING:e.material[r.EnumElementState.CLIPPING]=e.material[0];break;default:a[t]&&(e.material[t]=a[t])}return l};const s=i.mergedMeshesStates[t];let o=e.geometry;let l=0,d=!1;const h=(e=>{let t=[];for(const i of e.keys())t.push({userId:i,indexGroup:e.get(i)});return t.sort(((e,t)=>e.indexGroup.indexStart-t.indexGroup.indexStart)),t})(e.indexGroups),c=h.length;for(const t in s){const n=s[t],a=h[t].indexGroup,l=a.positionStart/3,c=a.positionEnd/3,u=h[t].userId;let p=!1,m=[0,0,0,0];switch(n.state){case r.EnumElementState.HIDDEN:for(let e=l;e<c;++e)o.attributes.vState.array[4*e]=r.EnumElementState.HIDDEN;delete s[t];break;case r.EnumElementState.DEACTIVATE:for(let e=l;e<c;++e)o.attributes.vState.array[4*e]=r.EnumElementState.DEACTIVATE;delete s[t];break;case r.EnumElementState.HOVER:let a=this._getHoverMaterial(e.material[0]);m=this._getStateValue(a),a=this._processGrowthAnimation(e,a),this._fillSecondState(e,a,m,r.EnumElementState.HOVER,l,c,i._content),delete s[t];break;case r.EnumElementState.LOCALCLIPPING:const f=this.getMaterialForClipFrom(e.material[0]);this._fillSecondState(e,f,m,r.EnumElementState.LOCALCLIPPING,l,c,i._content);break;case r.EnumElementState.TRANSPARENT:let g=this._filterImpl.getFrozonMaterialV3(e.material[0].borderLineVisible,e.material[0].side);g.setOutLineColor(e.material[0].outLineColor),m=this._getStateValue(g),g=this._processGrowthAnimation(e,g),this._fillSecondState(e,g,m,r.EnumElementState.TRANSPARENT,l,c,i._content),delete s[t];break;case r.EnumElementState.OVERRIDED:let v=r.EnumElementState.OVERRIDED,y=this._getOverrideSecondMaterial(i,e,n.userId);if(y)m=this._getStateValue(y),i.modifyOpacityUserIdSetObject.has(u)&&(m[3]=255*i.modifyOpacityUserIdSetObject.get(u).opacity);else{v=r.EnumElementState.HOVER;let t=this._getHoverMaterial(e.material[0]);this.hoverMaterial=t,y=t,m[3]=255*i.modifyOpacityUserIdSetObject.get(u).opacity}if(r.Utils.isDefined(y.map)){p=!0;break}if(this._fillSecondState(e,y,m,v,l,c,i._content),i.blinkUserIdSetObject.has(h[t].userId)){s[t].state=r.EnumElementState.BLINK;const n=i.content._copyMeshes;n&&n.getObjectByName(e.name)&&(d=!0)}else p||delete s[t]}}if(o.attributes.vState.needsUpdate=!0,o.attributes.pointColorState.needsUpdate=!0,0===Object.keys(s).length)return;let u=h[0].indexGroup.indexCount,p=r.EnumElementState.NONE;if(o.clearGroups(),s[0]&&s[0].state!==r.EnumElementState.NONE){p=s[0].state;if(p=a(e,p,s[0].userId,i,n),s[0].state===r.EnumElementState.BLINK&&d){i.content._copyMeshes.getObjectByName(e.name).material=e.material[r.EnumElementState.BLINK]}}for(let t=1;t<c;++t){let c=r.EnumElementState.NONE;const m=h[t].userId;if(s[t]){c=s[t].state;const r=a(e,c,m,i,n);if(r===p?u+=h[t].indexGroup.indexCount:(o.addGroup(l,u,p),p=r,l=h[t].indexGroup.indexStart,u=h[t].indexGroup.indexCount),1==d){const t=i.content._copyMeshes.getObjectByName(e.name);e.material[c].transparent=t.material.transparent,t.material=e.material[c]}}else p===r.EnumElementState.NONE?u+=h[t].indexGroup.indexCount:(o.addGroup(l,u,p),p=r.EnumElementState.NONE,a(e,p,m,i,n),l=h[t].indexGroup.indexStart,u=h[t].indexGroup.indexCount)}if(u>0&&p!==r.EnumElementState.HIDDEN){const t=a(e,p,h[c-1].userId,i,n);o.addGroup(l,u,t)}}_getStateByColorList(e){return[255*e[0],255*e[1],255*e[2],255*e[3]]}_getStateValue(e){const t=e.color,i=e.opacity;return[255*t.r,255*t.g,255*t.b,255*i]}_getHoverStateValue(e){const t=e.opacity;return 256*parseInt(255*t)+3}_getTransparentStateValue(e){const t=e.color;return parseInt(256*t.getHex()+r.EnumElementState.TRANSPARENT)}_getHoverMaterial(e){const t=e.clone();return t.opacity=r.MaterialUtil.getHoverOpacity(t.opacity),t.transparent=!0,t}_getMaterialByName(e){return"frozen"==e?this._filterImpl.getFrozonMaterialV3():super._getMaterialByName(e)}_getOverrideSecondMaterial(e,t,i){let n=null;const a=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(i);return t.name.indexOf("line")>-1&&e.overrideWireFrameUserIdSetObject&&e.overrideWireFrameUserIdSetObject.get(i)&&(a=e.overrideWireFrameUserIdSetObject.get(i)),n=this._getMaterialByName(a),n?(n.srcOpacity=1,this.model.materialManager.materialMap[a]=n,r.Utils.defined(t.material[0].growthAnimationPlanes)&&(n.growthAnimationPlanes=t.material[0].growthAnimationPlanes,n.refreshUniforms(),n.needsUpdate=!0),e.localClipUserIdSetObject&&e.localClipUserIdSetObject.get(i)&&(n=this.getMaterialForClipFrom(n)),n):null}_updateInstanceMaterialByOverrideMateriralMap(e,t,i,n,a,s){const o=i.rgbaColor,l=e.material;let d=e.geometry,h=d.getAttribute("vState").array[4*a];if(h===r.EnumElementState.HIDDEN||h===r.EnumElementState.TRANSPARENT)return;if(e.isCopyMesh)return;let c;this._getStateByColorList(o);d.getAttribute("vState").array[4*a]=-1,d.getAttribute("vState").needsUpdate=!0;const u=s._content.getCopyMeshes(t.name);c=u.getObjectByName(e.name),r.Utils.defined(c)||(c=this.cloneInstanceMeshFrom(e,t),c.isInstanceMeshNode=!0,c.indexCount=e.indexCount,c.indexGroups=e.indexGroups,c.insLodLevel=e.insLodLevel,l.growthAnimationMap&&(c.material.growthAnimationMap=l.growthAnimationMap),l.growthAnimationMapSizeWidth&&(c.material.growthAnimationMapSizeWidth=l.growthAnimationMapSizeWidth),l.growthAnimationMapSizeHeight&&(c.material.growthAnimationMapSizeHeight=l.growthAnimationMapSizeHeight),l.growthAnimationPlanes&&(c.material.growthAnimationPlanes=l.growthAnimationPlanes),c.material.refreshUniforms(),r.Utils.defined(e.cloneMesh)||(e.cloneMesh=[]),e.cloneMesh.push(c),s.meshLevelVisibleMap[c.uuid]=!0,u.add(c),u.updateMatrixWorld(!0)),s._content._instanceCopyMeshes[e.name]=t.name,c.visible=!0,d=c.geometry,d.getAttribute("vState").array[4*a]=0,d.getAttribute("vState").needsUpdate=!0,d.getAttribute("pointColorState").array[4*a+0]=255,d.getAttribute("pointColorState").array[4*a+1]=0,d.getAttribute("pointColorState").array[4*a+2]=255,d.getAttribute("pointColorState").array[4*a+3]=255,d.attributes.pointColorState.needsUpdate=!0,d=e.geometry,d.getAttribute("vState").array[4*a]=-1,d.getAttribute("vState").needsUpdate=!0,e.visible=!0}_dealHideUserIndexWithOverride(e,t,i,n){const a=n._content.getCopyMeshes(t.name);if(copyMesh=a.getObjectByName(e.name),!r.Utils.defined(copyMesh))return;const s=copyMesh.geometry;s.getAttribute("vState").array[4*i]=r.EnumElementState.HIDDEN,s.getAttribute("vState").needsUpdate=!0}_updateCopyInstanceMeshes(e,t,i,r,n){const a=n._content._instanceCopyMeshes[e.name];if(a){const e=n._content.getCopyMeshes(a).getObjectByName(mesh.name);if(e){const n=e.geometry;n.getAttribute("vState").array[4*r]=i,n.getAttribute("vState").needsUpdate=!0,n.getAttribute("pointColorState").array[4*r+0]=t[0],n.getAttribute("pointColorState").array[4*r+1]=t[1],n.getAttribute("pointColorState").array[4*r+2]=t[2],n.getAttribute("pointColorState").array[4*r+3]=t[3],n.getAttribute("pointColorState").needsUpdate=!0}}}_fillSecondState(e,t,i,n,a,s,o){if(e.material[0].transparent===t.transparent){for(let t=a;t<s;++t)e.geometry.attributes.vState.array[4*t]=n,e.geometry.attributes.pointColorState.array[4*t]=i[0],e.geometry.attributes.pointColorState.array[4*t+1]=i[1],e.geometry.attributes.pointColorState.array[4*t+2]=i[2],e.geometry.attributes.pointColorState.array[4*t+3]=i[3];return}const l=o.getCopyMeshes();let d=l.getObjectByName(e.name);r.Utils.defined(d)||(d=this.cloneMeshFrom(e,t),l.add(d),l.updateMatrixWorld(!0));for(let t=a;t<s;++t)e.geometry.attributes.vState.array[4*t]=r.EnumElementState.HIDDEN,d.geometry.attributes.vState.array[4*t]=n,d.geometry.attributes.vState.array[4*t+1]=e.geometry.attributes.vState.array[4*t+1],d.geometry.attributes.pointColorState.array[4*t]=i[0],d.geometry.attributes.pointColorState.array[4*t+1]=i[1],d.geometry.attributes.pointColorState.array[4*t+2]=i[2],d.geometry.attributes.pointColorState.array[4*t+3]=i[3];e.geometry.attributes.vState.needsUpdate=!0,d.geometry.attributes.pointColorState.needsUpdate=!0,d.geometry.attributes.vState.needsUpdate=!0}_fillWireFrameState(e,t,i,n,a){for(let s=n;s<a;++s)if(e.geometry.attributes.vState.array[4*s]!==r.EnumElementState.HIDDEN&&e.geometry.attributes.vState.array[4*s]!==r.EnumElementState.TRANSPARENT)if(e.geometry.attributes.vState.array[4*s]===r.EnumElementState.OVERRIDED||e.geometry.attributes.vState.array[4*s]===r.EnumElementState.HOVER){if(i===r.EnumElementWireFrameState.OVERRIDED)continue}else e.geometry.attributes.vState.array[4*s+1]=i,t&&(e.geometry.attributes.pointColorState.array[4*s]=t[0],e.geometry.attributes.pointColorState.array[4*s+1]=t[1],e.geometry.attributes.pointColorState.array[4*s+2]=t[2],e.geometry.attributes.pointColorState.array[4*s+3]=t[3]);e.geometry.attributes.pointColorState.needsUpdate=!0,e.geometry.attributes.vState.needsUpdate=!0}cloneInstanceMeshFrom(e,t){const i=e.geometry;let n=new THREE.InstancedBufferGeometry;n=i.clone(),n.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.getAttribute("vState").array.length).fill(-1),4));const a=(e.material instanceof Array?e.material[0]:e.material).clone();a.vertexColors=!1,a.defines.USE_MAP="",a.map=t.map,a.transparent=t.transparent,a.alphaMap=t.alphaMap,a.alphaTest=t.alphaTest,a.bumpMap=null,a.packingMatMap=null,a.metalness=.5,a.roughness=.5,a.name=t.name,a.growthAnimationPlanes=t.growthAnimationPlanes,a.growthAnimationMap=t.growthAnimationMap,a.growthAnimationMapSizeWidth=t.growthAnimationMapSizeWidth,a.growthAnimationMapSizeHeight=t.growthAnimationMapSizeHeight,t.bindMaterial||(t.bindMaterial=[]),t.bindMaterial.push(a),a.refreshUniforms();const s="LineSegmentsEx"===e.type?new r.LineSegmentsEx(n,a):new r.MeshEx(n,a);return s.databagId=e.databagId,s.fileId=e.fileId,s.name=e.name,s.frustumCulled=e.frustumCulled,s.castShadow=!1===a.transparent&&this.model.castShadow,s.receiveShadow=this.model.receiveShadow,s.customDepthMaterial=e.customDepthMaterial,s.matrixRoot=e.matrixRoot,e.isMeshQuantization&&(s.isMeshQuantization=e.isMeshQuantization),e.matrix&&(s.matrix=e.matrix,s.matrixAutoUpdate=!1,s.updateMatrixWorld()),s.sourceMesh=e,s}cloneMeshFrom(e,t){const i=e.geometry,n=new THREE.BufferGeometry;n.setAttribute("position",i.getAttribute("position")),n.setAttribute("id",i.getAttribute("id"));const a=new Float32Array(e.geometry.attributes.vState.array.length).fill(r.EnumElementState.HIDDEN),s=new THREE.Float32BufferAttribute(a,4);s.normalized=!1,n.setAttribute("vState",s);const o=new Uint8Array(e.geometry.attributes.pointColorState.array.length).fill(r.EnumElementState.NONE),l=new THREE.Uint8BufferAttribute(o,4);l.normalized=!0,n.setAttribute("pointColorState",l),i.getAttribute("cNormal")&&n.setAttribute("cNormal",i.getAttribute("cNormal")),i.getAttribute("color")&&n.setAttribute("color",i.getAttribute("color")),i.getAttribute("uv")&&n.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&n.setAttribute("uv2",i.getAttribute("uv2")),i.getAttribute("uv3")&&n.setAttribute("uv3",i.getAttribute("uv3")),i.getAttribute("barycentric")&&n.setAttribute("barycentric",i.getAttribute("barycentric")),i.getAttribute("growthPlaneIndex")&&n.setAttribute("growthPlaneIndex",i.getAttribute("growthPlaneIndex")),n.setIndex(i.getIndex());const d=e.material instanceof Array?e.material[0]:e.material,h=this.model.materialManager.createNewMaterialFrom(d);h.transparent=t.transparent,h.growthAnimationPlanes=t.growthAnimationPlanes,t.defines&&t.defines.CLOUDSTANDARDBATCHEDV3&&(h.defines||(h.defines={}),h.defines.CLOUDSTANDARDBATCHEDV3="");const c="LineSegmentsEx"===e.type?new r.LineSegmentsEx(n,h):new r.MeshEx(n,h);return"frozen"===t.name&&(c.material=t),c.databagId=e.databagId,c.fileId=e.fileId,c.name=e.name,c.frustumCulled=e.frustumCulled,c.castShadow=!1===h.transparent&&this.model.castShadow,c.receiveShadow=this.model.receiveShadow,c.customDepthMaterial=e.customDepthMaterial,c.matrixRoot=e.matrixRoot,e.isMeshQuantization&&(c.isMeshQuantization=e.isMeshQuantization),e.matrix&&(c.matrix=e.matrix,c.matrixAutoUpdate=!1,c.updateMatrixWorld()),c.sourceMesh=e,r.Utils.defined(e.cloneMesh)||(e.cloneMesh=[]),e.cloneMesh.push(c),c}_collectWireFrameFilteredUserIds(e,t,i){const n=this._hasOverrideMaterialFilterForWireFrame(),a=this.model.tilesLoader.wireFrameVisibilityOption,s=!0!==a;if(e.hiddenUserIdSetObject||(e.hiddenUserIdSetObject=new Map),e.localClipUserIdSetObject||(e.localClipUserIdSetObject=new Map),e.overrideUserIdSetObject||(e.overrideUserIdSetObject=new Map),e.hiddenWireFrameUserIdSetObject=new Map,e.overrideWireFrameUserIdSetObject=new Map,!n&&!s)return!1;for(const i of t.keys()){if(e.hiddenUserIdSetObject.has(i)||e.localClipUserIdSetObject.has(i)||e.overrideUserIdSetObject.has(i))continue;if(!this._hasOverrideMaterialForWireFrame({name:i}))continue;const t=this._getOverrideMaterialForWireFrame({name:i});e.overrideWireFrameUserIdSetObject.set(i,t.name)}for(const i of t.keys())e.hiddenUserIdSetObject.has(i)||e.localClipUserIdSetObject.has(i)||r.TilesUtil.matchWireFrameVisibilityOption(i,a)||e.hiddenWireFrameUserIdSetObject.set(i,!0);return!0}_collectFilteredUserIds(e,t,i){const n=this._hasHiddenFileIdFilter(),a=this._hasVisibleFilter()||this.model.hasHiddenSourceObjectUserId(),s=this._hasOverrideMaterialFilter(),o=this._hasTransparentFilter(),l=e.blinkUserIdSetObject.size>0,d=e.clippingUserIdSetObject.size>0,h=this._hasLocalClipping(),c=this._hasModifyOpacityList();let u=this.mapMaterialIdToUserIdsForFilter={};if(e.hiddenUserIdSetObject=new Map,e.overrideUserIdSetObject=new Map,e.transparentUserIdSetObject=new Map,n||a||s||o||l||h||c||d)for(const d of t.keys())i.getUserIdInfoCallback(d,(t=>{if(n&&this._isHiddenFileId(t)||a&&!1===this._isVisible(t)||this.model.isHiddenSourceObjectUserId(d))return void 0===u[t.materialId]&&(u[t.materialId]={}),void 0===u[t.materialId][r.EnumElementState.HIDDEN]&&(u[t.materialId][r.EnumElementState.HIDDEN]={}),u[t.materialId][r.EnumElementState.HIDDEN][d]=!0,void e.hiddenUserIdSetObject.set(d,!0);if(h&&e.localClipUserIdSetObject.has(d)&&(void 0===u[t.materialId]&&(u[t.materialId]={}),void 0===u[t.materialId][r.EnumElementState.LOCALCLIPPING]&&(u[t.materialId][r.EnumElementState.LOCALCLIPPING]={}),u[t.materialId][r.EnumElementState.LOCALCLIPPING][d]=!0),o&&this._isTransparent(t))return void 0===u[t.materialId]&&(u[t.materialId]={}),void 0===u[t.materialId][r.EnumElementState.TRANSPARENT]&&(u[t.materialId][r.EnumElementState.TRANSPARENT]={}),u[t.materialId][r.EnumElementState.TRANSPARENT][d]=!0,void e.transparentUserIdSetObject.set(d,!0);if(l&&e.blinkUserIdSetObject.has(d)&&(void 0===u[t.materialId]&&(u[t.materialId]={}),void 0===u[t.materialId][r.EnumElementState.BLINK]&&(u[t.materialId][r.EnumElementState.BLINK]={}),u[t.materialId][r.EnumElementState.BLINK][d]=!0),s&&this._hasOverrideMaterial(t)){var i=this._getOverrideMaterial(t);""!==(p=null!=i?i.name:"")&&(void 0===u[t.materialId]&&(u[t.materialId]={}),void 0===u[t.materialId][r.EnumElementState.OVERRIDED]&&(u[t.materialId][r.EnumElementState.OVERRIDED]={}),u[t.materialId][r.EnumElementState.OVERRIDED][d]=p,e.overrideUserIdSetObject.set(d,p))}else if(c&&e.modifyOpacityUserIdSetObject.has(d)){var p=`material_modifyOpacity_${e.modifyOpacityUserIdSetObject.get(d).opacity}`;e.overrideUserIdSetObject.set(d,p)}else;}))}_dealHideUserIndex(e,t,i,n,a){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId.get(n);let s=i.children[0],o=i.children[1];if(a.enableDynamicInstanceLod()){const e=a.content.getLodVisibleMeshList();s=e[0],o=e[1]}let l=s.geometry,d=o.geometry;for(const e of t.keys())l.getAttribute("vState").array[4*e]=r.EnumElementState.HIDDEN,l.getAttribute("vState").needsUpdate=!0,d.getAttribute("vState"),d.getAttribute("vState").array[4*e]=r.EnumElementState.HIDDEN,d.getAttribute("vState").needsUpdate=!0}))}_updateInstanceDemandMaterial(e,t,i){const r=this.model.onDemandManager.idMap;for(let n of t.keys())r[n]||this._dealHideUserIndex(n,i,meshGroup,e.contentId,e)}_canChangeAllMeshGroup(e,t,i,n){if(e.isHideByFilter=!1,e.isTransparentByFilter=!1,t.visible=!0,t.isHideByFilterForce=!1,e.hiddenUserIdSetObject.size===i.size)return t.visible=!1,t.isHideByFilterForce=!0,e.isHideByFilter=!0,e._content.clearCopyMeshes(),!0;if(e.transparentUserIdSetObject.size===i.size&&!1===n){e.isTransparentByFilter=!0;return t.children.map((t=>{const i=this._filterImpl.getFrozonMaterialV3(t.material[0].borderLineVisible,t.material[0].side);i.setOutLineColor(t.material[0].outLineColor);const n=this._getStateValue(i),a=t.geometry.attributes.vState.count;this._fillSecondState(t,i,n,r.EnumElementState.TRANSPARENT,0,a,e._content),!1!==t.material[0].transparent?(t.geometry.attributes.pointColorState.needsUpdate=!0,t.geometry.attributes.vState.needsUpdate=!0):t.visible=!1})),!0}if(e.transparentUserIdSetObject.size===i.size&&!0===n){e.isTransparentByFilter=!0;return t.children.map((t=>{if(e.enableDynamicInstanceLod()&&!t.insLodLevels[e.realLodLevel])return;if(!1===t.material.transparent)return t.visible=!1,void(e.meshLevelVisibleMap[t.uuid]=!1);t.visible=!0,e.meshLevelVisibleMap[t.uuid]=!0;const i=this._filterImpl.getFrozonMaterialV3(t.material.borderLineVisible),n=this._getStateValue(i),a=t.geometry.attributes.vState.count;for(let e=0;e<a;e++)t.geometry.getAttribute("vState").array[4*e]=r.EnumElementState.TRANSPARENT,t.geometry.getAttribute("vState").array[4*e+1]=r.EnumElementWireFrameState.NONE,t.geometry.getAttribute("pointColorState").array[4*e]=n[0],t.geometry.getAttribute("pointColorState").array[4*e+1]=n[1],t.geometry.getAttribute("pointColorState").array[4*e+2]=n[2],t.geometry.getAttribute("pointColorState").array[4*e+3]=n[3];t.geometry.attributes.pointColorState.needsUpdate=!0,t.geometry.attributes.vState.needsUpdate=!0})),!0}}}r.BimTileFilterManagerV3=e}(),r.BimTileUserIdInfoV3=class{constructor(){this._userId=void 0,this._userData=void 0,this._boundingBox=null,this._instanceOrNot=!1,this._tileId=new Map,this._lineId=void 0,this._parent=void 0,this._materialId=void 0,this._type=void 0,this._state=r.EnumObjectState.Visible,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}destroy(){this._userId=void 0,this._userData=void 0,this._boundingBox=null,this._instanceOrNot=void 0,this._lineId=void 0,this._tileId=null,this._parent=void 0,this._materialId=void 0,this._state=void 0,this._explodeMatrix=void 0,this._type=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}clone(){return{index:this.index,userId:this.userId,boundingBox:this.boundingBox,instanceOrNot:this.instanceOrNot,matrix:this.matrix}}get state(){return this._state}set state(e){this._state=e}get name(){return this._userId}set name(e){this._userId=e}get userId(){return this._userId}set userId(e){this._userId=e}get tileId(){return this._tileId}addTileNodeId(e,t){this._tileId.has(e)||this._tileId.set(e,new Map),this._tileId.get(e).set(t,!0)}addTileIndexMatrix(e,t,i){this._tileId.has(e)||this._tileId.set(e,new Map),this._tileId.get(e).set(t,i)}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}get instanceOrNot(){return this._instanceOrNot}set instanceOrNot(e){this._instanceOrNot=e}get userData(){return this._userData}set userData(e){this._userData=e}get lineId(){return`outline_${this._tileId}`}get parent(){return this._parent}set parent(e){this._parent=e}get type(){return this._type}set type(e){this._type=e}get materialId(){return this._materialId}set materialId(e){this._materialId=e}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}get explodeMatrix(){return this._explodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get material(){return this._material}set material(e){this._material=e}},r.BimTileUserIDBoxTool=class{constructor(){this.globalUserIdBoxUrls={},this.globalUserIdBoxBuffers=[],this.userIdBoxMap={},this.userIdChangedBoxMap={},this.userIdDrawingBoxMap={},this.modelMatrix=new THREE.Matrix4}destroy(){this.globalUserIdBoxUrls=null,this.globalUserIdBoxBuffers=null,this.userIdBoxMap=null,this.userIdDrawingBoxMap=null,this.userIdChangedBoxMap=null,this.modelMatrix=null}addGlobalUserIdBoxUrl(e,t){this.globalUserIdBoxUrls[e]=t}getGlobalUserIdBoxUrls(){return Object.keys(this.globalUserIdBoxUrls)}parseUserIdBoxBuffer(e,t){const i=this.globalUserIdBoxUrls[t];e.getBoxList().map(((e,t)=>{this.userIdBoxMap[i+t]=r.TilesUtil.getBox(e.getBboxList())})),e=null}getUserIdBoxByIndex(e){return this.userIdBoxMap[e]}setChangedUserIdBoxByIndex(e,t){this.userIdChangedBoxMap[e]=t}getChangedUserIdBoxByIndex(e){return this.userIdChangedBoxMap[e]}getUserIdDrawingBoxByIndex(e,t){const i=t.manager.scene.getRawMatrixGlobal();if(!r.Math.equalsEpsilonMatrix4(this.modelMatrix,t.transformMatrix,1e-4)){this.modelMatrix.copy(t.transformMatrix);for(let t in this.userIdDrawingBoxMap)this.userIdDrawingBoxMap[t].copy(this.userIdBoxMap[e]),this.userIdDrawingBoxMap[t].applyMatrix4(this.modelMatrix).applyMatrix4(i)}return this.userIdDrawingBoxMap[e]||(this.userIdDrawingBoxMap[e]=this.userIdBoxMap[e].clone(),this.userIdDrawingBoxMap[e].applyMatrix4(this.modelMatrix).applyMatrix4(i)),this.userIdDrawingBoxMap[e]}},function(){class e extends r.BimTileInstanceMeshBlobParser{constructor(e){super(e)}parse(e,t){if(!t||!t.buffer)return;const i=this._getBufferInfo(e,t);if(!i)return;const r=i.meshBlob.getNodesList();if(!r.length)return;this._traverseScenes(r,i);const n=this;return new Promise(((e,t)=>{Promise.all(n._parsePromiseArray).then((()=>{n._parsePromiseArray=null,e()})).catch((()=>{n._parsePromiseArray=null,t("some error when paser mesh block "+i.bufferId)}))}))}_traverseScenes(e,t){let i=0;e.forEach((e=>{let r=new THREE.Matrix4;16==e.getMatrixList().length&&r.fromArray(e.getMatrixList());const n={};n.nodeIndex=i++,n.matrix=r,n.sceneName="sceneName",n.quantizebits=e.getQuantizebitsList?e.getQuantizebitsList():void 0,n.isCompressedMode=this._isCompressedBufferMode(t.buffer),this._parseBufferNode(e,n,t)}))}_getBufferInfo(e,t){const i=t.meshBlob.content,r=i.getBlobHeader(),n=r.getBufferBlockId(),a=t.buffer.content;if(!a)return null;const s=this._getBufferData(a);let o={};return o.contentIndex=t.contentIndex,o.meshBlob=i,o.buffer=a,o.bufferData=s,o.bufferId=`${r.getTileId()}_${n}`,o.loader=e,o.node=t,o.renderInstance=!this._renderDirectly,o}_resetMeshBuffer(e){const t=e.meshBlob.getBlobHeader(),i=(t.getBufferBlockId(),t.getMaterialBlockId()),r=t.getUserdataBlockId(),n=e.node.buffer.content,a=-1===i?e.loader.tileReader.globalMaterialBuffer:e.node.materialBuffer.content;e.buffer=n,e.materialBlockId=i,e.material=a,e.userdataBlockId=r,n&&(e.bufferData=this._getBufferData(n))}_isCompressedBufferMode(e){if(e&&e.getBlobHeader){const t=e.getBlobHeader();if(t.getTotalVertexNum&&t.getTotalVertexNum()>0)return!0}return!1}}r.BimTileInstanceMeshBlobParserV3=e}(),r.BimtileDescriptorV3=class{constructor(){this.userIdInfoMap=new Map,this.userIdInstanceInfoMap=new Map,this.tileUserIdMap=new Map,this.cacheExplodeMatrixMap=new Map,this.cacheUserIdStateMap={},this.maxUserIDIndex=0,this.onNodeInfoChangedCallback=[]}destroy(){this.tileUserIdMap.clear(),this.tileUserIdMap=null,this.userIdInfoMap.clear(),this.userIdInstanceInfoMap.clear(),this.cacheExplodeMatrixMap.clear(),this.userIdInfoMap=null,this.userIdInstanceInfoMap=null,this.cacheExplodeMatrixMap=null,this.cacheUserIdStateMap=null,this.onNodeInfoChangedCallback=[]}hasNodeInfo(){return this.userIdInfoMap.size>0||this.userIdInstanceInfoMap.size>0}addOnNodeInfoChanged(e){this.onNodeInfoChangedCallback.push(e)}removeOnNodeInfoChanged(e){for(let t=0;t<this.onNodeInfoChangedCallback.length;++t)if(this.onNodeInfoChangedCallback[t]===e){this.onNodeInfoChangedCallback.splice(t,1);break}}onNodeInfoChanged(e,t,i){for(let r=0;r<this.onNodeInfoChangedCallback.length;++r)this.onNodeInfoChangedCallback[r](this,e,t,i)}patchMeshNodeInfo(e,t,i,n){if(this.userIdInfoMap.has(i))this.userIdInfoMap.get(i).addTileNodeId(t,e);else{const a=new r.BimTileUserIdInfoV3;if(a.addTileNodeId(t,e),a.userId=i,a.materialId=n,this.userIdInfoMap.set(i,a),this.cacheExplodeMatrixMap.get(i)&&(a.explodeMatrix=this.cacheExplodeMatrixMap.get(i),this.cacheExplodeMatrixMap.delete(i)),r.Utils.isDefined(this.cacheUserIdStateMap[i]))for(const e in this.cacheUserIdStateMap[i])a[e]=this.cacheUserIdStateMap[i][e]}this.tileUserIdMap.has(t)||this.tileUserIdMap.set(t,new Map),this.tileUserIdMap.get(t).set(i,!0)}patchInstanceNodeInfo(e,t,i,n){if(this.userIdInstanceInfoMap.has(e))this.userIdInstanceInfoMap.get(e).addTileIndexMatrix(n,i.instanceIndex,i.entityMatrix.clone());else{const t=new r.BimTileUserIdInfoV3;if(t.instanceOrNot=!0,t.addTileIndexMatrix(n,i.instanceIndex,i.entityMatrix.clone()),t.userId=e,this.userIdInstanceInfoMap.set(e,t),this.cacheExplodeMatrixMap.has(e)&&(t.explodeMatrix=this.cacheExplodeMatrixMap.get(e),this.cacheExplodeMatrixMap.delete(e)),r.Utils.isDefined(this.cacheUserIdStateMap[e]))for(const i in this.cacheUserIdStateMap[e])t[i]=this.cacheUserIdStateMap[e][i]}this.tileUserIdMap.has(n)||this.tileUserIdMap.set(n,new Map),this.tileUserIdMap.get(n).set(e,!0)}isUserIdExist(e){return r.Utils.defined(e)&&(this.userIdInfoMap.get(e)||this.userIdInstanceInfoMap.get(e)||e<=this.maxUserIDIndex)}getAllNodeInfos(){return[this.userIdInfoMap,this.userIdInstanceInfoMap]}getUserIdInfoByUserId(e){const t=[];return this.userIdInfoMap.has(e)&&t.push(this.userIdInfoMap.get(e)),this.userIdInstanceInfoMap.has(e)&&t.push(this.userIdInstanceInfoMap.get(e)),t}getBatchedUserIds(){let e=[];for(const t of this.userIdInfoMap.keys())this.userIdInstanceInfoMap.has(t)||e.push(t);return e}getInstanceUserIds(){let e=[];for(const t of this.userIdInstanceInfoMap.keys())this.userIdInfoMap.has(t)||e.push(t);return e}getUserIdBatchedInfoCallback(e,t){this.userIdInfoMap.get(e)&&t&&t(this.userIdInfoMap.get(e))}getAllUserIdBatchedInfoCallback(e){for(const t of this.userIdInfoMap.keys())e&&e(this.userIdInfoMap.get(t))}getUserIdInstanceInfoCallback(e,t){this.userIdInstanceInfoMap.get(e)&&t&&t(this.userIdInstanceInfoMap.get(e))}getAllUserIdInstanceInfoCallback(e){for(const t of this.userIdInstanceInfoMap.keys())e&&e(this.userIdInstanceInfoMap.get(t))}getUserIdInfoCallback(e,t){this.getUserIdBatchedInfoCallback(e,t),this.getUserIdInstanceInfoCallback(e,t)}getAllUserIdInfoCallback(e){this.getAllUserIdBatchedInfoCallback(e),this.getAllUserIdInstanceInfoCallback(e)}getInstanceMatrixListByUserIdAndTileId(e,t){let i=[];const r=this.userIdInstanceInfoMap.get(e);return r&&r.tileId.get(t)&&(i=[...r.tileId.get(t).values()]),i}patchExplodeMatrix(e,t){this.cacheExplodeMatrixMap.set(e,t)}patchUserIdState(e){return this.cacheUserIdStateMap[e]||(this.cacheUserIdStateMap[e]={userId:e,material:null,wireFrameMaterial:null,state:r.EnumObjectState.Visible}),this.cacheUserIdStateMap[e]}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.userIdInfoMap.get(i);if(r){const e=r.tileId;for(const[i,n]of e)for(const e of n.keys()){const n={instanceOrNot:!1,meshId:`${i}_${e}`,nodeInfo:r};t&&t(n)}}}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.userIdInstanceInfoMap.get(i);if(r){const e=r.tileId;for(const[i,n]of e)for(const[e,a]of n){const n={instanceOrNot:!0};n.meshId=`${i}_0`,n.matrix=a,n.index=e,n.nodeInfo=r,t&&t(n)}}}getUserTileIdMap(e,t){let i=this.userIdInfoMap.get(e);if(i)for(const e of i.tileId.keys())t[e]=null;if(i=this.userIdInstanceInfoMap.get(e),i)for(const e of i.tileId.keys())t[e]=null}updateMaxUserIDIndex(e){e>this.maxUserIDIndex&&(this.maxUserIDIndex=e)}},function(){class e extends r.BimTileInstanceParser{constructor(e){super(e),this._sharedInstanceManager=new r.SharedInstanceManager}destroy(){this._sharedInstanceManager.destroy(),this._sharedInstanceManager=void 0,super.destroy()}parseBlobs(e,t,i){t.isInstanceTile=!0,t.userIndexMap=new Map;proto.BlockHeader.BlockType.BT_INSTANCE;const r=t.buffer.content;r&&(r instanceof proto.bimtile_pbf_v3.InstanceBlobs?this.parseBlob(e,r,t,i):super.parseBlob(e,r,t,i))}parseBlob(e,t,i,n){if(!t)return;const a=t.getInsBlobsList()[i.blobId],s=a.getBlobHeader();let o=r.Utils.isDefined(i.contentInsModel)?i.contentInsModel:s.getEntityUrl();if(r.Utils.isDefined(i.insLodLevel)){o=i._tileset.instanceLodMeshPool.getLodMeshInfoRecursive(i.instanceId,i.insLodLevel).modelUrl}let l=-1==s.getTileId()?i.contentId:s.getTileId();i.contentId2=i.contentId,i.contentId=l,i.tileId=l,i.content&&i.content.meshes&&(i.content.meshes.tileId=l);const d=`${i.contentId}_${s.getBlockId()}`,h=this._parseInstanceBlob(e,i,a,d),c={entityID:o,entityInfoArray:h.entityInfoArray};i.instanceInfo=c,i.entityInfos=h,h.curInsLodLevel=i.insLodLevel,h.entityID=o,this._parseInstanceMeshBlob(o,h,i,d,e,n)}createInstanceMeshBlobParser(e){return new r.BimTileInstanceMeshBlobParserV3(e)}getSharedInstanceManager(){return this._sharedInstanceManager}}r.BimTileInstanceParserV3=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){super(e),this.loader=e.loader}destroy(){}parseBlobs(e,t,i){const r=t.meshBlob&&t.meshBlob.content;if(!r)return;t._parsePromiseArray=[],this.parseNodes(r,t,i);new Promise(((e,i)=>{Promise.all(t._parsePromiseArray).then((()=>{t._parsePromiseArray=null,t.meshBlob=null,t.buffer=null,e()})).catch((()=>{t._parsePromiseArray=null,i("some error when paser tile "+t._contentIndex)}))})).then((()=>{t.content&&(this.getUserIdInfo(r,t.content.meshes),i&&i(t))}))}parseNodes(e,t,i){const r=e.getNodesList();for(let n=0;n<r.length;++n)this.parseNode(r[n],n,e,t,i)}parseNode(e,t,i,n,a){const s=this.getTileId(n,i.getBlobHeader());let o=new THREE.Matrix4;if(16==e.getMatrixList().length){o.fromArray(e.getMatrixList());let t=e.getTranslationList();r.Utils.isDefined(t)&&3===t.length&&o.setPosition(t[0],t[1],t[2])}const l=o.clone().premultiply(n.matrix),d=e.getPrimitivesList(),h=d.length,c=e.getNodeType(),u=e.getUvboxList(),p=e.getQuantizebitsList?e.getQuantizebitsList():void 0;let m=null,f=null;if(u.length>=4&&(m=new THREE.Vector2(0,0),f=new THREE.Vector2(0,0),m.x=(u[0]+u[1])/2,m.y=(u[2]+u[3])/2,f.x=(u[1]-u[0])/2,f.y=(u[3]-u[2])/2),c!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE)for(let t=0;t<h;t++){const r=d[t],a=i.getPrimitivesList()[r];a.matrix=l,a.matrixRoot=o,a.tileId=s,a.nodeIndex=e.getNodeid(),a.nodeIndexId=`${s}_${a.nodeIndex}`,a.lineTileId=`${s}_${a.nodeIndex}`,a.uvCenter=m,a.uvHalfExtent=f,a.quantizebits=p,this.createMesh(a,i,n)}}createMesh(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return void console.warn("invalid acc info");const r=this.createGeometryByPrimitive(e,t,i);let n=i.materialBuffer&&i.materialBuffer.content;n||(n=this.loader.tileReader.getBuffer(i,-1,proto.BlockHeader.BlockType.BT_MATERIAL));let a=new Promise((t=>{this.materialManager.getMaterial(this.loader,{materialBlockId:-1,bufferData:this._getBufferData(i.buffer.content),material:n},e,(e=>{t(e)}))}));a.then((t=>{this.createMeshNode(e,i,r,t)})),i._parsePromiseArray.push(a)}createGeometryByPrimitive(e,t,i){const n=i.buffer.content,a=this._getBufferData(n);let s=new THREE.BufferGeometry;const o={},l=this._getUserIds(t,a,o,e),d=this._getNormal(t,a,o,e),h=this._getVertex(t,a,o,e),c=this._getIndex(t,a,o,e),u=this._getTextureCoord(t,a,o,e),p=this._getColor(t,a,o,e),m=this._getBarycentric(t,a,o,e);s.setAttribute("position",h.vertexBufferAttribute),s.setIndex(c.indexBufferAttribute),l.normalized=!0,s.setAttribute("id",l);const f=new Float32Array(4*l.count).fill(r.EnumElementState.NONE),g=new THREE.Float32BufferAttribute(f,4);g.normalized=!1,s.setAttribute("vState",g);const v=new Uint8Array(4*l.count).fill(r.EnumElementState.NONE),y=new THREE.Uint8BufferAttribute(v,4);return y.normalized=!0,s.setAttribute("pointColorState",y),u.uvBufferAttribute&&s.setAttribute("uv",u.uvBufferAttribute),u.uv2BufferAttribute&&s.setAttribute("uv2",u.uv2BufferAttribute),u.uv3BufferAttribute&&s.setAttribute("uv3",u.uv3BufferAttribute),u.lightMapTexture&&(e.lightMapTexture=u.lightMapTexture),d&&e.useCompressedNormal&&s.setAttribute("cNormal",d),d&&!e.useCompressedNormal&&s.setAttribute("normal",d),p&&s.setAttribute("color",p),m&&s.setAttribute("barycentric",m),s.clearGroups(),s.groups.push({start:0,count:o.iAccInfoCount,materialIndex:0}),s}createMeshNode(e,t,i,n){if(!t.content)return;let a=null;if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES)t.content.hasLine=!0,a=new r.LineSegmentsEx(i,[n]);else a=new r.MeshEx(i,[n]);a.applyMatrix4(e.matrix),a.name=e.nodeIndexId,a.tileId=e.tileId,a.nodeId=e.nodeIndex,a.databagId=t.content.meshes.databagId,a.fileId=t.content.meshes.fileId,a.matrixRoot=e.matrixRoot,a.isMeshQuantization=this._isCompressedBufferMode(t);var s=this.loader.filter.model;if(r.GlobalData.EnableShadowMap&&(a.castShadow=!1===a.material[0].transparent&&s.castShadow,a.receiveShadow=s.receiveShadow),e.lightMapTexture){r.GeomUtil.expandBufferGeometryWithUV2(a.geometry);const t=this.materialManager.getLightMapMaterial(a.material[0]);r.Utils.isDefined(t)&&(a.material[0]=t),a.material[0].lightMap=e.lightMapTexture,e.lightMapTexture=null,a.material[0].lightMapIntensity=r.GlobalData.LightmapIntensity,a.material[0].refreshUniforms(),a.material[0].needsUpdate=!0}a.customDepthMaterial=this.materialManager.getBatchDepthMaterial(),a.matrixAutoUpdate=!1,t.content.meshes.add(a),t.content.meshes.updateMatrixWorld(!0),this.loader.addMeshIdMap(a.name,a)}getUserIdInfo(e,t){const i=e.getBlobHeader().getTileId(),r=e.getUseridindexinfosList();let n={},a=0;r.forEach((e=>{const t=e.getNodeid(),r=e.getUseridindex(),s=e.getIndexstart(),o=3*e.getPositionstart(),l=3*(e.getPositionend()+1),d=l-o,h=e.getIndexend();0==s&&(a=0);const c={positionStart:o,positionEnd:l,positionCount:d,indexStart:s,indexEnd:h,stateIndex:a,indexCount:h-s+1,cNormalStart:o/3*2,cNormalCount:d/3*2};a++,this.loader.patchMeshNodeInfo(t,i,r),n[t]||(n[t]=new Map),n[t].set(r,c)})),t.children.forEach((e=>{if(!n[e.nodeId])return;const t=n[e.nodeId];if(e.geometry.hasAttribute("uv2")&&this.materialManager.hasLightMap())for(const e of t.values())e.positionStart=3*e.indexStart,e.positionEnd=3*(e.indexEnd+1),e.positionCount=e.positionEnd-e.positionStart,e.cNormalStart=2*e.indexStart,e.cNormalCount=e.positionCount/3*2;e.indexGroups=t})),n=null}getTileId(e,t){return t.getTileId()}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getUserIds(e,t,i,r){const n=this._getAccInfo(e,r.getAccUserids());if(n.count>0){const e=t.slice(n.offset,n.offset+n.length).buffer;let r=new Uint8Array(e);return i.uAccInfoStart=n.offset,new THREE.BufferAttribute(r,4)}return null}_getNormal(e,t,i,r){const n=this._getAccInfo(e,r.getAccNormals());if(n.count>0){let e,a;const s=t.slice(n.offset,n.offset+n.length).buffer;switch(i.nAccInfoStart=n.offset,i.nAccInfoCount=n.count,n.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:e=new Uint8Array(s),r.useCompressedNormal=!0,a=new THREE.BufferAttribute(e,2);break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:e=new Float32Array(s),r.useCompressedNormal=!1,a=new THREE.BufferAttribute(e,3)}return a}return null}_getBarycentric(e,t,i,r){const n=this._getAccInfo(e,r.getAccBarycentric());if(r.useBCOutline=!1,n.count>0){let e,a;const s=t.slice(n.offset,n.offset+n.length).buffer;if(i.bcAccInfoStart=n.offset,i.bcAccInfoCount=n.count,n.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE)e=new Uint8Array(s),r.useBCOutline=!0,a=new THREE.BufferAttribute(e,3);return a}return null}_getVertex(e,t,i,r){const n=this._getAccInfo(e,r.getAccVertices()),a=t.slice(n.offset,n.offset+n.length).buffer,s=8===n.length/n.count,o=r.quantizebits;let l=this._convertVertexArray(a,s,o);i.vAccInfoStart=n.offset;return{vertexBufferData:a,vertexBufferAttribute:new THREE.BufferAttribute(l,3)}}_getColor(e,t,i,r){const n=this._getAccInfo(e,r.getAccColor());if(0===n.length||0===r.getAccColor())return null;const a=t.slice(n.offset,n.offset+n.length).buffer;let s=new Uint8Array(a);i.cAccInfoStart=n.offset,r.vertexColors=!0;const o=new THREE.BufferAttribute(s,4);return o.normalized=!0,o}_getIndex(e,t,i,r){const n=this._getAccInfo(e,r.getAccIndices()),a=t.slice(n.offset,n.offset+n.length).buffer;let s=null;if(n.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT)s=new Uint16Array(a);else s=new Uint32Array(a);i.iAccInfoStart=n.offset,i.iAccInfoCount=n.count;return{indexBufferData:a,indexBufferAttribute:new THREE.BufferAttribute(s,1)}}_getTextureCoord(e,t,i,r){i.tAccInfoStart=0;let n={uvBufferData:null,uvBufferAttribute:null,uv2BufferData:null,uv2BufferAttribute:null,uv3BufferData:null,uv3BufferAttribute:null},a=null;const s=this._getAccInfo(e,r.getAccTexcoords());if(s.count>0){const e=t.slice(s.offset,s.offset+s.length).buffer;i.tAccInfoStart=s.offset,s.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(r.useCompressedUv=!0,a=new Int16Array(e)):(r.useCompressedUv=!1,a=new Float32Array(e));const o=new THREE.BufferAttribute(a,2);n.uvBufferData=e,n.uvBufferAttribute=o}const o=this._getAccInfo(e,r.getAccTexcoords2());if(o.count>0){const e=t.slice(o.offset,o.offset+o.length).buffer;i.tAccInfoStart2=o.offset,o.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(r.useCompressedUv=!0,a=new Int16Array(e)):(r.useCompressedUv=!1,a=new Float32Array(e));const s=new THREE.BufferAttribute(a,2);n.uv2BufferData=e,n.uv2BufferAttribute=s}const l=this.materialManager.getUv2InfoByNodeId(r.tileId,r.nodeIndexId,i.iAccInfoCount);if(l){n.uv2BufferData=l.uv2;const e=new THREE.Float32BufferAttribute(l.uv2,2);n.uv2BufferAttribute=e,n.lightMapTexture=l.lightMapTexture}const d=this._getAccInfo(e,r.getAccTexcoords3());if(d.count>0){const e=t.slice(d.offset,d.offset+d.length).buffer;i.tAccInfoStart3=d.offset,a=new Float32Array(e);const r=new THREE.BufferAttribute(a,2);n.uv3BufferData=e,n.uv3BufferAttribute=r}return n}_getBufferData(e){return r.BimTileMeshParser.getBufferData(e)}_convertVertexArray(e,t,i){return r.BimTileMeshParser.convertVertexArray(e,t,i)}_isCompressedBufferMode(e){if(e.buffer&&e.buffer.content){const t=e.buffer.content.getBlobHeader();if(t.getTotalVertexNum&&t.getTotalVertexNum()>0)return!0}return!1}}r.BimTileBatchBlobParserV3=e}(),function(){class e extends r.BimTileUserIdTool{constructor(){super(),this.userIndexStringMap=new Map,this.userStringIndexMap={}}destroy(){super.destroy()}addGlobalUserIdUrl(e){this.globalUserIdUrls.push(e)}getGlobalUserIdUrls(){return this.globalUserIdUrls}parseUserIdBuffer(e){const t=e.getBlobHeader().getUserIdMin(),i=e.getBlobHeader().getUserIdMax(),r=e.getUserIdsList();for(let e=t;e<=i;++e)this.userIndexStringMap.set(e,r[e-t]),this.userStringIndexMap[r[e-t]]=e;const n=e.getUserdataindexList();for(let e=t;e<=i;++e)this.userDataIndexMap[e]=n[e-t]}disposeBuffer(){}getIndexByUserId(e){return this.userStringIndexMap[e]}getUserIdByIndex(e){return this.userIndexStringMap.get(parseInt(e))}getAllUserIndexCallback(e){for(const t of this.userIndexStringMap.keys())e&&e(t)}getUserDataIndexByUserIndex(e){return this.userDataIndexMap[e]}}r.BimTileUserIdToolV3=e}(),function(){class e extends r.BimTilesLoader{constructor(e){super(e),this.bimTileParser[r.TileContentType.DATA_MESH]=new r.BimTileBatchBlobParserV3({materialManager:this.materialManager,loader:this}),this.bimTileParser[r.TileContentType.DATA_INSTANCE]=new r.BimTileInstanceParserV3({materialManager:this.materialManager,loader:this}),this.batchedMeshManager=new r.BimTileBatchedMeshManagerV3(this),this.instancedMeshManager=new r.BimTileInstancedMeshManagerV3(this),this._enableDynamicInstanceLod=!1,this._lodMeshVisibleInfo={}}_createTileReader(){this.tileReader=new r.BimTileReaderV3({dataVersion:this.dataVersion})}addSearchTreeUrl(e,t,i){i&&i()}destroy(){super.destroy()}addInstanceInfo(e,t){}patchMeshNodeInfo(e,t,i){this.userIdManager.patchMeshNodeInfo(e,t,i)}patchInstanceNodeInfo(e,t,i,r){this.userIdManager.patchInstanceNodeInfo(e,t,i,r)}get userIdManager(){return this.tileReader.descriptor}get enableDynamicInstanceLod(){return this._enableDynamicInstanceLod}set enableDynamicInstanceLod(e){this._enableDynamicInstanceLod=e}setLodMeshVisibleInfo(e,t){this._lodMeshVisibleInfo[e]=t}isLodMeshLoaded(e,t){return this._lodMeshVisibleInfo[e]===t}loadGlobalUserIdBoxUrls(e){const t=this.tileReader.getGlobalUserIdBoxUrls();let i=0;t&&(i+=t.length,t.map((t=>{this.loadBlock(t,{},r.TileContentType.DATA_GLOBAL_USER_ID_BOX,(()=>{i--,i<=0&&e&&e()}))})));const n=this.filter.model.materialManager;n.hasLightMap&&n.hasLightMap()&&(i++,n.loadLightMap(this,(()=>{i--,i<=0&&e&&e()})))}getMeshNodeById(e){const t=this.filter.model.objectGroup.children[0];return this.batchedMeshManager.getMeshNodeById(e,t)}addInstanceLodMeshIdMap(e,t,i,r,n){this.instancedMeshManager.addInstanceLodMeshIdMap(e,t,i,r,n)}getInstanceMeshNodeById(e){if(!this._enableDynamicInstanceLod){const t=this.filter.model.objectGroup.children[1];return this.instancedMeshManager.getInstanceMeshNodeById(e,t)}const t=this._lodMeshVisibleInfo[e];if(void 0!==t)return this.instancedMeshManager.getInstanceLodMeshNodeById(e,t)}getInstanceLoadedLodLevel(e){return this.instancedMeshManager.getInstanceLoadedLodLevel(e)}isInstanceLodLevelLoaded(e,t){return this.instancedMeshManager.isInstanceLodLevelLoaded(e,t)}}r.BimTilesLoaderV3=e}(),function(){class e extends r.BimTileReader{constructor(e){super(),this.descriptor=new r.BimtileDescriptorV3(this),this.userIdTool=new r.BimTileUserIdToolV3,this.userIdBoxTool=new r.BimTileUserIDBoxTool(this),this.dataVersion=e.dataVersion}getUserDataIndexKeyByString(e){return this.userDataTool.getUserDataIndexKeyByString(e)}getAllUserIndexCallback(e){return this.userIdTool.getAllUserIndexCallback(e)}getUserIdByIndex(e){return this.userIdTool.getUserIdByIndex(e)}getUserDataIndexByUserIndex(e){return this.userIdTool.getUserDataIndexByUserIndex(e)}getUserIdBoxByIndex(e){return this.userIdBoxTool.getUserIdBoxByIndex(e)}getOriginUserIdBoxByIndex(e){return this.userIdBoxTool.getUserIdBoxByIndex(e).clone()}setChangedUserIdBoxByIndex(e,t){this.userIdBoxTool.setChangedUserIdBoxByIndex(e,t)}getChangedUserIdBoxByIndex(e){return this.userIdBoxTool.getChangedUserIdBoxByIndex(e)}getUserIdDrawingBoxByIndex(e,t){return this.userIdBoxTool.getUserIdDrawingBoxByIndex(e,t)}getGlobalUserIdBoxUrls(){return this.userIdBoxTool&&this.userIdBoxTool.getGlobalUserIdBoxUrls()}parseBlock(e,t,i){const n=t.node,a=t.type,s=t.url,o=t.outline;let l=!0;n.bufferType=a;let d=0;const h=e.byteLength;for(n.buffer=r.Utils.isDefined(n.buffer)?n.buffer:{},n.lineBuffer=r.Utils.isDefined(n.lineBuffer)?n.lineBuffer:{},n.outlineBuffer=r.Utils.defaultValue(n.outlineBuffer,{});d<h;){const t=e.slice(d,d+4);let i=new Uint32Array(t)[0];d+=4;const h=new Uint8Array(e,d,i);d+=i;const u=proto.bimtile_pbf.BlockHeader.deserializeBinary(h);l&&u.getDataType(),i=u.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var c=new Uint8Array(e,d,i);if(d+=i,u.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const p=u.getDataType();let m={};switch(p){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf_v2.SearchTreeBlob.deserializeBinary(c);m.type=p,m.content=e,n.searchBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf_v3.UserIDBlob.deserializeBinary(c);if(a===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}m.type=p,m.content=t,n.userIdBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERIDBOX:const i=proto.bimtile_pbf_v3.UserIDBBoxBlob.deserializeBinary(c);if(a===r.TileContentType.DATA_GLOBAL_USER_ID_BOX){this.userIdBoxTool.parseUserIdBoxBuffer(i,s);break}break;case proto.BlockHeader.BlockType.BT_MATERIAL:const l=proto.bimtile_pbf.MaterialBlob.deserializeBinary(c);if(m.type=p,m.content=l,a===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=l;break}n.materialBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERDATA:const d=proto.bimtile_pbf.UserdataBlob.deserializeBinary(c);if(a===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(d);break}m.type=p,m.content=d,n.userdataBuffer=m;break;case proto.BlockHeader.BlockType.BT_BUFFER:const h=proto.bimtile_pbf.BufferBlob.deserializeBinary(c);m.type=p,m.content=this.decodeVertexBuffer(h),a===proto.BlockHeader.BlockType.BT_LINE?o?n.outlineBuffer=m:n.lineBuffer=m:n.buffer=m;break;case proto.BlockHeader.BlockType.BT_MESH:const u=proto.bimtile_pbf_v3.MeshBlob.deserializeBinary(c);m.type=p,m.content=u,n.meshBlob=m;break;case proto.BlockHeader.BlockType.BT_POINT:const f=proto.bimtile_pbf.PointBlob.deserializeBinary(c);m.type=p,m.content=f,n.buffer=m;break;case proto.BlockHeader.BlockType.BT_TILEID:const g=proto.bimtile_pbf.TileIDBlob.deserializeBinary(c);if(m.type=p,m.content=g,a===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=g;break}n.buffer=m;break;case proto.BlockHeader.BlockType.BT_INSTANCE:let v=proto.bimtile_pbf.InstanceBlob;r.Utils.defined(n.blobId)&&(v=proto.bimtile_pbf_v3.InstanceBlobs);const y=v.deserializeBinary(c);m.type=p,m.content=y,n.buffer=m;break;case proto.BlockHeader.BlockType.BT_LINE:const M=proto.bimtile_pbf.MeshBlob.deserializeBinary(c);m.type=p,m.content=M,a===proto.BlockHeader.BlockType.BT_LINE&&o?n.outlineBuffer=m:n.lineBuffer=m;break;default:return void console.warn("Parse unknow block faild! ")}l&&(l=!1)}i&&i()}createNodeInfoMap(){}decodeVertexBuffer(e){const t=e.getBlobHeader();if(!t.getTotalVertexNum||0===t.getTotalVertexNum())return e;const i=t.getBufferBlobSize(),r=t.getBufferSizeList();if(r.reduce(((e,t)=>e+t))!==i)return console.error("The compressed data is abnormal."),e;const n=proto.bimtile_pbf.BufferBlobHeader.BufferType,a=e.getBuffer(),s=a.byteOffset,o=(t.getTotalVertexNum(),t.getIndexCompressSequence()),l=t.getBufferOffsetList(),d=t.getVertexNumList(),h=t.getVertexStrideList(),c=t.getBufferTypeList();let u=[],p=[],m=0,f=!1;c.forEach(((e,t)=>{const i=e===n.BT_INDEX,r=d[t],a=h[t];let s;u.push(m),i&&!1===o&&r%3!=0?(f=!0,m+=2,s=(r-1)*a):s=r*a,p.push(s),m+=s}));let g=new Uint8Array(m);const v=MeshoptDecoder;try{c.forEach(((e,t)=>{const i=e===n.BT_INDEX,c=i&&f?d[t]-1:d[t],m=h[t],y=l[t],M=r[t],E=new Uint8Array(a.buffer,s+y,M),x=u[t],_=p[t];(i?o?v.decodeIndexSequence:v.decodeIndexBuffer:v.decodeVertexBuffer)(new Uint8Array(g.buffer,x,_),c,m,E)}))}catch(t){return console.error(t),e}return e._bufferData=g,e}}r.BimTileReaderV3=e}(),r.BimTileBatchedMeshManagerV3=class{constructor(e){this.loader=e,this.reader=e.reader,this.batchMeshIdNodeMap=new Map,this._capMeshGroup=null,this.idColor={}}destroy(){this.batchMeshIdNodeMap.clear(),this._capMeshGroup&&this._capMeshGroup.clear(),this._capMeshGroup=null}getGeometryBuffersByUserIdInfo(e,t,i,n){const a=e.tileId,s=e.userId;for(const[e,o]of a)for(const a of o.keys()){const o=`${e}_${a}`,l=t.getObjectByName(o);if(!l||!l.visible||l.parent&&!l.parent.visible)continue;let d=l.matrix.clone();const h=l.geometry,c=h.getIndex().array,u=h.getAttribute("position").array,p=h.getAttribute("uv"),m=p?p.array:null,f=h.getAttribute("uv3"),g=f?f.array:null,v=h.getAttribute("color"),y=v?v.array:null,M=h.getAttribute("cNormal"),E=M?M.array:null,x=h.getAttribute("barycentric"),_=x?x.array:null,b=l.indexGroups.get(s),I=h.getAttribute("id"),T=h.getAttribute("vState"),S=h.getAttribute("pointColorState");let C=b.indexStart,w=b.indexStart+b.indexCount;const R=c.slice(C,w);C=b.positionStart/3,w=C+b.positionCount/3;const B=I.array.slice(4*C,4*w);let A=T.array.slice(4*C,4*w);A.fill(r.EnumElementState.NONE);let P=S.array.slice(4*C,4*w);P.fill(0);let L=null;m&&(C=b.positionStart/3*2,w=C+b.positionCount/3*2,L=m.slice(C,w));let O,D,N,H=null;g&&(C=b.positionStart/3*2,w=C+b.positionCount/3*2,H=g.slice(C,w)),y&&(C=b.positionStart/3*4,w=C+b.positionCount/3*4,O=y.slice(C,w)),E&&(C=b.cNormalStart,w=C+b.cNormalCount,D=E.slice(C,w)),_&&(C=b.positionStart,w=C+b.positionCount,N=_.slice(C,w)),C=b.positionStart,w=b.positionStart+b.positionCount;const U=u.slice(C,w);C/=3,R.forEach((function(e,t,i){i[t]-=C})),n.push({isLines:!1,databagId:i,nodeId:o,position:U,index:R,uv:L,uv3:H,matrix:d,color:O,cNormal:D,id:B,vState:A,pointColorState:P,barycentric:N,isInstance:!1})}}calculateClippingIds(e,t,i,n,a){if(!r.GlobalData.CalculateClippingLine)return;const s=n.tileId,o=a.tilesLoader;for(const[l,d]of s){let s=[];const h=o.tileReader.getUserIdBoxByIndex(n.userId);for(const t of d.keys()){const i=o.getMeshNodeById(`${l}_${t}`);if(!i||"LineSegmentsEx"==i.type)continue;if(!i.visible||i.parent&&!i.parent.visible)continue;const d=i.indexGroups.get(n.userId);d.box=h;const c=r.ClippingBorderLineUtil.calculateIntersection(e,i,d,a);delete d.box,s=s.concat(c)}r.ClippingBorderLineUtil.push(a,s,t,i,n.userId)}}calculateClippingContours(e){const{modelId:t,plane:i,planeBoxWorld:n,userIndex:a,stringId:s,userIdInfo:o,modelTransform:l,capsIntersectContour:d}=e,h=this.loader.filter.model,c=o.tileId;for(const[e,o]of c)for(const c of o.keys()){const o=h.tilesLoader.getMeshNodeById(`${e}_${c}`);if(!o.visible||o.parent&&!o.parent.visible)continue;const u=o.matrix,p=o.indexGroups.get(a);let m=[];if(!o.isMesh)continue;if(o.getIntersectionContours(i,p,m),0===m.length)return;let f=[];if(m.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(u).applyMatrix4(l),r.ClippingBorderLineUtil.BoxContainsPoint(n,e)&&t.push(e)})),t.length>0&&f.push(t)})),0===f.length)return;const g=o.material[0].color,v={red:parseInt(255*g.r),green:parseInt(255*g.g),blue:parseInt(255*g.b)};void 0===d[t][s]?d[t][s]={clippingContours:[f],colors:[v]}:(d[t][s].clippingContours.push(f),d[t][s].colors.push(v))}}changeAllMaterials(e){this.loader.filter.model.objectGroup.children[0].traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;let i=t.material;if(i)for(let t=0;t<i.length;t++){if(!i[t])continue;let r=i[t].name;e[r]&&(i[t]=e[r])}}))}updatePickingMeshes(e,t,i,n,a,s){const o=i.geometry,l=i.indexGroups;let d=new THREE.BufferGeometry;d.setAttribute("position",o.getAttribute("position")),o.getAttribute("color")&&d.setAttribute("color",o.getAttribute("color")),!n&&o.getAttribute("uv3")&&d.setAttribute("uv3",o.getAttribute("uv3"));let h=o.getAttribute("uv");s&&h&&d.setAttribute("uv",h),d.setIndex(o.getIndex());let c="LineSegmentsEx"===i.type?new THREE.LineSegments(d,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(d,r.MaterialUtil.DefaultMaterial);c.name=i.name,c.frustumCulled=!1,c.renderOrder=r.EnumRenderOrder.Component,c._indicesGroup=l,c.material=n?[n]:i.material,c.matrix.copy(i.matrix),c.matrixAutoUpdate=!1;const u=l.get(parseInt(t));let p={};n||o.groups.map((e=>{p[e.start]=e.materialIndex}));let m=0;n||(m=p[u.indexStart]),c.geometry.addGroup(u.indexStart,u.indexCount,m),a.add(c)}_getCapMeshGroup(){return this._capMeshGroup||(this._capMeshGroup=new THREE.Group),this._capMeshGroup.clear(),this._capMeshGroup}_fillColor(e,t){for(const[i,r]of e){const e=r.positionStart/3,n=r.positionEnd/3;for(let r=e;r<n;++r)r!==e||this.idColor[i]?(t[4*r]=this.idColor[i][0],t[4*r+1]=this.idColor[i][1],t[4*r+2]=this.idColor[i][2],t[4*r+3]=this.idColor[i][3]):(this.idColor[i]=[],this.idColor[i][0]=t[4*r],this.idColor[i][1]=t[4*r+1],this.idColor[i][2]=t[4*r+2],this.idColor[i][3]=t[4*r+3])}}updatePickingMeshesStateForCap(e,t){const i=this._getCapMeshGroup(),n=e.children.length;for(let s=0;s<n;++s){const n=e.children[s],o=n.children.length;for(let e=0;e<o;++e){const s=n.children[e],o=s.material[0];if(o.side===THREE.DoubleSide||!1===s.visible)continue;if(!1===s.isMesh)continue;const l=t.getBackMaterial(o),d=s.indexGroups,h=s.geometry,c=h.attributes;var a=new THREE.BufferGeometry;if(a.setAttribute("position",h.getAttribute("position")),a.setIndex(h.getIndex()),c.color){const e=c.color.clone(),t=e.array;this._fillColor(d,t),a.setAttribute("color",e)}c.vState&&a.setAttribute("vState",c.vState),c.pointColorState&&a.setAttribute("pointColorState",c.pointColorState);const u=new THREE.Mesh(a,l);u.name=s.name,u.frustumCulled=!1,u.renderOrder=r.EnumRenderOrder.Component,u.indexGroups=d,u.matrix.copy(s.matrix),u.matrixAutoUpdate=!1,u.updateMatrixWorld(!0),i.add(u)}}return i}addMeshIdMap(e,t){this.batchMeshIdNodeMap.set(e,t)}getMeshNodeById(e){return this.batchMeshIdNodeMap.get(e)}disposeMeshNodeById(e){this.batchMeshIdNodeMap.delete(e)}},r.BimTileInstancedMeshManagerV3=class{constructor(e){this.loader=e,this.reader=e.tileReader,this.overrideMaterialMap={},this.instanceMeshIdNodeMap=new Map,this.instanceLodMeshIdNodeMap={},this._capMeshGroup=null}destroy(){this.instanceMeshIdNodeMap.clear(),this.instanceLodMeshIdNodeMap=null,this._capMeshGroup&&this._capMeshGroup.clear(),this._capMeshGroup=null}_extractArrayByAttributeIndex(e,t,i){const r=e.itemSize,n=e.array,a=t*r;let s=new Float32Array(r*i);for(let e=0;e<i;++e)for(let t=0;t<r;++t)s[e*r+t]=n[a+t];return s}getGeometryBuffersByUserIdInfo(e,t,i,r){const n=e.tileId;for(const[e,t]of n){const n=this.loader.getInstanceMeshNodeById(`${e}_0`);if(!n||!n.visible||n.parent&&!n.parent.visible)continue;const a=n.geometry,s=a.getIndex(),o=a.getAttribute("position"),l=o.count,d=a.getAttribute("uv"),h=a.getAttribute("barycentric"),c=a.getAttribute("id"),u=a.getAttribute("vState"),p=a.getAttribute("pointColorState"),m=a.getAttribute("uv3");for(const[e,a]of t){let t=n.matrix.clone().multiply(a);n.matrixRoot&&t.multiply(n.matrixRoot);let f=e,g=null;c&&(g=this._extractArrayByAttributeIndex(c,f,l));let v=null;u&&(v=this._extractArrayByAttributeIndex(u,f,l));let y=null;p&&(y=this._extractArrayByAttributeIndex(p,f,l));let M=null;m&&(M=this._extractArrayByAttributeIndex(m,f,l)),r.push({isLines:!1,databagId:i,nodeId:n.name,position:o.array,index:s.array,matrix:t,uv:d?d.array:null,uv3:M,id:g,vState:v,pointColorState:y,barycentric:h?h.array:null,isInstance:!0})}}}_createInstanceMaterial(e,t,i){const n=e.getAttribute("aColor").array,a=e.getAttribute("vState").array,s=n[4*t],o=n[4*t+1],l=n[4*t+2];let d=Math.floor(100*n[4*t+3])/100;const h=new THREE.Color(s,o,l);a[t]===r.EnumElementState.NONE&&(d=i);let c=!1;d<1&&(c=!0);const u={color:h.getHex(),opacity:d,transparent:c},p=`${u.color}_${d}`;let m=this.overrideMaterialMap[p];return m||(m=r.MaterialUtil.createStandardMaterial(u),this.overrideMaterialMap[p]=m,m)}updatePickingMeshes(e,t,i,n,a,s){const o=e.geometry;let l=new THREE.BufferGeometry;l.setAttribute("position",o.getAttribute("position")),o.getAttribute("color")&&l.setAttribute("color",o.getAttribute("color")),!t&&o.getAttribute("uv3")&&l.setAttribute("uv3",o.getAttribute("uv3")),l.setIndex(o.getIndex()),l.groups=o.groups;let d=null;d="LineSegmentsEx"===e.type?new THREE.LineSegments(l,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(l,t||this._createInstanceMaterial(o,s,e.material.opacity)),d.name=e.name,d.frustumCulled=!1,d.matrix.copy(e.matrix).multiply(i),e.matrixRoot&&d.matrix.multiply(e.matrixRoot),d.matrixAutoUpdate=!1,n.add(d)}calculateClippingIds(e,t,i,n,a){if(!r.GlobalData.CalculateClippingLine)return;const s=n.tileId,o=a.tilesLoader;for(const[l,d]of s){const s=o.tileReader.getUserIdBoxByIndex(n.userId),h=o.getInstanceMeshNodeById(`${l}_0`);if(!h)continue;let c=[];for(const t of d.values()){if(!h||"LineSegmentsEx"==h.type)continue;if(!h.visible||h.parent&&!h.parent.visible)continue;let i={matrix:h.matrixRoot?t.clone().multiply(h.matrixRoot):t,box:s};const n=r.ClippingBorderLineUtil.calculateIntersection(e,h,i,a);c=c.concat(n)}r.ClippingBorderLineUtil.push(a,c,t,i,n.userId)}}calculateClippingContours(e){const{modelId:t,plane:i,planeBoxWorld:n,userIndex:a,stringId:s,userIdInfo:o,modelTransform:l,capsIntersectContour:d}=e,h=o.tileId;for(const[e,a]of h){const o=this.loader.getInstanceMeshNodeById(`${e}_0`);if(o&&o.visible&&(!o.parent||o.parent.visible))for(const e of a.values()){let a=o.matrix.clone().multiply(e);o.matrixRoot&&a.multiply(o.matrixRoot);let h=[],c={matrix:a,isWorldPlane:!0,isInstance:!0};o.getIntersectionContours(i,c,h);let u=[];h.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(l),r.ClippingBorderLineUtil.BoxContainsPoint(n,e)&&t.push(e)})),t.length>0&&u.push(t)}));const p=o.material.color,m={red:parseInt(255*p.r),green:parseInt(255*p.g),blue:parseInt(255*p.b)};0!==u.length&&(void 0===d[t][s]?d[t][s]={clippingContours:[u],colors:[m]}:(d[t][s].clippingContours.push(u),d[t][s].colors.push(m)))}}}_getCapMeshGroup(){return this._capMeshGroup||(this._capMeshGroup=new THREE.Group),this._capMeshGroup.clear(),this._capMeshGroup}updatePickingMeshesStateForCap(e,t){const i=this._getCapMeshGroup(),n=e.children.length;for(let s=0;s<n;++s){const n=e.children[s],o=n.children.length;for(let e=0;e<o;++e){const s=n.children[e],o=s.material;if(o.side===THREE.DoubleSide||!1===s.visible)continue;if(!1===s.isMesh)continue;const l=t.getBackMaterial(o),d=s.geometry,h=d.attributes;var a=new THREE.InstancedBufferGeometry;a.setAttribute("position",d.getAttribute("position")),a.setIndex(d.getIndex()),h.color&&a.setAttribute("color",h.color),a.setAttribute("mcol0",h.mcol0),a.setAttribute("mcol1",h.mcol1),a.setAttribute("mcol2",h.mcol2),a.setAttribute("mcol3",h.mcol3),a.setAttribute("aColor",h.aColor);const c=h.vState.clone();c.array.fill(0),a.setAttribute("vState",c),a.setIndex(d.getIndex()),h.pointColorState&&a.setAttribute("pointColorState",h.pointColorState);const u=new THREE.Mesh(a,l);u.name=s.name,u.frustumCulled=!1,u.renderOrder=r.EnumRenderOrder.Component,u.matrix.copy(s.matrix),u.matrixAutoUpdate=!1,u.updateMatrixWorld(!0),i.add(u)}}return i}updateInstanceClipping(e){}updatePickingMeshesByIds(e){}changeAllMaterials(e){this.loader.filter.model.objectGroup.children[1].traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;let i=t.material;if(i)if(Array.isArray(i))for(let t=0;t<i.length;t++){if(!i[t])continue;let r=i[t].name;e[r]&&(i[t]=e[r])}else{let r=i.name;r&&e[r]&&(t.material=e[r])}}))}addInstanceMeshIdMap(e,t,i,r){this.instanceMeshIdNodeMap.set(e,i)}getInstanceMeshNodeById(e){return this.instanceMeshIdNodeMap.get(e)}addInstanceLodMeshIdMap(e,t,i,r,n){this.instanceLodMeshIdNodeMap[e]||(this.instanceLodMeshIdNodeMap[e]={}),this.instanceLodMeshIdNodeMap[e][n]=i}getInstanceLodMeshNodeById(e,t){if(this.instanceLodMeshIdNodeMap[e])return this.instanceLodMeshIdNodeMap[e][t]}getInstanceLoadedLodLevel(e){return this.instanceLodMeshIdNodeMap[e]?Object.keys(this.instanceLodMeshIdNodeMap[e]):[]}isInstanceLodLevelLoaded(e,t){return!!this.instanceLodMeshIdNodeMap[e]&&!!this.instanceLodMeshIdNodeMap[e][t]}disposeInstanceMeshNodeById(e){this.instanceMeshIdNodeMap.delete(e),this.instanceLodMeshIdNodeMap[e]=null}},function(){let e=new THREE.Matrix4;class t extends r.BimTilesModel{constructor(e,t,i,n,a,s){if(super(e,t,i,n,a,s),this._config.count){const e=this.statistics.numOfElements,t=Math.log(2),i=Math.ceil(Math.log(e)/t),r=Math.ceil(i/2),n=i-r,a=Math.pow(2,r),s=Math.pow(2,n);this.USERID_ANIMATION_MAP_WIDTH=a,this.USERID_ANIMATION_MAP_HEIGHT=s,this.userIdAnimationMap=new THREE.DataTexture(new Uint8Array(4*a*s).fill(0),this.USERID_ANIMATION_MAP_WIDTH,this.USERID_ANIMATION_MAP_HEIGHT,THREE.RGBAFormat,THREE.UnsignedByteType),this.userIdAnimationMap.generateMipmaps=!1,this.userIdAnimationMap.magFilter=THREE.NearestFilter,this.userIdAnimationMap.minFilter=THREE.NearestFilter}this.pickHelper=new r.BimTileGpuPickingManagerV1(t,this);const o=e.rendererManager.getPickingEffecter();o.enableUpdateScene(!1),this.pickingManager=new r.BimTilesPickingManagerV3(this,o),this.modelExplosion=new r.BimTilesModelExplosionV3(this),this.tilesLoader.modelExplosion=this.modelExplosion,this.objectGroup.castShadowIgnoreVisible=!1}destroy(){this.pickHelper.destroy(),this.pickHelper=null,this.tilesLoader.modelExplosion=null,super.destroy()}setVisible(e){super.setVisible(e),this._tileset&&!0===this._tileset.shadowMapManager.enable&&(this.objectGroup.castShadowIgnoreVisible=e)}_createLoader(e){this.tilesLoader=new r.BimTilesLoaderV3(e)}getNodeInfosByUserId(e){let t=(e,t)=>{const i=t.getUserDataByIndex(e);let r={};for(let e in i){const[n,a]=t.getUserDataStringMapByIndex(e,i[e]);r[n]=a}return r};const i=this.tilesLoader.tileReader,n=i.getIndexByUserId(e),a=this.getDescriptor().getUserIdInfoByUserId(n),s=[];for(let e=0;e<a.length;++e){const r=a[e],o=r.clone();o.transformMatrix=this.getTransformMatrix();const l=this.manager.explosionManager.isExploded(this.id)&&i.getChangedUserIdBoxByIndex(r.userId);o.boundingBox=l||i.getUserIdBoxByIndex(n).clone();const d=i.getUserDataIndexByUserIndex(n);o.userdataId=d,o.userData=t(d,i),s.push(o)}if(0==a.length&&r.Utils.defined(n)){const e=i.getUserDataIndexByUserIndex(n);s.push({userId:n,transformMatrix:this.getTransformMatrix(),boundingBox:i.getUserIdBoxByIndex(n).clone(),userdataId:e,userData:t(e,i)})}return s}_crateFilterManger(){return new r.BimTileFilterManagerV3(this)}_crateMaterialManger(e){return e.borderLineVisible=this._enableBorderLine,new r.BimTileMaterialManagerV3(e)}getBoundBoxByUserIndex(e){return this.tilesLoader.tileReader.getUserIdBoxByIndex(e)}getAllUserIds(){return Object.keys(this.tilesLoader.tileReader.userIdTool.userStringIndexMap)}hasUserId(e){return!!this.tilesLoader.tileReader.getIndexByUserId(e)}isHiddenUserId(e){return this.getFilter().isHidden(e)}calculateClippingIds(e,t){const i=this.manager.scene,n=r.FillClipPlaneManager.getInstance(i),a=n&&n.isEnabled(),s=i.clipPlanes;let o=a?n:s;if(!o)return;let l=o.renderClipPlane.clone();const d=this.getDescriptor(),h=this.getFilter(),c=h._hasVisibleFilter();let u=a?o.capsIntersectPosition:o.capsIntersectPosition[o.selectIndex];if(!u)return;let p=a?o.capsIntersectPositionGroup:o.capsIntersectPositionGroup[o.selectIndex];p.set(this,new Map);let m=a?-1:o.selectIndex;this.mapClippingIds.clear(),s&&t&&this.mapClippingIds.clear();let f=this.getFilter().getLocalClippingList(),g=this.viewer.getRenderer().localClippingEnabled&&f.size>0;i.getMatrixGlobal().multiply(this.transformMatrix);const v=this.tilesLoader.tileReader;if(t?this.mapClippingIdsBox.forEach((e=>{e.clear()})):d.getAllUserIdInfoCallback((e=>{if(c&&!h._isVisible(e))return;const t=e.userId,i=v.getUserIdByIndex(t);if(g&&!f.get(i))return;const r=v.getUserIdDrawingBoxByIndex(t,this);if(r&&l.intersectsBox(r)){this.mapClippingIds.set(t,!0);const e=d.getUserIdInfoByUserId(t);for(let t=0;t<e.length;++t){const i=e[t];i.instanceOrNot?this.tilesLoader.instancedMeshManager.calculateClippingIds(l,u,p,i,this):this.tilesLoader.batchedMeshManager.calculateClippingIds(l,u,p,i,this)}}})),m>=0){this.mapClippingIdsBox[m]=this.mapClippingIds,this.mapClippingIds=new Map;for(let e=0;e<this.mapClippingIdsBox.length;++e)this.mapClippingIdsBox[e].forEach(((e,t)=>{this.mapClippingIds.set(t,e)}))}this.filter.enableStateChanged()}getMeshesByUserId(e){const t=this.tilesLoader.tileReader,i=this.getLengthUnitsMatrix(),r=t.getIndexByUserId(e),n=t.getUserIdBoxByIndex(r),a=this.getDescriptor().getUserIdInfoByUserId(r),s=this.getTransformMatrix();for(let t=0;t<a.length;++t){const o=a[t];if(!1===o.instanceOrNot){const t=o.tileId;for(const[a,o]of t)for(const t of o.keys()){let o={};o.boundingBox=n,o.unitsMatrix=i;const l=`${a}_${t}`,d=this.objectGroup.children[0].getObjectByName(l);if(!d)continue;o.mesh=d;let h=(new THREE.Matrix4).copy(s).multiply(o.mesh.matrix);o.matrix=h;const c=o.mesh.indexGroups.get(r);o.indexInfo=c,this.minDistanceObjects[e].push(o)}}else{const t=o.tileId;for(const[r,a]of t)for(const t of a.values()){let a={};a.boundingBox=n;const o=this.tilesLoader.getInstanceMeshNodeById(`${r}_0`);if(!o)continue;a.mesh=o;let l=(new THREE.Matrix4).copy(s).multiply(a.mesh.matrix).multiply(t);o.matrixRoot&&l.multiply(o.matrixRoot),a.matrix=l,a.unitsMatrix=i,this.minDistanceObjects[e].push(a)}}}}getUserIdMapByFrustum(e){let t={},i=new THREE.Box3;var r=this.viewer.getScene().getRawMatrixGlobal();const n=this.transformMatrix,a=(this.tilesLoader.tileReader.getSearchTreeBuffer(),this.manager.explosionManager.isExploded(this.id));return this.getDescriptor().getAllUserIdInfoCallback((s=>{i.copy(this.tilesLoader.tileReader.getUserIdBoxByIndex(s.userId)),i.applyMatrix4(n).applyMatrix4(r),(e.intersectsBox(i)||a)&&(t[s.userId]=!0)})),t}getRootGeoErrDistance(){const e=this.viewer.domElement.offsetHeight/this.viewer.camera.frustumHeightFactor;let t=new THREE.Vector3;return this._tileset.root._boundingBox.clone().applyMatrix4(this.transformMatrix).getSize(t),e*t.length()/this._tileset.maximumScreenSpaceError}getGeometryBuffersByUserId(e){let t=[];return this.getDescriptor().getUserIdInfoCallback(e,(e=>{!1===e.instanceOrNot?this.tilesLoader.batchedMeshManager.getGeometryBuffersByUserIdInfo(e,this.objectGroup.children[0],this.databagId,t):this.tilesLoader.instancedMeshManager.getGeometryBuffersByUserIdInfo(e,this.objectGroup.children[1],this.databagId,t)})),t}getMaterialByMaterialId(e,t){let i=null;e&&(i=this.materialManager.materialMap[e].clone());const r=this.getDescriptor().getUserIdInfoByUserId(t.userId);for(let e=0;e<r.length;++e){const t=r[e];if(!1===t.instanceOrNot){const e=t.tileId;for(const[t,r]of e)for(const e of r.keys()){const r=`${t}_${e}`,n=this.objectGroup.children[0].getObjectByName(r);n&&(i=n.material[0].clone())}}else{const e=t.tileId;for(const t of e.keys()){const e=this.tilesLoader.getInstanceMeshNodeById(`${t}_0`);e&&(i=e.material.clone())}}}return i.name=`${i.name}_outing`,i}setBorderLineVisible(e){super.setBorderLineVisible(e),this.materialManager.setBorderLineVisible(e)}setPackingMaterialEnable(e){this.materialManager.setPackingMaterialEnable(e)}setWireframeColor(e){this.materialManager.setWireframeColor(e);let t=this.filter.materialSelector.getFrozonMaterialV3(!0,0);t.setOutLineColor(e),t=this.filter.materialSelector.getFrozonMaterialV3(!0,2),t.setOutLineColor(e)}getWireframeColor(){return this.materialManager.getWireframeColor()}restoreWireframeColor(){this.materialManager.setWireframeColor(null)}_dealNonInstancedNodesForPicking(e,t,i,n,a){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getBatchedNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo;if(!this.filter._isPickable(i))return;const r=this.objectGroup.children[0].getObjectByName(e.meshId);r&&this.tilesLoader.batchedMeshManager.updatePickingMeshes(i,t,r,o,s,a)}))}t.add(s)}}_dealInstancedNodesForPicking(e,t,i,n,a){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getInstanceNodeInfoByUserIdCallback(t,(e=>{e.nodeInfo;const t=this.tilesLoader.getInstanceMeshNodeById(e.meshId);t&&this.tilesLoader.instancedMeshManager.updatePickingMeshes(t,o,e.matrix,s,a,e.index)}))}t.add(s)}}getMeshesForCap(e){let t=this.id;e[t]=new r.ObjectGroup,e[t].matrix.copy(this.getTransformMatrix()),e[t].matrixAutoUpdate=!1;const i=this.objectGroup.children[0],n=this.tilesLoader.batchedMeshManager.updatePickingMeshesStateForCap(i,this.materialManager);e[t].add(n);const a=this.objectGroup.children[1],s=this.tilesLoader.instancedMeshManager.updatePickingMeshesStateForCap(a,this.materialManager);e[t].add(s)}isUserIdVisible(e){let t=!1;const i=this.tilesLoader.tileReader.getIndexByUserId(e),r=this.getDescriptor().getUserIdInfoByUserId(i);for(let e=0;e<r.length;++e){const i=r[e];for(const e of i.tileId.keys())this.objectGroup.traverse((i=>{i.tileId===parseInt(e)&&(t=t||i.visible)}))}return t}calculateClippingContours(t){const i=this.manager.scene;let n=r.FillClipPlaneManager.getInstance(i),a=n.renderClipPlane;n.planeMesh;const s=r.FillClipPlaneManager.getFillClipPlaneBoundingBoxWorld(i);e.copy(this.transformMatrix).invert();const o=s.clone().applyMatrix4(e),l=this.id;n.capsIntersectContour[l]={};const d=this.manager.getScene().getInverseMatrixGlobal();let h=a.clone().applyMatrix4(d);this.tilesLoader.getDescriptor();t.map((e=>{const t=this.tilesLoader.tileReader.getIndexByUserId(e),i=this.tilesLoader.tileReader.getUserIdBoxByIndex(t).clone().applyMatrix4(this.transformMatrix);if(!i.intersectsPlane(h)&&!i.intersectsBox(o))return;const r=this.transformMatrix,d=n.capsIntersectContour,c=this.getDescriptor().getUserIdInfoByUserId(t);for(let i=0;i<c.length;++i){const n=c[i],o={modelId:l,plane:a,planeBoxWorld:s,userIndex:t,stringId:e,userIdInfo:n,modelTransform:r,capsIntersectContour:d};n.instanceOrNot?(o.plane=h,this.tilesLoader.instancedMeshManager.calculateClippingContours(o)):this.tilesLoader.batchedMeshManager.calculateClippingContours(o)}}))}getIntersectsByUserId(e,t,i){const{userId:r,unitScale:n}=i,a=parseInt(r),s=this.getDescriptor().getUserIdInfoByUserId(a);for(let i=0;i<s.length;++i){const r=s[i];if(!1===r.instanceOrNot){const i=r.tileId;for(const[r,s]of i)for(const i of s.keys()){const s=`${r}_${i}`,o=this.objectGroup.children[0].getObjectByName(s),l=o.indexGroups.get(a);let d=[];o.raycastByIndices(e,d,l,null,n),d.length>0&&(d[0].indexInfo=l,t.push(d[0]))}}else{const i=r.tileId;for(const[r,a]of i)for(const i of a.values()){const a=this.tilesLoader.getInstanceMeshNodeById(`${r}_0`);if(a){let r=[];a.raycastByIndices(e,r,null,i,n),r.length>0&&t.push(r[0])}}}}return t.sort(((e,t)=>e.distance-t.distance)),t}getObjectsInBoxByBimtile(e,t,i,r){const n=this.tilesLoader.tileReader;n.getAllUserIndexCallback((i=>{if(2!==(e=>!!t.intersectsBox(e)&&(r(e)?1:2))(n.getUserIdDrawingBoxByIndex(i,this)))return;const a=this.getRealUserId(i);e[a]=!0}))}getBatchedUserIdArray(){const e=this.getDescriptor().getBatchedUserIds();let t=new Map,i=new THREE.Vector3;return e.map((e=>{const r=this.tilesLoader.tileReader.getUserIdBoxByIndex(e),n=this.getRealUserId(e);r.getSize(i),t.set(n,i.length())})),r.Utils.SortMapByValue(t)}getInstanceUserIdArray(){const e=this.getDescriptor().getInstanceUserIds();let t=new Map,i=new THREE.Vector3;return e.map((e=>{const r=this.tilesLoader.tileReader.getUserIdBoxByIndex(e),n=this.getRealUserId(e);r.getSize(i),t.set(n,i.length())})),r.Utils.SortMapByValue(t)}updatePickingMaterial(){this.pickHelper.updatePickingMaterial()}applyBlink(){this.filter.enableStateChanged(),this.filter.enableWireFrameStateChanged()}clearBlink(){this.filter.enableStateChanged(),this.filter.enableWireFrameStateChanged()}loadBusinessResources(e){e&&e()}enableCSM(e){this.objectGroup.castShadowIgnoreVisible=e;const t=this.tilesLoader.jsonLoader,i=this.tilesLoader.tileReader.globalShadowUrl;this._tileset.shadowMapManager.enableCSM(e,i,t,(()=>{this.manager.setRenderStateChanged(!0)}));this.viewer.getScene().lightManager.receivingPlane}enableOverrideWithSameParameter(e){this.materialManager.enableOverrideWithSameParameter(e)}checkLodMeshValid(){const e=this.objectGroup.children[1];let t=!0;return e.children.map((e=>{if(0==e.visible)return;const i=e.children;let r=0;i.map((e=>{1==e.visible&&r++})),1!==r&&(t=!1)})),t}getTileInfoByUserId(e){const t=this.tilesLoader.tileReader.getIndexByUserId(e),i=this.getDescriptor();let r=[];const n=this._tileset._selectedTiles,a=i.userIdInfoMap.get(t);if(a){const e=a.tileId;for(const t of e.keys())n.map((e=>{e.contentId===t&&r.push({tileId:t,contentUrl:e.contentUrl})}))}const s=i.userIdInstanceInfoMap.get(t);if(s){const e=s.tileId;for(const t of e.keys())n.map((e=>{e.contentId===t&&r.push({tileId:t,contentInsModel:e.contentInsModel})}))}return r}_downloadPMTexture(e,t,i){var r=new THREE.FileLoader;r.setResponseType("arraybuffer");const n=new THREE.DataTexture(null,0,0,THREE.RGBAFormat,THREE.FloatType);return r.load(e,(function(e){var i=new Float32Array(e);let r=i.length/4096;n.image.data=i,n.image.width=1024,n.image.height=r,n.needsUpdate=!0,n.generateMipmaps=!1,n.magFilter=THREE.NearestFilter,n.minFilter=THREE.NearestFilter,t&&t()}),void 0,i),n}}r.BimTilesModelV3=t}(),function(){class e extends r.BimTilesPickingManager{constructor(e,t){super(e,t),this._matrix=new THREE.Matrix4}destroy(){super.destroy()}needsUpdate(e){const t=this.model.getDescriptor().tileUserIdMap.get(e.contentId);if(t.size<=this.selectedIdMap.size){for(let e of t.keys())if(this.selectedIdMap.has(e))return!0}else for(let e of this.selectedIdMap.keys())if(t.has(e))return!0;return!1}cloneInstanceGeometry(e){const t=new THREE.InstancedBufferGeometry;t.setAttribute("id",e.getAttribute("id")),t.setAttribute("position",e.getAttribute("position")),e.getAttribute("barycentric")&&t.setAttribute("barycentric",e.getAttribute("barycentric")),t.setAttribute("mcol0",e.getAttribute("mcol0")),t.setAttribute("mcol1",e.getAttribute("mcol1")),t.setAttribute("mcol2",e.getAttribute("mcol2")),t.setAttribute("mcol3",e.getAttribute("mcol3")),t.setAttribute("vState",e.getAttribute("vState").clone()),t.getAttribute("vState").array.fill(0);const i=e.getAttribute("vState").count,r=[],n=new THREE.Color(1170103);for(let e=0;e<i;++e)r.push(n.r,n.g,n.b,.3);const a=new THREE.InstancedBufferAttribute(new Float32Array(r),4,!1,1);return t.setAttribute("aColor",a),t.setIndex(e.getIndex()),t}createBatchedLineSegmentsMesh(e,t,i){let n=[];if(e.length===t.size){const e=i.index;n.push({indexCount:e.count,indexEnd:e.count,indexStart:0})}else e.map((e=>{const i=t.get(e);n.push(i)}));let a=new r.LineSegmentsPickGeometryCreaetor(i,n).getGeometry(),s=new r.LineSegmentsHighLightMaterial({color:3330982});return new r.LineSegmentsPickMesh(a,s)}createBatchedMesh(e,t,i,n){const a=r.EnumElementState.NONE;let s=new THREE.Mesh(i,r.MaterialUtil.DefaultCloudMaterial),o=!1,l=null;if(Array.isArray(n.material)?n.material.length>0&&(l=n.material[0]):l=n.material,l&&null!=l.useBCOutline&&(o=l.useBCOutline),s.material=[r.MaterialUtil.getDefaultSelectedMaterialV3(o)],l.growthAnimationPlanes&&(s.material[0]=s.material[0].clone(),s.material[0].growthAnimationPlanes=l.growthAnimationPlanes,s.material[0].growthAnimationMap=l.growthAnimationMap,s.material[0].growthAnimationMapSizeWidth=l.growthAnimationMapSizeWidth,s.material[0].growthAnimationMapSizeHeight=l.growthAnimationMapSizeHeight,s.material[0].defines.CLOUDSTANDARDBATCHEDV3="",s.material[0].refreshUniforms()),s.material[0].setBorderLineVisible(o),r.Utils.defined(n.selectedMeshes)||(n.selectedMeshes=[]),n.selectedMeshes.push(s),e.length===t.size){const e=n.geometry.groups[0];return e&&n.material[e.materialIndex]&&(s.material[0].clippingPlanes=n.material[e.materialIndex].clippingPlanes,s.material[0].clipIntersection=n.material[e.materialIndex].clipIntersection),s.geometry.addGroup(0,i.index.count,a),s}return e.map((e=>{const i=t.get(e);for(let e=0;e<n.geometry.groups.length;++e){const t=n.geometry.groups[e];if(i.indexStart>=t.start&&i.indexEnd<=t.start+t.count-1&&n.material[t.materialIndex]){const e=n.material[t.materialIndex].clippingPlanes;s.material[0].clippingPlanes=e,s.material[0].clipIntersection=n.material[t.materialIndex].clipIntersection}}s.geometry.addGroup(i.indexStart,i.indexCount,a)})),s}updatePickingMeshes(e){!0===e.isInstanceTile&&e.enableDynamicInstanceLod()?this.updateLodPickingMeshes(e):super.updatePickingMeshes(e)}updateLodPickingMeshes(e){const t=e.realLodLevel;this.stateChangedRenderer===e.stateLodChangedRenderer[t]&&this.selectionChangedRenderer===e.selectionLodChangedRenderer[t]||(this.needsUpdate(e)?(this.stateChangedRenderer=e.stateChangedRenderer,e.selectionMeshes=[],this.updateInstancePickingMeshes(e),e.selectionLodChangedRenderer[t]=this.selectionChangedRenderer):e.selectionLodChangedRenderer[t]=this.selectionChangedRenderer)}updateBatchedPickingMeshes(e){e.content.meshes.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t||!t.indexGroups||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,n=t.indexGroups,a=this.getMatchedIds(n);if(0===a.length)return;let s=new THREE.BufferGeometry;s.setAttribute("id",i.getAttribute("id")),s.setAttribute("position",i.getAttribute("position")),i.getAttribute("barycentric")&&s.setAttribute("barycentric",i.getAttribute("barycentric"));i.getAttribute("uv");s.setIndex(i.getIndex());let o="LineSegmentsEx"===t.type?this.createBatchedLineSegmentsMesh(a,n,s,t):this.createBatchedMesh(a,n,s,t);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.Component,o._indicesGroup=n,o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,this._dirty=!0,e.selectionMeshes.push(o),this.selectedMeshes.add(o)}))}_calculateInstanceIdArray(e,t){const i=Math.floor(e/256/256),r=Math.floor((e-65536*i)/256),n=e-65536*i-256*r;let a=[];for(let e=0;e<t;++e)a.push(0,i,r,n);return a}updateInstancePickingMeshes(e){const t=this.model.manager.explosionManager.isExploded(this.model.id);this.instanceMatrixListMap.clear();const i=e.content.meshes,n=this.model.getDescriptor().tileUserIdMap.get(e.contentId),a=this.getMatchedIds(n);0!==a.length&&i.traverse((i=>{if("MeshEx"!==i.type&&"LineSegmentsEx"!==i.type)return;if(!e.enableDynamicInstanceLod()&&r.TilesUtil.isInstanceNodeInVisible(i))return;if(e.enableDynamicInstanceLod()&&!i.insLodLevels[e.realLodLevel]||!i||void 0===i.geometry)return;const s=i.geometry,o=i.material instanceof Array?i.material[0]:i.material;let l=new THREE.BufferGeometry;l.setAttribute("position",s.getAttribute("position")),s.getAttribute("barycentric")&&l.setAttribute("barycentric",s.getAttribute("barycentric")),l.setIndex(s.getIndex());let d=[];if(a.length===n.size&&!t){let t=null;return l=this.cloneInstanceGeometry(s),t="LineSegmentsEx"===i.type?new THREE.LineSegments(l,r.MaterialUtil.getDefaultSelectedInstanceMaterialV3()):new r.MeshEx(l,r.MaterialUtil.getDefaultSelectedInstanceMaterialV3()),o.growthAnimationPlanes&&(t.material=t.material.clone(),t.material.growthAnimationPlanes=o.growthAnimationPlanes,t.material.growthAnimationMap=o.growthAnimationMap,t.material.growthAnimationMapSizeWidth=o.growthAnimationMapSizeWidth,t.material.growthAnimationMapSizeHeight=o.growthAnimationMapSizeHeight,o.defines&&o.defines.hasOwnProperty("CLOUDSTANDARDINSTANCEDV3")&&(t.material.defines.CLOUDSTANDARDINSTANCEDV3="",t.material.refreshUniforms())),t.material.defines.USE_COLORWITHOUTLIGHT="",t.material.setBorderLineVisible(!0),t.name=`${i.name}`,t.frustumCulled=!1,this._matrix.identity(),t.matrix.copy(i.matrix).multiply(this._matrix),i.matrixRoot&&(t.matrixRoot=i.matrixRoot),t.matrixAutoUpdate=!1,e.selectionMeshes.push(t),this.selectedMeshes.add(t),void(this._dirty=!0)}for(let n=0;n<a.length;++n){const s=a[n],h=this.model.getDescriptor().getInstanceMatrixListByUserIdAndTileId(s,e.contentId),c=new Uint8Array(this._calculateInstanceIdArray(s,l.getAttribute("position").count));l.setAttribute("id",new THREE.BufferAttribute(c,4,!0)),d.push(...h);for(let n=0;n<h.length;++n){const a=h[n];let d=null;if(d="LineSegmentsEx"===i.type?new THREE.LineSegments(l,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(l,r.MaterialUtil.getDefaultSelectedMaterialV3(!0)),o.growthAnimationPlanes&&(d.material=d.material.clone(),d.material.growthAnimationPlanes=o.growthAnimationPlanes,d.material.growthAnimationMap=o.growthAnimationMap,d.material.growthAnimationMapSizeWidth=o.growthAnimationMapSizeWidth,d.material.growthAnimationMapSizeHeight=o.growthAnimationMapSizeHeight,o.defines&&o.defines.hasOwnProperty("CLOUDSTANDARDINSTANCEDV3")&&(d.material.defines.CLOUDSTANDARDINSTANCEDV3="",d.material.refreshUniforms())),d.material.setBorderLineVisible(!0),d.name=`${i.name}_${s}`,d.frustumCulled=!1,this._matrix.identity(),t){const e=this.model.modelExplosion.getExplosionTranslation(s);this._matrix.makeTranslation(e.x,e.y,e.z)}d.matrix.copy(i.matrix).multiply(this._matrix).multiply(a),i.matrixRoot&&d.matrix.multiply(i.matrixRoot),d.matrixAutoUpdate=!1,e.selectionMeshes.push(d),this.selectedMeshes.add(d)}}this._dirty=!0,this.instanceMatrixListMap.set(i.name,d)}))}}r.BimTilesPickingManagerV3=e}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BimTilesModelExplosion{constructor(e){super(e),this._explosionTileBoundingBoxes={}}destroy(){this._explosionTileBoundingBoxes=null,super.destroy()}explode(){this.model._tileset.explode(this)}preFloorExplode(e,t,i){this.explosionBegin=!0;let n={},a={};for(var s=0,o=t.length;s<o;s++){let e=t[s].explodedHeight-t[s].elevation,r=new THREE.Vector3(i.x*e,i.y*e,i.z*e);n[t[s].name]=r;let o=null;o=t[s].preExplodedTranslation?r.clone().sub(t[s].preExplodedTranslation):r.clone(),a[t[s].name]=o,t[s].preExplodedTranslation=r}let l=this.explosionTranslation;const d=this.model.getDescriptor();let h=new THREE.Matrix4,c=new THREE.Matrix4,u=3;const p=this.model.tilesLoader.tileReader,m=p.getUserDataIndexKeyByString("levelName");r.Utils.defined(m)&&(u=m),this._initTileBoundingBox(),p.getAllUserIndexCallback((t=>{const i=p.getUserDataIndexByUserIndex(t);let r=p.getUserDataByIndex(i)[u],s=p.getUserDataStringMapByIndex(u,r)[1];const o=p.getUserIdBoxByIndex(t);let m=n[s]||new THREE.Vector3;l[t]=m,h.makeTranslation(m.x,m.y,m.z);let f=a[s]||new THREE.Vector3;c.makeTranslation(f.x,f.y,f.z);const g=d.getUserIdInfoByUserId(t);o.applyMatrix4(c),e.union(o),this._setTileBoundingBox(g,o)}));const f=this.model.getTransformMatrix();e.applyMatrix4(f),this._transformTileBoundingBox(f),this.model.filter.enableVisibleStateChanged()}preElementExplode(i,n,a){this.explosionBegin=!0;const s=this.model.getBoundingBoxWorld();if(!s)return;const o=n-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==o)return;let l=new THREE.Matrix4,d=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert(),a?t.copy(a):s.getCenter(t),t.applyMatrix4(e);const h=this.model.getDescriptor(),c=this.model.tilesLoader.tileReader;let u=this.explosionTranslation;this._initTileBoundingBox(),c.getAllUserIndexCallback((e=>{let a=new THREE.Box3;const s=c.getOriginUserIdBoxByIndex(e);a.union(s);let p=r.Utils.computeExplodeTranslation(t,a,n);u[e]=p,l.makeTranslation(p.x,p.y,p.z);let m=r.Utils.computeExplodeTranslation(t,a,o);d.makeTranslation(m.x,m.y,m.z),this.explosionOffset[e]=m;const f=h.getUserIdInfoByUserId(e);s.applyMatrix4(l),c.setChangedUserIdBoxByIndex(e,s),i.union(s),this._setTileBoundingBox(f,s)}));const p=this.model.getTransformMatrix();i.applyMatrix4(p),this._transformTileBoundingBox(p),this.model.filter.enableVisibleStateChanged()}getLevelNameByObjId(e){const t=this.model.tilesLoader.tileReader,i=t.getIndexByUserId(e),n=t.getUserDataIndexByUserIndex(i),a=t.getUserDataByIndex(n);let s=3;const o=t.getUserDataIndexKeyByString("levelName");r.Utils.defined(o)&&(s=o);let l=a[s];return this.model.tilesLoader.tileReader.getUserDataStringMapByIndex(s,l)[1]}standardExplode(e){function t(e,t,n,a,s){const o=e.getAttribute("position").array;for(let e=t;e<n;e+=3)i.set(o[e],o[e+1],o[e+2]),i.applyMatrix4(s),i.add(a),r.copy(s).invert(),i.applyMatrix4(r),o[e]=i.x,o[e+1]=i.y,o[e+2]=i.z}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;let i=new THREE.Vector3,r=new THREE.Matrix4;const n=e._content.meshes,a=e._content._outlineContent.outlineMeshes;let s=new THREE.Vector3,o=new THREE.Vector3(0),l=e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.frustumCulled=!1;let i=e.geometry;const r=e.indexGroups;for(const[n,a]of r){let r=this.getExplosionTranslation(n),l=a.preTranslation?a.preTranslation:o;if(s.set(r.x-l.x,r.y-l.y,r.z-l.z),0==s.x&&0==s.y&&0==s.z)continue;const d=a.positionStart;t(i,d,d+a.positionCount,s,e.matrix),a.preTranslation=r}i.getAttribute("position").needsUpdate=!0,i.computeBoundingSphere()};n.traverse((e=>{l(e)})),a.traverse((e=>{l(e)})),e.explodeCount=this.model.manager.explosionManager.explodeCount}updateGeometryPosition(e,t,i,r){var n=e.getAttribute("mcol3").array;n[3*t]+=i.x,n[3*t+1]+=i.y,n[3*t+2]+=i.z,e.getAttribute("mcol3").needsUpdate=!0}instanceLodExplode(e){const t=e.realLodLevel;if(e.explodeLodCount[t]==this.model.manager.explosionManager.explodeCount)return;const i=e.instanceInfo.entityInfoArray;let r=new THREE.Vector3,n=new THREE.Vector3(0);const a=e._content._lodMeshMap[t][0];if(a.frustumCulled=!1,a.explodeCount!==this.model.manager.explosionManager.explodeCount){for(let e=0,t=i.length;e<t;e++){const t=i[e].userID;let s=this.getExplosionTranslation(t),o=n;i[e].preTranslation&&i[e].preTranslation[a.uuid]&&(o=i[e].preTranslation[a.uuid]),r.set(s.x-o.x,s.y-o.y,s.z-o.z),0==r.x&&0==r.y&&0==r.z||(this.updateGeometryPosition(a.geometry,e,r),i[e].preTranslation||(i[e].preTranslation={}),i[e].preTranslation[a.uuid]=s)}a.explodeCount=this.model.manager.explosionManager.explodeCount,e.explodeLodCount[t]=this.model.manager.explosionManager.explodeCount}else e.explodeLodCount[t]=this.model.manager.explosionManager.explodeCount}instanceExplode(e){if(e.enableDynamicInstanceLod())return void this.instanceLodExplode(e);if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;const t=e.instanceInfo.entityInfoArray;let i=new THREE.Vector3,r=new THREE.Vector3(0);const n=e._content.meshes.children[0],a=e._content._outlineContent.outlineMeshes.children[0];n.frustumCulled=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e].userID;let o=this.getExplosionTranslation(s),l=r;t[e].preTranslation&&(l=t[e].preTranslation),i.set(o.x-l.x,o.y-l.y,o.z-l.z),0==i.x&&0==i.y&&0==i.z||(this.updateGeometryPosition(n.geometry,e,i),a&&a.geometry&&this.updateGeometryPosition(a.geometry,e,i),t[e].preTranslation=o)}e.explodeCount=this.model.manager.explosionManager.explodeCount}_initTileBoundingBox(){const e=this._explosionTileBoundingBoxes;for(const t in e)if(Object.hasOwnProperty.call(e,t)){e[t].makeEmpty()}}_setTileBoundingBox(e,t){const i=this._explosionTileBoundingBoxes;e.forEach((e=>{const r=e.tileId.keys();for(const e of r)void 0===i[e]&&(i[e]=new THREE.Box3),i[e].union(t)}))}_transformTileBoundingBox(e){if(r.Math.isIdentityMatrix4(e))return;const t=this._explosionTileBoundingBoxes;for(const i in t)if(Object.hasOwnProperty.call(t,i)){t[i].applyMatrix4(e)}}getTileBoundingBoxByTileId(e){return this._explosionTileBoundingBoxes[e]}}r.BimTilesModelExplosionV3=i}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(e),this.growthAnimationMap=e.growthAnimationMap,this.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth,this.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight,this.growthAnimationPlanes=e.growthAnimationPlanes,this.type="PickingMaterial",this.defines.CNORMAL="",this.side=THREE.DoubleSide,this.clipping=!0,e.instancing&&(this.defines.USE_INSTANCE=""),this.defines.update=0,this.vertexShader="\n                #define CLOUDSTANDARDBATCHEDV3\n                attribute vec4 id;\n\n                uniform vec3 cameraPos;\n                \n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n\n\n                #include <CompressNormal_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <cloud_state_pars_vertex>\n\n                void main() {\n                    vec3 transformed = vec3( position );\n\n                    vec3 objectNormal = vec3( normal );\n                    #ifdef CNORMAL \n                        objectNormal = octDecode();\n                    #endif\n                    vec3 transformedNormal = objectNormal;\n                    vec4 mvPosition = vec4( transformed, 1.0 );\n                    vNormal = normalize( transformedNormal );\n                    vId = vec4(id.a,id.b,id.g,id.r);\n                    mvPosition = modelViewMatrix * mvPosition;\n                    vViewPosition = - mvPosition.xyz;\n                    // Using mvPosition and then converting on the CPU side reduces errors\n                    vPosition =  modelMatrix * vec4( position, 1.0 );\n                    gl_Position = projectionMatrix * mvPosition;\n\n                    #include <clipping_planes_vertex>\n                    #include <cloud_state_vertex>\n                }\n            ",this.fragmentShader="\n                precision highp float;\n                precision highp int;\n                #define CLOUDSTANDARDBATCHEDV3\n\n                uniform bool pickable;\n                uniform bool localClipping;\n                \n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n\n                #include <compare_function>\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <cloud_state_pars_fragment>\n                // vId在growthAnimation_pars_fragment中\n                #include <growthAnimation_pars_fragment>\n\n                void main() {\n\n                    // #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4(0.0,0.0,0.0,0.0);\n                    vec4 withoutLightColor = diffuseColor;\n                    #include <cloud_state_fragment>\n\n                    if (!localClipping)\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                    else\n                    {\n                        #include <num_clipping_planes_for_bimtilepick_fragment>\n                    }\n\n                    #include <growthAnimation_fragment>\n\n                    // 隔离构件\n                    if (pickable && (floatEqual(componentState, ElementState_TRANSPARENT) || floatEqual(componentState, ElementState_DEACTIVATE)))\n                    {\n                        discard;\n                    }\n\n                    //gId = vId;\n                    // write normals to G-Buffer\n                    //gId = vec4( 1.0,1.0,1.0, 0.0 );\n                    //gNormal = vec4( normalize( vNormal ), 0.0 );\n                    //gPosition = vPosition;\n                    gl_FragColor = vId;\n\n                    // #if NUM_CLIPPING_PLANES < 3\n                    //     gl_FragColor = vec4( 1.0,1.0,1.0, 0.0 );\n                    // #endif\n\n                }\n            ",this.uniforms={pickable:{value:!0},localClipping:{value:!1},growthAnimationMap:{value:this.growthAnimationMap},growthAnimationMapSizeWidth:{value:this.growthAnimationMapSizeWidth},growthAnimationMapSizeHeight:{value:this.growthAnimationMapSizeHeight},growthAnimationPlanes:{value:this.growthAnimationPlanes}}}refreshUniforms(){super.refreshUniforms&&super.refreshUniforms(),this.uniforms={pickable:{value:!0},localClipping:{value:this.uniforms.localClipping.value},growthAnimationMap:{value:this.growthAnimationMap},growthAnimationMapSizeWidth:{value:this.growthAnimationMapSizeWidth},growthAnimationMapSizeHeight:{value:this.growthAnimationMapSizeHeight},growthAnimationPlanes:{value:this.growthAnimationPlanes}}}setLocalClipping(e){this.uniforms.localClipping.value=e}set needsUpdate(e){!0===e&&(this.version++,this.defines.update++)}}r.PickingMaterial=e;class t extends r.PickingMaterial{constructor(e){super(e),this.type="PickingInstanceMaterial",this.defines.USE_INSTANCE="",this.vertexShader="\n                #define CLOUDSTANDARDINSTANCEDV3\n                attribute vec4 id;\n                attribute float vClipping;\n\n                uniform vec3 cameraPos;\n\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n\n                attribute vec4 vState;\n\n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying float componentState;\n                varying vec3 vViewPosition;\n                varying float fClipping;\n\n\n                #include <matrix_transform_pars_vertex>\n                #include <common>\n                #include <CompressNormal_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n\n                #include <compare_function>\n\n                void main() {\n                    vec3 transformed = vec3( position );\n\n                    vec3 objectNormal = vec3( normal );\n\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <Transform_pars_vertex>\n                    \n                    vec4 mvPosition = vec4( transformed, 1.0 );\n                    vec3 transformedNormal = objectNormal;\n                    mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                    normalMat = inverse_mat3(normalMat);\n                    normalMat = transposeMat3(normalMat);\n                    transformedNormal = normalMat * objectNormal;\n                    vNormal = normalize( transformedNormal );\n                    vId = vec4(id.r,id.g,id.b,id.a);\n                    fClipping = vClipping;\n                    mvPosition = modelViewMatrix * mvPosition;\n                    vViewPosition = - mvPosition.xyz;\n                    // Using mvPosition and then converting on the CPU side reduces errors\n                    vPosition =  modelMatrix * vec4( transformed, 1.0 );\n                    gl_Position = projectionMatrix * mvPosition;\n                    \n                    componentState = vState.r;\n                    \n                    #include <clipping_planes_vertex>\n                }\n\n            ",this.fragmentShader="\n                precision highp float;\n                precision highp int;\n                #define CLOUDSTANDARDINSTANCEDV3\n\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n                varying float fClipping;\n\n\n                uniform bool pickable;\n                uniform bool localClipping;\n\n                #include <compare_function>\n\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <cloud_state_pars_fragment>\n                // vId在growthAnimation_pars_fragment中\n                #include <growthAnimation_pars_fragment>\n\n                void main() {\n\n                    //#include <clipping_planes_fragment>\n                    \n                    vec4 diffuseColor = vec4(0.0,0.0,0.0,0.0);\n                    //#include <cloud_state_fragment>\n\n                    if (!localClipping)\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                    else\n                    {\n                        #include <num_clipping_planes_for_bimtilepick_fragment>\n                    }\n\n                    #include <growthAnimation_fragment>\n                    \n                    if (floatEqual(componentState, ElementState_HIDDEN))\n                    {\n                        discard;\n                    }\n\n                    if (pickable && (floatEqual(componentState, ElementState_TRANSPARENT)|| floatEqual(componentState, ElementState_DEACTIVATE)))\n                    {\n                        discard;\n                    }\n\n                    //gId = vId;\n                    // write normals to G-Buffer\n                    //gId = vec4( 1.0,1.0,1.0, 0.0 );\n                    //gNormal = vec4( normalize( vNormal ), 0.0 );\n                    //gPosition = vPosition;\n                    gl_FragColor = vId;\n\n                }\n            "}}r.PickingInstanceMaterial=t}(),function(){let e=new THREE.Box3;r.BimTileGpuPickingManagerV1=class{constructor(e,t){this.idRenderTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.pixelBufferId=new Uint8Array(4),this.viewer=e.viewer,this.model=t,this.idPickingMaterial=new r.PickingMaterial({}),this.idPickingInstanceMaterial=new r.PickingInstanceMaterial({}),this.idPickingMaterial.growthAnimationMap=this.idPickingInstanceMaterial.growthAnimationMap=t.userIdAnimationMap,this.idPickingMaterial.growthAnimationMapSizeWidth=this.idPickingInstanceMaterial.growthAnimationMapSizeWidth=t.USERID_ANIMATION_MAP_WIDTH,this.idPickingMaterial.growthAnimationMapSizeHeight=this.idPickingInstanceMaterial.growthAnimationMapSizeHeight=t.USERID_ANIMATION_MAP_HEIGHT,this.idPickingMaterial.growthAnimationPlanes=this.idPickingInstanceMaterial.growthAnimationPlanes=t.viewer.growthAnimationManager.planeUniform.value,this.idPickingMaterial.refreshUniforms(),this.idPickingInstanceMaterial.refreshUniforms(),this.idPickingMaterial.needsUpdate=!0,this.idPickingInstanceMaterial.needsUpdate=!0,this.selectLineDistance=16}destroy(){this.idRenderTarget=null,this.pixelBufferId=null,this.idPickingMaterial=null,this.idPickingInstanceMaterial=null,this.viewer=null,this.model=null}readMultipleRenderTargetPixels(e,t,i,r,n,a,s,o,l){let d=e.properties.get(t).__webglFramebuffer;const h=e.getContext();let c=e.getRenderTarget();if(d){e.state.bindFramebuffer(h.FRAMEBUFFER,d);var u=[h.COLOR_ATTACHMENT0,h.COLOR_ATTACHMENT1,h.COLOR_ATTACHMENT2,h.COLOR_ATTACHMENT3];h.readBuffer(u[l]);try{const l=i,d=(l.format,l.type);let u=h.FLOAT;d===THREE.UnsignedByteType&&(u=h.UNSIGNED_BYTE),r>=0&&r<=t.width-a&&n>=0&&n<=t.height-s&&h.readPixels(r,n,a,s,h.RGBA,u,o)}finally{const t=null!==c?e.properties.get(c).__webglFramebuffer:null;e.state.bindFramebuffer(h.FRAMEBUFFER,t)}}}renderOnePixel(e,t,i,n,a){const s=r.DomUtil.getContainerOffsetToClient(e.domElement);let o=!0===i.isPerspective?i.perspectiveCamera:i.orthoCamera;o.setViewOffset(e.domElement.width,e.domElement.height,(n.x-s.left)*window.devicePixelRatio|0,(n.y-s.top)*window.devicePixelRatio|0,1,1),e.setRenderTarget(this.idRenderTarget),e.clear(),t.overrideMaterial=this.idPickingMaterial,this.model.objectGroup.children[0].visible=!0,e.render(t,i),t.overrideMaterial=this.idPickingInstanceMaterial,this.model.objectGroup.children[0].visible=!1,this.model.objectGroup.children[1].visible=!0,e.render(t,i),this.pixelBufferId.fill(-1),e.readRenderTargetPixels(this.idRenderTarget,0,0,1,1,this.pixelBufferId);const l=this.pixelBufferId[3]+256*this.pixelBufferId[2]+256*this.pixelBufferId[1]*256;o.clearViewOffset(),a.set(l,!0)}renderMultiPixel(e,t,i,n,a){const s=this.selectLineDistance/2,o=this.selectLineDistance;this.idRenderTarget.setSize(o,o),this.pixelBufferId=new Uint8Array(4*o*o);const l=r.DomUtil.getContainerOffsetToClient(e.domElement);let d=!0===i.isPerspective?i.perspectiveCamera:i.orthoCamera;d.setViewOffset(e.domElement.width,e.domElement.height,(n.x-l.left)*window.devicePixelRatio-s|0,(n.y-l.top)*window.devicePixelRatio-s|0,o,o),e.setRenderTarget(this.idRenderTarget),e.clear(),t.overrideMaterial=this.idPickingMaterial,this.model.objectGroup.children[0].visible=!0,e.render(t,i),t.overrideMaterial=this.idPickingInstanceMaterial,this.model.objectGroup.children[0].visible=!1,this.model.objectGroup.children[1].visible=!0,e.render(t,i),this.pixelBufferId.fill(-1),e.readRenderTargetPixels(this.idRenderTarget,0,0,o,o,this.pixelBufferId);const h=o*o;for(let e=0;e<h;e++){const t=this.pixelBufferId[4*e+3]+256*this.pixelBufferId[4*e+2]+256*this.pixelBufferId[4*e+1]*256;0!==t&&a.set(t,0)}d.clearViewOffset()}render(t,i,n,a,s){if(!1===this.model.objectGroup.visible)return null;const{raycaster:o,modelTransform:l,inverseMatrixGlobal:d,isExploded:h,modelManager:c,pickable:u}=s;let p=r.Utils.scratchMatrix4_1;p.copy(l).invert();let m=o.ray.clone().applyMatrix4(d).applyMatrix4(p);const f=this.model.getRawBoundingBox();if(!h&&m.intersectBoxWithDistance(f)<0)return null;const g=t.getRenderTarget(),v=i.overrideMaterial,y=t.autoClear;t.autoClear=!1,this.model.objectGroup.children.forEach((e=>{e.visible=!1}));let M=!1;!h&&this.model._tileset._selectedTiles.map((e=>{m.intersectBoxWithDistance(e.boundingBox)<0?e.content.meshes.visible=!1:!0===e.content.hasLine&&(M=!0)}));let E=new Map;E.set(0,!0),this.idPickingMaterial.uniforms.pickable.value=u,this.idPickingInstanceMaterial.uniforms.pickable.value=u,1==M?this.renderMultiPixel(t,i,n,a,E):this.renderOnePixel(t,i,n,a,E),i.overrideMaterial=v,t.setRenderTarget(g),t.autoClear=y,this.model.objectGroup.children.forEach((e=>{e.visible=!0})),this.model._tileset._selectedTiles.map((e=>{e.isHideByFilter||(e.content.meshes.visible=!0)}));const x=c.getSceneUnit()===r.EnumLengthlUnits.Meter?.001:1,_=r.GlobalData.LineSelectRange/2*x,b=this.model.filter,I=b._hasVisibleFilter(),T=b._hasPickableFilter();((e,t)=>{var i=c.isHiddenSourceObjectUserId(e.userId,this.model.id);if(t){if(I&&!b._isVisible(e)||T&&!b._isPickable(e)||i)return!0}else if(I&&!b._isVisible(e)||i)return!0;return!1})({userId:0,name:0},u)&&E.delete(0);let S=new THREE.Vector3,C=(e,t,i,r)=>{let n=e.clone();return!0===i&&(n.getSize(S),S.x<.001||S.y<.001?n.expandByScalar(r):(n.min.z-=r,n.max.z+=r)),m.intersectBoxWithDistance(n)},w=e=>!e||!e.parent||!1===e.visible||!1===e.parent.visible;const R=this.model.getDescriptor(),B=this.model.tilesLoader.tileReader;let A=[];for(const t of E.keys())R.getUserIdInfoCallback(t,(i=>{let r=B.getUserIdBoxByIndex(i.userId);if(h&&B.getChangedUserIdBoxByIndex(i.userId)&&(r=B.getChangedUserIdBoxByIndex(i.userId)),!r)return;e.copy(r);let n=C(e,0,this.model.is2D,_);if(n<0)return;if(0==i.instanceOrNot){const e=i.tileId;for(const[r,a]of e)for(const e of a.keys()){const a=`${r}_${e}`,s=this.model.tilesLoader.getMeshNodeById(a);if(!s)continue;if(w(s)&&!b._isTransparent({name:i.userId}))continue;const o=s.indexGroups.get(t);if(!o)continue;const d=o;d.userId=t,delete d.isExploded,h&&(d.isExploded=!0),A.push({meshNode:s,distance:n,nodeInfo:d,meshId:a,modelTransform:l})}return}const a=i.tileId;for(const[e,r]of a)for(const a of r.values()){const r=this.model.tilesLoader.getInstanceMeshNodeById(`${e}_0`);if(!r)continue;if(w(r)&&!b._isTransparent({name:i.userId}))continue;let s={instanceOrNot:!0,userId:t};r.matrixRoot?s.matrix=a.clone().multiply(r.matrixRoot):s.matrix=a,delete s.isExploded,h&&(s.isExploded=!0),A.push({meshNode:r,distance:n,nodeInfo:s,meshId:`${e}_0`})}}));A.sort(((e,t)=>e.distance-t.distance));let P=[],L=this,O=function(e,t,i,r,n,a){const s=e.material[0]||e.material,l=s.side;s.side=THREE.DoubleSide,e.raycastByIndices(o,t,i,r,x,a),s.side=l;const d=L.model.filter.getLocalClippingList(),h=L.model.tilesLoader.tileReader.getUserIdByIndex(n);return L.model.filter._hasLocalClipping()&&!d.get(h)||(t=t.filter((e=>!L.viewer.clipPoint(e.point)&&e))),t.sort(((e,t)=>e.distance-t.distance)),t};for(let e=0;e<A.length&&null!==A[e];e++){let t=[],i=A[e].nodeInfo,r=null,n=i;if(i.instanceOrNot){if(r=i.matrix,h){const e=this.model.modelExplosion.getExplosionTranslation(i.userId);r=(new THREE.Matrix4).makeTranslation(e.x,e.y,e.z).multiply(r)}n=null}if(t=O(A[e].meshNode,t,n,r,i.userId,l),0===t.length)continue;t[0].userId=i.userId,i.instanceOrNot?t[0].matrix=i.matrix:t[0].indexInfo=i,t[0].meshId=A[e].meshId,P.push(t[0]);let a=t[0].distance;t.map((e=>{e.distance<a&&(a=e.distance)}));for(let t=e+1;t<A.length&&null!==A[t];t++)A[t].distance<=a||(A[t]=null)}return P.sort(((e,t)=>e.distance-t.distance)),P[0]}getMaterials(){return[this.idPickingMaterial,this.idPickingInstanceMaterial]}updatePickingMaterial(){this.getMaterials().forEach((e=>{e.needsUpdate=!0}))}}}(),(()=>{class e extends r.CloudStandardMaterial{constructor(e){super(e),this.type="cloudStandardV3",this.useGlobalOpacity=!1,this.globalOpacity=this.opacity,this.packingMatMap=null,this.growthAnimationPlanes=null,this.growthAnimationMap=null,this.growthAnimationMapSizeWidth=-1,this.growthAnimationMapSizeHeight=-1,null!=e&&null!=e&&(void 0!==e.packingMatTexture&&(this.packingMatMap=e.packingMatTexture),void 0!==e.growthAnimationMap&&(this.growthAnimationMap=e.growthAnimationMap),null!=e.growthAnimationMapSizeWidth&&(this.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth),null!=e.growthAnimationMapSizeHeight&&(this.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight),null!=e.growthAnimationPlanes&&(this.growthAnimationPlanes=e.growthAnimationPlanes)),this.vertexShader=THREE.ShaderChunk.cloudStandardVertexV3,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragmentV3,this.useBCOutline=!1,this.borderLineVisible=!0,this.packingMaterialEnable=r.GlobalData.IsPackingMaterialEnable,this.uniforms.packingMatMap={value:null},this.outLineColor=new THREE.Color(.3,.3,.3),this.uLineTexture=r.LineTextureManager.uLineTexture,this.usePreShadow=!1,this.skipShadowCal=!1,e&&e.hasOwnProperty("useBCOutline")&&(this.useBCOutline=e.useBCOutline),e&&e.hasOwnProperty("borderLineVisible")&&(this.borderLineVisible=e.borderLineVisible),e&&e.hasOwnProperty("packingMaterialEnable")&&(this.packingMaterialEnable=e.packingMaterialEnable),e&&e.hasOwnProperty("outLineColor")&&(this.outLineColor=e.outLineColor),e&&e.hasOwnProperty("isShadowExterior")&&(this.usePreShadow=e.isShadowExterior),this.uniforms.outLineColor={value:this.outLineColor},this.uniforms.uLineTexture={value:this.uLineTexture},this.uniforms.useGlobalOpacity={value:this.useGlobalOpacity},this.uniforms.usePreShadow={value:this.usePreShadow},this.uniforms.skipShadowCal={value:this.skipShadowCal},this.uniforms.globalOpacity={value:this.globalOpacity},this.uniforms.growthAnimationMap={value:this.growthAnimationMap},this.uniforms.growthAnimationMapSizeWidth={value:this.growthAnimationMapSizeWidth},this.uniforms.growthAnimationMapSizeHeight={value:this.growthAnimationMapSizeHeight},this.uniforms.growthAnimationPlanes={value:this.growthAnimationPlanes}}setBorderLineVisible(e){this.borderLineVisible=e,this.useBCOutline&&this.borderLineVisible?this.defines.USE_BC_OUTLINE="":delete this.defines.USE_BC_OUTLINE}setOutLineColor(e){e?(this.outLineColor=e,this.uniforms.outLineColor={value:this.outLineColor}):(this.outLineColor=new THREE.Color(.3,.3,.3),this.uniforms.outLineColor={value:this.outLineColor})}setPackingMaterialEnable(e){this.packingMaterialEnable=e,null!=this.packingMatMap&&e?this.defines.USE_PACKINGMAT="":delete this.defines.USE_PACKINGMAT}copy(e){return this.useBCOutline=e.useBCOutline,this.borderLineVisible=e.borderLineVisible,this.packingMatMap=e.packingMatMap,this.packingMaterialEnable=e.packingMaterialEnable,this.outLineColor=e.outLineColor,this.uLineTexture=e.uLineTexture,this.growthAnimationMap=e.growthAnimationMap,this.growthAnimationMapSizeWidth=e.growthAnimationMapSizeWidth,this.growthAnimationMapSizeHeight=e.growthAnimationMapSizeHeight,this.growthAnimationPlanes=e.growthAnimationPlanes,super.copy(e),this}refreshUniforms(){super.refreshUniforms(),this.useBCOutline&&this.borderLineVisible?this.defines.USE_BC_OUTLINE="":delete this.defines.USE_BC_OUTLINE,null!=this.packingMatMap&&(this.uniforms.packingMatMap.value=this.packingMatMap,this.packingMaterialEnable?this.defines.USE_PACKINGMAT="":delete this.defines.USE_PACKINGMAT),this.uniforms.outLineColor={value:this.outLineColor},this.uniforms.uLineTexture={value:this.uLineTexture},this.uniforms.useGlobalOpacity={value:this.useGlobalOpacity},this.uniforms.skipShadowCal={value:this.skipShadowCal},this.uniforms.globalOpacity={value:this.globalOpacity},this.uniforms.growthAnimationMap={value:this.growthAnimationMap},this.uniforms.growthAnimationMapSizeWidth={value:this.growthAnimationMapSizeWidth},this.uniforms.growthAnimationMapSizeHeight={value:this.growthAnimationMapSizeHeight},this.uniforms.growthAnimationPlanes={value:this.growthAnimationPlanes}}}r.CloudStandardMaterialV3=e})(),(()=>{class e extends r.CloudStandardMaterialV3{constructor(e){r.Utils.defined(e)&&e.hasOwnProperty("growthAnimationMap")&&void 0===e.growthAnimationMap&&(delete e.growthAnimationMap,delete e.growthAnimationMapSizeWidth,delete e.growthAnimationMapSizeHeight),super(e),this.type2="cloudStandardBatchedV3",this.vertexShader=THREE.ShaderChunk.cloudStandardBatchedVertexV3,this.fragmentShader=THREE.ShaderChunk.cloudStandardBatchedFragmentV3}refreshUniforms(){super.refreshUniforms()}}r.CloudStandardBatchedMaterialV3=e})(),(()=>{class e extends r.CloudStandardMaterialV3{constructor(e){r.Utils.defined(e)&&e.hasOwnProperty("growthAnimationMap")&&void 0===e.growthAnimationMap&&(delete e.growthAnimationMap,delete e.growthAnimationMapSizeWidth,delete e.growthAnimationMapSizeHeight),super(e),this.type2="cloudStandardInstanceV3",this.defines.SUPPORT_INSTANCE_MIRROR="",this.vertexShader=THREE.ShaderChunk.cloudStandardInstanceVertexV3,this.fragmentShader=THREE.ShaderChunk.cloudStandardInstanceFragmentV3,this.uniforms.runTime={value:0},this.uniforms.minZ={value:0},this.uniforms.maxZ={value:0},this.uniforms.localMinZ={value:0},this.uniforms.localMaxZ={value:0},this.uniforms.scaleX={value:0},this.uniforms.scaleY={value:0}}toStandardMaterial(){let e=new r.CloudStandardBatchedMaterialV3;return e.copy(this),e}refreshUniforms(){super.refreshUniforms()}}r.CloudStandardInstanceMaterialV3=e})(),function(){async function e(e){return new Promise((t=>{const i=new THREE.FileLoader(new THREE.LoadingManager);i.setCrossOrigin("anonymous"),i.setResponseType("json"),i.load(e,(e=>{t(e)}))}))}async function t(e){return new Promise((t=>{const i=new THREE.FileLoader(new THREE.LoadingManager);i.setCrossOrigin("anonymous"),i.setResponseType("arraybuffer"),i.load(e,(e=>{t(e)}))}))}async function i(e,t,i){return new Promise((r=>{const n=function(e,t,i){return e+`${t}/texture/lightmap-rgbm${i}.png`}(e,t,i);let a=new THREE.ImageLoader;a.setCrossOrigin("anonymous"),a.load(n,(e=>{r(e)}))}))}function n(e,t){return e+`${t}/uv2/uvs1-export.json`}function a(e,t){return e+`${t}/uv2/uvs1-export.buf`}r.BimTilesLightMapManager=class{constructor(e){this.lightMapCount=0,this.lightMapTextureMap={},this.bakingRootUrl=void 0,this.uv2MapItemMap=null,this.uv2BufferMap=null,this.contentIdMap=null,e.lightmapServerUrl&&e.lightmapDatabagId&&(this.bakingRootUrl=e.lightmapServerUrl+""+e.lightmapDatabagId+"/",this.projectUrl=this.bakingRootUrl+"/config.json")}destroy(){this.lightMapCount=void 0,this.lightMapTextureMap={},this.bakingRootUrl=void 0,this.projectUrl=void 0,this.uv2MapItemMap=null,this.uv2BufferMap=null,this.contentIdMap=null}getUv2InfoByNodeId(e,t,i){if(!this.uv2MapItemMap)return;const r=this.contentIdMap[e],n=this.uv2MapItemMap[r][t];if(!n)return;const a=n.uv1Scale,s=n.uv1Translation,o=n.uv1ByteOffset/2,l=2*i;if(!this.uv2BufferMap)return;const d=this.uv2BufferMap[r];let h=[];for(let e=o;e<o+l;e+=2)h.push(a[0]*(d[e]/65535)+s[0]),h.push(a[1]*(d[e+1]/65535)+s[1]);return{lightMapTexture:this.lightMapTextureMap[r][n.lightmapIdx],uv2:h}}hasLightMap(){return void 0!==this.bakingRootUrl}hasUv2Info(e,t){if(!this.uv2MapItemMap)return!1;const i=this.contentIdMap[e];return!!this.uv2MapItemMap[i][t]}findUv2MapItemMap(e){for(const t in this.uv2MapItemMap){if(this.uv2MapItemMap[t][e]){return{modelIndex:t,uv2ModelMapItemMap:this.uv2MapItemMap[t]}}}}findUv2MapInstanceItemMap(e){const t=`${e}_0`;for(const e in this.uv2MapItemMap){if(this.uv2MapItemMap[e][t]){return{modelIndex:e,uv2ModelMapItemMap:this.uv2MapItemMap[e]}}}}getInstanceUV2InfoByNodeId(e,t,i,r){if(!this.uv2MapItemMap)return;let n,a,s=[];const o=this.contentIdMap[e],l=this.uv2MapItemMap[o];for(let e=0;e<i;++e){const i=l[`${t}_${e}`],d=i.uv1Scale,h=i.uv1Translation;s.push(d[0]),s.push(d[1]),s.push(h[0]),s.push(h[1]),n||(n=this.lightMapTextureMap[o][i.lightmapIdx]),a||(a=this.getInstanceUV2ByOffset(i.uv1ByteOffset,r,o))}return{lightMapTexture:n,uv2Array:a,offsetRepeat:s}}getInstanceUV2ByOffset(e,t,i){const r=e/2;if(!this.uv2BufferMap)return;return this.uv2BufferMap[i].slice(r,r+t)}async load(r,s){const o={configUrl:this.projectUrl,bakingRootUrl:this.bakingRootUrl,contentMapUrl:this.getContentMapUrl()},l=await async function(r){const{configUrl:s,bakingRootUrl:o,contentMapUrl:l}=r,d=await async function(e){return new Promise((t=>{const i=new THREE.FileLoader(new THREE.LoadingManager);i.setCrossOrigin("anonymous"),i.setResponseType("json"),i.load(e,(e=>{t(e)}))}))}(s),h=await async function(e){return new Promise((t=>{const i=new THREE.FileLoader(new THREE.LoadingManager);i.setCrossOrigin("anonymous"),i.setResponseType("json"),i.load(e,(e=>{t(e)}))}))}(l),c=d.count.lightmapNum;let u={},p={},m={};for(const r in c){const s=a(o,r),l=n(o,r),d=await e(l),h=await t(s);u[r]=d,p[r]=new Uint16Array(h),m[r]=[];const f=c[r];for(let e=0;e<f;++e){const t=await i(o,r,e);m[r].push(t)}}return new Promise((e=>{e({lightMapNum:c,uv2MapItemMap:u,uv2BufferMap:p,lightImageMap:m,contentIdMap:h})}))}(o),{lightMapNum:d,uv2MapItemMap:h,uv2BufferMap:c,lightImageMap:u,contentIdMap:p}=l;this.uv2MapItemMap=h,this.uv2BufferMap=c,this.contentIdMap=p;for(const e in d){const t=d[e];this.lightMapTextureMap[e]=[];for(let i=0;i<t;++i){let t=new THREE.Texture;t.image=u[e][i],t.encoding=THREE.GammaEncoding,t.needsUpdate=!0,this.lightMapTextureMap[e].push(t)}}s&&s()}getConfigUrl(){return this.projectUrl}getContentMapUrl(){return this.bakingRootUrl+"/content.json"}loadLightMap(e,t,i,r,n){}}}(),function(){class e extends r.BimTileMaterialManager{constructor(e){super(e),this.packingMatTexture=null,this.borderLineVisible=!1!==e.borderLineVisible,this.defaultWireframeColor=new THREE.Color(.3,.3,.3),this.wireframeColor=(new THREE.Color).copy(this.defaultWireframeColor),this.packingMaterialEnable=r.GlobalData.IsPackingMaterialEnable,this.lightMapManager=new r.BimTilesLightMapManager(e),this.useCompressedNormal=!0}getDefaultStandardMaterial(){return r.MaterialUtil.getDefaultStandardMaterialV3()}getDefaultInstanceMaterial(){return r.MaterialUtil.getDefaultInstanceMaterialV3()}getBatchDepthMaterial(){if(this.batchDepthMaterial)return this.batchDepthMaterial;var e=new r.BatchedDepthMaterial;return e.depthPacking=THREE.RGBADepthPacking,this.batchDepthMaterial=e,this.batchDepthMaterial}_checkInstancePackingMaterial(e,t){let i=Date.parse(e),r=Date.parse("2023/05/04");t.disableInstancePMT=!(i>r)}_createMaterial(e,t,i,n,a){const s=i.toObject();r.Utils.isDefined(s.tintColor)&&0==s.tintColor&&(s.tintColor=16777215),s.hasLightMap=a.hasLightMap,s.vertexColors=!!r.Utils.isDefined(a.vertexColors)&&a.vertexColors,s.useEnvLight=!0,r.Utils.isDefined(e.datetime)&&this._checkInstancePackingMaterial(e.datetime,s),null!=this.packingMatTexture?s.packingMatTexture=this.packingMatTexture:s.packingMatTexture=null,this.dealMaterialParm(s);let o=n?this.createInstanceMaterial(s,!0,s.receiveIBL&&r.GlobalData.IBL):this.createStandardMaterial(s,s.receiveIBL&&r.GlobalData.IBL);o.name=t,r.Utils.isDefined(a.useBCOutline)&&!0===a.useBCOutline&&(o.useBCOutline=!0),null!=this.packingMatTexture&&(o.packingMatMap=this.packingMatTexture),this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e]);return void 0!==o.refreshUniforms&&o.refreshUniforms(),"cloudStandard"!==o.type&&"cloudStandardV3"!=o.type||o.setDisableHemiLight(this.disableHemiSphereLight),a.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES&&o.setDisableHemiLight(!0),o}createStandardMaterial(e,t,i){let n;return t?(n=!0===i?new H.IBLInstanceMaterialV3(e):new H.IBLBatchedMaterialV3(e),n.type="IBL"):(n=1==i?new r.CloudStandardInstanceMaterialV3(e):new r.CloudStandardBatchedMaterialV3(e),n.setBorderLineVisible(this.borderLineVisible),n.setOutLineColor(this.wireframeColor),n.setPackingMaterialEnable(this.packingMaterialEnable)),i&&r.Utils.isDefined(e.disableInstancePMT)&&!0===e.disableInstancePMT&&n.setPackingMaterialEnable(!1),e.fillMap&&(n.defines.USE_FILLPATTERN=""),"cloudStandard"!==n.type&&"cloudStandardV3"!=n.type||n.setDisableHemiLight(this.disableHemiSphereLight),n}createInstanceSecondMaterial(e){return this.createInstanceMaterial(e,!0,e.receiveIBL&&r.GlobalData.IBL)}createInstanceMaterial(e,t,i){let n=this.createStandardMaterial(e,i,!0);return n.forInstance=!0,t&&(n.defines.USE_INSTANCE_NORMAL=""),n.colorState=r.EnumShaderColorState.BLINK,n.refreshUniforms(),n}setBorderLineVisible(e){for(var t in this.borderLineVisible=e,this.materialMap){var i=this.materialMap[t];"cloudStandardV3"!=i.type&&"IBLMaterial"!=i.type&&"IBL"!=i.type||(i.setBorderLineVisible(e),i.needsUpdate=!0)}}getWireframeColor(){return this.wireframeColor}setWireframeColor(e){for(var t in e?this.wireframeColor=e:this.wireframeColor.copy(this.defaultWireframeColor),this.materialMap){var i=this.materialMap[t];"cloudStandardV3"!=i.type&&"IBLMaterial"!=i.type&&"IBL"!=i.type||i.setOutLineColor(e)}}setPackingMaterialEnable(e){for(var t in this.packingMaterialEnable=e,this.materialMap){var i=this.materialMap[t];"cloudStandardV3"!=i.type&&"IBLMaterial"!=i.type&&"IBL"!=i.type||i.setPackingMaterialEnable(e)}}changeAllMaterials(e,t){const i=this.materialMap;for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];if(!a.receiveIBL)continue;var s,o=r.MaterialUtil.getMaterialParameters(a),l=!1;""!=a.defines.USE_INSTANCE&&""!=a.defines.USE_INSTANCE_NORMAL||(o.defines=a.defines,l=!0),a instanceof H.IBLInstanceMaterialV3&&(l=!0),t?(delete o.textureColor,delete o.pureColor,delete o.imageFade,delete o.tintColor,o.lights=!0,(s="cloudStandardBatchedV3"===a.type2||a instanceof H.IBLBatchedMaterialV3?new H.IBLBatchedMaterialV3(o):new H.IBLInstanceMaterialV3(o)).type="IBL",s.refreshUniforms()):(delete o.iblProbe,o.lights=!e.lightmap,(s=this.createStandardMaterial(o,t,l)).roughness=o.originRoughness,s.metalness=o.originMetalness,s.refreshUniforms()),s.name=n,i[n]=s,o=null}if(!t)for(let e in this.IBLParams)delete this.settingMaterialPara[e]}_createLineMaterial(e,t,i,n,a){const s=i.toObject(),o=!0===n?this.createInstanceMaterial(s):new r.LineBasicMaterial({linewidth:1});n&&(o.receiveIBL=!1),o._imageByteSize=0,o.vertexColors=!!r.Utils.isDefined(a.vertexColors)&&a.vertexColors,this.initMaterialOpacity(o);const l=e.filter.model;return l.localClippingMode&&(o.clippingPlanes=l.localClippingPlanes,o.innerClipping=l.innerClippingMode,l.innerClippingMatrix&&o.orthoViewProjMatrix.copy(l.innerClippingMatrix)),o.color.setHex(s.color),o.defines&&(o.defines.USE_COLORWITHOUTLIGHT=""),o.needsUpdate=!0,this.materialMap[t]=o,o._referenceCount=1,o}setMaterialsOpacity(e){this.materialsOpacity=e;for(const e in this.materialMap){const t=this.materialMap[e];this.initMaterialOpacity(t),t.refreshUniforms&&t.refreshUniforms()}}initMaterialOpacity(e){null!=this.materialsOpacity&&(e.defines&&void 0!==e.defines.INSTANCE_STATE_SECONDARY||(e.useGlobalOpacity=!0,e.globalOpacity=e.opacity*this.materialsOpacity,e.transparent=!(e.globalOpacity>1-r.TilesUtil.TWO_ACCURACY)))}loadLightMap(e,t){this.lightMapManager.load(e,t)}getUv2InfoByNodeId(e,t,i){return this.lightMapManager.getUv2InfoByNodeId(e,t,i)}hasLightMap(){return this.lightMapManager.hasLightMap()}getLightMapMaterial(e){const t=this.materialMap;if(!r.Utils.isDefined(e.lightMap))return;const i=e.clone(),n=`${i.id}_${i.name}`;return i.name=n,t[n]=i,i}}r.BimTileMaterialManagerV3=e}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(e),this.type="UniqueTileIdMaterial",this.side=THREE.DoubleSide,this.clipping=!0,e.instancing&&(this.defines.USE_INSTANCE=""),this.defines.update=0,this.vertexShader="\n                attribute vec4 id;\n\n                uniform vec3 cameraPos;\n                uniform int uniqueTileId;\n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n\n\n                #include <CompressNormal_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                #include <cloud_state_pars_vertex>\n\n                void main() {\n                    vec3 transformed = vec3( position );\n                    vec3 objectNormal = vec3( normal );\n                    #ifdef CNORMAL \n                        objectNormal = octDecode();\n                    #endif\n                    vec3 transformedNormal = objectNormal;\n                    vec4 mvPosition = vec4( transformed, 1.0 );\n                    vNormal = normalize( transformedNormal );\n                    vId = vec4(float((uniqueTileId>>16)%256)/255.0, float((uniqueTileId>>8)%256)/255.0, float(uniqueTileId%256)/255.0, 1.0);\n                    mvPosition = modelViewMatrix * mvPosition;\n                    vViewPosition = - mvPosition.xyz;\n                    // Using mvPosition and then converting on the CPU side reduces errors\n                    vPosition =  modelMatrix * vec4( position, 1.0 );\n                    gl_Position = projectionMatrix * mvPosition;\n\n                    #include <clipping_planes_vertex>\n                    #include <cloud_state_vertex>\n                }\n            ",this.fragmentShader="\n                precision highp float;\n                precision highp int;\n\n                uniform bool localClipping;\n                \n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n\n                #include <compare_function>\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <cloud_state_pars_fragment>\n\n                void main() {\n\n                    // #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4(0.0,0.0,0.0,0.0);\n                    vec4 withoutLightColor = diffuseColor;\n                    #include <cloud_state_fragment>\n\n                    if (!localClipping)\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                    else\n                    {\n                        #include <num_clipping_planes_for_bimtilepick_fragment>\n                    }\n\n                    if (floatEqual(componentState, ElementState_TRANSPARENT))\n                    {\n                        discard;\n                    }\n\n                    //gId = vId;\n                    // write normals to G-Buffer\n                    //gId = vec4( 1.0,1.0,1.0, 0.0 );\n                    //gNormal = vec4( normalize( vNormal ), 0.0 );\n                    //gPosition = vPosition;\n                    gl_FragColor = vId;\n\n                    // #if NUM_CLIPPING_PLANES < 3\n                    //     gl_FragColor = vec4( 1.0,1.0,1.0, 0.0 );\n                    // #endif\n\n                }\n            ",this.uniforms={uniqueTileId:{value:0}}}set needsUpdate(e){!0===e&&(this.version++,this.defines.update++)}}r.UniqueTileIdMaterial=e;class t extends r.UniqueTileIdMaterial{constructor(e){super(e),this.type="PickingInstanceMaterial",this.defines.USE_INSTANCE="",this.vertexShader="\n                attribute vec4 id;\n                attribute float vClipping;\n\n                uniform vec3 cameraPos;\n                uniform int uniqueTileId;\n\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n\n                attribute vec4 vState;\n\n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying float componentState;\n                varying vec3 vViewPosition;\n                varying float fClipping;\n\n\n                #include <inverse_mat3_pars_vertex>\n                #include <common>\n                #include <CompressNormal_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n\n                #include <compare_function>\n\n                void main() {\n                    vec3 transformed = vec3( position );\n                    vec3 objectNormal = vec3( normal );\n\n                    #ifdef CNORMAL\n                        objectNormal = octDecode();\n                    #endif\n                    #include <Transform_pars_vertex>\n                    \n                    vec4 mvPosition = vec4( transformed, 1.0 );\n                    vec3 transformedNormal = objectNormal;\n                    mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                    normalMat = inverse_mat3(normalMat);\n                    normalMat = transposeMat3(normalMat);\n                    transformedNormal = normalMat * objectNormal;\n                    vNormal = normalize( transformedNormal );\n                    vId = vec4(float((uniqueTileId>>16)%256)/255.0, float((uniqueTileId>>8)%256)/255.0, float(uniqueTileId%256)/255.0, 1.0);\n                    vViewPosition = - mvPosition.xyz;\n                    fClipping = vClipping;\n                    mvPosition = modelViewMatrix * mvPosition;\n                    // Using mvPosition and then converting on the CPU side reduces errors\n                    vPosition =  modelMatrix * vec4( transformed, 1.0 );\n                    gl_Position = projectionMatrix * mvPosition;\n                    \n                    componentState = vState.r;\n                    \n                    #include <clipping_planes_vertex>\n                }\n\n            ",this.fragmentShader="\n                precision highp float;\n                precision highp int;\n\n                varying vec4 vId;\n                varying vec3 vNormal;\n                varying vec4 vPosition;\n                varying vec3 vViewPosition;\n                varying float fClipping;\n\n\n               \n                uniform bool localClipping;\n\n                #include <compare_function>\n\n                #include <clipping_planes_pars_fragment>\n                #include <cloud_state_defines>\n                #include <cloud_state_pars_fragment>\n\n                void main() {\n\n                    //#include <clipping_planes_fragment>\n                    \n                    vec4 diffuseColor = vec4(0.0,0.0,0.0,0.0);\n                    //#include <cloud_state_fragment>\n\n                    if (!localClipping)\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                    else\n                    {\n                        #include <num_clipping_planes_for_bimtilepick_fragment>\n                    }\n\n                    if (floatEqual(componentState, ElementState_HIDDEN))\n                    {\n                        discard;\n                    }\n\n                    if (floatEqual(componentState, ElementState_TRANSPARENT))\n                    {\n                        discard;\n                    }\n                    //gId = vId;\n                    // write normals to G-Buffer\n                    //gId = vec4( 1.0,1.0,1.0, 0.0 );\n                    //gNormal = vec4( normalize( vNormal ), 0.0 );\n                    //gPosition = vPosition;\n                    gl_FragColor = vId;\n                }\n            "}}r.InstanceUniqueTileIdMaterial=t}(),r.BimtilesShadowMapManager=class{constructor(){this.enable=!1,this.loaded=0,this.shadowInfo={},this._useShadowVisibility=!1,this.castShadowTileMap=new Map}destroy(){this.castShadowTileMap.clear(),this.shadowInfo=null,this.loaded=0,this._useShadowVisibility=void 0,this.castShadowTileMap=null}setShadowVisibility(e){this._useShadowVisibility=e}enableCSM(e,t,i,r){this.loaded>0||!t||null==this.shadowInfo?this.enable=e:(this.loaded=1,i.load(t,(t=>{this.shadowInfo&&(t.shadow.map((e=>{const t=e.tileId;this.shadowInfo[t]={},e.value.map((e=>{this.shadowInfo[t][e.nodeid]=e.len}))})),this.loaded=2,this.enable=e,r&&r())}),void 0,(()=>{console.warn(`load ${t} failed`),this.enable=!1})))}init(){for(const e of this.castShadowTileMap.values())e._content.meshes.castShadowIgnoreVisible=!1,e._content.meshes.children.map((e=>{e.castShadowIgnoreVisible=!1}));this.castShadowTileMap.clear()}addCastShadowTileMap(e,t){if(!1===this.enable)return;if(this._useShadowVisibility&&!1===e.isShadowExterior)return;let i=null,r=e.parent,n=null,a=e;for(;r;){if(r.contentAvailable&&(a=r),r.contentAvailable&&r.sse>=100*t.maximumScreenSpaceError){n=r;break}r=r.parent}i=null===n?a:n,0!=i.castShadow&&this.addShadowTile(i)}addShadowTile(e){if(this.castShadowTileMap.set(e.contentId,e),e._content.meshes.castShadowIgnoreVisible=!0,e.applyFilter(),e._content._copyMeshes&&(e._content._copyMeshes.castShadowIgnoreVisible=!0),e.isInstanceTile&&e._content.meshes.children.length>0)return e._content.meshes.children[0].castShadowIgnoreVisible=!0,e._content.meshes.children[0].customTileMaterial=new r.InstanceUniqueTileIdMaterial({}),void(e._content.meshes.children[0].customTileMaterial.uniforms.uniqueTileId.value=e.uniqueTileId);const t=e.contentId;e._content.meshes.children.map((i=>{if(i.isLine)return;i.castShadowIgnoreVisible=!0;const n=i.nodeId;this.shadowInfo[t]&&this.shadowInfo[t][n]&&(i.geometry.castShadowIndex=this.shadowInfo[t][n]),i.customTileMaterial=new r.UniqueTileIdMaterial({}),i.customTileMaterial.uniforms.uniqueTileId.value=e.uniqueTileId})),e._content._copyMeshes&&e._content._copyMeshes.children.map((i=>{if(i.isLine||1==i.material.transparent)return;i.castShadowIgnoreVisible=!0;const n=i.nodeId;this.shadowInfo[t]&&this.shadowInfo[t][n]&&(i.geometry.castShadowIndex=this.shadowInfo[t][n]),i.customTileMaterial=new r.UniqueTileIdMaterial({}),i.customTileMaterial.uniforms.uniqueTileId.value=e.uniqueTileId}))}},function(){const e=new THREE.Box3;class t extends r.BimTilesetTraversal{constructor(){super(),this.shadowInFrustumTileMap=new Map}traverseTiles(e,t,i){const r=this._initVisibilityBoxsCondition(e,i);this._initOccluded(i),this.traverseTile(e,t,i,r,!0,!0),this._endOccluded(i)}traverseTile(e,t,i,r,n,a){if(!this._inVisibilityBoxs(t,i,r))return!1;if(this._isOccluded(t,i))return!1;if(this.updateTile(e,t,n,i),!t._visible)return t._parent&&t._parent._visible&&(e.visitTile(t,i),e.touchTile(t,i),e._addTileToRequestedQueue(t,i)),!1;e._addTileToRequestedQueue(t,i);let s=!1;const o=t._childrenTree;if(o.length>0){let l=!1;if(this.IsChildMayPassSSE(t,i)){let d=!0;if(a)for(let e of o)if(!e.contentReady){d=!1;break}l=!0;const h=n&&t.contentTypeEmpty&&!t.refineStop,c=a&&d;for(let t of o){const n=this.traverseTile(e,t,i,r,h,c);s=s||n}}else if(o.length>1){l=!0;for(let e of o)e.updateVisibility_onlyVis(i)}if(l&&!s){let e=!1;for(let t of o)if(t._visible){e=!0;break}t._visible=e}}let l=!1;return t._visible&&!s&&(a||n)&&(l=e._addTileToSelectedQueue(t,i)),e.visitTile(t,i),e.touchTile(t,i),l||s}traverseShadowTiles(e,t,i){if(!e.enableShadowVisibility||!r.GlobalData.EnableReplenishShadowTile)return;this.shadowInFrustumTileMap.clear();const n=e._loader.filter.model.getModelManager().getScene().lightManager.csm.frustum;this.traverseShadowTile(e,t,i,n,-1)}traverseShadowTile(t,i,r,n,a){if(e.copy(i.boundingBox),e.applyMatrix4(i._transformMatrix),e.applyMatrix4(r.globalMatrix),!i.contentReady||!n.intersectsBox(e))return;if(i.contentReady&&!i.contentTypeEmpty&&!1===i.isShadowExterior)return;i.contentTypeEmpty||(-1==a?(a=this.shadowInFrustumTileMap.size,this.shadowInFrustumTileMap.set(a,[i])):this.shadowInFrustumTileMap.get(a).push(i));const s=i._childrenTree;for(const e of s)this.traverseShadowTile(t,e,r,n,a)}IsChildMayPassSSE(e,t){return!(!e.contentTypeEmpty||e.refineStop)||!!e.passSSE(t)}updateTile(e,t,i,r){t.updateVisibilityV3(r,i),e.updateMaxAndMinPriority(t)}}r.BimTilesetTraversalV3=t}(),function(){class e extends r.BimTileContent{constructor(e,t){super(e,t)}}r.StandardTileContent=e}(),function(){class e extends r.BimTileNode{constructor(e,t,i,r){super(e,t,i,r)}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):new r.StandardTileContent(this,e)}_createNewTile(e,t,i,n){return new r.StandardTile(e,t,i,n)}}r.StandardTile=e}(),function(){class e extends r.BimTileset{constructor(e){super(e),this.leavesLoadFirst=r.Utils.defaultValue(e._leavesLoadFirst,!1)}_canBeTraverse(e,t){return!!e.hasChildren()&&(!!e.contentTypeEmpty||e.passSSE(t))}_createNewTileset(){return new e}_createNewTile(e,t,i,n){return new r.StandardTile(e,t,i,n)}_createTraversalController(e){this._traversalController=new r.TilesetTraversal}isCheckChildrenPassSSE(){return!1}}r.StandardTileset=e}(),function(){class e extends r.BimTilesModel{constructor(e,t,i,r,n,a){super(e,t,i,r,n,a)}_createNewTileset(e){return new r.StandardTileset(e)}_createNewModel(t,i,r){return e(t,i,r)}}r.StandardTilesModel=e}(),function(){class e extends r.BimTileMaterialManager{constructor(e){super(e),this.mapExcavation=null}destroy(){super.destroy(),this.mapExcavation=null}dealMaterialDefines(e,t){super.dealMaterialDefines(e,t),!0===this.isUseColorWithoutLight&&(e.defines.USE_COLORWITHOUTLIGHT=""),this.mapExcavation&&e.updateExcavation&&(e.updateExcavation(this.mapExcavation),e.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation}))}dealMaterialParm(e){super.dealMaterialParm(e),delete e.doubleSide,delete e.receiveIbl,delete e.receiveIBL,delete e.light,delete e.metalness,delete e.roughness,delete e.texturesList,delete e.customList,delete e.originMetalness,delete e.originRoughness}_createMaterial(e,t,i,n,a){const s=i.toObject();r.Utils.isDefined(s.tintColor)&&delete s.tintColor,s.hasLightMap=a.hasLightMap,s.vertexColors=!!r.Utils.isDefined(a.vertexColors)&&a.vertexColors,this.dealMaterialParm(s);let o=new r.ObliquePhotographyMaterial(s);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e]);return void 0!==o.refreshUniforms&&o.refreshUniforms(),o}setExcavation(e){if(e){this.mapExcavation=e;for(const t in this.materialMap){const i=this.materialMap[t];i.updateExcavation&&(i.updateExcavation(e),i.updateSide({isExcavation:e&&e.isExcavation}),i.needsUpdate=!0)}}}setPolygonClimpGroundInfo(e){if(e)for(const t in this.materialMap){const i=this.materialMap[t];i.updatePolygonClimpGroundInfo&&(i.updatePolygonClimpGroundInfo(e),i.needsUpdate=!0)}}closePolygonClimpGround(){for(const e in this.materialMap){const t=this.materialMap[e];t.closePolygonClimpGround&&(t.closePolygonClimpGround(),t.needsUpdate=!0)}}}r.ObliquePhotographyMaterialManager=e}(),function(){class e extends r.BimTileFilterManager{constructor(e,t){super(e),this.terrainOperationManager=t,this.stateFlatChangedRenderer=0,this.elevationScratch=new THREE.Vector3,this.worldBoxScratch=new THREE.Box3,this.worldMatrixScratch=new THREE.Matrix4,this.inverseWorldMatrixScratch=new THREE.Matrix4,this.worldPositionScratch=new THREE.Vector3,this.lineStartScratch=new THREE.Vector2,this.lineEndScratch=new THREE.Vector2}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;e._content.meshes.traverse((e=>{if("MeshEx"!==e.type)return;const t=e.geometry,i=t.groups[0].start,n=t.groups[0].count;if(t.clearGroups(),t._visible=!0,!0===this.objectInfoManager.hasLocalClipping){const a=this.getMaterialForClipFrom(e.material[0]);e.material[r.EnumElementState.BLINK]=a,t.addGroup(i,n,r.EnumElementState.BLINK)}else t.addGroup(i,n,r.EnumElementState.NONE)})),e.stateChangedRenderer=this.stateChangedRenderer;const t=this.model.viewer.getScene();let i=r.ClipPlaneManager.getInstance(t);i.isEnabled()&&i.update()}getVisibleComponentsBbox(){return this.model.getBoundingBoxWorld()}addToLocalClippingListByConditions(e){0===e.length&&this.addToLocalClippingList()}addToLocalClippingList(){this.objectInfoManager.activeLocalClipping(),this.enableStateChanged()}clearLocalClippingList(){super.clearLocalClippingList()}updateTileMeshForFlatten(){this.stateFlatChangedRenderer++}applyTileMeshForFlatten(e){if(0===this.stateFlatChangedRenderer||this.stateFlatChangedRenderer===e.stateFlatChangedRenderer)return;const t=e._content.meshes,i=this.model.objectGroup.matrix,r=this.terrainOperationManager;this.worldBoxScratch.copy(e._boundingBox),this.worldBoxScratch.applyMatrix4(i),this.worldBoxScratch.min.y=0,this.worldBoxScratch.max.y=0;const n=t.matrix;this.worldMatrixScratch.multiplyMatrices(i,n);let a=r.isIntersectFlattenBboxDrawing(this.worldBoxScratch,this.model.id);if(!a&&e.isFlattened)return t.children.map((e=>{this.updateGeometryForFlatten(r,e.geometry,this.worldMatrixScratch,!0),e.material[0].side=THREE.FrontSide})),void(e.isFlattened=!1);a&&(t.children.map((e=>{this.updateGeometryForFlatten(r,e.geometry,this.worldMatrixScratch,!1),e.material[0].side=THREE.DoubleSide})),e.isFlattened=!0),e.stateFlatChangedRenderer=this.stateFlatChangedRenderer}updateGeometryForFlatten(e,t,i,n){this.inverseWorldMatrixScratch.copy(i).invert(),t.attributes.normal||t.computeVertexNormals(),t.prePositionArray||(t.prePositionArray=[...t.attributes.position.array],t.preNormalArray=[...t.attributes.normal.array],t.preUVArray=[...t.attributes.uv.array],t.preIndexArray=[...t.index.array]);let a=[...t.prePositionArray],s=[...t.preNormalArray],o=[...t.preUVArray],l=[...t.preIndexArray],d={};if(!n){const n=[...l];for(let h=0;h<n.length;h+=3){const c=a[3*n[h]],u=a[3*n[h]+1],p=t.prePositionArray[3*n[h]+2],m=a[3*n[h+1]],f=a[3*n[h+1]+1],g=t.prePositionArray[3*n[h+1]+2],v=a[3*n[h+2]],y=a[3*n[h+2]+1],M=t.prePositionArray[3*n[h+2]+2];this.worldPositionScratch.set(c,u,p),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let E=0,x=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);x&&(x.transformElevation(this.inverseWorldMatrixScratch),E++),this.worldPositionScratch.set(m,f,g),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let _=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);_&&(_.transformElevation(this.inverseWorldMatrixScratch),E++),this.worldPositionScratch.set(v,y,M),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let b=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);b&&(b.transformElevation(this.inverseWorldMatrixScratch),E++);const I=o[2*n[h]],T=o[2*n[h]+1],S=o[2*n[h+1]],C=o[2*n[h+1]+1],w=o[2*n[h+2]],R=o[2*n[h+2]+1];if(1==E)if(x){a[3*n[h]+2]=x.worldElevation;let e=d[x.id];e||(e=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(v,y),this.lineEndScratch.set(c,u);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;a.push(t.x),a.push(t.y),a.push(g),a.push(i.x),a.push(i.y),a.push(M),a.push(t.x),a.push(t.y),a.push(x.worldElevation),a.push(i.x),a.push(i.y),a.push(x.worldElevation);const p=(t.x-c)/(m-c+r.Math.EPSILON6),E=(t.y-u)/(f-u+r.Math.EPSILON6),_=(i.x-v)/(c-v+r.Math.EPSILON6),b=(i.y-y)/(u-y+r.Math.EPSILON6);o.push(I+(S-I)*p),o.push(T+(C-T)*E),o.push(w+(I-w)*_),o.push(R+(T-R)*b),o.push(I+(S-I)*p),o.push(T+(C-T)*E),o.push(w+(I-w)*_),o.push(R+(T-R)*b),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=a.length/3;l.push(B-4),l.push(B-3),l.push(B-1),l.push(B-4),l.push(B-1),l.push(B-2),l.push(l[h+1]),l.push(l[h+2]),l.push(B-3),l.push(l[h+1]),l.push(B-3),l.push(B-4),l[h+1]=B-2,l[h+2]=B-1}else if(_){a[3*n[h+1]+2]=_.worldElevation;let e=d[_.id];e||(e=_.transformPolygon(this.inverseWorldMatrixScratch),d[_.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(m,f),this.lineEndScratch.set(v,y);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;a.push(t.x),a.push(t.y),a.push(p),a.push(i.x),a.push(i.y),a.push(M),a.push(t.x),a.push(t.y),a.push(_.worldElevation),a.push(i.x),a.push(i.y),a.push(_.worldElevation);const g=(t.x-c)/(m-c+r.Math.EPSILON6),E=(t.y-u)/(f-u+r.Math.EPSILON6),x=(i.x-m)/(v-m+r.Math.EPSILON6),b=(i.y-f)/(y-f+r.Math.EPSILON6);o.push(I+(S-I)*g),o.push(T+(C-T)*E),o.push(S+(w-S)*x),o.push(C+(R-C)*b),o.push(I+(S-I)*g),o.push(T+(C-T)*E),o.push(S+(w-S)*x),o.push(C+(R-C)*b),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=a.length/3;l.push(B-2),l.push(B-1),l.push(B-3),l.push(B-2),l.push(B-3),l.push(B-4),l.push(l[h]),l.push(B-4),l.push(B-3),l.push(l[h]),l.push(B-3),l.push(l[h+2]),l[h]=l[h+1],l[h+1]=B-1,l[h+2]=B-2}else{a[3*n[h+2]+2]=b.worldElevation;let e=d[b.id];e||(e=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(v,y);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(v,y),this.lineEndScratch.set(m,f);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;a.push(t.x),a.push(t.y),a.push(p),a.push(i.x),a.push(i.y),a.push(g),a.push(t.x),a.push(t.y),a.push(b.worldElevation),a.push(i.x),a.push(i.y),a.push(b.worldElevation);const M=(t.x-c)/(v-c+r.Math.EPSILON6),E=(t.y-u)/(y-u+r.Math.EPSILON6),x=(i.x-v)/(m-v+r.Math.EPSILON6),_=(i.y-y)/(f-y+r.Math.EPSILON6);o.push(I+(w-I)*M),o.push(T+(R-T)*E),o.push(w+(S-w)*x),o.push(R+(C-R)*_),o.push(I+(w-I)*M),o.push(T+(R-T)*E),o.push(w+(S-w)*x),o.push(R+(C-R)*_),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=a.length/3;l.push(B-4),l.push(B-1),l.push(B-2),l.push(B-4),l.push(B-3),l.push(B-1),l.push(l[h]),l.push(l[h+1]),l.push(B-3),l.push(l[h]),l.push(B-3),l.push(B-4),l[h]=l[h+2],l[h+1]=B-2,l[h+2]=B-1}else if(2==E)if(x)if(_){a[3*n[h]+2]=x.worldElevation,a[3*n[h+1]+2]=_.worldElevation;let e=d[x.id];e||(e=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=e);let t=d[_.id];t||(t=_.transformPolygon(this.inverseWorldMatrixScratch),d[_.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(v,y);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(v,y),this.lineEndScratch.set(m,f);let p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(p||(p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!p)continue;a.push(i.x),a.push(i.y),a.push(x.worldElevation),a.push(p.x),a.push(p.y),a.push(x.worldElevation),a.push(i.x),a.push(i.y),a.push(M),a.push(p.x),a.push(p.y),a.push(M);const g=(i.x-c)/(v-c+r.Math.EPSILON6),E=(i.y-u)/(y-u+r.Math.EPSILON6),b=(p.x-v)/(m-v+r.Math.EPSILON6),B=(p.y-y)/(f-y+r.Math.EPSILON6);o.push(I+(w-I)*g),o.push(T+(R-T)*E),o.push(w+(S-w)*b),o.push(R+(C-R)*B),o.push(I+(w-I)*g),o.push(T+(R-T)*E),o.push(w+(S-w)*b),o.push(R+(C-R)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const A=a.length/3;l.push(l[h]),l.push(A-3),l.push(A-4),l.push(A-4),l.push(A-3),l.push(A-1),l.push(A-4),l.push(A-1),l.push(A-2),l.push(l[h+2]),l.push(A-2),l.push(A-1),l[h+2]=A-3}else{a[3*n[h]+2]=x.worldElevation,a[3*n[h+2]+2]=b.worldElevation;let e=d[x.id];e||(e=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=e);let t=d[b.id];t||(t=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(m,f),this.lineEndScratch.set(v,y);let p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(p||(p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!p)continue;a.push(i.x),a.push(i.y),a.push(x.worldElevation),a.push(p.x),a.push(p.y),a.push(x.worldElevation),a.push(i.x),a.push(i.y),a.push(g),a.push(p.x),a.push(p.y),a.push(g);const M=(i.x-c)/(m-c+r.Math.EPSILON6),E=(i.y-u)/(f-u+r.Math.EPSILON6),_=(p.x-m)/(v-m+r.Math.EPSILON6),B=(p.y-f)/(y-f+r.Math.EPSILON6);o.push(I+(S-I)*M),o.push(T+(C-T)*E),o.push(S+(w-S)*_),o.push(C+(R-C)*B),o.push(I+(S-I)*M),o.push(T+(C-T)*E),o.push(S+(w-S)*_),o.push(C+(R-C)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const A=a.length/3;l.push(l[h+2]),l.push(A-4),l.push(A-3),l.push(A-2),l.push(A-3),l.push(A-4),l.push(A-2),l.push(A-1),l.push(A-3),l.push(l[h+1]),l.push(A-1),l.push(A-2),l[h+1]=A-4}else{a[3*n[h+1]+2]=_.worldElevation,a[3*n[h+2]+2]=b.worldElevation;let e=d[_.id];e||(e=_.transformPolygon(this.inverseWorldMatrixScratch),d[_.id]=e);let t=d[b.id];t||(t=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(v,y),this.lineEndScratch.set(c,u);let g=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(g||(g=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!g)continue;a.push(i.x),a.push(i.y),a.push(_.worldElevation),a.push(g.x),a.push(g.y),a.push(_.worldElevation),a.push(i.x),a.push(i.y),a.push(p),a.push(g.x),a.push(g.y),a.push(p);const M=(i.x-c)/(m-c+r.Math.EPSILON6),E=(i.y-u)/(f-u+r.Math.EPSILON6),x=(g.x-v)/(c-v+r.Math.EPSILON6),B=(g.y-y)/(u-y+r.Math.EPSILON6);o.push(I+(S-I)*M),o.push(T+(C-T)*E),o.push(w+(I-w)*x),o.push(R+(T-R)*B),o.push(I+(S-I)*M),o.push(T+(C-T)*E),o.push(w+(I-w)*x),o.push(R+(T-R)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const A=a.length/3;l.push(l[h+1]),l.push(l[h+2]),l.push(A-3),l.push(A-4),l.push(A-1),l.push(A-2),l.push(A-4),l.push(A-3),l.push(A-1),l.push(l[h]),l.push(A-2),l.push(A-1),l[h]=l[h+1],l[h+1]=A-3,l[h+2]=A-4}else 3==E&&(a[3*n[h]+2]=x.worldElevation,a[3*n[h+1]+2]=_.worldElevation,a[3*n[h+2]+2]=b.worldElevation)}}t.setIndex(l),t.deleteAttribute("position"),t.deleteAttribute("uv"),t.deleteAttribute("normal"),t.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),t.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),t.setAttribute("normal",new THREE.Float32BufferAttribute(s,3)),t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.EnumElementState.NONE),t.computeBoundingBox(),t.computeBoundingSphere()}}r.ObliquePhotographyModelFilterManager=e}(),function(){class e extends r.StandardTilesModel{constructor(e,t,i,r,n,a){super(e,t,i,r,n,a),this.isObliquePhotography=!0}_createNewModel(t,i,r){return e(t,i,r)}_createTileSet(){return super._createTileSet(),this._tileset.setUserInputWorking(!0),this._tileset}setExcavation(e){this.materialManager.setExcavation(e)}setPolygonClimpGroundInfo(e){this.materialManager.setPolygonClimpGroundInfo(e)}closePolygonClimpGround(){this.materialManager.closePolygonClimpGround()}_crateFilterManger(){return new r.ObliquePhotographyModelFilterManager(this,this.viewer.terrainOperationManager)}_crateMaterialManger(e){return new r.ObliquePhotographyMaterialManager(e)}updateTileMeshForFlatten(){this.filter.updateTileMeshForFlatten()}}r.ObliquePhotographyModel=e}(),function(){class e extends r.BimTilesModel{constructor(e,t,i,r,n,a){super(e,t,i,r,n,a)}_createNewTileset(e){return new r.Workers.Tileset(e)}_createLoader(e){this.tilesLoader=new r.Workers.TilesLoader(e)}_crateFilterManger(){return new r.Workers.TilesFilterManager(this)}_crateMaterialManger(e){return new r.Workers.MaterialManager(e)}getUserIdMapByFrustum(e){const t=this.tilesLoader.tileReader.searchTreeManager,i=this.transformMatrix,r=this.viewer.getScene().getMatrixGlobal();return t.getUserIdMapByFrustum(e,i,r)}getAllUserIds(){return this.tilesLoader.tileReader.getAllUserIds()}getRealUserId(e){return this.tilesLoader.tileReader.getUserIdByIndex(e)}getWireframeMaterial(){return this.materialManager.getWireframeMaterial()}getInstanceWireframeMaterial(){return this.materialManager.getInstanceWireframeMaterial()}setWireframeColor(e,t){return this.materialManager.setWireframeColor(e,t)}getWireframeColor(){return this.materialManager.getWireframeColor()}restoreWireframeColor(){return this.materialManager.restoreWireframeColor()}loadBusinessResources(e){!1!==this.disableUserData&&this._tileset.loadUserIdResourcesWithDelayResources((()=>{this._recoverIndexInfo(e)}))}}r.Workers.TilesModel=e}(),function(){class e extends r.BimTileContent{constructor(e,t){super(e,t)}setDataBlobs(e,t){}disposeGeometry(){this._meshes.parent&&this._meshes.parent.remove(this._meshes),this._texturesByteLength=0;const e=this._meshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];if(i.children&&i.children.length)for(let e=0,t=i.children.length;e<t;++e){const t=i.children[e];this.disposeGeometryAttributes(t),this._disposeMesh(t)}else i.geometry&&(this.disposeGeometryAttributes(i),this._disposeMesh(i))}this._meshes=void 0,this.disposeGeometryRelatedResource()}_disposeMesh(e){const t=e.geometry;t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0,this._disposeMaterials(e.material),e.geometry=void 0,e.material=void 0}getMeshBuilder(){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}disposeGeometryAttributes(e){}disposeGeometryRelatedResource(){}update(e){const t=this._tile;this._state===r.TileContentProcessState.PENDING&&(this._state=r.TileContentProcessState.PROCESSING,this._parseContentBlock((i=>{this.isMeshCreateLimitEnabled()?r.Workers.LimitedMeshCreator.push((()=>this._buildContent(t,i,e))):this._buildContent(t,i,e)}))),this._state,r.TileContentProcessState.PROCESSED,this._updateOutlineContent()}updateContent(e){e.setByteLength(this.geometryByteLength),this.attachToTilesGroup(e),this.disposeContentBuffer()}_buildContent(e,t,i,n){return 0===t.length?Promise.resolve():this._isValidTileContent(e)?this._createMeshes(t,n).then((()=>{this._isValidTileContent(e)&&(this._state=r.TileContentProcessState.PROCESSED,this.updateContent(e),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0,i.afterRenderFns.push((function(){})))})):Promise.resolve()}_createMeshes(e,t){const i=this._tile,r=this.getMeshBuilder().build(i,e,t);return r&&r.length?Promise.all(r):Promise.resolve()}_parseContentBlock(e){const t=this._tile;if("CMPT"===t.contentType)return;const i=t._loader,r=this._contentBuffer,n=[];for(const e in r){const t=i.decodeByBuffer(r[e],e);n.push(t)}Promise.all(n).then((t=>{e(t)})).catch((e=>{console.log(e)}))}parseTileContent(e){}_isValidTileContent(e){return!e.isDestroyed()&&!this.isDestroyed()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}isMeshCreateLimitEnabled(){return r.GlobalData.EnableMeshCreateLimit}}r.Workers.TileContent=e}(),function(){class e extends r.Workers.TileContent{constructor(e,t){super(e,t)}setDataBlobs(e,t){this._contentBuffer=e[0];const i=this._contentBuffer;for(const e in i)this._geometryByteLength+=i[e].byteLength}_initOutlineContent(){this._outlineContent=new r.Workers.TileBatchedOutlineContent(this._tile)}getMeshBuilder(){return this._tile._loader.getBatchedMeshBuilder()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}}r.Workers.TileBatchedContent=e}(),function(){class e extends r.Workers.TileContent{constructor(e,t){super(e,t),this._requestedBlobType=void 0}destroy(){this._clearLodInstancedContent(),super.destroy()}setDataBlobs(e,t){if(void 0===t)return;let i;this._requestedBlobType=t;const n=r.Workers.RequestedBlobType;switch(t){case n.NONE:this._contentBuffer=e,e.forEach((e=>{this._geometryByteLength+=e.byteLength}));break;case n.INSTANCE:this._contentBuffer=e,i=e[0];for(const e in i)this._geometryByteLength+=i[e].byteLength;this._geometryByteLength+=e[1].byteLength;break;case n.MESH:this._contentBuffer=e,i=e[1];for(const e in i)this._geometryByteLength+=i[e].byteLength;this._geometryByteLength+=e[0].byteLength;break;case n.BOTH:this._contentBuffer=e,i=e[0];for(const e in i)this._geometryByteLength+=i[e].byteLength}}_parseContentBlock(e){if("CMPT"===this._tile.contentType)return;const t=this._requestedBlobType;if(void 0===t)return;const i=r.Workers.RequestedBlobType;switch(t){case i.NONE:this._parseContentBlockByNone(e);break;case i.INSTANCE:this._parseContentBlockByInstanceOnly(e);break;case i.MESH:this._parseContentBlockByMeshOnly(e);break;case i.BOTH:this._parseContentBlockByBoth(e)}}_parseContentBlockByBoth(e){const t=this._tile,i=t._loader,r=this._contentBuffer[0];let n=Object.keys(r);if(2!==n.length)return void console.log("data error!");n=t.getInstanceContentUrls(n);const a=[];n.forEach((e=>{const t=i.decodeByBuffer(r[e],e);a.push(t)})),Promise.all(a).then((i=>{t.resolveSharedInstanceBlob(i[0]),this._updateMeshBlob(i[1]),t.resolveSharedMeshBlob(i[1]),e(i)})).catch((e=>{console.log(e)}))}_parseContentBlockByMeshOnly(e){const t=this._tile,i=t._loader,r=this._contentBuffer,n=r[0].contentBlob,a=r[1];let s;for(const e in a){s=i.decodeByBuffer(a[e],e);break}s&&s.then((i=>{this._updateMeshBlob(i),t.resolveSharedMeshBlob(i),e([n,i])})).catch((e=>{console.log(e)}))}_parseContentBlockByInstanceOnly(e){const t=this._tile,i=t._loader,r=this._contentBuffer,n=r[0],a=r[1].contentBlob;let s;for(const e in n){s=i.decodeByBuffer(n[e],e);break}s&&s.then((i=>{t.resolveSharedInstanceBlob(i),e([i,a])})).catch((e=>{console.log(e)}))}_parseContentBlockByNone(e){const t=this._contentBuffer;e([t[0].contentBlob,t[1].contentBlob])}_updateMeshBlob(e){this.getMeshBuilder().updateGeomteries(e)}update(e){const t=this._tile;if(this._state===r.TileContentProcessState.PENDING){this._state=r.TileContentProcessState.PROCESSING;const i=t.requestedInsLodLevel;this.isMeshCreateLimitEnabled()?this._parseContentBlock((n=>{r.Workers.LimitedMeshCreator.push((()=>this._buildContent(t,n,e,i)))})):this._parseContentBlock((r=>{this._buildContent(t,r,e,i)}))}this._state===r.TileContentProcessState.SUB_PROCESSED&&this._updateLodContent(e),this._state,r.TileContentProcessState.PROCESSED,this._updateOutlineContent()}_buildContent(e,t,i,r){return 0===t.length?Promise.resolve():this._isValidTileContent(e)?this._createMeshes(t,r).then((()=>{this._isValidTileContent(e)&&(this.updateContent(e),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0,i.afterRenderFns.push((function(){})))})):Promise.resolve()}_updateLodContent(e){const t=this._tile,i=t.instanceId,n=t.insLodLevel,a=t.contentId,s=t._tileset.instanceLodMeshPool;if(s.isModelReady(i,n,a))return void(s.isAllModelReady(i,a)&&(this._state=r.TileContentProcessState.PROCESSED));const o=s.getLodMeshInfo(i,n),l=o.modelUrl,d=o.fullUrl;this._getLodInstancedContent(t,l,d,n).update(e),s.isAllModelReady(i,a)&&(this._state=r.TileContentProcessState.PROCESSED)}updateMatrixWorldForLodMeshes(){this._tile.content.meshes.updateMatrixWorld(!0)}_getLodInstancedContent(e,t,i,n){this._lodInstancedContentMap||(this._lodInstancedContentMap={});let a=this._lodInstancedContentMap[t];return a||(a=new r.Workers.TileLodInstancedContent(e,t,i,n),this._lodInstancedContentMap[t]=a),a}_clearLodInstancedContent(){const e=this._lodInstancedContentMap;if(e){for(const t in e)Object.hasOwnProperty.call(e,t)&&(e[t].destroy(),e[t]=void 0);this._lodInstancedContentMap=void 0}}_initOutlineContent(){this._outlineContent=new r.Workers.TileInstancedOutlineContent(this._tile)}getMeshBuilder(){return this._tile._loader.getInstancedMeshBuilder()}disposeGeometryRelatedResource(){}disposeGeometryAttributes(e){const t=this._tile,i=e.entityId?e.entityId:t._getSharedMeshBlobId();if(!t._hasSharedMeshBlobByBlobId(i))return;const r=this._getSharedGeometryAttributeNamesByBlobId(i);if(!r)return;const n=e.geometry;r.forEach((e=>{"index"===e&&n.index?n.index=null:n.hasAttribute(e)&&n.deleteAttribute(e)}))}_getSharedGeometryAttributeNamesByBlobId(e){const t=this._tile._getSharedMeshBlobManager().getSharedBlob(e);if(!t.contentBlob)return;const i=[];let n=[];const a=t.contentBlob.parsedData,s=Object.keys(a),o=r.Workers.TileBlockType;if(s.forEach((e=>{const t=a[e],i=Number(e);i!==o.BT_LINE&&i!==o.BT_MESH||t.forEach((e=>{n.push(e)}))})),0===n.length)return;const l=n[0].geometry;return l.index&&i.push("index"),l.attributes.forEach((e=>{"id"!==e.name&&"vState"!==e.name&&"pointColorState"!==e.name&&"uv2"!==e.name&&"uv3"!==e.name&&i.push(e.name)})),i}updateContent(e){if(e.enableDynamicInstanceLod()){this._state=r.TileContentProcessState.SUB_PROCESSED;e._tileset.instanceLodMeshPool.setModelState(e.instanceId,e.requestedInsLodLevel,e.contentId,r.TileContentState.READY)}else this._state=r.TileContentProcessState.PROCESSED;this.attachToTilesGroup(e),this.disposeContentBuffer()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}isMeshCreateLimitEnabled(){return r.GlobalData.EnableMeshCreateLimit}}r.Workers.TileInstancedContent=e}(),function(){class e extends r.BimTileOutlineContent{constructor(e){super(e),this.bufferByteLength=0}disposeLineGeometry(){this._outlineMeshes.parent&&this._outlineMeshes.parent.remove(this._outlineMeshes),this.bufferByteLength=0;const e=this._outlineMeshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];this.disposeGeometryAttributes(i),this._disposeMesh(i)}this.disposeGeometryRelatedResource()}_disposeMesh(e){const t=e.geometry;t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0,e.geometry=void 0,e.material=void 0}disposeGeometryAttributes(e){}disposeGeometryRelatedResource(){}getMeshBuilder(){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}getMeshGroupName(){return r.ObjectGroupType.WIREFRAME}update(){this._state===r.TileContentProcessState.PENDING&&this.requestContent(),this._state===r.TileContentProcessState.LOADED&&this.parseContent(),this._state===r.TileContentProcessState.PROCESSED&&this.updateContent(),this._state,r.TileContentProcessState.READY}parseContent(){const e=this._tile,t=this._buffer;this.bufferByteLength=t.byteLength,this._state=r.TileContentProcessState.PROCESSING;const i=e.getOutlineContentUrl();e._loader.decodeByBuffer(t,i).then((t=>{this._parse(e,t)}),(e=>{console.log(e)}))}updateContent(){this._state=r.TileContentProcessState.READY,this._tile._content._geometryByteLength+=this.bufferByteLength,this.attachToTilesGroup(this._tile),this.disposeContentBuffer()}_parse(e,t){t&&(e.isDestroyed()||this.isDestroyed()||(this._state=r.TileContentProcessState.PROCESSED,this.createMeshes(t)))}createMeshes(e){this.getMeshBuilder().build(this,e)}attachToTilesGroup(e){const t=this._tile._tileset._objectGroup,i=this.getMeshGroupName(),r=t.getObjectByName(i);r.add(this.outlineMeshes),r.updateMatrixWorld(!0)}}r.Workers.TileOutlineContent=e}(),function(){class e extends r.Workers.TileOutlineContent{constructor(e){super(e)}getMeshBuilder(){return this._tile._loader.getBatchedOutlineBuilder()}}r.Workers.TileBatchedOutlineContent=e}(),function(){class e extends r.Workers.TileOutlineContent{constructor(e){super(e),this._requestedBlobType=void 0}destroy(){this._disposeSharedMeshBlob(),super.destroy()}disposeGeometryAttributes(e){if(!this._hasSharedMeshBlob())return;const t=this._getSharedGeometryAttributeNames();if(!t)return;const i=e.geometry;t.forEach((e=>{"index"===e&&i.index?i.index=null:i.hasAttribute(e)&&i.deleteAttribute(e)}))}_getSharedGeometryAttributeNames(){const e=this._getSharedMeshBlobId(),t=this._getSharedMeshBlobManager().getSharedBlob(e),i=[];let n=[];const a=t.contentBlob.parsedData,s=Object.keys(a),o=r.Workers.TileBlockType;if(s.forEach((e=>{const t=a[e],i=Number(e);i!==o.BT_LINE&&i!==o.BT_MESH||t.forEach((e=>{n.push(e)}))})),0===n.length)return;const l=n[0].geometry;return l.index&&i.push("index"),l.attributes.forEach((e=>{i.push(e.name)})),i}disposeGeometryRelatedResource(){}getMeshBuilder(){return this._tile._loader.getInstancedOutlineBuilder()}getMeshGroupName(){return r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY}requestContent(){return this._hasSharedMeshBlob()?this._requestContentWithNone():this._requestContent()}_requestContent(){const e=this._getRequestPromise();if(!e)return!1;this._initSharedMeshBlob();const t=this._request,i=r.Workers.RequestedBlobType.MESH;return this._createContentByRequestPromise(t,e,i,(()=>{this._disposeSharedMeshBlob()})),!0}_requestContentWithNone(){if(!this._isSharedBlobLoaded())return!1;const e=this._parseSharedMeshBlob(),t=r.Workers.RequestedBlobType.NONE;return this._createContentByRequestPromise(null,e,t),!0}_getRequestPromise(){const e=this._tile,t=new r.Request({throttle:!0,type:e._tileset.type,url:e.getOutlineContentUrl(),priorityCallback:e._createPriorityCallback(e)});return this._request=t,this._fetchContent(t)}_createContentByRequestPromise(e,t,i,n){const a=this._tile,s=this._state;this._state=r.TileContentProcessState.LOADING;const o=this._handleFailedContent(this,a._tileset),l=a._tileset.statistics;l.incrementNumberOfPendingRequests(),t.then((e=>{this.isDestroyed()?o():(l.decrementNumberOfPendingRequests(),this._state=r.TileContentProcessState.LOADED,this.setDataBlobs(e,i))})).catch((t=>{if(n&&n(),e&&e.state===r.RequestState.CANCELLED)return this._state=s,this.handleAfterRequestCancelled(),l.decrementNumberOfPendingRequests(),void l.incrementNumberOfAttemptedRequests();console.log(t),o(t)}))}setDataBlobs(e,t){if(void 0===t)return;this._requestedBlobType=t;const i=r.Workers.RequestedBlobType;switch(t){case i.NONE:this._buffer=e;break;case i.MESH:const t=Object.values(e);this._buffer=t[0]}}_parseContentBlock(e){const t=this._requestedBlobType;if(void 0===t)return;const i=r.Workers.RequestedBlobType;switch(t){case i.NONE:this._parseContentBlockByNone(e);break;case i.MESH:this._parseContentBlockByMesh(e)}}_parseContentBlockByNone(e){const t=this._buffer;this.bufferByteLength=t.byteLength,this._state=r.TileContentProcessState.PROCESSING;e(t.contentBlob)}_parseContentBlockByMesh(e){const t=this._tile,i=this._buffer;this.bufferByteLength=i.byteLength,this._state=r.TileContentProcessState.PROCESSING;const n=t.getOutlineContentUrl();t._loader.decodeByBuffer(i,n).then((t=>{this._updateMeshBlob(t),this.resolveSharedMeshBlob(t),e(t)})).catch((e=>{console.log(e)}))}_updateMeshBlob(e){this.getMeshBuilder().updateGeomteries(e)}parseContent(){const e=this._tile;this._parseContentBlock((t=>{this._parse(e,t)}))}_getSharedMeshBlobId(){return this._tile.contentOutlineId}_getSharedMeshBlobManager(){return this._tile._loader.getSharedMeshBlobManager()}_hasSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().hasSharedBlob(e)}_isSharedBlobLoaded(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().isSharedBlobLoaded(e)}_initSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().initSharedBlob(e)}_parseSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().parseSharedBlob(e)}_disposeSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().disposeSharedBlob(e)}resolveSharedMeshBlob(e){const t=this._getSharedMeshBlobId(),i=this._getSharedMeshBlobManager(),r={contentBlob:e,contentType:e.contentType,byteLength:e.byteLength};i.resolveSharedBlob(t,r)}}r.Workers.TileInstancedOutlineContent=e}(),function(){const e=Object.freeze({NONE:0,INSTANCE:1,MESH:2,BOTH:3});class t extends r.BimTileNode{constructor(e,t,i,r){super(e,t,i,r)}_createNewTile(e,i,r,n){return new t(e,i,r,n)}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):this.isInstanceTile?new r.Workers.TileInstancedContent(this,e):new r.Workers.TileBatchedContent(this,e)}unloadContent(){this.isInstanceTile&&this._contentState!==r.TileContentState.UNLOADED&&(this._resetRequestedInsLodLevel(),this._disposeSharedInstanceBlob(),this._disposeSharedMeshBlob()),super.unloadContent()}parseOutlineContentBlock(e,t){t(e)}parseCMPTContentBlock(e,t){const i=[];for(const t in e){const e=r.RequestSpliter.splitByUrlMd5(t),n=this._loader.CMPTUrlMap[e].buffer.slice(this.contentCMPTOffset,this.contentCMPTOffset+this.contentCMPTSize);i.push(n)}t(i)}parseContentBlock(e,t){}requestContent(){return this.isInstanceTile?this._requestInstanceContent():this._requestContent()}_requestContent(){const e=this._getResource(),t=this._getRequestPromise(e);if(!t)return!1;const i=[t],r=this._request;return this._createContentByRequestPromise(r,i),!0}_requestInstanceContent(){this._initRequestedInsLodLevel();const e=this._hasSharedInstanceBlob(),t=this._hasSharedMeshBlob(),i=this.getAbsoluteContentUrl(),r=this.getAbsoluteInstanceMeshContentUrl();if(!e&&!t){const e=this._getResource();return e.url=[i,r],this._requestInstanceContentWithBoth(e)}if(e&&t)return this._requestInstanceContentWithNone();if(e){const e=this._getResource();return e.url=[r],this._requestInstanceContentWithMeshBlob(e)}if(t){const e=this._getResource();return e.url=[i],this._requestInstanceContentWithInstanceBlob(e)}return!1}_requestInstanceContentWithBoth(e){const t=this._getRequestPromise(e);if(!t)return this._resetRequestedInsLodLevel(),!1;this._initSharedInstanceBlob(),this._initSharedMeshBlob();const i=this._request,n=[t],a=r.Workers.RequestedBlobType.BOTH;return this._request=null,this._createContentByRequestPromise(i,n,a,(()=>{this.isDestroyed()||(this._resetRequestedInsLodLevel(),this._disposeSharedInstanceBlob(),this._disposeSharedMeshBlob())})),!0}_requestInstanceContentWithNone(){if(!this._isSharedInstanceBlobLoaded()||!this._isSharedMeshBlobLoaded())return this._resetRequestedInsLodLevel(),!1;const e=[this._parseSharedInstanceBlob(),this._parseSharedMeshBlob()],t=r.Workers.RequestedBlobType.NONE;return this._createContentByRequestPromise(null,e,t),!0}_requestInstanceContentWithMeshBlob(e){if(!this._isSharedInstanceBlobLoaded())return!1;const t=this._getRequestPromise(e);if(!t)return this._resetRequestedInsLodLevel(),!1;this._initSharedMeshBlob();const i=this._request,n=[this._parseSharedInstanceBlob(),t],a=r.Workers.RequestedBlobType.MESH;return this._request=null,this._createContentByRequestPromise(i,n,a,(()=>{this.isDestroyed()||(this._resetRequestedInsLodLevel(),this._disposeSharedMeshBlob())})),!0}_requestInstanceContentWithInstanceBlob(e){if(!this._isSharedMeshBlobLoaded())return!1;const t=this._getRequestPromise(e);if(!t)return this._resetRequestedInsLodLevel(),!1;this._initSharedInstanceBlob();const i=this._request,n=[t,this._parseSharedMeshBlob()],a=r.Workers.RequestedBlobType.INSTANCE;return this._request=null,this._createContentByRequestPromise(i,n,a,(()=>{this.isDestroyed()||(this._resetRequestedInsLodLevel(),this._disposeSharedInstanceBlob())})),!0}_getRequestPromise(e){const t=new r.Request({throttle:!0,type:this._tileset.type,priorityCallback:this._createPriorityCallback(this)});return this._request=t,e.setRequest(t),e.fetch({fetchCallback:this._getContentBlockCallback()})}_createContentByRequestPromise(e,t,i,n){const a=this._getResource(),s=this._contentState;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const o=this._tileset.statistics;o.incrementNumberOfPendingRequests();const l=this._handleFailedContent(this,this._tileset),d=this;Promise.all(t).then((function(e){if(!d.isDestroyed())return d.isTilesetContent?d._content=d.createContent(e[0]):(d._content=d.createContent(),d._content.setDataBlobs(e,i)),d._contentState=r.TileContentState.PROCESSING,d._contentProcessDeferred.resolve(d._content),o.decrementNumberOfPendingRequests(),d._content.readyPromise.then((function(e){d._contentState=r.TileContentState.READY,d._contentReadyDeferred.resolve(e)}));l()})).catch((function(t){if(n&&n(),d._contentProcessDeferred.destroy(),d._contentProcessDeferred=void 0,d._contentReadyDeferred.destroy(),d._contentReadyDeferred=void 0,e&&e.state===r.RequestState.CANCELLED)return d._contentState=s,o.decrementNumberOfPendingRequests(),void o.incrementNumberOfAttemptedRequests();l(t),a.retryOnError()&&(e.state=r.RequestState.UNISSUED,e.deferred=void 0,d._contentState=s)}))}_getResource(){const e=this._resource;if(e)return e;const t=this.getAbsoluteContentUrl();let i;if(this.isTilesetContent)i=t;else if(this.isInstanceTile){i=[t,this.getAbsoluteInstanceMeshContentUrl()]}else i=[t];return this._resource=r.Resource.create({url:i}),this._resource}getAbsoluteInstanceMeshContentUrl(){return this._contentInsModelIndex}_getSharedInstanceBlobManager(){return this._loader.getSharedInstanceBlobManager()}_hasSharedInstanceBlob(){const e=this._getSharedInstanceBlobId();return this._getSharedInstanceBlobManager().hasSharedBlob(e)}_isSharedInstanceBlobLoaded(){const e=this._getSharedInstanceBlobId();return this._getSharedInstanceBlobManager().isSharedBlobLoaded(e)}_initSharedInstanceBlob(){const e=this._getSharedInstanceBlobId();this._getSharedInstanceBlobManager().initSharedBlob(e)}_parseSharedInstanceBlob(){const e=this._getSharedInstanceBlobId();return this._getSharedInstanceBlobManager().parseSharedBlob(e)}resolveSharedInstanceBlob(e){if(this.isDestroyed())return;const t=this._getSharedInstanceBlobId(),i=this._getSharedInstanceBlobManager(),r={contentBlob:e,contentType:e.contentType,byteLength:e.byteLength};i.resolveSharedBlob(t,r)}_disposeSharedInstanceBlob(){if(!this.isInstanceTile)return;const e=this._getSharedInstanceBlobId();this._getSharedInstanceBlobManager().disposeSharedBlob(e)}_getSharedMeshBlobId(){return this.contentInsModel}_getSharedMeshBlobManager(){return this._loader.getSharedMeshBlobManager()}_hasSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().hasSharedBlob(e)}_hasSharedMeshBlobByBlobId(e){return this._getSharedMeshBlobManager().hasSharedBlob(e)}_isSharedMeshBlobLoaded(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().isSharedBlobLoaded(e)}_initSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().initSharedBlob(e)}_parseSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().parseSharedBlob(e)}resolveSharedMeshBlob(e){if(this.isDestroyed())return;const t=this._getSharedMeshBlobId(),i=this._getSharedMeshBlobManager(),r={contentBlob:e,contentType:e.contentType,byteLength:e.byteLength};i.resolveSharedBlob(t,r)}_disposeSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().disposeSharedBlob(e)}getInstanceContentUrls(e){const t=this.getAbsoluteContentUrl();if(e[0]===t)return e;const i=e[0];return e[0]=e[1],e[1]=i,e}_initRequestedInsLodLevel(){if(!this.enableDynamicInstanceLod())return;if(void 0!==this.requestedInsLodLevel)return;const e=this.instanceId,t=this.insLodLevel,i=this._tileset.instanceLodMeshPool.getLodMeshInfo(e,t);this.contentInsModel!==i.modelUrl&&(this.contentInsModel=i.modelUrl,this._contentInsModelIndex=i.fullUrl),this.requestedInsLodLevel=t,this.requestedInsLodModelId=i.modelUrl}_resetRequestedInsLodLevel(){this.enableDynamicInstanceLod()&&(this.requestedInsLodLevel=void 0)}getInsLodInfo(e,t){return this._tileset.instanceLodMeshPool.getLodMeshInfoRecursive(e,t)}getRealInsLodLevel(e,t){return this._tileset.instanceLodMeshPool.getRealLodLevel(e,t)}}r.Workers.RequestedBlobType=e,r.Workers.Tile=t}(),function(){class e extends r.BimTileset{constructor(e){super(e)}_createNewTile(e,t,i,n){return new r.Workers.Tile(e,t,i,n)}loadUserIdResources(e){const t=this._loader,i=this._loader.tileReader;t.loadUserIdResources().then((()=>{t.loadIndependentResources().then((()=>{e&&e()})),i.createNodeInfoMap(),i.createTileIdMap(),this._userIdReady=!0}))}loadUserIdResourcesWithDelayResources(e){const t=this._loader,i=this._loader.tileReader;t.loadUserIdResources().then((()=>{i.createNodeInfoMap(),i.createTileIdMap(),this._userIdReady=!0,e&&e()})).then((()=>{t.loadIndependentResources()}))}}r.Workers.Tileset=e}(),function(){class e extends r.BimTilesLoader{constructor(e){super(e),this._initMeshBuilder(),this._sharedMeshBlobManager=new r.Workers.SharedBlobManager,this._sharedInstanceBlobManager=new r.Workers.SharedBlobManager}destroy(){this._sharedMeshBlobManager.destroy(),this._sharedMeshBlobManager=null,this._sharedInstanceBlobManager.destroy(),this._sharedInstanceBlobManager=null,this._destroyMeshBuilder(),super.destroy()}_initMeshBuilder(){this._batchedMeshBuilder=new r.Workers.BatchedMeshBuilder,this._batchedOutlineBuilder=new r.Workers.BatchedOutlineBuilder(this._batchedMeshBuilder),this._instancedMeshBuilder=new r.Workers.InstancedMeshBuilder,this._instancedOutlineBuilder=new r.Workers.InstancedOutlineBuilder(this._instancedMeshBuilder)}_destroyMeshBuilder(){this._batchedOutlineBuilder&&(this._batchedOutlineBuilder.destroy(),this._batchedOutlineBuilder=void 0),this._batchedMeshBuilder.destroy(),this._batchedMeshBuilder=void 0,this._instancedOutlineBuilder&&(this._instancedOutlineBuilder.destroy(),this._instancedOutlineBuilder=void 0),this._instancedMeshBuilder.destroy(),this._instancedMeshBuilder=void 0}getBatchedMeshBuilder(){return this._batchedMeshBuilder}getBatchedOutlineBuilder(){return this._batchedOutlineBuilder}getInstancedMeshBuilder(){return this._instancedMeshBuilder}getInstancedOutlineBuilder(){return this._instancedOutlineBuilder}_createTileReader(){this.tileReader=new r.Workers.TilesReader({dataVersion:this._getDataVersion()})}_getDataVersion(){return r.BimTilesVersionControl.isVersion_3(this.dataVersion)?r.Workers.DataVersion.DV_V3:r.BimTilesVersionControl.isVersion_2(this.dataVersion)?r.Workers.DataVersion.DV_V2:r.Workers.DataVersion.DV_V1}addSearchTreeUrl(e,t,i){this.tileReader.searchTreeManager.addUrl({url:e,box:t,callback:i})}loadSearchTree(){const e=r.Workers.ParserType.SEARCHTREE,t=r.Workers.TileBlockType.BT_INDEX;return this._parseDataBlock(e,t)}loadGlobalResources(e){return this.loadMaterialBlock()}loadMaterialBlock(){const{tileReader:e}=this,t=e.globalMaterialUrl;if(!r.Utils.isDefined(t))return Promise.resolve();const i=r.Workers.TileBlockType,n=this.materialManager;return this.loadAndDecode(t).then((e=>{n.parseMaterial(e.parsedData[i.BT_MATERIAL])}))}loadUserIdBlock(){const e=r.Workers.ParserType.USERID,t=r.Workers.TileBlockType.BT_USERID;return this._parseDataBlock(e,t)}registerResourcesLoadDelay(e){const t=this,i=function(){console.log("------ resources delay load ------"),e.unregisterEventListener(r.EVENTS.ON_TILES_LOAD_INITIAL,i),t.loadUserDataBlock(),t.loadUserIdBlock(),t.loadSearchTree()};e.registerEventListener(r.EVENTS.ON_TILES_LOAD_INITIAL,i)}loadUserDataBlock(){const e=r.Workers.ParserType.USERDATA,t=r.Workers.TileBlockType.BT_USERDATA;return this._parseDataBlock(e,t)}loadTileIdBlock(){const e=r.Workers.ParserType.TILEID,t=r.Workers.TileBlockType.BT_TILEID;return this._parseDataBlock(e,t)}loadNodeBoxBlock(){const e=r.Workers.ParserType.NODEBOX,t=r.Workers.TileBlockType.BT_NODEBOX;return this._parseDataBlock(e,t)}loadUserIdBoxBlock(){const e=r.Workers.ParserType.USERIDBOX,t=r.Workers.TileBlockType.BT_USERIDBOX;return this._parseDataBlock(e,t)}loadNodeIdBlock(){const e=r.Workers.ParserType.NODEID,t=r.Workers.TileBlockType.BT_NODEID;return this._parseDataBlock(e,t)}loadUserIdResources(){const e=[],t=this.loadUserIdBlock();t&&e.push(t);const i=this.loadUserDataBlock();i&&e.push(i);const r=this.loadTileIdBlock();r&&e.push(r);const n=this.loadNodeIdBlock();n&&e.push(n);const a=this.loadNodeBoxBlock();return a&&e.push(a),Promise.all(e)}loadIndependentResources(){const e=[],t=this.loadSearchTree();t&&e.push(t);const i=this.loadUserIdBoxBlock();return i&&e.push(i),Promise.all(e)}_parseDataBlock(e,t){if(this.isDestroyed())return;const i=this.tileReader.getParserByType(e);if(!i)return;const r=[];return i.traverseUrls((e=>{const n="object"==typeof e,a=n?e.url:e;let s=n?e.callback:void 0;const o=this.loadAndDecode(a).then((r=>{i.update({data:r.parsedData[t],params:{element:e,tickTime:r.tickTime,packToBuffer:r.packToBuffer}}),s&&s(),s=void 0,e=void 0}),(e=>{console.log(e)}));r.push(o)})),Promise.all(r)}loadAndDecode(e,t){const i=r.TilesUtil.getProtobufDecoder(),n=this._getDataVersion();return void 0===t&&(t=!1),new Promise(t?(t,r)=>{i.decodeByUrl(e,{packToBuffer:!0,version:n},(e=>{t(e)}),(e=>{r(e)}))}:(t,r)=>{this.loadArrayBufferDirectly(e,(a=>{i.decodeByBuffer(a,{url:e,version:n},(e=>{t(e)}),(e=>{r(e)}))}))})}decodeByBuffer(e,t){const i=r.TilesUtil.getProtobufDecoder(),n=this._getDataVersion();return new Promise(((r,a)=>{i.decodeByBuffer(e,{url:t,version:n},(e=>{r(e)}),(e=>{a(e)}))}))}getSharedInstanceBlobManager(){return this._sharedInstanceBlobManager}getSharedMeshBlobManager(){return this._sharedMeshBlobManager}}r.Workers.TilesLoader=e}(),function(){const e=Object.freeze({USERID:0,USERDATA:1,SEARCHTREE:2,TILEID:3,VIEWTREE:4,NODEID:5,NODEBOX:6,USERIDBOX:7}),t=Object.freeze({DV_V1:0,DV_V2:1,DV_V3:2});r.Workers.ParserType=e,r.Workers.DataVersion=t,r.Workers.TilesReader=class{constructor(e){this._dataVersion=r.Utils.defaultValue(e.dataVersion,t.DV_V1),this._initParsers(),this._initDescriptor(),this.globalMaterialUrl=void 0,this.globalInstance=void 0,this.globalLodUrl=void 0,this.globalVisibilityUrl=void 0}destroy(){this.descriptor.destroy(),this.descriptor=void 0,this._destroyParsers()}_initDescriptor(){this.descriptor=new r.BimtileDescriptor}getDescriptor(){return this.descriptor}get searchTreeManager(){return this.getParserByType(r.Workers.ParserType.SEARCHTREE)}get userDataParser(){return this.getParserByType(r.Workers.ParserType.USERDATA)}get userIdParser(){return this.getParserByType(r.Workers.ParserType.USERID)}_initParsers(){this._parsers={},this._createParserByType(e.SEARCHTREE),this._createParserByType(e.USERID)}_destroyParsers(){let e=this._parsers;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const i=e[t];i&&i.destroy()}e=void 0,this._parsers=void 0}_createParserByType(i){let n=this._parsers[i];if(n)return n;const a=this._dataVersion;switch(i){case e.USERID:n=a===t.DV_V3?new r.Workers.UserIdParserV3:a===t.DV_V2?new r.Workers.UserIdV2Parser:new r.Workers.UserIdParser;break;case e.USERDATA:n=new r.Workers.UserDataParser;break;case e.SEARCHTREE:n=a===t.DV_V1?new r.Workers.SearchTreeV1Parser:new r.Workers.SearchTreeV2Parser(this);break;case e.TILEID:n=new r.Workers.TileIdParser;break;case e.NODEID:n=new r.Workers.NodeIdParser;break;case e.NODEBOX:n=new r.Workers.NodeBoxParser;break;case e.USERIDBOX:n=new r.Workers.UserIdBoxParser}return n&&(this._parsers[i]=n),n}getParserByType(e){return this._parsers[e]}getNodeByIndex(e){return this.getParserByType(r.Workers.ParserType.NODEID).getNode(e)}getNodeBBoxByIndex(e){return this.getParserByType(r.Workers.ParserType.NODEBOX).getNode(e)}getUserdataIdByIndex(e){return this.getParserByType(r.Workers.ParserType.USERID).getUserdataIdByIndex(e)}getUserDataIndexByUserIndex(e){return this.getUserdataIdByIndex(e)}getAllUserIds(){return this.getParserByType(r.Workers.ParserType.USERID).getAllUserIds()}getUserIdByIndex(e){return this.getParserByType(r.Workers.ParserType.USERID).getUserIdByIndex(e)}getIndexByUserId(e){return this.getParserByType(r.Workers.ParserType.USERID).getIndexByUserId(e)}getUserDataIndexMapByString(e,t){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataIndexMapByString(e,t)}getUserDataStringMapByIndex(e,t){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataStringMapByIndex(e,t)}getUserDataByIndex(e){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataByIndex(e)}getUserDataStringMapByUserId(e){const t=this.getIndexByUserId(e),i=this.getUserDataIndexByUserIndex(t),r=this.getUserDataByIndex(i);let n={};if(r)for(const e in r)if(Object.hasOwnProperty.call(r,e)){const t=r[e],i=this.getUserDataStringMapByIndex(e,t);i&&(n[i[0]]=i[1])}return n}getUserDataIndexValueByString(e){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataIndexValueByString(e)}getUserDataIndexKeyByString(e){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataIndexKeyByString(e)}getUserIdBoxByIndex(e){return this.getParserByType(r.Workers.ParserType.USERIDBOX).getNode(e)}createNodeInfoMap(){this._dataVersion===t.DV_V1?this._createNodeInfoMapV1():this._dataVersion===t.DV_V2&&this._createNodeInfoMapV2()}_createNodeInfoMapV1(){const e=this.getDescriptor(),t=this.getParserByType(r.Workers.ParserType.TILEID),i=this.getParserByType(r.Workers.ParserType.USERID);i&&(i.traverse((i=>{const n=new r.BimTileNodeInfo;n.index=i.nodeId,n.blockId=i.blockId,n.userId=i.userId,n.userData=i.userdataId,n.boundingBox=Object.values(i.boundingBox),n.tileId=i.tileId,t&&t.isInstanceTile(i.tileId)&&(n.instanceOrNot=!0),e._classifyNodeInfo(n)})),this.clearCacheFromDataParser())}_createNodeInfoMapV2(){const e=this.getDescriptor(),t=this.getParserByType(r.Workers.ParserType.TILEID),i=this.getParserByType(r.Workers.ParserType.NODEID);i&&(i.traverse((i=>{const n=new r.BimTileNodeInfo;n.blockId=0,n.userId=i.userId,n.userData=this.getUserdataIdByIndex(i.userId),n.boundingBox=this.getNodeBBoxByIndex(i.bboxId),n.tileId=i.tileId,n.index=i.nodeId,t&&t.isInstanceTile(i.tileId)&&(n.instanceOrNot=!0),e._classifyNodeInfo(n)})),this.clearCacheFromDataParser())}clearCacheFromDataParser(){let e=this._parsers;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const i=e[t];i&&i.clear()}}createTileIdMap(){}parseSchemaProperties(t,i){if(void 0===t)return;if(this.layerKey=t.layerKey,this.layerValue=t.layerValue,this.globalMaterialUrl=t.globalMaterial?i+t.globalMaterial.content.url:void 0,this.globalInstance=t.instanceTiles?i+t.instanceTiles.content.url:void 0,this.globalLodUrl=t.groupTiles?i+t.groupTiles.content.url:void 0,this.globalVisibilityUrl=t.visibilityTiles?i+t.visibilityTiles.content.url:void 0,this.globalShadowVisibilityUrl=t.visibilityShadowTiles?i+t.visibilityShadowTiles.content.url:void 0,this.globalShadowUrl=t.globalShadow?i+t.globalShadow.content.url:void 0,t.globalUserdata){const r=i+t.globalUserdata.content.url;this._createParserByType(e.USERDATA).addUrl(r)}const r=t.globalUserID;if(r){const t=this._createParserByType(e.USERID);r.map((e=>{const r=i+e.content.url;t.addUrl(r),this.descriptor.updateMaxUserIDIndex(e.maxUserIDIndex)}))}if(t.globalTileID){const r=i+t.globalTileID.content.url;this._createParserByType(e.TILEID).addUrl(r)}const n=t.globalNodeID;if(n){const t=this._createParserByType(e.NODEID);n.map((e=>{const r=i+e.content.url;t.addUrl({url:r,startPos:e.startPos})}))}const a=t.globalNodeBox;if(a){const t=this._createParserByType(e.NODEBOX);a.map((e=>{const r=i+e.content.url;t.addUrl({url:r,startPos:e.startPos})}))}const s=t.globalUserIDBox;if(s){const t=this._createParserByType(e.USERIDBOX);s.map((e=>{const r=i+e.content.url;t.addUrl({url:r,startPos:e.startPos})}))}}}}(),r.Workers.DataParser=class{constructor(){this.nodeMap={},this.urls=[],this._destroyed=!1}destroy(){this.nodeMap=void 0,this.urls=void 0,this._destroyed=!0}isDestroyed(){return this._destroyed}update(e){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}addUrl(e){this.urls.push(e)}clearUrls(){this.urls=[]}traverseUrls(e){this.urls.forEach((t=>{e(t)}))}traverse(e){const t=this.nodeMap;Object.keys(t).forEach((i=>{const r=t[i];e(r)}))}clearNodeMap(){this.nodeMap={}}clear(){this.clearUrls(),this.clearNodeMap()}},function(){const e={isInBox:(e,t)=>e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z,isIntersectsBox:(t,i)=>i.intersectsBox(t)?e.isInBox(t,i)?1:2:0,getBoxDistanceByRay:(e,t)=>e.intersectBoxWithDistance(t),getBoxDistanceByBox:(e,t,i,r)=>(t.applyMatrix4(i),e.intersectsBox(t)?1:-1)};class t extends r.Workers.DataParser{constructor(){super()}clear(){this.clearUrls()}getBoundingBox(e){return this.nodeMap[e].box}getOctreeList(e){return r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!"),[]}getNodeByIndex(e,t){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}holdNode(e,t){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}_traverse(e,t){const i=this,n=this.nodeMap;let a=r.Utils.scratchBoundingBox,s=function(r,n,o){if(a.setFromArray(o.boundingBox),e(a))return;let l=o.nodeIds;if(l)for(let n=0,s=l.length;n<s;++n){const s=l[n],{node:o,boudingBox:d}=i.getNodeByIndex(r,s);a.setFromArray(d),e(a)||t(o)}let d=o.children;d&&d.map((e=>{const t=n[e];s(r,n,t)}))};for(const t in n){if(a.copy(this.getBoundingBox(t)),e(a))continue;const i=this.getOctreeList(t),r=i[0];s(t,i,r)}}intersect(t,i,n,a,s,o){let l,d={};if(!i){let e=r.Utils.scratchMatrix4_1;e.copy(a).invert(),l=t.ray.clone().applyMatrix4(n).applyMatrix4(e)}return this._traverse((t=>{const r=i?e.getBoxDistanceByBox(i,t,a,s):e.getBoxDistanceByRay(l,t);return!o&&r<0}),(e=>{this.holdNode(e,d)})),d}getUserIdMapByFrustum(e,t,i){let r={};return this._traverse((r=>(r.applyMatrix4(t).applyMatrix4(i),!e.intersectsBox(r))),(e=>{this.holdNode(e,r)})),r}getObjectsInBox(t,i,r,n,a){this._traverse((t=>(t.applyMatrix4(n).applyMatrix4(a),!e.isIntersectsBox(t,r))),(e=>{const r=e.userId,n=i.getRealUserId(r);t[n]=!0}))}getObjectsInBoxByBimtile(e,t,i,r){this.getObjectsInBox(e,t,i,t.getTransformMatrix(),r)}setIs2D(e){}}r.Workers.SearchTreeParser=t}(),function(){class e extends r.Workers.SearchTreeParser{constructor(){super()}update(e){const{url:t,box:i}=e.params.element,r=e.data,n=this._parseNodeId(r),a=this._parseNodeIdBox(r);this.nodeMap[t]={nodes:{nodeIdItems:n,nodeIdBoxes:a,treeNodeItems:r.treeNodeItems},box:i}}_parseNodeId(e){const t=[],i=e.nodeIdItems[0];let r=[];r.length=5;for(let e=0,n=i.length;e<n;e+=5){for(let t=0;t<5;t++)r[t]=i[e+t];t.push({tileId:r[0],blockId:r[1],nodeId:r[2],userId:r[3],userdataId:r[4]})}return t}_parseNodeIdBox(e){const t=[],i=e.nodeIdBoxes[0];for(let e=0,r=i.length;e<r;e+=6){let r=[];r.length=6;for(let t=0;t<6;t++)r[t]=i[e+t];t.push(r)}return t}getOctreeList(e){return this.nodeMap[e].nodes.treeNodeItems}getNodeByIndex(e,t){const i=this.nodeMap[e].nodes;return{node:i.nodeIdItems[t],boudingBox:i.nodeIdBoxes[t]}}holdNode(e,t){const i=`${e.tileId}_${e.blockId}_${e.nodeId}`;void 0===t[e.userId]?t[e.userId]=[i]:t[e.userId].push(i)}}r.Workers.SearchTreeV1Parser=e}(),function(){class e extends r.Workers.SearchTreeParser{constructor(e){super(),this.reader=e}destroy(){this.reader=void 0,super.destroy()}update(e){const t=e.data,{url:i,box:r}=e.params.element;this.nodeMap[i]={nodes:t,box:r}}getOctreeList(e){return this.nodeMap[e].nodes}getNodeByIndex(e,t){const i=this.reader,r=i.getNodeByIndex(t);return{node:r,boudingBox:i.getNodeBBoxByIndex(r.bboxId)}}holdNode(e,t){const i=`${e.tileId}_${e.nodeId}`;void 0===t[e.userId]?t[e.userId]=[i]:t[e.userId].push(i)}}r.Workers.SearchTreeV2Parser=e}(),r.Workers.WireframeMaterialManager=class{constructor(){this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),this.wireframeMaterial.transparent=!0,this.wireframeMaterial.defines.USE_NO_SSAO="",this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),this.instanceWireframeMaterial.transparent=!0,this.instanceWireframeMaterial.defines.USE_NO_SSAO=""}destroy(){this.defaultWireframeColor=void 0,this.wireframeMaterial=void 0,this.instanceWireframeMaterial=void 0}getWireframeMaterial(){return this.wireframeMaterial}getInstanceWireframeMaterial(){return this.instanceWireframeMaterial}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){let e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){const e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}},function(){class e extends r.BimTileMaterialManager{constructor(e){super(e),this._textureManager=this.viewer.TextureManager,this._wireframeMaterialManager=new r.Workers.WireframeMaterialManager,this._materialParser=new r.Workers.MaterialParser}destroy(){this._textureManager=void 0,this._wireframeMaterialManager.destroy(),this._wireframeMaterialManager=void 0,this._materialParser.destroy(),this._materialParser=void 0,super.destroy()}parseMaterial(e,t){this._materialParser&&this._materialParser.update(e,t)}dealMaterialParm(e){e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY),e.side=0===e.doubleSide?THREE.FrontSide:THREE.DoubleSide,e.originMetalness=e.metalness,e.originRoughness=e.roughness,e.receiveIBL=0!=e.receiveIbl,e.light=!0!==e.hasLightMap,delete e.hasLightMap,e.hasOwnProperty("textureIds")&&delete e.textureIds,e.hasOwnProperty("customData")&&delete e.customData}_createMaterial(e,t,i,n,a){const s=i.receiveIBL&&r.GlobalData.IBL;r.Utils.isDefined(i.tintColor)&&0==i.tintColor&&(i.tintColor=16777215),i.useEnvLight=!0;const o=a?r.MaterialUtil.createInstanceMaterial(i,!0,s):r.MaterialUtil.createStandardMaterial(i,s);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!i.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e]);if(void 0!==o.refreshUniforms&&o.refreshUniforms(),this._updateMaterialPartlProps(e,o),this.materialMap[t]=o,a){const e=r.MaterialUtil.getMaterialParameters(o);let i=r.MaterialUtil.createInstanceMaterial(e,!0);i.transparent=!o.transparent,i.defines.INSTANCE_STATE_SECONDARY="",this.dealMaterialDefines(i),r.MaterialUtil.setCompressParm(i,n);const a=t+"_second";this.materialMap[a]=i}return r.Utils.isDefined(n.uvCenter)&&(o.uvCenter=n.uvCenter,o.uvHalfExtent=n.uvHalfExtent),r.MaterialUtil.setCompressParm(o,n),o}generateMaterialName(e,t,i){return`${-1===t?-1:`${e}_${t}`}_${i?"instance":"standard"}`}getDefaultMaterial(e,t,i){if(!i){const i=this.getDefaultStandardMaterial();return r.MaterialUtil.setCompressParm(i,t),this.dealMaterialDefines(i),i.name=e,this.materialMap[e]=i,i}const n=this.getDefaultInstanceMaterial();r.MaterialUtil.setCompressParm(n,t),this.dealMaterialDefines(n),n.name=e,this.materialMap[e]=n;const a=n.clone();a.transparent=!0,a.defines.INSTANCE_STATE_SECONDARY="",r.MaterialUtil.setCompressParm(a,t);const s=e+"_second";return this.materialMap[s]=a,n}_updateMaterialPartlProps(e,t){t.srcOpacity=t.opacity,null!=this.materialsOpacity&&(t.opacity=t.srcOpacity*this.materialsOpacity,t.transparent=!(t.opacity>1-r.TilesUtil.TWO_ACCURACY)),e.localClippingMode&&(t.clippingPlanes=e.localClippingPlanes,t.innerClipping=e.innerClippingMode,t.orthoViewProjMatrix.copy(e.innerClippingMatrix))}getLineMaterial(e,t,i){const{materialId:n,materialBlockId:a}=t,s=`${a}_${n}_line`;let o=this.materialMap[s];if(r.Utils.isDefined(o))return o._referenceCount++,Promise.resolve(o);const l=this._materialParser.getMaterialParm(a,n);return o=this._createLineMaterial(e,s,l,t,i),Promise.resolve(o)}_createLineMaterial(e,t,i,n,a){const s=a?r.MaterialUtil.createInstanceMaterial(i):new r.LineBasicMaterial({linewidth:1});if(a&&(s.receiveIBL=!1),this._updateMaterialPartlProps(e,s),s._imageByteSize=0,s._referenceCount=1,s.vertexColors=!!n.vertexColors,s.color.setHex(i.color),s.name=t,s.defines&&(s.defines.USE_COLORWITHOUTLIGHT=""),s.needsUpdate=!0,this.materialMap[t]=s,a){const e=r.MaterialUtil.getMaterialParameters(s);let i=this.createInstanceSecondMaterial(e);!0===s.transparent?i.transparent=!1:i.transparent=!0,i.defines.INSTANCE_STATE_SECONDARY="",i.defines.USE_COLORWITHOUTLIGHT="",this.dealMaterialDefines(i),r.MaterialUtil.setCompressParm(i,n);const a=t+"_second";i.name=a,this.materialMap[a]=i}return s}getMaterial(e,t,i,n){const{materialId:a,materialBlockId:s,vertexColors:o,hasLightMap:l}=i,d=this.generateMaterialName(s,a,n);let h;if(-1===a)return h=this.getDefaultMaterial(d,i,n),this.updateMaterialUseCompressedNormal(h),Promise.resolve(h);if(h=this.getMaterialByName(d),r.Utils.isDefined(h))return Promise.resolve(h);let c=r.Utils.clone(this._materialParser.getMaterialParm(s,a),!0);return c.vertexColors=o,c.hasLightMap=l,this.dealMaterialParm(c),h=this._createMaterial(e,d,c,i,n),this.updateMaterialUseCompressedNormal(h),this._createTexture(t,h,s,a)}_createTexture(e,t,i,n){const a=this._textureManager,s=this._materialParser.getTextureIdsByMaterialId(i,n),o=r.Workers.TextureType;if(!s)return Promise.resolve(t);const l=[];for(let t=0,d=s.length;t<d;++t){const d=s[t],h=this._materialParser.getTextureParm(i,d);if(!r.Utils.isDefined(h)||h.image<0)continue;const c=this._materialParser.getImageParm(i,h.image);if(!r.Utils.isDefined(c))continue;const u=h.alpha>0?o.TT_ALPHA:h.type,p=c.type;let m=h.name||`${i}_${n}`;if(c.url){const t=`${e}${c.url}`;m=r.Utils.getEncodedString(t+m);const i=new Promise(((e,i)=>{a.getTextureFromURL(t,m,{textureParm:h,imageType:p,fromWorker:true}).then((t=>{e({textureType:u,texture:t})})).catch((e=>{i(e)}))}));l.push(i)}else if(c.bufferId>=0){const e=this._getImageBuffer(c),t=new Promise(((t,i)=>{a.getTextureFromBuffer(e,m,{textureParm:h,imageType:p,fromWorker:true}).then((e=>{t({textureType:u,texture:e})})).catch((e=>{i(e)}))}));l.push(t)}}return 0===l.length?Promise.resolve().then((()=>t)):Promise.all(l).then((e=>(e.forEach((e=>{this._setTexture(t,e.textureType,e.texture)})),t)))}_setTexture(e,t,i){const n=r.MaterialUtil.getImageByteSize(i.image);e._imageByteSize+=n;const a=r.Workers.TextureType;switch(t){case a.TT_DIFFUSE:e.map=i;break;case a.TT_SPECULAR:e.specularMap=i;break;case a.TT_EMISSIVE:e.emissiveMap=i;break;case a.TT_ENVIRONMENT:e.envMap=i;break;case a.TT_ALPHA:e.useAlphaMap=!0,e.map=i,e.transparent=!0,e.alphaTest=.01,this._dealInstanceSecondMaterialAlpha(e);break;case a.TT_RELIEF:case a.TT_BUMP:e.bumpMap=i,e.bumpScale=i.bumpScale,e.bumpUvTransform=i.matrix;break;case a.TT_LIGHT:e.lightMap=i,e.defines.USE_COMPONENT_LIGHTMAP="",e.lightMapIntensity=r.GlobalData.LightmapIntensity}if(e.refreshUniforms(),e.needsUpdate=!0,""===e.defines.USE_INSTANCE){const r=e.name+"_second";let n=this.materialMap[r];if(!n)return;i._referenceCount++,this._setTexture(n,t,i)}}_getImageBuffer(e){return e.imageBuffer}getWireframeMaterial(){return this._wireframeMaterialManager.getWireframeMaterial()}getInstanceWireframeMaterial(){return this._wireframeMaterialManager.getInstanceWireframeMaterial()}setWireframeColor(e,t){return this._wireframeMaterialManager.setWireframeColor(e,t)}getWireframeColor(){return this._wireframeMaterialManager.getWireframeColor()}restoreWireframeColor(){return this._wireframeMaterialManager.restoreWireframeColor()}}r.Workers.MaterialManager=e}(),r.Workers.MaterialParser=class{constructor(){this.materialDataMap={},this._destroyed=!1}destroy(){this.materialDataMap=void 0,this._destroyed=!0}isDestroyed(){return this._destroyed}update(e,t){if(this.isDestroyed())return;const i=e;t?Array.isArray(i)?i.forEach((e=>{Object.keys(e).forEach((t=>{this.materialDataMap[t]=e[t]}))})):Object.keys(i).forEach((e=>{this.materialDataMap[e]=i[e]})):Array.isArray(i)?i.forEach((e=>{Object.keys(e).forEach((t=>{this.materialDataMap[t]=e[t]}))})):this.materialDataMap=i}_getMaterialBlock(e){return this.materialDataMap[e]}getTextureIdsByMaterialId(e,t){return this._getMaterialBlock(e).materials[t].textureIds}getMaterialParm(e,t){return this._getMaterialBlock(e).materials[t]}getTextureParm(e,t){return this._getMaterialBlock(e).textures[t]}getImageParm(e,t){return this._getMaterialBlock(e).images[t]}},function(){class e extends r.Workers.DataParser{constructor(){super(),this.userIdInfoMap={},this.userIdMap={},this.userIdIndexMap={}}destroy(){this.userIdInfoMap=void 0,this.userIdMap=void 0,this.userIdIndexMap=void 0,super.destroy()}clear(){this.userIdInfoMap={},super.clear()}update(e){if(this.isDestroyed())return;const t=JSON.parse(e.data),i=t.userIdInfoMap;for(const e in i)this.userIdInfoMap[e]=i[e];const r=t.userIdMap;for(const e in r)this.userIdMap[e]=r[e];const n=t.userIdIndexMap;for(const e in n)this.userIdIndexMap[e]=n[e]}getUserIdByIndex(e){return this.userIdMap[e]}getAllUserIds(){return Object.keys(this.userIdIndexMap)}getIndexByUserId(e){return this.userIdIndexMap[e]}traverse(e){const t=this.userIdInfoMap;Object.keys(t).forEach((i=>{const r=t[i];e(r)}))}}r.Workers.UserIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.userDataKeyMap={},this.userDataKeys={},this.userDataValueMap={},this.userDataValues={},this.userDataItems={},this.blockIds=[]}destroy(){this.userDataKeyMap=void 0,this.userDataKeys=void 0,this.userDataValueMap=void 0,this.userDataValues=void 0,this.userDataItems=void 0,this.blockIds=void 0,super.destroy()}update(e){if(this.isDestroyed())return;const t=JSON.parse(e.data);this.userDataKeyMap=t.userDataKeyMap,this.userDataKeys=t.userDataKeys,this.userDataValueMap=t.userDataValueMap,this.userDataValues=t.userDataValues,this.userDataItems=t.userDataItems,this.blockIds=Object.keys(t.userDataKeyMap)}getUserDataKeyMap(){const e=this.blockIds[0];return this.userDataKeyMap[e]}getUserDataValueMap(){const e=this.blockIds[0];return this.userDataValueMap[e]}getUserDataKeys(){const e=this.blockIds[0];return this.userDataKeys[e]}getUserDataValues(){const e=this.blockIds[0];return this.userDataValues[e]}getUserDataItems(){const e=this.blockIds[0];return this.userDataItems[e]}getUserDataIndexMapByString(e,t){const i=this.getUserDataKeyMap(),r=this.getUserDataValueMap();if(!i||!r)return;const n=i[e];let a;return t instanceof Array?(a=[],t.forEach((e=>{void 0!==r[e]&&a.push(r[e])}))):a=r[t],{key:n,value:a}}getUserDataStringMapByIndex(e,t){const i=this.getUserDataKeys(),r=this.getUserDataValues();return[i[e],r[t]]}getUserDataByIndex(e){return this.getUserDataById(e)}getUserDataById(e){const t=this.getUserDataItems();if(t)return t[e]}getUserDataIndexKeyByString(e){return this.getUserDataKeyMap()[e]}getUserDataIndexValueByString(e){const t=this.getUserDataValueMap();let i;return e instanceof Array?(i=[],e.forEach((e=>{void 0!==t[e]&&i.push(t[e])}))):i=t[e],i}shallowCopy(e){this.userDataKeyMap=e.userDataKeyMap,this.userDataKeys=e.userDataKeys,this.userDataValueMap=e.userDataValueMap,this.userDataValues=e.userDataValues,this.userDataItems=e.userDataItems,this.blockIds=e.blockIds}}r.Workers.UserDataParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.tileIdMap={},this.tileIds={},this.blockIds=[]}destroy(){this.tileIdMap=void 0,this.tileIds=void 0,this.blockIds=void 0,super.destroy()}clear(){this.tileIdMap={},this.tileIds={},this.blockIds=[],super.clear()}update(e){if(this.isDestroyed())return;const t=JSON.parse(e.data);this.tileIdMap=t.tileIdMap,this.tileIds=t.tileIds,this.blockIds=Object.keys(t.tileIdMap)}getTilePath(e){const t=this.blockIds;for(let i=0,r=t.length;i<r;++i){const r=t[i],n=this.tileIds[r][e];if(n)return n}}isInstanceTile(e){return-1!==this.getTilePath(e).indexOf("instance")}}r.Workers.TileIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super()}clear(){this.clearUrls()}update(e){if(this.isDestroyed())return;const t=e.params.element.startPos,i=e.data[0];let r=[];r.length=4;let n=0;for(let e=0,a=i.length;e<a;e+=4){for(let t=0;t<4;t++)r[t]=i[e+t];const a=t+n;this.nodeMap[a]={tileId:r[0],nodeId:r[1],userId:r[2],bboxId:r[3]},n++}}getNode(e){return this.nodeMap[e]}traverse(e){const t=this.nodeMap;Object.keys(t).forEach((i=>{e(t[i])}))}}r.Workers.NodeIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.nodeMap=new Map}clear(){this.clearUrls()}update(e){if(this.isDestroyed())return;const t=e.params.element.startPos,i=e.data[0];let r=0;for(let e=0,n=i.length;e<n;e+=6){let n=[];n.length=6;for(let t=0;t<6;t++)n[t]=i[e+t];const a=t+r;this.nodeMap.set(a,n),r++}}getNode(e){return this.nodeMap.get(parseInt(e))}}r.Workers.NodeBoxParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.userIdMap=new Map,this.userIdIndexMap=new Map,this.userdataIdMap=new Map}destroy(){this.userdataIdMap=void 0,this.userIdMap=void 0,this.userIdIndexMap=void 0,super.destroy()}clear(){this.userdataIdMap.clear(),super.clear()}update(e){if(this.isDestroyed())return;const t=e.data[0],i=t.userIds,n=t.minUserIdIndex,a=t.userdataIds,s=new r.Workers.BinaryDecoder(i);let o=0;for(;!s.atEnd();){let e=n+o,t=s.readUnsignedVarint32();const i=s.readString(t);this.userIdMap.set(e,i),this.userIdIndexMap.set(i,e),this.userdataIdMap.set(e,a[o]),o++}s.destroy()}getUserIdByIndex(e){return this.userIdMap.get(parseInt(e))}getIndexByUserId(e){return this.userIdIndexMap.get(e)}getUserdataIdByIndex(e){return this.userdataIdMap.get(e)}getAllUserIds(){return Array.from(this.userIdIndexMap.keys())}}r.Workers.UserIdV2Parser=e}(),function(){class e{constructor(){this._refCount=0,this._id=null,this._state=r.SharedGeometryState.UNLOADED,this._byteLength=0,this._geometries=[]}get refCount(){return this._refCount}set refCount(e){this._refCount=e}get id(){return this._id}set id(e){this._id=e}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}get state(){return this._state}set state(e){this._state=e}ref(){++this._refCount}unRef(){--this._refCount}addGeometry(e){this._geometries.push(e)}getGeometryCount(){return this._geometries.length}getGeometry(e){return this._geometries[e]}getNodeInfo(e){return this._geometries[e]?this._geometries[e].nodeInfo:void 0}getGeometryInfo(e){return this._geometries[e]?this._geometries[e].geometry:void 0}contentProcessing(){return this._state===r.SharedGeometryState.PROCESSING}contentUnloaded(){return this._state===r.SharedGeometryState.UNLOADED}destroy(){this._state=r.SharedGeometryState.DESTROYED,this._id=null,this._geometries=null}}r.Workers.SharedGeometry=e,r.Workers.SharedGeometryManager=class{constructor(){this._geometryMap={}}destroy(){for(const e in this._geometryMap)if(Object.hasOwnProperty.call(this._geometryMap,e)){this._geometryMap[e].destroy(),delete this._geometryMap[e]}this._geometryMap=null}setGeometryByteLength(e,t){let i=this._geometryMap[e];r.Utils.defined(i)&&(i.byteLength=t)}createGeometryById(t){let i=this._geometryMap[t];return r.Utils.defined(i)||(i=this._geometryMap[t]=new e,i.id=t),i}disposeGeometry(e){const t=this.getGeometryById(e);return!!r.Utils.defined(t)&&(!t.contentUnloaded&&!t.contentProcessing&&(t.unRef(),0===t.refCount&&(t.destroy(),delete this._geometryMap[e],!0)))}getGeometryById(e){return this._geometryMap[e]}}}(),r.Workers.BatchedOutlineBuilder=class{constructor(e){this._meshBuilder=e}destroy(){this._meshBuilder=void 0}build(e,t){this._setWireFrameVisibility(e);const i=t.parsedData[r.Workers.TileBlockType.BT_LINE];0!==i.length&&i.forEach((t=>{this._createMesh(e,t)}))}_setWireFrameVisibility(e){const t=e._tile,i=t._loader;t.wireFrameVisibilityOption=i.wireFrameVisibilityOption}_createMesh(e,t){const i=e.outlineMeshes,n=e._tile,a=n._loader,s=this._getNodeInfo(n,t.nodeInfo),o=this._createGeometry(t.geometry,s),l=this._getMaterial(a),d=new r.LineSegmentsEx(o,[l]);d.applyMatrix4(s.matrix),d.name=s.nodeId,d.tileId=s.tileId,d.indexGroups=s.indexInfos,d.databagId=i.databagId,d.fileId=i.fileId,d.renderOrder=r.EnumRenderOrder.WireFrame,i.add(d),a.addLineNodeById(d.tileId,s.nodeId,d),a.dealLineMeshVisible(d)}_getMaterial(e){return e.materialManager.getWireframeMaterial()}_getNodeInfo(e,t){return this._updateNodeInfo(e,t),this._addUserIdMapIndices(e._loader,t.nodeId,t.userIdMapIndex),t}_addUserIdMapIndices(e,t,i){this._meshBuilder._addUserIdMapIndices(e,t,i)}_updateNodeInfo(e,t){if(r.Utils.isDefined(e.contentId)){t.tileId=e.contentId;const i=t.nodeId.split("_");i[0]=e.contentId,t.nodeId=i.join("_")}const i=`outline_${t.nodeId}`;t.nodeId=i;const n=`outline_${t.tileId}`;t.tileId=n,this._meshBuilder._updateNodeInfo(e,t)}_createGeometry(e,t){return this._meshBuilder._createGeometry(e,t)}},function(){function e(e,t){const i=new Float32Array(4*e);return i.fill(t),{array:i,itemSize:4,normalized:!1,meshPerAttribute:1}}function t(e,t){const i=new Float32Array(4*e);let r=0;for(let n=0;n<e;++n)i[r++]=t.r,i[r++]=t.g,i[r++]=t.b,i[r++]=void 0!==t.opacity?t.opacity:1;return{array:i,itemSize:4,normalized:!1,meshPerAttribute:1}}function i(e,t){const i=new Float32Array(e);return i.fill(t),{array:i,itemSize:1,normalized:!1,meshPerAttribute:1}}function n(e,t){const i=e.length,n=[],a=3*i;for(let e=0;e<4;++e){const t=new Float32Array(a);n.push({name:`mcol${e}`,array:t,itemSize:3,normalized:!1,meshPerAttribute:1})}let s=new Array(n.length);s.fill(0);let o=r.Utils.scratchMatrix4_1;for(let r=0;r<i;++r){o.copy(e[r].entityMatrix),t&&o.multiply(t);const i=o.elements;n.forEach(((e,t)=>{const r=e.array;r[s[t]++]=i[0+4*t],r[s[t]++]=i[1+4*t],r[s[t]++]=i[2+4*t]}))}return n}r.Workers.InstancedOutlineBuilder=class{constructor(e){this._meshBuilder=e}destroy(){this._meshBuilder=void 0}build(e,t){this._setWireFrameVisibility(e);const i=e._tile,n=this._getInstanceInfos(i);if(!n||0===n.length)return;const a=t?t.parsedData[r.Workers.TileBlockType.BT_LINE]:void 0,s=this._getGeometries(e,a);0!==s.length&&this._parseMeshes(e,n,s)}_setWireFrameVisibility(e){const t=e._tile,i=t._loader;t.wireFrameVisibilityOption=i.wireFrameVisibilityOption}_getInstanceInfos(e){return e.instanceInfos}_getGeometries(e,t){const i=[];if(t&&t.length){const r=e._tile;for(let e=0,n=t.length;e<n;++e){const n=t[e],a=this._getGeometryInfo(r,n,e);i.push(a)}}return i}_parseMeshes(e,t,i){const r=[];for(let n=0,a=t.length;n<a;++n){const a=t[n].nodeInfo,s=i[n],o=this._createMesh(e,a,s);r.push(o)}return r}_getMeshMatrixRoot(e,t){return e.getInstanceMeshNodeById(t).entries().next().value[1].mesh.matrixRoot}_createMesh(e,t,i){const n=e.outlineMeshes,a=e._tile,s=a._loader,o=t.nodeId,l=i.blockId,d=i.geometry,h=this._getMeshMatrixRoot(s,o),c=this._createInstanceAttributes(a,t,h),u=this._createGeometry(d,c),p=this._getMaterial(s);let m=new r.LineSegmentsEx(u,p);m.name=o,m.tileId=`outline_${a.contentId}`,m.frustumCulled=!1,m.isInstanceMeshNode=!0,m.blockId=l,m.visible=!s.disableUserData&&s.isBorderLineVisible(),m.renderOrder=r.EnumRenderOrder.WireFrame,m.databagId=n.databagId,m.fileId=n.fileId,m.applyMatrix4(t.modelMatrix);const f=r.Workers.InstancedMeshBuilder.cloneMeshFrom(m,p);f.visible=!1,n.add(m),n.add(f),s.addInstanceLineNodeById(m.tileId,m)}_createGeometry(e,t){const i=new THREE.InstancedBufferGeometry;return e.index&&i.setIndex(e.index),e.attributes.forEach((e=>{i.setAttribute(e.name,e.attribute)})),this._createCustomAttributes(i,t),i}_createInstanceAttributes(a,s,o){const l=a._loader,d=s.entityInfoArray,h=d.length,c=[];c.push({name:"mcols",attribute:n(d,o)});const u=r.MaterialUtil.DefaultWireframeColor;c.push({name:"aColor",attribute:t(h,{r:u.color.r,g:u.color.g,b:u.color.b,opacity:u.opacity})});const p=r.TilesUtil.matchWireFrameVisibilityOption(d[0].userId,a.wireFrameVisibilityOption)?r.EnumElementState.NONE:r.EnumElementState.HIDDEN;c.push({name:"vState",attribute:e(h,p)});const m=l.filter.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE;return c.push({name:"vClipping",attribute:i(h,m)}),c}_getMaterial(e){return e.materialManager.getInstanceWireframeMaterial()}_getGeometryInfo(e,t,i){return this._meshBuilder._getGeometryInfo(e,t,i)}updateGeomteries(e){this._meshBuilder.updateGeomteries(e)}_createCustomAttributes(e,t){this._meshBuilder._createCustomAttributes(e,t)}}}(),r.Workers.BatchedMeshBuilder=class{constructor(){}destroy(){}build(e,t){let i=[],n=[];const a=r.Workers.TileBlockType;return t.forEach((e=>{const t=e.parsedData;Object.keys(t).forEach((e=>{const r=t[e],s=Number(e);s===a.BT_LINE||s===a.BT_MESH?i.push(...r):s===a.BT_MATERIAL&&n.push(r)}))})),n.length&&this._parseMaterials(e,n),this._parseMeshes(e,i)}_parseMaterials(e,t){const i=e._loader.materialManager,r=[],n=e.contentId;t.forEach((e=>{let t={};for(let i in e){const r=e[i];t[`${n}_${r.header.blockId}`]=r}r.push(t)})),i.parseMaterial(r,!0)}_parseMeshes(e,t){if(0===t.length)return null;const i=[];return t.forEach((t=>{const r=this._createMesh(e,t);i.push(r)})),i}_getNodeInfo(e,t){const i=e._loader;return this._updateNodeInfo(e,t),this._addUserIdMapIndices(i,t.nodeId,t.userIdMapIndex),this._updateMeshNodeInfo(e,i,t),t}_updateNodeInfo(e,t){let i=new THREE.Matrix4;t.matrix&&(Array.isArray(t.matrix)?(t.matrixElements=t.matrix,i.fromArray(t.matrixElements)):t.matrixElements&&i.fromArray(t.matrixElements)),t.matrixRoot=i.clone(),i.premultiply(e.matrix),t.matrix=i,t.uvCenter&&Array.isArray(t.uvCenter)&&(t.uvCenter=(new THREE.Vector2).fromArray(t.uvCenter),t.uvHalfExtent=(new THREE.Vector2).fromArray(t.uvHalfExtent)),this._parseSubnodeIndexInfos(t)}_createGeometry(e,t){const i=new THREE.BufferGeometry;return i.groups.push({start:t.indexStart,count:t.indexCount,materialIndex:0}),e.index&&i.setIndex(new THREE.BufferAttribute(e.index.array,1)),e.attributes.forEach((e=>{i.setAttribute(e.name,new THREE.BufferAttribute(e.array,e.itemSize,e.normalized))})),i}_isEnableShadowMap(){return r.GlobalData.EnableShadowMap}_updateMeshNodeInfo(e,t,i){if(!i.indexInfos)return;const r=i.indexInfos,n=t.materialManager.generateMaterialName(i.materialBlockId,i.materialId);for(const a of r.keys()){e.userIndexMap.set(a,!0);const s=r.get(a);for(const e of s.keys()){const r={parent:i.nodeId,matrix:i.matrix,materialId:n};t.disableUserData?t.addNoUserDataMeshNodeInfo(a,e,r):t.patchMeshNodeInfo(a,e,r)}}}_parseSubnodeIndexInfos(e){const t=e.indexInfos;if(!t)return;if(t instanceof Map)return;const i=e.numComponentsOfIndexInfo,r=t.length;if(0===r||r%i!=0)return console.log("Data parsing error!"),void(e.indexInfos=void 0);e.userIdMapIndex=[];const n=new Map,a=e.tileId,s=e.blockId;for(let r=0,o=t.length;r<o;r+=i){let i=r;const o=t[i++],l=t[i++],d=t[i++],h={positionStart:t[i++],positionCount:t[i++],indexStart:t[i++],indexCount:t[i++],uvStart:t[i++],uvCount:t[i++],colorStart:t[i++],colorCount:t[i++],cNormalStart:t[i++],cNormalCount:t[i++]},c=`${a}_${s}_${l}`;!1===n.has(o)&&n.set(o,new Map),n.get(o).set(c,h),e.userIdMapIndex.push({userId:o,index:d})}e.indexInfos=n}_addToMeshIdMap(e,t,i){e.addMeshIdMap(t,i)}_addUserIdMapIndices(e,t,i){e.pbfNodeInfoMap[t]||i&&e.addUserIdMapIndices(i,t),e.pbfNodeInfoMap[t]=!0}_addGeometryById(e,t){e._tileset.geometryManager.addGeometryById(e.nodeId,t)}_createMesh(e,t){return new Promise(((i,n)=>{const a=this._getNodeInfo(e,t.nodeInfo),s=this._createGeometry(t.geometry,a),o=e._loader,l=o.getDescriptor(),d=e.content.meshes,h=a.nodeId,c=this._isLineMode(a),u=c?r.LineSegmentsEx:r.MeshEx;this._getMaterial(o,a,c).then((e=>{const t=new u(s,[e]);if(t.frustumCulled=!1,t.name=h,t.indexGroups=a.indexInfos,t.indexCount=s.index.count,t.databagId=d.databagId,t.fileId=d.fileId,t.applyMatrix4(a.matrix),this._isEnableShadowMap()){const e=o.filter.model;t.castShadow=e.castShadow,t.receiveShadow=e.receiveShadow}d.add(t),this._addToMeshIdMap(o,h,t);for(const e of a.indexInfos.keys()){const t=l.mapNodeInfoByBatched.get(e);if(!t)continue;const i=t.get(h);i&&l.onNodeInfoChanged(i)}i()})).catch((e=>{n(e)}))}))}_getMaterial(e,t,i){const r=e.filter.model,n=e.materialManager,a={materialBlockId:t.materialBlockId,materialId:t.materialId,uvCenter:t.uvCenter,uvHalfExtent:t.uvHalfExtent,vertexColors:t.vertexColors,useCompressedNormal:t.useCompressedNormal,useCompressedColor:t.useCompressedColor,useCompressedUv:t.useCompressedUv,hasLightMap:t.hasLightMap,useBCOutline:t.useBCOutline,isShadowExterior:t.isShadowExterior,isLine:i};return"0.0.3"===r.dataVersion&&(a.growthAnimationMap=r.userIdAnimationMap,a.growthAnimationMapSizeWidth=r.USERID_ANIMATION_MAP_WIDTH,a.growthAnimationMapSizeHeight=r.USERID_ANIMATION_MAP_HEIGHT,a.growthAnimationPlanes=r.viewer.growthAnimationManager.planeUniform.value),n.getMaterial(r,e.rootUrl,a,!1)}_isLineMode(e){return e.primitiveMode===r.Workers.PrimitiveMode.PM_LINES}},function(){function e(e,t){const i=e.geometry,n=new THREE.InstancedBufferGeometry;n.setAttribute("position",i.getAttribute("position")),i.getAttribute("normal")&&n.setAttribute("normal",i.getAttribute("normal")),i.getAttribute("cNormal")&&n.setAttribute("cNormal",i.getAttribute("cNormal")),i.getAttribute("color")&&n.setAttribute("color",i.getAttribute("color")),i.getAttribute("barycentric")&&n.setAttribute("barycentric",i.getAttribute("barycentric")),i.getAttribute("uv")&&n.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&n.setAttribute("uv2",i.getAttribute("uv2")),i.getAttribute("uv3")&&n.setAttribute("uv3",i.getAttribute("uv3")),n.setAttribute("mcol0",i.getAttribute("mcol0")),n.setAttribute("mcol1",i.getAttribute("mcol1")),n.setAttribute("mcol2",i.getAttribute("mcol2")),n.setAttribute("mcol3",i.getAttribute("mcol3")),i.getAttribute("muvCol0")&&(n.setAttribute("muvCol0",i.getAttribute("muvCol0")),n.setAttribute("muvCol1",i.getAttribute("muvCol1"))),i.getAttribute("id")&&n.setAttribute("id",i.getAttribute("id")),n.setAttribute("aColor",i.getAttribute("aColor")),n.setAttribute("vClipping",i.getAttribute("vClipping")),i.getAttribute("pointColorState")&&n.setAttribute("pointColorState",i.getAttribute("pointColorState")),n.setAttribute("vState",i.getAttribute("vState").clone()),n.getAttribute("vState").array.fill(-1),n.setIndex(i.getIndex());let a=null;return a="LineSegmentsEx"===e.type?new r.LineSegmentsEx(n,t):new r.MeshEx(n,t),a.databagId=e.databagId,a.fileId=e.fileId,a.frustumCulled=e.frustumCulled,a.name=`${e.name}_copy`,a.indexGroups=e.indexGroups,a.indexCount=e.indexCount,a.insLodLevels=e.insLodLevels,a.insLodLevel=e.insLodLevel,a.isInstanceMeshNode=!0,a.isCopyMesh=!0,a.matrixRoot=e.matrixRoot,e.isMeshQuantization&&(a.isMeshQuantization=e.isMeshQuantization),e.customDepthMaterial&&(a.customDepthMaterial=e.customDepthMaterial,a.castShadow=!e.castShadow,a.receiveShadow=!e.receiveShadow),e.matrix&&(a.matrix=e.matrix,a.matrixAutoUpdate=!1,a.updateMatrixWorld()),a}class t{constructor(){}destroy(){}build(e,t){let i=[],n=[],a=[];const s=r.Workers.TileBlockType;t.forEach((e=>{const t=e.parsedData;Object.keys(t).forEach((e=>{const r=t[e],o=Number(e);o===s.BT_LINE||o===s.BT_MESH?n.push(...r):o===s.BT_INSTANCE?i.push(...r):o===s.BT_MATERIAL&&a.push(r)}))}));const o=this._parseInstances(e,i);if(0===o.length)return null;this._holdInstanceNodeInfos(e,o);const l=this._parseGeometries(e,n);return 0===l.length?null:(a.length&&this._parseMaterials(e,a),this._parseMeshes(e,o,l))}_holdInstanceNodeInfos(e,t){e.instanceInfos=[],t.forEach((t=>{e.instanceInfos.push(t)})),e.instanceInfo=e.instanceInfos[0].nodeInfo,e.nodeIndexId=e.instanceInfo.nodeId}_parseInstances(e,t){const i=[];for(let r=0,n=t.length;r<n;++r){const n=t[r],a=this._getInstanceInfo(e,n);i.push(a)}return i}_parseGeometries(e,t){const i=[];if(t.length)for(let r=0,n=t.length;r<n;++r){const n=t[r],a=this._getGeometryInfo(e,n,r);i.push(a)}return i}_parseMaterials(e,t){const i=e._loader.materialManager;t.forEach((e=>{i.parseMaterial(e,!0)}))}_parseMeshes(e,t,i,r,n){const a=[];for(let s=0,o=t.length;s<o;++s){const o=t[s],l=i[s],d=this._createMesh(e,o,l,r,n);a.push(d)}return a}_createMesh(t,i,n,a,s){return new Promise(((o,l)=>{const d=i.nodeInfo,h=i.geometry,c=n.blockId,u=n.nodeInfo,p=n.geometry,m=this._createGeometry(u,p,h),f=t._loader,g=f.getDescriptor(),v=d.nodeId;let y=(new THREE.Matrix4).copy(t.matrix);d.rootMatrix&&y.multiply(d.rootMatrix),d.modelMatrix=y,u.isShadowExterior=t.isShadowExterior;const M=u.primitiveMode===r.Workers.PrimitiveMode.PM_LINES?r.LineSegmentsEx:r.MeshEx;this._getMaterial(f,u).then((r=>{const n=r[0];this._updateCustomAttributeBuffer(n,u.matrix,d.entityInfoArray,h,f,m);const l=new M(m,n);l.frustumCulled=!1,l.isInstanceMeshNode=!0,l.blockId=c,l.name=v,l.databagId=t.content.meshes.databagId,l.fileId=t.content.meshes.fileId,l.indexGroups=u.indexInfos,l.indexCount=u.indexCount,l.matrixRoot=u.matrix,l.insLodLevel=a,s&&(l.isMeshQuantization=u.isCompressedMode),l.isShadowExterior=t.isShadowExterior,l.applyMatrix4(y);const p=f.filter.model.viewer.treeAnimationManager;if(p&&(!0===n.isTreeTrunk?p.addTrunkMesh(l):!0===n.isTreeLeaves&&p.addLeavesMesh(l)),this._isEnableShadowMap()){const e=t._loader.filter.model;l.customDepthMaterial=e.manager.getInstanceDepthMaterial(),l.castShadow=!1===n.transparent&&e.castShadow,l.receiveShadow=e.receiveShadow}const E=e(l,r[1]);E.visible=!1,this.addMeshToGroup(t,i,v,c,l,E,y);for(let e=0;e<d.entityInfoArray.length;++e){const t=d.entityInfoArray[e];if(g.userIdInstanceInfoMap){const i=g.userIdInstanceInfoMap.get(t.userID);g.onNodeInfoChanged(i,d.tileId,e)}else if(g.mapNodeInfoByInstance){const r=g.mapNodeInfoByInstance.get(t.userID);if(!r)continue;const n=r.get(i.nodeId);if(!n)continue;const a=n.get(e);if(!a)continue;g.onNodeInfoChanged(a)}}o()})).catch((e=>{l(e)}))}))}addMeshToGroup(e,t,i,r,n,a,s){const o=e._loader,l=e.content.meshes;l.add(n),l.add(a),this._addToMeshIdMap(o,i,r,n,a,s)}_getGeometryInfo(e,t,i){return{blockId:i,nodeInfo:t.nodeInfo,geometry:t.geometry}}updateGeomteries(e){const t=e.parsedData,i=Object.keys(t),n=r.Workers.TileBlockType;i.forEach((e=>{const i=t[e],r=Number(e);r!==n.BT_LINE&&r!==n.BT_MESH||i.forEach((e=>{this._updateGeomteryInfo(e)}))}))}_updateGeomteryInfo(e){if(e.cached)return;e.cached=!0;const t=e.nodeInfo;let i=new THREE.Matrix4;t.matrix&&Array.isArray(t.matrix)&&(i.fromArray(t.matrix),t.matrix=i),t.uvCenter&&Array.isArray(t.uvCenter)&&(t.uvCenter=(new THREE.Vector2).fromArray(t.uvCenter),t.uvHalfExtent=(new THREE.Vector2).fromArray(t.uvHalfExtent));const r=e.geometry,n={attributes:[]};r.index&&(n.index=new THREE.BufferAttribute(r.index.array,1)),r.attributes.forEach((e=>{n.attributes.push({name:e.name,attribute:new THREE.BufferAttribute(e.array,e.itemSize,e.normalized)})})),e.geometry=n}_getInstanceInfo(e,t){const i=e._loader,r=t.geometry.attributes,n=t.nodeInfo,a=`${-1==n.tileId?e.contentId:n.tileId}_${n.blockId}`;n.nodeId=a;const s=n.entityInfoArray;if(n.cached)s.forEach(((t,r)=>{e.userIndexMap.set(t.userID,!0),this._updateInstanceNodeInfo(i,t,a,r)})),this._addToInstanceInfoMap(i,a,s);else{n.cached=!0,n.rootMatrix=(new THREE.Matrix4).fromArray(n.rootMatrix);const t=i.tileReader.userDataParser,r=s[0],o=s[1],l=s[2],d=s[3],h=s[4];let c=[];r.forEach(((r,n)=>{let s=o[n],u={userID:r,userDataID:s,userData:t.getUserDataById(s),color:l[n],entityMatrix:(new THREE.Matrix4).fromArray(d,16*n),uv3:[h[2*n],h[2*n+1]]};c.push(u),e.userIndexMap.set(r,!0),this._updateInstanceNodeInfo(i,u,a,n)})),n.entityInfoArray=c,this._addToInstanceInfoMap(i,a,c)}return{nodeInfo:n,geometry:r}}_createGeometry(e,t,i){const r=new THREE.InstancedBufferGeometry;return r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:0}),r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:1}),t.index&&r.setIndex(t.index),t.attributes.forEach((e=>{r.setAttribute(e.name,e.attribute)})),this._createCustomAttributes(r,i),r}_createCustomAttributes(e,t){t.forEach((t=>{if(Array.isArray(t.attribute))t.attribute.forEach((t=>{e.setAttribute(t.name,new THREE.InstancedBufferAttribute(t.array,t.itemSize,t.normalized,t.meshPerAttribute))}));else{const i=t.attribute;if("uv3"===t.name&&i.array.length>0&&i.array[0]<0)return;e.setAttribute(t.name,new THREE.InstancedBufferAttribute(i.array,i.itemSize,i.normalized,i.meshPerAttribute))}}))}_getMaterial(e,t){const i=e.filter.model,n=e.materialManager,a={materialBlockId:t.materialBlockId,materialId:t.materialId,uvCenter:t.uvCenter,uvHalfExtent:t.uvHalfExtent,vertexColors:t.vertexColors,useCompressedNormal:t.useCompressedNormal,useCompressedColor:t.useCompressedColor,useCompressedUv:t.useCompressedUv,hasLightMap:t.hasLightMap,useBCOutline:t.useBCOutline,isShadowExterior:t.isShadowExterior,growthAnimationMap:i.userIdAnimationMap,growthAnimationMapSizeWidth:i.USERID_ANIMATION_MAP_WIDTH,growthAnimationMapSizeHeight:i.USERID_ANIMATION_MAP_HEIGHT,growthAnimationPlanes:i.viewer.growthAnimationManager.planeUniform.value};let s=null;return s=t.primitiveMode===r.Workers.PrimitiveMode.PM_LINES?n.getLineMaterial(i,a,!0):n.getMaterial(i,e.rootUrl,a,!0),s.then((e=>{const t=e.name+"_second";return[e,n.getMaterialByName(t)]}))}_addToMeshIdMap(e,t,i,r,n,a){e.addInstanceMeshIdMap(t,i,r,a)}_addToInstanceInfoMap(e,t,i){e.addInstanceInfo(t,i)}_isEnableShadowMap(){return r.GlobalData.EnableShadowMap}_updateInstanceNodeInfo(e,t,i,r){const n=t.userID,a={bufferId:i,instanceIndex:r,entityMatrix:t.entityMatrix};e.disableUserData?e.addNoUserDataInstanceNodeInfo(n,i,a):e.patchInstanceNodeInfo(n,i,a)}_updateCustomAttributeBuffer(e,t,i,n,a){const s=a.filter.model.localClippingMode?r.EnumElementState.LOCALCLIPPING:r.EnumElementState.NONE,o=i.length;n.forEach((n=>{if("mcols"===n.name){let e=new Array(n.attribute.length);e.fill(0);for(let a=0;a<o;++a){let s=r.Utils.scratchMatrix4_1.copy(i[a].entityMatrix);if(t){let e=r.Utils.scratchMatrix4_2.copy(t);s=s.multiply(e)}const o=s.elements;n.attribute.forEach(((t,i)=>{const r=t.array;r[e[i]++]=o[0+4*i],r[e[i]++]=o[1+4*i],r[e[i]++]=o[2+4*i]}))}}else if("muvCols"===n.name);else if("aColor"===n.name){const t=n.attribute.array,i=e.color;let r=0;for(let e=0;e<o;++e)t[r++]=i.r,t[r++]=i.g,t[r++]=i.b,t[r++]=void 0!==i.opacity?i.opacity:1}else"vClipping"===n.name&&0!==s&&n.attribute.array.fill(s)}))}}t.cloneMeshFrom=e,r.Workers.InstancedMeshBuilder=t}(),function(){class e extends r.BimTileFilterManager{constructor(e){super(e),this.objectInfoManager=new r.BimtileObjectInfoManager}}r.Workers.TilesFilterManager=e}(),function(){const e=Object.freeze({DT_INVALID:0,DT_INT8:1,DT_UINT8:2,DT_INT16:3,DT_UINT16:4,DT_INT32:5,DT_UINT32:6,DT_INT64:7,DT_UINT64:8,DT_FLOAT32:9,DT_FLOAT64:10,DT_BOOL:11,DT_TYPES_COUNT:12}),t=Object.freeze({NT_UNKNOW_NODE:0,NT_COMMON_NODE:1,NT_BATCHED_MAIN_NODE:2,NT_BATCHED_SUB_NODE:3}),i=Object.freeze({PM_POINTS:0,PM_LINES:1,PM_LINE_STRIP:2,PM_TRIANGLES:3,PM_TRIANGLE_STRIP:4,PM_TRIANGLE_FAN:5}),n=Object.freeze({BT_UNKNOWN:0,BT_MESH:1,BT_LINE:2,BT_POINT:3,BT_SYMBOL:4,BT_INSTANCE:5,BT_INDEX:6,BT_BUFFER:7,BT_MATERIAL:8,BT_USERDATA:9,BT_USERID:10,BT_TILEID:11,BT_VIEWTREE:12,BT_NODEID:13,BT_NODEBOX:14,BT_USERIDBOX:15}),a=Object.freeze({TT_UNKNOW:0,TT_DIFFUSE:1,TT_BUMP:2,TT_SPECULAR:3,TT_ALPHA:4,TT_EMISSIVE:5,TT_RELIEF:6,TT_ENVIRONMENT:7,TT_LIGHT:8,TT_PACKINGMAT:9}),s=Object.freeze({MT_UNKNOW:0,MT_PHONG:1,MT_PBR:2,MT_LINE:3,MT_PM_PHONG:10,MT_PM_PBR:11});r.Workers.DataType=e,r.Workers.NodeType=t,r.Workers.PrimitiveMode=i,r.Workers.TileBlockType=n,r.Workers.TextureType=a,r.Workers.MaterialType=s}(),function(){r.Loader=r.Loader||{};class e extends THREE.Loader{constructor(e){super(e),this._decoderPath="",this._decoderConfig={},this._decoderBinary=null,this._decoderPending=null,this._workerLimit=4,this._workerPool=[],this._workerNextTaskID=1,this._workerSourceURL="",this._defaultAttributeIDs={position:"GAT_POSITION",normal:"GAT_NORMAL",color:"GAT_COLOR",uv:"GAT_TEX_COORD",uv2:"GAT_TEX_COORD2"},this._defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array",uv2:"Float32Array"}}dispose(){for(let e=0,t=this._workerPool.length;e<t;++e)this._workerPool[e].terminate();return this._workerPool.length=0,this}setDecoderPath(e){return this._decoderPath=e,this}setDecoderConfig(e){return this._decoderConfig=e,this}setWorkerLimit(e){return this._workerLimit=e,this}load(e,t,i,r){const n=new THREE.FileLoader(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),this.crossOrigin&&n.setWithCredentials(!0),n.load(e,(e=>{const i={attributeIDs:this._defaultAttributeIDs,attributeTypes:this._defaultAttributeTypes,useUniqueIDs:!1};this.decodeDataBuffer(e,i).then(t).catch(r)}),i,r)}decodeByUrl(e,t,i,n){const a={url:e,xhr:!0,version:(t=t||{}).version,packToBuffer:!!t.packToBuffer},s=r.Utils.str2ab(e);this.decodeDataBuffer(s,a).then(i).catch(n)}decodeByBuffer(e,t,i,r){const n={url:t.url,version:t.version};this.decodeDataBuffer(e,n).then(i).catch(r)}decodeDataBuffer(t,i){const r=JSON.stringify(i);if(e.taskCache.has(t)){const i=e.taskCache.get(t);if(i.key===r)return i.promise;if(0===t.byteLength)throw new Error("CLOUD.Loader.TilesWorkerDecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const a=this._workerNextTaskID++,s=t.byteLength,o=this._getWorker(a,s).then((e=>(n=e,new Promise(((e,r)=>{n._callbacks[a]={resolve:e,reject:r},n.postMessage({type:"decode",id:a,taskConfig:i,buffer:t},[t])}))))).then((e=>e.data),(e=>{console.log(e)}));return o.finally((()=>{n&&a&&this._releaseTask(n,a)})),e.taskCache.set(t,{key:r,promise:o}),o}_loadLibrary(e,t){const i=new THREE.FileLoader(this.manager);return i.setPath(this._decoderPath),i.setResponseType(t),new Promise(((t,r)=>{i.load(e,t,void 0,r)}))}_initDecoder(){if(this._decoderPending)return this._decoderPending;const t=[];return t.push(this._loadLibrary("bimtiles_decoder.js","text")),t.push(this._loadLibrary("bimtiles_decoder.wasm","arraybuffer")),this._decoderPending=Promise.all(t).then((t=>{const i=t[0];this._decoderConfig.wasmBinary=t[1];const r=e.DecoderWorker.toString(),n=[i,"",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this._workerSourceURL=URL.createObjectURL(new Blob([n]))})),this._decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this._workerPool.length<this._workerLimit){const e=new Worker(this._workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this._decoderConfig}),e.onmessage=function(t){const i=t.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('CLOUD.Loader.TilesWorkerDecoder: Unexpected message, "'+i.type+'"')}},this._workerPool.push(e)}else this._workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const i=this._workerPool[this._workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}}e.taskCache=new WeakMap,e.DecoderWorker=function(){let e,t;function i(e,t,i,r,x){try{const _=t.packToBuffer,b=function(e,t,i,r,x){const _=t.DecodeFromArray(new Int8Array(i),i.byteLength,x);if(!_.ok())throw new Error("CLOUD.Loader.TilesWorkerDecoder: Decoding failed: "+_.error_msg());const b=t.GetBlockTypeCount();if(b<1)throw new Error("CLOUD.Loader.TilesWorkerDecoder: no blockData data.");let I={data:{},buffers:[]},T=!1;for(let i=0;i<b;i++){const r=t.GetBlockType(i),_=t.GetBlockCount(r,x);if(_<1)throw new Error("CLOUD.Loader.TilesWorkerDecoder: no blockData data.");let b=null;switch(r){case e.BT_LINE:case e.BT_MESH:b=x===e.DV_V3?M.decode(e,t,_):n.decode(e,t,_);break;case e.BT_POINT:b=a.decode(e,t,_);break;case e.BT_INSTANCE:b=x===e.DV_V3?E.decode(e,t,_):s.decode(e,t,_);break;case e.BT_INDEX:b=x===e.DV_V1?o.decode(e,t,_):f.decode(e,t,_);break;case e.BT_MATERIAL:b=l.decode(e,t,_);break;case e.BT_USERID:x===e.DV_V1?b=d.decode(e,t,_):x===e.DV_V2?b=g.decode(e,t,_):x===e.DV_V3&&(b=v.decode(e,t,_));break;case e.BT_USERDATA:b=h.decode(e,t,_);break;case e.BT_TILEID:b=c.decode(e,t,_);break;case e.BT_VIEWTREE:b=u.decode(e,t,_);break;case e.BT_NODEID:b=p.decode(e,t,_);break;case e.BT_NODEBOX:b=m.decode(e,t,_);break;case e.BT_USERIDBOX:b=y.decode(e,t,_);break;default:console.log("CLOUD.Loader.TilesWorkerDecoder: Unexpected blockData type.")}b&&(T=!0,I.data[r]=b.decodedData,I.buffers.push(...b.buffers))}return T?I:void 0}(i,r,e,0,void 0===t.version?0:t.version),I=Date.now();if(b){let t=b.buffers;t.push(e),self.postMessage({type:"decode",id:x,data:{byteLength:e.byteLength,parsedData:b.data,packToBuffer:_,tickTime:I}},t),b.buffers=void 0,b.data=void 0,r.ReleaseAllBuffers()}else self.postMessage({type:"error",id:x,error:"Decoder: no data."}),r.ReleaseAllBuffers()}catch(t){console.error(t),self.postMessage({type:"error",id:x,error:t.message},[e])}finally{i.destroy(r)}}onmessage=function(n){const a=n.data;switch(a.type){case"init":e=a.decoderConfig,t=new Promise(((t,i)=>{e.onModuleLoaded=function(e){t({protobuf:e})},ProtobufDecoderModule(e)}));break;case"decode":const n=a.buffer,s=a.taskConfig,o=a.id;t.then((e=>{const t=e.protobuf,a=new t.Decoder;if(s.xhr){!function(e,t,n,a,s){r.xhr(e,t,(e=>{i(e,t,n,a,s)}),void 0,(e=>{self.postMessage({type:"error",id:s,error:e})}))}(s.url,s,t,a,o)}else i(n,s,t,a,o)}))}};const r={Matrix3IdentityElements:[1,0,0,0,1,0,0,0,1],Matrix4:{identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},fromArray(e,t,i=0){for(let r=0;r<16;r++)e[r]=t[r+i];return e},multiplyMatrices:function(e,t){const i=new Array[16],r=e[0],n=e[4],a=e[8],s=e[12],o=e[1],l=e[5],d=e[9],h=e[13],c=e[2],u=e[6],p=e[10],m=e[14],f=e[3],g=e[7],v=e[11],y=e[15],M=t[0],E=t[4],x=t[8],_=t[12],b=t[1],I=t[5],T=t[9],S=t[13],C=t[2],w=t[6],R=t[10],B=t[14],A=t[3],P=t[7],L=t[11],O=t[15];return i[0]=r*M+n*b+a*C+s*A,i[4]=r*E+n*I+a*w+s*P,i[8]=r*x+n*T+a*R+s*L,i[12]=r*_+n*S+a*B+s*O,i[1]=o*M+l*b+d*C+h*A,i[5]=o*E+l*I+d*w+h*P,i[9]=o*x+l*T+d*R+h*L,i[13]=o*_+l*S+d*B+h*O,i[2]=c*M+u*b+p*C+m*A,i[6]=c*E+u*I+p*w+m*P,i[10]=c*x+u*T+p*R+m*L,i[14]=c*_+u*S+p*B+m*O,i[3]=f*M+g*b+v*C+y*A,i[7]=f*E+g*I+v*w+y*P,i[11]=f*x+g*T+v*R+y*L,i[15]=f*_+g*S+v*B+y*O,i},setPosition:function(e,t,i,r){return e[12]=t,e[13]=i,e[14]=r,e}},str2ab:function(e){return(new TextEncoder).encode(e).buffer},ab2str:function(e){return(new TextDecoder).decode(new Uint8Array(e))},stringToUint8Array:function(e){let t=[];for(let i=0,r=e.length;i<r;++i)t.push(e.charCodeAt(i));return Uint8Array.from(t)},stringArrayToUint8Array:function(e){let t=[];return e.forEach((e=>{let i=e.length;t.push(i);for(let r=0;r<i;++r)t.push(e.charCodeAt(r))})),Uint8Array.from(t)},isDefined:function(e){return null!=e},uint32ToVec4:function(e){return[parseInt(e/16777216),parseInt(e/65536)%256,parseInt(e/256)%256,e%256]},xhr:function(e,t,i,r,n){void 0===t.responseType&&(t.responseType="arraybuffer");const{responseType:a,requestHeader:s,withCredentials:o,mimeType:l}=t;let d=new XMLHttpRequest;d.open("GET",e,!0),d.addEventListener("load",(function(e){const t=this.response;200===this.status||0===this.status?(0===this.status&&console.warn("XHR: HTTP Status 0 received."),i&&i(t)):n&&n(e)}),!1),d.addEventListener("progress",(function(e){r&&r(e)}),!1),d.addEventListener("error",(function(e){n&&n(e)}),!1),d.addEventListener("abort",(function(e){n&&n(e)}),!1),void 0!==a&&(d.responseType=a),void 0!==o&&(d.withCredentials=o),d.overrideMimeType&&d.overrideMimeType(void 0!==l?l:"text/plain");for(const e in s)d.setRequestHeader(e,s[e]);return d.send(null),d}},n={getAttributeName:function(e,t,i){switch(t){case e.GAT_POSITION:return"position";case e.GAT_INDEX:return"index";case e.GAT_NORMAL:return i?"cNormal":"normal";case e.GAT_COLOR:return"color";case e.GAT_TEX_COORD:return"uv";case e.GAT_TEX_COORD2:return"uv2";default:return"invalid"}},decode:function(e,t,i){let r=[];for(let a=0;a<i;a++){const i=t.GetMesh(a);let s={header:n.getMeshHeader(e,i,a),geometries:[]};const o=i.num_mesh_entities();for(let r=0;r<o;++r){const a=i.GetMeshEntity(r),o=n.decodeGeometry(e,t,i,a);o&&s.geometries.push(o)}n.parse(s,r)}return{decodedData:r,buffers:n.getTransferableBuffers(r)}},parse:function(e,t){const i=e.header;e.geometries.forEach((e=>{t.push({nodeInfo:n.getNodeInfo(i,e),geometry:{index:e.index,attributes:e.attributes}}),e.index=void 0,e.attributes=void 0}))},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{const i=e.geometry;i.attributes.forEach((e=>{t.push(e.array.buffer)})),i.index&&t.push(i.index.array.buffer);const r=e.nodeInfo;r.indexInfos&&t.push(r.indexInfos.buffer)})),t},getNodeInfo:function(e,t){const i=t.summary,a=e.tileId,s=e.blockId,o=`${e.tileId}_${e.blockId}_${i.nodeId}`,l=-1===e.materialBlockId?"-1_0":`${e.tileId}_${e.materialBlockId}`;let d,h,c,u;if(r.isDefined(i.matrix)&&16===i.matrix.itemSize){d=r.Matrix4.identity(),r.Matrix4.fromArray(d,i.matrix.array);const e=i.translation;r.isDefined(e)&&3===e.itemSize&&r.Matrix4.setPosition(d,e.array[0],e.array[1],e.array[2])}if(r.isDefined(i.bbox)){const e=Object.values(i.bbox.array);e.length>=10&&(h=[(e[6]+e[7])/2,(e[8]+e[9])/2],c=[(e[7]-e[6])/2,(e[9]-e[8])/2]),u=e.slice(0,6)}let p={tileId:a,blockId:s,nodeId:o,materialBlockId:l,materialId:i.materialId,primitiveMode:i.primitiveMode,bbox:u,matrix:d,indexStart:0,indexCount:i.index_count,uvCenter:h,uvHalfExtent:c,vertexColors:!1,useCompressedNormal:!1,useCompressedColor:!1,useCompressedUv:!1,hasLightMap:!1};t.attributes.forEach((e=>{"cNormal"===e.name&&(p.useCompressedNormal=!0),"color"===e.name&&(p.vertexColors=!0,p.useCompressedColor=i.color_compressed),"uv"===e.name&&(p.useCompressedUv=i.uv_compressed),"uv2"===e.name&&(p.hasLightMap=!0)}));let m=[];const f=t.groups;if(f.length)f.forEach(((e,t)=>{const r=n.getSubnodeIndexInfo(i,e,t);m.push(r)}));else{const e=n.getNodeIndexInfo(i);m.push(e)}const g=n.getSubNodeIndexInfos(m);return p.indexInfos=g.indexInfos,p.numComponentsOfIndexInfo=g.numComponents,p},getSubnodeIndexInfo:function(e,t,i){const r=!!e.uv_count,n=!!e.color_count,a=e.normal_count&&e.compressed;return{userId:t.userId,nodeId:t.nodeId,nodeIndex:i,positionStart:void 0!==t.vertex_start?(t.vertex_start-e.vertex_start)/4:void 0,positionCount:void 0!==t.vertex_count?3*t.vertex_count:0,indexStart:void 0!==t.index_start?(t.index_start-e.index_start)/e.index_stride:void 0,indexCount:void 0!==t.index_count?t.index_count:0,uvStart:r?(t.uv_start-e.uv_start)/4:0,uvCount:r?2*t.uv_count:0,colorStart:n?(t.color_start-e.color_start)/e.color_stride:0,colorCount:n?t.color_count:0,cNormalStart:a?(t.normal_start-e.normal_start)/2:0,cNormalCount:a?t.normal_count:0}},getNodeIndexInfo:function(e){return{userId:e.userId,nodeId:e.nodeId,nodeIndex:0,positionStart:0,positionCount:3*e.vertex_count,indexStart:0,indexCount:e.index_count,uvStart:0,uvCount:e.uv_count?2*e.uv_count:0,colorStart:0,colorCount:e.color_count||0,cNormalStart:0,cNormalCount:e.normal_count&&e.compressed?e.normal_count:0}},getSubNodeIndexInfos(e){const t=e.length,i=new Int32Array(13*t);let r=0;return e.forEach((e=>{i[r++]=e.userId,i[r++]=e.nodeId,i[r++]=e.nodeIndex,i[r++]=e.positionStart,i[r++]=e.positionCount,i[r++]=e.indexStart,i[r++]=e.indexCount,i[r++]=e.uvStart,i[r++]=e.uvCount,i[r++]=e.colorStart,i[r++]=e.colorCount,i[r++]=e.cNormalStart,i[r++]=e.cNormalCount})),{indexInfos:i,numComponents:13}},getMeshHeader:function(e,t,i){return{id:i,tileId:t.get_tile_id(),blockId:t.get_block_id(),bufferBlockId:t.get_buffer_block_id(),materialBlockId:t.get_material_block_id(),userdataBlockId:t.get_userdata_block_id(),matrix:n.getMatrix(e,t),bbox:n.getBbox(e,t),translation:n.getTranslation(e,t)}},getMatrix:function(e,t){const i=t.num_components_matrix();if(0===i)return;const r=i,n=t.byte_length_per_component_matrix(),a=r*n;4!==n&&console.log("entity.byte_length_per_component_matrix:",n);let s=e._malloc(a);t.GetMatrixFloat32Array(a,s);const o=new Float32Array(e.HEAPF32.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},getBbox:function(e,t){const i=t.num_components_bbox();if(0===i)return;const r=i,n=t.byte_length_per_component_bbox(),a=r*n;4!==n&&console.log("entity.byte_length_per_component_bbox:",n);let s=e._malloc(a);t.GetBBoxFloat32Array(a,s);const o=new Float32Array(e.HEAPF32.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},getTranslation:function(e,t){const i=t.num_components_translation();if(0===i)return;const r=i,n=t.byte_length_per_component_translation(),a=r*n;8!==n&&console.log("entity.byte_length_per_component_translation:",n);let s=e._malloc(a);t.GetTranslationFloat64Array(a,s);const o=new Float64Array(e.HEAPF64.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},decodeGeometry:function(e,t,i,r){const a=r.num_attributes();if(0===a)return null;const s={userId:r.get_user_id(),userdataId:r.get_userdata_id(),materialId:r.get_material_id(),sceneId:r.get_scene_id(),sceneName:r.get_scene_name(),nodeId:r.get_node_id(),nodeType:r.node_type(),primitiveId:r.get_primitive_id(),primitiveMode:r.primitive_mode(),matrix:n.getMatrix(e,r),bbox:n.getBbox(e,r),translation:n.getTranslation(e,r)},o={index:null,attributes:[]};for(let l=0;l<a;++l){const a=r.GetAttribute(l),d=n.getAttributeParms(e,a),h=n.decodeAttribute(e,t,i,d,a);d.attributeType===e.GAT_INDEX?o.index=h:o.attributes.push(h),n.setGeometrySummary(e,d,s)}return o.summary=s,o.groups=n.getGeometryGroups(e,r),o},getAttributeParms(e,t){const i=t.attribute_type(),r=t.compressed();return{attributeType:i,attributeName:n.getAttributeName(e,i,r),dataType:t.data_type(),numComponents:t.num_components(),numPoints:t.num_points(),byteOffset:t.byte_offset(),byteStride:t.byte_stride(),byteLength:t.byte_length(),normalized:t.normalized(),compressed:r}},setGeometrySummary:function(e,t,i){let r;switch(t.attributeType){case e.GAT_POSITION:r="vertex_";break;case e.GAT_INDEX:r="index_";break;case e.GAT_NORMAL:r="normal_";break;case e.GAT_COLOR:r="color_";break;case e.GAT_TEX_COORD:r="uv_";break;case e.GAT_TEX_COORD2:r="uv2_"}r&&(i[`${r}start`]=t.byteOffset,i[`${r}count`]=t.numPoints,i[`${r}value_type`]=t.dataType,i[`${r}length`]=t.byteLength,i[`${r}stride`]=t.byteStride,i[`${r}components`]=t.numComponents,i[`${r}normalized`]=t.normalized,i[`${r}compressed`]=t.compressed)},getGeometryGroups:function(e,t){const i=t.num_sub_entities(),r=[];for(let a=0;a<i;++a){const i=t.GetSubMeshEntity(a),s={userId:i.get_user_id(),userdataId:i.get_userdata_id(),materialId:i.get_material_id(),nodeId:i.get_node_id()},o=i.num_attributes();for(let t=0;t<o;++t){const r=i.GetAttribute(t),a=n.getAttributeParms(e,r);n.setGeometrySummary(e,a,s)}r.push(s)}return r},decodeAttribute:function(e,t,i,r,n){const{attributeName:a,numComponents:s,numPoints:o,dataType:l,normalized:d,compressed:h}=r,c=o*s;let u,p,m;switch(l){case e.DT_FLOAT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray(i,n,m,u),p=new Float32Array(e.HEAPF32.buffer,u,c).slice(),e._free(u);break;case e.DT_INT8:u=e._malloc(c),t.GetAttributeDataArray(i,n,c,u),p=new Int8Array(e.HEAP8.buffer,u,c).slice(),e._free(u);break;case e.DT_INT16:m=2*c,u=e._malloc(m),t.GetAttributeDataArray(i,n,m,u),p=new Int16Array(e.HEAP16.buffer,u,c).slice(),e._free(u);break;case e.DT_INT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray(i,n,m,u),p=new Int32Array(e.HEAP32.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT8:u=e._malloc(c),t.GetAttributeDataArray(i,n,c,u),p=new Uint8Array(e.HEAPU8.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT16:m=2*c,u=e._malloc(m),t.GetAttributeDataArray(i,n,m,u),p=new Uint16Array(e.HEAPU16.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray(i,n,m,u),p=new Uint32Array(e.HEAPU32.buffer,u,c).slice(),e._free(u);break;default:throw new Error("CLOUD.Loader.TilesWorkerDecoder: Unexpected attribute type.")}return{name:a,array:p,itemSize:s,normalized:d,compressed:h}}},a={decode:function(e,t,i){return console.log("BT_POINT"),null}},s={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetInstance(n);let a={blobId:i.get_blob_id(),type:e.BT_INSTANCE,header:s.getHeader(e,i,n),entities:[]};const o=i.num_instance_entities();for(let t=0;t<o;++t){const r=i.GetInstanceEntity(t);a.entities.push({userId:r.get_user_id(),userdataId:r.get_userdata_id(),color:r.get_color(),matrix:s.getMatrix(e,i,r),bbox:s.getBbox(e,i,r),translation:s.getTranslation(e,i,r),packingUvs:s.getPackingUvs(e,i,r)})}s.parse(a,r)}return{decodedData:r,buffers:s.getTransferableBuffers(r)}},parse:function(e,t){const i=e.header,r=e.entities;t.push({blobId:e.blobId,nodeInfo:s.getNodeInfo(i,r),geometry:{attributes:s.getCustomAttributes(r.length)}})},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{e.geometry.attributes.forEach((e=>{Array.isArray(e.attribute)?e.attribute.forEach((e=>{t.push(e.array.buffer)})):t.push(e.attribute.array.buffer)}));e.nodeInfo.entityInfoArray.forEach((e=>{t.push(e.buffer)}))})),t},getNodeInfo:function(e,t){const{tileId:i,blockId:n,entityId:a,matrix:s,translation:o}=e,l=r.Matrix4.identity();r.isDefined(s)&&16===s.itemSize&&(r.Matrix4.fromArray(l,s.array),r.isDefined(o)&&3===o.itemSize&&r.Matrix4.setPosition(l,o.array[0],o.array[1],o.array[2]));const d=t.length;0===d&&console.log("no subnode!!!");let h=new Int32Array(d),c=0,u=new Int32Array(d),p=0,m=new Int32Array(d),f=0,g=new Float32Array(16*d),v=0,y=new Float32Array(2*d),M=0;t.forEach((t=>{h[c++]=t.userId,u[p++]=t.userdataId,m[f++]=t.color;const i=r.Matrix4.identity();if(r.isDefined(t.matrix)&&16===t.matrix.itemSize){r.Matrix4.fromArray(i,t.matrix.array);const e=t.translation;r.isDefined(e)&&3===e.itemSize&&r.Matrix4.setPosition(i,e.array[0],e.array[1],e.array[2])}let n;i.forEach((e=>{g[v++]=e})),n=r.isDefined(e.packingUvs)&&2===e.packingUvs.array.length?e.packingUvs.array:r.isDefined(t.packingUvs)&&2===t.packingUvs.array.length?t.packingUvs.array:new Float32Array(2).fill(-1),t.packingUvs=n,n.forEach((e=>{y[M++]=e}))}));return{tileId:i,blockId:n,entityId:a,entityInfoArray:[h,u,m,g,y],rootMatrix:l}},createMatrixAttribute:function(e){const t=[],i=3*e;for(let e=0;e<4;++e){const r=new Float32Array(i);r.fill(0),t.push({name:`mcol${e}`,array:r,itemSize:3,normalized:!1,meshPerAttribute:1})}return t},createUVMatrixAttribute:function(e){const t=[],i=3*e,n=r.Matrix3IdentityElements;for(let r=0;r<3;++r){const a=new Float32Array(i);let s=0;for(let t=0;t<e;++t)a[s++]=n[0+3*r],a[s++]=n[1+3*r],a[s++]=n[2+3*r];t.push({name:`muvCol${r}`,array:a,itemSize:3,normalized:!1,meshPerAttribute:1})}return t},createColorAttribute:function(e){const t=new Float32Array(4*e);return t.fill(0),{array:t,itemSize:4,normalized:!1,meshPerAttribute:1}},createClippingAttribute:function(e){const t=new Float32Array(e);return t.fill(0),{array:t,itemSize:1,normalized:!1,meshPerAttribute:1}},createStateAttribute:function(e){const t=new Float32Array(4*e);return t.fill(0),{array:t,itemSize:4,normalized:!1,meshPerAttribute:1}},getCustomAttributes:function(e){const t=[];return t.push({name:"mcols",attribute:s.createMatrixAttribute(e)}),t.push({name:"muvCols",attribute:s.createUVMatrixAttribute(e)}),t.push({name:"aColor",attribute:s.createColorAttribute(e)}),t.push({name:"vState",attribute:s.createStateAttribute(e)}),t.push({name:"vClipping",attribute:s.createClippingAttribute(e)}),t},getHeader:function(e,t,i){return{id:i,tileId:t.get_tile_id(),blockId:t.get_block_id(),entityId:t.get_entity_url(),matrix:s.getHeaderMatrix(e,t),bbox:s.getHeaderBbox(e,t),translation:s.getHeaderTranslation(e,t),packingUvs:s.getHeaderPackingUvs(e,t)}},getMatrix:function(e,t,i){const r=i.num_components_matrix();if(0===r)return;const n=r,a=4*n;let s=e._malloc(a);t.GetMatrixFloat32Array(i,a,s);const o=new Float32Array(e.HEAPF32.buffer,s,n).slice();return e._free(s),{array:o,itemSize:r}},getBbox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const n=r,a=4*n;let s=e._malloc(a);t.GetBBoxFloat32Array(i,a,s);const o=new Float32Array(e.HEAPF32.buffer,s,n).slice();return e._free(s),{array:o,itemSize:r}},getTranslation:function(e,t,i){const r=i.num_components_translation();if(0===r)return;const n=r,a=8*n;let s=e._malloc(a);t.GetTranslationFloat64Array(i,a,s);const o=new Float64Array(e.HEAPF64.buffer,s,n).slice();return e._free(s),{array:o,itemSize:r}},getPackingUvs:function(e,t,i){const r=i.num_components_packing_uvs();if(0===r)return;const n=r,a=4*n;let s=e._malloc(a);t.GetFloat32ArrayOfPackingUvs(i,a,s);const o=new Float32Array(e.HEAPF32.buffer,s,n).slice();return e._free(s),{array:o,itemSize:r}},getHeaderMatrix:function(e,t){const i=t.num_components_matrix();if(0===i)return;const r=i,n=4*r;let a=e._malloc(n);t.GetHeaderMatrixFloat32Array(n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),{array:s,itemSize:i}},getHeaderBbox:function(e,t){const i=t.num_components_bbox();if(0===i)return;const r=i,n=4*r;let a=e._malloc(n);t.GetHeaderBBoxFloat32Array(n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),{array:s,itemSize:i}},getHeaderTranslation:function(e,t){const i=t.num_components_translation();if(0===i)return;const r=i,n=8*r;let a=e._malloc(n);t.GetHeaderTranslationFloat64Array(n,a);const s=new Float64Array(e.HEAPF64.buffer,a,r).slice();return e._free(a),{array:s,itemSize:i}},getHeaderPackingUvs:function(e,t){const i=t.num_components_packing_uvs();if(0===i)return;const r=i,n=4*r;let a=e._malloc(n);t.GetFloat32ArrayOfHeaderPackingUvs(n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),{array:s,itemSize:i}}},o={decode:function(e,t,i){let r={nodeIdItems:[],nodeIdBoxes:[],treeNodeItems:[]};for(let n=0;n<i;n++){const i=t.GetSearchTree(n),a=i.GetNodeIdCount();let s={nodeIdItems:[],nodeIdBoxes:[],treeNodeItems:[]},l=s.nodeIdItems,d=s.nodeIdBoxes,h=s.treeNodeItems;for(let t=0;t<a;t++){const r=i.GetNodeIdItem(t);l.push([r.get_tile_id(),r.get_block_id(),r.get_node_id(),r.get_user_id(),r.get_userdata_id()]);const n=o.getNodeIdBoundingBox(e,i,r);d.push(n)}const c=i.GetTreeNodeCount();for(j=0;j<c;j++){const t=i.GetTreeNodeItem(j);h.push({treeNodeId:t.get_node_id(),nodeIds:o.getNodeIdsFromOctree(e,i,t),children:o.getChildrenNodeIdsFromOctree(e,i,t),boundingBox:o.getTreeNodeBoundingBox(e,i,t)})}o.parse(s,r)}return{decodedData:r,buffers:o.getTransferableBuffers(r)}},parse:function(e,t){const i=e.nodeIdItems;let r=[];for(let e=0,t=i.length;e<t;++e)r.push(...i[e]);t.nodeIdItems.push(Int32Array.from(r));const n=e.nodeIdBoxes;let a=[];for(let e=0,t=n.length;e<t;++e)a.push(...n[e]);t.nodeIdBoxes.push(Float32Array.from(a)),t.treeNodeItems.push(...e.treeNodeItems)},getTransferableBuffers:function(e){let t=[];return e.nodeIdItems.forEach((e=>{t.push(e.buffer)})),e.nodeIdBoxes.forEach((e=>{t.push(e.buffer)})),e.treeNodeItems.forEach((e=>{e.nodeIds&&e.nodeIds.length&&t.push(e.nodeIds.buffer),e.children&&e.children.length&&t.push(e.children.buffer),e.boundingBox&&e.boundingBox.length&&t.push(e.boundingBox.buffer)})),t},getNodeIdBoundingBox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const n=r*i.byte_lenth_per_component_bbox();let a=e._malloc(n);t.GetNodeIdBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s},getTreeNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const n=r*i.byte_lenth_per_component_bbox();let a=e._malloc(n);t.GetTreeNodeBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s},getNodeIdsFromOctree:function(e,t,i){const r=i.num_nodes();if(0===r)return;const n=r*i.byte_lenth_per_component_node();let a=e._malloc(n);t.GetTreeNodeInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s},getChildrenNodeIdsFromOctree:function(e,t,i){const r=i.num_children();if(0===r)return;const n=r*i.byte_lenth_per_component_childnode();let a=e._malloc(n);t.GetTreeChildNodeInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s}},l={decode:function(e,t,i){let r={};for(let n=0;n<i;n++){const i=t.GetMaterial(n);let a,s={id:n,type:e.BT_MATERIAL,header:{tileId:i.get_tile_id(),blockId:i.get_block_id(),materialCount:i.get_material_count(),textureCount:i.get_texture_count(),imageCount:i.get_image_count()},materials:[],textures:[],images:[]};const o=i.GetMaterialItemCount();for(a=0;a<o;++a){const t=i.GetMaterialItem(a),r=l.getTextureIds(e,i,t),n=l.getMaterialCustomData(e,i,t),o={name:t.get_name(),type:t.get_type(),color:t.get_color(),doubleSide:t.get_double_side(),receiveIbl:t.get_receive_ibl(),tintColor:t.get_tint_color(),opacity:t.get_opacity(),metalness:t.get_metalness(),roughness:t.get_roughness()};r&&(o.textureIds=r),n&&(o.customData=n),s.materials.push(o)}const d=i.GetTextureItemCount();for(a=0;a<d;++a){const t=i.GetTextureItem(a);s.textures.push({name:t.get_name(),type:t.get_type(),image:t.get_image(),repeatU:t.get_repeat_u(),repeatV:t.get_repeat_v(),angle:t.get_angle(),alpha:t.get_alpha(),depth:t.get_depth(),offsetU:t.get_offset_u(),offsetV:t.get_offset_v(),scaleU:t.get_scale_u(),scaleV:t.get_scale_v(),lodImageIds:l.getLodImageIds(e,i,t)})}const h=i.GetImageItemCount();for(a=0;a<h;++a){const t=i.GetImageItem(a);s.images.push({url:t.get_url(),type:t.get_type(),width:t.get_width(),height:t.get_height(),dimension:t.get_dimension(),bufferId:t.get_buffer_id(),byteOffset:t.get_byte_offset(),byteLength:t.get_byte_length(),imageBuffer:l.getImageBuffer(e,t)})}l.parse(s,r)}return{decodedData:r,buffers:l.getTransferableBuffers(r)}},parse:function(e,t){const{tileId:i,blockId:r}=e.header,n=`${i}_${r}`;void 0===t[n]?t[n]=e:console.log("The material has been parsed!")},getTransferableBuffers:function(e){let t=[];return Object.keys(e).forEach((i=>{e[i].images.forEach((e=>{e.imageBuffer&&t.push(e.imageBuffer)}))})),t},getImageBuffer:function(e,t){if(!t.HasImageBuffer())return;const i=t.get_byte_length();if(0===i)return;let r=e._malloc(i);t.GetImageBuffer(i,r);const n=new Int8Array(e.HEAP8.buffer,r,i).slice().buffer;return e._free(r),n},getTextureIds:function(e,t,i){const r=i.num_entries_textures();if(0===r)return;const n=r*i.byte_length_per_entry_textures();let a=e._malloc(n);t.GetTextureIdsInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s},getLodImageIds:function(e,t,i){const r=i.num_entries_lod_images();if(0===r)return;const n=r*i.byte_length_per_entry_lod_images();let a=e._malloc(n);t.GetLodImageIdsInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s},GetKeyValueInt32ArrayForCustomData:function(e,t,i){const r=i.num_entries_int32();if(0===r)return;const n=r*i.byte_length_per_entry_int32();let a=e._malloc(n);t.GetValueInt32ArrayForCustomData(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();e._free(a);const o=[];for(let e=0;e<r;++e)o.push(t.GetKeyForCustomDataWithInt32Values(i,e));return{keys:o,values:s}},GetKeyValueFloatArrayForCustomData:function(e,t,i){const r=i.num_entries_float();if(0===r)return;const n=r*i.byte_length_per_entry_float();let a=e._malloc(n);t.GetValueFloatArrayForCustomData(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();e._free(a);const o=[];for(let e=0;e<r;++e)o.push(t.GetKeyForCustomDataWithFloatValues(i,e));return{keys:o,values:s}},GetKeyValueStringArrayForCustomData:function(e,t,i){const r=i.num_entries_string();if(0===r)return;const n=[],a=[];for(let e=0;e<r;++e)n.push(t.GetKeyForCustomDataWithStringValues(i,e)),a.push(t.GetValueForCustomDataWithStringValues(i,e));return{keys:n,values:a}},getMaterialCustomData:function(e,t,i){const r=i.num_entries_custom_data_items();if(0===r)return;const n=[];for(let a=0;a<r;++a){const r=i.GetCustomDataItem(a);n.push([{I32:l.GetKeyValueInt32ArrayForCustomData(e,t,r)},{F32:l.GetKeyValueFloatArrayForCustomData(e,t,r)},{STR:l.GetKeyValueStringArrayForCustomData(e,t,r)}])}return n}},d={decode:function(e,t,i){let r={userIdInfoMap:{},userIdMap:{},userIdIndexMap:{}};for(let n=0;n<i;n++){const i=t.GetUserId(n),a=i.num_user_id_infos(),s=i.get_user_id_min();let o={userIdInfoMap:{},userIdMap:{},userIdIndexMap:{}},l=o.userIdInfoMap;for(let t=0;t<a;++t){const r=i.GetUserIdInfo(t),n=r.get_tile_id(),a=r.get_block_id(),s=r.get_node_id(),o=r.get_user_id(),h=d.getUserInfoBox(e,i,r);l[`${n}_${a}_${s}`]={userId:o,tileId:n,blockId:a,nodeId:s,userdataId:r.get_userdata_id(),boundingBox:h}}let h=o.userIdMap,c=o.userIdIndexMap;const u=i.num_user_ids();for(let e=0;e<u;++e){const t=i.GetUserIdStr(e),r=s+e;h[r]=t,c[t]=r}d.parse(o,r)}const n=d.getTransferableBuffers(r);return{decodedData:JSON.stringify(r),buffers:n}},parse:function(e,t){const i=e.userIdInfoMap,r=e.userIdMap,n=e.userIdIndexMap;for(const e in r)t.userIdMap[e]=r[e];for(const e in n)t.userIdIndexMap[e]=n[e];for(const e in i)t.userIdInfoMap[e]=i[e]},getTransferableBuffers:function(e){return[]},getUserInfoBox:function(e,t,i){const r=i.num_bbox_components(),n=r*i.bytesize_bbox_per_component();let a=e._malloc(n);t.GetBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s}},h={decode:function(e,t,i){let r={userDataKeyMap:{},userDataKeys:{},userDataValueMap:{},userDataValues:{},userDataItems:{}};for(let n=0;n<i;n++){const i=t.GetUserData(n);let a={header:{tileId:i.GetTileId(),blockId:i.GetBlockId(),userdataCount:i.GetUserdataCount()},userDataKeyMap:{},userDataKeys:[],userDataValueMap:{},userDataValues:[],userDataItems:[]};const s=a.userDataKeyMap,o=a.userDataKeys,l=i.GetKeysCount();let d;for(d=0;d<l;++d){const e=i.GetStringKey(d);s[e]=d,o.push(e)}const c=a.userDataValueMap,u=a.userDataValues,p=i.GetValuesCount();for(d=0;d<p;++d){const e=i.GetStringValue(d);c[e]=d,u.push(e)}const m=i.GetUserDataItemCount(),f=a.userDataItems;for(d=0;d<m;++d){const t=i.GetUserDataItem(d),r=h.getUserDataKeyIndices(e,i,t),n=h.getUserDataValueIndices(e,i,t),a=r.length,s={};for(let e=0;e<a;e++)s[r[e]]=n[e];f.push(s)}h.parse(a,r)}const n=h.getTransferableBuffers(r);return{decodedData:JSON.stringify(r),buffers:n}},parse:function(e,t){const i=t.userDataKeyMap,r=t.userDataKeys,n=t.userDataValueMap,a=t.userDataValues,s=t.userDataItems,o=e.header.blockId;i[o]=e.userDataKeyMap,r[o]=e.userDataKeys,n[o]=e.userDataValueMap,a[o]=e.userDataValues,s[o]=e.userDataItems},getTransferableBuffers:function(e){return[]},getUserDataKeyIndices:function(e,t,i){const r=i.num_entries_string()*i.num_components(),n=r*i.byte_length_per_component();let a=e._malloc(n);t.GetKeyIndexStringArray(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s},getUserDataValueIndices:function(e,t,i){const r=i.num_entries_string()*i.num_components(),n=r*i.byte_length_per_component();let a=e._malloc(n);t.GetValueIndexStringArray(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s}},c={decode:function(e,t,i){let r={tileIdMap:{},tileIds:{}};for(let e=0;e<i;e++){const i=t.GetTileId(e);let n={index:e,tileIds:[],tileIdMap:{}},a=n.tileIds,s=n.tileIdMap;const o=i.num_tile_ids();for(let e=0;e<o;++e){const t=i.get_tile_path(e);s[t]=e,a.push(t)}c.parse(n,r)}const n=c.getTransferableBuffers(r);return{decodedData:JSON.stringify(r),buffers:n}},parse:function(e,t){const i=t.index;t.tileIdMap[i]=e.tileIdMap,t.tileIds[i]=e.tileIds},getTransferableBuffers:function(e){return[]}},u={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetViewTree(n);let a={treeType:i.get_tree_type(),geometryErrors:u.GetGeometryErrors(e,i),viewNodes:[]},s=a.viewNodes;const o=i.GetViewNodeCount();for(let t=0;t<o;++t){const r=i.GetViewNodeItem(t);s.push({nodeId:r.get_node_id(),parentId:r.get_node_parent_id(),bbox:u.getViewNodeBoundingBox(e,i,r),tileIds:u.getViewNodeTileIds(e,i,r)})}r.push(a)}return{decodedData:r,buffers:u.getTransferableBuffers(r)}},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{t.push(e.geometryErrors.buffer);e.viewNodes.forEach((e=>{t.push(e.bbox.buffer),e.tileIds&&t.push(e.tileIds.buffer)}))})),t},GetGeometryErrors:function(e,t){const i=t.num_geometry_errors(),r=i*t.byte_lenth_per_geometry_error();let n=e._malloc(r);t.GetGeometryErrorsFloat32Array(r,n);const a=new Float32Array(e.HEAPF32.buffer,n,i).slice();return e._free(n),a},getViewNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox(),n=r*i.byte_lenth_per_component_bbox();let a=e._malloc(n);t.GetViewNodeBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s},getViewNodeTileIds:function(e,t,i){const r=i.num_tile_ids();if(0===r)return;const n=r*i.byte_lenth_per_tile_ids();let a=e._malloc(n);t.GetViewNodeTileIdsInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s}},p={decode:function(e,t,i){let r=[];for(let e=0;e<i;e++){const i=t.GetNodeId(e);let n={nodeIdItems:[]},a=n.nodeIdItems;const s=i.GetNodeIdItemCount();for(let e=0;e<s;++e){const t=i.GetNodeIdItem(e);a.push([t.get_tile_id(),t.get_node_id(),t.get_user_id(),t.get_bbox_id()])}p.parse(n,r)}return{decodedData:r,buffers:p.getTransferableBuffers(r)}},parse:function(e,t){const i=e.nodeIdItems;let r=[];for(let e=0,t=i.length;e<t;++e)r.push(...i[e]);t.push(Int32Array.from(r))},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{t.push(e.buffer)})),t}},m={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetNodeBox(n),a=m.getBoundingBox(e,i);r.push(a)}return{decodedData:r,buffers:m.getTransferableBuffers(r)}},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{t.push(e.buffer)})),t},getBoundingBox:function(e,t){const i=t.num_components_bboxs_total(),r=i*t.byte_lenth_per_component_bbox();let n=e._malloc(r);t.GetBBoxFloat32Array(r,n);const a=new Float32Array(e.HEAPF32.buffer,n,i).slice();return e._free(n),a}},f={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetSearchTreeV2(n),a=i.GetTreeNodeCount();for(let t=0;t<a;t++){const n=i.GetTreeNodeItem(t);r.push({treeNodeId:n.get_node_id(),nodeIds:f.getNodeIdsFromOctree(e,i,n),children:f.getChildrenNodeIdsFromOctree(e,i,n),boundingBox:f.getTreeNodeBoundingBox(e,i,n)})}}return{decodedData:r,buffers:f.getTransferableBuffers(r)}},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{e.nodeIds&&e.nodeIds.length&&t.push(e.nodeIds.buffer),e.children&&e.children.length&&t.push(e.children.buffer),e.boundingBox&&e.boundingBox.length&&t.push(e.boundingBox.buffer)})),t},getNodeIdBoundingBox:function(e,t,i){const r=i.num_components_bbox(),n=r*i.byte_lenth_per_component_bbox();let a=e._malloc(n);t.GetNodeIdBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s},getTreeNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox(),n=r*i.byte_lenth_per_component_bbox();let a=e._malloc(n);t.GetTreeNodeBBoxFloat32Array(i,n,a);const s=new Float32Array(e.HEAPF32.buffer,a,r).slice();return e._free(a),s},getNodeIdsFromOctree:function(e,t,i){const r=i.num_nodes();if(0===r)return;const n=r*i.byte_lenth_per_component_node();let a=e._malloc(n);t.GetTreeNodeInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s},getChildrenNodeIdsFromOctree:function(e,t,i){const r=i.num_children();if(0===r)return;const n=r*i.byte_lenth_per_component_childnode();let a=e._malloc(n);t.GetTreeChildNodeInt32Array(i,n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),s}},g={decode:function(e,t,i){const n=[];for(let a=0;a<i;a++){const i=t.GetUserIdV2(a),s=i.get_user_id_min(),o=g.getUserIds(i),l=g.getUserDataIds(e,i);n.push({userIds:r.stringArrayToUint8Array(o),minUserIdIndex:s,userdataIds:l})}return{decodedData:n,buffers:g.getTransferableBuffers(n)}},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{t.push(e.userIds.buffer),t.push(e.userdataIds.buffer)})),t},getUserIds:function(e){const t=[],i=e.num_user_ids();for(j=0;j<i;++j){const i=e.GetUserIdStr(j);t.push(i)}return t},getNodeListIds:function(e,t){const i=t.num_nodelist_ids();if(0===i)return;const r=4*i;let n=e._malloc(r);t.GetNodeListIdsInt32Array(r,n);const a=new Int32Array(e.HEAP32.buffer,n,i).slice();return e._free(n),a},getUserDataIds:function(e,t){const i=t.num_userdata_ids();if(0===i)return;const r=4*i;let n=e._malloc(r);t.GetUserDataIdsInt32Array(r,n);const a=new Int32Array(e.HEAP32.buffer,n,i).slice();return e._free(n),a}},v={decode:function(e,t,i){let n=[];for(let a=0;a<i;a++){const i=t.GetUserIdV3(a),s=i.get_user_id_min(),o=v.getUserIds(i),l=v.getUserDataIds(e,i);n.push({userIds:r.stringArrayToUint8Array(o),minUserIdIndex:s,userdataIds:l})}return{decodedData:n,buffers:v.getTransferableBuffers(n)}},getTransferableBuffers:function(e){return g.getTransferableBuffers(e)},getUserIds:function(e){const t=[],i=e.num_user_ids();for(j=0;j<i;++j){const i=e.GetUserIdStr(j);t.push(i)}return t},getUserDataIds:function(e,t){const i=t.num_userdata_indices();if(0===i)return;const r=4*i;let n=e._malloc(r);t.GetInt32ArrayForUserDataIndices(r,n);const a=new Int32Array(e.HEAP32.buffer,n,i).slice();return e._free(n),a}},y={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetUserIdBoxV3(n),a=y.getBoundingBox(e,i);r.push(a)}return{decodedData:r,buffers:y.getTransferableBuffers(r)}},getTransferableBuffers:function(e){let t=[];return e.forEach((e=>{t.push(e.buffer)})),t},getBoundingBox:function(e,t){const i=t.num_components_bboxs_total(),r=i*t.byte_lenth_per_component_bbox();let n=e._malloc(r);t.GetBBoxFloat32Array(r,n);const a=new Float32Array(e.HEAPF32.buffer,n,i).slice();return e._free(n),a}},M={getAttributeName:function(e,t,i){switch(t){case e.GAT_POSITION:return"position";case e.GAT_INDEX:return"index";case e.GAT_NORMAL:return i?"cNormal":"normal";case e.GAT_COLOR:return"color";case e.GAT_TEX_COORD:return"uv";case e.GAT_TEX_COORD2:return"uv2";case e.GAT_TEX_COORD3:return"uv3";case e.GAT_USERID:return"id";case e.GAT_BARYCENTRIC:return"barycentric";default:return"invalid"}},decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetMeshV3(n);let a={header:M.getMeshHeader(e,i,n),geometries:[]},s={},o=0;const l=i.num_userid_index_infos();for(let e=0;e<l;++e){const t=i.GetUseridIndexInfo(e),r=M.getUserIdIndexInfo(t);0===r.indexStart&&(o=0),r.stateIndex=o,o++,s[r.nodeId]||(s[r.nodeId]=new Map),s[r.nodeId].set(r.userId,r)}const d=i.num_mesh_nodes();for(let r=0;r<d;++r){const n=i.GetNode(r),o=M.decodeGeometry(e,t,i,n,s);o&&a.geometries.push(o)}M.parse(a,r)}return{decodedData:r,buffers:M.getTransferableBuffers(r)}},parse:function(e,t){const i=e.header;e.geometries.forEach((e=>{t.push({nodeInfo:M.getNodeInfo(i,e),geometry:{index:e.index,attributes:e.attributes}}),e.index=void 0,e.attributes=void 0}))},getTransferableBuffers:function(e){return n.getTransferableBuffers(e)},getNodeInfo:function(e,t){const i=t.summary,n=e.tileId,a=i.nodeId,s=-1===e.materialBlockId?"-1_0":`${e.tileId}_${e.materialBlockId}`;let o,l,d;if(r.isDefined(i.matrix)&&16===i.matrix.itemSize){o=r.Matrix4.identity(),r.Matrix4.fromArray(o,i.matrix.array);const e=i.translation;r.isDefined(e)&&3===e.itemSize&&r.Matrix4.setPosition(o,e.array[0],e.array[1],e.array[2])}if(r.isDefined(i.bbox)){const e=Object.values(i.bbox.array);e.length>=4&&(l=[(e[0]+e[1])/2,(e[2]+e[3])/2],d=[(e[1]-e[0])/2,(e[3]-e[2])/2])}let h={tileId:n,nodeId:a,materialBlockId:s,materialId:i.materialId,primitiveMode:i.primitiveMode,matrix:o,indexStart:0,indexCount:i.index_count,uvCenter:l,uvHalfExtent:d,vertexColors:!1,useCompressedNormal:!1,useCompressedColor:!1,useCompressedUv:!1,hasLightMap:!1,isCompressedMode:e.isCompressedMode};t.attributes.forEach((e=>{"cNormal"===e.name&&(h.useCompressedNormal=!0),"color"===e.name&&(h.vertexColors=!0,h.useCompressedColor=i.color_compressed),"uv"===e.name&&(h.useCompressedUv=i.uv_compressed),"uv2"===e.name&&(h.hasLightMap=!0),"barycentric"===e.name&&(h.useBCOutline=!0)}));const c=M.getSubNodeIndexInfos(t);return c&&(h.indexInfos=c.indexInfos,h.numComponentsOfIndexInfo=c.numComponents),h},getSubNodeIndexInfos(e){const t=e.subnodeIndexInfos;if(!t)return null;const i=t.size,r=new Int32Array(11*i);let n=0;for(const e of t.values())r[n++]=e.userId,r[n++]=e.nodeId,r[n++]=e.stateIndex,r[n++]=e.positionStart,r[n++]=e.positionEnd,r[n++]=e.positionCount,r[n++]=e.indexStart,r[n++]=e.indexEnd,r[n++]=e.indexCount,r[n++]=e.cNormalStart,r[n++]=e.cNormalCount;return{indexInfos:r,numComponents:11}},getMeshHeader:function(e,t,i){return{id:i,tileId:t.get_tile_id(),blockId:t.get_block_id(),bufferBlockId:t.get_buffer_block_id(),materialBlockId:t.get_material_block_id(),userdataBlockId:t.get_userdata_block_id(),isCompressedMode:t.compressed_mode()}},getMatrix:function(e,t){return n.getMatrix(e,t)},getBbox:function(e,t){return n.getBbox(e,t)},getTranslation:function(e,t){return n.getTranslation(e,t)},getQuantizeBits:function(e,t){const i=t.num_components_quantize_bits();if(0===i)return;const r=i,n=r*t.byte_length_per_component_quantize_bits();let a=e._malloc(n);t.GetQuantizeBitsInt32Array(n,a);const s=new Int32Array(e.HEAP32.buffer,a,r).slice();return e._free(a),{array:s,itemSize:i}},decodeGeometry:function(e,t,i,r,n){const a=r.num_attributes();if(0===a)return null;const s={nodeId:r.get_node_id(),nodeType:r.node_type(),materialId:r.get_material_id(),primitiveId:r.get_primitive_id(),primitiveMode:r.primitive_mode(),matrix:M.getMatrix(e,r),bbox:M.getBbox(e,r),translation:M.getTranslation(e,r)},o=M.getQuantizeBits(e,r),l={index:null,attributes:[]};for(let n=0;n<a;++n){const a=r.GetAttribute(n),d=M.getAttributeParms(e,a);o&&(d.quantizebits=o);const h=M.decodeAttribute(e,t,i,d,a);if(d.attributeType===e.GAT_INDEX?l.index=h:l.attributes.push(h),d.attributeType===e.GAT_USERID){M.createAttributesByUserIdCount(d.numPoints).forEach((e=>{l.attributes.push(e)}))}M.setGeometrySummary(e,d,s)}return l.summary=s,n[s.nodeId]&&(l.subnodeIndexInfos=n[s.nodeId]),l},getAttributeParms(e,t){const i=t.attribute_type(),r=t.compressed();return{attributeType:i,attributeName:M.getAttributeName(e,i,r),dataType:t.data_type(),numComponents:t.num_components(),numPoints:t.num_points(),byteOffset:t.byte_offset(),byteStride:t.byte_stride(),byteLength:t.byte_length(),normalized:t.normalized(),compressed:r}},setGeometrySummary:function(e,t,i){let r;switch(t.attributeType){case e.GAT_POSITION:r="vertex_";break;case e.GAT_INDEX:r="index_";break;case e.GAT_NORMAL:r="normal_";break;case e.GAT_COLOR:r="color_";break;case e.GAT_TEX_COORD:r="uv_";break;case e.GAT_TEX_COORD2:r="uv2_";break;case e.GAT_TEX_COORD3:r="uv3_";break;case e.GAT_USERID:r="uid_";break;case e.GAT_BARYCENTRIC:r="bc_"}r&&(i[`${r}start`]=t.byteOffset,i[`${r}count`]=t.numPoints,i[`${r}value_type`]=t.dataType,i[`${r}length`]=t.byteLength,i[`${r}stride`]=t.byteStride,i[`${r}components`]=t.numComponents,i[`${r}normalized`]=t.normalized,i[`${r}compressed`]=t.compressed)},getUserIdIndexInfo:function(e){const t=e.get_node_id(),i=e.get_userid_index(),r=e.get_index_start(),n=e.get_index_end(),a=n-r+1,s=3*e.get_position_start(),o=3*(e.get_position_end()+1),l=o-s;return{nodeId:t,userId:i,indexStart:r,indexEnd:n,indexCount:a,positionStart:s,positionEnd:o,positionCount:l,cNormalStart:s/3*2,cNormalCount:l/3*2}},decodeAttribute:function(e,t,i,r,n){let{attributeName:a,numComponents:s,numPoints:o,dataType:l,normalized:d,compressed:h,quantizebits:c}=r;const u=o*s;let p,m,f;switch(l){case e.DT_FLOAT64:f=8*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p);let r=new Uint8Array(e.HEAPU8.buffer,p,f).slice();if(e._free(p),c){let e=new BigUint64Array(r.buffer);m=new Float32Array(3*e.length);const t=c.array[0],i=c.array[1],n=c.array[2],a=(BigInt(1)<<BigInt(t))-BigInt(1),s=(BigInt(1)<<BigInt(i))-BigInt(1),o=(BigInt(1)<<BigInt(n))-BigInt(1);for(let r=0,n=e.length;r<n;++r){const n=e[r];let l=n,d=Number(l&a);m[3*r+0]=d,l=n>>BigInt(t),d=Number(l&s),m[3*r+1]=d,l=n>>BigInt(t+i),d=Number(l&o),m[3*r+2]=d}}else{let e=new Uint16Array(r.buffer);m=new Float32Array(3*e.length/4);for(let t=0,i=e.length/4;t<i;++t)m[3*t]=e[4*t],m[3*t+1]=e[4*t+1],m[3*t+2]=e[4*t+2]}s=3;break;case e.DT_FLOAT32:f=4*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p),m=new Float32Array(e.HEAPF32.buffer,p,u).slice(),e._free(p);break;case e.DT_INT8:p=e._malloc(u),t.GetAttributeDataArrayV3(i,n,u,p),m=new Int8Array(e.HEAP8.buffer,p,u).slice(),e._free(p);break;case e.DT_INT16:f=2*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p),m=new Int16Array(e.HEAP16.buffer,p,u).slice(),e._free(p);break;case e.DT_INT32:f=4*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p),m=new Int32Array(e.HEAP32.buffer,p,u).slice(),e._free(p);break;case e.DT_UINT8:p=e._malloc(u),t.GetAttributeDataArrayV3(i,n,u,p),m=new Uint8Array(e.HEAPU8.buffer,p,u).slice(),e._free(p);break;case e.DT_UINT16:f=2*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p),m=new Uint16Array(e.HEAPU16.buffer,p,u).slice(),e._free(p);break;case e.DT_UINT32:f=4*u,p=e._malloc(f),t.GetAttributeDataArrayV3(i,n,f,p),m=new Uint32Array(e.HEAPU32.buffer,p,u).slice(),e._free(p);break;default:throw new Error("CLOUD.Loader.TilesWorkerDecoder: Unexpected attribute type.")}return{name:a,array:m,itemSize:s,normalized:d,compressed:h}},createAttributesByUserIdCount:function(e){const t=[],i=4*e;return t.push({name:"vState",array:new Float32Array(i).fill(0),itemSize:4,normalized:!1,compressed:!1}),t.push({name:"pointColorState",array:new Uint8Array(i).fill(0),itemSize:4,normalized:!0,compressed:!1}),t}},E={decode:function(e,t,i){let r=[];for(let n=0;n<i;n++){const i=t.GetInstance(n),a={blobId:i.get_blob_id(),type:e.BT_INSTANCE,header:s.getHeader(e,i,n),entities:[]},o=i.num_instance_entities();for(let t=0;t<o;++t){const r=i.GetInstanceEntity(t);a.entities.push({userId:r.get_user_id(),userdataId:r.get_userdata_id(),color:r.get_color(),matrix:s.getMatrix(e,i,r),bbox:s.getBbox(e,i,r),translation:s.getTranslation(e,i,r),packingUvs:s.getPackingUvs(e,i,r)})}E.parse(a,r)}return{decodedData:r,buffers:E.getTransferableBuffers(r)}},parse:function(e,t){const i=e.header,r=e.entities,n=E.getNodeInfo(i,r);t.push({blobId:e.blobId,nodeInfo:n,geometry:{attributes:E.getCustomAttributes(r)}})},getTransferableBuffers:function(e){return s.getTransferableBuffers(e)},getNodeInfo:function(e,t){return s.getNodeInfo(e,t)},createUserIdAttribute:function(e){const t=e.length,i=new Uint8Array(4*t);for(let n=0;n<t;++n){const t=r.uint32ToVec4(e[n].userId);i[4*n]=t[0],i[4*n+1]=t[1],i[4*n+2]=t[2],i[4*n+3]=t[3]}return{array:i,itemSize:4,normalized:!0,meshPerAttribute:1}},createPackingUVAttribute:function(e){const t=e.length,i=new Float32Array(2*t);for(let r=0;r<t;++r){const t=e[r].packingUvs;i[2*r]=t[0],i[2*r+1]=t[1]}return{array:i,itemSize:2,normalized:!1,meshPerAttribute:1}},createIdStateAttribute:function(e){const t=new Float32Array(4*e);return t.fill(0),{array:t,itemSize:4,normalized:!1,meshPerAttribute:1}},createIdColorStateAttribute:function(e){const t=new Uint8Array(4*e);return t.fill(0),{array:t,itemSize:4,normalized:!0,meshPerAttribute:1}},getCustomAttributes:function(e){const t=e.length,i=[];return i.push({name:"mcols",attribute:s.createMatrixAttribute(t)}),i.push({name:"muvCols",attribute:s.createUVMatrixAttribute(t)}),i.push({name:"aColor",attribute:s.createColorAttribute(t)}),i.push({name:"vClipping",attribute:s.createClippingAttribute(t)}),i.push({name:"id",attribute:E.createUserIdAttribute(e)}),i.push({name:"uv3",attribute:E.createPackingUVAttribute(e)}),i.push({name:"vState",attribute:E.createIdStateAttribute(t)}),i.push({name:"pointColorState",attribute:E.createIdColorStateAttribute(t)}),i}}},r.Loader.TilesWorkerDecoder=e}(),function(){function e(e){return new Promise(((t,i)=>{e().then((()=>{t(e)}))}))}let t=[],i=[],n=3;r.Workers.LimitedMeshCreator=class{static set concurrency(e){n=e||3}static push(e){i.push(e)}static clear(){t.length=0,i.length=0}static update(){0!==i.length&&(t.length||(t.length=i.length,i.forEach(((e,i)=>{t[i]=e})),i.length=0,async function(e,t,i){const r=[],n=e.splice(0,i).map(((e,i)=>{const n=t(e);return r.push(n),n.then((e=>[i,e]))}));for(const i of e){const[e]=await Promise.race(n),a=t(i);r.push(a),n[e]=a.then((t=>[e,t]))}return Promise.allSettled(r)}(t,e,n).then((e=>{t.length=0}))))}}}(),function(){class e extends r.BimTileFilterManagerV3{constructor(e){super(e)}}r.Workers.FilterManagerV3=e}(),function(){class e extends r.BimTileMaterialManagerV3{constructor(e){super(e),this._textureManager=this.viewer.TextureManager,this._materialParser=new r.Workers.MaterialParser}destroy(){this._textureManager=void 0,this._materialParser.destroy(),this._materialParser=void 0,super.destroy()}parseMaterial(e,t){this._materialParser&&this._materialParser.update(e,t)}dealMaterialParm(e){e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY),e.side=0===e.doubleSide?THREE.FrontSide:THREE.DoubleSide,e.originMetalness=e.metalness,e.originRoughness=e.roughness,e.receiveIBL=0!=e.receiveIbl,e.light=!0!==e.hasLightMap,delete e.hasLightMap,e.hasOwnProperty("textureIds")&&delete e.textureIds,e.hasOwnProperty("customData")&&delete e.customData}generateMaterialName(e,t,i,r,n){const a=-1===t?-1:`${e}_${t}`;let s=a;return void 0!==n&&(s=1==n?`${a}_shadow`:a),r&&(s=`${s}_line`),`${s}_${i?"instance":"standard"}`}getDefaultMaterial(e,t,i){if(!i){const i=this.getDefaultStandardMaterial();return r.MaterialUtil.setCompressParm(i,t),this.dealMaterialDefines(i),i.name=e,this.materialMap[e]=i,i}const n=this.getDefaultInstanceMaterial();r.MaterialUtil.setCompressParm(n,t),this.dealMaterialDefines(n),n.name=e,this.materialMap[e]=n;const a=n.clone();a.transparent=!0,a.defines.INSTANCE_STATE_SECONDARY="",r.MaterialUtil.setCompressParm(a,t);const s=e+"_second";return this.materialMap[s]=a,n}_updateMaterialPartProps(e,t){this.initMaterialOpacity(t),e.localClippingMode&&(t.clippingPlanes=e.localClippingPlanes,t.innerClipping=e.innerClippingMode,e.innerClippingMatrix&&t.orthoViewProjMatrix.copy(e.innerClippingMatrix))}getLineMaterial(e,t,i){const{materialId:n,materialBlockId:a}=t,s=`${a}_${n}_line`;let o=this.materialMap[s];if(r.Utils.isDefined(o))return o._referenceCount++,Promise.resolve(o);const l=this._materialParser.getMaterialParm(a,n);return o=this._createLineMaterial(e,s,l,t,i),Promise.resolve(o)}_createLineMaterial(e,t,i,n,a){const s=a?this.createInstanceMaterial(i):new r.LineBasicMaterial({linewidth:1});if(a&&(s.receiveIBL=!1),this._updateMaterialPartProps(e,s),s._imageByteSize=0,s._referenceCount=1,s.vertexColors=!!n.vertexColors,s.color.setHex(i.color),s.name=t,s.defines&&(s.defines.USE_COLORWITHOUTLIGHT=""),s.needsUpdate=!0,this.materialMap[t]=s,a){const e=r.MaterialUtil.getMaterialParameters(s);let i=this.createInstanceSecondMaterial(e);!0===s.transparent?i.transparent=!1:i.transparent=!0,i.defines.INSTANCE_STATE_SECONDARY="",i.defines.USE_COLORWITHOUTLIGHT="",this.dealMaterialDefines(i),r.MaterialUtil.setCompressParm(i,n);const a=t+"_second";i.name=a,this.materialMap[a]=i}return s}getMaterial(e,t,i,n){const{materialId:a,materialBlockId:s,vertexColors:o,isLine:l,hasLightMap:d,isShadowExterior:h,growthAnimationMap:c,growthAnimationMapSizeWidth:u,growthAnimationMapSizeHeight:p,growthAnimationPlanes:m}=i,f=this.generateMaterialName(s,a,n,l,h);let g;if(-1===a)return g=this.getDefaultMaterial(f,i,n),this.updateMaterialUseCompressedNormal(g),Promise.resolve(g);if(g=this.getMaterialByName(f),r.Utils.isDefined(g))return Promise.resolve(g);let v=r.Utils.clone(this._materialParser.getMaterialParm(s,a),!0);return v.vertexColors=o,v.hasLightMap=d,v.isShadowExterior=h,v.growthAnimationMap=c,v.growthAnimationMapSizeWidth=u,v.growthAnimationMapSizeHeight=p,v.growthAnimationPlanes=m,v.packingMatTexture=void 0!==this.packingMatTexture?this.packingMatTexture:null,this.dealMaterialParm(v),g=this._createMaterial(e,f,v,i,n),"bimtile_unique_material_treeTrunk"==v.name?g.isTreeTrunk=!0:"bimtile_unique_material_treeLeaves"==v.name&&(g.isTreeLeaves=!0),this.updateMaterialUseCompressedNormal(g),this._createTexture(t,g,s,a)}_createMaterial(e,t,i,n,a){const s=i.receiveIBL&&r.GlobalData.IBL;r.Utils.isDefined(i.tintColor)&&0==i.tintColor&&(i.tintColor=16777215),i.useEnvLight=!0,r.Utils.isDefined(e.datetime)&&this._checkInstancePackingMaterial(e.datetime,i);const o=a?this.createInstanceMaterial(i,!0,s):this.createStandardMaterial(i,s);o.name=t,r.Utils.isDefined(n.useBCOutline)&&!0===n.useBCOutline&&(o.useBCOutline=!0),null!=this.packingMatTexture&&(o.packingMatMap=this.packingMatTexture),n.isLine&&(o.disableHemiLight=!0),this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!i.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e]);if(void 0!==o.refreshUniforms&&o.refreshUniforms(),this._updateMaterialPartProps(e,o),this.materialMap[t]=o,a){const e=r.MaterialUtil.getMaterialParameters(o);let i=this.createInstanceSecondMaterial(e);i.transparent=!o.transparent,i.defines.INSTANCE_STATE_SECONDARY="",this.dealMaterialDefines(i),r.MaterialUtil.setCompressParm(i,n);const a=t+"_second";this.materialMap[a]=i}return r.Utils.isDefined(n.uvCenter)&&(o.uvCenter=n.uvCenter,o.uvHalfExtent=n.uvHalfExtent),r.MaterialUtil.setCompressParm(o,n),o}_createTexture(e,t,i,n){const a=this._materialParser,s=a.getTextureIdsByMaterialId(i,n);if(!s)return Promise.resolve(t);const o=this._textureManager,l=r.Workers.TextureType,d=[];for(let t=0,h=s.length;t<h;++t){const h=s[t],c=a.getTextureParm(i,h);if(!r.Utils.isDefined(c)||c.image<0)continue;const u=a.getImageParm(i,c.image);if(!r.Utils.isDefined(u))continue;const p=c.alpha>0?l.TT_ALPHA:c.type,m=u.type;let f=c.name||`${i}_${n}`;if(u.url){const t=`${e}${u.url}`;f=r.Utils.getEncodedString(t+f);const i=new Promise(((e,i)=>{o.getTextureFromURL(t,f,{textureParm:c,imageType:m,fromWorker:true}).then((t=>{e({textureType:p,texture:t})})).catch((e=>{i(e)}))}));d.push(i)}else if(u.bufferId>=0){const e=this._getImageBuffer(u),t=new Promise(((t,i)=>{o.getTextureFromBuffer(e,f,{textureParm:c,imageType:m,fromWorker:true}).then((e=>{t({textureType:p,texture:e})})).catch((e=>{i(e)}))}));d.push(t)}}return 0===d.length?Promise.resolve().then((()=>t)):Promise.all(d).then((e=>(e.forEach((e=>{this._setTexture(t,e.textureType,e.texture)})),t)))}_setTexture(e,t,i){const n=r.MaterialUtil.getImageByteSize(i.image);e._imageByteSize+=n;const a=r.Workers.TextureType;switch(t){case a.TT_DIFFUSE:e.map=i;break;case a.TT_SPECULAR:e.specularMap=i;break;case a.TT_EMISSIVE:e.emissiveMap=i;break;case a.TT_ENVIRONMENT:e.envMap=i;break;case a.TT_ALPHA:e.useAlphaMap=!0,e.map=i,e.transparent=!0,e.alphaTest=.01,this._dealInstanceSecondMaterialAlpha(e);break;case a.TT_RELIEF:case a.TT_BUMP:e.bumpMap=i,e.bumpScale=i.bumpScale,e.bumpUvTransform=i.matrix;break;case a.TT_LIGHT:e.lightMap=i,e.defines.USE_COMPONENT_LIGHTMAP="",e.lightMapIntensity=r.GlobalData.LightmapIntensity}if(e.refreshUniforms(),e.needsUpdate=!0,""===e.defines.USE_INSTANCE){const r=e.name+"_second";let n=this.materialMap[r];if(!n)return;i._referenceCount++,this._setTexture(n,t,i)}}_getImageBuffer(e){return e.imageBuffer}}r.Workers.MaterialManagerV3=e}(),function(){class e extends r.Workers.TilesReader{constructor(e){super(e)}_initDescriptor(){this.descriptor=new r.BimtileDescriptorV3(this)}_createParserByType(e){let t=this._parsers[e];if(t)return t;const i=r.Workers.ParserType;switch(e){case i.USERID:t=new r.Workers.UserIdParserV3;break;case i.USERDATA:t=new r.Workers.UserDataParser;break;case i.SEARCHTREE:t=new r.Workers.SearchTreeV2Parser(this);break;case i.TILEID:t=new r.Workers.TileIdParser;break;case i.NODEID:t=new r.Workers.NodeIdParser;break;case i.NODEBOX:t=new r.Workers.NodeBoxParser;break;case i.USERIDBOX:t=new r.Workers.UserIdBoxParser}return t&&(this._parsers[e]=t),t}createNodeInfoMap(){}getAllUserIndexCallback(e){this.getParserByType(r.Workers.ParserType.USERID).getAllUserIndexCallback(e)}getUserIdDrawingBoxByIndex(e,t){return this.getParserByType(r.Workers.ParserType.USERIDBOX).getUserIdDrawingBoxByIndex(e,t)}getOriginUserIdBoxByIndex(e,t){return this.getParserByType(r.Workers.ParserType.USERIDBOX).getOriginUserIdBoxByIndex(e,t)}setChangedUserIdBoxByIndex(e,t,i){this.getParserByType(r.Workers.ParserType.USERIDBOX).setChangedUserIdBoxByIndex(e,t,i)}getChangedUserIdBoxByIndex(e,t){return this.getParserByType(r.Workers.ParserType.USERIDBOX).getChangedUserIdBoxByIndex(e,t)}}r.Workers.TilesReaderV3=e}(),function(){class e extends r.Workers.TilesLoader{constructor(e){super(e),this.batchedMeshManager=new r.BimTileBatchedMeshManagerV3(this),this.instancedMeshManager=new r.BimTileInstancedMeshManagerV3(this),this._enableDynamicInstanceLod=!1,this._lodMeshVisibleInfo={}}destroy(){this._lodMeshVisibleInfo={},super.destroy()}_initMeshBuilder(){this._batchedMeshBuilder=new r.Workers.BatchedMeshBuilderV3,this._instancedMeshBuilder=new r.Workers.InstancedMeshBuilderV3}_createTileReader(){this.tileReader=new r.Workers.TilesReaderV3({dataVersion:r.Workers.DataVersion.DV_V3})}patchMeshNodeInfo(e,t,i,r){this.tileReader.getDescriptor().patchMeshNodeInfo(e,t,i,r)}patchInstanceNodeInfo(e,t,i,r){this.tileReader.getDescriptor().patchInstanceNodeInfo(e,t,i,r)}addUserIdMapIndices(e,t){}addInstanceInfo(e,t){}_getDataVersion(){return r.Workers.DataVersion.DV_V3}get enableDynamicInstanceLod(){return this._enableDynamicInstanceLod}set enableDynamicInstanceLod(e){this._enableDynamicInstanceLod=e}setLodMeshVisibleInfo(e,t){this._lodMeshVisibleInfo[e]=t}isLodMeshLoaded(e,t){return this._lodMeshVisibleInfo[e]===t}getMeshNodeById(e){const t=this.filter.model.objectGroup.children[0];return this.batchedMeshManager.getMeshNodeById(e,t)}addInstanceLodMeshIdMap(e,t,i,r,n){this.instancedMeshManager.addInstanceLodMeshIdMap(e,t,i,r,n)}getInstanceMeshNodeById(e){if(!this._enableDynamicInstanceLod){const t=this.filter.model.objectGroup.children[1];return this.instancedMeshManager.getInstanceMeshNodeById(e,t)}const t=this._lodMeshVisibleInfo[e];if(void 0!==t)return this.instancedMeshManager.getInstanceLodMeshNodeById(e,t)}getInstanceLoadedLodLevel(e){return this.instancedMeshManager.getInstanceLoadedLodLevel(e)}isInstanceLodLevelLoaded(e,t){return this.instancedMeshManager.isInstanceLodLevelLoaded(e,t)}}r.Workers.TilesLoaderV3=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.userIdMap=new Map,this.userdataIdMap=new Map,this.userIdIndexMap=new Map}destroy(){this.userdataIdMap=void 0,this.userIdMap=void 0,this.userIdIndexMap=void 0,super.destroy()}clear(){super.clear()}update(e){if(this.isDestroyed())return;e.data.forEach((e=>{this._parseUserIds(e)}))}_parseUserIds(e){const t=e.userIds,i=e.minUserIdIndex,n=e.userdataIds,a=new r.Workers.BinaryDecoder(t);let s=0;for(;!a.atEnd();){let e=i+s,t=a.readUnsignedVarint32();const r=a.readString(t);this.userIdMap.set(e,r),this.userdataIdMap.set(e,n[s]),this.userIdIndexMap.set(r,e),s++}a.destroy()}getUserIdByIndex(e){return this.userIdMap.get(e)}getIndexByUserId(e){return this.userIdIndexMap.get(e)}getUserdataIdByIndex(e){return this.userdataIdMap.get(e)}updateUserdataIdByUserIdIndex(e,t){void 0!==this.userdataIdMap.get(e)&&this.userdataIdMap.set(e,t)}getAllUserIds(){return Array.from(this.userIdIndexMap.keys())}getAllUserIndexCallback(e){if(!e)return;const t=this.userIdMap.keys();for(const i of t)e(i)}}r.Workers.UserIdParserV3=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.nodeMap=new Map,this.userIdChangedBoxMap={},this.userIdDrawingBoxMap={},this.modelMatrix=new THREE.Matrix4}destroy(){this.userIdChangedBoxMap=void 0,this.userIdDrawingBoxMap=void 0,this.modelMatrix=void 0,super.destroy()}clear(){this.clearUrls()}update(e){if(this.isDestroyed())return;const t=e.params.element.startPos,i=e.data[0];let r=[];r.length=6;let n=0;for(let e=0,a=i.length;e<a;e+=6){for(let t=0;t<6;t++)r[t]=i[e+t];const a=new THREE.Box3;a.setFromArray(r);const s=t+n;this.nodeMap.set(s,a),n++}}getNode(e){return this.nodeMap.get(parseInt(e))}getUserIdDrawingBoxByIndex(e,t){const i=t.manager.scene.getRawMatrixGlobal(),n=t.transformMatrix;if(!r.Math.equalsEpsilonMatrix4(this.modelMatrix,n,1e-4)){this.modelMatrix.copy(n);for(let t in this.userIdDrawingBoxMap)this.userIdDrawingBoxMap[t].copy(this.getNode(e)),this.userIdDrawingBoxMap[t].applyMatrix4(this.modelMatrix).applyMatrix4(i)}return this.userIdDrawingBoxMap[e]||(this.userIdDrawingBoxMap[e]=this.getNode(e).clone(),this.userIdDrawingBoxMap[e].applyMatrix4(this.modelMatrix).applyMatrix4(i)),this.userIdDrawingBoxMap[e]}getOriginUserIdBoxByIndex(e){return this.getNode(e).clone()}setChangedUserIdBoxByIndex(e,t){this.userIdChangedBoxMap[e]=t}getChangedUserIdBoxByIndex(e){return this.userIdChangedBoxMap[e]}}r.Workers.UserIdBoxParser=e}(),function(){const e=Object.freeze({UNLOADED:"unloaded",LOADING:"loading",LOADED:"loaded",FAILED:"failed"});class t{constructor(){this._id=null,this._byteLength=0,this._refCount=0,this._contentType=0,this._contentBlob=null,this._status=e.UNLOADED,this._readyDeferred=new r.Deferred}destroy(){this._contentBlob=null,this._readyDeferred.destroy(),this._readyDeferred=null}get readyPromise(){return this._readyDeferred.promise}get refCount(){return this._refCount}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}set contentBlob(e){this._contentBlob=e}get contentBlob(){return this._contentBlob}set contentType(e){this._contentType=e}get contentType(){return this._contentType}set status(e){this._status=e}get status(){return this._status}resetRef(){this._refCount=0}ref(){++this._refCount}unRef(){--this._refCount}isUnloaded(){return this._status===e.UNLOADED}isLoading(){return this._status===e.LOADING}isLoaded(){return this._status===e.LOADED}isFailed(){return this._status===e.FAILED}resolveDeferred(e){this._readyDeferred.resolve(e)}}r.Workers.SharedBlobManager=class{constructor(){this._entityMap={},this._waitingTaskMap={},this._callbacks={}}destroy(){this._entityMap={},this._waitingTaskMap={}}disposeSharedBlob(e){let t=this._entityMap[e];t&&(t.refCount>0&&t.unRef(),0===t.refCount&&(t.destroy(),this._entityMap[e]=void 0,delete this._entityMap[e]))}initSharedBlob(t){const i=this._createSharedBlob(t);i.status=e.LOADING,i.ref(),this._initResolvedFn(t),i.readyPromise.then((i=>{this.hasSharedBlob(t)?(this._setSharedBlob(t,{id:t,contentBlob:i.contentBlob,contentType:i.contentType,byteLength:i.byteLength,status:e.LOADED}),this._fireResolvedFn(t,{contentBlob:i.contentBlob,contentType:i.contentType,byteLength:i.byteLength}),i=null):this._fireResolvedFn(t,null)})).catch((e=>{console.log("load failed:",e),this._handleFailedLoad(t)}))}resolveSharedBlob(e,t){const i=this.getSharedBlob(e);i?i.resolveDeferred(t):console.log("resolveSharedBlob:",e)}parseSharedBlob(e){return new Promise(((t,i)=>{let r=this.getSharedBlob(e);r?r.isLoaded()?(r.ref(),t({contentBlob:r.contentBlob,contentType:r.contentType,byteLength:r.byteLength})):r.isLoading()?(r.ref(),this._addResolvedFn(e,(function(e){t(e)}))):r.isFailed()&&i("load entity failed"):i("no shared content blob!")}))}getSharedBlob(e){return this._entityMap[e]}hasSharedBlob(e){return!!this.getSharedBlob(e)}isSharedBlobLoaded(e){return this.getSharedBlob(e).isLoaded()}_createSharedBlob(e){return this._entityMap[e]=new t,this._entityMap[e]}_setSharedBlob(t,i){const r=this.getSharedBlob(t);void 0!==i.id&&(r.id=i.id),void 0!==i.contentBlob&&(r.contentBlob=i.contentBlob),void 0!==i.contentType&&(r.contentType=i.contentType),void 0!==i.byteLength&&(r.byteLength=i.byteLength),r.status=i.status,void 0!==i.status&&i.status===e.FAILED&&r.resetRef()}_fireResolvedFn(e,t){const i=this._waitingTaskMap[e];if(i){for(let e=0;e<i.length;++e)i[e](t);this._removeResolvedFn(e)}}_initResolvedFn(e){this._waitingTaskMap[e]=[]}_addResolvedFn(e,t){this._waitingTaskMap[e].push(t)}_removeResolvedFn(e){this._waitingTaskMap[e]=null,delete this._waitingTaskMap[e]}_handleFailedLoad(t){this.hasSharedBlob(t)&&this._setSharedBlob(t,{status:e.FAILED}),this._fireResolvedFn(t,null)}}}(),function(){class e extends r.Workers.BatchedMeshBuilder{constructor(){super()}_createMesh(e,t){return new Promise(((i,n)=>{const a=this._getNodeInfo(e,t.nodeInfo),s=this._createGeometry(t.geometry,a),o=e._loader,l=e.content.meshes,d=`${a.tileId}_${a.nodeId}`,h=this._isLineMode(a),c=h?r.LineSegmentsEx:r.MeshEx;a.isShadowExterior=e.isShadowExterior;const u=this._getMaterial(o,a,h),p=o.materialManager;h&&(e.content.hasLine=!0),u.then((t=>{const n=new c(s,[t]);if(n.frustumCulled=!1,n.name=d,n.tileId=a.tileId,n.nodeId=a.nodeId,n.indexGroups=a.indexInfos,n.indexCount=s.index.count,n.databagId=l.databagId,n.fileId=l.fileId,n.isShadowExterior=e.isShadowExterior,n.matrixRoot=a.matrixRoot,n.isMeshQuantization=a.isCompressedMode,n.applyMatrix4(a.matrix),this._isEnableShadowMap()){const e=o.filter.model;n.castShadow=e.castShadow,n.receiveShadow=e.receiveShadow}const h=o.filter.model;r.GlobalData.EnableShadowMap&&(n.castShadow=!1===n.material[0].transparent&&h.castShadow,n.receiveShadow=h.receiveShadow),n.customDepthMaterial=p.getBatchDepthMaterial(),n.matrixAutoUpdate=!1,l.add(n),this._addToMeshIdMap(o,d,n);for(const e of n.indexGroups.keys()){const t=o.getDescriptor().userIdInfoMap.get(e);o.getDescriptor().onNodeInfoChanged(t,n.tileId,n.nodeId)}i()})).catch((e=>{n(e)}))}))}_parseSubnodeIndexInfos(e){const t=e.indexInfos;if(!t)return;if(t instanceof Map)return;const i=e.numComponentsOfIndexInfo,r=t.length;if(0===r||r%i!=0)return console.log("Data parsing error!"),void(e.indexInfos=void 0);let n=new Map;for(let e=0,r=t.length;e<r;e+=i){let i=e;const r={userId:t[i++],nodeId:t[i++],stateIndex:t[i++],positionStart:t[i++],positionEnd:t[i++],positionCount:t[i++],indexStart:t[i++],indexEnd:t[i++],indexCount:t[i++],cNormalStart:t[i++],cNormalCount:t[i++]};n.set(r.userId,r)}e.indexInfos=n}_updateMeshNodeInfo(e,t,i){if(!i.indexInfos)return;const{nodeId:r,tileId:n,indexInfos:a,materialBlockId:s,materialId:o}=i,l=this._isLineMode(i),d=t.materialManager.generateMaterialName(s,o,!1,l);for(const e of a.keys())t.patchMeshNodeInfo(r,n,e,d)}_addUserIdMapIndices(e,t,i){}}r.Workers.BatchedMeshBuilderV3=e}(),function(){class e extends r.Workers.InstancedMeshBuilder{constructor(e){super(e)}build(e,t,i){let n=[],a=[],s=[];const o=e.blobId,l=r.Workers.TileBlockType;t.forEach((e=>{const t=e.parsedData;Object.keys(t).forEach((e=>{const i=t[e],r=Number(e);r===l.BT_LINE||r===l.BT_MESH?a.push(...i):r===l.BT_INSTANCE?n=i.filter((e=>e.blobId===o)):r===l.BT_MATERIAL&&s.push(i)}))}));const d=this._parseInstances(e,n);if(0===d.length)return null;this._holdInstanceNodeInfos(e,d);const h=this._parseGeometries(e,a);return 0===h.length?null:(s.length&&this._parseMaterials(e,s),this._parseMeshes(e,d,h,i,!0))}_createGeometry(e,t,i){const r=new THREE.InstancedBufferGeometry;return r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:0}),r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:1}),t.index&&r.setIndex(t.index),t.attributes.forEach((e=>{"id"!==e.name&&"vState"!==e.name&&"pointColorState"!==e.name&&"uv2"!==e.name&&r.setAttribute(e.name,e.attribute)})),this._createCustomAttributes(r,i),r}_createCustomAttributes(e,t){t.forEach((t=>{if(Array.isArray(t.attribute)){let i="mcols"===t.name;t.attribute.forEach((t=>{let r=i?t.array.slice():t.array;e.setAttribute(t.name,new THREE.InstancedBufferAttribute(r,t.itemSize,t.normalized,t.meshPerAttribute))}))}else{const i=t.attribute;if("uv3"===t.name&&i.array.length>0&&i.array[0]<0)return;e.setAttribute(t.name,new THREE.InstancedBufferAttribute(i.array,i.itemSize,i.normalized,i.meshPerAttribute))}}))}_getInstanceInfo(e,t){const i=e._loader,r=t.geometry.attributes,n=t.nodeInfo;let a=-1===n.tileId?e.contentId:n.tileId;void 0===e.contentId2&&(e.contentId2=e.contentId),e.contentId=a,e.tileId=a,e.content&&e.content.meshes&&(e.content.meshes.tileId=a);const s=`${a}_${n.blockId}`;n.nodeId=s;const o=n.entityInfoArray;if(n.cached)o.forEach(((t,r)=>{e.userIndexMap.set(t.userID,!0),this._updateInstanceNodeInfo(i,t,s,r,a)})),this._addToInstanceInfoMap(i,s,o);else{n.cached=!0,n.rootMatrix=(new THREE.Matrix4).fromArray(n.rootMatrix);const t=i.tileReader.userDataParser,r=o[0],l=o[1],d=o[2],h=o[3],c=o[4];let u=[];r.forEach(((r,n)=>{let o=l[n],p={userID:r,userDataID:o,userData:t.getUserDataById(o),color:d[n],entityMatrix:(new THREE.Matrix4).fromArray(h,16*n),uv3:[c[2*n],c[2*n+1]]};u.push(p),e.userIndexMap.set(r,!0),this._updateInstanceNodeInfo(i,p,s,n,a)})),n.entityInfoArray=u,this._addToInstanceInfoMap(i,s,u)}return{nodeInfo:n,geometry:r}}_updateInstanceNodeInfo(e,t,i,r,n){const a=t.userID,s={bufferId:i,instanceIndex:r,entityMatrix:t.entityMatrix};e.disableUserData?e.addNoUserDataInstanceNodeInfo(a,i,s):e.patchInstanceNodeInfo(a,i,s,n)}_updateCustomAttributeBuffer(e,t,i,n,a,s){const o=a.filter.model.localClippingMode?r.EnumElementState.CLIPPING:r.EnumElementState.NONE,l=i.length;n.forEach((n=>{if("mcols"===n.name){let e=new Array(n.attribute.length);e.fill(0);let a=s.attributes;for(let s=0;s<l;++s){let o=r.Utils.scratchMatrix4_1.copy(i[s].entityMatrix);if(t){let e=r.Utils.scratchMatrix4_2.copy(t);o=o.multiply(e)}const l=o.elements;n.attribute.forEach(((t,i)=>{const r=a[`mcol${i}`].array;r[e[i]++]=l[0+4*i],r[e[i]++]=l[1+4*i],r[e[i]++]=l[2+4*i]}))}}else if("muvCols"===n.name);else if("aColor"===n.name){const t=n.attribute.array,r=e.color,a=null!=r.opacity?r.opacity:1;let s,o=new THREE.Color,d=0;for(let e=0;e<l;++e){let n=i[e].color;s=-1!==n?o.setHex(n):r,t[d++]=s.r,t[d++]=s.g,t[d++]=s.b,t[d++]=a}}else"vClipping"===n.name&&0!==o&&n.attribute.array.fill(o)}))}_addToInstanceInfoMap(e,t,i){}_addToMeshIdMap(e,t,i,r,n,a){}addMeshToGroup(e,t,i,r,n,a,s){e.nodeIndexId=i;const o=e._loader,l=e.content.meshes;if(e.enableDynamicInstanceLod()){const t=e.instanceId,i=n.insLodLevel,r=e.getRealInsLodLevel(t,i),d=e.getInsLodInfo(t,i).modelUrl;n.entityId=d,a.entityId=d;const h=e.updateInstanceLodLevelInfo(d,r);e.content.addLodMeshNode(n,d,r,h),e.content.addLodMeshNode(a,d,r,h),l.parent&&e.content.updateMatrixWorldForLodMeshes(),o.addInstanceLodMeshIdMap(n.name,0,n,s,r),o.addInstanceLodMeshIdMap(a.name,0,a,s,r)}else l.add(n),l.add(a),o.addInstanceMeshIdMap(n.name,0,n,s),o.addInstanceMeshIdMap(a.name,0,a,s)}}r.Workers.InstancedMeshBuilderV3=e}(),r.Workers.TileLodInstancedContent=class{constructor(e,t,i,n){this._tile=e,this._entityId=t,this._resource=r.Resource.create({url:i}),this._lodLevel=n||0,this._destroyed=!1,this._state=r.TileContentProcessState.PENDING,this._buffer=void 0,this._bufferByteLength=0,this._fetchContentCallback=this._fetchContent.bind(this),this._fromSharedBlob=!1}destroy(){this._destroyed=!0,this._disposeSharedMeshBlob(),this._resource&&(this._resource.request&&this._resource.request.destroy(),this._resource.destroy(),this._resource=void 0),this._fetchContentCallback=void 0,this._buffer=void 0,this._tile=void 0}isDestroyed(){return this._destroyed}get contentPending(){return this._state===r.TileContentProcessState.PENDING}get contentLoaded(){return this._state===r.TileContentProcessState.LOADED}get contentProcessing(){return this._state===r.TileContentProcessState.PROCESSING}get contentProcessed(){return this._state===r.TileContentProcessState.PROCESSED}get contentReady(){return this._state===r.TileContentProcessState.READY}update(e){this.contentPending&&this.requestContent(),this.contentLoaded&&this.parseContent(),this.contentProcessed&&this.updateContent(e)}requestContent(){if(this._hasSharedMeshBlob()){if(!this._isSharedBlobLoaded())return!1;const e=this._parseSharedMeshBlob();return this._requestContentByPromise(e,!0)}const e=this._getRequestPromise();return!!e&&(this._initSharedMeshBlob(),this._requestContentByPromise(e,!1,(()=>{this._disposeSharedMeshBlob()})))}parseContent(){const e=this._tile;if(!this._isValidTileContent(e))return void(this._state=r.TileContentProcessState.FAILED);const t=this._buffer;if(this._bufferByteLength=t.byteLength,this._state=r.TileContentProcessState.PROCESSING,this._fromSharedBlob)this._parse(e,t.contentBlob);else{const i=this._getContentUrl();e._loader.decodeByBuffer(t,i).then((t=>{this._updateMeshBlob(t),this.resolveSharedMeshBlob(t),this._parse(e,t)})).catch((e=>{console.log(e)}))}}updateContent(e){const t=this._tile;this._isValidTileContent(t)?(this._state=r.TileContentProcessState.READY,this._setContentReady(),this._updateContentLength(),this._disposeContentBuffer(),this._delayRefresh(e)):this._state=r.TileContentProcessState.FAILED}_getContentUrl(){return this._resource.url}_getRequestPromise(){const e=this._tile,t=this._resource,i=new r.Request({throttle:!0,type:e._tileset.type,priorityCallback:e._createPriorityCallback(e)});return t.request&&(t.request.destroy(),t.request=void 0),t.request=i,t.fetch({fetchCallback:this._fetchContentCallback})}_requestContentByPromise(e,t,i){const n=this._tile,a=this._resource,s=t?null:a.request,o=this._handleFailedContent(this,n._tileset),l=n._tileset.statistics;return l.incrementNumberOfPendingRequests(),this._state=r.TileContentProcessState.LOADING,e.then((e=>{this._isValidTileContent(n)?(l.decrementNumberOfPendingRequests(),this._state=r.TileContentProcessState.LOADED,this._setDataBlob(e,t)):o()})).catch((e=>{if(i&&i(),s&&s.state===r.RequestState.CANCELLED)return this._state=r.TileContentProcessState.PENDING,l.decrementNumberOfPendingRequests(),void l.incrementNumberOfAttemptedRequests();console.log(e),o(),s&&a.retryOnError()&&(s.state=r.RequestState.UNISSUED,s.deferred=void 0,this._state=r.TileContentProcessState.PENDING)})),!0}_setDataBlob(e,t){this._fromSharedBlob=t,this._buffer=e}_setContentReady(){const e=this._tile;e._tileset.instanceLodMeshPool.setModelState(e.instanceId,this._lodLevel,e.contentId,r.TileContentState.READY)}_updateContentLength(){this._tile.updateContentLength(this._bufferByteLength)}_disposeContentBuffer(){this._buffer=void 0}_delayRefresh(e){e.afterRenderFns.push((function(){}))}_updateMeshBlob(e){this._getMeshBuilder().updateGeomteries(e)}_parse(e,t){if(!this._isValidTileContent(e)||!t)return void(this._state=r.TileContentProcessState.FAILED);const i=this._createMeshes(t);i?Promise.all(i).then((()=>{this._state=r.TileContentProcessState.PROCESSED})):this._state=r.TileContentProcessState.FAILED}_getMeshBuilder(){return this._tile._loader.getInstancedMeshBuilder()}_getInstanceInfos(e){return e.instanceInfos}_createMeshes(e){const t=this._tile,i=this._getMeshBuilder();let n=[],a=[];const s=r.Workers.TileBlockType,o=e.parsedData;Object.keys(o).forEach((e=>{const t=o[e],i=Number(e);i===s.BT_LINE||i===s.BT_MESH?n.push(...t):i===s.BT_MATERIAL&&a.push(t)}));const l=this._getInstanceInfos(t);if(!l||0===l.length)return null;const d=i._parseGeometries(t,n);return 0===d.length?null:(a.length&&i._parseMaterials(t,a),i._parseMeshes(t,l,d,this._lodLevel))}_fetchContent(e,t,i){this._tile._loader.loadArrayBufferImmediately(e,t,i)}_handleFailedContent(e,t){return function(){e.contentProcessing?t.statistics.decrementNumberOfTilesProcessing():t.statistics.decrementNumberOfPendingRequests(),e._state=r.TileContentProcessState.FAILED}}_isValidTileContent(e){return!(e.isDestroyed()||e.content.isDestroyed()||this.isDestroyed())}_getSharedMeshBlobId(){return this._entityId}_getSharedMeshBlobManager(){return this._tile._loader.getSharedMeshBlobManager()}_hasSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().hasSharedBlob(e)}_isSharedBlobLoaded(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().isSharedBlobLoaded(e)}_initSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().initSharedBlob(e)}_parseSharedMeshBlob(){const e=this._getSharedMeshBlobId();return this._getSharedMeshBlobManager().parseSharedBlob(e)}_disposeSharedMeshBlob(){const e=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().disposeSharedBlob(e)}resolveSharedMeshBlob(e){const t=this._getSharedMeshBlobId();this._getSharedMeshBlobManager().resolveSharedBlob(t,{contentBlob:e,contentType:e.contentType,byteLength:e.byteLength})}},function(){class e extends r.BimTilesModelV3{constructor(e,t,i,r,n,a){super(e,t,i,r,n,a)}_createNewTileset(e){return new r.Workers.Tileset(e)}_createLoader(e){this.tilesLoader=new r.Workers.TilesLoaderV3(e)}_crateFilterManger(){return new r.Workers.FilterManagerV3(this)}_crateMaterialManger(e){return e.borderLineVisible=this._enableBorderLine,new r.Workers.MaterialManagerV3(e)}getAllUserIds(){return this.tilesLoader.tileReader.getAllUserIds()}}r.Workers.TilesModelV3=e}(),function(){class e{constructor(e,t,i){this._bytes=null,this._cursor=0,this._end=0,this._start=0,this._error=!1,e&&this.setBlock(e,t,i)}destroy(){this.clear()}setBlock(e,t,i){this._bytes=e,this._start=void 0!==t?t:0,this._end=void 0!==i?this._start+i:this._bytes.length,this._cursor=this._start}getBuffer(){return this._bytes}clear(){this._bytes=null,this._cursor=0,this._end=0,this._start=0,this._error=!1}atEnd(){return this._cursor==this._end}readUnsignedVarint32(){const e=this._bytes;let t=e[this._cursor+0],i=127&t;return 128>t?(this._cursor+=1,this._cursor<=this._end?i:void 0):(t=e[this._cursor+1],i|=(127&t)<<7,128>t?(this._cursor+=2,this._cursor<=this._end?i:void 0):(t=e[this._cursor+2],i|=(127&t)<<14,128>t?(this._cursor+=3,this._cursor<=this._end?i:void 0):(t=e[this._cursor+3],i|=(127&t)<<21,128>t?(this._cursor+=4,this._cursor<=this._end?i:void 0):(t=e[this._cursor+4],i|=(15&t)<<28,128>t?(this._cursor+=5,this._cursor<=this._end?i>>>0:void 0):(this._cursor+=5,128<=e[this._cursor++]&&128<=e[this._cursor++]&&128<=e[this._cursor++]&&128<=e[this._cursor++]&&e[this._cursor++],this._cursor<=this._end?i:void 0)))))}readString(t){const i=this._bytes;let r,n,a,s=this._cursor,o=[],l="";for(t=s+t;s<t;){let e=i[s++];if(128>e)o.push(e);else{if(192>e)continue;224>e?(r=i[s++],o.push((31&e)<<6|63&r)):240>e?(r=i[s++],n=i[s++],o.push((15&e)<<12|(63&r)<<6|63&n)):248>e&&(r=i[s++],n=i[s++],a=i[s++],e=(7&e)<<18|(63&r)<<12|(63&n)<<6|63&a,e-=65536,o.push(55296+(e>>10&1023),56320+(1023&e)))}8192<=o.length&&(l+=String.fromCharCode.apply(null,o),o.length=0)}return l+=e.byteArrayToString(o),this._cursor=s,l}static byteArrayToString(t){if(8192>=t.length)return String.fromCharCode.apply(null,t);let i="";for(let r=0,n=t.length;r<n;r+=8192){let n=e.arraySlice(t,r,r+8192);i+=String.fromCharCode.apply(null,n)}return i}static arraySlice(e,t,i){return 2>=arguments.length?Array.prototype.slice.call(e,t):Array.prototype.slice.call(e,t,i)}}r.Workers.BinaryDecoder=e}(),function(){class e extends THREE.BufferGeometry{constructor(e,t=64,i=1,r=8,n=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:n};let a=[];t<2&&(a.push(0),a.push(1));for(let e=0;e<=t-2;e++){if(1==e||e==t-2){const t=1==e?.01:.99;a.push(t)}if(t-2==1){const t=1==e?.01:.99;a.push(t)}const i=e/(t-2);a.push(i)}const s=function(e,t,i){const r=new THREE.Vector3,n=[],s=[],o=[],l=new THREE.Vector3,d=new THREE.Matrix4;for(let i=0;i<=t;i++){let t=e.getTangentAt(a[i],new THREE.Vector3);t.normalize(),n.push(t)}s[0]=new THREE.Vector3,o[0]=new THREE.Vector3;let h=Number.MAX_VALUE;const c=Math.abs(n[0].x),u=Math.abs(n[0].y),p=Math.abs(n[0].z);c<=h&&(h=c,r.set(1,0,0));u<=h&&(h=u,r.set(0,1,0));p<=h&&r.set(0,0,1);l.crossVectors(n[0],r).normalize(),s[0].crossVectors(n[0],l),o[0].crossVectors(n[0],s[0]);for(let e=1;e<=t;e++){if(s[e]=s[e-1].clone(),o[e]=o[e-1].clone(),l.crossVectors(n[e-1],n[e]),l.length()>Number.EPSILON){l.normalize();const t=Math.acos(THREE.MathUtils.clamp(n[e-1].dot(n[e]),-1,1));s[e].applyMatrix4(d.makeRotationAxis(l,t))}o[e].crossVectors(n[e],s[e])}if(!0===i){let e=Math.acos(THREE.MathUtils.clamp(s[0].dot(s[t]),-1,1));e/=t,n[0].dot(l.crossVectors(s[0],s[t]))>0&&(e=-e);for(let i=1;i<=t;i++)s[i].applyMatrix4(d.makeRotationAxis(n[i],e*i)),o[i].crossVectors(n[i],s[i])}return{tangents:n,normals:s,binormals:o}}(e,t,n);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector2;let h=new THREE.Vector3;const c=[],u=[],p=[],m=[];function f(t){h=e.getPointAt(a[t],h);const n=s.normals[t],d=s.binormals[t];for(let e=0;e<=r;e++){const t=e/r*Math.PI*2,a=Math.sin(t),s=-Math.cos(t);l.x=s*n.x+a*d.x,l.y=s*n.y+a*d.y,l.z=s*n.z+a*d.z,l.normalize(),u.push(l.x,l.y,l.z),o.x=h.x+i*l.x,o.y=h.y+i*l.y,o.z=h.z+i*l.z,c.push(o.x,o.y,o.z)}}!function(){for(let e=0;e<t;e++)f(e);f(!1===n?t:0),function(){for(let e=0;e<=t;e++)for(let t=0;t<=r;t++)d.x=a[e],d.y=t/r,p.push(d.x,d.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=r;t++){const i=(r+1)*(e-1)+(t-1),n=(r+1)*e+(t-1),a=(r+1)*e+t,s=(r+1)*(e-1)+t;m.push(i,n,s),m.push(n,a,s)}}()}(),this.setIndex(m),this.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),this.setAttribute("normal",new THREE.Float32BufferAttribute(u,3)),this.setAttribute("uv",new THREE.Float32BufferAttribute(p,2))}toJSON(){const e=THREE.BufferGeometry.prototype.toJSON.call(this);return e.path=this.parameters.path.toJSON(),e}}r.TubeGeometry=e}(),r.Ground=class{constructor(e){e=r.Utils.defaultValue(e,{}),this._referencePlane=new THREE.Plane,this._elevation=r.Utils.defaultValue(e.elevation,0);const t=r.Utils.defaultValue(e.position,new THREE.Vector3(0,0,0));t.y=this._elevation,this._position=t,this._direction=r.Utils.defaultValue(e.direction,new THREE.Vector3(0,1,0)),this._referencePlane.setFromNormalAndCoplanarPoint(this._direction,this._position),this._scratchInsertPoint=null}get elevation(){return this._elevation}show(){}hide(){}remove(){this._referencePlane=null}update(){}setColor(){}setElevation(e){this._position.y=e,this._elevation=e,this._referencePlane.setFromNormalAndCoplanarPoint(this._direction,this._position)}getElevation(){return this._elevation}intersect(e){return this._scratchInsertPoint||(this._scratchInsertPoint=new THREE.Vector3),e.intersectPlane(this._referencePlane,this._scratchInsertPoint)}},function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.basic.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}class t extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="BlinkMeshStandardMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.standard.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.standard.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class i extends THREE.MeshPhongMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.phong.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.phong.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class n extends THREE.MeshLambertMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.lambert.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.lambert.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class a extends THREE.LineBasicMaterial{constructor(e){super(e),this.type="BlinkLineBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.basic.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}class s extends THREE.PointsMaterial{constructor(e){super(e),this.type="BlinkPointsMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.points.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.points.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.points.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}r.Blink=r.Blink||{},r.Blink.MeshBasicMaterial=e,r.Blink.MeshStandardMaterial=t,r.Blink.MeshPhongMaterial=i,r.Blink.MeshLambertMaterial=n,r.Blink.LineBasicMaterial=a,r.Blink.PointsMaterial=s,r.Blink.DefaultBlinkColor={color:(new THREE.Color).setHex(3330982),opacity:1},r.Blink.MaterialFactory={MeshBasicMaterial:function(e){return new r.Blink.MeshBasicMaterial(e)},MeshStandardMaterial:function(e){return new r.Blink.MeshStandardMaterial(e)},MeshPhongMaterial:function(e){return new r.Blink.MeshPhongMaterial(e)},MeshLambertMaterial:function(e){return new r.Blink.MeshLambertMaterial(e)},LineBasicMaterial:function(e){return new r.Blink.LineBasicMaterial(e)},PointsMaterial:function(e){return new r.Blink.PointsMaterial(e)}}}(),(()=>{var e=new THREE.Matrix4;class t extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.AXISGRIDMANAGER,{priority:20}),this.globalSpace=!0,this.materialMap={},this.meshUuidMap={},this.floorHeightMap={},this.gridLineColor="#333333",this.gridBubbleColor="#000000",this.bEnableHover=!0,this.mapAxisTypes={GRIDLINE:"GRIDLINE",GRIDBUBBLE:"GRIDBUBBLE"},this.translateMatrix=new THREE.Matrix4,this.bHasTranslation=!1,this.mapTranslateDelta={},this.mapLinkFloorId={},this.mapFileIdGridjson={},this.mapIntersectAxisLines={},this.modelTransformation=new THREE.Matrix4,this.isDepthTest=!0,this.isShowAxisWindowEdge=!1}getAxisGridState(){var e={},t=this.meshUuidMap,i=[];for(var r in t)if(t.hasOwnProperty(r)){var n=[];for(var a in t[r])if(t[r].hasOwnProperty(a)&&0!==Object.keys(t[r][a]).length){var s={};s.id=a,s.height=this.floorHeightMap[r][a].height,n.push(s)}i.push({fileId:r,floorInfos:n})}var o={};return e.hasOwnProperty("default")?o.fileInfos={fileId:"",floorInfos:e.default}:o.fileInfos=i,o.gridLineColor=this.gridLineColor,o.gridBubbleColor=this.gridBubbleColor,o}addMeshUuidInMap(e,t,i,r){var n=this.meshUuidMap;n.hasOwnProperty(e)||(n[e]={}),n[e].hasOwnProperty(t)||(n[e][t]={}),n[e][t].hasOwnProperty(i)||(n[e][t][i]={}),n[e][t][i][r]=!0}addFloorHeightInMap(e,t,i){var r=this.floorHeightMap;r.hasOwnProperty(e)||(r[e]={}),r[e].hasOwnProperty(t)||(r[e][t]={});var n=e+"_"+t;r[e][t]={height:i,translation:this.mapTranslateDelta[n]}}removeFloorHeightInMap(e,t){var i=this.floorHeightMap;i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)&&delete i[e][t]}addLinesNode(e,t,i,n,a,s){var o=new THREE.BufferGeometry;o.setAttribute("position",new THREE.Float32BufferAttribute(e,3));var l=new THREE.Line(o,t);l.renderOrder=r.EnumRenderOrder.Effect,l.name=s,this.add(l),this.addMeshUuidInMap(i,n,a,l.uuid),this.updateMatrixWorld(!0)}getLabelCanvas(e,t="#000000"){const i=document.createElement("canvas"),n=i.getContext("2d"),a='16px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';n.font=a;const s=n.measureText(e),{width:o,actualBoundingBoxAscent:l}=s,d=Math.max(r.MaterialUtil.nextHighestPowerOfTwo(o),r.MaterialUtil.nextHighestPowerOfTwo(l));return i.width=d,i.height=d,n.font=a,n.fillStyle=t,n.fillText(e,(d-o)/2,(d+l)/2),{canvas:i,size:d}}addLabelNodes(e,t,i,n,a){const{canvas:s,size:o}=this.getLabelCanvas(e.name,"string"==typeof this.gridBubbleColor?this.gridBubbleColor:`rgba(${this.gridBubbleColor.red}, ${this.gridBubbleColor.green}, ${this.gridBubbleColor.blue}, ${this.gridBubbleColor.alpha})`),l=new THREE.CanvasTexture(s);this.savePointInfo(e,t,i,n,a),e.label.positions.forEach((s=>{const d={...s,z:a||0},h=this.translate(t,i,d),c=new r.PointsMaterial({sizeAttribute:!0,map:l,depthTest:this.isDepthTest,alphaTest:.001,transparent:!0}),u=new Float32Array(3),p=new Float32Array(1),m=new Uint8Array(1);h.toArray(u,0),p[0]=o,m[0]=0;const f=new THREE.BufferGeometry;f.setAttribute("position",new THREE.BufferAttribute(u,3)),f.setAttribute("attrSize",new THREE.BufferAttribute(p,1)),f.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(m,1));const g=new r.PointsEx(f,c);g.name=`${this.mapAxisTypes.GRIDBUBBLE}_${e.name}`,this.add(g),g.matrixAutoUpdate=!1,g.updateMatrixWorld(!0),this.addMeshUuidInMap(t,i,n,g.uuid),this.updateMatrixWorld(!0)}))}savePointInfo(e,t,i,r,n){this.pointInfo||(this.pointInfo=[]),2==e.label.positions.length&&(this.pointInfo.push({name:e.name,fileId:t,floorId:i,gridIndex:r,points:[{...e.label.positions[0],z:n||0},{...e.label.positions[1],z:n||0}]}),this.computedIntersection(this.pointInfo[this.pointInfo.length-1]))}removePointInfo(e,t,i){if(this.pointInfo)for(let r=0;r<this.pointInfo.length;r++)this.pointInfo[r].fileId==e&&this.pointInfo[r].floorId==t&&this.pointInfo[r].gridIndex==i&&this.pointInfo.splice(r--,1)}computedIntersection(e){if(!this.isShowAxisWindowEdge)return;if(!this.viewer)return;let t=this.getClientPoints(),i=new THREE.Vector3(e.points[0].x,e.points[0].y,e.points[0].z).applyMatrix4(this.viewer.getModelManager().getModel(this.modelId).transformMatrix.clone()),r=new THREE.Vector3(e.points[1].x,e.points[1].y,e.points[1].z).applyMatrix4(this.viewer.getModelManager().getModel(this.modelId).transformMatrix.clone());for(let n in t){let a=new THREE.Line3(i,r),s=new THREE.Plane,o=this.viewer.canvasToWorld({x:t[n][0].x,y:t[n][0].y,z:1}),l=this.viewer.canvasToWorld({x:t[n][0].x,y:t[n][0].y,z:2}),d=this.viewer.canvasToWorld({x:t[n][1].x,y:t[n][1].y,z:1});s.setFromCoplanarPoints(new THREE.Vector3(o.x,o.y,o.z),new THREE.Vector3(l.x,l.y,l.z),new THREE.Vector3(d.x,d.y,d.z));let h=new THREE.Vector3;if(s.intersectLine(a,h),0!=h.x||0!=h.y||0!=h.z){let t=this.viewer.worldToCanvas(h);"top"==n?t.y+=10:"left"==n?t.x+=10:"right"==n?t.x-=10:"bottom"==n&&(t.y-=10);let i=this.viewer.canvasToWorld(t);i=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(this.viewer.getModelManager().getModel(this.modelId).transformMatrix.clone().invert()),this.addIntersectionNode(e.name,i,e.fileId,e.floorId)}}}addIntersectionNode(e,t,i,n,a){const{canvas:s,size:o}=this.getLabelCanvas(e,"string"==typeof this.gridBubbleColor?this.gridBubbleColor:`rgba(${this.gridBubbleColor.red}, ${this.gridBubbleColor.green}, ${this.gridBubbleColor.blue}, ${this.gridBubbleColor.alpha})`),l=new THREE.CanvasTexture(s),d=this.translate(i,n,t),h=new r.PointsMaterial({sizeAttribute:!0,map:l,depthTest:this.isDepthTest,alphaTest:.001,transparent:!0}),c=new Float32Array(3),u=new Float32Array(1),p=new Uint8Array(1);d.toArray(c,0),u[0]=o,p[0]=0;const m=new THREE.BufferGeometry;m.setAttribute("position",new THREE.BufferAttribute(c,3)),m.setAttribute("attrSize",new THREE.BufferAttribute(u,1)),m.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(p,1));const f=new r.PointsEx(m,h);f.name=`${this.mapAxisTypes.GRIDBUBBLE}_${e}`,this.add(f),f.matrixAutoUpdate=!1,f.updateMatrixWorld(!0),this.intersectionNodesArr||(this.intersectionNodesArr=[]),this.intersectionNodesArr.push(f.uuid),this.updateMatrixWorld(!0)}removeIntersectionNodes(){var e=this.children;this.intersectionNodesArr&&this.intersectionNodesArr.map((t=>{for(var i=0;i<e.length;){e[i].uuid==t?e.splice(i,1):i++}})),this.intersectionNodesArr=[]}redrawIntersectionAxis(){this.pointInfo&&(this.removeIntersectionNodes(),this.pointInfo.map((e=>{this.computedIntersection(e)})),this.viewer.render())}createMaterial(e,t){return this.materialMap.hasOwnProperty(e)||(this.materialMap[e]={}),this.materialMap[e][t.color]||("string"!=typeof t.color&&(t.color="#"+t.color.getHEX()),this.materialMap[e][t.color]=r.MaterialUtil.createStandardMaterial(t),this.materialMap[e][t.color].setDisableHemiLight(!0),this.materialMap[e][t.color].setUnLight(!0),this.materialMap[e][t.color].defines.USE_NO_SSAO=""),this.materialMap[e][t.color]}loadAxisGridsByHeight(e,i,r,n,a,s){var o=this;s&&(this.viewer=s);var l=new THREE.FileLoader;this.axisGridHeight=r,null!=r&&this.addFloorHeightInMap(i,n,r),l.load(e,(function(s){var l=t.adaptGridData(JSON.parse(s));o.gridsJson=l;var d=l.grids.length,h=d;if(d&&d>0){var c=i+"_"+n;o.mapFileIdGridjson[i]||(o.mapFileIdGridjson[i]=l);for(var u=0;u<d;u++){var p=o.mapLinkFloorId[c]||n;if(-1==p.toString().indexOf("_")){var m=l.grids[u].floors;if(null!=m&&-1==m.indexOf(p.toString())){o.floorHeightMap[i][n].hideAxisGridIndex||(o.floorHeightMap[i][n].hideAxisGridIndex=[]),o.floorHeightMap[i][n].hideAxisGridIndex.push(u),0==--h&&a&&a();continue}}o.loadAxisGrid(e,i,u,r,n,(function(){0==--h&&a&&a()}))}}else console.warn("There is no grid on this floor.")})),this.isAddListener||(this.addListener(),this.isAddListener=!0)}enableShowGridBubblesAlongWithAxis(e){this.isShowAxisWindowEdge=e,this.redrawIntersectionAxis()}getClientPoints(){if(!this.viewer)return{};let e=this.viewer.domElement,t=e.clientWidth,i=e.clientHeight;return{top:[{x:0,y:0},{x:t,y:0}],left:[{x:0,y:0},{x:0,y:i}],right:[{x:t,y:0},{x:t,y:i}],bottom:[{x:0,y:i},{x:t,y:i}]}}addListener(){let e=this;this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED,(function(){e.debounceAndThrottlefun()}))}debounceAndThrottlefun(){let e=this;e.removeIntersectionNodes(),e.timer2||(e.timer2=setTimeout((()=>{e.redrawIntersectionAxis(),e.timer2=null}),300)),e.timer1&&(clearTimeout(e.timer1),e.timer1=null),e.timer1=setTimeout((()=>{clearTimeout(e.timer2),e.timer2=null,e.redrawIntersectionAxis()}),200)}unloadAxisGridsByFloor(e,t){var i=this.children,r=this.meshUuidMap;if(r.hasOwnProperty(e)&&r[e].hasOwnProperty(t)){for(var n in r[e][t]){for(var a=r[e][t][n],s=0;s<i.length;){a[i[s].uuid]?i.splice(s,1):s++}delete r[e][t][n],this.removePointInfo(e,t,n)}this.removeFloorHeightInMap(e,t)}this.redrawIntersectionAxis()}loadAxisGrid(e,i,r,n,a,s){var o=e.split("/");null==n&&(a=o[o.length-1].split(".")[0]);var l=0,d=this.gridsJson;if(r&&r>=0){if(!(r<d.grids.length))return void console.log("Input grid index is invalid.");l=r}const{color:h}=d.grids[l],c=d.grids[l].geometry,u=h||this.gridLineColor,p=this.mapAxisTypes.GRIDLINE,m=this.createMaterial(p,{color:u,side:THREE.DoubleSide,depthTest:this.isDepthTest}),f=[];c.forEach((e=>{if("Line"===e.lineType)f.push(e.startPoint,e.endPoint);else if("Arc"===e.lineType){const i=t.getArcGridPoints(e);f.push(...i)}e.linePoints=f}));const g=this.prepareLinesBuffer(i,a,f,n);this.addLinesNode(g,m,i,a,l,p),this.addLabelNodes(d.grids[l],i,a,l,n),s&&s()}prepareLinesBuffer(e,t,i,r){const n=[];return i.forEach((i=>{const a={...i};a.z=r||0;const s=this.translate(e,t,a);n.push(...Object.values(s))})),n}unloadAxisGrid(e,t,i){var r=this.children,n=this.meshUuidMap;if(n.hasOwnProperty(e)&&n[e].hasOwnProperty(t)&&n[e][t].hasOwnProperty(i)){for(var a=n[e][t][i],s=0;s<r.length;){a[r[s].uuid]?r.splice(s,1):s++}delete n[e][t][i]}}unloadAllAxisGrids(){var e=this.meshUuidMap;for(var t in e)if(e.hasOwnProperty(t))for(var i in e[t])if(e[t].hasOwnProperty(i)){for(var r in e[t][i])e[t][i].hasOwnProperty(r)&&(this.unloadAxisGrid(t,i,r),this.removePointInfo(t,i,r));this.removeFloorHeightInMap(t,i)}this.redrawIntersectionAxis()}enableDepthTest(e){this.isDepthTest=e;for(var t=this.children,i=0;i<t.length;i++)t[i].material.depthTest=e}formatHidedAxisGridIndex(e,t,i){e||(e="default");let r=this.floorHeightMap[e]={},n=0;for(const e of t.grids){let t=e.floors;for(const e of i){0==r.hasOwnProperty(e)&&(r[e]={});let i=r[e];-1==t.indexOf(e)&&(0==i.hasOwnProperty("hideAxisGridIndex")&&(i.hideAxisGridIndex=[]),i.hideAxisGridIndex.push(n))}n++}}getHidedAxisGridIndex(e,t){e||(e="default");let i=this.floorHeightMap[e][t];return i.hasOwnProperty("hideAxisGridIndex")?i.hideAxisGridIndex:[]}prepareGridLines(e,t,i){if(e){null==t&&(t=[0,0,0]),this.verticalLines=[],this.horizontalLines=[];var r=e.grids;for(let e=0;e<r.length;e++){if(i&&i.indexOf(e)>=0)continue;let a=r[e].geometry[0];if("Line"!==a.lineType)continue;var n=[0,0,0,0,0,0];n.name=r[e].name;const s=new THREE.Vector3(a.startPoint.x+t[0],a.startPoint.y+t[1],0),o=new THREE.Vector3(a.endPoint.x+t[0],a.endPoint.y+t[1],0);n[0]=s.x,n[1]=s.y,n[3]=o.x,n[4]=o.y,Math.abs(a.startPoint.x-a.endPoint.x)<Math.abs(a.startPoint.y-a.endPoint.y)?this.horizontalLines.push(n):this.verticalLines.push(n)}}}getNearestIntersection(e,t){let i={dist:Number.MAX_SAFE_INTEGER,intersect:null};e=new THREE.Vector3(e.x,e.y,e.z);for(const r of this.intersections){let n=r.clone().applyMatrix4(this.modelTransformation);n.z=t;let a=n.distanceTo(e);a<i.dist&&(i.dist=a,i.intersect=r)}return i}getIntersectLines(e){return this.mapIntersectAxisLines[e]}destroy(){this.mapIntersectAxisLines=null,this.horizontalLines=null,this.verticalLines=null,this.intersections=null,this.floorHeightMap=null,this.mapTranslateDelta=null,this.mapLinkFloorId=null,this.mapFileIdGridjson=null}calculateIntersections(e){var t,i,r,n;null==e&&(e=[0,0,0]),this.intersections=[];var a=this.horizontalLines.length,s=this.verticalLines.length;for(let l=0;l<a;l++){const a=this.horizontalLines[l];a[0]+=e[0],a[1]+=e[1],a[3]+=e[0],a[4]+=e[1],t=new THREE.Vector2(a[0],a[1]),i=new THREE.Vector2(a[3],a[4]);for(let l=0;l<s;l++){const s=this.verticalLines[l];s[0]+=e[0],s[1]+=e[1],s[3]+=e[0],s[4]+=e[1],r=new THREE.Vector2(s[0],s[1]),n=new THREE.Vector2(s[3],s[4]);const d=this.computeSegmentsIntersect(t,i,r,n);if(d){var o=new THREE.Vector3(d.x,d.y,this.axisGridHeight);o.name=a.name+s.name,this.mapIntersectAxisLines.hasOwnProperty(o.name)||(this.mapIntersectAxisLines[o.name]=[]),this.mapIntersectAxisLines[o.name].push(a),this.mapIntersectAxisLines[o.name].push(s),this.intersections.push(o)}}}}getAxisGridHeight(){return this.axisGridHeight}getAxisGridPlane(e){var t=new THREE.Plane;return t.setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,e)),t}getAxisGridPlanes(){var e=[],t=this.floorHeightMap;for(var i in t)if(t.hasOwnProperty(i))for(var r in t[i])if(t[i].hasOwnProperty(r)){var n=Number(t[i][r].height),a=t[i][r].translation||[0,0,0];e.push(this.getAxisGridPlane(n+a[2]))}return e}snapOnFloors(e){var t=this.floorHeightMap,i=this.mapFileIdGridjson;if(0==Object.keys(i).length)return[];var r=0,n=[];for(var a in t)if(t.hasOwnProperty(a))for(var s in t[a])if(t[a].hasOwnProperty(s))if(null!=e[r]){var o=t[a][s].height,l=t[a][s].translation||[0,0,0];this.axisGridHeight=o+l[2];var d=t[a][s].hasOwnProperty("hideAxisGridIndex")?t[a][s].hideAxisGridIndex:null;this.prepareGridLines(i[a],l,d),n.push(this.snaping(e[r++],l))}else r++;return n}snaping(e,t){this.calculateIntersections(t);var i={toIntersection:1/0,toGridLine:1/0},r={toIntersection:new THREE.Vector3,toGridLine:new THREE.Vector3};for(let t=0;t<this.intersections.length;t++){let a=this.intersections[t].clone();a.name=this.intersections[t].name,a.applyMatrix4(this.modelTransformation);var n=a.distanceTo(e);n<i.toIntersection&&(i.toIntersection=n,r.toIntersection=a)}var a=null,s=0;const o=t=>{const n=new THREE.Line3(new THREE.Vector3(t[0],t[1],this.axisGridHeight),new THREE.Vector3(t[3],t[4],this.axisGridHeight));n.applyMatrix4(this.modelTransformation);const o=new THREE.Vector3;n.closestPointToPoint(e,!0,o),(s=new THREE.Line3(e,o).distance())<i.toGridLine&&(i.toGridLine=s,a=t,r.toGridLine=o)};for(let e=0;e<this.horizontalLines.length;e++){o(this.horizontalLines[e])}for(let e=0;e<this.verticalLines.length;e++){o(this.verticalLines[e])}var l={};return l.intersectLines=this.mapIntersectAxisLines[r.toIntersection.name],l.gridLine=a,{point:e,height:this.axisGridHeight,snapLines:l,nearestPoint:r,minDistance:i}}setGridBubblesColor(e){this.gridBubbleColor=e;for(var t=this.children,i=0;i<t.length;i++)if(t[i].name.indexOf(this.mapAxisTypes.GRIDBUBBLE)>=0){const r=t[i].name.slice(t[i].name.lastIndexOf("_")+1),{canvas:n}=this.getLabelCanvas(r,`rgba(${e.red}, ${e.green}, ${e.blue}, ${e.alpha})`),a=new THREE.CanvasTexture(n);t[i].material.map&&t[i].material.map.dispose(),t[i].material.map=a}}getGridBubblesColor(){return this.gridBubbleColor}setGridLinesColor(e){this.gridLineColor=e;for(var t=this.children,i=0;i<t.length;i++)t[i].name==this.mapAxisTypes.GRIDLINE&&(t[i].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[i].material.alpha=e.alpha)}getGridLinesColor(){return this.gridLineColor}getElements(){return this.children}setIsEnableHover(e){this.bEnableHover=e}getIsEnableHover(){return this.bEnableHover}setTranslation(e,t,i,r,n){var a=e+"_"+t;this.mapTranslateDelta[a]=[i,r,n]}translate(e,t,i){var r=e+"_"+t,n=this.mapTranslateDelta[r],a=new THREE.Vector3(i.x,i.y,i.z);return n&&(this.translateMatrix.makeTranslation(n[0],n[1],n[2]),a.applyMatrix4(this.translateMatrix)),a}setLinkFloorId(e,t,i){var r=e+"_"+t;this.mapLinkFloorId[r]=i}getIntersectPoints(t,i){var r=[];e.copy(i).invert();var n=this.getAxisGridPlanes();for(const a of n){const n=this.modelTransformation.clone();a.applyMatrix4(n).applyMatrix4(i);let s=new THREE.Vector3;t.ray.intersectPlane(a,s),s&&s.applyMatrix4(e),r.push(s)}return r}getAxisGridsIntersection(e,t,i){i||"[object Array]"!==Object.prototype.toString.call(t)||(i=t,t=e,e="default");var r=this.computeIntersection(e,i),n=this.floorHeightMap[e][t].height,a={};for(var s in r)for(var o=r[s],l=0;l<o.intersects.length;l++){var d=o.intersects[l];d.intersectPoint.z=n;var h={intersection:d.intersectPoint,axisGrids:d.axisGrids};a[d.name]=h}return Object.values(a)}computeIntersection(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default"),t=t.map((e=>e.toString()));for(var i=this.mapFileIdGridjson[e].grids.filter((e=>t.indexOf(e.name)>=0)),r={},n=0;n<i.length-1;n++){var a,s=i[n];r[s.name]?a=r[s.name].lineSegments:(a=this.getGridLineSegments(s),r[s.name]={lineSegments:a,intersects:[]});for(var o=n+1;o<i.length;o++){var l,d=i[o];r[d.name]?l=r[d.name].lineSegments:(l=this.getGridLineSegments(d),r[d.name]={lineSegments:l,intersects:[]});for(var h=0,c=0;c<a.length;c++)for(var u=a[c],p=0;p<l.length;p++){var m=l[p],f=this.computeSegmentsIntersect(u[0],u[1],m[0],m[1]);f&&(f.applyMatrix4(this.modelTransformation),r[s.name].intersects.push({name:`${s.name}_${d.name}_${h}`,axisGrids:[s.name,d.name],intersectPoint:f,segmentNum:c}),r[d.name].intersects.push({name:`${s.name}_${d.name}_${h}`,axisGrids:[s.name,d.name],intersectPoint:f,segmentNum:p}),h++)}}}return r}getPartitionDataByAxisGrids(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var i=this.computeIntersection(e,t),r={},n=0;for(u in i){var a=i[u];a.intersects.sort(((e,t)=>{if(e.segmentNum!==t.segmentNum)return e.segmentNum-t.segmentNum;var i=a.lineSegments[e.segmentNum][0],r=e.intersectPoint,n=t.intersectPoint;return(r.x-i.x)*(r.x-i.x)+(r.y-i.y)*(r.y-i.y)-((n.x-i.x)*(n.x-i.x)+(n.y-i.y)*(n.y-i.y))}));for(var s=1;s<a.intersects.length;s++){if((f={origin:a.intersects[s].name,target:a.intersects[s-1].name,id:n++,linePoints:[a.intersects[s].intersectPoint]}).axis=u,a.intersects[s].segmentNum>a.intersects[s-1].segmentNum)for(var o=a.intersects[s].segmentNum;o>a.intersects[s-1].segmentNum;o--)f.linePoints.push(a.lineSegments[o][0]);else if(a.intersects[s].segmentNum<a.intersects[s-1].segmentNum)for(o=a.intersects[s].segmentNum;o<a.intersects[s-1].segmentNum;o++)f.linePoints.push(a.lineSegments[o][1]);f.linePoints.push(a.intersects[s-1].intersectPoint),r[a.intersects[s].name]||(r[a.intersects[s].name]={subLines:[],name:a.intersects[s].name}),r[a.intersects[s].name].subLines.push(f),r[a.intersects[s-1].name]||(r[a.intersects[s-1].name]={subLines:[],name:a.intersects[s-1].name});for(var l={origin:f.target,target:f.origin,id:f.id,axis:f.axis,linePoints:[]},d=f.linePoints.length-1;d>=0;d--)l.linePoints.push(f.linePoints[d]);r[a.intersects[s-1].name].subLines.push(l)}}var h=[],c=e=>{var t=e[e.length-1].subLine;if(!t.used){for(var i,n=t.linePoints,a=n[n.length-1],s=n[n.length-2],o=new THREE.Vector2(s.x-a.x,s.y-a.y),l=r[t.target],d=2*Math.PI,u=0;u<l.subLines.length;u++){var p=l.subLines[u];if(p.id!==t.id){var m=p.linePoints,f=m[0],g=m[1],v=new THREE.Vector2(g.x-f.x,g.y-f.y).angle()-o.angle();v<0&&(v+=2*Math.PI),v>=0&&v<d&&(d=v,i=p)}}if(i)if(e.push({intersect:l,subLine:i,angle:d}),i.target===e[0].subLine.target){var y=0;e.forEach((e=>{e.subLine.used=!0,y+=e.angle||0})),y-(e.length-1)*Math.PI<.001&&h.push(e)}else c(e)}};for(var u in r){var p=r[u],m=p.subLines;for(s=0;s<m.length;s++){var f=m[s];c([{intersect:p,subLine:f}])}}return h}getPartitionByAxisGrids(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var i,r=this.getPartitionDataByAxisGrids(e,t);if(1===r.length){var n=r[0].slice(1,r[0].length);(i=[]).push(n[0].subLine.linePoints[0]),n.forEach((e=>{var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);i=i.concat(t)}))}else if(r.length>1)for(var a=0;a<r.length;a++){var s=new Set,o=(n=r[a].slice(1,r[a].length),[]);if(o.push(n[0].subLine.linePoints[0]),n.forEach((e=>{s.add(e.subLine.axis);var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);o=o.concat(t)})),s.size===t.length){i=o;break}}return i}getGridLineSegments(e){const t=[];return e.geometry.forEach((e=>{if("Line"===e.lineType)t.push([e.startPoint,e.endPoint]);else if("Arc"===e.lineType)for(let i=0;i<e.linePoints.length-1;i++)t.push([e.linePoints[i],e.linePoints[i+1]])})),t}computeSegmentsIntersect(e,t,i,r){var n=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),a=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);if(n*a>0)return!1;var s=(i.x-e.x)*(r.y-e.y)-(i.y-e.y)*(r.x-e.x);if(s*((i.x-t.x)*(r.y-t.y)-(i.y-t.y)*(r.x-t.x))>0)return!1;var o=s/(a-n),l=o*(t.x-e.x),d=o*(t.y-e.y);let h=e.x+l,c=e.y+d;return new THREE.Vector3(h,c,0)}}t.getInstance=function(e,i){if(e.axisGridManagerMap||(e.axisGridManagerMap={},e.axisGridEnableHover=!0),!e.axisGridManagerMap[i]){e.axisGridManagerMap[i]=new r.AxisGridManager(e),e.axisGridManagerMap[i].modelId=i;const n=new r.ObjectGroup;n.name=r.ObjectGroupType.AXISGRIDMANAGER,n.add(e.axisGridManagerMap[i]),e.objectGroups.add(n),t.updateTransformation(e,i)}return e.axisGridManagerMap[i]},t.updateTransformation=function(e,t){if(!e.axisGridManagerMap)return;const i=e.axisGridManagerMap[t];if(!i)return;const[r]=e.objectGroups.children.filter((e=>e.name.includes(`|${t}`)));r?i.matrix.copy(r.matrix):i.matrix.copy(e.geometryGroup.matrix),i.matrixAutoUpdate=!1,i.updateMatrixWorld(!0);const n=e.getRawMatrixGlobal(),a=(new THREE.Matrix4).copy(n).invert();i.modelTransformation=i.matrix.clone().premultiply(a),i.debounceAndThrottlefun()},t.setEnableHover=function(e,t){e.axisGridManagerMap&&(e.axisGridEnableHover=t)},t.adaptGridData=e=>{let t={grids:[]};return 2!==e.version?e.grids.forEach((e=>{const i={id:e.id,name:e.name,floors:e.floors,geometry:[],label:{positions:[]},color:""};e.gridLines.forEach((e=>{"Circle"!==e.type?i.geometry.push(...e.lines.map((e=>({startPoint:{x:e[0],y:e[1]},endPoint:{x:e[3],y:e[4]},lineType:"Line"})))):i.label.positions.push({x:e.circleCenter[0],y:e.circleCenter[1]})})),t.grids.push(i)})):t={...e},t},t.getArcGridPoints=e=>{const{centerPoint:t,startAngle:i,endAngle:r,radius:n}=e;return new THREE.EllipseCurve(t.x,t.y,n,n,i,r,!1,0).getPoints(50)},t.destroy=function(e){e.axisGridManagerMap=null},r.AxisGridManager=t})();class G extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.CUSTOMPLANE,{priority:20}),this.globalSpace=!0}addPlane(e,t,i,n){var a=new THREE.Vector3;a.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),a.multiplyScalar(.5);var s=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(s,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(a),o.renderOrder=r.EnumRenderOrder.ClipPlane,this.add(o),o.updateMatrixWorld(!0);var l=new THREE.TextureLoader;l.setCrossOrigin("anonymous"),l.load(i,(function(e){o.material.map=e,o.material.needsUpdate=!0,n&&n(o)}))}removePlane(e){e&&this.remove(e)}showPlane(e){e&&(e.visible=!0)}hidePlane(e){e&&(e.visible=!1)}setPlaneOpacity(e,t){e&&(e.material.opacity=t)}}G.getInstance=function(e){return null==e.customPlaneManager&&(e.customPlaneManager=new r.CustomPlaneManager,e.objectGroups.add(e.customPlaneManager),e.customPlaneManager.matrix.copy(e.geometryGroup.matrix),e.customPlaneManager.matrixAutoUpdate=!1,e.customPlaneManager.updateMatrixWorld(!0)),e.customPlaneManager},G.destroy=function(e){e.customPlaneManager=null},r.CustomPlaneManager=G,r.Marker3D=class{constructor(e){this._viewer=e,this._scene=e.getScene(),this._group=null,this._isHidden=!1,this._markersGroup={},this._textures={},this._defaultSize=32,this._defaultColor=16777215,this._textureLoader=new THREE.TextureLoader,this._textureLoader.setCrossOrigin("anonymous"),this.visibleState={}}loadTextures(e){let t=0;const i=e.length;let n=()=>{++t,t>=i&&(this.update(),this._viewer.render())};for(let t=0;t<i;++t){const i=e[t];void 0===this._textures[i]?this._textures[i]=this._textureLoader.load(i,(e=>{e.image=r.MaterialUtil.ensureQuadrate(e.image),e.encoding=THREE.GammaEncoding,n()}),void 0,(()=>{n()})):n()}}unloadTextures(){for(const e in this._textures)this._textures.hasOwnProperty(e)&&delete this._textures[e]}add(e){let t=[];const i=e.length;if(e&&e instanceof Array){for(let r=0;r<i;++r){const i=e[r],n={id:i.id?i.id:THREE.Math.generateUUID(),position:{x:i.position.x,y:i.position.y,z:i.position.z},size:i.size?i.size:this._defaultSize,iconUrl:i.iconUrl?i.iconUrl:null,tooltip:i.tooltip,hoverAnimation:0==i.hoverAnimation?0:1};let a;n.iconUrl?(a=n.iconUrl,t.push(n.iconUrl)):a=""+this._defaultColor,void 0===this._markersGroup[a]&&(this._markersGroup[a]=[]),null==this.visibleState[n.id]&&(this.visibleState[n.id]=!0),this._markersGroup[a].push(n)}this.loadTextures(t)}}remove(e){if(!e)return;const t=e.iconUrl?e.iconUrl:""+this._defaultColor;if(void 0===this._markersGroup[t])return;let i=!1;const r=this._markersGroup[t];for(var n=0,a=r.length;n<a;++n)if(r[n].id===e.id){r.splice(n,1),i=!0;break}i&&this.update()}removeById(e){let t=!1;for(const i in this._markersGroup){if(!this._markersGroup.hasOwnProperty(i))continue;const r=this._markersGroup[i],n=r.length;for(let i=0;i<n;++i)if(r[i].id===e){r.splice(i,1),t=!0;break}}t&&this.update()}getItemById(e){for(const t in this._markersGroup){if(!this._markersGroup.hasOwnProperty(t))continue;const i=this._markersGroup[t],r=i.length;for(let t=0;t<r;++t){const r=i[t];if(r.id===e)return{id:r.id,position:{x:r.position.x,y:r.position.y,z:r.position.z},size:r.size,iconUrl:r.iconUrl,tooltip:r.tooltip,hoverAnimation:r.hoverAnimation}}}return null}getItems(){let e=[];for(const t in this._markersGroup){if(!this._markersGroup.hasOwnProperty(t))continue;const i=this._markersGroup[t],r=i.length;for(let t=0;t<r;++t){const r=i[t];e.push({id:r.id,position:{x:r.position.x,y:r.position.y,z:r.position.z},size:r.size,iconUrl:r.iconUrl,tooltip:r.tooltip,hoverAnimation:r.hoverAnimation})}}return e.length>0?e:null}clear(){this._group&&this._group.clear(),this.unloadTextures();for(const e in this._markersGroup)this._markersGroup.hasOwnProperty(e)&&delete this._markersGroup[e];this.update()}activate(){this.clear()}deactivate(){this.clear(),this._group&&(this._scene.removeObjectGroup(this._group),this._group=null)}show(){this._group&&(this._group.visible=!0),this._isHidden=!1;for(let e in this.visibleState)this.visibleState.hasOwnProperty(e)&&(this.visibleState[e]=!0);this.update()}showByIds(e){if(this._group&&(this._group.visible=!0),this._isHidden=!1,!(e&&e instanceof Array))return;const t=e.length;for(let i=0;i<t;i++)this.visibleState[e[i]]=!0;this.update()}hide(){this._group&&(this._group.visible=!1),this._isHidden=!0;for(const e in this.visibleState)this.visibleState.hasOwnProperty(e)&&(this.visibleState[e]=!1);this.update()}hideByIds(e){if(!(e&&e instanceof Array))return;const t=e.length;for(var i=0;i<t;i++)this.visibleState[e[i]]=!1;this.update()}load(e){this.clear(),this.add(e),this.update()}_createParticle(e,t,i){const n=this._textures[i];let a=[];for(let i=0;i<t;++i){const t=e[i];t.isHideByClustering||this.visibleState[t.id]&&a.push(i)}const s=a.length;let o=new Float32Array(3*s);const l=new Float32Array(s),d=new Uint8Array(s);let h=new THREE.Vector3,c=0,u=[],p=0;a.map((t=>{const i=e[t];h.set(i.position.x,i.position.y,i.position.z),h.toArray(o,3*p),l[p]=i.size,d[p]=i.hoverAnimation,u.push(i.id),c<i.size&&(c=i.size),p++}));let m=new THREE.BufferGeometry;m.setAttribute("position",new THREE.BufferAttribute(o,3)),m.setAttribute("attrSize",new THREE.BufferAttribute(l,1)),m.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(d,1));const f=new r.PointsMaterial({size:c,sizeAttenuation:!1,positionOffset:!0,sizeAttribute:!0,map:n,depthTest:!0,alphaTest:.001,transparent:!0});f.color.setHex(this._defaultColor);let g=new r.PointsEx(m,f);g.name=i,g.size=c,g.pointIds=u,1==r.GlobalData.IncrementRender?g.renderOrder=r.EnumRenderOrder.Effect:g.renderOrder=r.EnumRenderOrder.BeforeComponent,this._group.add(g),g.matrixAutoUpdate=!1,g.updateMatrixWorld(!0)}update(){if(!this._isHidden){this._group||(this._group=this._scene.getOrCreateObjectGroup(r.ObjectGroupType.MARKER3D,{pickableType:r.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),this._group.clear();for(const e in this._markersGroup){if(!this._markersGroup.hasOwnProperty(e))continue;const t=this._markersGroup[e],i=t.length;i<1||this._createParticle(t,i,e)}this._group.updateMatrixWorld(!0)}}},function(){class e extends r.Marker3D{constructor(e,t){super(e),this.shpPointId=t}update(){this._group||(this._group=this._scene.getOrCreateObjectGroup(`${r.ObjectGroupType.MARKER3D}|${this.shpPointId}`,{pickableType:r.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),super.update()}destroy(){this._group&&this._scene.removeObjectGroup(this._group),this._group=null,this._viewer=null,this._scene=null,this._markersGroup=null,this._textures=null,this._textureLoader=null,this.visibleState=null}}r.ShpPointMarker=e}(),r.LabelCollection=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.labelMap={}}destroy(){this.labelMap=null}addLabel(e){const t={id:e.id?e.id:THREE.Math.generateUUID(),position:{x:e.position.x,y:e.position.y,z:e.position.z},size:e.size?e.size:this.defaultFontSize,text:e.text?e.text:null,fontSize:e.fontSize?e.fontSize:24};if(null!=this.labelMap[t.id])return;this.labelMap[t.id]={},this.labelMap[t.id].info=t;let i=document.createElement("div");i.innerHTML=`<span style='font-size:${t.fontSize}px; color:black;pointer-events:none;'>${e.text}</br></span>`,i.style.display="none",i.style.position="absolute",i.style.pointerEvents="none",this.labelMap[t.id].visible=!0,this.labelMap[t.id].domLabel=i,this.viewer.domElement.parentNode.appendChild(i)}update(){var e=window.innerWidth,t=window.innerHeight;for(const i in this.labelMap){if(!1===this.labelMap[i].visible)continue;let r=this.labelMap[i].info.position;if(r=this.viewer.worldToClient(r),r.x<0||r.y<0||r.x>e||r.y>t)continue;let n=this.labelMap[i].domLabel;n.style.display="block",n.style.right="",n.style.left=r.x.toString()+"px",n.style.bottom="",n.style.top=r.y.toString()+"px"}}removeById(e){this.labelMap[e]&&this.labelMap[e].domLabel&&(this.viewer.domElement.parentNode.removeChild(this.labelMap[e].domLabel),delete this.labelMap[e])}showById(e){this.labelMap[e]&&(this.labelMap[e].visible=!0)}hideById(e){this.labelMap[e]&&(this.labelMap[e].visible=!1,this.labelMap[e].domLabel.style.display="none")}hideAll(){for(const e in this.labelMap)this.hideById(e)}},function(){new THREE.Vector3;r.ClipCapsManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.camera=e.camera,this.modelManager=e.modelManager;let t=e.getRenderer();this.size=new THREE.Vector2,t.getDrawingBufferSize(this.size),this.pixelRatio=t.getPixelRatio(),this.backSceneRenderTarget=new THREE.WebGLRenderTarget(this.size.x,this.size.y),this.target=new THREE.WebGLRenderTarget(128,128,{stencilBuffer:!0}),this.hatchByMaterialForBox=!1,this.hatchByMaterialForPlane=!1,this.capsScene=new r.Scene,this.capMeshPrepared=!1,this.addedCapPlane=null,this.addedCapBox=null,this.isReverse=!1}shouldRender(e){if(!r.GlobalData.CalculateClippingLine)return!0;let t=!0;const i=r.FillClipPlaneManager.getInstance(e),n=i&&i.isEnabled(),a=e.clipPlanes;let s=n?i:a;if(n)s.capsIntersectPosition.length>0&&(t=!1);else if(s)for(let e=0;e<s.capsIntersectPosition.length;++e)s.capsIntersectPosition[e].length>0&&(t=!1);return!t}render(e){if(0==r.GlobalData.ClippingCapsType||!r.GlobalData.ClippingCaps)return;let t=this.scene,i=this.camera,n=this.viewer;if(!this.shouldRender(t))return;const a=r.ExtrudeBodyManager.getInstance(n)._getAlphaTestNodeGroupVisible();r.ExtrudeBodyManager.getInstance(n)._setAlphaTestNodeGroupVisible(!1);var s=t.getObjectGroup(r.GlobalData.TilePlaneGroupName);s&&(s.preVisible=s.visible,s.visible=!1);const o=t.getObjectGroup(r.ObjectGroupType.CONTACTSHADOW);o&&(o.preVisible=o.visible,o.visible=!1),this._prepareCapScene(),this._renderBackSceneForCaps(e,t,i);let l=e.getClearAlpha();e.autoClear&&(e.clear(),e.setClearAlpha(0),e.autoClear=!1);const d=this.viewer.rendererManager.renderer.composer;d&&d.ssaoPass&&!0===d.ssaoPass.enabled&&e.clear(),t.fillClipPlane&&t.fillClipPlane.updateCamera(n);var h=e.getContext(),c=e.state;c.buffers.stencil.setTest(!0),c.buffers.stencil.setLocked(!0),c.buffers.stencil.setFunc(h.ALWAYS,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.INCR),t.overrideMaterial=t.backMaterial,t.backFrontStencil=!0,e.render(t,i),this._renderToTarget(e,t,i,!0),c.buffers.stencil.setFunc(h.ALWAYS,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.DECR),t.overrideMaterial=t.frontMaterial,e.render(t,i),this._renderToTarget(e,t,i),t.backFrontStencil=!1,c.buffers.stencil.setFunc(h.LEQUAL,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.KEEP),e.render(this.capsScene,i),this._renderToTarget(e,this.capsScene,i),c.buffers.stencil.setLocked(!1),c.buffers.stencil.setTest(!1),e.setClearAlpha(l),t.overrideMaterial=null,s&&(s.visible=s.preVisible),o&&(o.visible=o.preVisible),r.ExtrudeBodyManager.getInstance(n)._setAlphaTestNodeGroupVisible(a)}_renderBackSceneForCaps(e,t,i){if(!this.hatchByMaterialForBox&&!this.hatchByMaterialForPlane||0==r.GlobalData.ClippingCapsType)return;this._getBackScene();let n=e.getRenderTarget(),a=this.backSceneRenderTarget;e.setRenderTarget(a),e.clear(),e.render(this.backScene,i),e.setRenderTarget(n)}_renderToTarget(e,t,i,r){if(!this.viewer.editorManager.getToolByName("pickByMeasure"))return;let n=e.getRenderTarget(),a=this.target;e.setRenderTarget(a),r&&e.clear(),e.render(t,i),e.setRenderTarget(n)}_getBackScene(){if(this.backScene&&!this.modelManager.isFilterApplied())return;this.backScene||(this.backScene=new THREE.Scene,this.backScene.matrixAutoUpdate=!1),this.backScene.clear();let e=this.modelManager.modelCollection,t={},i=this;e.traverse((e=>{e.getMeshesForCap(t,"cap"),t[e.id]&&i.backScene.add(t[e.id])})),this.backScene.matrix.copy(this.scene.getRawMatrixGlobal()),this.backScene.updateMatrixWorld(!0)}setSize(e,t){let i=e*this.pixelRatio,r=t*this.pixelRatio;this.size.x==i&&this.size.y==r||(this.size.set(i,r),this.backSceneRenderTarget.setSize(i,r))}_prepareCapScene(){this.capMeshPrepared||(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox?this._initCapBox(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForBox):this._initCapPlane(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForPlane)),this._createCapStencilMaterials()}_createCapStencilMaterials(){this.scene.backMaterial||(this.scene.backMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.frontMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.backInstanceMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.backInstanceMaterial.defines.USE_INSTANCE="",this.scene.frontInstanceMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.frontInstanceMaterial.defines.USE_INSTANCE="")}resetClippingCapsStatus(e){this.capMeshPrepared=!1,r.GlobalData.ClippingCapsType=null==e?r.EnumClippingCapsTypes.None:e,null!==this.addedCapPlane&&(this.capsScene.remove(this.addedCapPlane.lineMesh),this.capsScene.remove(this.addedCapPlane.planeMesh),this.addedCapPlane=null),null!==this.addedCapBox&&(this.capsScene.remove(this.addedCapBox),this.addedCapBox=null),this.modelManager.forceUpdateGTAOPass(),this.scene.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}).clear()}_initCapPlane(){var e=r.FillClipPlaneManager.getInstance(this.scene).initCapsPlane(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForPlane);this.capsScene.add(e.lineMesh),this.capsScene.add(e.planeMesh),this.addedCapPlane=e,this.capMeshPrepared=!0}_initCapBox(){var e=r.ClipPlaneManager.getInstance(this.scene).initCapsBox(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForBox);this.capsScene.add(e),this.addedCapBox=e,this.capMeshPrepared=!0}dispose(){this.viewer=null,this.scene=null,this.camera=null,this.modelManager=null,this.backSceneRenderTarget=null,this.target=null,this.capsScene=null,this.addedCapPlane=null,this.addedCapBox=null}_updateMaterial(e){this.viewer.modelManager.modelCollection.traverse((t=>{t.updateMaterialsValue("useForCap",e)}))}enableHatchByMaterial(e,t){t?this.hatchByMaterialForBox=e:this.hatchByMaterialForPlane=e,t&&this.addedCapBox&&(e?(this.addedCapBox.children[0].visible=!1,this.addedCapBox.children[1].material.defines.USE_CAP=""):(this.addedCapBox.children[0].visible=!0,delete this.addedCapBox.children[1].material.defines.USE_CAP)),!t&&this.addedCapPlane&&(e?(this.addedCapPlane.lineMesh.visible=!1,this.addedCapPlane.planeMesh.material.defines.USE_CAP=""):(this.addedCapPlane.lineMesh.visible=!0,delete this.addedCapPlane.planeMesh.material.defines.USE_CAP))}enableHatch(e){if(r.GlobalData.ClippingCapsType!=e&&r.GlobalData.ClippingCapsType!=r.EnumClippingCapsTypes.ClipPlane){r.GlobalData.ClippingCapsType=e?r.EnumClippingCapsTypes.ClipBox:r.EnumClippingCapsTypes.None;var t=r.ClipPlaneManager.getInstance(this.scene);t.capsWireframe&&(t.capsWireframe.visible=e),e&&t.reCalculateClippingIds()}}changeDirection(e,t,i){let n=[],a=this.scene;a.backMaterial&&(n.push(a.backMaterial),n.push(a.frontMaterial),n.push(a.backInstanceMaterial),n.push(a.frontInstanceMaterial)),n.forEach((t=>{t.clippingPlanes=e,t.clipIntersection=i}));var s=a.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}).children;for(let e=0;e<s.length;e++)s[e].material.clippingPlanes=t;if(!this.addedCapBox||this.isReverse==i)return;let o=this.addedCapBox.children[0].children;for(let e=0;e<o.length;e++)i?o[e].material.defines.USE_OUTNORMAL="":delete o[e].material.defines.USE_OUTNORMAL;this.addedCapBox.children[1].material.side=i?THREE.BackSide:THREE.FrontSide,this.isReverse=i}}}(),function(){class e extends r.ObjectGroup{constructor(e,t){super(r.ObjectGroupType.CLIPREGION,{priority:20,globalSpace:!0}),this.planes=[],this.planeMaterial=new r.PhongLightingMaterial({color:2989714,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0,depthWrite:!1,unlight:!0}),this.wireFramesMaterial=new r.PhongLightingMaterial({color:2989714,lights:!0,unlight:!0}),this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array}},this.init(e,t)}clear(){super.clear(),this.planes.length=0,this.planes=null,this.planeMaterial.dispose(),this.wireFramesMaterial.dispose(),this.planeMaterial=null,this.wireFramesMaterial=null,this.uniforms=null}addSidePlaneMesh(e){let t=new THREE.BufferGeometry;const i=new THREE.BufferAttribute(e,3);t.setAttribute("position",i),t.setIndex([0,1,2,2,3,1]);const r=new THREE.Mesh(t,this.planeMaterial);this.add(r),this.addSideWireFrames(e)}addSideWireFrames(e){let t=new THREE.BufferGeometry;t.setIndex([0,1,0,2,2,3]),t.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),t.setAttribute("color",new THREE.Float32BufferAttribute([1,1,1,1,1,1,1,1,1,1,1,1],3)),t.computeBoundingSphere();var i=new THREE.LineSegments(t,this.wireFramesMaterial);i.name="WireFrames",i.customTag=!0,this.add(i)}addTopWireFrames(e){let t=[],i=[],r=[];e.map(((e,n)=>{t.push(e.x,e.y,e.z),i.push(1,1,1),r.push(n)}));let n=new THREE.BufferGeometry;n.setIndex(r),n.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),n.setAttribute("color",new THREE.Float32BufferAttribute(i,3)),n.computeBoundingSphere();var a=new THREE.LineSegments(n,this.wireFramesMaterial);a.name="WireFrames",a.customTag=!0,this.add(a)}addTopPlaneMesh(e){let t=new THREE.BufferGeometry,i=new THREE.Shape(e),r=new THREE.ShapeBufferGeometry(i);t.attributes=r.attributes;let n=r.attributes.position.array;const a=n.length;for(let t=2;t<a;t+=3)n[t]=e[0].z;t.groups=r.groups,t.index=r.index;const s=new THREE.Mesh(t,this.planeMaterial);this.add(s),this.addTopWireFrames(e)}init(e,t){this.planes=[];let i=[];const r=new THREE.Vector3(0,0,t),n=e.length,a=e[0].z;for(let t=0;t<n-1;++t){const s=e[t],o=e[t+1];s.z=a,o.z=a;const l=e[t].clone().add(r),d=e[t+1].clone().add(r),h=(new THREE.Plane).setFromCoplanarPoints(s,l,o);this.planes.push(h);const c=new Float32Array([s.x,s.y,s.z,o.x,o.y,o.z,l.x,l.y,l.z,d.x,d.y,d.z]);this.addSidePlaneMesh(c),i.push(l),t===n-2&&i.push(d)}this.addTopPlaneMesh(e),this.addTopPlaneMesh(i);const s=(new THREE.Plane).setFromCoplanarPoints(e[0],e[1],e[2]),o=(new THREE.Plane).setFromCoplanarPoints(i[0],i[2],i[1]);s.normal.z>0&&o.normal.z<0&&(s.negate(),o.negate()),this.planes.push(o),this.planes.push(s)}hide(){this.visible=!1}show(){this.visible=!0}}r.ClipRegion=e}(),r.ClipRegionManager=class{constructor(){this.isReverse=!1,this.isUpdate=!1,this.isUpdateOnce=!1,this.enableFilter=!1}static setUpdateOnce(){this.isUpdateOnce=!0}static setEnableFilter(e){this.enableFilter=e}static setClipRegion(e,t,i){let n=e.getScene();n.clipRegion&&n.removeObjectGroup(n.clipRegion),n.clipRegion=new r.ClipRegion(t,i);let a=n.clipRegion;const s=n.geometryGroup.matrix;a.matrix.copy(s),a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0),n.objectGroups.add(a);const o=a.planes.length;a.uniforms.iClipPlane.value=o;let l=a.uniforms.vClipPlane.value;a.planes.map(((e,t)=>{e.applyMatrix4(s);let i=new THREE.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant);l.push(i)})),this.isUpdate=!0,r.ClipPlanesTool.updateClippingRegionParams(e,a.uniforms,this.isReverse,!this.enableFilter),e.updateShadowMap()}static changeClipDirection(e,t,i){let n=e.getScene();n.clipRegion&&(this.isReverse=t,r.ClipPlanesTool.updateClippingRegionParams(e,n.clipRegion.uniforms,t,!this.enableFilter))}static exit(e){this.isUpdate=!1,this.isReverse=!1;let t=e.getScene();t.clipRegion&&(r.ClipPlanesTool.updateClippingRegionParams(e,{iClipPlane:{type:"i",value:0}},this.isReverse,!this.enableFilter),t.clipRegion.clear(),t.removeObjectGroup(t.clipRegion),t.clipRegion=null)}static hide(e){let t=e.getScene();t.clipRegion&&t.clipRegion.hide()}static show(e){let t=e.getScene();t.clipRegion&&t.clipRegion.show()}static update(e){if(this.isUpdateOnce){let t=e.getScene();t.clipRegion&&t.clipRegion.uniforms&&r.ClipPlanesTool.updateClippingRegionParams(e,t.clipRegion.uniforms,this.isReverse,!this.enableFilter)}else if(this.isUpdate){let t=e.getScene();t.clipRegion&&t.clipRegion.uniforms&&r.ClipPlanesTool.updateFilterMaterialsForClip(e,t.clipRegion.uniforms,this.isReverse)}this.isUpdateOnce=!1}},function(){let e=new THREE.Vector3,t=new THREE.Vector3,i=!1,n={};class a extends r.EditTool{constructor(e){super(r.EditToolMode.CLIP_BY_BOX);const t=this;this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.onClipBox=!1,this.isReverse=!1,this.mapLockedBoxFaces={},this.mapBoxFaceIndex={0:"Right",1:"Left",2:"Top",3:"Bottom",4:"Front",5:"Back"},this.clipPlanes=r.ClipPlaneManager.getInstance(this.scene),this.clipPlanes.updateClippingParams=t=>{a.updateClippingParams(e,t,this.isReverse),this.clipPlanes.calculateClipBoundingBox(),this.viewer.updateShadowMap()},this.clipPlanes.calculateClippingIds=(e,i)=>{if(!r.GlobalData.ClippingCaps)return;if(!r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox)return;const n=this.clipPlanes,a=n.uniforms.vClipPlane.value[n.selectIndex];n.renderClipPlane.setComponents(a.x,a.y,a.z,a.w),n.renderClipPlane.normalize(),n.capsIntersectPosition[n.selectIndex].length=0,n.capsIntersectPositionGroup[n.selectIndex].clear(),this.viewer.modelManager.calculateClippingIds(e,i),n.addToCapsWireframe(t.scene),this.viewer.setRenderStateChanged(!0)},this.clipPlanes.init(),this.clipPlanes.clipCapsManager=this.viewer.getClipCapsManager(),this.selectIndex=null,this.lastSelectIndex=null,this.planeDistance=0,this.offsetSpeed=.02,this._planIntersect=new THREE.Vector3,this.clipStartPoint=new THREE.Vector3,this.calculateClippingIdsWrapper=e=>{t.clipPlanes.reCalculateClippingIds()},this.viewer.registerEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.calculateClippingIdsWrapper)}toggle(e,t){this.clipPlanes.enable(e,t)}visible(e){this.clipPlanes.visible=e,!e&&this.cancelHighLight(),this.cameraControl.viewer.modelManager.forceUpdateGTAOPass()}rotatable(e){this.clipPlanes.rotatable=e}store(){return this.clipPlanes.store()}restore(e){this.clipPlanes.restore(e)}reset(){this.isReverse=!1,this.clipPlanes.reset()}changeDirection(e){this.isReverse=e,this.clipPlanes.update()}visibleCapsWireframe(e){this.clipPlanes.capsWireframe&&(this.clipPlanes.capsWireframe.visible=e)}pointToScreen(e){let t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);let r=new THREE.Vector4(e.x,e.y,e.z,1);r.applyMatrix4(i);let n=new THREE.Vector2;n.x=(r.x/r.w+1)/2,n.y=1-(r.y/r.w+1)/2;let a=this.cameraControl.getContainerDimensions();return n.x=n.x*a.width+a.left,n.y=n.y*a.height+a.top,n}getPlaneDistanceInScreen(){if(null==this.selectIndex)return null;if(this.selectIndex<2){let e=this.clipPlanes.center.clone(),t=this.clipPlanes.center.clone();e.x-=this.clipPlanes.cubeSize.x,t.x+=this.clipPlanes.cubeSize.x;const i=this.pointToScreen(e),r=this.pointToScreen(t);return i.x-r.x}{let e=this.clipPlanes.center.clone(),t=this.clipPlanes.center.clone();t.y-=this.clipPlanes.cubeSize.y,e.y+=this.clipPlanes.cubeSize.y;const i=this.pointToScreen(t),r=this.pointToScreen(e);return i.y-r.y}}getPickPoint(e,t){let i=this.cameraControl.camera,n=this.cameraControl.getContainerDimensions();const a=e-n.left,s=t-n.top,o=a/n.width*2-1,l=(n.height-s)/n.height*2-1;let d=new r.Raycaster;d.setFromCamera(new THREE.Vector2(o,l),i);return d.ray.intersectPlane(this.plane,this._planIntersect)}getSelectIndex(){return this.clipPlanes.selectIndex}getLastSelectIndex(){return this.lastSelectIndex}setLastSelectIndex(e){this.lastSelectIndex=e}_isVisible(){return this.clipPlanes.visible}isRotate(){return this.clipPlanes.rotatable}offset(e){const t=Math.floor(this.selectIndex/2);this.selectIndex<=3||this.selectIndex%2==1?this.clipPlanes.offset(this.selectIndex,-e*this.clipPlanes.cubeSize.getComponent(t)*2):this.clipPlanes.offset(this.selectIndex,e*this.clipPlanes.cubeSize.getComponent(t)*2)}setSectionBox(e,t){let i=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));i.applyMatrix4(this.scene.getRawMatrixGlobal()),this.clipPlanes.setSectionBox(i.min,i.max)}calculateOffsetByBox(i,r){let n=new THREE.Box3(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(r.x,r.y,r.z));n.applyMatrix4(this.scene.getRawMatrixGlobal()),n.getCenter(t),n.setFromCenterAndSize(t,n.getSize(e).multiplyScalar(this.scene.getExpandScalar())),this.clipPlanes.calculateOffsetByBox(n.min,n.max)}moveSectionPlane(e,t){this.clipPlanes.moveSectionPlane(e,t)}rotateSectionBox(e,t){this.clipPlanes.rotateSectionBox(e,t)}rotate(e,t){2==this.selectIndex||3==this.selectIndex?this.clipPlanes.rotX(t/180*Math.PI*.1):this.clipPlanes.rotY(e/180*Math.PI*.1)}update(e){this.clipPlanes.update(e)}cancelHighLight(){this.clipPlanes.cancelHighLight()}cancelHighLightByIndex(e){this.clipPlanes.cancelHighLightByIndex(e)}highLight(){this.clipPlanes.highLight()}lockBoxFaces(e){for(const t of e)this.mapLockedBoxFaces[t]=!0}unlockBox(){this.mapLockedBoxFaces={}}setProcess(e,t){this.mapLockedBoxFaces[e]||this.clipPlanes.setProcess(e,t)}getProcess(e){return this.clipPlanes.getProcess(e)}reCalculateClippingIds(e){this.clipPlanes.reCalculateClippingIds(e)}destroy(){this.cameraControl=null,this.intersectPoint=null,this.selectIndex=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null,this.lastSelectIndex=null}onExit(){this.toggle(!1,!1),this.viewer.unregisterEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.calculateClippingIdsWrapper)}processMouseDown(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){e.preventDefault();let t=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=r.ClipPlaneManager.getInstance(this.scene).hitTest(t),n=this.cameraControl.getIntersectContext(new THREE.Vector2(e.clientX,e.clientY)),a=this.cameraControl.intersector.intersect(n,null,!0);if(null!=a&&a.distance<=i.distance)return r.EditTool.prototype.processMouseDown(this,e);if(this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex){if(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){r.ClipPlaneManager.getInstance(this.scene).clearCapsWireframeForSelectIndex(),r.GlobalData.ClippingCaps=!1,this.visibleCapsWireframe(!1)}return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.enablePick=!0,this.clipStartPoint=t.ray.at(i.distance,this.clipStartPoint),!0}}return super.processMouseDown(e)}processHover(e){if(!this.enablePick){let t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY),n=r.ClipPlaneManager.getInstance(this.scene);const a=this.getLastSelectIndex();null!==a&&this.cancelHighLightByIndex(a);n.hitTest(i);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),this.setLastSelectIndex(this.selectIndex),!this.onClipBox){this.onClipBox=!0,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}t=!0}else if(this.onClipBox){this.onClipBox=!1,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}return this.selectIndex!==a&&(this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)),t}return super.processHover(e)}processMouseUp(e){if(e.button===THREE.MOUSE.LEFT){let t=this.cameraControl.viewer.modelManager,i=this.cameraControl.getRaycaster(e.clientX,e.clientY),n=r.ClipPlaneManager.getInstance(this.scene);if(null!==this.getSelectIndex()){if(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){let e=r.ClipPlaneManager.getInstance(this.scene);r.GlobalData.ClippingCaps=!0,e.calculateClippingIds(),this.visibleCapsWireframe(!0)}t.dispatchEvent({type:r.EVENTS.ON_CLIP_MOUSE_MOVE_END,onClipBox:!0}),this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)}n.hitTest(i);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex)this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipBox||(this.onClipBox=!0,t.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!0}));else if(this.onClipBox){this.onClipBox=!1,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}if(this.enablePick)return this.planeDistance=0,this.enablePick=!1,!0}return super.processMouseUp(e)}processMouseMove(e){if(this.enablePick){if(this.isRotate())this.rotate(e.clientX-this.startPt.x,e.clientY-this.startPt.y),this.startPt.set(e.clientX,e.clientY);else{const t=this.mapBoxFaceIndex[this.selectIndex];if(this.mapLockedBoxFaces[t])return!0;if(!(e.clientX==this.startPt.x&&e.clientY==this.startPt.y)){let t=r.ClipPlaneManager.getInstance(this.scene),i=t.clipplanes[this.selectIndex],n=this.cameraControl.movePlane(i,e,this.startPt,!0,this.clipStartPoint);null!=n&&t.offset(this.selectIndex,n),this.startPt.set(e.clientX,e.clientY)}this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_MOUSE_MOVE,draggedFaceName:t})}return this.cameraControl.setCameraChanging(!0),this.cameraControl.update(!0),!0}return super.processMouseMove(e)}processTouchstart(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.enablePick)return super.processTouchstart(e);{let t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);if(r.ClipPlaneManager.getInstance(this.scene).hitTest(t),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex)return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.update(),!0}}processTouchmove(e){if(null!=this.selectIndex){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{let t=0;t=this.selectIndex<2?e.touches[0].clientX-this.startPt.x:e.touches[0].clientY-this.startPt.y,this.offset(t/this.planeDistance),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),this.update(),!0}return super.processTouchmove(e)}processTouchend(e){return this.selectIndex=null,this.planeDistance=0,this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),this.update(),super.processTouchend(e)}static resetClippingRegionParams(e,t,n){const a=t.iClipPlane.value;if(0==a)return e.getRenderer().localClippingEnabled=!1,void(e.getRenderer().clippingPlanes=Object.freeze([]));let s=[],o=[];for(let e=0;e<a;++e){let e=new THREE.Plane;s.push(e)}for(let e=0;e<a;++e){const i=t.vClipPlane.value[e];let r=s[e];r.setComponents(-i.x,-i.y,-i.z,-i.w),r.normalize(),o.push(r.clone()),n&&r.negate()}let l=!1,d=e.modelManager,h=[],c=[],u=[],p=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)c.push(i[e]);else c.push(i)}};d.modelCollection.traverse((e=>{if(e instanceof r.ExtrudeBodyManager){e.getAllNodes().forEach((e=>{c.push(e.material)}))}else if(e instanceof r.ExternalComponentManager){e.getAllMeshes().forEach((e=>{if(void 0===e.material)return;const t=e.material.length;t&&t>0?e.material.forEach((e=>{c.push(e)})):c.push(e.material),e._materialHold&&c.push(e._materialHold)}))}else{e.materialManager&&(p(e.materialManager.materials),p(e.materialManager.instanceMaterials),e.materialManager instanceof r.BimTileMaterialManager&&(c.push(e.materialManager.globalMaterial),e.updateMaterialsValue("clippingPlanes",null,!1),e.updateMaterialsValue("clipIntersection",n,!1)),null!=e.wireframeManager&&(c.push(e.wireframeManager.wireframeMaterial),c.push(e.wireframeManager.instanceWireframeMaterial),c.push(e.wireframeManager.defaultWireframeColor))),e.getWireframeMaterial&&c.push(e.getWireframeMaterial());let t=null;e.getInstanceWireframeMaterial&&(t=e.getInstanceWireframeMaterial(),t&&(c.push(t),h.push(t)));let i=e.getFilter();if(i){const e=i.materialSelector.getAllTypeMaterial();if(c.push(...e),i._hasLocalClipping()){let e=i.getAllMaterialsForClip();for(let t in e)e[t].clippingPlanes=s,c.push(e[t]);let r=i.getAllInstanceMaterialsForClip();for(let e in r){let t=r[e];t.instanceMaterial&&(t.instanceMaterial.clippingPlanes=s,c.push(t))}t&&(t.clippingPlanes=s),l=!0}}}}));let m=e.rendererManager.getPickingEffecter();if(c.push(m.selectedMaterialForClip),c.push(m.wireframeMaterialForClip),c.push(m.instancedSelectedMaterialForClip),c.push(m.instancedWireFrameMaterialForClip),u.push(m.instancedWireFrameMaterial),u.push(m.selectedMaterial),u.push(m.wireframeMaterial),u.push(m.selectedLineMaterial),u.push(m.skinningSelectedMaterial),u.push(m.skinningWireframeMaterial),e.rendererManager.renderer.composer&&(e.rendererManager.renderer.composer.depthMaterial&&c.push(e.rendererManager.renderer.composer.depthMaterial),e.rendererManager.renderer.composer.InstancedDepthMaterial&&c.push(e.rendererManager.renderer.composer.InstancedDepthMaterial)),l||n?(e.getRenderer().localClippingEnabled=!0,e.getRenderer().clippingPlanes=Object.freeze([])):(e.getRenderer().localClippingEnabled=!1,e.getRenderer().clippingPlanes=s),i!=l){if(l){d.updateMaterialsValue("localClipping",1);for(let e=0;e<h.length;e++)h[e].localClipping=1,h[e].refreshUniforms()}else{d.updateMaterialsValue("localClipping",-1);for(let e=0;e<h.length;e++)h[e].localClipping=-1,h[e].refreshUniforms()}i=l}c.forEach((e=>{e.clippingPlanes=null,e.clipIntersection=n})),u.forEach((e=>{l?(e.clipIntersection=!1,e.clippingPlanes=null):n?(e.clipIntersection=!0,e.clippingPlanes=s):(e.clipIntersection=!1,e.clippingPlanes=null)})),e.clipCapsManager&&e.clipCapsManager.changeDirection(s,o,n)}static updateFilterMaterialsForClip(e,t,i){const n=t.iClipPlane.value;if(0==n)return e.getRenderer().localClippingEnabled=!1,void(e.getRenderer().clippingPlanes=Object.freeze([]));let a=[],s=[];for(let e=0;e<n;++e){let e=new THREE.Plane;a.push(e)}for(let e=0;e<n;++e){const r=t.vClipPlane.value[e];let n=a[e];s.push(n.clone()),n.setComponents(-r.x,-r.y,-r.z,-r.w),n.normalize(),i&&n.negate()}let o=e.modelManager,l=[];o.modelCollection.traverse((e=>{if(e instanceof r.ExtrudeBodyManager);else if(e instanceof r.ExternalComponentManager);else if(e instanceof r.ObliquePhotographyModel&&1==e.localClippingMode)e.objectGroup.children.forEach((e=>{e.children.forEach((e=>{e.children.forEach((e=>{e.material.forEach((e=>{e instanceof r.ObliquePhotographyMaterial&&(e.clipIntersection=i,e.clippingPlanes=a)}))}))}))}));else{let t=null;e.getInstanceWireframeMaterial&&(t=e.getInstanceWireframeMaterial());let i=e.getFilter();if(i&&i._hasLocalClipping()){let e=i.getAllMaterialsForClip();for(let t in e)e[t].clippingPlanes=a,l.push(e[t]);let r=i.getAllInstanceMaterialsForClip();for(let e in r){let t=r[e];t.instanceMaterial&&(t.instanceMaterial.clippingPlanes=a,l.push(t))}t&&(t.clippingPlanes=a,l.push(t))}}})),l.forEach((e=>{e.clippingPlanes=a,e.clipIntersection=i})),e.clipCapsManager&&e.clipCapsManager.changeDirection(a,s,i)}static updateClippingRegionParams(e,t,a,s){r.ClipPlanesTool.resetClippingRegionParams(e,t,a);const o=t.iClipPlane.value;if(0==o)return e.getRenderer().localClippingEnabled=!1,void(e.getRenderer().clippingPlanes=Object.freeze([]));let l=[],d=[];for(let e=0;e<o;++e){let e=new THREE.Plane;l.push(e)}for(let e=0;e<o;++e){const i=t.vClipPlane.value[e];let r=l[e];r.setComponents(-i.x,-i.y,-i.z,-i.w),r.normalize(),d.push(r.clone()),a&&r.negate()}let h=!1,c=e.modelManager,u=[],p=[],m=[],f=new Set,g=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)p.push(i[e]);else p.push(i)}},v=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)i[e].clipIntersection=!1,i[e].clippingPlanes=null;else i.clipIntersection=!1,i.clippingPlanes=null}};c.modelCollection.traverse((e=>{let t=e.getFilter();t&&t._hasLocalClipping()&&f.add(e)})),c.modelCollection.traverse((e=>{if(e instanceof r.ExtrudeBodyManager){e.getAllNodes().forEach((e=>{p.push(e.material)}))}else if(e instanceof r.ExternalComponentManager){e.getAllMeshes().forEach((e=>{if(void 0===e.material)return;const t=e.material.length;t&&t>0?e.material.forEach((e=>{p.push(e)})):p.push(e.material),e._materialHold&&p.push(e._materialHold)}))}else{if(e.materialManager&&f.size>0&&!f.has(e))return v(e.materialManager.materials),void v(e.materialManager.instanceMaterials);null==n[e.id]&&(n[e.id]=a),e.materialManager&&(n[e.id]!=a||a)&&s&&(g(e.materialManager.materials),g(e.materialManager.instanceMaterials),e.materialManager instanceof r.BimTileMaterialManager&&(p.push(e.materialManager.globalMaterial),e.updateMaterialsValue("clippingPlanes",l,!1),e.updateMaterialsValue("clipIntersection",a,!1)),null!=e.wireframeManager&&(p.push(e.wireframeManager.wireframeMaterial),p.push(e.wireframeManager.instanceWireframeMaterial),p.push(e.wireframeManager.defaultWireframeColor)),n[e.id]=a),e.getWireframeMaterial&&p.push(e.getWireframeMaterial());let t=null;e.getInstanceWireframeMaterial&&(t=e.getInstanceWireframeMaterial(),t&&(p.push(t),u.push(t)));let i=e.getFilter();if(i){const e=i.materialSelector.getAllTypeMaterial();if(p.push(...e),i._hasLocalClipping()){let e=i.getAllMaterialsForClip();for(let t in e)e[t].clippingPlanes=l,p.push(e[t]);let r=i.getAllInstanceMaterialsForClip();for(let e in r){let t=r[e];t.instanceMaterial&&(t.instanceMaterial.clippingPlanes=l,p.push(t))}t&&(t.clippingPlanes=l),h=!0}}}}));let y=e.rendererManager.getPickingEffecter();if(p.push(y.selectedMaterialForClip),p.push(y.wireframeMaterialForClip),p.push(y.instancedSelectedMaterialForClip),p.push(y.instancedWireFrameMaterialForClip),m.push(y.instancedWireFrameMaterial),m.push(y.selectedMaterial),m.push(y.wireframeMaterial),m.push(y.selectedLineMaterial),m.push(y.skinningSelectedMaterial),m.push(y.skinningWireframeMaterial),e.rendererManager.renderer.composer&&(e.rendererManager.renderer.composer.depthMaterial&&p.push(e.rendererManager.renderer.composer.depthMaterial),e.rendererManager.renderer.composer.InstancedDepthMaterial&&p.push(e.rendererManager.renderer.composer.InstancedDepthMaterial),e.rendererManager.renderer.composer.normalDepthMaterial&&p.push(e.rendererManager.renderer.composer.normalDepthMaterial),e.rendererManager.renderer.composer.instancedNormalDepthMaterial&&p.push(e.rendererManager.renderer.composer.instancedNormalDepthMaterial)),h||a?(e.getRenderer().localClippingEnabled=!0,e.getRenderer().clippingPlanes=Object.freeze([])):(e.getRenderer().localClippingEnabled=!1,e.getRenderer().clippingPlanes=l),i!=h){if(h){c.updateMaterialsValue("localClipping",1);for(let e=0;e<u.length;e++)u[e].localClipping=1,u[e].refreshUniforms()}else{c.updateMaterialsValue("localClipping",-1);for(let e=0;e<u.length;e++)u[e].localClipping=-1,u[e].refreshUniforms()}i=h}p.forEach((e=>{e.clippingPlanes=h||a?l:null,e.clipIntersection=a})),m.forEach((e=>{h?(e.clipIntersection=!1,e.clippingPlanes=null):a?(e.clipIntersection=!0,e.clippingPlanes=l):(e.clipIntersection=!1,e.clippingPlanes=null)})),e.clipCapsManager&&e.clipCapsManager.changeDirection(l,d,a)}static updateClippingParams(e,t,a){const s=t.iClipPlane.value;if(0==s)return e.getRenderer().localClippingEnabled=!1,void(e.getRenderer().clippingPlanes=Object.freeze([]));let o=[],l=[];for(let e=0;e<s;++e){let e=new THREE.Plane;o.push(e)}for(let e=0;e<s;++e){const i=t.vClipPlane.value[e];let r=o[e];r.setComponents(-i.x,-i.y,-i.z,-i.w),r.normalize(),l.push(r.clone()),a&&r.negate()}let d=!1,h=e.modelManager,c=[],u=[],p=[],m=new Set,f=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)u.push(i[e]);else u.push(i)}},g=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)i[e].clipIntersection=!1,i[e].clippingPlanes=null;else i.clipIntersection=!1,i.clippingPlanes=null}};h.modelCollection.traverse((e=>{let t=e.getFilter();t&&t._hasLocalClipping()&&m.add(e)})),h.modelCollection.traverse((e=>{if(e instanceof r.ExtrudeBodyManager){e.getAllNodes().forEach((e=>{u.push(e.material)}))}else if(e instanceof r.ExternalComponentManager){e.getAllMeshes().forEach((e=>{if(void 0===e.material)return;const t=e.material.length;t&&t>0?e.material.forEach((e=>{u.push(e)})):u.push(e.material),e._materialHold&&u.push(e._materialHold)}))}else{if(e.materialManager&&m.size>0&&!m.has(e))return g(e.materialManager.materials),void g(e.materialManager.instanceMaterials);if(null==n[e.id]&&(n[e.id]=a),e.materialManager&&(n[e.id]!=a||a)){if(f(e.materialManager.materials),f(e.materialManager.instanceMaterials),e.pickHelper){e.pickHelper.getMaterials().forEach((e=>{e.clippingPlanes=o,e.clipIntersection=a,e.setLocalClipping(!1),e.needsUpdate=!0}))}e.materialManager instanceof r.BimTileMaterialManager&&(u.push(e.materialManager.globalMaterial),e.updateMaterialsValue("clippingPlanes",o,!1),e.updateMaterialsValue("clipIntersection",a,!1)),null!=e.wireframeManager&&(u.push(e.wireframeManager.wireframeMaterial),u.push(e.wireframeManager.instanceWireframeMaterial),u.push(e.wireframeManager.defaultWireframeColor)),n[e.id]=a}e.getWireframeMaterial&&u.push(e.getWireframeMaterial());let t=null;e.getInstanceWireframeMaterial&&(t=e.getInstanceWireframeMaterial(),t&&(u.push(t),c.push(t)));let i=e.getFilter();if(i){const r=i.materialSelector.getAllTypeMaterial();if(u.push(...r),i._hasLocalClipping()){let r=i.getAllMaterialsForClip();for(let e in r)r[e].clippingPlanes=o,u.push(r[e]);let n=i.getAllInstanceMaterialsForClip();for(let e in n){let t=n[e];t.instanceMaterial&&(t.instanceMaterial.clippingPlanes=o,u.push(t))}if(t&&(t.clippingPlanes=o),e.pickHelper){e.pickHelper.getMaterials().forEach((e=>{e.clippingPlanes=o,e.clipIntersection=a,e.setLocalClipping(!0),e.needsUpdate=!0}))}d=!0}}}}));let v=e.rendererManager.getPickingEffecter();if(u.push(v.selectedMaterialForClip),u.push(v.wireframeMaterialForClip),u.push(v.instancedSelectedMaterialForClip),u.push(v.instancedWireFrameMaterialForClip),p.push(v.instancedWireFrameMaterial),p.push(v.selectedMaterial),p.push(v.wireframeMaterial),p.push(v.selectedLineMaterial),p.push(v.skinningSelectedMaterial),p.push(v.skinningWireframeMaterial),e.rendererManager.renderer.composer&&(e.rendererManager.renderer.composer.depthMaterial&&u.push(e.rendererManager.renderer.composer.depthMaterial),e.rendererManager.renderer.composer.InstancedDepthMaterial&&u.push(e.rendererManager.renderer.composer.InstancedDepthMaterial),e.rendererManager.renderer.composer.normalDepthMaterial&&u.push(e.rendererManager.renderer.composer.normalDepthMaterial),e.rendererManager.renderer.composer.instancedNormalDepthMaterial&&u.push(e.rendererManager.renderer.composer.instancedNormalDepthMaterial)),d||a?(e.getRenderer().localClippingEnabled=!0,e.getRenderer().clippingPlanes=Object.freeze([])):(e.getRenderer().localClippingEnabled=!1,e.getRenderer().clippingPlanes=o),i!=d){if(d){h.updateMaterialsValue("localClipping",1);for(let e=0;e<c.length;e++)c[e].localClipping=1,c[e].refreshUniforms()}else{h.updateMaterialsValue("localClipping",-1);for(let e=0;e<c.length;e++)c[e].localClipping=-1,c[e].refreshUniforms()}i=d}u.forEach((e=>{e.clippingPlanes=d||a?o:null,e.clipIntersection=a})),p.forEach((e=>{d?(e.clipIntersection=!1,e.clippingPlanes=null):a?(e.clipIntersection=!0,e.clippingPlanes=o):(e.clipIntersection=!1,e.clippingPlanes=null)})),e.clipCapsManager&&e.clipCapsManager.changeDirection(o,l,a)}}r.ClipPlanesTool=a}(),(()=>{var e=[new THREE.Plane],t=!1;let i=new THREE.Vector3;class n extends r.EditTool{constructor(n){super(r.EditToolMode.CLIP_FILL),this.viewer=n,this.scene=n.getScene(),this.enablePick=!1,this.rotX=!0,this.onClipPlane=!1,this.cameraControl=n.cameraControl,this.startPt=new THREE.Vector2,this.modelManager=this.cameraControl.viewer.modelManager,this.planeDistance=0,this.offsetSpeed=.02;var a=this;this._planIntersect=new THREE.Vector3,this.fillClipPlane=r.FillClipPlaneManager.getInstance(this.scene),this.fillClipPlane.updateClippingParams=function(s){if(0==s.iClipPlane.value)n.getRenderer().localClippingEnabled=!1,n.getRenderer().clippingPlanes=Object.freeze([]);else{var o=s.vClipPlane.value[0],l=e[0];l.setComponents(-o.x,-o.y,-o.z,-o.w),l.normalize();var d=!1,h=n.modelManager,c=[],u=[],p=[];h.modelCollection.traverse((t=>{var i,n;if(t.getInstanceWireframeMaterial&&(i=t.getInstanceWireframeMaterial())&&(c.push(i),u.push(i)),t.getWireframeMaterial&&(n=t.getWireframeMaterial())&&u.push(n),t.pickHelper){t.pickHelper.getMaterials().forEach((t=>{t.clippingPlanes=e,t.setLocalClipping(!1),t.needsUpdate=!0}))}if(t.localClippingMode)if(d=!0,t.localClippingPlanes=e,t.innerClippingMode=a.fillClipPlane.innerClipping?1:-1,!t.innerClippingMatrix&&(t.innerClippingMatrix=new THREE.Matrix4),t.innerClippingMatrix.copy(a.fillClipPlane.orthoViewProjMatrix),n&&(n.clippingPlanes=e,p.push(n)),i&&(i.clippingPlanes=e,p.push(i)),t instanceof r.Model){for(var s in t.materialManager.materials){(h=t.materialManager.materials[s]).clippingPlanes=e,p.push(h)}for(var s in t.materialManager.instanceMaterials){if((h=t.materialManager.instanceMaterials[s])instanceof Array)for(var o=0,l=h.length;o<l;o++)h[o].clippingPlanes=e,p.push(h[o]);else h.clippingPlanes=e,p.push(h)}}else if(t instanceof r.BimTilesModel)for(var s in t.materialManager.materialMap){var h;(h=t.materialManager.materialMap[s]).clippingPlanes=e,p.push(h)}var m=t.getFilter();if(m&&m._hasLocalClipping()){var f=m.getAllMaterialsForClip();for(var g in f)f[g].clippingPlanes=e,p.push(f[g]);var v=m.getAllInstanceMaterialsForClip();for(var g in v){var y=v[g];y.instanceMaterial&&(y.instanceMaterial.clippingPlanes=e,p.push(y.instanceMaterial))}if(i&&(i.clippingPlanes=e),t.pickHelper){t.pickHelper.getMaterials().forEach((t=>{t.clippingPlanes=e,t.setLocalClipping(!0),t.needsUpdate=!0}))}d=!0}}));var m=n.rendererManager.getPickingEffecter();if(m.selectedMaterialForClip.clippingPlanes=e,m.wireframeMaterialForClip.clippingPlanes=e,m.instancedSelectedMaterialForClip.clippingPlanes=e,m.instancedWireFrameMaterialForClip.clippingPlanes=e,n.getClipCapsManager()._prepareCapScene(),d){n.getRenderer().localClippingEnabled=!0,n.getRenderer().clippingPlanes=Object.freeze([]),a.scene.backMaterial.clippingPlanes=e,a.scene.frontMaterial.clippingPlanes=e,a.scene.backInstanceMaterial.clippingPlanes=e,a.scene.frontInstanceMaterial.clippingPlanes=e,p.push(m.selectedMaterialForClip),p.push(m.wireframeMaterialForClip),p.push(m.instancedSelectedMaterialForClip),p.push(m.instancedWireFrameMaterialForClip),p.push(a.scene.backMaterial),p.push(a.scene.frontMaterial),p.push(a.scene.backInstanceMaterial),p.push(a.scene.frontInstanceMaterial);for(var f=0;f<p.length;f++)p[f].orthoViewProjMatrix&&(p[f].orthoViewProjMatrix.copy(this.orthoViewProjMatrix),p[f].innerClipping=this.innerClipping?1:-1,p[f].refreshUniforms())}else{n.getRenderer().localClippingEnabled=!1,n.getRenderer().clippingPlanes=e,a.scene.backMaterial.clippingPlanes=Object.freeze([]),a.scene.frontMaterial.clippingPlanes=Object.freeze([]),a.scene.backInstanceMaterial.clippingPlanes=Object.freeze([]),a.scene.frontInstanceMaterial.clippingPlanes=Object.freeze([]),u.push(m.selectedMaterial),u.push(m.wireframeMaterial),u.push(m.instancedSelectedMaterial),u.push(m.instancedWireFrameMaterial),u.push(a.scene.backMaterial),u.push(a.scene.frontMaterial),u.push(a.scene.backInstanceMaterial),u.push(a.scene.frontInstanceMaterial),h.updateMaterialsValue("orthoViewProjMatrix",this.orthoViewProjMatrix),h.updateMaterialsValue("innerClipping",this.innerClipping?1:-1);for(f=0;f<u.length;f++)u[f].orthoViewProjMatrix&&(u[f].orthoViewProjMatrix.copy(this.orthoViewProjMatrix),u[f].innerClipping=this.innerClipping?1:-1,u[f].refreshUniforms())}if(t!=d){if(d){h.updateMaterialsValue("localClipping",1);for(f=0;f<c.length;f++)c[f].localClipping=1,c[f].refreshUniforms();h.updateMaterialsValue("innerClipping",-1);for(f=0;f<u.length;f++)u[f].innerClipping=-1,u[f].refreshUniforms()}else{h.updateMaterialsValue("localClipping",-1);for(f=0;f<c.length;f++)c[f].localClipping=-1,c[f].refreshUniforms();for(f=0;f<p.length;f++)p[f].innerClipping=-1,p[f].refreshUniforms()}t=d}this.renderClipPlane=new THREE.Plane,this.renderClipPlane.setComponents(o.x,o.y,o.z,o.w),this.renderClipPlane.normalize(),this.calculateFillClipBoundingBox(l.coplanarPoint(i)),n.updateShadowMap()}},this.fillClipPlane.calculateClippingIds=function(e,t){r.GlobalData.ClippingCaps&&(this.clearCapsWireframe(),n.modelManager.calculateClippingIds(e,t),this.addToCapsWireframe(a.scene),a.viewer.setRenderStateChanged(!0))},this.fillClipPlane.init(),this.fillClipPlane.clipCapsManager=this.viewer.getClipCapsManager(),this.calculateClippingIdsWrapper=e=>{a.fillClipPlane.calculateClippingIds()},this.viewer.registerEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.calculateClippingIdsWrapper)}toggle(e,t){this.fillClipPlane.enable(e,t),this.fillClipPlane.update(),this.viewer.updateShadowMap()}visible(e){this.fillClipPlane.visible=e,this.fillClipPlane.update()}rotatable(e){this.fillClipPlane.rotatable=e,this.fillClipPlane.update()}hit(){return this.fillClipPlane.hit}pointToScreen(e){var t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var r=new THREE.Vector4(e.x,e.y,e.z,1);r.applyMatrix4(i);var n=new THREE.Vector2;n.x=(r.x/r.w+1)/2,n.y=1-(r.y/r.w+1)/2;var a=this.cameraControl.getContainerDimensions();return n.x=n.x*a.width+a.left,n.y=n.y*a.height+a.top,n}getPlaneDistanceInScreen(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=clipPlanes.center.clone(),t=clipPlanes.center.clone();e.x-=clipPlanes.cubeSize.x,t.x+=clipPlanes.cubeSize.x;var i=this.pointToScreen(e),r=this.pointToScreen(t);return i.x-r.x}var n=clipPlanes.center.clone(),a=clipPlanes.center.clone();a.y-=clipPlanes.cubeSize.y,n.y+=clipPlanes.cubeSize.y;var s=this.pointToScreen(a),o=this.pointToScreen(n);return s.y-o.y}getPickPoint(e,t){var i=this.cameraControl.camera,n=this.cameraControl.getContainerDimensions(),a=e-n.left,s=t-n.top,o=a/n.width*2-1,l=(n.height-s)/n.height*2-1,d=new r.Raycaster;return d.setFromCamera(new THREE.Vector2(o,l),i),d.ray.intersectPlane(this.plane,this._planIntersect)}_isVisible(){return this.fillClipPlane.visible}isRotate(){return this.fillClipPlane.rotatable}offset(e){this.fillClipPlane.offset(e)}setOffset(e){this.fillClipPlane.setOffset(e)}rotate(e,t){this.rotX?this.fillClipPlane.rotX(t/180*Math.PI*.1):this.fillClipPlane.rotY(e/180*Math.PI*.1)}rotateAngleOffset(e,t){this.fillClipPlane.rotateAngleOffset(e,t)}setRotateAngle(e,t){this.fillClipPlane.setRotateAngle(e,t)}getRotateAngle(){return this.fillClipPlane.getRotateAngle()}changeNormal(e){this.fillClipPlane.changeNormal(e)}update(e){this.fillClipPlane.update(e)}cancelHighLight(){this.fillClipPlane.cancelHighLight()}highLight(){this.fillClipPlane.highLight()}store(){return this.fillClipPlane.store()}restore(e){this.viewer.clipCapsManager.enableHatchByMaterial(e.isHatchMaterial,!1),this.fillClipPlane.restore(e)}setProcess(e){this.fillClipPlane.setProcess(e)}getProcess(){return this.fillClipPlane.getProcess()}destroy(){this.cameraControl=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null}onExit(){this.toggle(!1,!1),this.viewer.unregisterEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,this.calculateClippingIdsWrapper)}processMouseDown(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY);if(r.FillClipPlaneManager.getInstance(this.scene).hitTest(t),this.hit())return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!1}return r.EditTool.prototype.processMouseDown(this,e)}processMouseUp(e){this.planeDistance=0;var t=!1;if(this.enablePick&&e.button===THREE.MOUSE.LEFT)if(this.startPt.x==e.clientX&&this.startPt.y==e.clientY)this.pickHelper.click(e);else if(e.shiftKey||e.ctrlKey||e.altKey){this.endPt.set(e.clientX,e.clientY);var i=r.OPSELECTIONTYPE.Clear;e.ctrlKey?i=r.OPSELECTIONTYPE.Add:e.altKey&&(i=r.OPSELECTIONTYPE.Remove);var n=this;this.scene.pickByRect(this.frustum,i,(function(){n.pickHelper.notifySelectionChanged(null,0,e)})),this.cameraControl.updateView(!0),t=!0}var a=this.cameraControl.getRaycaster(e.clientX,e.clientY);return r.FillClipPlaneManager.getInstance(this.scene).hitTest(a),this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane||(this.onClipPlane=!0,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane&&(this.onClipPlane=!1,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}))),this.modelManager.dispatchEvent({type:r.EVENTS.ON_TOOL_END}),t}processMouseMove(e){return this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_MOUSE_MOVE,event:e}),r.EditTool.prototype.processMouseMove(this,e)}processTouchstart(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),!this.enablePick){var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);r.FillClipPlaneManager.getInstance(this.scene).hitTest(t)}return r.EditTool.prototype.processTouchstart(this,e)}processTouchmove(e){}processTouchend(e){return this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),r.EditTool.prototype.processTouchmove(this,e)}processHover(e){if(!this.enablePick){var t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY);return r.FillClipPlaneManager.getInstance(this.scene).hitTest(i),this.hit()?(this.onClipPlane||(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!0,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):this.onClipPlane?(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!1,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e})):this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}),t}return r.EditTool.prototype.processHover(this,e)}}r.FillClipPlaneTool=n})(),(()=>{let e=[];e.push("clipPlane_right"),e.push("clipPlane_left"),e.push("clipPlane_top"),e.push("clipPlane_bottom"),e.push("clipPlane_front"),e.push("clipPlane_back");let t=new THREE.Quaternion,i=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1),s=new THREE.Matrix4;class o extends r.ObjectGroup{constructor(e,t){super(r.ObjectGroupType.CLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.center=t.clone(),this.visible=!1,this.rotatable=!1,this.selectIndex=null,this.planeOffset=new Array(6),this.planeRotate=[0,0,0],this.observer=null,this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array(new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4)}},this.clipplanes=null,this.calculation=!0,this.boundingBox=new THREE.Box3,this.planeMaterial=new r.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0,unlight:!0}),this.planeHighLightMatrial=new r.PhongLightingMaterial({color:2989714,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0,unlight:!0}),this.capsIntersectPosition=[[],[],[],[],[],[]],this.capsIntersectPositionGroup=[new Map,new Map,new Map,new Map,new Map,new Map],this.renderClipPlane=new THREE.Plane,this.renderOrder=r.EnumRenderOrder.ClipPlane,this.lastClipTime=new Array(6).fill(0)}calculateClipBoundingBox(e){this.boundingBox.setFromObject(this)}getClipBoundingBox(){return this.boundingBox}isVisible(){return this.visible}getPlaneNormal(e){var t=new THREE.Vector4,i=Math.floor(e/2),r=e%2;return t.setComponent(i,Math.pow(-1,r)),t.w=.5*-this.cubeSize.getComponent(i),this.planeOffset[e]=0,t}initPlaneModel(t){var i=Math.floor(t/2),n=t%2,a=0==i?this.cubeSize.z:this.cubeSize.x,s=1==i?this.cubeSize.z:this.cubeSize.y,o=new THREE.PlaneGeometry(a,s),l=new THREE.Mesh(o,this.planeMaterial);l.name=e[t],l.customTag=!0,l.position.setComponent(i,Math.pow(-1,n)*this.cubeSize.getComponent(i)*.5),0==i?l.rotation.y=Math.pow(-1,n)*Math.PI*.5:1==i&&(l.rotation.x=Math.pow(-1,n)*Math.PI*.5),l.renderOrder=r.EnumRenderOrder.ClipPlane,this.add(l)}initCapsBox(e,t,i){var n=new THREE.BoxBufferGeometry(this.cubeSize.x,this.cubeSize.y,this.cubeSize.z);n.groups=null;var a=new r.PhongLightingMaterial({color:10064980,side:THREE.DoubleSide,viewportSize:t,backSceneTexture:e,unlight:!0}),s=new THREE.Mesh(n,a);let o=this.cubeSize.x,l=this.cubeSize.y,d=this.cubeSize.z,h=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)];this.boxCap=new THREE.Group;let c=new THREE.Group;return c.add(this._getLine(l,d,.5*o,0,h[0])),c.add(this._getLine(l,d,.5*-o,1,h[1])),c.add(this._getLine(o,d,.5*l,2,h[2])),c.add(this._getLine(o,d,.5*-l,3,h[3])),c.add(this._getLine(o,l,.5*d,4,h[4])),c.add(this._getLine(o,l,.5*-d,5,h[5])),this.boxCap.add(c),i&&(a.defines.USE_CAP="",c.visible=!1),this.boxCap.add(s),this.boxCap.matrixWorld=this.matrixWorld,this.boxCap.matrix=this.matrix,this.boxCap.matrixAutoUpdate=!1,this.boxCap.updateMatrixWorld(!0),this.boxCap}_getLineMesh(e,t){var i=new THREE.LineMaterial({color:2236962,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),outNormal:t});i.uniforms.outNormal.value=t;var r=new THREE.LineSegmentsGeometry;return r.setPositions(e),new THREE.LineSegments2(r,i)}_getLine(e,t,i,r,n){let a=[];for(var s=.5*e,o=.5*t,l=5;l<e+t;l+=5){var d,h,c,u;l<t?(d=-s,h=-o+l):(d=-s+l-t,h=o),l<e?(c=-s+l,u=-o):(c=s,u=-o+l-e),r<2?(a.push(i,d,h),a.push(i,c,u)):r>3?(a.push(d,h,i),a.push(c,u,i)):(a.push(d,i,h),a.push(c,i,u))}return this._getLineMesh(a,n)}addToCapsWireframe(e){if(this.capsWireframe&&this.capsWireframe.children.length>0){let e=this.capsWireframe.children[this.selectIndex];e&&(e.geometry.setPositions(this.capsIntersectPosition[this.selectIndex]),e.geometry._maxInstanceCount=void 0)}else{for(var t=e.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}),i=0;i<6;i++){var n=new THREE.LineSegmentsGeometry;i==this.selectIndex&&n.setPositions(this.capsIntersectPosition[this.selectIndex]);let e=new THREE.LineSegments2(n,new THREE.LineMaterial({color:2236962,linewidth:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),clipping:!0,clippingTolerance:.001,side:THREE.DoubleSide}));t.add(e),e.updateMatrixWorld(!0)}this.capsWireframe=t}}clearCapsWireframeForSelectIndex(){this.capsWireframe&&this.capsWireframe.children&&this.capsWireframe.children[this.selectIndex]&&(this.capsWireframe.children[this.selectIndex].geometry.deleteAttribute("instanceStart"),this.capsWireframe.children[this.selectIndex].geometry.deleteAttribute("instanceEnd"))}clearCapsWireframe(){if(this.capsWireframe&&r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){var e=this.capsWireframe.children;for(let t=0;t<e.length;t++)e[t].geometry.deleteAttribute("instanceStart"),e[t].geometry.deleteAttribute("instanceEnd")}}reCalculateClippingIds(e,t){if(r.GlobalData.ClippingCapsType!=r.EnumClippingCapsTypes.ClipBox)return;let i=this.selectIndex;for(let i=0;i<6;i++)this.selectIndex=i,this.calculateClippingIds(e,t);this.selectIndex=i}initWireframes(){var e=[.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z],t=new THREE.BufferGeometry,i=new r.PhongLightingMaterial({color:2989714,lights:!0,unlight:!0});t.setIndex([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,3,7,1,5,2,6]),t.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),t.setAttribute("color",new THREE.Float32BufferAttribute([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],3)),t.computeBoundingSphere();var n=new THREE.LineSegments(t,i);n.name="Wireframes",n.customTag=!0,this.add(n)}updateClippingParams(e){}enable(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?6:0,this.updateClippingParams(this.uniforms)}isEnabled(){return 0!==this.uniforms.iClipPlane.value}store(){let e=r.GlobalData.ClippingCapsType>0;return new l(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.calculation,this.planeOffset,this.planeRotate,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.boundingBox.clone(),e,this.clipCapsManager&&this.clipCapsManager.hatchByMaterialForBox)}restore(e){this.calculation=!0,this.calculationPlanes(e.cubeSize,e.center),this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.calculation=e.calculation;for(var t=0;t<6;++t)this.planeOffset[t]=e.planeOffset[t];for(t=0;t<3;++t)this.planeRotate[t]=e.planeRotate[t];this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.update(),this.clipCapsManager.enableHatch(e.isHatchEnabled),this.clipCapsManager.enableHatchByMaterial(e.isHatchByMaterial,!0),this.reCalculateClippingIds()}reset(){this.calculation=!0;for(var e=0;e<6;++e)this.planeOffset[e]=0;for(e=0;e<3;++e)this.planeRotate[e]=0;this.position.copy(this.center),this.scale.copy(new THREE.Vector3(1,1,1)),this.quaternion.copy(new THREE.Quaternion),this.update(),this.clearCapsWireframe(),this.reCalculateClippingIds(!1,!0)}calculationPlanes(e,t){if(this.calculation){this.cubeSize.copy(e),this.center.copy(t);for(var i=this.children.length-1;i>=0;--i)this.remove(this.children[i]);for(i=0;i<6;++i)this.uniforms.vClipPlane.value[i]=this.getPlaneNormal(i),this.initPlaneModel(i);this.initWireframes(),this.clipplanes=this.uniforms.vClipPlane.value.slice(0),this.reset()}}update(){this.updateMatrixWorld(),this.boxCap&&(this.boxCap.matrixWorld=this.matrixWorld,this.boxCap.matrix=this.matrix,this.boxCap.updateMatrixWorld(!0)),s.copy(this.matrix).invert(),s.transpose();for(var e=0;e<6;++e)this.uniforms.vClipPlane.value[e]=this.clipplanes[e].clone().applyMatrix4(s);this.updateClippingParams(this.uniforms),this.observer&&this.observer()}offset(e,t){this.calculation=!1;var i=Math.floor(e/2);this.cubeSize.getComponent(i);e%2==0&&this.planeOffset[e]+t>0&&(t=-this.planeOffset[e]),e%2==1&&this.planeOffset[e]+t<0&&(t=-this.planeOffset[e]),this.planeOffset[e]+=t;for(var r=new THREE.Vector3,n=0;n<6;++n){var a=this.clipplanes[n].clone(),s=this.planeOffset[n],o=new THREE.Vector3(a.x*s,a.y*s,a.z*s);r.add(o)}var l=1+r.getComponent(i)/this.cubeSize.getComponent(i);if((l=0==l?1e-5:l)>0){this.scale.setComponent(i,l);var d=this.uniforms.vClipPlane.value[e].clone(),h=new THREE.Vector3(d.x,d.y,d.z);h.normalize();o=t;var c=new THREE.Vector3(h.x*o,h.y*o,h.z*o);e%2==1?this.position.sub(c.multiplyScalar(.5)):this.position.add(c.multiplyScalar(.5)),this.update()}else this.planeOffset[e]-=t}rotX(e){this.calculation=!1,t.setFromAxisAngle(i,e),this.quaternion.multiply(t),this.update()}rotY(e){this.calculation=!1,t.setFromAxisAngle(n,e),this.quaternion.multiply(t),this.update()}setSectionBox(e,t){this.calculation=!0;var i=new THREE.Vector3(t.x-e.x,t.y-e.y,t.z-e.z),n=new THREE.Vector3(.5*(e.x+t.x),.5*(e.y+t.y),.5*(e.z+t.z));this.calculationPlanes(i,n),this.clipCapsManager.resetClippingCapsStatus(r.GlobalData.ClippingCapsType)}calculateOffsetByBox(e,t){var i=t.x-this.center.x-.5*this.cubeSize.x;i<this.planeOffset[0]?(this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x),this.moveSectionPlane("Right",i)):(this.moveSectionPlane("Right",i),this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x));var r=t.y-this.center.y-.5*this.cubeSize.y;r<this.planeOffset[2]?(this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y),this.moveSectionPlane("Top",r)):(this.moveSectionPlane("Top",r),this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y));var n=t.z-this.center.z-.5*this.cubeSize.z;n<this.planeOffset[4]?(this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z),this.moveSectionPlane("Front",n)):(this.moveSectionPlane("Front",n),this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z))}getPlaneIndexByName(e){var t=-1;return"Right"==e?t=0:"Left"==e?t=1:"Top"==e?t=2:"Bottom"==e?t=3:"Front"==e?t=4:"Back"==e&&(t=5),t}moveSectionPlane(e,t){var i=this.getPlaneIndexByName(e);if(-1!=i){i%2!=0&&(t=-t);var r=t-this.planeOffset[i];this.offset(i,r)}}setProcess(e,t){var i=this.getPlaneIndexByName(e),r=0;if(i<2?r=this.cubeSize.x:i<4?r=this.cubeSize.y:i<6&&(r=this.cubeSize.z),t>1?t=1:t<0&&(t=0),-1!=i){i%2==0&&(t=-t);var n=t*r-this.planeOffset[i];if(0==n)return;this.offset(i,n)}}getProcess(e){var t=this.getPlaneIndexByName(e);-1==t&&console.log("faceName is illegal");var i=0;t<2?i=this.cubeSize.x:t<4?i=this.cubeSize.y:t<6&&(i=this.cubeSize.z);var r=1;t%2!=1&&(r=-1);var n=r*this.planeOffset[t]/i;return n>1?n=1:n<0&&(n=0),n}rotateSectionBox(e,t){"x"==e?this.planeRotate[0]=t:"y"==e?this.planeRotate[1]=t:"z"==e&&(this.planeRotate[2]=t),this.calculation=!0;var r=new THREE.Quaternion;r.setFromAxisAngle(i,this.planeRotate[0]);var s=new THREE.Quaternion;s.setFromAxisAngle(n,this.planeRotate[1]);var o=new THREE.Quaternion;o.setFromAxisAngle(a,this.planeRotate[2]);var l=new THREE.Quaternion;l.multiply(r),l.multiply(s),l.multiply(o),this.quaternion.copy(l),this.update()}highLight(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeHighLightMatrial)}cancelHighLight(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeMaterial,this.selectIndex=null)}cancelHighLightByIndex(e){this.children[e].material=this.planeMaterial}init(){this.calculationPlanes(this.cubeSize,this.center)}hitTest(e){var t=null,i=null;if(this.raycast(e),null!=this.selectIndex){var r=e.ray,n=new THREE.Plane,a=this.uniforms.vClipPlane.value[this.selectIndex];n.setComponents(a.x,a.y,a.z,a.w),t=r.distanceToPlane(n),i=r.direction.dot(n.normal)<0}return{sign:i,distance:t}}raycast(e){if(this.visible){var t=[],i=null;this.selectIndex=null;for(var r=0;r<6;r++)if(this.children[r].raycast(e,t),t.length>0){var n=t.pop();(!i||n.distance<i.distance)&&(i=n,this.selectIndex=r),t=[]}}}}var l=function(e,t,i,r,n,a,s,o,l,d,h,c,u,p){this.enable=e,this.visible=t,this.rotatable=i,this.calculation=r,this.planeOffset=n.slice(0),this.planeRotate=a.slice(0),this.position=s,this.scale=o,this.quaternion=l,this.cubeSize=d,this.center=h,this.boundingBox=c,this.isHatchEnabled=u,this.isHatchByMaterial=p};r.ClipPlanes=o})(),(()=>{var e=new THREE.Quaternion,t=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,1,0),n=new THREE.Vector3(0,0,1);let a=new THREE.Matrix4,s=new THREE.Vector3,o=(new THREE.Vector3,function(e,t,i,r,n,a,s,o,l,d,h,c){this.enable=e,this.visible=t,this.rotatable=i,this.planeOffset=r,this.position=n,this.scale=a,this.quaternion=s,this.cubeSize=o,this.center=l,this.normalIndex=d,this.isHatchByMaterial=h,this.basePoint=c});class l extends r.ObjectGroup{constructor(e,t,i,n){super(r.ObjectGroupType.FILLCLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.modelBBox=i.clone(),this.scene=n,this.boundaryPoints=function(e){return[new THREE.Vector3(e.min.x,e.min.y,e.min.z),new THREE.Vector3(e.min.x,e.min.y,e.max.z),new THREE.Vector3(e.min.x,e.max.y,e.min.z),new THREE.Vector3(e.max.x,e.min.y,e.min.z),new THREE.Vector3(e.min.x,e.max.y,e.max.z),new THREE.Vector3(e.max.x,e.min.y,e.max.z),new THREE.Vector3(e.max.x,e.max.y,e.min.z),new THREE.Vector3(e.max.x,e.max.y,e.max.z)]}(this.modelBBox),this.extentPoints=[new THREE.Vector3(.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z),new THREE.Vector3(.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z),new THREE.Vector3(.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z),new THREE.Vector3(.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z),new THREE.Vector3(.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z),new THREE.Vector3(.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z),new THREE.Vector3(.5*this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z),new THREE.Vector3(.5*this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z)],this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(t,e),this.boundingBox=this.originBoundingBox.clone(),this.center=t.clone(),this.length=Math.max(this.cubeSize.x,Math.max(this.cubeSize.y,this.cubeSize.z)),this.planeOffset=0,this.normalIndex=3,this.visible=!1,this.rotatable=!1,this.hit=!1,this.clipplane=new THREE.Vector4,this.observer=null,this.renderClipPlane=new THREE.Plane,this.angleA=0,this.angleB=0,this.capsIntersectPosition=[],this.capsIntersectPositionGroup=new Map,this.capsIntersectContour={},this.clipPlaneBox=null,this.clipPlaneBoxWorld=new THREE.Box3,this.innerClipping=!1,this.limitDragging=!0,this.orthoViewProjMatrix=new THREE.Matrix4,this.planeWidth=null,this.planeHeight=null,this.state={rotation:this.rotation.clone(),position:this.position.clone(),quaternion:this.quaternion.clone(),planeMeshCenter:this.position.clone(),matrix:new THREE.Matrix4},this.state.matrix.compose(this.state.position,this.state.quaternion,this.scale),this.basePoint=this.position.clone(),this.autoAdjustScene=!0,this.uniforms={iClipPlane:{value:0},vClipPlane:{value:new Array(new THREE.Vector4)}},this.planeMaterial=new r.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0,unlight:!0}),this.planeHighLightMatrial=new r.PhongLightingMaterial({color:2989714,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0,unlight:!0}),this.renderOrder=r.EnumRenderOrder.ClipPlane,this.orderredCapsIntersectPosition=[],this.lastClipTime=0}_updateState(){this.state.matrix.compose(this.state.position,this.state.quaternion,this.scale)}initPlaneModel(){for(var e=this.children.length-1;e>=0;--e)this.remove(this.children[e]);this.planeOffset=0;var t=this.length,i=new THREE.PlaneGeometry(t,t),n=new THREE.Mesh(i,this.planeMaterial);n.name="fillClipPlane",n.customTag=!0,n.renderOrder=r.EnumRenderOrder.ClipPlane,this.position.copy(this.center),this.state.position.copy(this.center),this.basePoint.copy(this.center),this._updateState(),this.clipplane.set(0,0,1,0),this.planeMesh=n,this.planeMesh.geometry.computeBoundingBox(),this.clipPlaneBox=this.planeMesh.geometry.boundingBox,this.add(n)}initWireframes(){var e=.5*this.length,t=[-e,e,0,e,e,0,-e,-e,0,e,-e,0],i=new THREE.BufferGeometry,n=new r.PhongLightingMaterial({color:2989714,lights:!0,unlight:!0});i.setIndex([0,1,1,3,3,2,2,0]),i.setAttribute("position",new THREE.Float32BufferAttribute(t,3));var a=new THREE.LineSegments(i,n);a.name="Wireframes",a.customTag=!0,this.wireframeMesh=a,this.add(a)}resizeGeometry(e,t){if(this.planeMesh&&this.wireframeMesh){var i=new THREE.PlaneGeometry(e,t);this.planeMesh.geometry=i,this.planeMesh.geometry.computeBoundingBox(),this.clipPlaneBox=this.planeMesh.geometry.boundingBox;var r=.5*e,n=.5*t,a=[-r,n,0,r,n,0,-r,-n,0,r,-n,0],s=new THREE.BufferGeometry;if(s.setIndex([0,1,1,3,3,2,2,0]),s.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),this.wireframeMesh.geometry=s,this.capPlane){var o=new THREE.PlaneGeometry(e,t);this.capPlane.planeMesh.geometry=o}}}getCoordinate(){var e=this.planeWidth?.5*this.planeWidth:.5*this.length,t=this.planeHeight?.5*this.planeHeight:.5*this.length,i=new THREE.Vector3(-e,t,0);i.applyMatrix4(this.state.matrix);var r=new THREE.Vector3(e,t,0);r.applyMatrix4(this.state.matrix);var n=new THREE.Vector3(-e,-t,0);return n.applyMatrix4(this.state.matrix),{axisX:i.clone().sub(r).normalize(),axisY:i.clone().sub(n).normalize()}}initCapsPlane(e,t,i){if(this.capPlane)return this.capPlane;var n=this.length,a=new THREE.PlaneGeometry(n,n),s=new r.PhongLightingMaterial({color:10064980,side:THREE.DoubleSide,viewportSize:t,backSceneTexture:e,unlight:!0}),o=new THREE.Mesh(a,s),l=this.planeMesh;o.matrixWorld=l.matrixWorld,o.matrix=this.matrix;for(var d=.5*this.length,h=[],c=5;c<2*this.length;c+=5){var u,p;c<this.length?(u=-d,p=-d+c):(u=-d+c-this.length,p=d),h.push(u,p,0),h.push(p,u,0)}var m=new THREE.LineMaterial({color:2236962});m.linewidth=1,m.resolution.set(t.x,t.y),m.depthTest=!1;var f=new THREE.LineSegmentsGeometry;f.setPositions(h);var g=new THREE.LineSegments2(f,m);return g.matrix=this.matrix,g.matrixWorld=l.matrixWorld,i&&(s.defines.USE_CAP="",g.visible=!1),this.capPlane={planeMesh:o,lineMesh:g},this.capPlane}getPlaneCoordinateSystem(){var e=this.getCoordinate(),t=this.renderClipPlane.normal.clone(),i=e.axisY.clone(),r=t.clone().cross(i.clone());return this.normalIndex>3&&(i=(r=e.axisX.clone()).clone().cross(t.clone())),{x:r,y:i}}_prepareSectionPlaneByBorder(e){if(this.orderredCapsIntersectPosition=[],0!=this.capsIntersectPosition.length){var t=e.getRawMatrixGlobal(),i=t.clone().invert(),n=this.getPlaneCoordinateSystem(),a={center:this.position.clone(),width:this.planeWidth||this.length,height:this.planeHeight||this.length,coord:n,normal:this.renderClipPlane.normal.clone()};a.rightTop=a.center.clone().add(a.coord.x.clone().multiplyScalar(a.width/2)).add(a.coord.y.clone().multiplyScalar(a.height/2)),a.rightBottom=a.center.clone().add(a.coord.x.clone().multiplyScalar(a.width/2)).sub(a.coord.y.clone().multiplyScalar(a.height/2)),a.leftTop=a.center.clone().sub(a.coord.x.clone().multiplyScalar(a.width/2)).add(a.coord.y.clone().multiplyScalar(a.height/2)),a.leftBottom=a.center.clone().sub(a.coord.x.clone().multiplyScalar(a.width/2)).sub(a.coord.y.clone().multiplyScalar(a.height/2));for(var s=0;s<this.capsIntersectPosition.length;s+=3){if(S((new THREE.Vector3).fromArray(this.capsIntersectPosition,s),a))break}if(s>=this.capsIntersectPosition.length)this.orderredCapsIntersectPosition=this.capsIntersectPosition;else for(var o of("function"!=typeof THREE.Vector3.prototype.equalsEpsilon&&(THREE.Vector3.prototype.equalsEpsilon=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}),this.capsIntersectPositionGroup.keys())){var l=this.capsIntersectPositionGroup.get(o);for(var d of l.keys()){var h=[],c=l.get(d),u=[];for(s=0;s<c.length;s++)for(var p=c[s],m=p[0],f=p[1],g=m;g<f;g+=6){var v=(new THREE.Vector3).fromArray(this.capsIntersectPosition,g),y=(new THREE.Vector3).fromArray(this.capsIntersectPosition,g+3);u.push({start:v,end:y})}_(x(M(u,(function(e,t){return e.start.equalsEpsilon(t.start,1e-6)&&e.end.equalsEpsilon(t.end,1e-6)||e.end.equalsEpsilon(t.start,1e-6)&&e.start.equalsEpsilon(t.end,1e-6)}))),t).forEach((e=>{var t;if((t=e)[0].start.equalsEpsilon(t[t.length-1].end,1e-6)){var r=I(T(b(e),a),i,!0);this.orderredCapsIntersectPosition.push(...r)}else e.forEach((e=>{var t=S(e.start,a),r=S(e.end,a);if(t^r){var n=C(e.start.clone(),e.end.clone(),a);if(h.push(n),n)if(r){var s=e.start.clone().applyMatrix4(i).toArray([],0);this.orderredCapsIntersectPosition.push(...s),this.orderredCapsIntersectPosition.push(...n.point)}else{this.orderredCapsIntersectPosition.push(...n.point);var o=e.end.clone().applyMatrix4(i).toArray([],0);this.orderredCapsIntersectPosition.push(...o)}}else t||r||this.orderredCapsIntersectPosition.push(...e.start.clone().applyMatrix4(i).toArray([],0),...e.end.clone().applyMatrix4(i).toArray([],0))}))}))}}}function M(e,t){for(var i=[],r=0;r<e.length;r++){for(var n=e[r],a=0;a<i.length;a++){if(1==t(n,i[a])){i.splice(a,1);break}}i.push(n)}return i}function E(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(e.start.equalsEpsilon(r.start,1e-6))return{index:i,data:r,revert:!0,next:!1};if(e.start.equalsEpsilon(r.end,1e-6))return{index:i,data:r,revert:!1,next:!1};if(e.end.equalsEpsilon(r.start,1e-6))return{index:i,data:r,revert:!1,next:!0};if(e.end.equalsEpsilon(r.end,1e-6))return{index:i,data:r,revert:!0,next:!0}}}function x(e){var t=[];function i(e){var t=[],i=e[0],r=i;for(t.push(i),e.splice(0,1);e.length>0;){var n=E(r,e);if(null==n)break;if(null!=n){if(n.revert){var a=n.data.end;n.data.end=n.data.start,n.data.start=a}1==n.next?(t.push(n.data),r=n.data):t.unshift(n.data),e.splice(n.index,1)}}return t}for(;e.length>0;)t.push(i(e));return t}function _(e,t){var i=[];return e.forEach((e=>{var r=[];e.forEach((e=>{r.push({start:e.start.clone().applyMatrix4(t),end:e.end.clone().applyMatrix4(t)})})),i.push(r)})),i}function b(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].start);return t}function I(e,t,i){var r=[];if(e.length>1){for(var n=0;n<e.length-1;n++)r.push(...e[n].clone().applyMatrix4(t).toArray([],0),...e[n+1].clone().applyMatrix4(t).toArray([],0));i&&r.push(...e[e.length-1].clone().applyMatrix4(t).toArray([],0),...e[0].clone().applyMatrix4(t).toArray([],0))}return r}function T(e,t){function i(e,t,i){switch(t){case"left":case"Left":case"L":var r=e.clone().sub(i.center),n=i.coord.y.clone().cross(r).normalize().equalsEpsilon(i.normal.clone().negate(),.01),a=new THREE.Line3(i.center,i.center.clone().add(i.coord.y)),s=new THREE.Vector3,o=a.closestPointToPoint(e,!1,s).distanceTo(e);return!n||n&&o<i.width/2;case"right":case"Right":case"R":r=e.clone().sub(i.center),n=i.coord.y.clone().cross(r).normalize().equalsEpsilon(i.normal.clone(),.01),a=new THREE.Line3(i.center,i.center.clone().add(i.coord.y)),s=new THREE.Vector3,o=a.closestPointToPoint(e,!1,s).distanceTo(e);return!n||n&&o<i.width/2;case"top":case"Top":case"T":r=e.clone().sub(i.center),n=i.coord.x.clone().cross(r).normalize().equalsEpsilon(i.normal.clone().negate(),.01),a=new THREE.Line3(i.center,i.center.clone().add(i.coord.x)),s=new THREE.Vector3,o=a.closestPointToPoint(e,!1,s).distanceTo(e);return!n||n&&o<i.height/2;case"Bottom":case"bottom":case"B":r=e.clone().sub(i.center),n=i.coord.x.clone().cross(r).normalize().equalsEpsilon(i.normal.clone(),.01),a=new THREE.Line3(i.center,i.center.clone().add(i.coord.x)),s=new THREE.Vector3,o=a.closestPointToPoint(e,!1,s).distanceTo(e);return!n||n&&o<i.height/2}}function r(e,t,i,r){var n=t.clone().sub(e),a=n.length(),s=n.clone().normalize(),o=new THREE.Line3(i,r),l=new THREE.Vector3,d=new THREE.Vector3;o.closestPointToPoint(e,!1,l),o.closestPointToPoint(t,!1,d);var h=l.distanceTo(e),c=h/(h+d.distanceTo(t));return e.clone().add(s.clone().multiplyScalar(c*a))}var n=[];if(e.length>0){for(var a=0;a<e.length-1;a++){var s=e[a],o=e[a+1];if((c=i(s,"L",t))^i(o,"L",t)){var l=r(s,o,t.leftBottom,t.leftTop);c?n.push(l):n.push(l,o)}else i(s,"L",t)&&i(o,"L",t)&&n.push(o)}s=e[e.length-1],o=e[0];if((c=i(s,"L",t))^i(o,"L",t)){l=r(s,o,t.leftBottom,t.leftTop);c?n.push(l):n.push(l,o)}else i(s,"L",t)&&i(o,"L",t)&&n.push(o)}var d=[];if(n.length>0){for(a=0;a<n.length-1;a++){s=n[a],o=n[a+1];if((c=i(s,"R",t))^i(o,"R",t)){l=r(s,o,t.rightBottom,t.rightTop);c?d.push(l):d.push(l,o)}else i(s,"R",t)&&i(o,"R",t)&&d.push(o)}s=n[n.length-1],o=n[0];if((c=i(s,"R",t))^i(o,"R",t)){l=r(s,o,t.rightBottom,t.rightTop);c?d.push(l):d.push(l,o)}else i(s,"R",t)&&i(o,"R",t)&&d.push(o)}var h=[];if(d.length>0){for(a=0;a<d.length-1;a++){s=d[a],o=d[a+1];var c=i(s,"T",t);i(o,"T",t);if(i(s,"T",t)^i(o,"T",t)){l=r(s,o,t.rightTop,t.leftTop);c?h.push(l):h.push(l,o)}else i(s,"T",t)&&i(o,"T",t)&&h.push(o)}s=d[d.length-1],o=d[0],c=i(s,"T",t),i(o,"T",t);if(i(s,"T",t)^i(o,"T",t)){l=r(s,o,t.rightTop,t.leftTop);c?h.push(l):h.push(l,o)}else i(s,"T",t)&&i(o,"T",t)&&h.push(o)}var u=[];if(h.length>0){for(a=0;a<h.length-1;a++){s=h[a],o=h[a+1];if((c=i(s,"B",t))^i(o,"B",t)){l=r(s,o,t.rightBottom,t.leftBottom);c?u.push(l):u.push(l,o)}else i(s,"B",t)&&i(o,"B",t)&&u.push(o)}s=h[h.length-1],o=h[0];if((c=i(s,"B",t))^i(o,"B",t)){l=r(s,o,t.rightBottom,t.leftBottom);c?u.push(l):u.push(l,o)}else i(s,"B",t)&&i(o,"B",t)&&u.push(o)}return u}function S(e,t){function i(e){return e.x+e.y+e.z}var r=e.clone().sub(t.center.clone()),n=r.length(),a=i(r.clone().multiply(t.coord.x))/n,s=i(r.clone().multiply(t.coord.y))/n,o=Math.abs(a*n),l=Math.abs(s*n);return o>t.width/2||l>t.height/2}function C(e,t,n){for(var a=[{dir:n.coord.y,line:new THREE.Line3(n.rightTop,n.rightBottom)},{dir:n.coord.x,line:new THREE.Line3(n.rightBottom,n.leftBottom)},{dir:n.coord.y,line:new THREE.Line3(n.leftBottom,n.leftTop)},{dir:n.coord.x,line:new THREE.Line3(n.leftTop,n.rightTop)}],s=0;s<a.length;s++){if(r.Utils.lineLineIntersection3d(e,t,a[s].line.start,a[s].line.end)){var o=t.clone().sub(e),l=o.length(),d=o.clone().normalize(),h=new THREE.Vector3,c=new THREE.Vector3,u=a[s];u.line.closestPointToPoint(e,!1,h),u.line.closestPointToPoint(t,!1,c);var p=h.clone().sub(e).length(),m=p/(p+c.clone().sub(t).length()),f=e.clone().add(d.multiplyScalar(l*m));return f.applyMatrix4(i),{line:u.line,point:f.toArray([],0)}}}return null}}addToCapsWireframe(e){if(this._prepareSectionPlaneByBorder(e),this.capsWireframe)this.capsWireframe.geometry.setPositions(this.orderredCapsIntersectPosition),this.capsWireframe.geometry._maxInstanceCount=void 0;else{var t=e.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}),i=new THREE.LineSegmentsGeometry;i.setPositions(this.orderredCapsIntersectPosition),this.capsWireframe=new THREE.LineSegments2(i,new THREE.LineMaterial({color:2236962,linewidth:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),side:THREE.DoubleSide})),t.add(this.capsWireframe),t.updateMatrixWorld(!0)}}clearCapsWireframe(){this.capsIntersectPosition.length=0,this.capsIntersectPosition=[],this.orderredCapsIntersectPosition=[],this.capsIntersectPositionGroup=new Map,this.capsWireframe&&this.capsWireframe.geometry.deleteAttribute("instanceStart"),this.capsWireframe&&this.capsWireframe.geometry.deleteAttribute("instanceEnd")}calculateClippingIds(){}reCalculateClippingIds(e,t){this.calculateClippingIds(e,t)}updateClippingParams(e){}getFillClipBoundingBox(){return this.boundingBox}getFillClipPlaneBoundingBox(){this.clipPlaneBoxWorld.copy(this.clipPlaneBox);const e=this.planeMesh.matrixWorld;return this.clipPlaneBoxWorld.applyMatrix4(e),this.clipPlaneBoxWorld}calculateFillClipBoundingBox(e){this.boundingBox=this.originBoundingBox.clone();const t=this.clipplane.clone();let i=(new THREE.Matrix4).makeRotationFromEuler(this.rotation);t.applyMatrix4(i),r.Math.equalsEpsilon(t.x,0,r.Math.EPSILON4)?r.Math.equalsEpsilon(t.y,0,r.Math.EPSILON4)?r.Math.equalsEpsilon(t.z,0,r.Math.EPSILON4)||(r.Math.equalsEpsilon(t.z,1,r.Math.EPSILON3)?this.boundingBox.max.z=e.z:this.boundingBox.min.z=e.z):r.Math.equalsEpsilon(t.y,1,r.Math.EPSILON3)?this.boundingBox.max.y=e.y:this.boundingBox.min.y=e.y:r.Math.equalsEpsilon(t.x,1,r.Math.EPSILON3)?this.boundingBox.max.x=e.x:this.boundingBox.min.x=e.x}enable(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?1:0,this.update()}isEnabled(){return 0!=this.uniforms.iClipPlane.value}updateClippingPlane(){}setBasePoint(e){this.updateBasePoint(e)}updateBasePoint(e){this.basePoint=new THREE.Vector3(e.x,e.y,e.z)}_updateClippingPlaneMesh(){let e=this.uniforms.vClipPlane.value[0].clone();e=(new THREE.Plane).setComponents(-e.x,-e.y,-e.z,-e.w);let t=[];t=[],t.push(this.basePoint),this.boundaryPoints.forEach((i=>{let r=new THREE.Vector3;e.projectPoint(i,r),t.push(r)}));let i=0,r=0,n=(new THREE.Matrix4).makeRotationFromQuaternion(this.state.quaternion.clone()).invert(),a=[];t.forEach((e=>{let t=e.clone().applyMatrix4(n);a.push(t)}));let o=(new THREE.Box3).setFromPoints(a),l=new THREE.Vector3,d=new THREE.Vector3;o.getCenter(l),d=o.getSize(d).multiplyScalar(1.05),o.setFromCenterAndSize(l,d);let h=(new THREE.Vector3).copy(l.clone().applyQuaternion(this.state.quaternion));this.position.copy(h);let c=o.getSize(s),u=this.normalIndex;0!=u&&1!=u||(i=c.z,r=c.y),2!=u&&3!=u||(i=c.x,r=c.y),4!=u&&5!=u||(i=c.x,r=c.z),this.setBorder(i,r,!1,!0),this.updateMatrixWorld()}_updatePlaneMesh(){this.position.copy(this.state.position),this.quaternion.copy(this.state.quaternion),this._updateState(),this.updateMatrixWorld()}update(){if(this._updatePlaneMesh(),a.copy(this.state.matrix).invert(),a.transpose(),this.uniforms.vClipPlane.value[0]=this.clipplane.clone().applyMatrix4(a),this.autoAdjustScene&&this._updateClippingPlaneMesh(),this.innerClipping){var e=this.planeWidth,t=this.planeHeight;this.orthoCamera=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,.1,2e3),this.orthoCamera.position.set(this.state.position.x,this.state.position.y,this.state.position.z);var i=this.uniforms.vClipPlane.value[0].clone(),r=new THREE.Vector3(i.x,i.y,i.z);r.normalize();var n=new THREE.Vector3(this.state.position.x,this.state.position.y,this.state.position.z);n.add(r),this.orthoCamera.lookAt(n),this.orthoCamera.updateMatrixWorld(!0),this.orthoViewProjMatrix.copy(this.orthoCamera.projectionMatrix),a.copy(this.orthoCamera.matrixWorld).invert(),this.orthoViewProjMatrix.multiply(a)}this.updateClippingParams(this.uniforms),this.updatePlaneOffset(),this.observer&&this.observer()}getClipPlane(){return this.clipplane.clone()}computeDistance(e){const t=new THREE.Plane(e,0);let i=0;for(let e=0;e<this.extentPoints.length;++e){const r=t.distanceToPoint(this.extentPoints[e]);i=Math.max(i,r)}return i}offset(e){var t=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(t.x,t.y,t.z);i.normalize();const r=this.computeDistance(i);let n=this.planeOffset;this.planeOffset+=e,this.limitDragging&&Math.abs(this.planeOffset)>r&&(this.planeOffset=this.planeOffset>0?r:-r,e=this.planeOffset-n);var a=new THREE.Vector3(i.x*this.planeOffset,i.y*this.planeOffset,i.z*this.planeOffset),s=i.clone().multiplyScalar(e);this.state.position.add(s),this.basePoint.add(s),this.state.planeMeshCenter.copy(this.center).add(a),this.update()}setOffset(e){var t=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(t.x,t.y,t.z);i.normalize();var r=this.computeDistance(i);let n=this.planeOffset,a=e-this.planeOffset;this.planeOffset=e,this.limitDragging&&Math.abs(e)>r&&(this.planeOffset=e>0?r:-r,a=this.planeOffset-n);var s=new THREE.Vector3(i.x*this.planeOffset,i.y*this.planeOffset,i.z*this.planeOffset);this.state.position.add(i.clone().multiplyScalar(a));let o=this.basePoint.add(i.clone().multiplyScalar(a));this.updateBasePoint(o),this.state.planeMeshCenter.copy(this.center).add(s),this.update()}changeNormal(e){this.state.quaternion.set(0,0,0,1),this._updateState(),this.quaternion.set(0,0,0,1),this.angleA=0,this.angleB=0,this.setNormal(e)}setNormal(e){var t=this.planeMesh,i=this.wireframeMesh;0==e?(this.clipplane.set(1,0,0,0),t.rotation.set(0,Math.PI/2,0),i.rotation.set(0,Math.PI/2,0)):1==e?(this.clipplane.set(-1,0,0,0),t.rotation.set(0,-Math.PI/2,0),i.rotation.set(0,-Math.PI/2,0)):2==e?(this.clipplane.set(0,0,-1,0),t.rotation.set(Math.PI,0,0),i.rotation.set(Math.PI,0,0)):3==e?(this.clipplane.set(0,0,1,0),t.rotation.set(0,0,0),i.rotation.set(0,0,0)):4==e?(this.clipplane.set(0,1,0,0),t.rotation.set(-Math.PI/2,0,0),i.rotation.set(-Math.PI/2,0,0)):5==e&&(this.clipplane.set(0,-1,0,0),t.rotation.set(Math.PI/2,0,0),i.rotation.set(Math.PI/2,0,0)),this.normalIndex=e,t.updateMatrixWorld(),i.updateMatrixWorld(),this.capPlane&&(this.capPlane.planeMesh.matrixWorld=t.matrixWorld,this.capPlane.lineMesh.matrixWorld=t.matrixWorld),this.state.quaternion.copy(this.quaternion),this.state.position.copy(this.center),this.state.planeMeshCenter.copy(this.center),this.planeOffset=0,this.basePoint.copy(this.center),this.update()}rotX(i){e.setFromAxisAngle(t,i),this.quaternion.multiply(e),this.update()}rotY(t){e.setFromAxisAngle(i,t),this.quaternion.multiply(e),this.update()}rotateByAxis(e,t){this.rotateOnBasePoint(this.basePoint,e,t)}rotateAngleOffset(e,r){var a=this.normalIndex;e=e%360/180*Math.PI,0==a||1==a?("y"==r&&this.rotateByAxis(n,e),"z"==r&&this.rotateByAxis(i,e)):2==a||3==a?("x"==r&&this.rotateByAxis(t,e),"z"==r&&this.rotateByAxis(i,e)):4!=a&&5!=a||("x"==r&&this.rotateByAxis(t,e),"y"==r&&this.rotateByAxis(n,e)),this.update()}rotateOnBasePoint(e,t,i){let r=new THREE.Vector3(e.x,e.y,e.z),n=new THREE.Vector3(t.x,t.y,t.z).normalize(),a=this.state.quaternion.clone().clone().invert(),s=this.state.position.clone();this.basePoint=r;let o=(new THREE.Quaternion).setFromAxisAngle(n,i);this.state.quaternion.multiply(o);let l=r.clone().sub(s).applyQuaternion(a).applyQuaternion(this.state.quaternion);this.state.position.sub(l).add(r.clone().sub(s)),this._updatePlaneMesh();let d=this.renderClipPlane,h=d.distanceToPoint(this.center);this.planeOffset=h,this.state.planeMeshCenter.copy(this.center).add(d.normal.clone().multiplyScalar(h)),this.update()}setRotateAngle(e,r){this.quaternion.set(0,0,0,1);var a=this.normalIndex;e=(e=null==e?this.angleA:e%360)<0?360+e:e,r=(r=null==r?this.angleB:r%360)<0?360+r:r,this.angleA=e,this.angleB=r,e=e/180*Math.PI,r=r/180*Math.PI,0==a||1==a?(e=0==a?-e:e,r=0==a?r:-r,this.rotateByAxis(n,e),this.rotateByAxis(i,r)):2==a||3==a?(this.rotateByAxis(t,e),this.rotateByAxis(i,r)):4!=a&&5!=a||(e=3==a?-e:e,r=3==a?r:-r,this.rotateByAxis(t,e),this.rotateByAxis(n,r)),this.update()}getRotateAngle(){return{angleA:this.angleA,angleB:this.angleB}}highLight(){this.planeMesh.material=this.planeHighLightMatrial}cancelHighLight(){this.planeMesh.material=this.planeMaterial,this.hit=!1}store(e){return new o(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.planeOffset,this.state.position.clone(),this.scale.clone(),this.state.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.normalIndex,this.clipCapsManager.hatchByMaterialForPlane,this.basePoint)}restore(e){this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.normalIndex=null==e.normalIndex?this.normalIndex:e.normalIndex,this.setNormal(this.normalIndex),this.state.position.copy(e.position),this.state.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.state.quaternion._w=e.quaternion._w,this.state.quaternion._x=e.quaternion._x,this.state.quaternion._y=e.quaternion._y,this.state.quaternion._z=e.quaternion._z,e.basePoint?this.updateBasePoint(e.basePoint):this.updateBasePoint(e.position),this.setBorder(this.length,this.length,!1,!0),this.cubeSize.set(e.cubeSize.x,e.cubeSize.y,e.cubeSize.z),this.clipCapsManager.enableHatchByMaterial(e.isHatchByMaterial,!1),this.update();var t=this.uniforms.vClipPlane.value[0].clone();let i=(new THREE.Plane).setComponents(-t.x,-t.y,-t.z,-t.w).distanceToPoint(this.center);this.planeOffset=i,this.calculateClippingIds()}setProcess(e){var t=this.uniforms.vClipPlane.value[0].clone(),i=new THREE.Vector3(t.x,t.y,t.z);i.normalize(),e>1?e=1:e<-1&&(e=-1);let r=e*this.computeDistance(i);this.setOffset(r)}restoreRotation(){this.state.quaternion.set(0,0,0,1),this.state.position.copy(this.position),this.basePoint.copy(this.state.position),this.update()}getProcess(){var e=this.uniforms.vClipPlane.value[0].clone(),t=new THREE.Vector3(e.x,e.y,e.z);t.normalize();var i=this.computeDistance(t);return this.planeOffset/i}init(){this.initPlaneModel(),this.initWireframes()}hitTest(e){if(this.visible){var t=null,i=null;if(this.hit=this.raycast(e),this.hit){var r=e.ray,n=new THREE.Plane,a=this.uniforms.vClipPlane.value[0];n.setComponents(a.x,a.y,a.z,a.w),t=r.distanceToPlane(n),i=r.direction.dot(n.normal)<0}return{sign:i,distance:t}}this.hit=!1}raycast(e,t){var i=[];return this.planeMesh.raycast(e,i),i.length>0}resize(e){var t=Math.max(e.x,Math.max(e.y,e.z))/this.length;this.scale.set(t,t,t),this.cubeSize.copy(e)}setBorder(e,t,i,n=!1){this.planeWidth=e,this.planeHeight=t,this.resizeGeometry(e,t),this.cubeSize.set(1,e,t),this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(this.center,this.cubeSize),this.boundingBox=this.originBoundingBox.clone(),this.innerClipping=!r.Utils.isDefined(i)||i,this.limitDragging=!0,this.autoAdjustScene=!0,n||(this.state.position.copy(this.basePoint),this.basePoint.copy(this.basePoint),this.limitDragging=!1,this.autoAdjustScene=!1,this.update())}getSideLength(){return this.length*this.scale.x}updateCamera(e){!1!==this.visible&&(e.calculateNearFar({fillClipPlane:!0}),e.cameraControl.updateCamera())}updatePlaneOffset(){var e=this.uniforms.vClipPlane.value[0].clone(),t=(new THREE.Plane).setComponents(-e.x,-e.y,-e.z,-e.w);let i=t.distanceToPoint(this.center);this.planeOffset=i,this.state.planeMeshCenter.copy(this.center).add(t.normal.clone().multiplyScalar(this.planeOffset))}}r.FillClipPlane=l})(),r.ClipPlaneService=function(e){this.viewer=e},r.ClipPlaneService.prototype={construtor:r.ClipPlaneService,destroy:function(){this.viewer=null},update:function(e){var t=this.getEditor();t&&(t.update(e),this.viewer.render())},getEditor:function(){for(var e=this.viewer.editorManager.tools,t=0;t<e.length;t++)if(e[t].getName()==r.EditToolMode.CLIP_BY_BOX)return e[t];return null},setSectionBox:function(e,t){this.getEditor().setSectionBox(e,t)},toggle:function(e,t){this.getEditor().toggle(e,t)},setVisible:function(e){this.getEditor().visible(e)},setRotatable:function(e){this.getEditor().rotatable(e)},enablePick:function(e){this.getEditor().enablePick=e},saveState:function(){return this.getEditor().store()},loadState:function(e){this.getEditor().restore(e)},reset:function(){r.ClipPlaneManager.resetClipPlanes(this.viewer.getScene()),this.getEditor().reset()},recalculate:function(){return this.viewer.getFilter().getVisibleComponentsBbox()},setProcess:function(e,t){this.getEditor().setProcess(e,t)},reCalculateClippingIds:function(e){this.getEditor().reCalculateClippingIds(e)},getProcess:function(e){return this.getEditor().getProcess(e)},changeDirection:function(e){this.getEditor().changeDirection(e)},visibleCapsWireframe:function(e){return this.getEditor().visibleCapsWireframe(e)}},(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;class i{constructor(){}}i.getInstance=function(i){if(null==i.clipPlanes){var n=i.getBoundingBox();i.clipPlanes=new r.ClipPlanes(n.getSize(t).multiplyScalar(i.expandScalar),n.getCenter(e)),i.objectGroups.add(i.clipPlanes)}return i.clipPlanes},i.destroy=function(e){e.clipPlanes=null},i.setClipPlanes=function(i,n){if(n){var a=r.ClipPlaneManager.getInstance(i);n.setFromCenterAndSize(n.getCenter(e),n.getSize(t).multiplyScalar(i.expandScalar)),a.setSectionBox(n.min,n.max)}},i.resetClipPlanes=function(i){var n=r.ClipPlaneManager.getInstance(i),a=i.getBoundingBox();a.max.x!=-1/0&&a.max.y!=-1/0&&a.max.z!=-1/0&&a.min.x!=1/0&&a.min.y!=1/0&&a.min.z!=1/0?(a.setFromCenterAndSize(a.getCenter(e),a.getSize(t).multiplyScalar(i.expandScalar)),n.setSectionBox(a.min,a.max)):i.clipPlanes=null},i.disableClipPlanes=function(e){null!=e.clipPlanes&&(e.clipPlanes.enable(!1,!1),e.clipPlanes.update())},r.ClipPlaneManager=i})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;class i{constructor(){}}i.getInstance=function(i){if(null==i.fillClipPlane){var n=new THREE.Box3;n.copy(i.getBoundingBoxWithoutDEM()),i.fillClipPlane=new r.FillClipPlane(n.getSize(t).multiplyScalar(i.expandScalar),n.getCenter(e),n,i),i.objectGroups.add(i.fillClipPlane)}return i.fillClipPlane},i.destroy=function(e){e.fillClipPlane=null},i.disableClipPlanes=function(e){null!=e.fillClipPlane&&(e.fillClipPlane.enable(!1,!1),e.fillClipPlane.update())},i.getFillClipPlaneBoundingBoxWorld=function(e){const t=i.getInstance(e).planeMesh;t.geometry.computeBoundingBox();let r=t.geometry.boundingBox.clone();var n=e.getInverseMatrixGlobal();return r.applyMatrix4(t.matrixWorld).applyMatrix4(n),r},i.getCreatedFillClipPlane=function(e){return e.fillClipPlane},r.FillClipPlaneManager=i})(),function(){class e{constructor(){}static getContours(t,i,n){let a,s,o=[],l=(e,t,i)=>{let r=0;for(let n=0;n<i.length;n++){let a=i[n];if(n!=t&&0==a.checked&&a.faceIndex==e.faceIndex){r=n;break}}return r},d=(t,i)=>{let n=-1;for(let a=0;a<i.length;a++){let s=i[a];if(0==s.checked&&r.GeomUtil.isVector3Equal(s,t,e.tolerance)){n=a;break}}return n},h=(t,i,n)=>{let a=d(t,i);if(-1===a&&(t.x=n[0].x,t.y=n[0].y,t.z=n[0].z,n.reverse(),a=d(t,i),-1===a))return n;let s=i[a];s.checked=!0;let o=i[l(s,a,i)];return o.checked=!0,r.GeomUtil.isVector3Equal(o,n[0],e.tolerance)?(n.push(n[0].clone()),n):(n.push(o.clone()),h(o,i,n))},c=0,u=0;for(let e=0;e<t.length;e++)if(1!=t[e].checked){c=e,a=t[c],a.checked=!0,u=l(a,c,t),s=t[u],s.checked=!0,o.push(a.clone()),o.push(s.clone());break}o=h(s,t,o),i.push(o);let p=0;return t.forEach((e=>{p+=1==e.checked?1:0})),p!=t.length?this.getContours(t,i,!1):i}static concatContours(t){if(1===t.length)return t[0];let i=[];t.map((e=>{e.map((e=>{let t={checked:!1};t.line=e,i.push(t)}))}));let n=[],a=t=>{let i,s=(t,i,n)=>{let a=-1;for(let o=0;o<n.length;o++){const l=n[o],d=l.line;if(o!==i&&1!=l.checked){if(r.GeomUtil.isVector3Equal(t[0],d[0],e.tolerance)){t.reverse(),d.map(((e,i)=>{0!=i&&t.push(e)})),a=o,n[o].checked=!0,s(t,a,n);break}if(r.GeomUtil.isVector3Equal(t[0],d[d.length-1],e.tolerance)){d.reverse(),d.map(((e,i)=>{0!=i&&t.unshift(e)})),a=o,n[o].checked=!0,s(t,a,n);break}if(r.GeomUtil.isVector3Equal(t[t.length-1],d[0],e.tolerance))d.map(((e,i)=>{0!=i&&t.push(e)})),a=o,n[o].checked=!0,s(t,a,n);else if(r.GeomUtil.isVector3Equal(t[t.length-1],d[d.length-1],e.tolerance)){d.reverse(),d.map(((e,i)=>{0!=i&&t.push(e)})),a=o,n[o].checked=!0,s(t,a,n);break}}}},o=0;for(let e=0;e<t.length;e++){if(!0===t[e].checked)continue;i=t[e],t[e].checked=!0,o=e,s(i.line,o,t),n.push(i.line);let r=0;if(t.forEach((e=>{r+=1==e.checked?1:0})),r!=t.length)return a(t)}return n};return a(i)}static searchInnerRing(e){let t=e=>{const t=e[0],i=e[e.length-1];return r.GeomUtil.isVector3Equal(t,i,.1)};e.length;let i=[];e.map((e=>{let t={checked:!1};t.line=e,t.box=new THREE.Box3,e.map((e=>{t.box.expandByPoint(e)})),i.push(t)}));let n={},a=e=>{let i,r=(e,t,i)=>{for(let r=0;r<i.length;r++){const a=i[r],s=a.box;if(r!==t&&1!=a.checked)if(e.containsBox(s)){void 0===n[t]?n[t]=[r]:n[t].push(r),n[r]&&n[r].length>0&&(n[t]=n[t].concat(n[r]),delete n[r]);for(const e in n)n[e].indexOf(t)>-1&&(n[e]=n[e].concat(n[t]),delete n[t]);i[r].checked=!0}else if(s.containsBox(e)){void 0===n[r]?n[r]=[t]:n[r].push(t),i[r].checked=!0,n[t]&&n[t].length>0&&(n[r]=n[r].concat(n[t]),delete n[t]);for(const e in n)n[e].indexOf(r)>-1&&(n[e]=n[e].concat(n[r]),delete n[r])}else;}},s=0;for(let n=0;n<e.length;n++){if(!t(e[n].line))continue;if(!0===e[n].checked)continue;i=e[n],e[n].checked=!0,s=n,r(i.box,s,e);let o=0;if(e.forEach((e=>{o+=1==e.checked?1:0})),o!=e.length)return a(e)}};return a(i),n}}e.tolerance=.001,r.ClipPlaneContourManager=e}(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModel{constructor(e){super(e.getModelManager(),{modelId:"ExternalComponent"}),this.manager.addModel(this),this.filter=new r.FilterManager,this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.castShadow=!1,this.receiveShadow=!1,this.meshes={},this.customSelectMaterials={},this.databagId="ExternalComponent",this.objectIds=null,this.lastFilteredIds=null,this.firstAnimation=!0,this.animationIds={},this.animationLength=0,this.animationId=0,this.invalidObjectType=["invalidPlane"],this.floorExplosion=!1,this.blinkMaterials=[],this.blinkMaterialMap={},this.blinkOriginMaterialMap={},this.rawBoundingBoxMap={},this.bindModelMap={},this.mixers={},this.activeMixerIndex={},this.actions={},this.hoveredRenderOrder=-100}destroy(){if(this.manager.removeModel(this.id),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._removeNodeGroup(),this.meshes=null,this.customSelectMaterials=null,this.objectIds=null,this.lastFilteredIds=null,this._cancelAnimate(),this.firstAnimation=null,this.animationIds=null,this.invalidObjectType=null,this.blinkMaterials=null,this.blinkMaterialMap=null,this.blinkOriginMaterialMap=null,this.selectedIds=null,this.blinkedIds=null,this.rawBoundingBoxMap=null,this.bindModelMap=null,super.destroy()}setVisible(e){this.visible=e,this._getNodeGroup().visible=e}cloneNode(e,t){this.addNode(t,this.meshes[e])}addNode(t,i,n={}){if(!r.Utils.isDefined(i))return void console.log("Warning: the object is invalid");if(this.meshes[t])return void console.log("Warning: name is already exist, please change name ");if(-1!=this.invalidObjectType.indexOf(i.type))return void console.log("Warning: the object is invalid");let a;i.externalComponentManager=this,i instanceof Array||(i=[i]);for(let e in this.meshes)if(this.meshes[e][0].uuid===i[0].uuid){a=e;break}if(a){this.meshes[t]=[];let e=this.meshes[a].length;for(let i=0;i<e;i++)this.meshes[t][i]=r.SkeletonUtils.clone(this.meshes[a][i]),this.meshes[t][i].animations=this.meshes[a][i].animations,this.meshes[t][i].position.copy(this.meshes[a][i]._oriPosition),this.meshes[t][i].quaternion.copy(this.meshes[a][i]._oriQuaternion),this.meshes[t][i].scale.copy(this.meshes[a][i]._oriScale),this.meshes[t][i].matrix=(new THREE.Matrix4).copy(this.meshes[a][i]._oriMatrix),this.meshes[t][i].visible=!0;i=this.meshes[t]}else this.meshes[t]=i;var s,o,l=[r.ExternalObjectConverterGroup];for(s=0,o=i.length;s<o;s++){var d=!1;l.some((e=>(i[s]instanceof e&&(d=!0),d))),d?(c=i[s].clone(),i[s]=c):c=i[s],void 0===c._oriMatrix&&(c._oriMatrix=new THREE.Matrix4),c._oriPosition=(new THREE.Vector3).copy(c.position),c._oriQuaternion=(new THREE.Quaternion).copy(c.quaternion),c._oriScale=(new THREE.Vector3).copy(c.scale),c._oriMatrix.compose(c.position,c.quaternion,c.scale)}this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().addNode(t,i),n.customSelectMaterial&&(this.customSelectMaterials[t]=n.customSelectMaterial);var h=this.getModelManager().viewer;for(s=0,o=i.length;s<o;s++){var c;(c=i[s]).name=t;var u=new THREE.Box3;u.setFromObject(c),c.box=u,e.copy(c.matrix).invert(),c.originBox=u.clone().applyMatrix4(e),this._initializeAutoAnimation(c,t),this._getNodeGroup().add(c),c.updateMatrixWorld(!0);let a=r.Utils.defaultValue(n.holdMaterialWhenPicked,!1);this._cacheNodeMaterial(c,a),(r.GlobalData.EnableShadowMap||r.GlobalData.EnableCSM)&&(h.traverseGroupEnableShadow(c,!1,!1),h.updateShadowMap())}let p=r.Utils.defaultValue(n.objectData,{});if(r.Utils.isDefined(i[0].sourceComponentId)){let e=h.getUserdataByUserId(i[0].sourceComponentId);r.Utils.isDefined(e)&&(p=Object.assign({},p,e))}this._addToNodeInfoMap({name:t,userId:t,boundingBox:new THREE.Box3,state:r.EnumObjectState.Visible,userData:p}),this._updateBoundingBoxByObjectId(t),this._updateFilterManager(),this.objectIds=Object.keys(this.meshes),this.rawBoundingBoxMap[t]=this.getBoundingBoxById(t).clone()}setObjectData(e,t){this._updateUserData(e,t)}getObjectData(e){if(!this.nodeInfoMap)return;const t=this.nodeInfoMap[e];return r.Utils.isDefined(t)?t[0].userData:void 0}bindModel(e,t,i){if(t=r.Utils.defaultValue(t,"ExternalComponent"),this.meshes[e]&&this.getModelManager().modelCollection.getIds().indexOf(t.toString())>=0){if(this.getBindedInfo(e))return;this.bindModelMap[t]||(this.bindModelMap[t]={}),this.bindModelMap[t][e]=i||-1;let r=this.getModelManager().explosionManager;if(0!==r.getFloorExplosionExtent(t)){let i=r.getFloorInfos(t),n=this.meshes[e],a=this.getPickingNodeGenerator().pickingNodeMap[e];for(let e=0;e<n.length;e++){let t=n[e],r=a[e];this.explodeMesh(t,r,i,!0)}}}}unbindModel(e,t){if(this.bindModelMap[t]&&this.bindModelMap[t][e]){delete this.bindModelMap[t][e];const i=(e,t)=>{if(void 0!==e.explodedHeight){const i=e.explodedDirection.clone().negate().multiplyScalar(e.explodedHeight);let r=new THREE.Matrix4;r.makeTranslation(i.x,i.y,i.z),e.applyMatrix4(r),e.updateMatrixWorld(),t.applyMatrix4(r),t.updateMatrixWorld(),delete e.explodedDirection,delete e.explodedHeight,delete e.preExplodedDirection,delete e.preExplodedHeight}};let r=this.meshes[e];if(!r)return;let n=this.getPickingNodeGenerator().pickingNodeMap[e];for(let e=0;e<r.length;e++){i(r[e],n[e])}}}getBindedInfo(e){let t,i;return Object.keys(this.bindModelMap).some((r=>{let n=this.bindModelMap[r][e];if(n)return t=r,i=n,!0})),t?-1==i?{modelId:t}:{modelId:t,objectId:i}:void 0}getNodeById(e){var t=this.meshes[e];return t&&1===t.length?t[0]:t}removeNodeById(e){if(!this._hasObjectId(e))return;var t=this.meshes[e];t[0].autoAnimation&&(delete this.animationIds[e],this.animationLength--,0==this.animationLength&&this._cancelAnimate()),delete this.meshes[e],delete this.rawBoundingBoxMap[e],this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().removeNodeById(e),this.customSelectMaterials[e]&&delete this.customSelectMaterials[e];for(var i=this._getNodeGroup(),r=0,n=t.length;r<n;r++)i.remove(t[r]);this._removeFromNodeInfoMap(e),this._updateFilterManager(),this.filteredIds&&this.filteredIds[e]&&(delete this.filteredIds[e],this.lastFilteredIds=Object.keys(this.filteredIds)),this.objectIds=Object.keys(this.meshes),this.getModelManager().viewer.updateShadowMap();let a=this.getBindedInfo(e);a&&this.unbindModel(e,a.modelId)}clearGroup(e){for(;e.children.length>0;)this.clearGroup(e.children[0]),e.remove(e.children[0]);e.geometry&&e.geometry.dispose(),e.geometry=null;let t=e=>{Object.keys(e).forEach((t=>{e[t]&&null!==e[t]&&"function"==typeof e[t].dispose&&e[t].dispose()})),e.dispose(),e=null};e.material&&(e.material.length>0?(e.material.map((e=>{t(e)})),e.material.length=0):t(e.material),e.material=null)}clearNodes(){this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().clearNodes(),this.clearGroup(this._getNodeGroup()),this._getNodeGroup().clear(),this._clearNodeInfoMap(),this.meshes={},this.rawBoundingBoxMap={},this.customSelectMaterials={},this.objectIds=null,this.animationIds={},this.animationLength=0,this._cancelAnimate(),this._updateFilterManager(),this.filteredIds&&(this.filteredIds={},this.lastFilteredIds=Object.keys(this.filteredIds)),this.getModelManager().viewer.updateShadowMap(),this.bindModelMap={}}getAllNodes(){return this.meshes}getAllMeshes(){let e=[],t=i=>{r.Utils.isGroupObject(i)?i.children.forEach((function(i){r.Utils.isMeshObject(i)?e.push(i):t(i)})):e.push(i)};for(let e in this.meshes){this.meshes[e].forEach((e=>{t(e)}))}return e}setAccumulateTransform(e,t,i,r,n){if(this.floorExplosion&&n)n();else if(this._hasObjectId(e)){for(var a=this.meshes[e],s=0,o=a.length;s<o;s++){var l=a[s];this.setAccumulateTransformForMesh(l,t,i,r),l.box=l.originBox.clone().applyMatrix4(l.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setAccumulateTransform(e,t,i,r),this.getModelManager().viewer.updateShadowMap()}}setAccumulateOffset(e,t){if(this._hasObjectId(e)&&"[object Object]"===Object.prototype.toString.call(t)&&t.hasOwnProperty("x")&&t.hasOwnProperty("y")&&t.hasOwnProperty("z")){t instanceof THREE.Vector3||(t=new THREE.Vector3(t.x,t.y,t.z));var i=this.meshes[e];if(i.length>0){var r=i[0],n=t.applyQuaternion(r.quaternion);this.setAccumulateTransform(e,n)}}}setTransform(e,t,i,r,n,a){if(this.floorExplosion&&n)n();else if(this._hasObjectId(e)){for(var s=this.meshes[e],o=0,l=s.length;o<l;o++){var d=s[o];this.setTransformForMesh(d,t,i,r,a),d.box=d.originBox.clone().applyMatrix4(d.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setTransform(e,t,i,r,a),this.getModelManager().viewer.updateShadowMap()}}rotateOnBasePoint(e,t,i,r){if(!this._hasObjectId(e))return;var n=this.meshes[e];let a=new THREE.Vector3(t.x,t.y,t.z),s=new THREE.Vector3(i.x,i.y,i.z).normalize();for(var o=0,l=n.length;o<l;o++){let e=n[o],t=e.quaternion.clone().clone().invert(),i=e.position.clone(),l=(new THREE.Quaternion).setFromAxisAngle(s,r);e.quaternion.multiply(l);let d=a.clone().sub(i).applyQuaternion(t).applyQuaternion(e.quaternion);e.position.sub(d).add(a.clone().sub(i)),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().rotateOnBasePoint(e,a,s,r),this.getModelManager().viewer.updateShadowMap()}scaleOnBasePoint(e,t,i){if(!this._hasObjectId(e))return;var r=this.meshes[e];let n=new THREE.Vector3(t.x,t.y,t.z),a=new THREE.Vector3(i.x,i.y,i.z);for(var s=0,o=r.length;s<o;s++){let e=r[s];e.scale.multiply(a);let t=a.clone().sub(new THREE.Vector3(1,1,1)),i=e.quaternion.clone(),o=i.clone().invert(),l=e.position.clone(),d=n.clone().sub(l).applyQuaternion(o).multiply(t).applyQuaternion(i);e.position.sub(d),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().scaleOnBasePoint(e,n,a)}getTransform(e){if(!this._hasObjectId(e))return null;var t=this.meshes[e][0];let i=new THREE.Vector3,r=new THREE.Quaternion,n=new THREE.Vector3;return t.children.length>0?t.matrix.clone().multiply(t.children[0].matrix).decompose(i,r,n):t.matrix.decompose(i,r,n),{position:i,scale:n,rotate:r}}getGroupTransform(e){if(!this._hasObjectId(e))return null;var t=this.meshes[e][0];return{position:t.position,scale:t.scale,rotate:t.quaternion}}applyTransform(e,t,i,r){if(this._hasObjectId(e)){var n=this.getTransformMatrix(t,i,r);this.applyTransformMatrix(e,n),this.getModelManager().viewer.updateShadowMap()}}applyTransformMatrix(e,t,i){if(this._hasObjectId(e)){for(var r=this.meshes[e],n=0,a=r.length;n<a;n++){var s=r[n];this.updateMatrixWorldForMesh(s,t,i);var o=s.originBox.clone();s.box=o.applyMatrix4(s.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().applyTransformMatrix(e,t,i),this.getModelManager().viewer.updateShadowMap()}}getTransformMatrix(e,t,i){e=e||new THREE.Vector3,t=t||new THREE.Vector3(1,1,1),i=i||new THREE.Quaternion;var r=new THREE.Matrix4;return r.compose(e,i,t),r}setAccumulateTransformForMesh(e,t,i,r){t&&(e.position.x+=t.x,e.position.y+=t.y,e.position.z+=t.z),i&&(e.scale.x*=i.x,e.scale.y*=i.y,e.scale.z*=i.z),r&&(e.rotation.x+=r.x,e.rotation.y+=r.y,e.rotation.z+=r.z),e.updateMatrixWorld(),this.getModelManager().viewer.updateShadowMap()}setTransformForMesh(e,t,i,r,n){t=t||e.position,i=i||e.scale,r=r||e.quaternion;var a=this.getTransformMatrix(t,i,r);this.updateMatrixWorldForMesh(e,a,n),this.getModelManager().viewer.updateShadowMap()}updateMatrixWorldForMesh(e,t,i){var r;i?r=t:r=(e._oriMatrix?e._oriMatrix:new THREE.Matrix4).clone().premultiply(t);r.decompose(e.position,e.quaternion,e.scale),e.matrixAutoUpdate||e.matrix.copy(r),e.updateMatrixWorld(!0),this.getModelManager().viewer.updateShadowMap()}applyFilter(){this._hasNode()&&(this._collectFilteredIds(),this._collectSelectedIds(),this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}applySelection(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}clearSelection(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}applyHover(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}clearHover(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}applyBlink(){this._hasNode()&&(this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}clearBlink(){this._clearBlinkedIds(),this.applyHover()}getAllNodeInfos(){return this.nodeInfoMap}getNodeInfosByUserId(e){return this.nodeInfoMap?this.nodeInfoMap[e]:void 0}_addToNodeInfoMap(e){this.nodeInfoMap||(this.nodeInfoMap={}),this.nodeInfoMap[e.userId]||(this.nodeInfoMap[e.userId]=[]),this.nodeInfoMap[e.userId].push(e)}_removeFromNodeInfoMap(e){this.nodeInfoMap&&this.nodeInfoMap[e]&&delete this.nodeInfoMap[e]}_updateUserData(e,t){if(!this.nodeInfoMap)return;const i=this.nodeInfoMap[e];r.Utils.isDefined(i)&&(i.forEach((e=>{e.userData=Object.assign({},e.userData,t)})),this._updateFilterManager())}_clearNodeInfoMap(){this.nodeInfoMap={}}_updateFilterManager(){var e={};e[this.id]=this.getAllNodeInfos(),this.getFilter().reinitFilterManager(e)}checkVisibleComponentsBox(){var e=0;for(var t in this.meshes)for(var i=this.meshes[t],r=0;r<i.length;r++){var n=i[r];0!=n.children.length&&(e++,this.nodeInfoMap[t]&&this.nodeInfoMap[t][r]&&this.nodeInfoMap[t][r].boundingBox.isEmpty()&&this.nodeInfoMap[t][r].boundingBox.copy(n.box))}return 0!=e}_updateBoundingBoxByObjectId(e){if(this.nodeInfoMap&&this._hasObjectId(e)){var t,i,r=this.meshes[e],n=new THREE.Box3;for(t=0,i=r.length;t<i;t++)n.union(r[t].box);var a=this.nodeInfoMap[e];for(t=0,i=a.length;t<i;t++)a[t].boundingBox.copy(n)}}_canBePick(e){return!e._materialHold}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTERNALCOMPONENTMANAGER,{pickableType:r.PICKABLETYPE.ExternalComponent,globalSpace:!0})}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTERNALCOMPONENTMANAGER)}_cacheNodeMaterial(e,t){r.Utils.isGroupObject(e)?e.traverse((function(e){if(r.Utils.isMeshObject(e)&&!e._oriMaterial&&(e._oriRenderOrder=e.renderOrder,e._oriMaterial=e.material,e._materialHold=t,!e.geometry.index&&e.geometry.attributes&&e.geometry.attributes.position)){for(var i=[],n=0,a=e.geometry.attributes.position.array.length/3;n<a;n++)i.push(n);e.geometry.setIndex(new THREE.BufferAttribute(new Uint32Array(i),1))}})):e._oriMaterial||(e._oriRenderOrder=e.renderOrder,e._oriMaterial=e.material,e._materialHold=t)}_collectFilteredIds(){var e=this.filteredIds={},t=this.getFilter(),i=t._hasHiddenFileIdFilter(),n=t._hasVisibleFilter(),a=t._hasOverrideMaterialFilter(),s=t._hasTransparentFilter();if(i||n||a||s)for(var o=this.objectIds,l=r.EnumElementState,d=0,h=o.length;d<h;d++){var c=o[d],u={name:c};if(n&&!1===t._isVisible(u))e[c]||(e[c]={}),e[c][l.HIDDEN]=!0;else if(s&&t._isTransparent(u))e[c]||(e[c]={}),e[c][l.TRANSPARENT]=!0;else if(a&&t._hasOverrideMaterial(u)){var p=t._getOverrideMaterial(u),m=null!=p?p.name:"";e[c]||(e[c]={}),e[c][l.OVERRIDED]=m}else;}}_collectSelectedIds(){var e=this.filteredIds=this.filteredIds||{},t=r.EnumElementState,i=this.getModelManager().sceneState.getSelection(),n={};this._clearSelectedIds();for(var a=0,s=i.length;a<s;a++){var o=i[a];this.canBeSelectedId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,n[o]=!0)}this.selectedIds=Object.keys(n)}_clearSelectedIds(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var i=this.selectedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.EnumElementState.SELECTED]}this.selectedIds=null}}_collectHoveredIds(){this._clearHoveredIds();var e=this.getModelManager().sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][r.EnumElementState.HOVER]=!0}}_clearHoveredIds(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][r.EnumElementState.HOVER],this.hoveredId=void 0)}_collectBlinkedIds(){var e=this.manager.sceneState.getBlinkComponentsIdMap(this.id),t=this.filteredIds=this.filteredIds||{},i=r.EnumElementState,n={};for(var a in this._clearBlinkedIds(),e)this._hasObjectId(a)&&(t[a]||(t[a]={}),t[a][i.BLINK]=!0,n[a]=!0);this.blinkedIds=Object.keys(n)}_clearBlinkedIds(){if(this.filteredIds&&this.blinkedIds&&this.blinkedIds.length){for(var e=0,t=this.blinkedIds.length;e<t;e++){var i=this.blinkedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.EnumElementState.BLINK]}this.blinkedIds=null}}_hasObjectId(e){var t=this.meshes[e];return!(!t||!t.length)}canBeSelectedId(e){var t=this.meshes[e];return!(!t||t[0].disPickable)}_hasNode(){return!(!this.objectIds||!this.objectIds.length)}_traverseNodeById(e,t){if(this._hasObjectId(e))for(var i=this.meshes[e],n=0,a=i.length;n<a;n++){var s=i[n];r.Utils.isGroupObject(s)?s.traverseVisible((function(e){r.Utils.isMeshObject(e)&&t&&t(e)})):r.Utils.isMeshObject(s)&&t&&t(s)}}_resetNodeMaterial(){var e=this.lastFilteredIds;if(e&&e.length)for(var t=0,i=e.length;t<i;t++)this._updateNodeVisible(e[t],!0),this._traverseNodeById(e[t],(function(e){e.material=e._oriMaterial,e.renderOrder=e._oriRenderOrder}))}_updateNodeVisible(e,t){for(var i=this.meshes[e],r=0,n=i.length;r<n;r++)i[r].groundCurve?!0===t?i[r].show():i[r].hide():i[r].visible=t}updateSelectEffect(){for(let t in this.meshes){var e=this.meshes[t];e[0]._geometryUpdated&&(this.getPickingNodeGenerator().removeNodeById(t),this.getPickingNodeGenerator().addNode(t,e),e[0]._geometryUpdated=!0)}}_updateNodeById(e,t){if(this._hasObjectId(e)){var i=this,n=this.hoveredRenderOrder,a=this.getModelManager().sceneState,s=r.EnumElementState,o=this.filteredIds[e];if(o)if(o[s.HIDDEN])this._updateNodeVisible(e,!1);else if(o[s.TRANSPARENT]){var l=t._getMaterialByName("scene");this._traverseNodeById(e,(function(e){if(!i._canBePick(e))return;const t=e.material.length;if(t>0)for(let i=0;i<t;++i)e._oriMaterial[i]instanceof r.CloudStandardMaterial?e.material[i]=l:e.material[i]=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial[i],l);else e._oriMaterial instanceof r.CloudStandardMaterial?e.material=l:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,l)}))}else if(this._isPickingEffectEnabled()||!o[s.SELECTED])if(o[s.BLINK])if(o[s.OVERRIDED]){var d=t._getMaterialByName(o[s.OVERRIDED]),h=a.getBlinkMaterial(d,this.id);this._traverseNodeById(e,(function(e){var t=!1;if(e._oriMaterial instanceof r.CloudStandardMaterial)t=!0,e.material=h;else{var n=r.Blink.MaterialFactory[e._oriMaterial.type];n?(t=!0,e.material=i.blinkOriginMaterialMap[e.uuid]||n(),e.material.copy(e._oriMaterial)):e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,d)}var a=e.material.uuid;t&&void 0===i.blinkMaterialMap[a]&&(i.blinkMaterialMap[a]=!0,i.blinkOriginMaterialMap[e.uuid]=e.material,i.blinkMaterials.push(e.material))}))}else this._traverseNodeById(e,(e=>{var t=!1;if(e._oriMaterial instanceof r.CloudStandardMaterial)t=!0,e.material=a.getBlinkMaterial(e._oriMaterial,this.id);else{var n=r.Blink.MaterialFactory[e._oriMaterial.type];n&&(t=!0,e.material=i.blinkOriginMaterialMap[e.uuid]||n(),e.material.copy(e._oriMaterial))}var s=e.material.uuid;t&&void 0===i.blinkMaterialMap[s]&&(i.blinkMaterialMap[s]=!0,i.blinkOriginMaterialMap[e.uuid]=e.material,i.blinkMaterials.push(e.material))}));else if(o[s.HOVER])if(o[s.OVERRIDED]){l=a.getHoverMaterial(t._getMaterialByName(o[s.OVERRIDED]));this._traverseNodeById(e,(function(e){if(!i._canBePick(e))return;e.renderOrder=n;const t=e.material.length;if(t>0)for(let i=0;i<t;++i)e._oriMaterial[i]instanceof r.CloudStandardMaterial?e.material[i]=l:e.material[i]=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial[i],l);else e._oriMaterial instanceof r.CloudStandardMaterial?e.material=l:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,l)}))}else this._traverseNodeById(e,(function(e){if(i._canBePick(e)){e.renderOrder=n;var t=a.getHoverMaterial(e._oriMaterial);e._oriMaterial instanceof r.CloudStandardMaterial?e.material=t:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,t)}}));else if(o[s.OVERRIDED]){var c=t._getMaterialByName(o[s.OVERRIDED]);this._traverseNodeById(e,(function(e){if(!i._canBePick(e))return;const t=e.material.length;if(t>0)for(let i=0;i<t;++i)e._oriMaterial[i]instanceof r.CloudStandardMaterial?e.material[i]=c:e.material[i]=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial[i],c),e._oriMaterial[i].useCSM&&null===e.material[i].uniforms.csmCascades.value&&(e.material[i].uniforms.csmCascades=e._oriMaterial[i].uniforms.csmCascades,e.material[i].defines.CSM_CASCADES=e._oriMaterial[i].defines.CSM_CASCADES);else e._oriMaterial instanceof r.CloudStandardMaterial?e.material=c:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,c),e._oriMaterial.useCSM&&null===e.material.uniforms.csmCascades.value&&(e.material.uniforms.csmCascades=e._oriMaterial.uniforms.csmCascades,e.material.defines.CSM_CASCADES=e._oriMaterial.defines.CSM_CASCADES)}))}else;else{var u=a.selectionMaterial,p=this.customSelectMaterials[e];this._traverseNodeById(e,(function(e){i._canBePick(e)&&(p?e.material=p:e._oriMaterial.isMeshPhongMaterial?(e.material=a.phongSelectionMaterial,e.material.skinning=e._oriMaterial.skinning):e._oriMaterial instanceof r.CloudStandardMaterial?e.material=u:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,u))}))}}}_updateNodes(){var e=this.getFilter();if(this._resetNodeMaterial(),this.blinkMaterialMap={},this.blinkMaterials.length=0,this.filteredIds){for(var t in this.filteredIds)this._updateNodeById(t,e);this.lastFilteredIds=Object.keys(this.filteredIds)}}_initializeAutoAnimation(e,i){var n=this.getModelManager().viewer;if(e.autoAnimation){if("fire"==e.type){var a=r.GlobalData.SceneSize,s=n.getBoundingBoxWorld().getSize(t),o=a/Math.max(s.x,s.y,s.z);e._initializeSizetween(o)}this._initializeAnimation(i)}}_initializeAnimation(e){this.firstAnimation&&(this._clock=new THREE.Clock,this._animate(),this.firstAnimation=!1),this.animationIds[e]=!0,this.animationLength++}play(e,t=0){if(this.actions[e]||(this.actions[e]=[]),!this.actions[e][t]){let i=this.getNodeById(e),r=new THREE.AnimationMixer(i);this.actions[e][t]=r.clipAction(i.animations[t]),this.mixers[e]||(this.mixers[e]=[]),this.mixers[e][t]=r,this._initializeAnimation(e,t)}this.activeMixerIndex[e]&&this.stop(e),this.activeMixerIndex[e]=t,this.actions[e][t].play(),this.actions[e][t].paused=!1}pause(e,t){void 0===t&&(t=this.activeMixerIndex[e]),void 0!==t&&this.actions[e]&&this.actions[e][t]&&(this.actions[e][t].paused=!0)}stop(e,t){void 0===t&&(t=this.activeMixerIndex[e]),void 0!==t&&this.actions[e]&&this.actions[e][t]&&(this.actions[e][t].paused=!1,this.actions[e][t].stop())}isAnimation(e){let t=this.getNodeById(e);return!!(t.animations&&t.animations.length>0)}_animate(){var e=this,t=this.getModelManager().viewer;!function i(){e.animationId=requestAnimationFrame(i);var r=e._clock.getDelta(),n=(JSON.parse(t.getCamera()),0);for(var a in e.meshes){var s=e.meshes[a];if(e.mixers[a]&&void 0!==e.activeMixerIndex[a])e.mixers[a][e.activeMixerIndex[a]].update(r);for(var o=0,l=s.length;o<l;o++)s[o].autoAnimation?s[o].update&&s[o].update():s[o].updateMatrixWorld(),null!=s[o].unrender&&0!=s[o].unrender||n++}n>0&&t.render()}()}_cancelAnimate(){this.firstAnimation=!0,cancelAnimationFrame(this.animationId),this.animationId=0}explodeMesh(e,t,i,r,n){let a,s,o,l;const d=t=>{a=e.explodedHeight=t.explodedHeight-t.elevation,s=e.explodedDirection=(t.explodedDirection||new THREE.Vector3).clone(),o=e.preExplodedHeight=t.preExplodedHeight-t.elevation,l=e.preExplodedDirection=(t.preExplodedDirection||new THREE.Vector3).clone()};let h=0;for(let t=i.length-1;t>=0;t--){let a=i[t];if(n){if(a.name==n){d(a);break}}else{let n=i[t].preExplodedTranslation?i[t].preExplodedTranslation.z:0;if(h=r?i[t].boundingBox.min.z:n+i[t].boundingBox.min.z,c=h,e.position.z>=c-1||0===t){d(a);break}}}var c;let u=new THREE.Matrix4;const p=s.clone().multiplyScalar(a).sub(l.clone().multiplyScalar(o));u.makeTranslation(p.x,p.y,p.z),e.applyMatrix4(u),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix),t.applyMatrix4(u),t.updateMatrixWorld()}explode(e){const t=e.id;if(!t)return;let i=this.bindModelMap[t];if(!i)return;let r=Object.keys(i),n=this.getModelManager().explosionManager.getFloorInfos(t);for(let t=0;t<r.length;t++){let a=r[t],s=i[a],o=-1!=s?e.modelExplosion.getLevelNameByObjId(s):null,l=this.meshes[a];if(!l)continue;let d=this.getPickingNodeGenerator().pickingNodeMap[a];for(let e=0;e<l.length;e++){let t=l[e],i=d[e];this.explodeMesh(t,i,n,void 0,o)}this._updateBoundingBoxByObjectId(a)}}elementExplode(e,t,i){let n=e.id;if(!n)return;let a=this.bindModelMap[n];if(!a)return;let s=Object.keys(a),o=new THREE.Matrix4;for(let n=0;n<s.length;n++){let l=s[n],d=a[l],h=this.meshes[l];if(!h)continue;let c=this.getPickingNodeGenerator().pickingNodeMap[l];for(let n=0;n<h.length;n++){let a=h[n],s=c[n];a.elementExplodeBox||(a.elementExplodeBox=a.box);let l=-1!=d?e.modelExplosion.getExplosionTranslationByObjId(d):r.Utils.computeExplodeTranslation(i,a.elementExplodeBox,t);o.makeTranslation(l.x,l.y,l.z),a.applyMatrix4(o),a.updateMatrixWorld(),a.box=a.originBox.clone().applyMatrix4(a.matrix),s.applyMatrix4(o),s.updateMatrixWorld()}this._updateBoundingBoxByObjectId(l)}}isPickableNode(e){if(!this.canBeSelectedId(e.userId))return!1;var t=this.getFilter();return!t._isHiddenFileId(e)&&!1!==t._isVisible(e)&&!t._isTransparent(e)}hasTransforms(){return!1}isUserIdExist(e){return!!this.meshes[e]}_isPickingEffectEnabled(){return!!r.GlobalData.PickingEffect}getPickingNodeGenerator(e){if(e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingExternalMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),"pick"==e||null==this.pickingNodeGenerators.pick.pickingNodeMap||null!=this.pickingNodeGenerators[e].pickingNodeMap&&!this._checkDirtyData(this.pickingNodeGenerators.pick.pickingNodeMap,this.pickingNodeGenerators[e].pickingNodeMap)){if("pick"!=e&&null!=this.pickingNodeGenerators.pick.pickingNodeMap&&null!=this.pickingNodeGenerators[e].pickingNodeMap)for(o=0;o<this.pickingNodeGenerators[e].pickingNodeGroup.children.length;o++){var t=this.pickingNodeGenerators[e].pickingNodeGroup.children[o].name;if(this.pickingNodeGenerators[e].manager.meshes[t]&&this.pickingNodeGenerators[e].manager.meshes[t].length>0){var i=this.pickingNodeGenerators[e].manager.meshes[t][0];this.pickingNodeGenerators[e].pickingNodeGroup.children[o].rotation.copy(i.rotation),this.pickingNodeGenerators[e].pickingNodeGroup.children[o].position.copy(i.position),this.pickingNodeGenerators[e].pickingNodeGroup.children[o].scale.copy(i.scale)}}}else for(var n=this.pickingNodeGenerators[e],a=this.pickingNodeGenerators.pick.pickingNodeMap,s=Object.keys(a),o=0;o<s.length;o++)n.addToPickingNodeMap(s[o],[a[s[o]][0]]);return this.pickingNodeGenerators[e]}_checkDirtyData(e,t){for(var i=Object.keys(e),r=0;r<i.length;r++)if(null==t[i[r]])return!0;return!1}getPickingMeshes(e,t,i,r,n){var a=this.getPickingNodeGenerator(n).updatePickingMeshes(e,i,r);a&&(t[this.databagId]=a)}getBoundingBoxById(e){return this.isUserIdExist(e)?this.nodeInfoMap[e][0].boundingBox:new THREE.Box3}getBlinkMaterials(){return this.blinkMaterials}getBoundaryPoints(e){let t=this.rawBoundingBoxMap[e],i=this.getGroupTransform(e);const r=(new THREE.Matrix4).compose(i.position,i.rotate,i.scale),n=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return n[0].set(t.min.x,t.min.y,t.min.z).applyMatrix4(r),n[1].set(t.max.x,t.min.y,t.min.z).applyMatrix4(r),n[2].set(t.max.x,t.max.y,t.min.z).applyMatrix4(r),n[3].set(t.min.x,t.max.y,t.min.z).applyMatrix4(r),n[4].set(t.min.x,t.min.y,t.max.z).applyMatrix4(r),n[5].set(t.max.x,t.min.y,t.max.z).applyMatrix4(r),n[6].set(t.max.x,t.max.y,t.max.z).applyMatrix4(r),n[7].set(t.min.x,t.max.y,t.max.z).applyMatrix4(r),n}getAllNodeGroups(){return this._getNodeGroup().children}collectBlinkedMaterial(e,t){t.push(...this.blinkMaterials)}getBoundingBoxWorld(){const e=new THREE.Box3;return this.nodeInfoMap&&Object.values(this.nodeInfoMap).forEach((t=>{t.forEach((t=>t.boundingBox instanceof THREE.Box3&&e.union(t.boundingBox)))})),e}}r.ExternalComponentManager=i})(),function(){r.ExternalObjectConverter=class{constructor(e){this.viewer=e,this.geometryMapFromComponentId={},this.externalObjectMap={},this.defaultMaterial=r.MaterialUtil.getDefaultStandardMaterial()}destroy(){this.viewer=null,this.geometryMapFromComponentId=null,this.externalObjectMap=null,this.defaultMaterial=null}clear(){this.geometryMapFromComponentId={},this.externalObjectMap={},this.cancelAllHidden()}cancelHiddenByComponentId(e){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelHiddenByUserId(e)}cancelAllHidden(){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelAllHidden()}convertToExternalObject(e,t,i){if("[object Object]"!==Object.prototype.toString.call(t))t=this.viewer.modelManager.filterHelper.distributeId(t);else if(!this.viewer.modelManager.getModel(t.modelId))return null;return this._hideByUserId(t,i),this.externalObjectMap[e]?this.externalObjectMap[e].clone():(this.externalObjectMap[e]=this._createMeshNodes(e,t),this.viewer.modelManager.forceUpdateGTAOPass(),this.externalObjectMap[e])}getExternalObject(e){return this.externalObjectMap[e]}_hideByUserId(e,t){this.viewer.setRenderStateChanged(!0);var{modelId:i,objectId:r}=e;const n=function(e){if(e.tilesLoader){const t=e.tilesLoader.tileReader.getIndexByUserId(r);void 0!==t&&(r=t,e.filter.enableStateChanged(),e.filter.enableWireFrameStateChanged(),i=e.id)}else e.isUserIdExist(r)&&(i=e.id)};i?n(this.viewer.modelManager.getModel(i)):this.viewer.modelManager.traverseModels(n),this.viewer.modelManager.getSourceObjectManager().hideByUserId(r,t,i)}_getGeometries(e){var{modelId:t,objectId:i}=e,n=this.geometryMapFromComponentId[`${t}_${i}`];if(n)return n;var a=[];if(t){var s=this.viewer.modelManager.getModel(t);if(s._handler)a=a.concat(s._handler.getGeometryBuffersByUserId(i));else if(s.tilesLoader){const e=s.tilesLoader.tileReader.getIndexByUserId(i);a=a.concat(s.getGeometryBuffersByUserId(e))}}else this.viewer.modelManager.traverseModels((function(e){if(e._handler)a=a.concat(e._handler.getGeometryBuffersByUserId(i));else if(e.tilesLoader){const t=e.tilesLoader.tileReader.getIndexByUserId(i);if(!r.Utils.isDefined(t))return;a=a.concat(e.getGeometryBuffersByUserId(t))}}));return n=this.geometryMapFromComponentId[`${t}_${i}`]=this._createGeometry(a)}_createGeometry(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i],a=new THREE.BufferGeometry;if(a.setIndex(new THREE.BufferAttribute(n.index,1)),a.setAttribute("position",new THREE.BufferAttribute(n.position,3)),n.uv&&a.setAttribute("uv",new THREE.BufferAttribute(n.uv,2)),n.uv3&&a.setAttribute("uv3",new THREE.BufferAttribute(n.uv3,2)),n.isLines||a.computeVertexNormals(),n.color){const e=new THREE.Uint8BufferAttribute(n.color,4);e.normalized=!0,a.setAttribute("color",e)}if(n.id){const e=new THREE.Uint8BufferAttribute(n.id,4);e.normalized=!0,a.setAttribute("id",e)}if(n.vState){const e=new THREE.Float32BufferAttribute(n.vState,4);a.setAttribute("vState",e)}if(n.barycentric){const e=new THREE.Float32BufferAttribute(n.barycentric,3);a.setAttribute("barycentric",e)}if(n.pointColorState){const e=new THREE.Uint8BufferAttribute(n.pointColorState,4);e.normalized=!0,a.setAttribute("pointColorState",e)}t.push({info:n,geometry:a})}return t}_createMeshNodes(t,i){var r=new e;r.matrixGroup=[],r.name=t,r.sourceComponentId=i;for(var n=this._getGeometries(i),a=0,s=n.length;a<s;a++){var o=n[a].geometry,l=n[a].info,{objectId:d}=i;let e=null,t=this.viewer.modelManager.modelCollection.getById(l.databagId);if(t&&t.tilesLoader){let i;if(l.isInstance){const e=t.tilesLoader.getInstanceMeshNodeById(l.nodeId);if(!0===e.isMesh)i=e;else for(const t of e.values())i=t.mesh}else i=t.tilesLoader.getMeshNodeById(l.nodeId);const r=i.material[0]||i.material;e=null==i?this.defaultMaterial:"cloudStandardInstanceV3"===r.type2?r.toStandardMaterial():r.clone(),e.forInstance=!1}else e=this.viewer.modelManager.getMaterialByNodeId(l.databagId,d,l.nodeId)||this.defaultMaterial;var h=new THREE.Mesh(o,e);h=l.isLines?new THREE.LineSegments(o,e):new THREE.Mesh(o,e),delete e.defines.CNORMAL,delete e.defines.USE_INSTANCE,delete e.defines.USE_INSTANCE_NORMAL,h._databagId=l.databagId,h._nodeId=l.nodeId,h._oriUserId=i,h._oriMaterial=e,h._cloned=!0;let s=t.transformMatrix;l.matrix?(h.matrix.copy(l.matrix),h.matrix.premultiply(s),h._modelMatrix=s.clone(),h.matrix.decompose(h.position,h.quaternion,h.scale)):s&&(h.matrix.copy(s),h._modelMatrix=s.clone(),h.matrix.decompose(h.position,h.quaternion,h.scale)),r.add(h)}return r}getModelLengthUnitsMatrix(e){return e?this.viewer.modelManager.getModelLengthUnitsMatrix(e):void 0}};class e extends THREE.Group{constructor(){super(),this.sourceComponentId=null}clone(e){return(e=super.clone(e)).sourceComponentId=this.sourceComponentId,e}}r.ExternalObjectConverterGroup=e}(),function(){let e,t=new THREE.Matrix4;r.GroundPrimitiveManager=class{constructor(e){this.viewer=e,this.groundCurveScene=new THREE.Scene,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.depthWithoutDEMRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.polygonClimpGroundMatchRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.polygonClimpGroundMatchRenderTarget.depthBuffer=!0,this.polygonClimpGroundMatchRenderTarget.stencilBuffer=!0,this.polygonClimpGroundColorRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.polygonClimpGroundColorRenderTarget.depthBuffer=!0,this.polygonClimpGroundColorRenderTarget.stencilBuffer=!0,this.polygonOnlyClimpGroundColorRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.polygonOnlyClimpGroundColorRenderTarget.depthBuffer=!0,this.polygonOnlyClimpGroundColorRenderTarget.stencilBuffer=!0,this.externalGroupOriginVisible=[],this.shadowVolumes=[],this.shadowVolumeScene=new THREE.Scene,this.backMaterial=new THREE.MeshBasicMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.frontMaterial=new THREE.MeshBasicMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.doubleMaterial=new THREE.MeshBasicMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.DoubleSide}),this.inVisibleModelIdMap=void 0,this.inVisibleGroupMap={},this.inVisibleModelIdMapForGroundCurve=void 0,this.inVisibleGroupMapForGroundCurve={},this.groundMinHeight=void 0,this.ifPolygonOnlyClampDEM=!0,this.polygonOnlyClampDEMArryNum=0,this.polygonOnlyClampDEM=[],this.polygonClampModel=!0,this.polygonClampModelArryNum=0,this.polygonClampModelSceneModels=[],this.splineCurveOriginOpacityVector=[],this.groundPlaneSceneModel=[],this.isFirstAdd=!0}destroy(){this.groundCurveScene=null,this.depthRenderTarget=null,this.depthWithoutDEMRenderTarget=null,this.polygonClimpGroundMatchRenderTarget=null,this.polygonClimpGroundColorRenderTarget=null,this.polygonOnlyClimpGroundColorRenderTarget=null,this.shadowVolumes=null,this.shadowVolumeScene=null,this.backMaterial.dispose(),this.backMaterial=null,this.frontMaterial.dispose(),this.frontMaterial=null,this.doubleMaterial.dispose(),this.doubleMaterial=null,this.inVisibleModelIdMap=null,this.inVisibleGroupMap=null,this.inVisibleModelIdMapForGroundCurve=null,this.inVisibleGroupMapForGroundCurve=null,this.viewer=null,this.ifPolygonOnlyClampDEM=!0,this.polygonOnlyClampDEMArryNum=0,this.polygonOnlyClampDEM=[],this.polygonClampModel=!0,this.polygonClampModelArryNum=0,this.polygonClampModelSceneModels=[],this.splineCurveOriginOpacityVector=null,this.groundPlaneSceneModel=null,this.isFirstAdd=!0}createGroundCurve(e){var t=e.color,i=e.width;e.viewer=this.viewer;var n=new r.GroundCurveMaterial({color:new THREE.Color(t.red/255,t.green/255,t.blue/255)});n.side=THREE.DoubleSide,n.depthFunc=THREE.AlwaysDepth,n.depthWrite=!1,n.transparent=!0,n.blending=THREE.NormalBlending,n.opacity=t.alpha,n.lineWidth=i;var a=new r.GroundCurveGeometry(e),s=new r.GroundCurveMesh(a,n);s.setViewer(this.viewer);var o=this;return s.onBeforeRender=function(e,t,i,r,n,a){var s=n.frustumPlanes;s.x=i.near*Math.tan(.5*THREE.Math.degToRad(i.fov)),s.y=-s.x,s.w=i.aspect*s.x,s.z=-s.w,n.cameraNear=i.near,n.cameraFar=i.far,n.pixelRatio=e.getPixelRatio(),n.viewport.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight);var l,d=n.viewport,h=THREE.Math.degToRad(i.fov);l=h?d.w>d.z?2*Math.tan(.5*h)/d.w:2*Math.tan(.5*h)/d.z:1/Math.max(d.z,d.w),n.geometricToleranceOverMeter=2*l,n.cameraProjection.copy(i.projectionMatrix),n.inverseProjection.copy(i.projectionMatrix).invert(),n.globeDepthTexture=o.depthRenderTarget.texture,n.customDepthTexture=o.depthWithoutDEMRenderTarget.texture,n.refreshUniforms()},s}removeGroundCurve(e){this.groundCurveScene.remove(e),0===this.groundCurveScene.children.length&&(this.inVisibleModelIdMapForGroundCurve=void 0)}addGroundCurve(e){this.groundCurveScene.add(e)}beforeRender(){if(!this.inVisibleModelIdMap)return;this.inVisibleGroupMap={};const e=this.viewer.getScene();for(const t in this.inVisibleModelIdMap){const i=`${r.ObjectGroupType.BIMTILESGROUP}|${t}`,n=e.getObjectGroup(i);n&&(this.inVisibleGroupMap[i]=n.visible,n.visible=!1)}}afterRender(e,t){if(!this.inVisibleModelIdMap)return;const i=this.viewer.getScene();for(const e in this.inVisibleGroupMap){const t=i.getObjectGroup(e);t&&(t.visible=this.inVisibleGroupMap[e])}}beforeRenderForGroundCurve(){if(!this.inVisibleModelIdMapForGroundCurve)return;this.inVisibleGroupMapForGroundCurve={};const e=this.viewer.getScene();for(const t in this.inVisibleModelIdMapForGroundCurve){const i=`${r.ObjectGroupType.BIMTILESGROUP}|${t}`,n=e.getObjectGroup(i);n&&(this.inVisibleGroupMapForGroundCurve[i]=n.visible,n.visible=!1)}}afterRenderForGroundCurve(e,t){if(!this.inVisibleModelIdMapForGroundCurve)return;const i=this.viewer.getScene();for(const e in this.inVisibleGroupMapForGroundCurve){const t=i.getObjectGroup(e);t&&(t.visible=this.inVisibleGroupMapForGroundCurve[e])}}hasGroundCurve(){const e=this.groundCurveScene;if(e.children.length<=0)return!1;for(let t=0;t<e.children.length;t++)if(e.children[t].visible)return!0;return!1}setExternalGroupOriginVisible(){let e=!1;e=this.hasGroundCurve();let t=this._getExternalObjectGroup();if(t&&e){this.externalGroupOriginVisible.splice(0,this.externalGroupOriginVisible.length);for(let e=0;e<t.children.length;e++){let i=t.children[e];this.externalGroupOriginVisible.push(i.visible)}}}setGroundCurve(e){e||this.setExternalGroupOriginVisible();let t=!1;t=this.hasGroundCurve();let i=this._getExternalObjectGroup();if(i&&t)for(let t=0;t<i.children.length;t++){let r=i.children[t];r instanceof Glodon.Bimface.Plugins.Geometry.SplineCurve||r instanceof Glodon.Bimface.Plugins.Geometry.Plane&&(r.visible=e)}}render(e,t,i){i=null==i?null:i,this.renderGroundCurves(e,t,i),this.renderPolygonClampGround(e,t,i)}renderPolygonClampGround(e,t,i){this.renderPolygonOnlyClampGround(e,t,i),this.renderPolygonClampGroundByConditions(e,t,i)}_getExternalObjectGroup(){return this.viewer.getScene().getObjectGroup("ExternalComponentManager")}_hideExternalPlanes(){let e=this._getExternalObjectGroup();if(e)for(let t=0;t<e.children.length;t++){let i=e.children[t];i instanceof Glodon.Bimface.Plugins.Geometry.Plane&&(i.visible=!1)}}_hideExternalObjectsExcludePlanes(){let e=this._getExternalObjectGroup();if(e)for(let t=0;t<e.children.length;t++){let i=e.children[t];i instanceof Glodon.Bimface.Plugins.Geometry.Plane||(i.visible=!1)}}_restoreVisibilityForExternalObjects(){let e=this._getExternalObjectGroup();if(e)for(let t=0;t<e.children.length;t++){e.children[t].visible=this.externalGroupOriginVisible[t]}}_hideObjectGroupOfModels(){let e={};return this.viewer.modelManager.modelCollection.traverse((t=>{const i=t.objectGroup||t.ObjectGroup||t._rootNodeGroup;i&&(e[t.id]=i.visible,i.visible=!1)})),e}_restoreVisibilityForModels(e){this.viewer.modelManager.modelCollection.traverse((t=>{if(e.hasOwnProperty(t.id)){const i=t.objectGroup||t.ObjectGroup||t._rootNodeGroup;i&&(i.visible=e[t.id])}}))}_getVisibleModelIdMapForGroundCurves(){const e=this.groundCurveScene;let t={},i=[],n=!1;for(let a=0,s=e.children.length;a<s;a++){const s=e.children[a],o=s.inVisibleModelIdMap;if(s.visible)if(o&&!r.Utils.isOwnEmptyObject(o)){n=!0;for(const e in o)Object.hasOwnProperty.call(o,e)&&(t[e]||(t[e]=[]),t[e].push(s))}else i.push(s)}return n&&i.length&&(t.others=i),n?t:void 0}_hideGroundCurvesExcluded(e){const t=this.groundCurveScene;let i=[];for(let r=0,n=t.children.length;r<n;r++){const n=t.children[r];if(!n.visible)continue;e.find((e=>e===n))||(i.push({mesh:n,visible:n.visible}),n.visible=!1)}return i}_restoreVisibilityForGroundCurves(e){e.forEach((e=>{e.mesh.visible=e.visible}))}_renderGroundCurvesWithCustomDepth(e,t,i,r){const n=this.viewer.rendererManager.renderer;if(n.renderCustomDepth&&n.renderCustomDepth(e,t,i,this.depthRenderTarget,!1),!n.renderCustomDepthWithoutDEM)return!1;n.renderCustomDepthWithoutDEM(e,t,i,this.depthWithoutDEMRenderTarget);const a=this._getVisibleModelIdMapForGroundCurves();if(!a)return!1;let s=!1;for(const o in a)if(Object.hasOwnProperty.call(a,o)){if("others"===o){s=!0;continue}const l=a[o],d=this._hideGroundCurvesExcluded(l);let h={};h[o]=!0,n.renderCustomDepthByVisibleModels(e,t,i,this.depthWithoutDEMRenderTarget,h),this._renderGroundCurveSceneOnly(e,i,r),n.renderCustomDepthByVisibleModels(e,t,i,this.depthWithoutDEMRenderTarget,h,!0),this._restoreVisibilityForGroundCurves(d)}if(s){const t=a.others,n=this._hideGroundCurvesExcluded(t);this._renderGroundCurveSceneOnly(e,i,r),this._restoreVisibilityForGroundCurves(n)}return!0}_renderGroundCurveSceneOnly(e,t,i){const r=this.groundCurveScene,n=e.autoClear;e.autoClear=!1;const a=e.getRenderTarget();e.setRenderTarget(i),e.render(r,t),e.autoClear=n,e.setRenderTarget(a)}_renderExternalPlanes(e,t,i){let r=this._hideObjectGroupOfModels();this._hideExternalObjectsExcludePlanes(),e.autoClear=!1,e.render(t,i),this._restoreVisibilityForExternalObjects(),this._restoreVisibilityForModels(r),r=null}renderGroundCurves(e,t,i){if(!this.hasGroundCurve())return;this._hideExternalPlanes();const r=e.autoClear,n=this.viewer.getScene();this._renderGroundCurvesWithCustomDepth(e,n,t,i)||this._renderGroundCurveSceneOnly(e,t,i),this._restoreVisibilityForExternalObjects(),this._renderExternalPlanes(e,n,t),e.autoClear=r}renderPolygonClampGroundByConditions(e,t,i){if(this.shadowVolumes.length<=0)return;let n=e.autoClear;e.autoClear=!1;let a=e.getRenderTarget(),s=this.shadowVolumeScene,o=this.backMaterial,l=this.frontMaterial,d=e.getContext(),h=e.state;h.buffers.stencil.setTest(!0);for(let n=0;n<this.shadowVolumes.length;n++){let a=this.shadowVolumes[n];if(!a.visible)continue;if(1==a.clampMode)continue;s.add(a),h.buffers.stencil.setLocked(!0),h.buffers.stencil.setFunc(d.ALWAYS,0,255),h.buffers.stencil.setOp(d.KEEP,d.INCR,d.KEEP),s.overrideMaterial=o,e.setRenderTarget(i),e.render(s,t),h.buffers.stencil.setFunc(d.ALWAYS,0,255),h.buffers.stencil.setOp(d.KEEP,d.DECR,d.KEEP),s.overrideMaterial=l,e.render(s,t),s.remove(this.shadowVolumes[n]);let g=this.polygonClampModelSceneModels;this.polygonClampModelArryNum!=this.viewer.modelManager.modelCollection._layers.length&&(this.polygonClampModelArryNum=this.viewer.modelManager.modelCollection._layers.length,this.polygonClampModel=!0),this.polygonClampModel&&(this.polygonClampModel=!1,this.viewer.modelManager.traverseValidModels((function(e){function t(e,t){let i=!1;for(let r=0;r<e.length;r++)if(e[r].parentmodel.id==t.id){i=!0;break}return i}if(!e.isDemLayer)if(e.objectGroup){if(!t(g,e)){let t={parentmodel:e,objectGroup:e.objectGroup,parent:e.objectGroup.parent,isOsgb:e.isOsgb};g.push(t)}}else if(e._rootNodeGroup){if(!t(g,e)){let t={parentmodel:e,objectGroup:e._rootNodeGroup,parent:e._rootNodeGroup.parent,isOsgb:e.isOsgb};g.push(t)}}else if(e.ObjectGroup&&!t(g,e)){let t={parentmodel:e,objectGroup:e.ObjectGroup,parent:e.ObjectGroup.parent,isOsgb:e.isOsgb};g.push(t)}})));var c=this.viewer.getScene().getRawMatrixGlobal(),u=(t=this.viewer.cameraControl.getCamera(),this.viewer.cameraControl.getCameraName()),p=new r.CameraInfo(u,t.position,t.target,t.realUp||t.up),m=(p=r.Camera.drawingToWorld(p,c)).position.clone().sub(p.target);m.normalize();var f=new THREE.Vector3(.5,.5,.5);if(m.multiply(f),a.visibleModelIdMap)for(let e=0;e<g.length;e++){let t=g[e],i=t.parentmodel.id;if(a.visibleModelIdMap.hasOwnProperty(i)){if(t.isOsgb){let e=t.parentmodel.getTransformMatrix();e.elements[12]=e.elements[12]+m.x,e.elements[13]=e.elements[13]+m.y,e.elements[14]=e.elements[14]+m.z,t.parentmodel.setTransformMatrix(e),t.parentmodel.updateMatrix()}s.add(t.objectGroup)}}else for(let e=0;e<g.length;e++){let t=g[e];if(t.isOsgb){let e=t.parentmodel.getTransformMatrix();e.elements[12]=e.elements[12]+m.x,e.elements[13]=e.elements[13]+m.y,e.elements[14]=e.elements[14]+m.z,t.parentmodel.setTransformMatrix(e),t.parentmodel.updateMatrix()}s.add(t.objectGroup)}if(h.buffers.stencil.setFunc(d.EQUAL,1,255),h.buffers.stencil.setOp(d.KEEP,d.KEEP,d.INCR),s.overrideMaterial=this.doubleMaterial,e.render(s,t),a.visibleModelIdMap)for(let e=0;e<g.length;e++){let t=g[e],i=t.parentmodel.id;if(a.visibleModelIdMap.hasOwnProperty(i)){if(t.isOsgb){let e=t.parentmodel.getTransformMatrix();e.elements[12]=e.elements[12]-m.x,e.elements[13]=e.elements[13]-m.y,e.elements[14]=e.elements[14]-m.z,t.parentmodel.setTransformMatrix(e),t.parentmodel.updateMatrix()}s.remove(t.objectGroup)}}else for(let e=0;e<g.length;e++){let t=g[e];if(t.isOsgb){let e=t.parentmodel.getTransformMatrix();e.elements[12]=e.elements[12]-m.x,e.elements[13]=e.elements[13]-m.y,e.elements[14]=e.elements[14]-m.z,t.parentmodel.setTransformMatrix(e),t.parentmodel.updateMatrix()}s.remove(t.objectGroup)}s.add(a),h.buffers.stencil.setFunc(d.EQUAL,2,255),h.buffers.stencil.setOp(d.ZERO,d.ZERO,d.ZERO),s.overrideMaterial=null,e.render(s,t),h.buffers.stencil.setLocked(!1),s.remove(a),g.length>0&&g.forEach((e=>{e.parent.add(e.objectGroup)}))}e.setRenderTarget(a),h.buffers.stencil.setTest(!1),e.autoClear=n}renderPolygonOnlyClampGround(e,t,i){if(this.shadowVolumes.length<=0)return;let n=this,a=e.autoClear;e.autoClear=!1;let s=e.getRenderTarget(),o=this.shadowVolumeScene,l=this.backMaterial,d=this.frontMaterial,h=e.getContext(),c=e.state;c.buffers.stencil.setTest(!0);for(let a=0;a<this.shadowVolumes.length;a++){if(!this.shadowVolumes[a].visible)continue;if(2==this.shadowVolumes[a].clampMode)continue;o.add(this.shadowVolumes[a]),c.buffers.stencil.setLocked(!0),c.buffers.stencil.setFunc(h.ALWAYS,0,255),c.buffers.stencil.setOp(h.KEEP,h.INCR,h.KEEP),o.overrideMaterial=l,e.setRenderTarget(i),e.render(o,t),c.buffers.stencil.setFunc(h.ALWAYS,0,255),c.buffers.stencil.setOp(h.KEEP,h.DECR,h.KEEP),o.overrideMaterial=d,e.render(o,t),o.remove(this.shadowVolumes[a]);let s=this.polygonOnlyClampDEM;n.polygonOnlyClampDEMArryNum!=this.viewer.modelManager.modelCollection._layers.length&&(n.polygonOnlyClampDEMArryNum=this.viewer.modelManager.modelCollection._layers.length,n.ifPolygonOnlyClampDEM=!0),n.ifPolygonOnlyClampDEM&&(n.ifPolygonOnlyClampDEM=!1,n.viewer.modelManager.traverseValidModels((function(e){if(!e.isDemLayer){function t(e,t){let i=!1;for(let r=0;r<e.length;r++)if(e[r].parentmodel.id==t.id){i=!0;break}return i}if(e instanceof r.ExternalComponentManager){n.viewer.getScene().getExternalCompObjectGroups().forEach((t=>{let i={parentmodel:e,objectGroup:t,parent:t.parent,isOsgb:!1};s.push(i)}))}if(e.objectGroup){if(!t(s,e)){let i={parentmodel:e,objectGroup:e.objectGroup,parent:e.objectGroup.parent,isOsgb:e.isOsgb};s.push(i)}}else if(e._rootNodeGroup){if(!t(s,e)){let a={parentmodel:e,objectGroup:e._rootNodeGroup,parent:e._rootNodeGroup.parent,isOsgb:e.isOsgb};s.push(a)}}else if(e.ObjectGroup&&!t(s,e)){let o={parentmodel:e,objectGroup:e.ObjectGroup,parent:e.ObjectGroup.parent,isOsgb:e.isOsgb};s.push(o)}}})));var u=this.getCameraDirOnWorldcoordinate();s.length>0&&s.forEach((e=>{if(e.isOsgb){let t=e.parentmodel.getTransformMatrix();t.elements[12]=t.elements[12]+u.x,t.elements[13]=t.elements[13]+u.y,t.elements[14]=t.elements[14]+u.z,e.parentmodel.setTransformMatrix(t),e.parentmodel.updateMatrix()}o.add(e.objectGroup)})),c.buffers.stencil.setFunc(h.EQUAL,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.INCR),o.overrideMaterial=this.doubleMaterial,e.render(o,t),s.length>0&&s.forEach((e=>{if(e.isOsgb){let t=e.parentmodel.getTransformMatrix();t.elements[12]=t.elements[12]-u.x,t.elements[13]=t.elements[13]-u.y,t.elements[14]=t.elements[14]-u.z,e.parentmodel.setTransformMatrix(t),e.parentmodel.updateMatrix()}o.remove(e.objectGroup)})),s.length>0&&s.forEach((e=>{e.parent.add(e.objectGroup)}));let p=[];this.splineCurveOriginOpacityVector.splice(0,this.splineCurveOriginOpacityVector.length);let m=this._getExternalObjectGroup();if(m)for(let e=0;e<m.children.length;e++){let t=m.children[e];if(t instanceof Glodon.Bimface.Plugins.Geometry.Plane)p.push(t.visible),t.visible=!1;else if(t.material&&t.material.opacity<1){let e={pid:t.id,opacity:t.material.opacity};this.splineCurveOriginOpacityVector.push(e),t.material.opacity=0}}let f={},g=n.viewer.modelManager.modelCollection;g.traverse((e=>{e.objectGroup&&(f[e.id]=e.objectGroup.visible,e.objectGroup.visible=!1),e.ObjectGroup&&(f[e.id]=e.ObjectGroup.visible,e.ObjectGroup.visible=!1),e._rootNodeGroup&&(f[e.id]=e._rootNodeGroup.visible,e._rootNodeGroup.visible=!1)})),n.viewer.modelManager.traverseValidModels((function(e){if(e.isDemLayer&&n.isFirstAdd){let t=null;t=e instanceof r.DemModel?e.ObjectGroup.parent:e.objectGroup.parent;let i={objectGroup:t,parent:t.parent};n.groundPlaneSceneModel.push(i),n.isFirstAdd=!1}}));for(let e=0;e<n.groundPlaneSceneModel.length;e++){let t=n.groundPlaneSceneModel[e];o.add(t.objectGroup)}c.buffers.stencil.setFunc(h.EQUAL,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.INCR),o.overrideMaterial=null,e.render(o,t);for(let e=0;e<n.groundPlaneSceneModel.length;e++){let t=n.groundPlaneSceneModel[e];o.remove(t.objectGroup)}if(n.groundPlaneSceneModel.forEach((e=>{e.parent.add(e.objectGroup)})),m)for(let e=0;e<m.children.length;e++){let t=m.children[e];if(t instanceof Glodon.Bimface.Plugins.Geometry.Plane)t.visible=!0;else for(let e=0;e<this.splineCurveOriginOpacityVector.length;e++){let i=this.splineCurveOriginOpacityVector[e];if(i.pid==t.id){t.material.opacity=i.opacity;break}}}g.traverse((e=>{let t=f.hasOwnProperty(e.id);e.objectGroup&&t&&(e.objectGroup.visible=f[e.id]),e.ObjectGroup&&t&&(e.ObjectGroup.visible=f[e.id]),e._rootNodeGroup&&t&&(e._rootNodeGroup.visible=f[e.id])})),o.add(this.shadowVolumes[a]),c.buffers.stencil.setFunc(h.EQUAL,1,255),c.buffers.stencil.setOp(h.ZERO,h.ZERO,h.ZERO),o.overrideMaterial=null,e.render(o,t),o.remove(this.shadowVolumes[a]),c.buffers.stencil.setLocked(!1)}e.setRenderTarget(s),c.buffers.stencil.setTest(!1),e.autoClear=a}getCameraDirOnWorldcoordinate(){var e=this.viewer.getScene().getRawMatrixGlobal(),t=this.viewer.cameraControl.getCamera(),i=this.viewer.cameraControl.getCameraName(),n=new r.CameraInfo(i,t.position,t.target,t.realUp||t.up),a=(n=r.Camera.drawingToWorld(n,e)).position.clone().sub(n.target);a.normalize();var s=new THREE.Vector3(.5,.5,.5);return a.multiply(s),a}createGroundPolygon(e){e.viewer=this.viewer;var t=e.color,i=new r.GroundPolygonMaterial({color:new THREE.Color(t.red/255,t.green/255,t.blue/255)});i.side=THREE.BackSide,i.depthFunc=THREE.AlwaysDepth,i.depthWrite=!1,i.transparent=!0,i.blending=THREE.NormalBlending,i.opacity=t.alpha;var n=new r.GroundPolygonGeometry(e),a=new r.GroundPolygonMesh(n,i);return a.setViewer(this.viewer),a.onBeforeRender=function(e,t,i,r,n,a){},a}getGroundMinHeight(){return this.groundMinHeight}computeGroundMinHeight(){0!==this.shadowVolumes.length?(this.groundMinHeight=0,this.shadowVolumes.forEach((e=>{const t=e.geometry.minHeight||0;this.groundMinHeight=Math.min(this.groundMinHeight,t)}))):this.groundMinHeight=void 0}addGroundPolygon(e){this.shadowVolumes.push(e),this.computeGroundMinHeight()}removeGroundPolygon(e){var t=this.shadowVolumes.indexOf(e);-1!==t&&(this.shadowVolumes.splice(t,1),this.computeGroundMinHeight())}setSize(e,t){this.depthRenderTarget.setSize(e,t),this.depthWithoutDEMRenderTarget.setSize(e,t),this.polygonClimpGroundMatchRenderTarget.setSize(e,t),this.polygonClimpGroundColorRenderTarget.setSize(e,t),this.polygonOnlyClimpGroundColorRenderTarget.setSize(e,t)}setInVisibleModelIdMapAboutGroundCurve(e){this.inVisibleModelIdMapForGroundCurve=e}getInVisibleModelIdMapAboutGroundCurve(){return this.inVisibleModelIdMapForGroundCurve}getSkyline3D(){var e=this.viewer.getRenderer(),i=this.viewer.camera,n=this.viewer.rendererManager.renderer;n.renderCustomDepth&&n.renderCustomDepth(e,this.viewer.getScene(),i,this.depthRenderTarget,!0);var a=this.viewer.getViewportSize(),s=a.width,o=a.height,l=new Uint8Array(s*o*4);e.readRenderTargetPixels(this.depthRenderTarget,0,0,s,o,l);var d=i.near,h=i.far,c=2/(Math.log(h+1)/Math.LN2),u=i.projectionMatrix;t.copy(u).invert();for(var p=i.matrixWorld,m=new THREE.Vector4,f=new THREE.Vector4,g=new Array,v=0;v<s;v++)for(var y=o-1;y>=0;y--){var M=4*(y*s+v),E=l[M],x=l[M+1],_=l[M+2],b=l[M+3];m.set(E,x,_,b);var I=r.Utils.unpackRGBAToDepth(m);if(0!=I){var T=v,S=y,C=2*(I/=255)/c,w=Math.pow(2,C)-1,R=h*(1-d/w)/(h-d),B=2*T/s-1,A=2*S/o-1;R=2*R-1,f.set(B,A,R,1),f.multiplyScalar(w),f.applyMatrix4(t),f.applyMatrix4(p),g.push(new THREE.Vector3(f.x,f.y,f.z));break}}return g}static getInstance(){return e}static createInstance(t){return e||(e=new r.GroundPrimitiveManager(t)),e}static destroyInstance(){e&&e.destroy(),e=void 0}}}(),(()=>{new THREE.Matrix4,new THREE.Vector3;class e extends r.ExternalComponentManager{constructor(e,t){super(e),this.id=t,this.databagId=this.id}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(this.id,{pickableType:r.PICKABLETYPE.ExternalComponent,globalSpace:!0})}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(this.id)}}r.EffectComponentManager=e})();r.AreaInfo=class{constructor(e){this.roomName=e,this.belong="user",this.roomBoundary=null,this.offsetZ=0,this.boundingBox=0,this.roomInnerBoundary=null}checkRoomBoundaryWithHoles(e,t){if(t.length>0){this.roomInnerBoundary=[];for(let e=0;e<t.length;e++){this.checkRoomBoundary(t[e])&&this.roomInnerBoundary.push(this.roomBoundary)}}return this.checkRoomBoundary(e)}checkRoomBoundary(e){function t(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}function i(e,i,r,n){var a=t(e,i,r)*t(e,i,n),s=t(r,n,e)*t(r,n,i);return!(a>0)&&(!(s>0)&&(0!=a||0!=s||!function(e,t,i,r){return!(Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y))&&!(Math.min(e.x,t.x)<=r.x&&r.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=r.y&&r.y<=Math.max(e.y,t.y))}(e,i,r,n)))}if(!(e instanceof Array)||e.length<3)return console.log("Failed to create room boundary, the number of the points must be more than three."),!1;this.offsetZ=e[0][2];var r=new THREE.Box2,n=[];n.push(new THREE.Vector2(e[0][0],e[0][1]));for(var a=1,s=e.length;a<s;a++){if(3!=e[a].length)return console.log("Failed to create room boundary, the format of boundary is not right, please follow [[x1,y1,z1],...]"),!1;for(a=1;a<e.length;a++){for(var o=!1,l=0;l<n.length;l++)if(e[a][0]==n[l].x&&e[a][1]==n[l].y){o=!0;break}if(!1===o){var d=new THREE.Vector2(e[a][0],e[a][1]);n.push(d),r.expandByPoint(d)}}}var h,c,u=n.length;if(u<3)return console.log("Failed to create room boundary, points are collinear."),!1;if(3==u){if(0==t(n[0],n[1],n[2]))return console.log("Failed to create room boundary, points are collinear."),!1;const i=new THREE.Vector2(e[0][0],e[0][1]);return n.push(i),r.expandByPoint(i),this.roomBoundary=n,this.boundingBox=r,!0}for(a=0;a<u;a++){h=n[a],c=n[a==u-1?0:a+1];for(l=a+2;l<u;l++)if((0!=a||l!=u-1)&&i(h,c,n[l],n[l==u-1?0:l+1]))return console.log("Failed to create room boundary, the room boundary is self-intersection."),!1}return n.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=n,this.boundingBox=r,!0}clone(){return(new this.constructor).copy(this)}copy(e){return this.roomName=e.roomName,this.belong=e.belong,void 0!==e.roomBoundary&&(this.roomBoundary=JSON.parse(JSON.stringify(e.roomBoundary))),this.offsetZ=e.offsetZ,this.boundingBox=e.boundingBox.clone(),this}};class V extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.BoundaryEdgeManager,{priority:20}),this.globalSpace=!0,this.areaInfo=new Array,this.areaGeometries=new Array,this.areaMeshes=new Array,this.areaMaterial=new THREE.LineMaterial({color:1005740}),this.areaMaterial.linewidth=5,this.areaMaterial.depthTest=!1}addAreaInfo(e){var t=this.areaInfo.length;return this.areaInfo.push(e),this.update(t),t}setAreaInfo(e,t){return void 0!==e&&(this.areaInfo.length>e&&(this.areaInfo[e]=t,this.update(e),!0))}setAreaLineColor(e){this.areaMaterial=new THREE.LineMaterial(e),this.areaMaterial.linewidth=1}removeAreaInfo(e){if(void 0===e)return!1;if(this.areaMesh&&this.remove(this.areaMesh),this.areaInfo.length>e){this.areaInfo.splice(e,1),this.areaGeometries.splice(e,1);var t=this.areaMeshes[e];return this.remove(t),this.areaMeshes.splice(e,1),!0}return!1}update(e){if(!(void 0===e||this.areaInfo.length<e)){for(var t=this.areaInfo[e].length,i=new Array,n=0;n<t;++n)for(var a=this.areaInfo[e][n],s=0,o=a.length;s<o;++s){var l=a[s];i.push(l.x),i.push(l.y),i.push(l.z)}this.areaMesh&&this.remove(this.areaMesh);var d=new THREE.LineSegmentsGeometry;d.setPositions(i),this.areaMaterial.resolution.set(window.innerWidth,window.innerHeight),this.areaMesh=new THREE.LineSegments2(d,this.areaMaterial),this.areaMesh.renderOrder=r.EnumRenderOrder.Effect,this.add(this.areaMesh),this.updateMatrixWorld(!0)}}}V.getInstance=function(e){return null==e.boundaryEdge&&(e.boundaryEdge=new r.BoundaryEdgeManager,e.objectGroups.add(e.boundaryEdge),e.boundaryEdge.matrix.copy(e.geometryGroup.matrix),e.boundaryEdge.matrixAutoUpdate=!1,e.boundaryEdge.updateMatrixWorld(!0)),e.boundaryEdge},V.destroy=function(e){e.boundaryEdge=null},r.BoundaryEdgeManager=V;class z extends r.BaseModel{constructor(e){super(e.getModelManager(),{modelId:r.ObjectGroupType.EXTRUDEBODYMANAGER}),this.viewer=e,this.manager.addModel(this),this.filter=new r.FilterManager,this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.castShadow=!1,this.receiveShadow=!1,this.mapColorToNodeId={},this.selectionColor={red:50,green:224,blue:240,alpha:.4},this.selectionEdgeColor={red:50,green:224,blue:240,alpha:1},this.blinkMaterials=[],this.blinkMaterialMap={},this.bindModelMap={},this.mapDepthTestToNodeId={}}destroy(){this.manager.removeModel(this.id),this._removeNodeGroup(),this.mapColorToNodeId=null,this.selectionColor=null,this.selectionEdgeColor=null,this.blinkMaterials=null,this.blinkMaterialMap=null,this.filteredIds=null,this.selectedIds=null,this.blinkedIds=null,this.bindModelMap=null,this.mapDepthTestToNodeId=null,super.destroy()}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Room,priority:20,globalSpace:!0})}_getAlphaTestNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGERTEST,{pickableType:r.PICKABLETYPE.Room,priority:20,globalSpace:!0})}getAllNodes(){return this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children)}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTRUDEBODYMANAGER),this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTRUDEBODYMANAGERTEST)}addNode(e,t,i,r,n,a){"cloudStandard"!==r.type&&"cloudStandardV3"!=r.type||r.setUnLight(),"cloudStandard"!==n.type&&"cloudStandardV3"!=n.type||n.setUnLight(),a=null==a||a,this.getNode(e)&&this.removeNodeById(e);var s=new Array,o=0,l=0,d=0,h=[];let c=[],u=[],p=[];if(t.belong&&"user"==t.belong){o=t.offsetZ;for(var m=0,f=t.roomBoundary.length;m<f;m++){var g=t.roomBoundary[m];s[m]=new THREE.Vector2(g.x,g.y)}if(t.roomInnerBoundary)for(m=0,f=t.roomInnerBoundary.length;m<f;m++){var v=t.roomInnerBoundary[m];u.push(v);let e=[];v.forEach((t=>{e.push(t.clone&&t.clone()||new THREE.Vector2(t.x,t.y))})),p.push(e)}}else{if(t.version&&"2.0"==t.version){t.loops&&t.loops.length>0&&(h=t.loops[0]);const e=JSON.stringify(h);if(t.loops.length>1)for(let i=1;i<t.loops.length;i++)JSON.stringify(t.loops[i])!==e&&c.push(t.loops[i])}let e=e=>{var t=e.length;let i=[];for(var r=0;r<t;++r)for(var n=e[r],a=n.length,s=0;s<a-1;s++){var l=n[s];i.push(new THREE.Vector2(l.x,l.y)),0==r&&0==s&&(o=l.z)}return i.length>0&&i.push(i[0].clone()),i};c.forEach((t=>{let i=e(t);u.push(i);let r=[];i.forEach((e=>{r.push(e.clone())})),p.push(r)})),s=e(h)}if(!t.offsetZ&&(t.offsetZ=o),s.length<=0)return;var y=[];let M=[];(e=>{y=[],l=0,d=0,l=e[0].x,d=e[0].y;for(var t=0,i=e.length-1;t<i;t++){var r=e[t];l>r.x&&(l=r.x),d>r.y&&(d=r.y),y.push({x:r.x,y:r.y,z:o})}for(t=0,i=e.length;t<i;t++)e[t].x-=l,e[t].y-=d})(s);let E=[];p.forEach((e=>{let t=new THREE.Vector2(-l,-d);if(e.forEach((e=>{e.add(t)})),!(e=>{let t=JSON.stringify(e).toString();for(let e=0;e<E.length;e++){let i=E[e];if(t===JSON.stringify(i).toString())return!0}return!1})(e)){let t=new THREE.Path(e);M.push(t),E.push(e)}}));var x=new THREE.Shape(s);x.holes=M;var _={depth:i,bevelEnabled:!1};this._genShap(x,_,r,l,d,o,e,y),this._genWireframe(u,y,a,n,l,d,o,i,e)}getBoundingBox(){let e=new THREE.Box3;const t=this.getAllNodeGroups();for(let i=0;i<t.length;i++){const r=t[i];if("LineSegments"===r.type)continue;const n=r.geometry.boundingBox.clone();n.applyMatrix4(r.matrix),e.expandByPoint(n.min),e.expandByPoint(n.max)}return e}_genShap(e,t,i,r,n,a,s,o){var l=new THREE.ExtrudeGeometry(e,t);l.contour=o,this._faceToContour(l,r,n),l.boundingBox||l.computeBoundingBox();var d=new THREE.Mesh(l,i);d.name=s.toString(),d._oriMaterial=i,d.translateX(r),d.translateY(n),d.translateZ(a),this.setColorInMap(d.name,i),this._getNodeGroup().add(d),this._getNodeGroup().updateMatrixWorld(!0)}_genWireframe(e,t,i,r,n,a,s,o,l){let d=new THREE.Geometry;e.forEach((e=>{for(var t=[],i=0,r=e.length-1;i<r;i++){var l=e[i];t.push({x:l.x,y:l.y,z:s})}let h=this._genWireFrameGeometry(t,n,a,s,o);null!=h&&d.merge((new THREE.Geometry).fromBufferGeometry(h))}));let h=this._genWireFrameGeometry(t,n,a,s,o);null!=h&&d.merge((new THREE.Geometry).fromBufferGeometry(h)),r.depthTest=!i,r.transparent=!0;let c=d.toBufferGeometry();c.deleteAttribute("normal");const u=new THREE.LineSegments(c,r);u.name="wireframe_"+l,u._oriMaterial=r,u.translateX(n),u.translateY(a),u.translateZ(s),u.updateMatrixWorld(!0),this.setColorInMap(u.name,r),this.mapDepthTestToNodeId[l]=!1,this._getNodeGroup().add(u),this._getNodeGroup().updateMatrixWorld(!0)}_genWireFrameGeometry(e,t,i,n,a){if(!(e.length<3)){var s=this._checkVertices(e.slice(),a);if(!(s.length<2))return r.BuildRoomEdge(s,t,i,n,a)}}bindModel(e,t){if(this.getNode(e)&&this.getModelManager().modelCollection.getIds().indexOf(t.toString())>=0){if(this.getBindedModelId(e))return;this.bindModelMap[t]||(this.bindModelMap[t]=[]),this.bindModelMap[t].push(e);let i=this.getNode(e),r=this.getNode("wireframe_"+e);i.explodedHeight=r.explodedHeight=0,i.explodedDirection=r.explodedDirection=new THREE.Vector3;let n=this.getModelManager().explosionManager;if(0!==n.getFloorExplosionExtent(t)){let i=n.getFloorInfos(t);this.explodeMesh(this.getNode(e),i,!0),this.explodeMesh(this.getNode("wireframe_"+e),i,!0)}let a=n.getExplosionExtent(t);if(0!==a){const i=this.getModelManager().getModel(t);let r=new THREE.Vector3;const n=i.getBoundingBoxWorld().getCenter(r);this.elementExplodeMesh(this.getNode(e),a,n),this.elementExplodeMesh(this.getNode("wireframe_"+e),a,n)}const s=this.getModelManager().getModel(t).transformMatrix;i.lastTransformation=(new THREE.Matrix4).copy(s),i.applyMatrix4(s),i.updateMatrixWorld(),r.lastTransformation=(new THREE.Matrix4).copy(s),r.applyMatrix4(s),r.updateMatrixWorld()}}unbindModel(e,t){if(this.bindModelMap[t]){let i=this.bindModelMap[t].indexOf(e);if(i>=0){this.bindModelMap[t].splice(i,1);const r=e=>{if(void 0!==e.explodedHeight){const t=e.explodedDirection.clone().negate().multiplyScalar(e.explodedHeight);let i=new THREE.Matrix4;i.makeTranslation(t.x,t.y,t.z),e.applyMatrix4(i),e.updateMatrixWorld(),delete e.explodedDirection,delete e.explodedHeight,delete e.preExplodedDirection,delete e.preExplodedHeight}},n=e=>{null!=e.preModelExplodedMatrix&&(e.preModelExplodedMatrix.invert(),e.applyMatrix4(e.preModelExplodedMatrix),e.updateMatrixWorld(),delete e.preModelExplodedMatrix)},a=e=>{const i=this.getModelManager().getModel(t).transformMatrixInverse;e.lastTransformation=(new THREE.Matrix4).copy(i),e.applyMatrix4(i),e.updateMatrixWorld()};if(!this.getNode(e))return;r(this.getNode(e)),r(this.getNode("wireframe_"+e)),n(this.getNode(e)),n(this.getNode("wireframe_"+e)),a(this.getNode(e)),a(this.getNode("wireframe_"+e))}}}getBindedModelId(e){let t;return Object.keys(this.bindModelMap).some((i=>{if(this.bindModelMap[i].indexOf(e)>=0)return t=i,!0})),t}_checkVertices(e,t){var i=.1;function r(e,t,r){return void 0!==e&&void 0!==t&&void 0!==r&&(Math.abs(t.x-e.x)<i&&Math.abs(r.x-e.x)<i||(Math.abs(t.y-e.y)<i&&Math.abs(r.y-e.y)<i||Math.abs((t.x-e.x)*(r.y-e.y)-(r.x-e.x)*(t.y-e.y))<100*i))}!0===this.viewer.hasBimtilesModel()&&(i=1e-4);for(var n=e.length;r(e[0],e[1],e[n-1]);)e.shift(),n=e.length;for(n=e.length;r(e[0],e[n-2],e[n-1]);)e.pop(),n=e.length;n=e.length;for(var a=0;a+2<n;){for(var s=a;s+2<n&&r(e[a],e[s+1],e[s+2]);)e.splice(s+1,1),n=e.length;a++}return e}_faceToContour(e,t,i){const r=e.contour,n=e.attributes.position;let a=[];const s=n.count,o=r.length;let l=new THREE.Vector3;function d(e,t){return Math.abs(e-t)<=.1}for(let e=0;e<o;e++)for(let o=0;o<s;o++)l.fromBufferAttribute(n,o),d(l.x+t,r[e].x)&&d(l.y+i,r[e].y)&&(a[o]=e);function h(e,t){var i=e<t?e:t,r=e>t?e:t;return 0==i&&r==o-1?{st:r,ed:i}:{st:i,ed:r}}let c=[];for(var u=0;u<s;u+=3){let e={},t=[];for(let e=u;e<u+3;e++){const i=a[e];i&&t.push(i)}t.length>2?e.contourIndex=h(t[1],t[2]):t.length>1?e.contourIndex=h(t[0],t[1]):1==t.length&&(e.contourIndex=h(t[0],t[0]+1)),c.push(e)}e.faces=c}applyFrontEffect(e,t,i){const r=this._getNodeGroupVisible(),n=this._getNodeGroup().parent.children,a=n.length;let s=new Array(a);for(var o=0;o<a;++o)s[o]=n[o].visible,n[o].visible=!1;this._setNodeGroupVisible(r);var l=e.autoClear,d=e.autoClearColor,h=e.autoClearDepth,c=e.autoClearStencil;e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1;const u=t.fog.postProcessSSAOMap;t.fog.setPostProcessSSAOMap(null),e.render(t,i),t.fog.setPostProcessSSAOMap(u),e.autoClear=l,e.autoClearColor=d,e.autoClearDepth=h,e.autoClearStencil=c;for(o=0;o<a;++o)n[o].visible=s[o]}setColorInMap(e,t){var i={red:255*t.color.r,green:255*t.color.g,blue:255*t.color.b,alpha:t.opacity};this.mapColorToNodeId[e]=i}createMaterial(e){return r.MaterialUtil.createStandardMaterial(e)}setNodeMaterial(e,t,i){var r=this.getNode(e);if(r){var n=r._oriMaterial;for(var a in t){var s=a;n.hasOwnProperty(s)&&(n[s]="color"==s?new THREE.Color(t[a]):t[a])}this.setColorInMap(e,n)}(r=this.getNode("wireframe_"+e))&&((n=r._oriMaterial).color.copy(i.color),n.opacity=i.opacity,this.setColorInMap("wireframe_"+e,n));this._updateNodeById(e)}getNode(e){let t=t=>{for(let i=0,r=t.length;i<r;i++)if(t[i].name==e.toString())return t[i]};return t(this._getNodeGroup().children)||t(this._getAlphaTestNodeGroup().children)}removeNodeById(e){var t=this.getNode(e);if(t&&(delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t),this._getAlphaTestNodeGroup().remove(t)),this.filter.enableStateChanged(),t=this.getNode("wireframe_"+e)){delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t),this._getAlphaTestNodeGroup().remove(t);let i=this.getBindedModelId(e);return i&&this.unbindModel(e,i),!0}return!1}clearNodes(){this._getNodeGroup().clear(),this._getAlphaTestNodeGroup().clear(),this.mapColorToNodeId={},this.bindModelMap={},this.filter.enableStateChanged()}setNodeVisibleById(e,t){var i=this.getNode(e);if(i&&(i.visible=t),this.filter.enableStateChanged(),i=this.getNode("wireframe_"+e))return i.visible=t,!0}_getNodeGroupVisible(){return this._getNodeGroup().visible}_setNodeVisible(e){const t=this._getNodeGroup().children;for(let i=0,r=t.length;i<r;i++)t[i].visible=e}_setNodeGroupVisible(e){this._getNodeGroup().visible=e}_getAlphaTestNodeGroupVisible(){return this._getAlphaTestNodeGroup().visible}_setAlphaTestNodeVisible(e){const t=this._getAlphaTestNodeGroup().children;for(let i=0,r=t.length;i<r;i++)t[i].visible=e}_setAlphaTestNodeGroupVisible(e){this._getAlphaTestNodeGroup().visible=e}showAllNodes(){this._setNodeVisible(!0),this._setAlphaTestNodeVisible(!0),this.filter.enableStateChanged()}hideAllNodes(){this._setNodeVisible(!1),this._setAlphaTestNodeVisible(!1),this.filter.enableStateChanged()}setNodeColorById(e,t){var i=this.getNode(e);if(i){var r=i._oriMaterial;return r.color=new THREE.Color(t.red/255,t.green/255,t.blue/255),r.opacity=t.alpha,t!=this.selectionColor&&t!=this.selectionEdgeColor&&this.setColorInMap(i.name,r),this._updateNodeById(e),this.filter.enableStateChanged(),!0}return!1}getNodeColorById(e){return this.mapColorToNodeId[e]}setWireframeColorById(e,t){return this.setNodeColorById("wireframe_"+e,t)}getWireframeColorById(e){return this.getNodeColorById("wireframe_"+e)}applySelection(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}clearSelection(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}applyHover(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}clearHover(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}applyBlink(){this._hasNode()&&(this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}clearBlink(){this._clearBlinkedIds(),this.applyHover()}_collectSelectedIds(){var e=this.filteredIds=this.filteredIds||{},t=r.EnumElementState,i=this.getModelManager().sceneState.getSelection(),n={};this._clearSelectedIds();for(var a=0,s=i.length;a<s;a++){var o=i[a];this._hasObjectId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,n[o]=!0)}this.selectedIds=Object.keys(n)}_clearSelectedIds(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var i=this.selectedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.EnumElementState.SELECTED]}this.selectedIds=null}}_collectHoveredIds(){this._clearHoveredIds();var e=this.getModelManager().sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][r.EnumElementState.HOVER]=!0}}_clearHoveredIds(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][r.EnumElementState.HOVER],this.hoveredId=void 0)}_collectBlinkedIds(){var e=this.getModelManager().sceneState.getBlinkComponentsIdMap(this.id),t=this.filteredIds=this.filteredIds||{},i=r.EnumElementState,n={};for(var a in this._clearBlinkedIds(),e)this._hasObjectId(a)&&(t[a]||(t[a]={}),t[a][i.BLINK]=!0,n[a]=!0);this.blinkedIds=Object.keys(n)}_clearBlinkedIds(){if(this.filteredIds&&this.blinkedIds&&this.blinkedIds.length){for(var e=0,t=this.blinkedIds.length;e<t;e++){var i=this.blinkedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.EnumElementState.BLINK]}this.blinkedIds=null}}_hasObjectId(e){return!!this.mapColorToNodeId[e]}_hasNode(){for(var e in this.mapColorToNodeId)if(this.mapColorToNodeId.hasOwnProperty(e))return!0;return!1}_updateNodes(){if(this._resetMaterial(),this.blinkMaterialMap={},this.blinkMaterials.length=0,this.filteredIds)for(var e in this.filteredIds)this._updateNodeById(e)}_resetMaterial(){let e=e=>{for(let t=0,i=e.length;t<i;t++){let i=e[t],r=this.mapColorToNodeId[i.name];i._oriMaterial.color.setRGB(r.red/255,r.green/255,r.blue/255),i._oriMaterial.opacity=r.alpha,i.material=i._oriMaterial}};e(this._getNodeGroup().children),e(this._getAlphaTestNodeGroup().children)}_updateNodeById(e){if(this._hasObjectId(e)&&this.filteredIds&&this.filteredIds[e]){var t=this.filteredIds[e],i=r.EnumElementState,n=this.getNode(e),a=this.getNode("wireframe_"+e),s=this.getModelManager().sceneState;if(t[i.SELECTED]){var o=this.selectionColor;if(n.material=n._oriMaterial,n.material.color.setRGB(o.red/255,o.green/255,o.blue/255),n.material.opacity=o.alpha,a){var l=this.selectionEdgeColor;a.material=a._oriMaterial,a.material.color.setRGB(l.red/255,l.green/255,l.blue/255),a.material.opacity=l.alpha}}else if(t[i.BLINK]){if(void 0===this.blinkMaterialMap[e]){this.blinkMaterialMap[e]=!0;var d=s.getBlinkMaterial(n._oriMaterial,this.id);n.material=d,this.blinkMaterials.push(d)}}else if(t[i.HOVER]){n.material=n._oriMaterial;var h=this.mapColorToNodeId[e],c=r.MaterialUtil.getHoverColorByColor({r:h.red/255,g:h.green/255,b:h.blue/255,a:h.alpha});return n.material.color.setRGB(c.r,c.g,c.b),void(n.material.opacity=c.a)}}}sortRenderOrder(e){for(var t=this._getNodeGroup().children,i=e.camera.position.clone(),r=new Map,n=0,a=t.length;n<a;++n){var s=t[n];if(-1!=s.name.indexOf("wireframe"));else{var o=[s.name],l=e.getBoundingBoxByIds(o).getCenter(),d=i.distanceTo(l);r.set(n,d)}}var h=Array.from(r);h.sort((function(e,t){return t[1]-e[1]}));var c=1;for(n=0,a=h.length;n<a;++n)t[h[n][0]].renderOrder=c,null!=t[h[n][0]+1]&&(t[h[n][0]+1].renderOrder=c),++c}explodeMesh(e,t,i){let r,n,a,s;const o=t=>{a=e.preExplodedHeight=e.explodedHeight,s=e.preExplodedDirection=e.explodedDirection.clone(),r=e.explodedHeight=t.explodedHeight-t.elevation,n=e.explodedDirection=(t.explodedDirection||new THREE.Vector3).clone()};let l=0;for(let r=t.length-1;r>=0;r--){let n=t[r],a=t[r].preExplodedTranslation?t[r].preExplodedTranslation.z:0;l=i?t[r].boundingBox.min.z:a+t[r].boundingBox.min.z;let s=e.position.z;if(s>=l-1||0===r){o(n);break}}let d=new THREE.Matrix4;const h=n.clone().multiplyScalar(r).sub(s.clone().multiplyScalar(a));d.makeTranslation(h.x,h.y,h.z),e.applyMatrix4(d),e.updateMatrixWorld()}explode(e){let t,i=this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children);if(e){let o=this.bindModelMap[e];if(o&&o.length>0){t=this.getModelManager().explosionManager.getFloorInfos(e);for(var r=0,n=i.length;r<n;r++){var a=i[r],s=a.name.indexOf("wireframe_")<0?a.name:a.name.split("wireframe_")[1];o.indexOf(s)>=0&&this.explodeMesh(a,t)}}}}elementExplodeMesh(e,t,i){let n=new THREE.Box3;void 0!==e.preModelExplodedMatrix&&e.applyMatrix4(e.preModelExplodedMatrix.invert()),e.preModelExplodedMatrix=new THREE.Vector3,e.geometry.boundingBox||e.geometry.computeBoundingBox();const a=e.position,s=(new THREE.Vector3).subVectors(e.geometry.boundingBox.max,e.geometry.boundingBox.min),o=(new THREE.Vector3).addVectors(a,s);n=(new THREE.Box3).setFromPoints([a,o]);let l=r.Utils.computeExplodeTranslation(i,n,t),d=new THREE.Vector3;const h=n.getCenter(d),c=(new THREE.Matrix4).makeTranslation(-h.x,-h.y,-h.z),u=(new THREE.Matrix4).copy(c).invert(),p=(new THREE.Matrix4).makeTranslation(l.x,l.y,l.z);e.preModelExplodedMatrix=p.clone().multiply(u).multiply(c),e.applyMatrix4(e.preModelExplodedMatrix),e.updateMatrixWorld()}elementExplode(e,t,i){let r=e.id;if(!r)return;if(!this.bindModelMap[r])return;let n=this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children);if(n)for(let e=0;e<n.length;e++){let r=n[e];this.elementExplodeMesh(r,t,i)}}enableDepthTest(e,t){for(const i of e)void 0!==this.mapColorToNodeId[i]&&(this.mapDepthTestToNodeId[i]=t,this.mapDepthTestToNodeId[`wireframe_${i}`]=t,this.getNode(`wireframe_${i}`).material.depthTest=t,1==t?(this._getAlphaTestNodeGroup().add(this.getNode(i)),this._getAlphaTestNodeGroup().add(this.getNode(`wireframe_${i}`)),this._getNodeGroup().remove(this.getNode(i)),this._getNodeGroup().remove(this.getNode(`wireframe_${i}`))):(this._getNodeGroup().add(this.getNode(i)),this._getNodeGroup().add(this.getNode(`wireframe_${i}`)),this._getAlphaTestNodeGroup().remove(this.getNode(i)),this._getAlphaTestNodeGroup().remove(this.getNode(`wireframe_${i}`))))}getBoundingBoxWorld(){const e=(new THREE.Box3).setFromObject(this._getNodeGroup());return e.applyMatrix4(this.viewer.getScene().getInverseMatrixGlobal()),e}getBlinkMaterials(){return this.blinkMaterials}isUserIdExist(e){return this._hasObjectId(e)}getAllNodeGroups(){return this._getNodeGroup().children}updateTransformation(e,t){const i=(new THREE.Matrix4).fromArray(e);let n=this.viewer.getScene().getObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER),a=this.bindModelMap[t];if(a&&a.length>0){let e=n.children;for(let t=0;t<e.length;t++){let r=e[t],n=r.name.indexOf("wireframe_")<0?r.name:r.name.split("wireframe_")[1];a.indexOf(n)>=0&&(r.lastTransformation&&r.applyMatrix4((new THREE.Matrix4).copy(r.lastTransformation).invert()),r.lastTransformation=i,r.applyMatrix4(i),r.updateMatrixWorld())}}}getPickingMeshes(e,t,i,n,a){if(!1===!(!a||"string"!=typeof a||!a.startsWith("glow")))return;const s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1,i.map((e=>{const i=this.getNode(e);let r=new THREE.Mesh(i.geometry,i.material.clone());r.visible=i.visible,r.matrix.copy(i.matrix),r.matrixAutoUpdate=!1,r.updateMatrixWorld(!0),i&&t[s].add(r)}))}collectBlinkedMaterial(e,t){e.map((e=>{if(!this._hasObjectId(e))return;const i=this.getNode(e),r=this.getModelManager().sceneState.getBlinkMaterial(i._oriMaterial,this.id);t.push(r)}))}}z.getInstance=function(e){var t=e.getModelManager().getScene();if(null==t.extrudeBodyManager){t.extrudeBodyManager=new r.ExtrudeBodyManager(e);var i=t.extrudeBodyManager._getNodeGroup();t.objectGroups.add(i),i.matrix.copy(t.geometryGroup.matrix),i.matrixAutoUpdate=!1,i.updateMatrixWorld(!0)}return t.extrudeBodyManager},z.destroy=function(e){var t=e.getModelManager().getScene();t.extrudeBodyManager.destroy(),t.extrudeBodyManager=null},r.ExtrudeBodyManager=z,r.MaterialOverrider=class{constructor(e,t,i){this.id=e,this.condition=t,this.material=i}},r.MaterialOverriderSet=class{constructor(e,t){this.overriders=[],this.overrideData=e,this.materials={},this.materialsByName={},this.textures={},this.defaultColor=t||"#808080",this.loader=new r.MaterialOverriderLoader(this.defaultColor)}load(e,t,i,n,a){i=null!=i&&i,(new r.MaterialOverriderLoader).getMaterialOverriders(this.overriders,e,t,i,n,a)}loadByDemand(e,t,i){this.loader.getMaterialsByDemand(this.materials,this.materialsByName,this.textures,this.overrideData,e,t,i)}setDefaultColor(e){this.defaultColor=e,this.loader.defaultColor=e}getOverrideMaterials(){return this.materials}getOverrideMaterialByNodeInfo(e,t){var i=this.materials;return t&&"user"==t.tag?i["elementId_"+e.userId]||t||i["systemTypeId_"+e.userData.systemTypeId]||i["familyId_"+e.userData.familyId]:i["elementId_"+e.userId]||i["systemTypeId_"+e.userData.systemTypeId]||i["familyId_"+e.userData.familyId]}getOverrideMaterialByName(e){return this.materialsByName[e]}updateMaterialsValue(e,t){var i,r=this.materials;for(var n in r)(i=r[n])&&i[e]&&(i[e]=t,void 0!==i.refreshUniforms&&i.refreshUniforms(),i.needsUpdate=!0)}},r.MaterialOverriderLoader=class{constructor(e){this.loader=new THREE.FileLoader,this.loadTaskCount=0,this.maxLoadTask=0,this.defaultColor=e}getMaterialOverriders(e,t,i,r,n,a){var s=t.overrides;this._getOverridesByData(e,s,i,r,n,a),0==this.maxLoadTask&&n&&n()}getMaterialsByDemand(e,t,i,n,a,s,o){if(n.overrides){this.maxLoadTask=0,this.loadTaskCount=0;for(var l=[],d=n.overrides,h=n.textureMaterials,c=a.familyIds,u=a.elementIds,p=a.systemTypeIds,m=d.length-1;m>=0;m--){var f,g=d[m].targetType,v=d[m].target;if("family"==g){if(!c[v])continue;f="familyId_"+v}else if("element"==g){if(!u[v])continue;f="elementId_"+v}else{if("systemType"!=g)continue;if(!p[v])continue;f="systemTypeId_"+v}if(!e[f]){var y=d[m].colorMaterial;if(!y){if(!d[m].textureMaterial)continue;y=this.defaultColor}var M=new r.CloudStandardMaterial;if(M.pureColor=y,M.color.setStyle(y),M.name=y,d[m].textureMaterial){var E=JSON.parse(d[m].textureMaterial),x=E.materialId,_=h[E.materialId];if(M.name=_?x+M.name:M.name,w=t[M.name]){e[f]=w;continue}if(_){var b=JSON.parse(_);if(b.diffuse_color){var I=b.diffuse_color.split(",");M.color.setRGB(parseFloat(I[0]),parseFloat(I[1]),parseFloat(I[2])),M.opacity=parseFloat(I[3])}var T=M.opacity<1;if(M.transparent=T,M.roughness=b.roughness,M.metalness=b.metallic,M.bumpScale=b.enableBump,!l[E.materialId]&&!i[E.materialId]){if(b.diffuse_texture){var S=b.diffuse_texture.texture_file;S&&""!=S?(this.maxLoadTask+=2,l[E.materialId]={diffuse:b.diffuse_texture},"1"==b.useAlphaCulling&&(M.alphaTest=parseFloat(b.alphaCulling),M.useAlphaMap=!0,M.defines.USE_ALPHAMAP="")):M.textureColor=M.color.getStyle()}if(b.bump_texture){var C=b.bump_texture.texture_file;C&&""!=C&&(this.maxLoadTask+=2,l[E.materialId]?l[E.materialId].bump=b.bump_texture:l[E.materialId]={bump:b.bump_texture})}}}else M.textureColor=y,console.log("Warning: there is no corresponding textureMaterial whose materialId is "+E.materialId)}else{var w;if(w=t[M.name]){e[f]=w;continue}M.textureColor=y}M.needsUpdate=!0,M.side=THREE.DoubleSide,e[f]=M,t[M.name]=M}}this._mappingTexturesByDemand(t,i,l,s,o),0==this.maxLoadTask&&s&&s()}else s&&s()}_getOverridesByData(e,t,i,n,a,s){for(var o=i.familyIds,l=i.elementIds,d=i.systemTypeIds,h=!1,c=[],u=[],p=0,m=t.length;p<m;p++){var f,g,v=t[p].targetType,y=t[p].target;if("family"==v){if(!o[y])continue;f=[{familyId:y}]}else if("element"==v){if(!l[y])continue;f=[{elementId:y}]}else{if("systemType"!=consitionType)continue;if(!d[y])continue;f=[{systemTypeId:y}]}if(h=!0,n){if(!(E=t[p].colorMaterial))continue;(g=new r.CloudStandardMaterial).color.setStyle(E),g.name=t[p].id}else{if(!t[p].textureMaterial)continue;var M=JSON.parse(t[p].textureMaterial);if(!M.diffuse_color)continue;var E=M.diffuse_color.split(","),x=1==M.transparent;(g=new r.CloudStandardMaterial({opacity:parseFloat(E[3]),roughness:M.roughness,metalness:M.metallic,transparent:x,bumpScale:M.enableBump})).name=M.id,g.color.setRGB(parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2]));var _=M.diffuse_texture.texture_file;_&&""!=_&&(this.maxLoadTask+=2,c[p]={diffuse:M.diffuse_texture});var b=M.bump_texture.texture_file;b&&""!=b&&(this.maxLoadTask+=2,c[p]?c[p].bump=M.bump_texture:c[p]={bump:M.bump_texture}),g.needsUpdate=!0}u[p]=g;var I=new r.MaterialOverrider(t[p].id,f,g);e.push(I)}this._mappingTextures(u,c,a,s),h||(console.log("there is no conditions matched"),s&&s())}_mappingTextures(e,t,i,r){for(var n=0;n<e.length;n++)if(e[n]&&t[n]){if(t[n].diffuse){var a=this._loadTexture(t[n].diffuse,i,r);e[n].map=a}if(t[n].bump){var s=this._loadTexture(t[n].bump,i,r);e[n].bumpMap=s}e[n].needsUpdate=!0}}_mappingTexturesByDemand(e,t,i,r,n){for(var a in e)if(e.hasOwnProperty(a)){var s=e[a],o=s.name.split("#")[0];if(s&&i[o]){if(!t[o]){if(t[o]=[],i[o].diffuse){var l=this._loadTexture(i[o].diffuse,r,n);l.texturetype="map",t[o].push(l)}if(i[o].bump){var d=this._loadTexture(i[o].bump,r,n);d.texturetype="bumpMap",t[o].push(d)}}let s=t[o].length;for(let i=0;i<s;i++){let r=t[o][i];(l.texturetype="map")?e[a].map=r:e[a].bumpMap=r}e[a].needsUpdate=!0}}}_loadTexture(e,t,i){var n=new THREE.Texture,a=this,s=new TEST.CryptoResourceLoader;const o=e.texture_file;return r.Storage.IndexedDBHelper.loadWithStorage("ModelData",o,(()=>new Promise(((e,t)=>{s.loadURL(o,e,t)}))),(i=>{var s=new Blob([i],{type:"jpeg"}),o=a._loadImage(URL.createObjectURL(s),(function(){a._onLoadFinished(t)}));n.image=o,n.encoding=THREE.GammaEncoding;var l=e.scale.split(","),d=e.offset.split(",");n.repeat.fromArray([parseFloat(l[0]),parseFloat(l[1])]),n.offset.fromArray([parseFloat(d[0]),parseFloat(d[1])]),n.wrapS=a._getTextureWrapping(e.wrap_parameter_s),n.wrapT=a._getTextureWrapping(e.wrap_parameter_t),n.magFilter=a._getTextureFilter(e.filter_mode_mag),n.minFilter=a._getTextureFilter(e.filter_mode_min),n.rotation=THREE.Math.degToRad(e.rotation),r.MaterialUtil.updateUVMatrix(n),n.needsUpdate=!0,a._onLoadFinished(t)}),(e=>{i&&i()})),n}_loadImage(e,t){var i=new Image;return i.onload=function(){var e=document.createElement("canvas");e.width=r.MaterialUtil.nextHighestPowerOfTwo(i.width),e.height=r.MaterialUtil.nextHighestPowerOfTwo(i.height),e.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,e.width,e.height),t()},i.onerror=function(e){console.log("Error: image is failed to loaded"),t()},i.src=e,i}_getTextureFilter(e){switch(e){case"NEAREST":default:return THREE.NearestFilter;case"NEAREST_MIPMAP_NEAREST":return THREE.NearestMipMapNearestFilter;case"NEAREST_MIPMAP_LINEAR":return THREE.NearestMipMapLinearFilter;case"LINEAR":return THREE.LinearFilter;case"LINEAR_MIPMAP_NEAREST":return THREE.LinearMipMapNearestFilter;case"LINEAR_MIPMAP_LINEAR":return THREE.LinearMipMapLinearFilter}}_getTextureWrapping(e){switch(e){case"REPEAT":default:return THREE.RepeatWrapping;case"CLAMP":return THREE.ClampToEdgeWrapping;case"MIRROR":return THREE.MirroredRepeatWrapping}}_onLoadFinished(e){this.loadTaskCount++,this.loadTaskCount>=this.maxLoadTask&&e&&e()}},r.FlowSegment=r.FlowSegment||{},r.FlowSegment.AbstractSegmentManager=class{constructor(){}destroy(){}disable(){}enable(){}loadSegments(e,t){}unloadSegments(e){}getSegmentMetadata(e,t,i,r){}getSegmentIsolateOption(){}getSegmentIdsByPartialElementId(e){}hideComponentsBySegment(e){}showComponentsBySegment(e){}isolateComponentsBySegment(e,t){}},function(){class e{constructor(e){this.viewer=e,this.model=e.modelManager.getFirstModel(),this.model.registerPlugin(this),this.material=r.MaterialUtil.getDefaultStandardMaterial(),this.loader=new r.SegmentLoader(this),this.index=0,this.segmentIdMap={},this.segmentPathMap={},this.segmentIdArray=[],this.elementIdMap={},this.partialElementMap={},this.partialNodeInfoMapFromNodeId={},this.partialNodeIdMapFromSegmentId={},this.partialParentUserIdMapFromSegmentId={},this.partialNodeIdMapFromUserId={},this.geometryIdMapFromDataId={},this.dataBufferMapFromGeometryId={},this.geometryMapFromGeometryId={},this.meshNodeMapFromNodeId={},this.nodeIdMapOctantMap={},this.selectedNodeIdArray=[],this.hoveredNodeIdArray=[],this.isolateApplied=!1}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.removeSegmentBufferByDataIds(Object.keys(this.geometryIdMapFromDataId)),this.destroyGeometries(),this.model=null,this.loader.destroy(),this.loader=null,this.material=null,this.segmentIdMap=null,this.segmentPathMap=null,this.segmentIdArray=null,this.elementIdMap=null,this.partialElementMap=null,this.partialNodeInfoMapFromNodeId=null,this.partialNodeIdMapFromSegmentId=null,this.partialParentUserIdMapFromSegmentId=null,this.partialNodeIdMapFromUserId=null,this.geometryIdMapFromDataId=null,this.dataBufferMapFromGeometryId=null,this.meshNodeMapFromNodeId=null,this.nodeIdMapOctantMap=null,this.selectedNodeIdArray=null,this.hoveredNodeIdArray=null,this.segmentIdMapFromPartialElementId&&(this.segmentIdMapFromPartialElementId=null),this.viewer=null}removeFromSegmentIdMap(e){for(var t=0,i=e.length;t<i;t++){var n=e[t],a=this.segmentIdMap[n];a&&(delete this.segmentIdMap[n],delete this.segmentPathMap[a][n],r.Utils.isOwnEmptyObject(this.segmentPathMap[a])&&delete this.segmentPathMap[a])}this.segmentIdArray=Object.keys(this.segmentIdMap)}loadSegmentsByPaths(e,t){var i=this,r=e.length;requestAnimationFrame(function e(n){var a=n;return function(){i.loadSegmentByTaskId(a,(function(){a<r-1?requestAnimationFrame(e(a+1)):t&&t()}))}}(0))}loadSegmentByTaskId(e,t){var i=this.addedSegmentPaths[e];-1!==i&&"-1"!==i?this.loader.load(i,(function(){t&&t()})):t&&t()}cacheSegmentBuffer(e,t,i){this.geometryIdMapFromDataId[e]||(this.geometryIdMapFromDataId[e]=[]);var r=e+"|"+t;this.geometryIdMapFromDataId[e].push(r),this.dataBufferMapFromGeometryId[r]=i}removeSegmentBufferByDataIds(e){for(var t=0,i=e.length;t<i;t++){var n=r.Utils.getEncodedId(e[t]),a=this.geometryIdMapFromDataId[n];if(a){for(var s=0,o=a.length;s<o;s++){var l=a[s];this.disposeGeometryByGeometryId(l),delete this.dataBufferMapFromGeometryId[l]}delete this.geometryIdMapFromDataId[n]}}}hasNodeInfoFromPartialNodeInfoMap(e){return!!this.partialNodeInfoMapFromNodeId[e]}classifyNodeInfos(e){this.partialNodeInfoMapFromNodeId[e.nodeId]=e,this.partialNodeIdMapFromSegmentId[e.segmentId]||(this.partialNodeIdMapFromSegmentId[e.segmentId]=[]),this.partialNodeIdMapFromSegmentId[e.segmentId].push(e.nodeId),this.partialParentUserIdMapFromSegmentId[e.segmentId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId][e.userId]=!0,this.partialNodeIdMapFromUserId[e.userId]||(this.partialNodeIdMapFromUserId[e.userId]=[]),this.partialNodeIdMapFromUserId[e.userId].push(e.nodeId)}getAllPartialSegmentIds(){return Object.keys(this.partialNodeIdMapFromSegmentId)}getNodeIdsBySegmentId(e){return this.partialNodeIdMapFromSegmentId[e]}getNodeInfoByNodeId(e){return this.partialNodeInfoMapFromNodeId[e]}getNodeIdsByUserId(e){return this.partialNodeIdMapFromUserId[e]}getNodeInfosBySegmentId(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],r=0,n=t.length;r<n;r++){var a=this.getNodeInfoByNodeId(t[r]);a&&i.push(a)}return i}getNodeInfosBySegmentIds(e){var t,i,r=[],n=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),a=n.usedSegmentIds,s=n.notUsedSegmentIds;for(t=0,i=a.length;t<i;t++)r=r.concat(this.getNodeInfosBySegmentId(a[t]));for(t=0,i=s.length;t<i;t++)r=r.concat(this.getNodeInfosBySegmentId(s[t]));return r}getMeshesNodeByNodeId(e){var t=this.getNodeInfoByNodeId(e);if(!t)return null;var i=this.getMeshNodesByNodeInfo(t);return i||null}getMeshNodesByNodeInfo(e){if(this.meshNodeMapFromNodeId[e.nodeId])return this.meshNodeMapFromNodeId[e.nodeId];var t=this.getGeometriesByNodeInfo(e);if(!t)return null;for(var i=[],n=this.model.materialManager.getMaterialById(e.materialId)||this.material,a=0,s=t.length;a<s;a++){var o=new r.MeshEx(t[a],n);o.spawn({databagId:this.model.databagId,fileId:this.model.fileId,matrix:e.matrix}),o.name=e.userId,o._nodeId=e.nodeId,o._oriMaterial=n,i.push(o)}if(!e.boundingBox){e.boundingBox=new THREE.Box3;for(var l=0,d=i.length;l<d;l++)e.boundingBox.union(i[l].computeBoundingBox());e.matrix&&e.boundingBox.applyMatrix4(e.matrix)}return this.meshNodeMapFromNodeId[e.nodeId]=i,this.meshNodeMapFromNodeId[e.nodeId]}getMeshNodesWithNotUsedSegment(e,t){for(var i=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),n=[],a=0,s=t.length;a<s;a++){var o=this.getNodeIdsBySegmentId(t[a]);if(o)for(var l=0,d=o.length;l<d;l++){var h=this.getNodeInfoByNodeId(o[l]);h&&i[h.parentUserId]&&n.push(h)}}return this.getMeshNodesByNodeInfos(n)}getMeshNodesByNodeInfos(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=this.getMeshNodesByNodeInfo(e[i]);if(n)for(var a=0,s=n.length;a<s;a++)t.push(n[a])}return t}getMeshNodesBySegmentId(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],r=0,n=t.length;r<n;r++){var a=this.getMeshesNodeByNodeId(t[r]);if(a)for(var s=0,o=a.length;s<o;s++)i.push(a[s])}return i}getMeshNodesBySegmentIds(e){for(var t=[],i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=i.usedSegmentIds,n=i.notUsedSegmentIds,a=0,s=r.length;a<s;a++)t=t.concat(this.getMeshNodesBySegmentId(r[a]));return t=t.concat(this.getMeshNodesWithNotUsedSegment(r,n))}getUserIdsBySegmentId(e){var t={},i={},r=this.getNodeIdsBySegmentId(e);if(r)for(var n=0,a=r.length;n<a;n++){var s=this.getNodeInfoByNodeId(r[n]);s&&(t[s.userId]=!0,i[s.parentUserId]=!0)}for(var o=this.elementIdMap[e],l=0,d=o.length;l<d;l++)i[o[l]]||(t[o[l]]=!0);return Object.keys(t)}getUserIdsBySegmentIds(e){for(var t=[],i=0,r=e.length;i<r;i++)t=t.concat(this.getUserIdsBySegmentId(e[i]));return t}getUserIdMapBySegmentIdAndParentUserId(e,t){return this.partialParentUserIdMapFromSegmentId[e]?this.partialParentUserIdMapFromSegmentId[e][t]:null}getParentUserIdsBySegmentId(e){return this.partialParentUserIdMapFromSegmentId[e]?Object.keys(this.partialParentUserIdMapFromSegmentId[e]):[]}getParentUserIdsBySegmentIds(e){for(var t=[],i=0,r=e.length;i<r;i++)t=t.concat(this.getParentUserIdsBySegmentId(e[i]));return t}hasSegmentIdFromSegmentIdMap(e){return!!this.segmentIdMap[e]}getGeometriesByNodeInfo(e){var t=e.geometryId;if(this.geometryMapFromGeometryId[t])return this.geometryMapFromGeometryId[t];var i=this.getGeometryDataBuffer(t),r=this._createBufferGeometry(e.type,i);return r?(r instanceof Array||(r=[r]),this.geometryMapFromGeometryId[t]=r,this.geometryMapFromGeometryId[t]):null}_createBufferGeometry(e,t){var i=r.ModelView.BaseDescriptor.EnumNodeItemType,n=null;switch(e){case i.MESH:case i.MESH_REF:if(!t)return null;(n=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(t.I,1)),n.setAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?n.setAttribute("normal",new THREE.BufferAttribute(t.N,3)):n.computeVertexNormals(),t.UV&&n.setAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case i.TUBE:case i.PIPE:n=r.GeomUtil.UnitCylinderInstance;break;case i.BOX:n=r.GeomUtil.UnitBoxInstance;break;case i.BOX_M:n=r.GeomUtil.getUnitTextureBox();break;case i.PIPE_M:n=r.GeomUtil.getUnitTextureCylinder();break;case i.LINE:if(!t)return null;(n=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(t.I,1)),n.setAttribute("position",new THREE.BufferAttribute(t.P,3))}return n}_isParameterizedGeometry(e){var t=r.ModelView.BaseDescriptor.EnumNodeItemType;return e===t.TUBE||e===t.PIPE||e===t.BOX||e===t.BOX_M||e===t.PIPE_M}getGeometryDataBuffer(e){return this.dataBufferMapFromGeometryId[e]}destroyGeometries(){for(var e=Object.keys(this.geometryMapFromGeometryId),t=0,i=e.length;t<i;t++)this.disposeGeometryByGeometryId(e[t]);this.disposeGeometryByGeometryId=null}disposeGeometryByGeometryId(e){if(this.geometryMapFromGeometryId[e]){for(var t=this.geometryMapFromGeometryId[e],i=0,r=t.length;i<r;i++)t[i].dispose();delete this.geometryMapFromGeometryId[e]}}getUsedAndNotUsedSegmentIdsBySegmentIds(e){var t,i,r={};for(t=0,i=e.length;t<i;t++)this.hasSegmentIdFromSegmentIdMap(e[t])&&(r[e[t]]=!0);var n=[],a=this.getAllPartialSegmentIds();for(t=0,i=a.length;t<i;t++)r[a[t]]||n.push(a[t]);return{usedSegmentIds:Object.keys(r),notUsedSegmentIds:n}}getNotUsedPartialUserIds(e,t){for(var i=[],n=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),a=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(t)),s=Object.keys(a),o=[],l=0,d=s.length;l<d;l++){var h=s[l];n[h]&&o.push(h)}for(var c=0,u=o.length;c<u;c++)for(var p=0,m=t.length;p<m;p++){var f=this.getUserIdMapBySegmentIdAndParentUserId(t[p],o[c]);f&&(i=i.concat(Object.keys(f)))}return i}updateNodeInfos(){var e=this,t=this._getTranslationMatrix();this.traversePartialElements((function(i,n,a){var s=e.getDescriptor().getNodeInfosByUserId(n);if(s)for(var o=0,l=s.length;o<l;o++){var d=s[o];d.finalState||(d.finalState=!0,d.nodeId=i+"|"+d.nodeId,e.hasNodeInfoFromPartialNodeInfoMap(d.nodeId)||(d.state=r.EnumObjectState.Visible,d.material=null,e._isParameterizedGeometry(d.type)?d.geometryId=d.geometryId:d.geometryId=i+"|"+d.geometryId,d.segmentId=a.segmentId||"",d.parentUserId=a.parentUserId,d.single=!0,d.uv=!1,d.isSegment=!0,t&&(d.matrix=d.matrix?d.matrix.premultiply(t):(new THREE.Matrix4).copy(t),d.boundingBox=d.boundingBox?d.boundingBox.applyMatrix4(t):null),e.classifyNodeInfos(d)))}})),this.initFilterManager()}_isSourceNodeInfoLoaded(e){return!!e.sourceLoaded}getNodeGroup(){return this.model._getNodeGroup("FlowSegments",{globalSpace:!0})}updateMeshNodes(){this.clearAllMeshNodes();var e=this.segmentIdArray;if(this.applyReplacementBySegmentIds(e),0!==e.length){for(var t=this.getMeshNodesBySegmentIds(e),i=this.getNodeGroup(),r=0,n=t.length;r<n;r++)i.add(t[r]),this.addMeshToOctantMap(t[r]);i.updateMatrixWorld(!0)}}addMeshToOctantMap(e){var t=this.model.manager,i=this.model.getEncodedDatabagId(),n=e._nodeId,a=this.getNodeInfoByNodeId(e._nodeId);t.addNodeInfoToOctantMap(i,a.cellId,a),t.addMeshToOctantMap(i,a.nodeId,new r.SingleCapsuleObject(a.nodeId,e)),this.nodeIdMapOctantMap[n]=!0}clearMeshNodesFromOctantMap(){for(var e=this.model.manager,t=this.model.getEncodedDatabagId(),i=Object.keys(this.nodeIdMapOctantMap),r=0,n=i.length;r<n;r++)e.removeMeshFromOctantMap(t,this.getNodeInfoByNodeId(i[r]));this.nodeIdMapOctantMap={}}clearAllMeshNodes(){this.getNodeGroup().clear(),this.clearMeshNodesFromOctantMap()}removeFromMeshNodeMap(e){for(var t=0,i=e.length;t<i;t++){var r=this.getNodeIdsBySegmentId(e[t]);if(r)for(var n=0,a=r.length;n<a;n++){var s=r[n];this.disposeGeometryByGeometryId(this.getNodeInfoByNodeId(s).geometryId),delete this.meshNodeMapFromNodeId[s]}}}applyReplacementBySegmentIds(e){if(!e||!e.length)return this.model.setReplacedUserIdMap(null),void this.model.applyReplacement();this.model.setReplacedUserIdMap(r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e))),this.model.applyReplacement()}restoreComponentsState(){for(var e=this.getMeshNodesBySegmentIds(this.segmentIdArray),t=0,i=e.length;t<i;t++)e[t].material=e[t]._oriMaterial,e[t].visible=!0}restoreMeshNodeMaterialByNodeIds(e){for(var t=0,i=e.length;t<i;t++){var r=this.getMeshesNodeByNodeId(e[t]);if(r)for(var n=0,a=r.length;n<a;n++)r[n].material=r[n]._oriMaterial}}updateFilterManager(){var e=this.model.getFilter();let t={};t[this.model.fileId]=this.model.getAllNodeInfos(),e.reinitFilterManager(t)}_updateNodeInfosBySourceNodeInfo(){Object.keys(this.partialNodeInfoMapFromNodeId).forEach((e=>{const t=this.partialNodeInfoMapFromNodeId[e];if(this._isSourceNodeInfoLoaded(t))return;const i=this.model.getModelDescriptor().getNodeInfosByUserId(t.parentUserId);t.sourceLoaded=!!i,t.materialId=i?i[0].materialId:-1,t.cellId=i?i[0].cellId:0,t.userData=t.userData?t.userData:i?i[0].userData:null}))}addToNodeInfoMap(){this.removeFromNodeInfoMap(),this._updateNodeInfosBySourceNodeInfo(),this.usedNodeInfos=this.getNodeInfosBySegmentIds(this.segmentIdArray),this.model.getModelDescriptor().addToNodeInfoMap(this.usedNodeInfos)}removeFromNodeInfoMap(){this.usedNodeInfos&&(this.model.getModelDescriptor().removeFromNodeInfoMap(this.usedNodeInfos),this.usedNodeInfos=void 0)}initFilterManager(){this.addToNodeInfoMap(),this.updateFilterManager()}deinitFilterManager(){this.removeFromNodeInfoMap(),this.updateFilterManager()}applyFilter(){for(var e=this.model.getFilter(),t=e._hasHiddenFileIdFilter(),i=e._hasVisibleFilter(),r=e._hasOverrideMaterialFilter(),n=e._hasTransparentFilter(),a=e._getMaterialByName("scene"),s=this.getMeshNodesBySegmentIds(this.segmentIdArray),o=0,l=s.length;o<l;o++){var d=s[o];d.visible=!0,d.material=d._oriMaterial;var h=this.getNodeInfoByNodeId(d._nodeId);if(t&&e._isHiddenFileId(h)||i&&!1===e._isVisible(h))d.visible=!1;else if(n&&e._isTransparent(h))d.material=a;else if(r&&e._hasOverrideMaterial(h)){var c=e._getOverrideMaterial(h);if(!c||""===c.name)continue;d.material=e._getMaterialByName(c.name)}else;}}applySelection(){if(!r.GlobalData.PickingEffect){var e=this.model.manager.sceneState,t=this.model.selectedMaterial,i=e.getSelection();this.clearSelection();var n=this.selectedNodeIdArray;this.traverseMeshNodeMapByUserIds(i,(function(e,i){for(var r=0,a=e.length;r<a;r++)e[r].material=t;n.push(i)}))}}clearSelection(){r.GlobalData.PickingEffect||this.selectedNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.selectedNodeIdArray),this.selectedNodeIdArray.length=0)}applyHover(){var e=this.model.manager,t=e.sceneState;if(t.hoverId&&!t.isSelected(t.hoverId)){this.clearHover();var i=this.model.getFilter(),r=this.hoveredNodeIdArray;this.traverseMeshNodeMapByUserIds([t.hoverId],(function(n,a,s){for(var o=0,l=n.length;o<l;o++){var d=n[o],h=e.getOverrideMaterialByNodeInfo(s,this.model.materialManager.getMaterialById(s.materialId))||i._getOverrideMaterial(s)||d._oriMaterial;d.material=t.getHoverMaterial(h)}r.push(a)}))}}clearHover(){this.hoveredNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.hoveredNodeIdArray),this.hoveredNodeIdArray.length=0)}traverseMeshNodeMapByUserIds(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i],a=this.getNodeIdsByUserId(e[i]);if(a&&a.length)for(var s=0,o=a.length;s<o;s++){var l=a[s],d=this.getNodeInfoByNodeId(l),h=this.getMeshNodesByNodeInfo(d);h&&t(h,l,d,n)}}}getSegmentIdsByPartialElementId(e){if(this.segmentIdMapFromPartialElementId)return this.segmentIdMapFromPartialElementId[e];var t=this.segmentIdMapFromPartialElementId={};return this.traversePartialElements((function(e,i,r){t[i]||(t[i]=[]),t[i].push(r.segmentId),t[r.parentUserId]||(t[r.parentUserId]=[]),t[r.parentUserId].push(r.segmentId)})),t[e]}cachePartialElements(e,t){this.partialElementMap[e]||(this.partialElementMap[e]={}),this.partialElementMap[e][t.partialElementId]={userId:t.partialElementId,segmentId:t.segmentId,parentUserId:t.elementId}}traversePartialElements(e){for(var t in this.partialElementMap)for(var i in this.partialElementMap[t])e(t,i,this.partialElementMap[t][i])}getSegmentIsolateOption(){return e.IsolateOption}getSegmentMetadata(e,t,i,r){this.loader._loadMetadata(t,i,r)}resetFilterState(){this.isolateApplied&&(this.model.getFilter().clearIsolation(),this.isolateApplied=!1)}unloadSegments(e){this.resetFilterState(),this.deinitFilterManager(),this.removeFromSegmentIdMap(e),this.removeFromMeshNodeMap(e),this.updateMeshNodes()}loadSegments(e,t){if(e instanceof Array&&0!==e.length){this.elementIdMap={};for(var i={},n={},a=0,s=e.length;a<s;a++){var o,l=e[a].id;o=e[a].paths.length?e[a].paths[0].databag:-1,i[l]=o,n[o]||(n[o]={}),n[o][l]=!0,this.elementIdMap[l]=e[a].elementIds||[]}var d=r.Utils.getDifferentialIdxs(i,this.segmentIdMap);this.segmentIdMap=d.objCurrUsedIdxs,this.segmentIdArray=Object.keys(this.segmentIdMap);var h=r.Utils.getDifferentialIdxs(n,this.segmentPathMap);this.segmentPathMap=h.objCurrUsedIdxs,this.addedSegmentPaths=h.addIdxs;var c=!1;if(d.removeIdxs.length&&(c=!0,this.removeFromMeshNodeMap(d.removeIdxs)),h.removeIdxs.length&&(c=!0,this.removeSegmentBufferByDataIds(h.removeIdxs)),0!==this.addedSegmentPaths.length){this.applyReplacementBySegmentIds(null);var u=this;this.loader.resetTaskCount(),this.loadSegmentsByPaths(this.addedSegmentPaths,(function(){u.updateNodeInfos(),u.updateMeshNodes(),t&&t()}))}else c&&this.updateMeshNodes()}}hideComponentsBySegment(e){var t=this.model.getFilter(),i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.hideByIds(r)}showComponentsBySegment(e){var t=this.model.getFilter(),i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.showByIds(r)}isolateComponentsBySegment(t,i){const r=this.model.getFilter(),n=this.getUsedAndNotUsedSegmentIdsBySegmentIds(t),a=this.getUserIdsBySegmentIds(n.usedSegmentIds),s=this.getNotUsedPartialUserIds(n.usedSegmentIds,n.notUsedSegmentIds),o=a.concat(s);switch(this.restoreComponentsState(),i){case e.IsolateOption.HIDDEN:r.setIsolationByIds(a,"HideOthers");break;case e.IsolateOption.TRANSLUCENT:r.setIsolationByIds(o,"TranslucentOthers");break;case e.IsolateOption.PARTLYTRANSLUCENT:r.setIsolationByIds(o,"HideOthers"),s.length&&r.setIsolationByIds(a,"TranslucentOthers")}this.isolateApplied=!0}disable(){this.getNodeGroup().visible=!1,this.applyReplacementBySegmentIds(null)}enable(){this.getNodeGroup().visible=!0,this.applyReplacementBySegmentIds(this.segmentIdArray)}getDescriptor(){return this.loader.descriptor}getMeshesByUserIds(e){const t=model.getLengthUnitsMatrix();for(let i=0,r=e.length;i<r;i++){const r=e[i],n=this.getNodeIdsByUserId(r);if(n&&n.length)for(let e=0,i=n.length;e<i;e++){const i=this.getNodeInfoByNodeId(n[e]);if(!this.isPickableNode(i))continue;const a=this.getMeshNodesByNodeInfo(i);if(a)for(let e=0,n=a.length;e<n;e++)this.model.minDistanceObjects[r].push({mesh:a[e],matrix:i.matrix,unitsMatrix:t,boundingBox:i.boundingBox})}}}isPickableNode(e){var t=this.model.getFilter(),i=t._hasHiddenFileIdFilter(),r=t._hasVisibleFilter(),n=t._hasTransparentFilter();return!(i&&t._isHiddenFileId(e)||r&&!1===t._isVisible(e))&&(!n||!t._isTransparent(e))}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingSegmentMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getTranslationMatrix(){if(void 0!==this._translationMatrix)return this._translationMatrix;const e=void 0===this.model.config.view?[0,0,0]:this.model.config.view.translation;return this._translationMatrix=e?(new THREE.Matrix4).makeTranslation(-e[0],-e[1],-e[2]):null,this._translationMatrix}}e.IsolateOption=r.Utils.freezeObject({HIDDEN:0,TRANSLUCENT:1,PARTLYTRANSLUCENT:2}),r.SegmentManager=e}(),r.SegmentLoader=class{constructor(e){this.model=e,this.loader=new THREE.FileLoader,this.url=new r.Loader.Url({serverUrl:"",databagId:""}),this.currentTaskCount=0,this.maxTaskCount=0,this.mpkTaskManager=new r.TaskManager,this.databagId="",this.descriptor=new r.ModelView.DefaultDescriptor,this.cfg=null}destroy(){this.model=null,this.loader=null,this.url=null,this.mpkTaskManager=null,this.descriptor.destroy(),this.descriptor=null,this.cfg=null}load(e,t){var i=this;this.finishedCallback=t,this.databagId=e,this.url.databagPath=e,this.loader.setResponseType(""),this.loader.load(this.url.projectUrl(),(function(e){var r;try{r=JSON.parse(e)}catch(e){return console.log("Config data exceptions!"),void(t&&t())}i.cfg=r;var n=r.metadata,a=n.scenes?1:0;if(0===a)return console.log("empty scene!"),void(t&&t());var s=n.mpks||0;if(0!==s){var o=n.symbol?1:0,l=n.userdata?1:0,d=n.lines||0;i.maxTaskCount+=a,i.maxTaskCount+=o,i.maxTaskCount+=1,i.maxTaskCount+=l,i.maxTaskCount+=d,i.maxTaskCount+=s,i._loadScene(),o&&i._loadSymbol(),i._loadUserId(),l&&i._loadUserData(),d&&i._loadLine(),i._loadMpks(s)}else t&&t()}))}_loadMetadata(e,t,i){var n=this;e=r.Utils.getEncodedId(e),this.loader.setResponseType(""),this.loader.load(t,(function(t){for(var r=JSON.parse(t).partialElements,a=0,s=r.length;a<s;a++)n.model.cachePartialElements(e,r[a]);i&&i()}),void 0,(function(e){i&&i()}))}_loadScene(){var e=this,t=this.cfg.metadata;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.sceneUrl(0),(function(i){e.descriptor.mapSceneReader[0]=new r.Loader.SceneReader(i,t.version),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadLine(){var e=this,t=r.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.lineUrl(),(function(i){for(var n=new r.Loader.LineReader(i),a=0,s=n.header.lineCount;a<s;++a){var o=n.getPtBuffer(a),l=n.getIdxBuffer(a);if(null!=o&&null!=l){var d=n.getLineData(a);if(0===d.lineType){for(var h=[],c=1,u=l.length;c<u;c++)h.push(l[c-1]),h.push(l[c]);h.length&&(l=h)}e.model.cacheSegmentBuffer(t,"line-"+d.line_id,{P:o,I:l})}else r.Logger.log("Error Geometry!")}n=null,e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadSymbol(){var e=this,t=this.cfg.metadata;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.symbolUrl(),(function(i){e.descriptor.symbolReader=new r.Loader.SymbolReader(i,t.version),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadUserId(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.userIdUrl(),(function(t){e.descriptor.userIdReader=new r.Loader.IdReader(t),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadUserData(){var e=this;this.loader.setResponseType(""),this.loader.load(this.url.userDataUrl(),(function(t){e.descriptor.userDataReader=new r.Loader.UserDataReader(t),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadMpks(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this.loadMpk.bind(this))}loadMpk(e,t){var i=this,n=r.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.mpkUrl(e),(function(e){for(var a=new r.Loader.MPKReader(e),s=a.header.meshCount,o=new THREE.Matrix4,l=0;l<s;++l){var d=a.getPtBuffer(l),h=a.getIdxBuffer(l);if(null!=d&&null!=h){var c=a.getNormalBuffer(l),u=a.getMeshData(l),p=a.getUVBuffer(l);0!==u.baseScale&&(d=new Float32Array(d),o.identity(),o.setPosition(new THREE.Vector3(u.baseX,u.baseY,u.baseZ)),o.scale(new THREE.Vector3(u.baseScale,u.baseScale,u.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(o,d)),i.model.cacheSegmentBuffer(n,u.mesh_id,{P:d,I:h,N:c,UV:p})}else r.Logger.log("Error Geometry!")}a=null,t(),i._onTaskFinished()}),void 0,(function(e){i._onTaskFinished()}))}_onTaskFinished(){this.currentTaskCount++,this.currentTaskCount>=this.maxTaskCount&&(this.prepareData(),this.finishedCallback())}prepareData(){this.descriptor.parseItemData(),this.descriptor.classifyAllNodeInfo()}resetTaskCount(){this.maxTaskCount=0,this.currentTaskCount=0}},r.BimtilesSegmentLoader=class{constructor(){this._loader=new THREE.FileLoader}destroy(){this._loader=void 0}load(e,t,i){const n=`${e.databagPath}/config.json`;let a=this._loader;r.Storage.IndexedDBHelper.loadWithStorage("InfoData",n,(()=>new Promise(((e,t)=>{a.setResponseType(""),a.load(n,(t=>{a=null,e(t)}),void 0,(e=>{a=null,t(e)}))}))),(e=>{try{const r=JSON.parse(e);if(!this._isSupportedVersion(r))return console.log("The segment is not supported!"),void(i&&i());t&&t(r)}catch(e){console.log(e),i&&i()}}),(e=>{console.log("Config load error!"),i&&i(e)}))}_isSupportedVersion(e){return e.metadata&&"BimtilesCompiler v0.03"===e.metadata.generateTool}loadMetadata(e,t,i){const r=this._loader;r.setResponseType(""),r.load(e,(e=>{const i=JSON.parse(e);t&&t(i)}),void 0,(()=>{i&&i()}))}},function(){class e extends r.BimTilesModelV3{constructor(e={}){super(e.viewer,e.manager,e.parameters)}_createNewTileset(e){return new r.Workers.Tileset(e)}_createLoader(e){this.tilesLoader=new r.Workers.TilesLoaderV3(e)}_crateFilterManger(){return new r.Workers.FilterManagerV3(this)}_crateMaterialManger(e){return e.borderLineVisible=this._enableBorderLine,new r.Workers.MaterialManagerV3(e)}getAllUserIds(){return this.tilesLoader.tileReader.getAllUserIds()}load(){const e=this._config.count&&this._config.count.element;this._createTileSet();const t=new Promise(((t,i)=>{this._tileset.loadTileset(this.url,(e=>{this.getTransforms().boundingBox=e._boundingBox.clone(),this.modelLoaded=!0,this.filter._updateFilterManager();const i=this.viewer.getScene().getRawMatrixGlobal();e.updateGlobalMatrix(i),this.updateModelMaximumScreenSpaceError(),t()}),(()=>{i()}),e)}));return t}}r.FlowSegment.BimtilesSegmentModel=e}(),r.FlowSegment.BimtilesSegmentShip=class{constructor(e,t){this._segmentManager=e,this._modelId=t.modelId,this._model=t.owner,this._model.registerPlugin(this),this._viewer=this._model.viewer,this._segmentModelMap={},this._databagIdMap={},this._partialNodeInfoMapFromUserId={},this._partialParentUserIdMapFromSegmentId={},this._partialUserIdMapFromSegmentId={},this._partialUserIdMapFromParentId={},this._segmentIdMapFromElementId={},this._aliveSegmentIdMap={},this._aliveSegmentPathMap={},this._aliveSegmentIds=[],this._aliveElementIdMap={},this._aliveSegementModelIdMap={},this._aliveSegementModelIdMapLast={},this._hiddenSegmentUserIds=[],this._hiddenSegmentUserIdsLast=[],this._isolateUserIdsLastForHostModel=[],this._isolateApplied=!1}destroy(){this._segmentManager.removeSegmentShipByModelId(this._modelId),this._segmentManager=null,this._aliveSegmentIdMap=null,this._aliveSegmentIds=null,this._aliveSegmentPathMap=null,this._aliveElementIdMap=null,this._aliveSegementModelIdMap=null,this._aliveSegementModelIdMapLast=null,this._hiddenSegmentUserIds=null,this._hiddenSegmentUserIdsLast=null,this._isolateUserIdsLastForHostModel=null,this._databagIdMap=null,this._partialNodeInfoMapFromUserId=null,this._partialParentUserIdMapFromSegmentId=null,this._partialUserIdMapFromSegmentId=null,this._partialUserIdMapFromParentId=null,this._segmentIdMapFromElementId=null,this._segmentModelMap=null,this._viewer=null,this._model=null,super.destroy()}traversePluginModels(e){this._traverseSegmentModels(e)}update(){this._resetStateForAllComponents(),this._collectHiddenSegmentUserIds(),this._hideSegmentComponentsAccordingToHostModelState()}preUpdate(){this._resetFilterState()}setPartialElements(e,t){if(!this._databagIdMap[e]){this._databagIdMap[e]=!0;for(var i=0,r=t.length;i<r;i++){const e=t[i];this._classifyNodeInfos({userId:e.partialElementId,segmentId:e.segmentId,parentUserId:e.elementId})}}}_classifyNodeInfos(e){const{userId:t,segmentId:i,parentUserId:r}=e;this._partialNodeInfoMapFromUserId[t]={userId:t,segmentId:i,parentUserId:r},this._partialParentUserIdMapFromSegmentId[i]||(this._partialParentUserIdMapFromSegmentId[i]={}),this._partialParentUserIdMapFromSegmentId[i][r]=!0,this._partialUserIdMapFromSegmentId[i]||(this._partialUserIdMapFromSegmentId[i]={}),this._partialUserIdMapFromSegmentId[i][t]=!0,this._partialUserIdMapFromParentId[r]||(this._partialUserIdMapFromParentId[r]={}),this._partialUserIdMapFromParentId[r][t]=!0,this._segmentIdMapFromElementId[t]||(this._segmentIdMapFromElementId[t]=[]),this._segmentIdMapFromElementId[t].push(i),this._segmentIdMapFromElementId[r]||(this._segmentIdMapFromElementId[r]=[]),this._segmentIdMapFromElementId[r].push(i)}loadSegments(e,t){if(!(e instanceof Array)||0===e.length)return;this._aliveElementIdMap={},this._aliveSegementModelIdMap={};let i={},n={};for(let t=0,r=e.length;t<r;t++){const r=e[t].id,a=e[t].paths;let s=-1;a.length&&(s=a[0].databag,this._aliveSegementModelIdMap[s]=a[0].fileId+""),i[r]=s,n[s]||(n[s]={}),n[s][r]=!0,this._aliveElementIdMap[r]=e[t].elementIds||[]}let a=!1;const s=r.Utils.getDifferentialIdxs(i,this._aliveSegmentIdMap);this._aliveSegmentIdMap=s.objCurrUsedIdxs,this._aliveSegmentIds=Object.keys(this._aliveSegmentIdMap),s.removeIdxs.length&&(a=!0);const o=r.Utils.getDifferentialIdxs(n,this._aliveSegmentPathMap);this._aliveSegmentPathMap=o.objCurrUsedIdxs;const l=o.addIdxs;this._addedSegmentPaths=l;const d=o.removeIdxs;d.length&&(a=!0,this._unloadSegmentDatabags(d,this._aliveSegementModelIdMapLast)),this._aliveSegementModelIdMapLast=this._aliveSegementModelIdMap,0!==l.length?this._loadSegmentsByPaths(l,(()=>{this._updateSegmentNodeInfos(),this._updateSegmentNodes(),t&&t()})):a&&this._updateSegmentNodes()}_loadSegmentsByPaths(e,t){const i=this,r=e.length;requestAnimationFrame(function e(n){let a=n;return function(){i._loadSegmentByTaskId(a,(function(){a<r-1?requestAnimationFrame(e(a+1)):t&&t()}))}}(0))}_loadSegmentByTaskId(e,t){const i=this._addedSegmentPaths[e];if(-1===i||"-1"===i)return void(t&&t());const n=this._aliveSegementModelIdMap[i]||r.Utils.getEncodedId(i),a={modelId:n,databagPath:i,viewer:this._viewer,wireFrameVisibilityOption:this._model.getLoader().wireFrameVisibilityOption,enableBorderLine:this._model.isBorderLineVisible()};let s=this._viewer.modelManager;this._segmentManager.getLoader().load(a,(e=>{if(e){let i=this._createSegmentModel(e,a);i.load().then((()=>{s.addModel(i),s=void 0,this._segmentModelMap[n]=i,t&&t()})).catch((e=>{console.log(`[BIMFACE ERROR]:some error occurred when load data of model ${i.id}.`),i.destroy(),i=null,t&&t()}))}else console.log("[BIMFACE ERROR]:some error occurred when load config of model."),t&&t()}))}_createSegmentModel(e,t){return new r.FlowSegment.BimtilesSegmentModel({viewer:t.viewer,manager:t.viewer.modelManager,parameters:{config:e,rootPath:e.metadata.root,resourceType:e.metadata.content,modelId:t.modelId,serverUrl:"",databagId:t.databagPath,enableBorderLine:t.enableBorderLine,wireFrameVisibilityOption:t.wireFrameVisibilityOption,dataVersion:r.BimTilesVersionControl.VERSION_3,disableUserData:!1}})}unloadSegments(e){this._resetFilterState(),this._removeFromSegmentIdMap(e),this._updateSegmentNodes()}_resetFilterState(){if(this._isolateApplied){this._traverseSegmentModels((e=>{e.getFilter().clearIsolation()}));const e=this._isolateUserIdsLastForHostModel;e&&e.length&&this._model.getFilter().clearIsolationByIds(e),this._isolateApplied=!1,this._isolateUserIdsLastForHostModel=[]}}_removeFromSegmentIdMap(e){for(let t=0,i=e.length;t<i;t++){const i=e[t],n=this._aliveSegmentIdMap[i];n&&(delete this._aliveSegmentIdMap[i],delete this._aliveSegmentPathMap[n][i],r.Utils.isOwnEmptyObject(this._aliveSegmentPathMap[n])&&(this._unloadSegmentDatabags([n],this._aliveSegementModelIdMap),delete this._aliveSegmentPathMap[n]))}this._aliveSegmentIds=Object.keys(this._aliveSegmentIdMap)}_getPartialUserIdMapBySegmentId(e){return this._partialUserIdMapFromSegmentId[e]}_getPartialUserIdMapBySegmentIds(e){let t={};return e.forEach((e=>{const i=this._getPartialUserIdMapBySegmentId(e);for(const e in i)Object.hasOwnProperty.call(i,e)&&(t[e]=!0)})),t}_getUserIdsBySegmentId(e){const t=this._getPartialUserIdMapBySegmentId(e),i=t?Object.keys(t):[],r=this._getPartialParentUserIdMapBySegmentId(e),n=this._aliveElementIdMap[e];let a={};return n&&n.length&&n.forEach((e=>{r&&r[e]||(a[e]=!0)})),{partialUserIds:i,noPartialUserIds:Object.keys(a)}}_getUserIdsBySegmentIds(e){let t=[],i=[];return e.forEach((e=>{const r=this._getUserIdsBySegmentId(e),n=r.partialUserIds;n&&t.push(...n);const a=r.noPartialUserIds;a&&i.push(...a)})),{partialUserIds:t,noPartialUserIds:i}}_getPartialParentUserIdMapBySegmentId(e){return this._partialParentUserIdMapFromSegmentId[e]}_getPartialParentUserIdMapBySegmentIds(e){let t={};return e.forEach((e=>{const i=this._getPartialParentUserIdMapBySegmentId(e);for(const e in i)Object.hasOwnProperty.call(i,e)&&(t[e]||(t[e]=!0))})),t}_getPartialUserIdMapOffLimits(e){let t={};const i=this._getAllPartialParentUserIdMap();for(const r in i)if(Object.hasOwnProperty.call(i,r)){if(e[r])continue;const n=i[r];for(const e in n)Object.hasOwnProperty.call(n,e)&&(t[e]=!0)}return t}_getPartialSegmentIdsBySegmentIds(e){let t={};for(let i=0,r=e.length;i<r;i++)this._isUsedSegmentId(e[i])&&(t[e[i]]=!0);const i=this._getAllPartialSegmentIds();let r=[];for(let e=0,n=i.length;e<n;e++)t[i[e]]||r.push(i[e]);return{usedSegmentIds:Object.keys(t),notUsedSegmentIds:r}}_isUsedSegmentId(e){return!!this._aliveSegmentIdMap[e]}_getAllPartialSegmentIds(){return Object.keys(this._partialUserIdMapFromSegmentId)}_getPartialUserIdsForNotUsed(e){let t={};const i=this._getPartialParentUserIdMapBySegmentIds(e),r=Object.keys(i),n=this._getPartialUserIdsByParentIds(r),a=this._getPartialUserIdMapBySegmentIds(e);return n.forEach((e=>{a[e]||(t[e]=!0)})),Object.keys(t)}_getParentUserIdByUserId(e){const t=this._partialNodeInfoMapFromUserId[e];return t?t.parentUserId:null}_getAllPartialParentUserIdMap(){return this._partialUserIdMapFromParentId}_getPartialUserIdMapByParentId(e){return this._partialUserIdMapFromParentId[e]}_getPartialUserIdsByParentIds(e){let t={};return e.forEach((e=>{const i=this._getPartialUserIdMapByParentId(e);for(const e in i)Object.hasOwnProperty.call(i,e)&&(t[e]=!0)})),Object.keys(t)}_unloadSegmentDatabags(e,t){e.forEach((e=>{let i=t[e];if(!i)return;i=i||r.Utils.getEncodedId(e);let n=this._segmentModelMap[i];n&&(this._viewer.modelManager.removeModel(n.id),n.destroy(),n=null),delete this._segmentModelMap[i]}))}_updateSegmentNodes(){this._resetStateForAllComponents(),this._applyReplacementBySegmentIds(this._aliveSegmentIds),this._collectHiddenSegmentUserIds(),this._hideSegmentComponentsAccordingToHostModelState()}_resetStateForAllComponents(){this._showSegmentComponentsAccordingToHostModelState()}_collectHiddenSegmentUserIds(){const e=this._model.getFilter(),t=this._aliveElementIdMap,i=Object.keys(t);let r={};i.forEach((i=>{const n=t[i],a=this._getPartialParentUserIdMapBySegmentId(i);n.forEach((t=>{if(e.isHidden(t)&&a&&a[t]){const e=this._getPartialUserIdMapByParentId(t);e&&Object.keys(e).forEach((e=>{r[e]=!0}))}}))})),this._hiddenSegmentUserIds=Object.keys(r),this._hiddenSegmentUserIdsLast=[...this._hiddenSegmentUserIds]}_getUserDataParserByModel(e){return e.tilesLoader.tileReader.userDataParser}_getUserIdParserByModel(e){return e.tilesLoader.tileReader.userIdParser}_updateSegmentNodeInfos(){const e=this._model,t=this._getUserDataParserByModel(e),i=this._aliveElementIdMap,n=Object.keys(i);let a={};n.forEach((e=>{const t=this._getPartialParentUserIdMapBySegmentId(e);t&&i[e].forEach((e=>{t[e]&&void 0===a[e]&&(a[e]=!0)}))}));let s=[];Object.keys(a).forEach((e=>{const t=this._getPartialUserIdMapByParentId(e);if(!t)return;const i=Object.keys(t);s.push(...i)})),0!==s.length&&this._traverseSegmentModels((i=>{const n=this._getUserDataParserByModel(i),a=this._getUserIdParserByModel(i);n._replaced||(n._replaced=!0,n.shallowCopy(t)),s.forEach((t=>{const n=i.getNodeInfosByUserId(t);if(!n)return;const s=a.getIndexByUserId(t);if(void 0===s)return;const o=this._getParentUserIdByUserId(t),l=e.getNodeInfosByUserId(o);if(!l||0===l.length)return;const d=l[0].userData;if(!d)return;n.forEach((e=>{r.Utils.isEmptyObjectSimple(e.userData)&&(e.userData=d)}));const h=l[0].userdataId;void 0!==h&&a.updateUserdataIdByUserIdIndex(s,h)}))}))}_hideSegmentComponentsAccordingToHostModelState(){const e=this._hiddenSegmentUserIds;e&&e.length&&this._traverseSegmentModels((t=>{t.getFilter().hideByIds(e)}))}_showSegmentComponentsAccordingToHostModelState(){const e=this._hiddenSegmentUserIdsLast;e&&e.length&&this._traverseSegmentModels((t=>{t.getFilter().showByIds(e)}))}getSegmentIdsByPartialElementId(e){return this._getSegmentIdsByElementId(e)}_getSegmentIdsByElementId(e){return this._segmentIdMapFromElementId[e]}_traverseSegmentModels(e){Object.keys(this._segmentModelMap).forEach((t=>{const i=this._segmentModelMap[t];e&&e(i)}))}hideComponentsBySegmentIds(e){this._resetStateForAllComponents();const t=this._getPartialSegmentIdsBySegmentIds(e),i=this._getUserIdsBySegmentIds(t.usedSegmentIds),r=i.partialUserIds;this._traverseSegmentModels((e=>{e.getFilter().hideByIds(r)}));const n=i.noPartialUserIds;this._model.getFilter().hideByIds(n),this._hideSegmentComponentsAccordingToHostModelState()}showComponentsBySegmentIds(e){this._resetStateForAllComponents();const t=this._getPartialSegmentIdsBySegmentIds(e),i=this._getUserIdsBySegmentIds(t.usedSegmentIds),r=i.partialUserIds;this._traverseSegmentModels((e=>{e.getFilter().showByIds(r)}));const n=i.noPartialUserIds;this._model.getFilter().showByIds(n),this._hideSegmentComponentsAccordingToHostModelState()}isolateComponentsBySegmentIds(e,t){this._resetStateForAllComponents();const i=this._getPartialSegmentIdsBySegmentIds(e).usedSegmentIds,n=this._getUserIdsBySegmentIds(i),a=n.partialUserIds,s=n.noPartialUserIds,o=this._getPartialUserIdsForNotUsed(i),l=[...a,...o],d=this._model;switch(t){case r.SegmentManager.IsolateOption.HIDDEN:this._traverseSegmentModels((e=>{e.getFilter().setIsolationByIds(a,"HideOthers")})),d.getFilter().setIsolationByIds(s,"HideOthers");break;case r.SegmentManager.IsolateOption.TRANSLUCENT:this._traverseSegmentModels((e=>{e.getFilter().setIsolationByIds(l,"TranslucentOthers")})),d.getFilter().setIsolationByIds(s,"TranslucentOthers");break;case r.SegmentManager.IsolateOption.PARTLYTRANSLUCENT:this._traverseSegmentModels((e=>{e.getFilter().setIsolationByIds(l,"HideOthers"),o.length&&e.getFilter().setIsolationByIds(a,"TranslucentOthers")})),d.getFilter().setIsolationByIds(s,"TranslucentOthers")}this._hideSegmentComponentsAccordingToHostModelState(),this._isolateUserIdsLastForHostModel=[...s],this._isolateApplied=!0}disable(){this._traverseSegmentModels((e=>{e.setVisible(!1)})),this._applyReplacementBySegmentIds(null)}enable(){this._traverseSegmentModels((e=>{e.setVisible(!0)})),this._applyReplacementBySegmentIds(this._aliveSegmentIds)}_applyReplacementBySegmentIds(e){const t=this._model;let i=null,r=null;e&&e.length&&(i=this._getPartialParentUserIdMapBySegmentIds(e),r=this._getPartialUserIdMapOffLimits(i)),t.setReplacedUserIdMap(i),t.applyReplacement(),this._traverseSegmentModels((e=>{e.setReplacedUserIdMap(r),e.applyReplacement()}))}},function(){class e extends r.FlowSegment.AbstractSegmentManager{constructor(e){super(),this._viewer=e,this._loader=new r.BimtilesSegmentLoader,this._segmentShipMap={}}destroy(){this._destroyAllSegmentShips(),this._loader.destroy(),this._loader=null,this._viewer=null,super.destroy()}_destroyAllSegmentShips(){Object.keys(this._segmentShipMap).forEach((e=>{this._segmentShipMap[e]&&(this._segmentShipMap[e].destroy(),this._segmentShipMap[e]=null)})),this._segmentShipMap={}}removeSegmentShipByModelId(e){this._segmentShipMap[e]&&delete this._segmentShipMap[e]}getLoader(){return this._loader}_getSegmentShip(e){const t=this._viewer.modelManager;void 0===e&&(e=t.getFirstModel().id);let i=this._segmentShipMap[e];if(i)return i;const n=t.getModel(e);if(n)return this._segmentShipMap[e]=new r.FlowSegment.BimtilesSegmentShip(this,{modelId:e,owner:n}),this._segmentShipMap[e];console.log("[BIMFACE ERROR]: There is no corresponding source model for the segment.")}getSegmentMetadata(e,t,i,r,n,a){this.getLoader().loadMetadata(i,(t=>{const i=t.partialElements;this._getSegmentShip(a).setPartialElements(e,i),t.partialElements=void 0,r&&r()}),(()=>{n&&n()}))}disable(e){const t=this._getSegmentShip(e);t&&t.disable()}enable(e){const t=this._getSegmentShip(e);t&&t.enable()}loadSegments(e,t,i){const r=this._getSegmentShip(i);r&&r.loadSegments(e,t)}unloadSegments(e,t){const i=this._getSegmentShip(t);i&&i.unloadSegments(e)}hideComponentsBySegment(e,t){const i=this._getSegmentShip(t);i&&i.hideComponentsBySegmentIds(e)}showComponentsBySegment(e,t){const i=this._getSegmentShip(t);i&&i.showComponentsBySegmentIds(e)}isolateComponentsBySegment(e,t,i){const r=this._getSegmentShip(i);r&&r.isolateComponentsBySegmentIds(e,t)}getSegmentIsolateOption(){return r.SegmentManager.IsolateOption}}r.BimtilesSegmentManager=e}(),function(){class e extends r.ObjectGroup{constructor(e){super(r.ObjectGroupType.VIEWSHED,{priority:20}),e=e||{},this._position=new THREE.Vector3(0,0,0),this._direction=new THREE.Vector3(0,0,-1),this._visibleAreaColor=new THREE.Vector4(0,255,0,.8),this._hiddenAreaColor=new THREE.Vector4(255,0,0,.8),this._distance=null!=e.distance?e.distance:200,this._horizontalFov=null!=e.horizontalFov?e.horizontalFov:2*Math.PI/3,this._verticalFov=null!=e.verticalFov?e.verticalFov:Math.PI/2,this._translucenceAvailable=!1!==e.translucenceAvailable,this._frustumVisible=e.frustumVisible,this._effectVisible=!0,this.visible=this._frustumVisible,this._up=new THREE.Vector3(0,1,0),this._right=new THREE.Vector3(1,0,0),this._unitAngle=5,this._cornerLeftTop=new THREE.Vector3,this._cornerRightTop=new THREE.Vector3,this._cornerLeftBottom=new THREE.Vector3,this._cornerRightBottom=new THREE.Vector3,this._viewer=null,this._lineGeometry=new THREE.BufferGeometry,this._lineMaterial=new THREE.LineBasicMaterial({color:16777215}),this._lineMesh=new THREE.LineSegments(this._lineGeometry,this._lineMaterial),this._sphereGeometry=new THREE.BufferGeometry,this._sphereMaterial=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this._sphereMesh=new THREE.Mesh(this._sphereGeometry,this._sphereMaterial),this._sphereMesh.visible=!1,this.camera=new THREE.PerspectiveCamera,this.viewMatrix=new THREE.Matrix4,this.viewProjMatrix=new THREE.Matrix4,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter});var t=new THREE.Vector3;this.updateViewMatrix=function(){t.copy(this._position),t.add(this._direction),this.camera.position.copy(this._position),this.camera.lookAt(t),this.camera.updateMatrixWorld(!0),this.viewMatrix.copy(this.camera.matrixWorld).invert()};var i=new THREE.Vector3;new THREE.Vector3;this.updateProjMatrix=function(){var e=Math.cos(this._horizontalFov/2),t=Math.tan(this._verticalFov/2),r=Math.atan(e*t),n=this._distance*Math.cos(r)*Math.cos(this._horizontalFov/2);i.copy(this._position),i.addScaledVector(this._direction,n);var a=n*Math.tan(this._horizontalFov/2),s=n*Math.tan(this._verticalFov/2);this._cornerLeftTop.copy(i),this._cornerLeftTop.addScaledVector(this._right,-a),this._cornerLeftTop.addScaledVector(this._up,s),this._cornerRightTop.copy(i),this._cornerRightTop.addScaledVector(this._right,a),this._cornerRightTop.addScaledVector(this._up,s),this._cornerLeftBottom.copy(i),this._cornerLeftBottom.addScaledVector(this._right,-a),this._cornerLeftBottom.addScaledVector(this._up,-s),this._cornerRightBottom.copy(i),this._cornerRightBottom.addScaledVector(this._right,a),this._cornerRightBottom.addScaledVector(this._up,-s);var o=Math.tan(.5*this._horizontalFov)/Math.tan(.5*this._verticalFov);this.camera.fov=THREE.Math.radToDeg(this._verticalFov),this.camera.aspect=o,this.camera.near=.01,this.camera.far=Math.max(this._distance),this.camera.updateProjectionMatrix()},this.getViewProjMatrix=function(){return this.viewProjMatrix.multiplyMatrices(this.camera.projectionMatrix,this.viewMatrix),this.viewProjMatrix},this.createSideLines=function(){for(var e=[],t=[this._cornerLeftBottom,this._cornerRightBottom,this._cornerRightTop,this._cornerLeftTop],i=0;i<t.length;i++)e.push(this._position.x,this._position.y,this._position.z),e.push(t[i].x,t[i].y,t[i].z);return e};var n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=[],d=this;this.createTopSideLines=function(){var e=[];function t(e,t,i){var r=[];if(i){for(var n=e;n<t;)if(r.push(n),(n+=d._unitAngle)>=t){r.push(t);break}}else for(n=t;n>e;)if(r.push(n),(n-=d._unitAngle)<=e){r.push(e);break}return r}n.copy(this._cornerLeftTop),n.sub(this._position),a.copy(this._cornerRightTop),a.sub(this._position),s.copy(this._cornerRightBottom),s.sub(this._position);var i,r,h=THREE.Math.radToDeg(a.angleTo(s)),c=THREE.Math.radToDeg(n.angleTo(a)),u=[{axis:"up",outerAngle:-this._horizontalFov/2,innerAngles:t(-h/2,h/2,!0)},{axis:"right",outerAngle:this._verticalFov/2,innerAngles:t(-c/2,c/2,!0)},{axis:"up",outerAngle:this._horizontalFov/2,innerAngles:t(-h/2,h/2,!1)},{axis:"right",outerAngle:-this._verticalFov/2,innerAngles:t(-c/2,c/2,!1)}];l=[];for(var p=0;p<u.length;p++){"up"==u[p].axis?(i=this._up,r=this._right):"right"==u[p].axis&&(i=this._right,r=this._up);for(var m=[],f=0;f<u[p].innerAngles.length;f++){o.copy(this._direction),o.applyAxisAngle(r,THREE.Math.degToRad(u[p].innerAngles[f])),o.applyAxisAngle(i,u[p].outerAngle),o.multiplyScalar(this._distance);var g=new THREE.Vector3;g.copy(this._position),g.add(o),m.push(g),l.push(g)}for(f=0;f<m.length-1;f++)e.push(m[f].x,m[f].y,m[f].z),e.push(m[f+1].x,m[f+1].y,m[f+1].z)}return e};var h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Quaternion;this.createTopLines=function(){var e=[];h.copy(this._position),h.addScaledVector(this._direction,this._distance),c.copy(h),c.sub(this._position),c.normalize();for(var t=[],i=0,r=0;r<l.length;r++){p.copy(l[r]),p.sub(this._position),p.normalize(),u.copy(c),u.cross(p),u.normalize();for(var n=THREE.Math.radToDeg(c.angleTo(p)),a=[],s=0;;s+=this._unitAngle){s>=n&&(s=n),m.setFromAxisAngle(u,THREE.Math.degToRad(s)),o.copy(c),o.applyQuaternion(m);var d=new THREE.Vector3;if(d.copy(this._position),d.addScaledVector(o,this._distance),a.push(d),s>=n)break}i=Math.max(i,a.length),t.push(a)}for(r=0;r<t.length;r++)for(s=0;s<t[r].length-1;s++)e.push(t[r][s].x,t[r][s].y,t[r][s].z),e.push(t[r][s+1].x,t[r][s+1].y,t[r][s+1].z);for(r=1;r<i;r++)for(s=0;s<t.length-1;s++)t[s][r]&&t[s+1][r]&&(e.push(t[s][r].x,t[s][r].y,t[s][r].z),e.push(t[s+1][r].x,t[s+1][r].y,t[s+1][r].z));return e},this.updateMeshGeometry=function(){this.updateViewMatrix(),this.updateProjMatrix(),this._sphereGeometry=new THREE.SphereGeometry(this._distance,40,40),this._sphereGeometry.translate(this._position.x,this._position.y,this._position.z);var e=[];return e=(e=(e=e.concat(this.createSideLines())).concat(this.createTopSideLines())).concat(this.createTopLines()),this._lineGeometry.deleteAttribute("position"),this._lineGeometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(e),3)),this._lineGeometry},this.initPrimitive=function(){this.updateMeshGeometry(),this._lineMesh.geometry=this._lineGeometry,this.add(this._lineMesh),this._sphereMesh.geometry=this._sphereGeometry,this.add(this._sphereMesh)},this.updatePrimitive=function(){this.updateMeshGeometry(),this._lineMesh.geometry=this._lineGeometry,this._sphereMesh.geometry=this._sphereGeometry},r.Viewshed.prototype.getId=function(){return this.uuid};var f={x:0,y:0,z:0};r.Viewshed.prototype.getPositon=function(){return f.x=this._position.x,f.y=this._position.y,f.z=this._position.z,f};var g=new THREE.Vector3;r.Viewshed.prototype.setPosition=function(e){g.x=e.x,g.y=e.y,g.z=e.z,this._position!=g&&(this._position.copy(g),this.updatePrimitive())};var v={x:0,y:0,z:0};r.Viewshed.prototype.getDirection=function(){return v.x=this._direction.x,v.y=this._direction.y,v.z=this._direction.z,v};var y=new THREE.Vector3(0,1,0),M=new THREE.Vector3;r.Viewshed.prototype.setDirection=function(e){M.x=e.x,M.y=e.y,M.z=e.z,M.normalize(),this._direction!=M&&(0!==M.lengthSq()?(this._direction.copy(M),this._right.crossVectors(y,M),0===this._right.lengthSq()&&(1===Math.abs(y.z)?M.x+=1e-4:M.z+=1e-4,M.normalize(),this._right.crossVectors(y,M)),this._right.normalize(),this._up.crossVectors(M,this._right),this.updatePrimitive()):r.Logger.warn("WARNING: Invalid direction when CLOUD.Viewshed.prototype.setDirection()"))};var E={x:0,y:0,z:0,w:0};r.Viewshed.prototype.getVisibleAreaColor=function(){return E.x=this._visibleAreaColor.x,E.y=this._visibleAreaColor.y,E.z=this._visibleAreaColor.z,E.w=this._visibleAreaColor.w,E};var x=new THREE.Vector4;r.Viewshed.prototype.setVisibleAreaColor=function(e){x.x=e.red||e.x?e.red||e.x:0,x.y=e.green||e.y?e.green||e.y:0,x.z=e.blue||e.z?e.blue||e.z:0,x.w=e.alpha||e.w?e.alpha||e.w:0,this._visibleAreaColor!=x&&(this._visibleAreaColor.copy(x),this.updatePrimitive())};var _={x:0,y:0,z:0,w:0};r.Viewshed.prototype.getHiddenAreaColor=function(){return _.x=this._hiddenAreaColor.x,_.y=this._hiddenAreaColor.y,_.z=this._hiddenAreaColor.z,_.w=this._hiddenAreaColor.w,_};var b=new THREE.Vector4;r.Viewshed.prototype.setHiddenAreaColor=function(e){b.x=e.red||e.x?e.red||e.x:0,b.y=e.green||e.y?e.green||e.y:0,b.z=e.blue||e.z?e.blue||e.z:0,b.w=e.alpha||e.w?e.alpha||e.w:0,this._hiddenAreaColor!=b&&(this._hiddenAreaColor.copy(b),this.updatePrimitive())},r.Viewshed.prototype.getDistance=function(){return this._distance},r.Viewshed.prototype.setDistance=function(e){this._distance!=e&&(this._distance=e,this.updatePrimitive())},r.Viewshed.prototype.getHorizontalFov=function(){return this._horizontalFov},r.Viewshed.prototype.setHorizontalFov=function(e){this._horizontalFov!=e&&(this._horizontalFov=e,this.updatePrimitive())},r.Viewshed.prototype.getVerticalFov=function(){return this._verticalFov},r.Viewshed.prototype.setVerticalFov=function(e){this._verticalFov!=e&&(this._verticalFov=e,this.updatePrimitive())},r.Viewshed.prototype.setTranslucenceAvailable=e=>{this._translucenceAvailable=e},r.Viewshed.prototype.getTranslucenceAvailable=()=>this._translucenceAvailable,r.Viewshed.prototype.show=function(){this._effectVisible=!0,this._frustumVisible&&(this.visible=!0),this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.hide=function(){this._effectVisible=!1,this.visible=!1,this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.setFrustumVisible=function(e){this._frustumVisible=e,this.visible=e,this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.isFrustumVisible=function(){return this._frustumVisible},r.Viewshed.prototype.isEffectVisible=function(){return!0===this._effectVisible},this.setPosition(null!=e.position?e.position:this._position),this.setDirection(null!=e.direction?e.direction:this._direction),this.setVisibleAreaColor(null!=e.visibleAreaColor?e.visibleAreaColor:this._visibleAreaColor),this.setHiddenAreaColor(null!=e.hiddenAreaColor?e.hiddenAreaColor:this._hiddenAreaColor),this.initPrimitive()}}r.Viewshed=e}(),(()=>{class e extends r.EditTool{constructor(e){super(r.EditToolMode.VIEW_SHED_ANALYSIS),this.viewer=e,this.scene=e.getScene(),this.viewshed=new r.Viewshed({position:new THREE.Vector3(0,0,0),direction:new THREE.Vector3(0,0,-1),distance:500,horizontalFov:2*Math.PI/3,verticalFov:Math.PI/2}),this.viewshed.show(),this.scene.objectGroups.add(this.viewshed)}enable(e){e?this.viewshed.show():this.viewshed.hide()}destroy(){}onEnter(){this.enable(!0)}onExit(){this.enable(!1)}processMouseDown(e){}processHover(e){}processMouseUp(e){}processMouseMove(e){}processTouchstart(e){}processTouchmove(e){}processTouchend(e){}}r.ViewshedTool=e})(),r.ViewshedManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.modelManager=e.modelManager,this._viewsheds=[],this._maxViewshedCount=4,this._viewshedContents=[],this._viewshedDepthMaps=[];for(var t=0;t<this._maxViewshedCount;t++)this._viewshedDepthMaps.push(new THREE.Texture),this._viewshedContents.push({viewshedViewProjMatrix:new THREE.Matrix4,viewshedViewMatrix:new THREE.Matrix4,viewshedVisibleColor:new THREE.Vector4,viewshedHiddenColor:new THREE.Vector4,viewshedMinMax:new THREE.Vector2,viewshedLogDepthBufFC:1});this.forceUpdate=!1}destroy(){this._viewsheds=null,this._viewshedContents=null,this._viewshedDepthMaps=null,this.scene=null,this.modelManager=null,this.viewer=null}addViewshed(e){return this._viewsheds.push(e),this.scene.objectGroups.add(e),e._viewer=this.viewer,e}getViewshedById(e){for(var t=0;t<this._viewsheds.length;t++)if(this._viewsheds[t].getId()==e)return this._viewsheds[t]}getViewsheds(){return this._viewsheds}hideById(e){var t=this.getViewshedById(e);t&&t.hide(),this.forceUpdate=!0,this.update()}showById(e){var t=this.getViewshedById(e);t&&t.show(),this.update()}removeById(e){for(var t=0;t<this._viewsheds.length;t++)if(this._viewsheds[t].getId()==e){this.scene.objectGroups.remove(this._viewsheds[t]),this._viewsheds.splice(t,1);break}this.forceUpdate=!0,this.update()}clear(){this._resetContents();for(var e=0;e<this._viewsheds.length;e++)this.scene.objectGroups.remove(this._viewsheds[e]);this._viewsheds=[],this.forceUpdate=!0,this.update()}update(){if(!(this._viewsheds.length<=0&&!1===this.forceUpdate))if(this._viewsheds.length>this._maxViewshedCount)console.warn("WARNING: Viewshed count exceeds max count limit");else{this._resetContents();for(var e=this.viewer.rendererManager.renderer,t=this.viewer.getScene(),i=0,r=0;r<this._viewsheds.length;r++)if(this._viewsheds[r].isEffectVisible()){var n=this._viewsheds[r].camera,a=this._viewsheds[r].depthRenderTarget;e.renderCustomDepth&&(this._viewsheds[r]._sphereMesh.visible=!0,!0===this._viewsheds[r].getTranslucenceAvailable()?e.renderCustomDepthByOpacity(e.renderer,t,n,a,.7,!0):e.renderCustomDepth(e.renderer,t,n,a,!0),this._viewsheds[r]._sphereMesh.visible=!1);var s=this._viewsheds[r].getVisibleAreaColor(),o=this._viewsheds[r].getHiddenAreaColor();this._viewshedContents[i].viewshedViewProjMatrix.copy(this._viewsheds[r].getViewProjMatrix()),this._viewshedContents[i].viewshedViewMatrix.copy(this._viewsheds[r].viewMatrix),this._viewshedContents[i].viewshedVisibleColor.set(s.x/255,s.y/255,s.z/255,s.w),this._viewshedContents[i].viewshedHiddenColor.set(o.x/255,o.y/255,o.z/255,o.w),this._viewshedContents[i].viewshedMinMax.set(n.near,n.far),this._viewshedContents[i].viewshedLogDepthBufFC=2/(Math.log(n.far+1)/Math.LN2),this._viewshedDepthMaps[i]=a.texture,i++}this.modelManager.updateMaterialsValue("viewshedCount",0==i?-1:i),this.modelManager.updateMaterialsValue("viewshedContents",this._viewshedContents),this.modelManager.updateMaterialsValue("viewshedDepthMaps",this._viewshedDepthMaps),this.forceUpdate=!0}}_resetContents(){for(var e=0;e<this._maxViewshedCount;e++)this._viewshedContents[e].viewshedViewProjMatrix.identity(),this._viewshedContents[e].viewshedViewMatrix.identity(),this._viewshedContents[e].viewshedVisibleColor.set(0,1,0,.8),this._viewshedContents[e].viewshedHiddenColor.set(1,0,0,.8),this._viewshedContents[e].viewshedMinMax.set(0,0),this._viewshedContents[e].viewshedLogDepthBufFC=1}},r.VideoCast=class{constructor(e){e=e||{},this._id=e.id,this._position=void 0!==e.position?new THREE.Vector3(e.position.x,e.position.y,e.position.z):new THREE.Vector3(0,0,0),this._direction=void 0!==e.direction?new THREE.Vector3(e.direction.x,e.direction.y,e.direction.z):new THREE.Vector3(0,0,-1),this._distance=void 0!==e.distance?e.distance:2e3,this._horizontalFov=void 0!==e.horizontalFov?e.horizontalFov:2*Math.PI/3,this._verticalFov=void 0!==e.verticalFov?e.verticalFov:Math.PI/2,this._projectorMap=void 0!==e.projectorMap?e.projectorMap:new THREE.Texture,this._up=new THREE.Vector3(0,1,0),this._right=new THREE.Vector3(1,0,0),this.camera=new THREE.PerspectiveCamera,this.viewMatrix=new THREE.Matrix4,this.viewProjMatrix=new THREE.Matrix4,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this._visible=!0,this.scratchAt=new THREE.Vector3,this.updateViewMatrix(),this.updateProjMatrix()}destroy(){this._id=void 0,this._position=null,this._direction=null,this._distance=void 0,this._horizontalFov=void 0,this._verticalFov=void 0,this._projectorMap=null,this._up=null,this._right=null,this.camera=null,this.viewMatrix=null,this.viewProjMatrix=null,this.depthRenderTarget=null,this._visible=void 0,this.scratchAt=null}setVisible(e){this._visible=e}getVisible(){return this._visible}updateViewMatrix(){this.scratchAt.copy(this._position),this.scratchAt.add(this._direction),this.camera.position.copy(this._position),this.camera.lookAt(this.scratchAt),this.camera.updateMatrixWorld(!0),this.viewMatrix.copy(this.camera.matrixWorld).invert()}updateProjMatrix(){const e=Math.tan(.5*this._horizontalFov)/Math.tan(.5*this._verticalFov);this.camera.fov=THREE.Math.radToDeg(this._verticalFov),this.camera.aspect=e,this.camera.near=.01,this.camera.far=this._distance,this.camera.updateProjectionMatrix()}getViewMatrix(){return this.viewMatrix}getViewProjMatrix(){return this.viewProjMatrix.multiplyMatrices(this.camera.projectionMatrix,this.viewMatrix),this.viewProjMatrix}getId(){return this._id}setProjectorMap(e){this._projectorMap=e}getProjectorMap(){return this._projectorMap}getPosition(){return this._position}setPosition(e){this._position!=e&&(this._position=e)}getDirection(){return this._direction}setDirection(e){this._direction!=e&&(this._direction=e)}getDistance(){return this._distance}setDistance(e){this._distance!=e&&(this._distance=e)}getHorizontalFov(){return this._horizontalFov}setHorizontalFov(e){this._horizontalFov!=e&&(this._horizontalFov=e)}getVerticalFov(){return this._verticalFov}setVerticalFov(e){this._verticalFov!=e&&(this._verticalFov=e)}},r.VideoCastManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.modelManager=e.modelManager,this._videoCasts=[],this._maxVideoCastCount=4,this._videoCastContents=[],this._videoCastDepthMaps=[],this._videoCastProjectorMaps=[],this.firstAnimate=!0}destroy(){this._cancelAnimate();for(let e=0;e<this._videoCasts.length;e++)this.scene.objectGroups.remove(this._videoCasts[e]);this._videoCasts=null,this._videoCastContents=null,this._videoCastDepthMaps=null,this.scene=null,this.modelManager=null,this.viewer=null}addVideoCast(e){this._videoCasts.length>=this._maxVideoCastCount?console.warn("WARNING: VideoCast count exceeds max count limit"):(this._videoCasts.push(e),this.addVideoTexture(),this.update(),!0===this.firstAnimate&&(this.firstAnimate=!1,this._animate()))}addVideoTexture(){this._videoCastDepthMaps.push(new THREE.Texture),this._videoCastProjectorMaps.push(new THREE.Texture),this._videoCastContents.push({viewProjMatrix:new THREE.Matrix4,viewMatrix:new THREE.Matrix4,logDepthBufFC:1})}getVideoCastById(e){for(var t=0;t<this._videoCasts.length;t++)if(this._videoCasts[t].getId()==e)return this._videoCasts[t]}getVideoCasts(){return this._videoCasts}hideById(e){var t=this.getVideoCastById(e);t&&t.setVisible(!1),this.update()}showById(e){var t=this.getVideoCastById(e);t&&t.setVisible(!0),this.update()}removeById(e){for(var t=0;t<this._videoCasts.length;t++)if(this._videoCasts[t].getId()==e){this._videoCasts.splice(t,1);break}this.update(),0===this.getVisibleCount()&&(this.firstAnimate=!0,this._cancelAnimate())}clear(){for(let e=0;e<this._videoCasts.length;e++)this.scene.objectGroups.remove(this._videoCasts[e]);this._videoCasts=[],this.update()}getVisibleCount(){let e=0;for(let t=0;t<this._videoCasts.length;t++)this._videoCasts[t].getVisible()&&e++;return e}update(){const e=this.viewer.rendererManager.renderer,t=this.viewer.getScene();let i=0;for(let r=0;r<this._videoCasts.length;r++)if(this._videoCasts[r].getVisible()){const n=this._videoCasts[r].camera,a=this._videoCasts[r].depthRenderTarget;e.renderCustomDepth&&e.renderCustomDepth(e.renderer,t,n,a,!0),this._videoCastContents[i].viewProjMatrix.copy(this._videoCasts[r].getViewProjMatrix()),this._videoCastContents[i].viewMatrix.copy(this._videoCasts[r].getViewMatrix()),this._videoCastContents[i].logDepthBufFC=2/(Math.log(n.far+1)/Math.LN2),this._videoCastDepthMaps[i]=a.texture,this._videoCastProjectorMaps[i]=this._videoCasts[r].getProjectorMap(),i++}this.modelManager.updateMaterialsValue("videoCastCount",0==i?-1:i),this.modelManager.updateMaterialsValue("videoCastContents",this._videoCastContents),this.modelManager.updateMaterialsValue("videoCastDepthMaps",this._videoCastDepthMaps),this.modelManager.updateMaterialsValue("videoCastProjectorMaps",this._videoCastProjectorMaps)}_animate(){let e=()=>{this.animationId=requestAnimationFrame(e),0!==this.getVisibleCount()&&this.viewer.render()};e()}_cancelAnimate(){cancelAnimationFrame(this.animationId),this.animationId=0}},r.TerrainExcavation=class{constructor(e){this.geometry=null,this.material=null,this.id=e.id||"",this.visible=e.visible||!1,this.terrainOperationManager=e.terrainOperationManager}init(e){for(var t=e.length,i=new Array,n=0,a=new THREE.Vector3,s=new Array(2*t),o=0;o<t;o++)a.copy(e[o]),a.y=0,s[2*o]=a.x,s[2*o+1]=a.z,a.toArray(i,n),n+=3;var l=r.earcut(s),d=new THREE.BufferGeometry;d.setIndex(l),d.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),d.computeBoundingBox(),this.geometry=d;var h=new THREE.ShaderMaterial({uniforms:{},side:THREE.DoubleSide,vertexShader:"\n                    void main()\n                    {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    }\n                ",fragmentShader:"\n                    precision highp float;\n                    void main()\n                    {\n                        gl_FragColor = vec4(1.0, 0.0, 0.0 , 1.0);\n                    }\n                "});this.material=h}dispose(){this.geometry.dispose(),this.material.dispose()}setId(e){this.id=e}getId(){return this.id}setVisible(e){this.visible=e}getVisible(){return this.visible}getAABBMin(){return this.geometry.boundingBox.min}getAABBMax(){return this.geometry.boundingBox.max}},N=new THREE.Vector3,r.TerrainFlatten=class{constructor(e){this.visible=e.visible||!1,this.id=e.id||"",this.elevation=e.elevation||0,this.viewer=e.viewer,this.modelIds=e.modelIds,this.boundingBox=new THREE.Box3,this.pointsInDrawing=[]}init(e){this.pointsInDrawing=[];for(var t=new THREE.Vector3(1/0,0,1/0),i=new THREE.Vector3(-1/0,0,-1/0),r=0;r<e.length;r++)this.pointsInDrawing.push(new THREE.Vector2(e[r].x,e[r].z)),t.x=Math.min(t.x,e[r].x),t.z=Math.min(t.z,e[r].z),i.x=Math.max(i.x,e[r].x),i.z=Math.max(i.z,e[r].z);this.boundingBox.min.copy(t),this.boundingBox.max.copy(i)}setId(e){this.id=e}getId(){return this.id}getModelIds(){return this.modelIds}setModelId(e){this.modelIds=e}setVisible(e){this.visible=e}getVisible(){return this.visible}isInRegionDrawing(e,t){return-1!==this.modelIds.indexOf(t)&&r.Utils.pointInPolygon(e,this.pointsInDrawing)}isIntersectRegionBboxDrawing(e,t){return-1!==this.modelIds.indexOf(t)&&this.boundingBox.intersectsBox(e)}transformElevation(e){N.set(0,0,this.elevation),(N=this.viewer.worldToDrawing(N)).applyMatrix4(e),this.worldElevation=N.z}transformPolygon(e){for(var t=[],i=0;i<this.pointsInDrawing.length;i++)N.set(this.pointsInDrawing[i].x,0,this.pointsInDrawing[i].y),N.applyMatrix4(e),t.push(new THREE.Vector2(N.x,N.y));return t}},r.TerrainOperationManager=class{constructor(e){this.frustum=new THREE.Frustum,this.viewer=e,this.terrainExcavations={},this.terrainExcavationsNumber=0,this.terrainFlattens=[]}render(e){}pickExcavation(e){}calcOrthoCamera(){}setSize(e,t){}dispose(){this.clearExcavationRegions(),this.clearFlattenRegions(),this.frustum=null,this.viewer=null,this.terrainExcavations=null,this.terrainFlattens=null}addExcavationRegion(e,t){if(this.terrainExcavations.hasOwnProperty(e))console.warn("the terrain Excavation id '"+e+"' is existed.");else{var i=new r.TerrainExcavation({terrainOperationManager:this,id:e,visible:!0});i.init(t),this.terrainExcavations[e]=i,this.isDirty=!0,this.terrainExcavationsNumber++}}hideExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].setVisible(!1),this.isDirty=!0)}showExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].setVisible(!0),this.isDirty=!0)}removeExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].dispose(),delete this.terrainExcavations[e[t]],this.isDirty=!0,this.terrainExcavationsNumber--)}clearExcavationRegions(){for(var e in this.terrainExcavations)this.terrainExcavations[e].dispose(),delete this.terrainExcavations[e],this.isDirty=!0,this.terrainExcavationsNumber--}addFlattenRegion(e,t,i,n){if(this._hasFlattenRegion(e))console.warn("the terrain flatten id '"+e+"' is existed.");else{var a=new r.TerrainFlatten({viewer:this.viewer,id:e,visible:!0,elevation:i,modelIds:n});a.init(t),this.terrainFlattens.push(a),this._updateTerrainForFlatten(n)}}removeFlattenRegionsById(e){for(var t=this.terrainFlattens.length-1;t>=0;--t)if(e.indexOf(this.terrainFlattens[t].getId())>=0){const e=this.terrainFlattens[t].getModelIds();this.terrainFlattens.splice(t,1),this._updateTerrainForFlatten(e)}}clearFlattenRegions(){for(let e=this.terrainFlattens.length-1;e>=0;--e){const t=this.terrainFlattens[e].getModelIds();this.terrainFlattens.splice(e,1),this._updateTerrainForFlatten(t)}this.terrainFlattens=[]}isInFlattenRegionDrawing(e,t){for(var i=this.terrainFlattens.length-1;i>=0;--i)if(this.terrainFlattens[i].isInRegionDrawing(e,t))return this.terrainFlattens[i];return!1}isIntersectFlattenBboxDrawing(e,t){for(let i=this.terrainFlattens.length-1;i>=0;--i)if(this.terrainFlattens[i].isIntersectRegionBboxDrawing(e,t))return!0;return!1}_hasFlattenRegion(e){for(var t=0;t<this.terrainFlattens.length;t++)if(e==this.terrainFlattens[t].getId())return!0;return!1}_updateTerrainForFlatten(e){e.map((e=>{const t=this.viewer.modelManager.getModel(e);t&&t.tileManager?t.tileManager.updateTileMeshForFlatten():t.updateTileMeshForFlatten()}))}};r.Walkthrough=class{constructor(e){this.name=e||"",this.keyFrameList=[],this.walkthroughTime=5,this.isFrameTimeMode=!1,this.interpolateType=0,this.fps=60,this.parts=100,this.rotateSpeed=Math.PI/this.fps/4,this.parameters={segments:this.walkthroughTime*this.fps*this.parts,closed:!1,curveType:"centripetal",tension:.25},this.modificationId=0,this.allocateSegmentList=null,this.frameTimeSegmentList=null}addKeyFrame(e){var t=new THREE.Vector3(e.position.x,e.position.y,e.position.z),i=new THREE.Vector3(e.target.x,e.target.y,e.target.z);const{id:r,name:n,timeBetweenFrames:a,stayTime:s}=e;this.keyFrameList.push({id:r,name:n,timeBetweenFrames:a,stayTime:s,position:t,target:i}),this.modificationId++}setKeyFrameList(e){this.keyFrameList=[];for(var t=0,i=e.length;t<i;t++)this.addKeyFrame(e[t])}removeKeyFrame(e){var t=this.keyFrameList.length;e>=0&&e<t&&(this.keyFrameList.splice(e,1),this.modificationId++)}checkFrameTimeMode(){return this.isFrameTimeMode=!1,this.keyFrameList.some((e=>{const{timeBetweenFrames:t,stayTime:i}=e;return isNaN(t)&&isNaN(i)||(this.isFrameTimeMode=!0),this.isFrameTimeMode})),this.isFrameTimeMode}getKeyFrames(){return this.keyFrameList}getKeyFrameCount(){return this.keyFrameList.length}clearFrames(){this.keyFrameList=[]}getJumpCounts(e){var t=e/(1e3/this.fps)*this.parts;return t=parseInt(t)}setWalkthroughTime(e){const t=Object.prototype.toString.call(e);"[object Array]"===t?e.forEach((e=>{if(void 0!==e.id){const t=this.keyFrameList.find((t=>t.id.toString()===e.id.toString()));t&&(t.timeBetweenFrames=e.timeBetweenFrames||0,t.stayTime=e.stayTime||0)}})):"[object Number]"===t&&(this.keyFrameList.forEach((e=>{delete e.timeBetweenFrames,delete e.stayTime})),this.walkthroughTime=e,this.setSegments(e*this.fps*this.parts)),this.modificationId++}setWalkthroughTimeByFrame(){let e=this.keyFrameList.length;this.allocateSegmentList=[],this.frameTimeSegmentList=[],this.keyFrameList.forEach(((t,i)=>{const{timeBetweenFrames:r,stayTime:n}=t,a={move:0,stay:0},s=i===e-1;isNaN(r)||s||(a.move=r*this.fps*this.parts),isNaN(n)||(a.stay=n*this.fps*this.parts),0===a.move&&(a.move=1),this.frameTimeSegmentList.push(a),s||this.allocateSegmentList.push(a.stay+a.move)})),this.allocateSegmentList.length&&this.setSegments(this.allocateSegmentList.reduce(((e,t)=>e+t)))}setInterpolateType(e){this.interpolateType=e,1==e&&this.setSplineTension(0)}getInterpolateType(){return this.interpolateType}setName(e){this.name=e}getName(){return this.name}getKeyFramePositions(){for(var e=[],t=0,i=this.keyFrameList.length;t<i;t++){var r=this.keyFrameList[t];e.push(r.position)}return e}getKeyFramePosition(e){return this.keyFrameList[e].position}getKeyFrameDirection(e){var t=this.keyFrameList[e];return t.target.clone().sub(t.position)}getKeyFrameTarget(e){return this.keyFrameList[e].target}allocateSegments(){if(this.checkFrameTimeMode())this.setWalkthroughTimeByFrame();else{for(var e=[],t=0,i=this.keyFrameList.length;t<i-1;t++){var r=this.keyFrameList[t].position,n=this.keyFrameList[t+1].position;e.push(n.clone().sub(r).length())}var a=0,s=0;for(i=e.length;s<i;s++)a+=e[s];var o=this.getSegments(),l=0;for(i=e.length;0!=a&&l<i;l++)e[l]/=a,e[l]*=this.getSegments(),e[l]=Math.floor(e[l]),o-=e[l];for(var d=0;d<o;d++)e[d]>0&&e[d]++;this.allocateSegmentList=e}}getAllocateSegmentCount(e){return null==this.allocateSegmentList&&this.allocateSegments(),this.allocateSegmentList[e]}getSplineParam(e,t){null==this.allocateSegmentList&&this.allocateSegments();var i=this.allocateSegmentList.length;return(e+t/this.allocateSegmentList[e])/i}calculateDeltaAngleCurrentKeyFrame(e,t,i,r){var n=this.allocateSegmentList,a=i.clone().sub(t),s=this.getKeyFrameDirection(e+1),o=a.angleTo(s);if(this.isFrameTimeMode){if(this.frameTimeSegmentList[e].stay>r)return 0}const l=n[e]-r;if(0==l){var d=Math.floor(o/this.rotateSpeed)*this.parts;return n[e]=d,o/d}return o/l}getRotateAxis(e){var t=this.getKeyFrameDirection(e),i=this.getKeyFrameDirection(e+1);return t.clone().cross(i.clone()).normalize()}getRotateAxisCurrentKeyFrame(e,t,i){var r=i.clone().sub(t),n=this.getKeyFrameDirection(e+1);return r.clone().cross(n.clone()).normalize()}calculateDeltaOffsetCurrentKeyFrame(e,t,i,r){var n=this.allocateSegmentList;if(this.isFrameTimeMode){if(this.frameTimeSegmentList[e].stay>r)return new THREE.Vector3}const a=n[e]-r;var s=t,o=this.getKeyFramePositions()[e+1];return 0==a?new THREE.Vector3:o.clone().sub(s).divideScalar(a)}setSplineTension(e){e>=0&&e<=1&&(this.parameters.tension=e,this.modificationId++)}setSegments(e){this.parameters.segments=e,this.modificationId++}getSegments(){return this.parameters.segments}setParameters(e){this.parameters=e,this.modificationId++}getParameters(){return this.parameters}setFps(e){this.fps=e,this.modificationId++}getModificationId(){return this.modificationId}};r.WalkthroughPlayer=class{constructor(e){this.viewer=e,this.walkthrough=null,this.bPause=!1,this.bContinue=!1,this.bStop=!1,this.spline=null,this.reqid=0,this.playBinded=this.play.bind(this),this.recordId=-1,this.keyFrameIdx=0,this.count=-1,this.camera=this.viewer.cameraControl.camera,this.pausePlayCallback=null,this.stopPlayCallback=null,this.timeRecorder={last:0,pause:0,deltaTime:0},this.keyFrameCallback=null}setWalkthrough(e){this.walkthrough=e,this.bPause=!1,this.recordId=-1,this.spline=null,this.keyFrameIdx=0,this.count=-1}updateCamera(e,t){this.camera.position.add(e),this.camera.target.addVectors(this.camera.position,t),this.camera.up.copy(new THREE.Vector3(0,1,0)),this.viewer.cameraControl._changeCallBack()}play(){this.viewer.cameraControl.lockPan=!0,this.reqid=requestAnimationFrame(this.playBinded),0==this.bContinue?(this.bContinue=!0,this.timeRecorder.deltaTime=this.timeRecorder.pause-this.timeRecorder.last):this.timeRecorder.deltaTime=performance.now()-this.timeRecorder.last,this.timeRecorder.last=performance.now();var e=this.walkthrough.getJumpCounts(this.timeRecorder.deltaTime);if(this.recordId!==this.walkthrough.getModificationId()&&(this.walkthrough.allocateSegments(),this.recordId=this.walkthrough.getModificationId()),this.bPause)return this.viewer.cameraControl.lockPan=!1,this.timeRecorder.pause=performance.now(),console.log("Walkthrough pause now,key frame index is "+this.keyFrameIdx),cancelAnimationFrame(this.reqid),this.pausePlayCallback&&this.pausePlayCallback(),this.bPause=!1,void(this.bContinue=!1);var t=this.walkthrough.getKeyFrameCount(),i=this.walkthrough.getAllocateSegmentCount(this.keyFrameIdx);if(0==i)this.keyFrameIdx++,1===this.keyFrameIdx?this.triggerKeyFrameCallback(0):this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=-1;else{if(this.bStop||this.keyFrameIdx==t-1)return this.viewer.cameraControl.lockPan=!1,void this.stop(!0);if(-1==this.count){this.timeStart=performance.now(),this.triggerKeyFrameCallback(this.keyFrameIdx);var r=this.walkthrough.getKeyFramePosition(this.keyFrameIdx),n=this.walkthrough.getKeyFrameTarget(this.keyFrameIdx);this.camera.position.copy(r),this.camera.target.copy(n),this.count=0}else if(this.count<i){this.count+e>i&&(e=i-this.count);var a=this.walkthrough.calculateDeltaOffsetCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),this.count),s=this.walkthrough.calculateDeltaAngleCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),this.count),o=this.walkthrough.getRotateAxisCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone()),l=new THREE.Vector3;l.subVectors(this.camera.target.clone(),this.camera.position),0==isNaN(o.length())&&l.applyAxisAngle(o,s*e),this.count+e==i?(this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=0):this.count+=e,this.updateCamera(a.clone().multiplyScalar(e),l)}}this.viewer.cameraControl.setCameraChanging(!0),this.viewer.render()}setProgress(e){if(this.walkthrough.keyFrameList&&this.walkthrough.keyFrameList.length<=1)return;this.walkthrough.allocateSegments();let t=this.walkthrough.allocateSegmentList,i=0;if(t.map((e=>i+=e)),0===i)return;if(1==e){this.stop(!0);let e=this.walkthrough.keyFrameList[this.walkthrough.keyFrameList.length-1];return this.camera.position.copy(e.position),void this.camera.target.copy(e.target)}(this.count=-1)&&(this.play(),this.pause());let r=i*e;for(let e=0;e<t.length;e++){if(r<t[e]){this.keyFrameIdx=e,this.count=r;break}r-=t[e]}let n=this.walkthrough.keyFrameList[this.keyFrameIdx];this.camera.position.copy(n.position),this.camera.target.copy(n.target);var a=this.walkthrough.calculateDeltaOffsetCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),0),s=this.walkthrough.calculateDeltaAngleCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),0),o=this.walkthrough.getRotateAxisCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone()),l=new THREE.Vector3;l.subVectors(this.camera.target.clone(),this.camera.position),0==isNaN(o.length())&&l.applyAxisAngle(o,s*this.count),this.updateCamera(a.clone().multiplyScalar(this.count),l)}pause(){this.bPause=!0,this.viewer.cameraControl.lockPan=!1}stop(e){e&&(this.viewer.cameraControl.lockPan=!1,this.bStop=!1,this.keyFrameIdx=0,this.count=-1,console.log("Time cost "+(performance.now()-this.timeStart)+"ms."),cancelAnimationFrame(this.reqid),this.stopPlayCallback&&this.stopPlayCallback(),this.viewer.enableCameraNearFar=!0)}startFrom(e){for(var t=this.walkthrough,i=t.getKeyFrameCount(),r=t.getKeyFrames(),n=0;n<i;n++)if(r[n].id==e)return this.keyFrameIdx=n,void(this.count=-1)}setKeyFrameCallback(e){this.keyFrameCallback=e}triggerKeyFrameCallback(e){this.keyFrameCallback&&this.keyFrameCallback(e)}addPausePlayCallback(e){this.pausePlayCallback=e}addStopPlayCallback(e){this.stopPlayCallback=e}updataSpline(){var e=this.walkthrough.getKeyFramePositions(),t=this.walkthrough.getParameters();this.spline=new THREE.CatmullRomCurve3(e,t.closed,t.curveType,t.tension)}};r.WalkthroughManager=class{constructor(){this.walkthroughList=[]}clear(){this.walkthroughList=[]}add(e){this.walkthroughList.push(e)}remove(e){for(var t=0,i=this.walkthroughList.length;t<i;t++){if(this.walkthroughList[t].getName()==e)return void this.walkthroughList.splice(t,1)}}save(){return JSON.stringify(this.walkthroughList)}load(e){this.clear();for(var t=JSON.parse(e),i=0,n=t.length;i<n;i++){var a=new r.Walkthrough;a.setName(t[i].name),a.setKeyFrameList(t[i].keyFrameList),a.setParameters(t[i].parameters),a.setWalkthroughTime(t[i].walkthroughTime),a.setInterpolateType(t[i].type),a.setFps(t[i].fps),this.add(a)}return this.walkthroughList}},function(){let e=new THREE.Matrix4;r.HeightLimitManager=class{constructor(e){this.viewer=e,this.renderTargetForLimitedColor=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.renderTargetForLimitedHeight=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter}),this.limitAnalyses={},this.limitAnalysesNumber=0,this.orthoCamera=null,this.orthoViewProjMatrix=new THREE.Matrix4,this.isDirty=!1,this.sceneForLimitedRegion=new THREE.Scene;var t=e.getScene().getRawMatrixGlobal();this.meshGroup=new r.ObjectGroup("limitedRegion"),this.meshGroup.matrix.copy(t),this.meshGroup.matrixAutoUpdate=!1,this.meshGroup.updateMatrixWorld(!0),this.sceneForLimitedRegion.add(this.meshGroup),this.modelIds={}}render(e){var t=e.clippingPlanes;if(e.clippingPlanes=[],this.renderer=e,0!=this.limitAnalysesNumber){if(this.isDirty){this._calcOrthoCamera(),this._changeMaterialMode(!0);var i=e.getRenderTarget();e.setRenderTarget(this.renderTargetForLimitedHeight),e.clear(),e.render(this.sceneForLimitedRegion,this.orthoCamera),this._changeMaterialMode(!1),e.setRenderTarget(this.renderTargetForLimitedColor),e.clear(),e.render(this.sceneForLimitedRegion,this.orthoCamera),e.setRenderTarget(i),this._updateMaterial(),this.isDirty=!1}e.clippingPlanes=t}else this.isDirty&&(this._updateMaterial(),this.isDirty=!1)}_changeMaterialMode(e){var t=this.meshGroup.children;if(e)for(var i=0;i<t.length;i++){(r=t[i].children[0].material).uniforms.useHeightLimit.value=!0,r.transparent=!1,r.needsUpdate=!0}else for(i=0;i<t.length;i++){var r;(r=t[i].children[0].material).uniforms.useHeightLimit.value=!1,r.transparent=!1,r.needsUpdate=!0}}_calcOrthoCamera(){var t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);for(var r in this.limitAnalyses)if(this.limitAnalyses[r].areaMesh.visible){var n=this.limitAnalyses[r]._getBox(),a=n.min,s=n.max;t.x=Math.min(a.x,t.x),t.y=Math.min(a.y,t.y),t.z=Math.min(a.z,t.z),i.x=Math.max(s.x,i.x),i.y=Math.max(s.y,i.y),i.z=Math.max(s.z,i.z)}var o=.5*(i.x-t.x),l=.5*(i.z-t.z),d=.5*(i.x+t.x),h=.5*(i.y+t.y),c=.5*(i.z+t.z),u=new THREE.Vector3(d,t.y-1,c),p=new THREE.Vector3(d,h+1,c);this.orthoCamera=new THREE.OrthographicCamera(-o,o,l,-l,-.1,i.y-t.y+2),this.orthoCamera.position.set(u.x,u.y,u.z),this.orthoCamera.lookAt(p),this.orthoCamera.updateMatrixWorld(!0),this.orthoViewProjMatrix=this.orthoCamera.projectionMatrix.clone(),e.copy(this.orthoCamera.matrixWorld).invert(),this.orthoViewProjMatrix.multiply(e)}setSize(e,t){}dispose(){this.clearLimitAnalyses(),null!=this.renderTargetForLimitedColor&&(this.renderTargetForLimitedColor.dispose(),this.renderTargetForLimitedColor=null),null!=this.renderTargetForLimitedHeight&&(this.renderTargetForLimitedHeight.dispose(),this.renderTargetForLimitedHeight=null),null!=this.sceneForLimitedRegion&&(this.sceneForLimitedRegion=null)}clearLimitAnalyses(){for(var e in this.limitAnalyses)delete this.limitAnalyses[e],this.isDirty=!0,this.limitAnalysesNumber--;this._updateModelIds()}addLimitAnalysis(e,t){this.limitAnalyses.hasOwnProperty(e)||(this.limitAnalyses[e]=t,this.isDirty=!0,this.limitAnalysesNumber++,t.areaMesh&&(this._initializePlaneMaterial(t.areaMesh,t._drawingHeight),this.meshGroup.add(t.areaMesh)),this._updateModelIds())}removeLimitAnalysisById(e){if(this.limitAnalyses.hasOwnProperty(e)){let t=this.meshGroup.children;for(let i=0;i<t.length;i++)if(t[i].name==e){this.meshGroup.remove(t[i]);break}delete this.limitAnalyses[e],this._updateModelIds(),this.limitAnalysesNumber--,this.isDirty=!0}}_updateMaterial(){this.viewer.modelManager.modelCollection.traverse((e=>{this.modelIds[e.id]&&(e.updateMaterialsValue("heightColorSampler",this.renderTargetForLimitedColor.texture),e.updateMaterialsValue("heightLimitSampler",this.renderTargetForLimitedHeight.texture),e.updateMaterialsValue("heightLimitOrthoMatrix",this.orthoViewProjMatrix))}))}_initializePlaneMaterial(e,t){var i=e.children[0];null!=i&&(i.material.defines.USE_COLORWITHOUTLIGHT="",i.material.defines.HEIGHT_LIMIT_WRITE="",i.material.heightLimit=t,i.material.refreshUniforms(),i.material.needsUpdate=!0)}_updatePlaneMaterial(e,t){var i=e.children[0];null!=i&&(i.material.heightLimit=t,i.material.uniforms.heightLimit.value=t)}update(e,t){let i=this.limitAnalyses[e];if(t){this._initializePlaneMaterial(i.areaMesh,i._drawingHeight);let t=this.meshGroup.children;for(let r=0;r<t.length;r++)t[r].name==e&&(t[r]=i.areaMesh,i.areaMesh.parent=this.meshGroup);i._updateBox(),this._updateModelIds()}else this._updatePlaneMaterial(i.areaMesh,i._drawingHeight);this.isDirty=!0}_updateModelIds(){let e={};for(let i in this.limitAnalyses){let r=this.limitAnalyses[i];if("global"==r.mode||!r._modelIds){this.viewer.modelManager.modelCollection.traverse((t=>{e[t.id]=!0}));break}for(var t=0;t<r._modelIds.length;t++)e[r._modelIds[t]]=!0}this.viewer.modelManager.modelCollection.traverse((t=>{this.modelIds[t.id]&&!e[t.id]&&(t.updateMaterialsValue("heightColorSampler",null),t.updateMaterialsValue("heightLimitSampler",null))})),this.modelIds=e}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3,i=new THREE.Vector3;class n extends THREE.Group{constructor(e){super();let t=this;t.disPickable=!0,t.autoAnimation=!1,t.view=e.viewer,null!=e.viewer.getViewer()&&(t.viewer=e.viewer.getViewer()),t.level=0,t.boundary=[],t.tileManager=null,t.worldBoxScratch=new THREE.Box3,t.tileBuilder=new r.Tile.PlaneTileBuilder,t.worldMatrixScratch=new THREE.Matrix4,t.inverseWorldMatrixScratch=new THREE.Matrix4,t.worldMatrixRestore=new THREE.Matrix4,t.pointVector3_a=new THREE.Vector3,t.pointVector3_b=new THREE.Vector3,t.pointVector3_c=new THREE.Vector3,t.lineStartScratch=new THREE.Vector2,t.lineEndScratch=new THREE.Vector2,t.worldCutPointData=[],t.worldFillPointData=[],t.worldFlatPointData=[],t.worldCutPlaneData=[],t.worldFillPlaneData=[],t.demTileList=[],t.detailWorldCutPointData=[],t.detailWorldFillPointData=[],t.detailWorldFlatPointData=[],t.allCutOsgbInfoVector=[],t.totalArea=0,t.cutArea=0,t.fillArea=0,t.cutVolume=0,t.fillVolume=0,t.totalSuperficialArea=0,t.setOpts(e),t._getDemTileManager(),(!t.layerIds&&null!=t.tileManager||t.layerIds)&&t.updateCutFillVolume(),this.renderOrder=r.EnumRenderOrder.WireFrame,t.show()}updateCutFillVolume(){let e=this;e.clearGriddingMesh(),e.pointsBoundary=[],e.worldPointsBoundary=[],e.worldCutPointData=[],e.worldFillPointData=[],e.worldFlatPointData=[],e.demTileList=[],e.newIndexCut=[],e.newIndexFill=[],e.newIndexGround=[],e.newPositionsCut=[],e.newPositionsFill=[],e.newPositionsGround=[],e.cutFillHeight={max:-1/0,min:1/0},e.modelAltitude=0,e.tileManager&&(e.modelAltitude=e.tileManager.modelAltitude*r.Tile.TileMath.unitScale),0==e.viewer.gisMode&&(e.modelAltitude*=-1);for(var t=0;t<e.boundary.length;t++){e.pointsBoundary.push(new THREE.Vector2(e.boundary[t].x,e.boundary[t].z));var i=e.viewer.drawingToWorld(e.boundary[t]);e.worldPointsBoundary.push(i)}e._initBoundingBox(),e._checkTileMeshBox2(),e.cutFillHeight.max!==-1/0||e.cutFillHeight.min!==1/0?(e._showVisualization(),e._setTotalArea(),e._setVolume(),e._setSuperficialArea2()):e.totalSuperficialArea=0}updateCutFillVolumeData(e){const t=this;t.worldCutPointData=[],t.worldFillPointData=[],t.worldFlatPointData=[],t._collectPointData(e)}_setSuperficialArea2(){let e=this;if(e.totalSuperficialArea=0,e.allCutOsgbInfoVector.forEach((t=>{let i=t;for(var r in i){if("pnewIndexCut"==r){let t=i[r],n=i.pnewPositionsCut;for(let i=0;i<t.length;i+=3){const r=[0,1,2].map((e=>t[i+e])).map((e=>new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]))),a=e.computeAreaOfTriangle(r[0],r[1],r[2],!1);e.totalSuperficialArea+=a}}if("pnewIndexFill"==r){let t=i[r],n=i.pnewPositionsFill;for(let i=0;i<t.length;i+=3){const r=[0,1,2].map((e=>t[i+e])).map((e=>new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]))),a=e.computeAreaOfTriangle(r[0],r[1],r[2],!1);e.totalSuperficialArea+=a}}if("pnewIndexGround"==r){let t=i[r],n=i.pnewPositionsGround;for(let i=0;i<t.length;i+=3){const r=[0,1,2].map((e=>t[i+e])).map((e=>new THREE.Vector3(n[3*e+0],n[3*e+1],n[3*e+2]))),a=e.computeAreaOfTriangle(r[0],r[1],r[2],!1);e.totalSuperficialArea+=a}}}})),e.allCutOsgbInfoVector=[],0==e.totalSuperficialArea&&0==e.totalSuperficialArea&&0==e.totalSuperficialArea){let t=e._calcSpatialArea();e.totalSuperficialArea=t/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}else e.totalSuperficialArea=e.totalSuperficialArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_setSuperficialArea(){let e=this;e.totalSuperficialArea=0;for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}for(let t=0;t<e.newIndexFill.length;t+=3){const i=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}for(let t=0;t<e.newIndexGround.length;t+=3){const i=[0,1,2].map((i=>e.newIndexGround[t+i])).map((t=>new THREE.Vector3(e.newPositionsGround[3*t+0],e.newPositionsGround[3*t+1],e.newPositionsGround[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}if(0==e.totalSuperficialArea&&0==e.totalSuperficialArea&&0==e.totalSuperficialArea){let t=e._calcSpatialArea();e.totalSuperficialArea=t/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}else e.totalSuperficialArea=e.totalSuperficialArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_calcSpatialArea(){var e=this;const r=e.worldPointsBoundary.length;if(r<3)return 0;let n=0,a=new THREE.Triangle;for(let s=2;s<r;s++){let r=a.clone().set(e.worldPointsBoundary[s-1],e.worldPointsBoundary[s],e.worldPointsBoundary[0]),o=r.getArea();if(s>2){let n=a.getNormal(t),l=r.getNormal(i),d=n.angleTo(l);if((Math.abs(d-3.1415)<2e-4||Math.abs(d)<2e-4)&&(a.containsPoint(e.worldPointsBoundary[s])||r.containsPoint(e.worldPointsBoundary[s-2]))){let e=a.getArea();o=Math.abs(o-e)-e}}n+=o,a.copy(r)}return n}_setTotalArea(){let e=this;e.totalArea=0,e.cutArea=0,e.worldCutPlaneData=[],e.fillArea=0,e.worldFillPlaneData=[];for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2]);e.worldCutPlaneData.push(r),e.cutArea+=r}for(let t=0;t<e.newIndexFill.length;t+=3){const i=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2]);e.worldFillPlaneData.push(r),e.fillArea+=r}let t=0;for(let i=0;i<e.newIndexGround.length;i+=3){const r=[0,1,2].map((t=>e.newIndexGround[i+t])).map((t=>new THREE.Vector3(e.newPositionsGround[3*t+0],e.newPositionsGround[3*t+1],e.newPositionsGround[3*t+2])));t+=e.computeAreaOfTriangle(r[0],r[1],r[2])}e.totalArea=e.cutArea+e.fillArea+t,e.cutArea=e.cutArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.fillArea=e.fillArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.totalArea=e.totalArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_setVolume(){let e=this;e.cutVolume=0,e.fillVolume=0;for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.worldCutPlaneData[t/3]*(i[0].z-e._level-e.modelAltitude+i[1].z-e._level-e.modelAltitude+i[2].z-e._level-e.modelAltitude)/3;e.cutVolume+=r}for(var t=0;t<e.newIndexFill.length;t+=3){const r=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2])));var i=e.worldFillPlaneData[t/3]*(e._level+e.modelAltitude-r[0].z+e._level+e.modelAltitude-r[1].z+e._level+e.modelAltitude-r[2].z)/3;e.fillVolume+=i}e.cutVolume=e.cutVolume/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.fillVolume=e.fillVolume/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_initBoundingBox(){let e=this;e.boundingBox=new THREE.Box3,e.pointsBoundary.forEach((t=>e.boundingBox.expandByPoint(new THREE.Vector3(t.x,0,t.y))))}_checkTileMeshBox2(){let e=this;if(e.layerIds){let t=new THREE.Box3;e.worldPointsBoundary.forEach((e=>t.expandByPoint(e)));for(let i=0;i<e.layerIds.length;i++){let n=[],a=e.layerIds[i];const s=e.view.getLayerManager().getLayer(a);if(!s.isVisible)continue;const o=s.customId||s.modelId,l=s.model.getCloudViewer().getModelManager().getModel(o),d=l.getBoundingBoxWorld();if(d.min.z-=1e3,d.max.z+=1e3,!t.intersectsBox(d))continue;const h=l._tileset,c=l.viewer.getScene().getInverseMatrixGlobal();h.traverseContentAvailableNode((e=>{e._content._meshes.traverse((e=>{if("MeshEx"!==e.type||!e.visible)return;const t=c.clone().multiply(e.matrixWorld),i=[...e.geometry.attributes.position.array],r=[...e.geometry.index.array];for(let e=0,a=r.length;e<a;e++){const a=i[3*r[e]+0],s=i[3*r[e]+1],o=i[3*r[e]+2],l=new THREE.Vector3(a,s,o);l.applyMatrix4(t),n.push(l)}}))})),n=n.filter((t=>{let i=!1;const r=e.worldPointsBoundary;for(let e=0,n=r.length-1;e<r.length;n=e++)r[e].y>t.y!=r[n].y>t.y&&t.x<(r[n].x-r[e].x)*(t.y-r[e].y)/(r[n].y-r[e].y)+r[e].x&&(i=!i);return i}));let u={},p=[],m=new THREE.Box3;n.forEach((e=>m.expandByPoint(e)));for(let e=0,t=n.length;e<t;e++){let t=n[e];const i=21*Math.floor(20*t.clone().sub(m.min).x/(m.max.x-m.min.x))+Math.floor(20*t.clone().sub(m.min).y/(m.max.y-m.min.y));!u[i]&&(u[i]=[]),u[i].push(e)}for(let e in u){u[e].sort((()=>.5)),u[e].length>5&&(u[e]=u[e].slice(0,5));for(let t=0,i=u[e].length;t<i;t++)p.push(n[u[e][t]])}if(n&&n.length>0){n=p;for(let t=0,i=e.worldPointsBoundary.length;t<i;t++){const i=e.worldPointsBoundary[t],r=e.worldPointsBoundary[(t+1)%e.worldPointsBoundary.length];for(let t=0;t<1;t+=.05){let a=i.clone().add(r.clone().sub(i).multiplyScalar(t));a.z=void 0;for(let t=0;t<e.layerIds.length;t++){let i=e.layerIds[t];const r=e.view.getLayerManager().getLayer(i);if(!r.isVisible)continue;const n=r.model,s=r.modelId,o=n.getCloudViewer().getModelManager().getModel(s).rayCastVertical(a);o&&(!a.z||o.z>a.z)&&(a=o)}a.z&&n.push(a)}}n.forEach((t=>{e.cutFillHeight.max=Math.max(e.cutFillHeight.max,t.z),e.cutFillHeight.min=Math.min(e.cutFillHeight.min,t.z)}));let t=n.map((e=>[e.x,e.y])),i=r.Utils.delaunay(t),a=[];n.forEach((e=>{a.push(e.x),a.push(e.y),a.push(e.z)}));for(let t=0,r=i.length;t<r;t+=3){const r=i[t+0],n=i[t+1],s=i[t+2],o=new THREE.Vector3(a[3*r+0],a[3*r+1],a[3*r+2]),l=new THREE.Vector3(a[3*n+0],a[3*n+1],a[3*n+2]),d=new THREE.Vector3(a[3*s+0],a[3*s+1],a[3*s+2]),h=(e.level-o.z)/(l.z-o.z),c=(e.level-l.z)/(d.z-l.z),u=(e.level-d.z)/(o.z-d.z);if(h>0&&h<1&&c>0&&c<1){const e=o.clone().add(l.clone().sub(o).multiplyScalar(h)),n=l.clone().add(d.clone().sub(l).multiplyScalar(c));a=a.concat([e.x,e.y,e.z,n.x,n.y,n.z]);const u=a.length/3-2;i[t+0]=u+0,i[t+2]=u+1,i=i.concat([r,u+0,u+1,r,u+1,s])}else if(h>0&&h<1&&u>0&&u<1){const e=o.clone().add(l.clone().sub(o).multiplyScalar(h)),r=d.clone().add(o.clone().sub(d).multiplyScalar(u));a=a.concat([e.x,e.y,e.z,r.x,r.y,r.z]);const c=a.length/3-2;i[t+1]=c+0,i[t+2]=c+1,i=i.concat([c+0,n,s,c+1,c+0,s])}else if(c>0&&c<1&&u>0&&u<1){const e=l.clone().add(d.clone().sub(l).multiplyScalar(c)),s=d.clone().add(o.clone().sub(d).multiplyScalar(u));a=a.concat([e.x,e.y,e.z,s.x,s.y,s.z]);const h=a.length/3-2;i[t+0]=h+1,i[t+1]=h+0,i=i.concat([r,n,h+1,h+1,n,h+0])}}let s=[],o=[],l=[],d={};d.pnewPositionsGround=a,d.pnewPositionsCut=a,d.pnewPositionsFill=a,e.newPositionsCut=a,e.newPositionsFill=a,e.newPositionsGround=a;for(let t=0,r=i.length;t<r;t+=3){const r=[0,1,2].map((e=>i[t+e])),n=r.map((e=>new THREE.Vector3(a[3*e+0],a[3*e+1],a[3*e+2])));let d=!1,h=!1;n.forEach((t=>{d=d||t.z>e.level+.01,h=h||t.z<e.level-.01})),d&&h?(e.newIndexGround=e.newIndexGround.concat(r),s=s.concat(r)):d?(e.newIndexCut=e.newIndexCut.concat(r),o=o.concat(r)):(e.newIndexFill=e.newIndexFill.concat(r),l=l.concat(r))}d.pnewIndexGround=s,d.pnewIndexCut=o,d.pnewIndexFill=l,e.allCutOsgbInfoVector.push(d)}}}else if(null!=e.tileManager.globeLayer)for(var t=e.tileManager.globeLayer._tileset.getTileMesh(),i=0;i<t.length;i++){if((c=t[i]).content&&c.content.meshes&&c.boundingBox){var n=c.content.meshes;if(n.children.length>0&&n.visible){var a=n.children[0],s=c._tileset._objectGroup.matrix;if(e.worldBoxScratch.copy(c.boundingBox),e.worldBoxScratch.applyMatrix4(s),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)){e.worldMatrixScratch.multiplyMatrices(s,a.matrix),e.inverseWorldMatrixScratch.copy(e.worldMatrixScratch).invert(),e.setMyPointsBoundary();const t={geometry:a.geometry,demTile:c,posX:0,posY:0,matrixWorld:s,tileMatrixWorld:e.worldMatrixScratch.clone(),tileMeshMatrix:a.matrix};e.demTileList.push(t),e._createTileGeometry(a.geometry,0,0,e.worldMatrixScratch)}}}}else if(null!=e.tileManager.globalLayer){var o=e.tileManager.globalLayer;for(var l in o)for(var d in o[l])for(var h in o[l][d]){var c;if(o[l][d][h])(c=o[l][d][h]).box&&c.terrainData&&(e.worldBoxScratch.copy(c.box),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)&&e._checkTileGeometryTriangular(c))}}}_checkTileMeshBox(){let e=this;if(e.layerIds){let t=[],i=[];if(e.boundary.length>2)for(let t=0;t<e.boundary.length;t++){let r=e.view.getViewer().drawingToWorld(e.boundary[t]);i.push(r)}let n=new THREE.Box3;i.forEach((e=>n.expandByPoint(e)));for(let i=0;i<e.layerIds.length;i++){let r=e.layerIds[i];const a=e.view.getLayerManager().getLayer(r),s=a.customId||a.modelId,o=a.model.getCloudViewer().getModelManager().getModel(s),l=o.getBoundingBoxWorld();if(l.min.z=-1e3,l.max.z=1e3,!n.intersectsBox(l))continue;const d=o._tileset,h=o.viewer.getScene().getInverseMatrixGlobal();d.traverseContentAvailableNode((e=>{e._content._meshes.traverse((e=>{if("MeshEx"!==e.type||!e.visible)return;const i=h.clone().multiply(e.matrixWorld),r=[...e.geometry.attributes.position.array],n=[...e.geometry.index.array];for(let e=0,a=n.length;e<a;e++){const a=r[3*n[e]+0],s=r[3*n[e]+1],o=r[3*n[e]+2],l=new THREE.Vector3(a,s,o);l.applyMatrix4(i),t.push(l)}}))}))}t=t.filter((t=>{let i=!1;const r=e.worldPointsBoundary;for(let e=0,n=r.length-1;e<r.length;n=e++)r[e].y>t.y!=r[n].y>t.y&&t.x<(r[n].x-r[e].x)*(t.y-r[e].y)/(r[n].y-r[e].y)+r[e].x&&(i=!i);return i}));let a={},s=[],o=new THREE.Box3;t.forEach((e=>o.expandByPoint(e)));for(let e=0,i=t.length;e<i;e++){let i=t[e];const r=21*Math.floor(20*i.clone().sub(o.min).x/(o.max.x-o.min.x))+Math.floor(20*i.clone().sub(o.min).y/(o.max.y-o.min.y));!a[r]&&(a[r]=[]),a[r].push(e)}for(let e in a){a[e].sort((()=>.5)),a[e].length>5&&(a[e]=a[e].slice(0,5));for(let i=0,r=a[e].length;i<r;i++)s.push(t[a[e][i]])}if(t&&t.length>0){t=s;for(let i=0,r=e.worldPointsBoundary.length;i<r;i++){const r=e.worldPointsBoundary[i],n=e.worldPointsBoundary[(i+1)%e.worldPointsBoundary.length];for(let i=0;i<1;i+=.05){let a=r.clone().add(n.clone().sub(r).multiplyScalar(i));a.z=void 0;for(let t of e.layerIds){const i=e.view.getLayerManager().getLayer(t),r=i.model,n=i.modelId,s=r.getCloudViewer().getModelManager().getModel(n).rayCastVertical(a);s&&(!a.z||s.z>a.z)&&(a=s)}a.z&&t.push(a)}}t.forEach((t=>{e.cutFillHeight.max=Math.max(e.cutFillHeight.max,t.z),e.cutFillHeight.min=Math.min(e.cutFillHeight.min,t.z)}));let i=t.map((e=>[e.x,e.y])),n=r.Utils.delaunay(i),a=[];t.forEach((e=>{a.push(e.x),a.push(e.y),a.push(e.z)}));for(let t=0,i=n.length;t<i;t+=3){const i=n[t+0],r=n[t+1],s=n[t+2],o=new THREE.Vector3(a[3*i+0],a[3*i+1],a[3*i+2]),l=new THREE.Vector3(a[3*r+0],a[3*r+1],a[3*r+2]),d=new THREE.Vector3(a[3*s+0],a[3*s+1],a[3*s+2]),h=(e.level-o.z)/(l.z-o.z),c=(e.level-l.z)/(d.z-l.z),u=(e.level-d.z)/(o.z-d.z);if(h>0&&h<1&&c>0&&c<1){const e=o.clone().add(l.clone().sub(o).multiplyScalar(h)),r=l.clone().add(d.clone().sub(l).multiplyScalar(c));a=a.concat([e.x,e.y,e.z,r.x,r.y,r.z]);const u=a.length/3-2;n[t+0]=u+0,n[t+2]=u+1,n=n.concat([i,u+0,u+1,i,u+1,s])}else if(h>0&&h<1&&u>0&&u<1){const e=o.clone().add(l.clone().sub(o).multiplyScalar(h)),i=d.clone().add(o.clone().sub(d).multiplyScalar(u));a=a.concat([e.x,e.y,e.z,i.x,i.y,i.z]);const c=a.length/3-2;n[t+1]=c+0,n[t+2]=c+1,n=n.concat([c+0,r,s,c+1,c+0,s])}else if(c>0&&c<1&&u>0&&u<1){const e=l.clone().add(d.clone().sub(l).multiplyScalar(c)),s=d.clone().add(o.clone().sub(d).multiplyScalar(u));a=a.concat([e.x,e.y,e.z,s.x,s.y,s.z]);const h=a.length/3-2;n[t+0]=h+1,n[t+1]=h+0,n=n.concat([i,r,h+1,h+1,r,h+0])}}e.newPositionsCut=a,e.newPositionsFill=a,e.newPositionsGround=a;for(let t=0,i=n.length;t<i;t+=3){const i=[0,1,2].map((e=>n[t+e])),r=i.map((e=>new THREE.Vector3(a[3*e+0],a[3*e+1],a[3*e+2])));let s=!1,o=!1;r.forEach((t=>{s=s||t.z>e.level+.01,o=o||t.z<e.level-.01})),s&&o?e.newIndexGround=e.newIndexGround.concat(i):s?e.newIndexCut=e.newIndexCut.concat(i):e.newIndexFill=e.newIndexFill.concat(i)}}}else if(null!=e.tileManager.globeLayer)for(var t=e.tileManager.globeLayer._tileset.getTileMesh(),i=0;i<t.length;i++){if((c=t[i]).content&&c.content.meshes&&c.boundingBox){var n=c.content.meshes;if(n.children.length>0&&n.visible){var a=n.children[0],s=c._tileset._objectGroup.matrix;if(e.worldBoxScratch.copy(c.boundingBox),e.worldBoxScratch.applyMatrix4(s),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)){e.worldMatrixScratch.multiplyMatrices(s,a.matrix),e.inverseWorldMatrixScratch.copy(e.worldMatrixScratch).invert(),e.setMyPointsBoundary();const t={geometry:a.geometry,demTile:c,posX:0,posY:0,matrixWorld:s,tileMatrixWorld:e.worldMatrixScratch.clone(),tileMeshMatrix:a.matrix};e.demTileList.push(t),e._createTileGeometry(a.geometry,0,0,e.worldMatrixScratch)}}}}else if(null!=e.tileManager.globalLayer){var o=e.tileManager.globalLayer;for(var l in o)for(var d in o[l])for(var h in o[l][d]){var c;if(o[l][d][h])(c=o[l][d][h]).box&&c.terrainData&&(e.worldBoxScratch.copy(c.box),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)&&e._checkTileGeometryTriangular(c))}}}_showVisualization(){var e=this;if(e.showVisualization){null==e.wallWireframeGeometry&&(e.wallWireframeGeometry=new THREE.BufferGeometry),null==e.blGeometry&&(e.blGeometry=new THREE.BufferGeometry),null==e.bpGeometry&&(e.bpGeometry=new THREE.BufferGeometry),null==e.wallGeometry1&&(e.wallGeometry1=new THREE.BufferGeometry),null==e.wallGeometry2&&(e.wallGeometry2=new THREE.BufferGeometry);const u=[],p=[],m=[],f=[],g=[],v=[];let y=[],M=e.worldPointsBoundary.length;for(var t=0;t<M;t++)if(y.push(new THREE.Vector2(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y)),p.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.max)),m.push(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min,e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),f.push(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.max,e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),t<M-1){u.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e._level+e.modelAltitude)),p.push(new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e.cutFillHeight.max),new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min));var i=2*t;g.push(i,i+1,i+3,i,i+2,i+3),v.push(i,i+1,i+3,i,i+2,i+3)}else{u.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e._level+e.modelAltitude)),p.push(new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e.cutFillHeight.max),new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min));i=2*t;g.push(i,i+1,1,i,0,1),g.push(i,i+1,1,i,0,1)}const E=new THREE.ShapeGeometry(new THREE.Shape(y)),x=E.attributes.position,_=x.count;for(let t=0;t<_;t++){const i=3*t+2;x.array[i]=e._level+e.modelAltitude}if(e.wallWireframeGeometry.setFromPoints(p),e.blGeometry.setFromPoints(u),e.wallGeometry1.setIndex(g),e.wallGeometry1.setAttribute("position",new THREE.Float32BufferAttribute(m,3)),e.wallGeometry2.setIndex(v),e.wallGeometry2.setAttribute("position",new THREE.Float32BufferAttribute(f,3)),e.bpGeometry.setAttribute("position",E.attributes.position),e.bpGeometry.index=E.index,null===e.wallGeometry1.boundingSphere&&e.wallGeometry1.computeBoundingSphere(),null===e.wallGeometry2.boundingSphere&&e.wallGeometry2.computeBoundingSphere(),null===e.wallWireframeGeometry.boundingSphere&&e.wallWireframeGeometry.computeBoundingSphere(),null===e.blGeometry.boundingSphere&&e.blGeometry.computeBoundingSphere(),null===e.bpGeometry.boundingSphere&&e.bpGeometry.computeBoundingSphere(),null==e.wallMesh1){var n=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.4,blending:THREE.NormalBlending});e.wallMesh1=new THREE.Mesh(e.wallGeometry1,n),e.wallMesh1.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallMesh1)}if(null==e.wallMesh2){var a=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.15,blending:THREE.NormalBlending});e.wallMesh2=new THREE.Mesh(e.wallGeometry2,a),e.wallMesh2.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallMesh2)}if(null==e.wallWireframeMesh){var s=new THREE.LineBasicMaterial({depthTest:!0,transparent:!1,depthWrite:!1,color:new THREE.Color("#00825E")});e.wallWireframeMesh=new THREE.Line(e.wallWireframeGeometry,s),e.wallWireframeMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallWireframeMesh)}if(null==e.blMesh){var o=new THREE.LineBasicMaterial({depthTest:!0,transparent:!1,depthWrite:!1,color:new THREE.Color("#32D3A6"),linewidth:4,opacity:1});e.blMesh=new THREE.Line(e.blGeometry,o),e.blMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.blMesh)}if(null==e.bpMesh&&r.GlobalData.EnableLogarithmicDepthBuffer){var l=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.4});e.bpMesh=new THREE.Mesh(e.bpGeometry,l),e.bpMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.bpMesh)}null==e.cutMaterial&&(e.cutMaterial=new r.CutFillMaterial({color:new THREE.Color("#E82C2C"),opacity:1}));var d=new THREE.BufferGeometry;d.setIndex(new THREE.Uint32BufferAttribute(e.newIndexCut,1)),d.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsCut,3)),e.cutMesh=new THREE.Mesh(d,e.cutMaterial),e.add(e.cutMesh),null==e.fillMaterial&&(e.fillMaterial=new r.CutFillMaterial({color:new THREE.Color("#FF9D0B"),opacity:1}));var h=new THREE.BufferGeometry;h.setIndex(new THREE.Uint32BufferAttribute(e.newIndexFill,1)),h.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsFill,3)),e.fillMesh=new THREE.Mesh(h,e.fillMaterial),e.add(e.fillMesh),null==e.groundMaterial&&(e.groundMaterial=new r.CutFillMaterial({color:new THREE.Color("#32D3A6"),opacity:1}));var c=new THREE.BufferGeometry;c.setIndex(new THREE.Uint32BufferAttribute(e.newIndexGround,1)),c.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsGround,3)),e.groundMesh=new THREE.Mesh(c,e.groundMaterial),e.add(e.groundMesh),e.updateMatrixWorld()}}_requestTerrainData(e,t,i,r){const n=e.getTerrainUrl(t,i,r);return new Promise(((a,s)=>{e.loadArrayBufferImmediately(n,(n=>{a({terrainData:e.getTerrainDataArray(n),x:t,y:i,level:r})}))}))}_requestTerrainDataByTileManager(e,t,i,r){return new Promise(((n,a)=>{e.getTerrainData(t,i,r,(e=>{n({terrainData:e,x:t,y:i,level:r})}))}))}_praseDemPointData(t,i,r,n,a){const s=this,[o,l,d]=s.tileBuilder.getTileGeometryTriangular(s,a,t);s.worldMatrixRestore.makeTranslation(i,r,0),s.worldMatrixRestore.multiplyMatrices(n,s.worldMatrixRestore);const h=s.viewer.getScene().getRawMatrixGlobal();e.copy(h).invert();for(let t=0;t<l.length;t+=3)s.pointVector3_a.set(l[t],l[t+1],l[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldCutPointData.push(s.pointVector3_a.clone());for(let t=0;t<o.length;t+=3)s.pointVector3_a.set(o[t],o[t+1],o[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldFillPointData.push(s.pointVector3_a.clone());for(let t=0;t<d.length;t+=3)s.pointVector3_a.set(d[t],d[t+1],d[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldFlatPointData.push(s.pointVector3_a.clone())}_cutDemData(e,t,i,r,n,a){const s=t.x,o=t.y,l=1<<14-t.level,d=[];for(let t=s*l;t<(s+1)*l;++t)for(let i=o*l;i<(o+1)*l;++i)d.push(this._requestTerrainData(e,t,i,14));Promise.all(d).then((t=>{t.map((t=>{t.tileTerrain={terrainData:t.terrainData},t.updateTerrainHeight=()=>{};const a=e.getTileGeometry(t),s=a.geometry;this.worldMatrixScratch.multiplyMatrices(n,a.matrix),this.inverseWorldMatrixScratch.copy(this.worldMatrixScratch).invert(),this.setMyPointsBoundary(),this._praseDemPointData(s,i,r,n,this.worldMatrixScratch.clone())})),a&&a()}))}_cutDemData2(e,t,i,n){const a=t.x,s=t.y,o=1<<14-t.zoom,l=[];for(let t=a*o;t<(a+1)*o;++t)for(let i=s*o;i<(s+1)*o;++i)l.push(this._requestTerrainDataByTileManager(e,t,i,14));Promise.all(l).then((t=>{t.map((t=>{const n=e.mercatorPerimeter/Math.pow(2,t.level)*r.Tile.TileMath.unitScale*2;let a=e.createTerrainGeometry(t.level,e.seg,n,t.x,t.y,t.terrainData,!0)[0];const s=e.mercatorPerimeter/Math.pow(2,e.maxZoom)*r.Tile.TileMath.unitScale*2,o=(t.x*Math.pow(2,e.maxZoom-t.level)-e.modelTileX)*s+Math.pow(2,e.maxZoom-t.level)/2*s,l=-(t.y*Math.pow(2,e.maxZoom-t.level)-e.modelTileY)*s-Math.pow(2,e.maxZoom-t.level)/2*s,d=(new THREE.Matrix4).makeTranslation(o,l,0);this.worldMatrixScratch.multiplyMatrices(i,d),this.inverseWorldMatrixScratch.copy(this.worldMatrixScratch).invert(),this.setMyPointsBoundary(),this._praseDemPointData(a,o,l,i,this.worldMatrixScratch.clone())})),n&&n()}))}_collectPointData(e){const t=this;let i=(e,i)=>{if(e<=0){t._setTotalArea(),t._setVolume(),t._setSuperficialArea();const e={level:t.level,totalArea:t.totalArea,cutArea:t.cutArea,cutVolume:t.cutVolume,fillArea:t.fillArea,fillVolume:t.fillVolume};i&&i(e)}},r=t.demTileList.length;if(0!==r)t.demTileList.map((n=>{if(void 0!==t.tileManager.tileProvider){const a=t.tileManager.tileProvider.terrainProvider,{geometry:s,demTile:o,posX:l,posY:d,matrixWorld:h,tileMatrixWorld:c,tileMeshMatrix:u}=n;if(o.level<14)return void this._cutDemData(a,o,l,d,h,(()=>{r--,i(r,e)}));t.worldMatrixScratch.multiplyMatrices(h,u),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),this._praseDemPointData(s,l,d,h,c),r--,i(r,e)}else if(void 0!==t.tileManager.globalLayer){const{geometry:a,demTile:s,posX:o,posY:l,matrixWorld:d,tileMatrixWorld:h,tileMeshMatrix:c}=n;if(s.zoom<14)return void this._cutDemData2(t.tileManager,s,d,(()=>{r--,i(r,e)}));t.worldMatrixScratch.multiplyMatrices(d,c),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),a.translate(-o,-l,0),this._praseDemPointData(a,o,l,d,h),a.translate(o,l,0),r--,i(r,e)}}));else{const i={level:t.level,totalArea:t.totalArea,cutArea:t.cutArea,cutVolume:t.cutVolume,fillArea:t.fillArea,fillVolume:t.fillVolume};e&&e(i)}}_createTileGeometry(t,i,r,n){var a=this,[s,o,l]=a.tileBuilder.getTileGeometryTriangular(a,a.worldMatrixScratch,t);a.worldMatrixRestore.makeTranslation(i,r,0),a.worldMatrixRestore.multiplyMatrices(n,a.worldMatrixRestore);var d=a.viewer.getScene().getRawMatrixGlobal();e.copy(d).invert();for(var h=a.newIndexCut.length,c=0;c<o.length;c+=3)a.newIndexCut.push(h+c/3),a.pointVector3_a.set(o[c],o[c+1],o[c+2]),a.pointVector3_a.applyMatrix4(a.worldMatrixRestore),a.pointVector3_a.applyMatrix4(e),a.newPositionsCut.push(a.pointVector3_a.x,a.pointVector3_a.y,a.pointVector3_a.z),a.worldCutPointData.push(a.pointVector3_a.clone()),a.cutFillHeight.max=Math.max(a.pointVector3_a.z,a.cutFillHeight.max),a.cutFillHeight.min=Math.min(a.pointVector3_a.z,a.cutFillHeight.min);var u=a.newIndexFill.length;for(c=0;c<s.length;c+=3)a.newIndexFill.push(u+c/3),a.pointVector3_a.set(s[c],s[c+1],s[c+2]),a.pointVector3_a.applyMatrix4(a.worldMatrixRestore),a.pointVector3_a.applyMatrix4(e),a.newPositionsFill.push(a.pointVector3_a.x,a.pointVector3_a.y,a.pointVector3_a.z),a.worldFillPointData.push(a.pointVector3_a.clone()),a.cutFillHeight.max=Math.max(a.pointVector3_a.z,a.cutFillHeight.max),a.cutFillHeight.min=Math.min(a.pointVector3_a.z,a.cutFillHeight.min);var p=a.newIndexGround.length;for(c=0;c<l.length;c+=3)a.newIndexGround.push(p+c/3),a.pointVector3_a.set(l[c],l[c+1],l[c+2]),a.pointVector3_a.applyMatrix4(a.worldMatrixRestore),a.pointVector3_a.applyMatrix4(e),a.newPositionsGround.push(a.pointVector3_a.x,a.pointVector3_a.y,a.pointVector3_a.z),a.worldFlatPointData.push(a.pointVector3_a.clone()),a.cutFillHeight.max=Math.max(a.pointVector3_a.z,a.cutFillHeight.max),a.cutFillHeight.min=Math.min(a.pointVector3_a.z,a.cutFillHeight.min)}_checkTileGeometryTriangular(e){var t=this;if(e.box&&e.terrainData){var i=e.x,n=e.y,a=e.zoom,s=t.tileManager.mercatorPerimeter/Math.pow(2,t.tileManager.maxZoom)*r.Tile.TileMath.unitScale*2,o=(i*Math.pow(2,t.tileManager.maxZoom-a)-t.tileManager.modelTileX)*s+Math.pow(2,t.tileManager.maxZoom-a)/2*s,l=-(n*Math.pow(2,t.tileManager.maxZoom-a)-t.tileManager.modelTileY)*s-Math.pow(2,t.tileManager.maxZoom-a)/2*s;t.worldMatrixScratch.makeTranslation(o,l,0),t.worldMatrixScratch.multiplyMatrices(t.tileManager.earthMatrix,t.worldMatrixScratch),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),e.geometry.translate(-o,-l,0);const d={geometry:e.geometry,demTile:e,posX:o,posY:l,matrixWorld:t.tileManager.earthMatrix,tileMatrixWorld:t.worldMatrixScratch.clone(),tileMeshMatrix:(new THREE.Matrix4).makeTranslation(o,l,0)};t.demTileList.push(d),t._createTileGeometry(e.geometry,o,l,t.tileManager.earthMatrix),e.geometry.translate(o,l,0)}}setMyPointsBoundary(){let e=this;e.myPointsBoundary=[];for(var t=0;t<e.pointsBoundary.length;t++)e.pointVector3_a.set(e.pointsBoundary[t].x,0,e.pointsBoundary[t].y),e.pointVector3_a.applyMatrix4(e.inverseWorldMatrixScratch),e.myPointsBoundary.push(new THREE.Vector2(e.pointVector3_a.x,e.pointVector3_a.y))}getIntersectPos(e,t){var i=this,n=[];i.lineStartScratch.set(e.x,e.y);for(var a=0;a<t.length;a++){i.lineEndScratch.set(t[a].x,t[a].y);var s=r.Utils.linePolygonIntersection2(i.lineStartScratch,i.lineEndScratch,i.myPointsBoundary);null!=s&&n.push(s)}for(a=0;a<n.length;a++){var o=t[a].x-e.x,l=t[a].y-e.y,d=Math.sqrt(o*o+l*l),h=n[a].x-e.x,c=n[a].y-e.y,u=Math.sqrt(h*h+c*c);n[a].z=e.z+u/d*(t[a].z-e.z)}if(n.length>2&&n[0].index!=n[1].index){var p=n[0].index>n[1].index?n[0].index:n[1].index;Math.abs(n[0].index-n[1].index)>1&&(0==n[0].index||0==n[1].index)&&(p=0),n[0].point={x:i.myPointsBoundary[p].x,y:i.myPointsBoundary[p].y,z:(n[0].z+n[1].z)/2}}return n}isInRegionDrawing(e){return r.Utils.pointInPolygon({x:e.x,y:e.z},this.pointsBoundary)}_getDemTileManager(){let e=this;null==e.tileManager&&e.viewer.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e.tileManager=t.tileManager)}))}computeAreaOfTriangle(e,t,i,r=!0){var n=this;r?(n.pointVector3_a.set(e.x,e.y,0),n.pointVector3_b.set(t.x,t.y,0),n.pointVector3_c.set(i.x,i.y,0)):(n.pointVector3_a.set(e.x,e.y,e.z),n.pointVector3_b.set(t.x,t.y,t.z),n.pointVector3_c.set(i.x,i.y,i.z));var a=Math.sqrt(n.pointVector3_a.distanceToSquared(n.pointVector3_b)),s=Math.sqrt(n.pointVector3_b.distanceToSquared(n.pointVector3_c)),o=Math.sqrt(n.pointVector3_c.distanceToSquared(n.pointVector3_a)),l=(a+s+o)/2;return Math.sqrt(l*(l-a)*(l-s)*(l-o))}clearGriddingMesh(){var e=this;null!=e.cutMesh&&(e.remove(e.cutMesh),e.cutMesh.geometry.dispose(),e.cutMesh=null),null!=e.fillMesh&&(e.remove(e.fillMesh),e.fillMesh.geometry.dispose(),e.fillMesh=null),null!=e.groundMesh&&(e.remove(e.groundMesh),e.groundMesh.geometry.dispose(),e.groundMesh=null)}removeAllMesh(){var e=this;e.clearGriddingMesh(),null!=e.cutMaterial&&e.cutMaterial.dispose(),null!=e.fillMaterial&&e.fillMaterial.dispose(),null!=e.groundMaterial&&e.groundMaterial.dispose(),null!=e.wallMesh1&&(e.remove(e.wallMesh1),e.wallMesh1.geometry.dispose(),e.wallMesh1.material.dispose(),e.wallMesh1=null),null!=e.wallMesh2&&(e.remove(e.wallMesh2),e.wallMesh2.geometry.dispose(),e.wallMesh2.material.dispose(),e.wallMesh2=null),null!=e.wallWireframeMesh&&(e.remove(e.wallWireframeMesh),e.wallWireframeMesh.geometry.dispose(),e.wallWireframeMesh.material.dispose(),e.wallWireframeMesh=null),null!=e.blMesh&&(e.remove(e.blMesh),e.blMesh.geometry.dispose(),e.blMesh.material.dispose(),e.blMesh=null),null!=e.bpMesh&&(e.remove(e.bpMesh),e.bpMesh.geometry.dispose(),e.bpMesh.material.dispose(),e.bpMesh=null)}destroy(){var e=this;e.removeAllMesh(),e.level=null,e.boundary=null,e.showVisualization=null,e.tileManager=null,e.worldBoxScratch=null,e.tileBuilder=null,e.worldMatrixScratch=null,e.inverseWorldMatrixScratch=null,e.worldMatrixRestore=null,e.pointVector3_a=null,e.pointVector3_b=null,e.pointVector3_c=null,e.lineStartScratch=null,e.lineEndScratch=null,e.allCutOsgbInfoVector=null}checkHighLowTerrain(e,t,i,r,n,a){var s=this;if(e[2]>s._level&&t[2]>s._level&&i[2]>s._level)n.push(e[0],e[1],e[2]),n.push(t[0],t[1],t[2]),n.push(i[0],i[1],i[2]);else if(e[2]<s._level&&t[2]<s._level&&i[2]<s._level)r.push(e[0],e[1],e[2]),r.push(t[0],t[1],t[2]),r.push(i[0],i[1],i[2]);else if(e[2]==s._level&&t[2]==s._level&&i[2]==s._level)a.push(e[0],e[1],e[2]),a.push(t[0],t[1],t[2]),a.push(i[0],i[1],i[2]);else{var o=[],l=[],d=[];if(e[2]>s._level?o.push(e[0],e[1],e[2]):e[2]<s._level?l.push(e[0],e[1],e[2]):d.push(e[0],e[1],e[2]),t[2]>s._level?o.push(t[0],t[1],t[2]):t[2]<s._level?l.push(t[0],t[1],t[2]):d.push(t[0],t[1],t[2]),i[2]>s._level?o.push(i[0],i[1],i[2]):i[2]<s._level?l.push(i[0],i[1],i[2]):d.push(i[0],i[1],i[2]),0==l.length)n.push(e[0],e[1],e[2]),n.push(t[0],t[1],t[2]),n.push(i[0],i[1],i[2]);else if(0==o.length)r.push(e[0],e[1],e[2]),r.push(t[0],t[1],t[2]),r.push(i[0],i[1],i[2]);else if(3==d.length){var h=s.getGradient(l[2],d[2],o[2]),c=l[0]+h*(o[0]-l[0]),u=l[1]+h*(o[1]-l[1]),p=s._level;r.push(c,u,p),r.push(l[0],l[1],l[2]),r.push(d[0],d[1],d[2]),n.push(c,u,p),n.push(o[0],o[1],o[2]),n.push(d[0],d[1],d[2])}else if(6==l.length){var m=s.getGradient(o[2],s._level,l[2]),f=s.getGradient(o[2],s._level,l[5]),g=o[0]+m*(l[0]-o[0]),v=o[1]+m*(l[1]-o[1]),y=s._level,M=o[0]+f*(l[3]-o[0]),E=o[1]+f*(l[4]-o[1]),x=s._level;n.push(g,v,y),n.push(M,E,x),n.push(o[0],o[1],o[2]),r.push(g,v,y),r.push(M,E,x),r.push(l[0],l[1],l[2]),r.push(M,E,x),r.push(l[0],l[1],l[2]),r.push(l[3],l[4],l[5])}else if(6==o.length){m=s.getGradient(l[2],s._level,o[2]),f=s.getGradient(l[2],s._level,o[5]),g=l[0]+m*(o[0]-l[0]),v=l[1]+m*(o[1]-l[1]),y=s._level,M=l[0]+f*(o[3]-l[0]),E=l[1]+f*(o[4]-l[1]),x=s._level;r.push(g,v,y),r.push(M,E,x),r.push(l[0],l[1],l[2]),n.push(g,v,y),n.push(M,E,x),n.push(o[0],o[1],o[2]),n.push(M,E,x),n.push(o[0],o[1],o[2]),n.push(o[3],o[4],o[5])}else console.log("数据丢失~")}}getGradient(e,t,i){return Math.abs((t-e)/(i-e))}effectOpt(e){var t=this;t.setOpts(e),null!=t.tileManager&&t.updateCutFillVolume()}setVisible(e){var t=this;null!=t.cutMesh&&(t.cutMesh.material.visible=e),null!=t.fillMesh&&(t.fillMesh.material.visible=e),null!=t.groundMesh&&(t.groundMesh.material.visible=e),null!=t.wallMesh1&&(t.wallMesh1.material.visible=e),null!=t.wallMesh2&&(t.wallMesh2.material.visible=e),null!=t.wallWireframeMesh&&(t.wallWireframeMesh.material.visible=e),null!=t.blMesh&&(t.blMesh.material.visible=e),null!=t.bpMesh&&(t.bpMesh.material.visible=e)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}setOpts(e){let t=this;e&&(t.layerIds=e.layerIds,e.level&&(t.level=e.level),e.boundary&&(t.boundary=e.boundary),e.showVisualization&&(t.showVisualization=e.showVisualization)),t._level=t.level*r.Tile.TileMath.unitScale*r.GlobalData.TerrainScale}getTotalArea(){return this.totalArea}getTotalSuperficialArea(){return this.totalSuperficialArea}getCutArea(){return this.cutArea}getCutVolume(){return this.cutVolume}getFillArea(){return this.fillArea}getFillVolume(){return this.fillVolume}}r.CutFillMeasure=n}(),function(){let e=new THREE.Vector2;r.ScissorViewportManager=class{constructor(e){var t=this;t.embeddedViewFlg=!1,t.viewer=e,t.modelManager=t.viewer.getModelManager(),t.oldSceneMap={},t.mainViewContents=[],t.subViewContents=[],t.subViewRegion={},t.needUpdate=!1,t.tempMaterial=new THREE.ShaderMaterial}dispose(){var e=this;e.embeddedViewFlg=null,e.subViewRegion=null,e.mainViewContents=null,e.subViewContents=null,e.oldSceneMap=null,e.modelManager=null}isEmbeddedView(){return this.embeddedViewFlg}effectOpt(e){this.setOpts(e),this.update()}getTileManager(){var e=this;null==e.tileManager&&e.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e.tileManager=t.tileManager)}));return e.tileManager}setOpts(e){var t=this;null!=e.subViewRegion&&(null!=e.subViewRegion.locationX&&(t.subViewRegion.locationX=e.subViewRegion.locationX),null!=e.subViewRegion.locationY&&(t.subViewRegion.locationY=e.subViewRegion.locationY),null!=e.subViewRegion.widthRatio&&(t.subViewRegion.widthRatio=e.subViewRegion.widthRatio),null!=e.subViewRegion.heightRatio&&(t.subViewRegion.heightRatio=e.subViewRegion.heightRatio)),null!=e.mainViewContents&&(t.mainViewContents=e.mainViewContents,t.needUpdate=!0),null!=e.subViewContents&&(t.subViewContents=e.subViewContents,t.needUpdate=!0)}show(){this.embeddedViewFlg=!0,this.update()}hide(){this.embeddedViewFlg=!1,this.recoverVisible(!0)}setViewRegionRender(t,i,r){var n=this;t.setScissorTest(!0),t.getSize(e);var a=e.width,s=e.height,o=n.subViewRegion.locationX,l=n.subViewRegion.locationY;n.recoverVisible(),n.setContentsVisible(n.mainViewContents),this.viewer.getScene().updateCSMParameter(),t.setScissor(0,0,a,s),t.render(i,r);var d=s-l-s*n.subViewRegion.heightRatio;d<0&&(d=0);var h=s*n.subViewRegion.heightRatio;h+d>s-l&&(h=s-l),h<=0&&(h=0);var c=a*n.subViewRegion.widthRatio;c+o>a&&(c=a-o),c<=0&&(c=0),0!=c&&0!=h&&(n.recoverVisible(),n.setContentsVisible(n.subViewContents),this.viewer.getScene().updateCSMParameter(),t.setScissor(o,d,c,h),t.render(i,r)),n.showViewContents(),t.setScissorTest(!1)}showViewContents(){var e=this;if(e.embeddedViewFlg){let t;for(t=0;t<e.mainViewContents.length;t++)null!=e.mainViewContents[t].modelId&&e.modelManager.getModel(e.mainViewContents[t].modelId).setVisible(!0);for(t=0;t<e.subViewContents.length;t++)null!=e.subViewContents[t].modelId&&e.modelManager.getModel(e.subViewContents[t].modelId).setVisible(!0)}}setContentsVisible(e){var t=this;for(let i=0;i<e.length;i++)null==e[i].modelId?e[i].isVisible?t.getTileManager().show(e[i].imageryId):t.getTileManager().hide(e[i].imageryId):t.modelManager.getModel(e[i].modelId).setVisible(e[i].isVisible)}recoverVisible(e=!1){var t=this;for(let i in t.oldSceneMap)t.oldSceneMap[i].isImagery?t.oldSceneMap[i].isVisible?t.getTileManager().show(i):t.getTileManager().hide(i):t.modelManager.getModel(i).setVisible(t.oldSceneMap[i].isVisible),e&&delete t.oldSceneMap[i]}backupVisible(e){var t=this;let i,r,n;var a=t.getTileManager().tileProvider.tileVisible;for(let s=0;s<e.length;s++)null==e[s].modelId?(i=e[s].imageryId,n=!0,r=a[i]):(i=e[s].modelId,r=t.modelManager.getModel(i).visible,n=!1),null==t.oldSceneMap[i]?t.oldSceneMap[i]={isVisible:r,dirty:!1,isImagery:n}:t.oldSceneMap[i].dirty=!1}update(){var e=this;if(e.embeddedViewFlg&&e.needUpdate){for(let t in e.oldSceneMap)e.oldSceneMap[t].dirty=!0;e.backupVisible(e.mainViewContents),e.backupVisible(e.subViewContents);for(let t in e.oldSceneMap)e.oldSceneMap[t].dirty&&(e.modelManager.getModel(t).setVisible(e.oldSceneMap[t].isVisible),delete e.oldSceneMap[t])}}}}(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3;class a{constructor(e){this.renderWire=void 0,this.currentLevel=void 0,this.orthoCamera=new THREE.OrthographicCamera,this.spacing=e.getModelManager().isMeterUnit()?1:1e3,this.lastTime=(new Date).getTime(),this.timeInterval=1e3,this.viewer=e,this.cameraOriginCallBack=this.viewer.cameraControl._changeCallBack,this.currentDrawingStyle=void 0,this.hasFitterState=void 0,this.filterSate=void 0,this.sectionBoxEnable=void 0,this.sectionBoxVisible=null,this.sectionPlaneEnable=void 0,this.sectionPlaneVisible=null,this.externalComponentVisible=void 0,this.externalBodyVisible=null,this.scene=this.viewer.getScene(),this.instanceMap={},this.batchMap={},this.cameraChangedHandle=()=>{const{force:e,bottom:t,maxLevel:i,modelSpacing:r,scale:n,useBorder:a,successCallback:s}=this.handleInputOption;let o=Math.floor((this.viewer.camera.position.y-t)/r);if(o>i&&(o=i),!e&&(o===this.currentLevel||o<=0))return;const l=(new Date).getTime();if(!e&&l-this.lastTime<this.timeInterval)return;this.lastTime=l,this.currentLevel=o,o<=0&&(o=1);const d=r*o+.5;this.createMap(n,d,a,void 0,s),this.handleInputOption.force=!1}}destroy(){this.removeCreateMapEvent(),this.orthoCamera=null,this.spacing=void 0,this.lastTime=null,this.timeInterval=void 0,this.currentDrawingStyle=void 0,this.filterSate=void 0,this.hasFitterState=void 0,this.sectionBoxEnable=void 0,this.sectionBoxState=null,this.externalComponentVisible=void 0,this.externalBodyVisible=null,this.scene=null,this.instanceMap=null,this.batchMap=null}updateCamera(e,t,i,r,n,a,s,o){this.orthoCamera.left=e,this.orthoCamera.right=t,this.orthoCamera.top=i,this.orthoCamera.bottom=r,this.orthoCamera.near=n,this.orthoCamera.far=a,this.orthoCamera.updateProjectionMatrix(),this.orthoCamera.position.set(s.x,s.y,s.z),this.orthoCamera.up.set(0,0,1),this.orthoCamera.target=o,this.orthoCamera.lookAt(o),this.orthoCamera.updateMatrixWorld(!0)}_beforeCreateMap(e){this.viewer.getModelManager().traverseLoadedModels((e=>{const t=e.getObjectGroup();t&&!0===t.visible&&t.traverse((e=>{if(!0===e.visible&&e.isMesh){const t=e.geometry;if("InstancedBufferGeometry"===t.type&&t.attributes.hasOwnProperty("vState"))this.instanceMap[t.id]=t.attributes.vState.array[0],t.attributes.vState.array[0]=r.EnumElementState.CLIPPING;else{const i=t.groups;for(let n=0;n<i.length;++n)i[n]&&-1!==i[n].materialIndex&&(this.batchMap[""+t.id+n]=i[n].materialIndex,e.material[r.EnumElementState.CLIPPING]=e.material[i[n].materialIndex],i[n].materialIndex=r.EnumElementState.CLIPPING)}}}))}));const t=this.viewer.getScene();t.updateLights(this.orthoCamera,this.viewer);const i=this.viewer.getFilter();this.filterSate=i.saveState(),this.hasFitterState=i._hasVisibleFilter()||i._hasTransparentFilter()||i._hasHiddenFileIdFilter()||i._hasOverrideMaterialFilter(),!0===this.hasFitterState&&(this.viewer.getFilter().clear(),this.viewer.rendererManager.renderer._render(!0)),this.sectionBoxEnable=t.clipPlanes&&t.clipPlanes.isEnabled(),!0===this.sectionBoxEnable&&(this.sectionBoxVisible=t.clipPlanes.visible,t.clipPlanes.enable(!1,!1)),this.sectionPlaneEnable=t.fillClipPlane&&!0===t.fillClipPlane.isEnabled(),!0===this.sectionPlaneEnable&&(this.sectionPlaneVisible=t.fillClipPlane.visible,t.fillClipPlane.enable(!1,!1));const n=this.viewer.modelManager.getModel("ExternalComponent");this.externalComponentVisible=n&&n._getNodeGroup().visible,!0===this.externalComponentVisible&&(n._getNodeGroup().visible=!1);const a=this.viewer.getScene().extrudeBodyManager;this.externalBodyVisible=n&&[a._getNodeGroupVisible(),a._getAlphaTestNodeGroupVisible()],this.externalBodyVisible&&(a._getNodeGroup().visible=!1,a._getAlphaTestNodeGroup().visible=!1),this.currentDrawingStyle=r.GlobalData.DrawingStyle,e&&(this.viewer.setDrawingStyle(r.DrawingStyle.SHADINGWITHLINE),!0!==this.renderWire&&(this.renderWire,this.viewer.rendererManager.renderer._render(!0)))}_endCreateMap(){this.viewer.getModelManager().traverseLoadedModels((e=>{const t=e.getObjectGroup();t&&!0===t.visible&&t.traverse((e=>{if(!0===e.visible&&e.isMesh){const t=e.geometry;if("InstancedBufferGeometry"===t.type&&t.attributes.hasOwnProperty("vState"))t.attributes.vState.array[0]=this.instanceMap[t.id];else{const i=t.groups;for(let n=0;n<i.length;++n)i[n]&&-1!==i[n].materialIndex&&(e.material[r.EnumElementState.CLIPPING]=void 0,i[n].materialIndex=this.batchMap[""+t.id+n])}}}))})),!0===this.hasFitterState&&this.viewer.getFilter().loadState(this.filterSate);const e=this.viewer.getScene();if(!0===this.sectionBoxEnable&&e.clipPlanes.enable(!0,this.sectionBoxVisible),!0===this.sectionPlaneEnable&&e.fillClipPlane.enable(!0,this.sectionPlaneVisible),!0===this.externalComponentVisible){this.viewer.modelManager.getModel("ExternalComponent")._getNodeGroup().visible=!0}if(this.externalBodyVisible){const t=e.extrudeBodyManager;t._getNodeGroup().visible=this.externalBodyVisible[0],t._getAlphaTestNodeGroup().visible=this.externalBodyVisible[1]}let t=r.ClipPlaneManager.getInstance(this.scene),i=r.FillClipPlaneManager.getInstance(this.scene);t.clipplanes&&(t.selectIndex=2,t.calculateClippingIds()),i&&i.calculateClippingIds()}createMap(i,s,o,l,d){let h=this.viewer.getScene().getBoundingBox();const c=h;void 0!==l&&(h=l);const u=(h.min.x+h.max.x)/2,p=(h.min.z+h.max.z)/2,m=c.max.y;e.set(u,m,p),t.set(u,m-1,p),h.getSize(n);const f=n.x/2,g=n.z/2;let v=new THREE.Vector3;c.getSize(v),this.updateCamera(-f,f,g,-g,v.y-s,v.y,e,t),this._beforeCreateMap(o);const y=this.viewer.rendererManager.getRenderer(),M=y.autoClear;y.autoClear=!1;const E=y.getRenderTarget(),x=Math.max(parseInt(n.x*i),1),_=Math.max(parseInt(n.z*i),1),b=new THREE.WebGLRenderTarget(x,_);b.texture.flipY=!1,b.texture.encoding=THREE.GammaEncoding,b.stencilBuffer=!0;const I=this.viewer.getScene(),T=I.fog.postProcessSSAOMap;y.setRenderTarget(b),I.fog.postProcessSSAOMap=null,y.clear();let S=new r.Scene;const C=new THREE.PlaneGeometry(n.x,n.z),w=new r.PhongLightingMaterial({color:10064980,side:THREE.DoubleSide,unlight:!0}),R=new THREE.Mesh(C,w);R.rotateX(-Math.PI/2),R.position.y=c.min.y+s,R.position.x=.5*(h.min.x+h.max.x),R.position.z=.5*(h.min.z+h.max.z);const B=Math.max(n.x,n.z),A=.5*B,P=[R.position.x,R.position.y-.001,R.position.z];let L=[];for(let e=10;e<2*B;e+=10){let t,i;e<B?(t=-A,i=-A+e):(t=-A+e-B,i=A),L.push(i+P[0],P[1],t+P[2]),L.push(t+P[2],P[1],i+P[0])}let O=new THREE.LineMaterial({color:2236962});O.linewidth=1,O.resolution.set(B,B),O.depthTest=!1;let D=new THREE.LineSegmentsGeometry;D.setPositions(L);const N={planeMesh:R,lineMesh:new THREE.LineSegments2(D,O)};S.add(N.planeMesh),S.add(N.lineMesh),R.updateMatrixWorld(),new r.MapCapsManager(this.viewer,this.orthoCamera,S).render(y),y.render(I,this.orthoCamera),I.fog.postProcessSSAOMap=T,y.autoClear=M,y.setRenderTarget(E);const H=a.exportCanvas(y,b,x,_);this._endCreateMap(),d&&d(H)}createMapByHeight(e){const{maxPixel:t,useBorder:i,height:r,boundingbox:n,successCallback:a}=e,s=this.viewer.getBoundingBox();if(Array.isArray(r)){let e=[],o=t=>{e.push(t)};for(let e=0;e<r.length;e++){const a=r[e],l=n[e],d=this.getScaleByPixel(l,t),h=this.viewer.worldToDrawing({x:0,y:0,z:a}).y+.5-s.min.y;this.createMap(d,h,i,l,o)}a(e)}else{const e=this.getScaleByPixel(s,t),n=this.viewer.worldToDrawing({x:0,y:0,z:r}).y+.5-s.min.y;n<0&&console.warn("the height beyond the bottom of the model"),this.createMap(e,n,i,void 0,a)}}getScaleByPixel(e,t){e.getSize(n);return t/Math.max(n.x,n.z)}addCreateMapEvent(e){const{maxPixel:t,useBorder:a,spacing:s,successCallback:o}=e,l=this.viewer.getBoundingBox(),d=l.min.y,h=l.max.y,c=this.getScaleByPixel(l,t);this.viewer.getBoundingBoxWorld().getSize(i),null!=s&&(this.spacing=s);const u=this.spacing*n.y/i.z,p=Math.floor((h-d)/u)+1;this.handleInputOption={force:!0,bottom:d,maxLevel:p,modelSpacing:u,scale:c,useBorder:a,successCallback:o},this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.cameraChangedHandle)}removeCreateMapEvent(){this.viewer.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.cameraChangedHandle),document.querySelectorAll(".modelMap").forEach((e=>{document.body.removeChild(e)}))}}a.exportCanvas=(e,t,i,r)=>{const n=document.createElement("canvas");n.width=i,n.height=r;const a=n.getContext("2d"),s=new Uint8Array(4*i*r),o=new Uint8ClampedArray(s.buffer);e.readRenderTargetPixels(t,0,0,i,r,s);let l=new ImageData(o,i,r);for(let e=3;e<4*i*r;e+=4)l.data[e]*=.8;return a.putImageData(l,0,0),n.toDataURL("image/png")},r.MapManager=a})(),r.MapCapsManager=class{constructor(e,t,i){this.viewer=e,this.scene=e.getScene(),this.camera=t,this.capsScene=i,this.capMeshPrepared=!1;let r=e.getRenderer();this.size=new THREE.Vector2,r.getDrawingBufferSize(this.size)}dispose(){this.viewer=null,this.scene=null,this.camera=null,this.capsScene=null}render(e){let t=this.scene,i=this.camera,n=this.viewer;const a=r.ExtrudeBodyManager.getInstance(n)._getAlphaTestNodeGroupVisible();r.ExtrudeBodyManager.getInstance(n)._setAlphaTestNodeGroupVisible(!1);const s=t.getObjectGroup(r.GlobalData.TilePlaneGroupName);s&&(s.preVisible=s.visible,s.visible=!1);const o=t.getObjectGroup(r.ObjectGroupType.CONTACTSHADOW);o&&(o.preVisible=o.visible,o.visible=!1),this._prepareCapScene();let l=e.getClearAlpha();e.autoClear&&(e.clear(),e.setClearAlpha(0),e.autoClear=!1);const d=this.viewer.rendererManager.renderer.composer;d&&d.ssaoPass&&!0===d.ssaoPass.enabled&&e.clear();let h=e.getContext(),c=e.state;c.buffers.stencil.setTest(!0),c.buffers.stencil.setLocked(!0),c.buffers.stencil.setFunc(h.ALWAYS,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.INCR),t.overrideMaterial=t.backMaterial,t.backFrontStencil=!0,e.render(t,i),c.buffers.stencil.setFunc(h.ALWAYS,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.DECR),t.overrideMaterial=t.frontMaterial,e.render(t,i),t.backFrontStencil=!1,c.buffers.stencil.setFunc(h.LEQUAL,1,255),c.buffers.stencil.setOp(h.KEEP,h.KEEP,h.KEEP),e.render(this.capsScene,i),c.buffers.stencil.setLocked(!1),c.buffers.stencil.setTest(!1),e.setClearAlpha(l),t.overrideMaterial=null,s&&(s.visible=s.preVisible),o&&(o.visible=o.preVisible),r.ExtrudeBodyManager.getInstance(n)._setAlphaTestNodeGroupVisible(a)}_prepareCapScene(){this.capMeshPrepared||(this.capMeshPrepared=!0),this._createCapStencilMaterials()}_createCapStencilMaterials(){this.scene.backMaterial||(this.scene.backMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.frontMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.backInstanceMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.backInstanceMaterial.defines.USE_INSTANCE="",this.scene.frontInstanceMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.frontInstanceMaterial.defines.USE_INSTANCE="")}},(()=>{let e=null,t=new THREE.Vector3,i=new THREE.Vector3;class n{constructor(e){this.viewer=e,this.shadowGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.CONTACTSHADOW),this.offset=-0,this.blur=3.5,this.darkness=1,this.opacity=1,this.color=new THREE.Color(0,0,0),this.renderTarget=new THREE.WebGLRenderTarget(512,512),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new THREE.WebGLRenderTarget(512,512),this.renderTargetBlur.texture.generateMipmaps=!1;const n=this.viewer.getBoundingBox();n.getCenter(t),n.getSize(i);const a=new THREE.PlaneGeometry(1,1).rotateX(Math.PI/2),s=new THREE.MeshBasicMaterial({map:this.renderTarget.texture,opacity:this.opacity,transparent:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:10,side:THREE.DoubleSide});this.plane=new THREE.Mesh(a,s),this.plane.renderOrder=r.EnumRenderOrder.WireFrame,this.plane.name="ContactShadow",this.plane.scale.y=-1,this.shadowGroup.add(this.plane),this.blurPlane=new THREE.Mesh(a),this.blurPlane.visible=!1,this.blurPlane.renderOrder=r.EnumRenderOrder.WireFrame,this.shadowGroup.add(this.blurPlane);const o=new THREE.MeshBasicMaterial({color:new THREE.Color(0,0,0),opacity:0,transparent:!0,depthWrite:!1,side:THREE.DoubleSide});r.MaterialUtil.AddCloseSSAODefine(o),r.MaterialUtil.AddCloseSSRDefine(o),this.fillPlane=new THREE.Mesh(a,o),this.fillPlane.rotateX(Math.PI),this.fillPlane.renderOrder=r.EnumRenderOrder.Component,this.fillPlane.visible=!1,this.shadowGroup.add(this.fillPlane),this.shadowGroup.matrixAutoUpdate=!1,this.planeScale=1.2,this.shadowBox=null,this.updatePlane(this.plane,n,t,i),this.updatePlane(this.blurPlane,n,t,i),this.updatePlane(this.fillPlane,n,t,i),this.shadowCamera=new THREE.OrthographicCamera(-i.x/2*this.planeScale,i.x/2*this.planeScale,i.z/2*this.planeScale,-i.z/2*this.planeScale,0,i.y),this.shadowCamera.position.set(t.x,n.min.y+this.offset,t.z),this.shadowCamera.rotation.x=Math.PI/2,this.cameraHelper=new THREE.CameraHelper(this.shadowCamera),this.cameraHelper.visible=!1,this.shadowGroup.add(this.cameraHelper),this.depthMaterial=new r.CustomMeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.BasicDepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.userData.color={value:this.color},this.depthMaterial.onBeforeCompile=e=>{e.uniforms.darkness=this.depthMaterial.userData.darkness,e.uniforms.color=this.depthMaterial.userData.color,e.fragmentShader=`\n\t\t\t\t\t\tuniform float darkness;\n                        uniform vec3 color;\n\t\t\t\t\t\t${e.fragmentShader.replace("gl_FragColor = vec4( vec3( fragZ ), opacity );","gl_FragColor = vec4( fragZ*color, darkness );")}\n\t\t\t\t\t`},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.InstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,this.InstancedDepthMaterial.side=THREE.DoubleSide,this.InstancedDepthMaterial.depthPacking=THREE.BasicDepthPacking,this.InstancedDepthMaterial.blending=THREE.NoBlending,this.InstancedDepthMaterial.userData.darkness={value:this.darkness},this.InstancedDepthMaterial.userData.color={value:this.color},this.InstancedDepthMaterial.onBeforeCompile=e=>{e.uniforms.darkness=this.depthMaterial.userData.darkness,e.uniforms.color=this.depthMaterial.userData.color,e.fragmentShader=`\n\t\t\t\t\t\tuniform float darkness;\n                        uniform vec3 color;\n\t\t\t\t\t\t${e.fragmentShader.replace("gl_FragColor = vec4( vec3( fragZ ), opacity );","gl_FragColor = vec4( fragZ*color, darkness );")}\n\t\t\t\t\t`},this.InstancedDepthMaterial.depthTest=!1,this.InstancedDepthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new THREE.ShaderMaterial(r.HorizontalBlurShader),this.horizontalBlurMaterial.depthTest=!1,this.horizontalBlurMaterial.side=THREE.DoubleSide,this.verticalBlurMaterial=new THREE.ShaderMaterial(r.VerticalBlurShader),this.verticalBlurMaterial.depthTest=!1,this.verticalBlurMaterial.side=THREE.DoubleSide,this.shadowGroup.updateMatrixWorld(!0)}destroy(){this.viewer.getScene().removeObjectGroupByName(r.ObjectGroupType.CONTACTSHADOW),this.shadowGroup=null,this.blur=void 0,this.darkness=void 0,this.opacity=void 0,this.color=null,this.renderTarget=null,this.renderTargetBlur=null,this.shadowCamera=null,this.cameraHelper=null,this.plane=null,this.blurPlane=null,this.fillPlane=null,this.depthMaterial=null,this.horizontalBlurMaterial=null,this.verticalBlurMaterial=null}getShadowBoxWorld(){if(this.shadowBox)return this.shadowBox.clone();this.shadowBox=new THREE.Box3,this.shadowBox.copy(this.viewer.getBoundingBox()),this.shadowBox.expandByVector(new THREE.Vector3(i.x*(this.planeScale-1),0,i.z*(this.planeScale-1))),this.shadowBox.min.y+=this.offset;const e=this.viewer.getScene().geometryGroup.matrix.clone();return e.invert(),this.shadowBox.applyMatrix4(e),this.shadowBox.clone()}updatePlane(e,t,i,r){e.position.y=t.min.y+this.offset,e.position.x=i.x,e.position.z=i.z,e.scale.x=r.x*this.planeScale,e.scale.z=r.z*this.planeScale}render(e,t,i){const r=t.background,n=t.clipPlanes&&!0===t.clipPlanes.visible,a=t.fillClipPlane&&!0===t.fillClipPlane.visible,s=t.clipPlanes&&t.clipPlanes.capsWireframe&&!0===t.clipPlanes.capsWireframe.visible,o=e.autoClear;e.autoClear=!1,t.background=null,this.plane.visible=!1,!0===n&&(t.clipPlanes.visible=!1),!0===s&&(t.clipPlanes.capsWireframe.visible=!1),!0===a&&(t.fillClipPlane.visible=!1),t.overrideMaterial=this.depthMaterial,this.viewer.modelManager.adjustVisibility(!0),this.viewer.modelManager.adjustInstanceVisibility(!1);const l=e.getRenderTarget();e.setRenderTarget(this.renderTarget),e.clear(),e.render(t,this.shadowCamera),t.overrideMaterial=this.InstancedDepthMaterial,this.viewer.modelManager.adjustVisibility(!1),this.viewer.modelManager.adjustInstanceVisibility(!0),e.render(t,this.shadowCamera),this.blurShadow(e,this.blur),this.blurShadow(e,.4*this.blur),e.setRenderTarget(l),t.overrideMaterial=null,this.viewer.modelManager.adjustVisibility(!0),e.autoClear=o,t.background=r,!0===n&&(t.clipPlanes.visible=!0),!0===s&&(t.clipPlanes.capsWireframe.visible=!0),!0===a&&(t.fillClipPlane.visible=!0),this.plane.visible=!0}blurShadow(e,t){this.blurPlane.visible=!0,this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=1*t/256,e.setRenderTarget(this.renderTargetBlur),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=1*t/256,e.setRenderTarget(this.renderTarget),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1}getBlur(){return this.blur}setBlur(e){this.blur=e}getDarkness(){return this.darkness}setDarkness(e){this.darkness=e,this.depthMaterial.userData.darkness.value=e}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e,this.plane.material.opacity=e}getColor(){return this.color}setColor(e){this.color=e,this.depthMaterial.userData.color.value=e}setHeight(e){const r=this.viewer.getBoundingBoxWorld();if(e>r.max.z)return void console.warn("Height greater than the scene bounding box");this.height=e,r.min.z=e;const n=this.viewer.getScene().getRawMatrixGlobal(),a=r.applyMatrix4(n);a.getCenter(t),a.getSize(i);const s=this.viewer.getBoundingBox();this.offset=a.min.y-s.min.y,this.update()}getHeight(){return this.height}update(){const e=this.viewer.getBoundingBox();e.getCenter(t),e.getSize(i),this.updatePlane(this.plane,e,t,i),this.updatePlane(this.blurPlane,e,t,i),this.updatePlane(this.fillPlane,e,t,i),this.shadowGroup.updateMatrixWorld(!0),this.shadowCamera.left=-i.x/2*this.planeScale,this.shadowCamera.right=i.x/2*this.planeScale,this.shadowCamera.top=i.z/2*this.planeScale,this.shadowCamera.bottom=-i.z/2*this.planeScale,this.shadowCamera.near=0,this.shadowCamera.far=i.y-this.offset,this.shadowCamera.updateProjectionMatrix(),this.shadowCamera.position.set(t.x,e.min.y+this.offset,t.z),this.shadowCamera.updateMatrixWorld(!0)}}n.destroyInstance=()=>{e&&e.destroy(),e=null},n.getInstance=()=>e,n.createInstance=t=>(e||(e=new r.ContactShadow(t)),e),r.ContactShadow=n})(),function(){class e extends r.TerrainOperationManager{constructor(e){super(e),this.viewer=e,this.modelId={},this.holeId,this.imageLayerIds=[],this.boundary=[],this.originBoundary=[],this.lowestHeight=1/0,this.hasOsgbLayer=!1}getTerrainExcavation(e){return this.terrainExcavations[e]}dispose(){super.dispose(),this.modelId=null,this.imageLayerIds=null}setImageLayerIds(e){this.imageLayerIds=e}setModelId(e){this.modelId=e}getModelIds(){return this.modelId}setHoleId(e){this.holeId=e}getHoleId(){return this.holeId}setBoundary(e){this.boundary=e}getBoundary(){return this.boundary}setOriginBoundary(e){for(let t=0;t<e.length;++t)this.originBoundary.push(e[t])}getOriginBoundary(){return this.originBoundary}setBBoxLowestPos(e){this.hasOsgbLayer&&this.lowestHeight>e.pos.z&&(this.lowestHeight=e.pos.z)}calcOriginBBox(e){let t=this.getOriginBoundary(),i=[];for(let r=0;r<t.length;r++){let n=this.viewer.drawingToWorld(t[r]);n.z=e?this.lowestHeight:0,i.push(n)}this.boundary.splice(0,this.boundary.length);let r=[];for(let e=0;e<i.length;e++){let t=this.viewer.worldToDrawing(i[e]);r.push(t),this.boundary.push(t)}let n=new THREE.Vector3(1/0,1/0,1/0),a=new THREE.Vector3(-1/0,-1/0,-1/0);for(let e=0;e<t.length;e++)n.x=Math.min(t[e].x,n.x),n.y=Math.min(t[e].y,n.y),n.z=Math.min(t[e].z,n.z),a.x=Math.max(t[e].x,a.x),a.y=Math.max(t[e].y,a.y),a.z=Math.max(t[e].z,a.z);for(let e=0;e<r.length;e++)n.x=Math.min(r[e].x,n.x),n.y=Math.min(r[e].y,n.y),n.z=Math.min(r[e].z,n.z),a.x=Math.max(r[e].x,a.x),a.y=Math.max(r[e].y,a.y),a.z=Math.max(r[e].z,a.z);return new THREE.Box3(n,a)}getOriginBBox(){let e=this.getOriginBoundary(),t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);for(let r=0;r<e.length;r++)t.x=Math.min(e[r].x,t.x),t.y=Math.min(e[r].y,t.y),t.z=Math.min(e[r].z,t.z),i.x=Math.max(e[r].x,i.x),i.y=Math.max(e[r].y,i.y),i.z=Math.max(e[r].z,i.z);return new THREE.Box3(t,i)}updateOriginBBox(e){return this.hasOsgbLayer?this.calcOriginBBox(e):this.getOriginBBox()}setIfExistOsgbLayer(e){this.hasOsgbLayer=e}}r.Hole=e}(),r.HolesManager=class{constructor(e){this.viewer=e,this._maxHoleCount=4,this.holeMap=new Map,this.size={},this._imageLayerScene=[],this._modelIds=[],this.isDirty=!0,this.isUseTerrain=!1,this.tempBoundary=[],this.orthoCameraFar=2e4,this.orthoCameraPosHeight=1e4,this.excavationInfo=[]}dispose(){for(const e of this.holeMap.values())e.dispose();this.holeMap=null,this._maxHoleCount=void 0,this.size=null,this._imageLayerScene.forEach((e=>{e.renderTargetForExcavation.dispose(),e.pickingExcavationRenderTarget.dispose(),e.pickingExcavationMaterial=null,e.sceneForExcavation=null})),this._imageLayerScene=null,this._modelIds=null,this.tempBoundary=null,this.excavationInfo=null}mergeExcavationScene(e,t){e.holes.push(t);let i=t.getTerrainExcavation(t.getHoleId()),r=new THREE.Mesh(i.geometry,i.material);r.terrainExcavationId=i.id,e.sceneForExcavation.add(r);const{orthoViewProjMatrix:n,orthoCamera:a}=this.createOrthoViewProjMatrix(e.holes);e.orthoViewProjMatrix=n,e.orthoCamera=a}createExcavationGISScene(e,t,i,n){let a=new THREE.Scene,s=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),o=new r.PickingExcavationMaterial,l=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),d=e.getTerrainExcavation(e.getHoleId()),h=new THREE.Mesh(d.geometry,d.material);h.terrainExcavationId=d.id,a.add(h);let c=[];c.push(e);const{orthoViewProjMatrix:u,orthoCamera:p}=this.createOrthoViewProjMatrix(c);this._imageLayerScene.push({sceneForExcavation:a,renderTargetForExcavation:s,pickingExcavationMaterial:o,pickingExcavationRenderTarget:l,orthoViewProjMatrix:u,orthoCamera:p,imageId:t,layerId:i,modelId:n,holes:c})}createExcavation3DScene(e,t){if(this.isDirty){this.isDirty=!1;let i=new THREE.Scene,n=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),a=new r.PickingExcavationMaterial,s=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),o=e.getTerrainExcavation(e.getHoleId()),l=new THREE.Mesh(o.geometry,o.material);l.terrainExcavationId=o.id,i.add(l);let d=[];d.push(e);const{orthoViewProjMatrix:h,orthoCamera:c}=this.createOrthoViewProjMatrix(d);this._imageLayerScene.push({sceneForExcavation:i,renderTargetForExcavation:n,pickingExcavationMaterial:a,pickingExcavationRenderTarget:s,orthoViewProjMatrix:h,orthoCamera:c,modelId:t,holes:d})}else this._imageLayerScene.forEach((t=>{this.mergeExcavationScene(t,e)}))}createOrthoViewProjMatrix(e){let t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);return e.forEach((e=>{let r=e.getTerrainExcavation(e.getHoleId());if(r.getVisible()){let e=r.getAABBMin(),n=r.getAABBMax();t.x=Math.min(e.x,t.x),t.y=Math.min(e.y,t.y),t.z=Math.min(e.z,t.z),i.x=Math.max(n.x,i.x),i.y=Math.max(n.y,i.y),i.z=Math.max(n.z,i.z)}})),this.createOrthoViewProjMatrixByBox({max:i,min:t})}createOrthoViewProjMatrixByBox(e){const t=e.max,i=e.min;let r=.5*(t.x-i.x),n=.5*(t.z-i.z),a=.5*(t.x+i.x),s=.5*(t.y+i.y),o=.5*(t.z+i.z),l=new THREE.Vector3(a,this.orthoCameraPosHeight,o),d=new THREE.Vector3(a,s,o),h=new THREE.OrthographicCamera(-r,r,n,-n,.1,this.orthoCameraFar);h.position.set(l.x,l.y,l.z),h.up.set(0,0,1),h.lookAt(d),h.updateMatrixWorld(!0);let c=new THREE.Matrix4,u=new THREE.Matrix4;return c=h.projectionMatrix.clone(),u.copy(h.matrixWorld).invert(),c.multiply(u),{orthoCamera:h,orthoViewProjMatrix:c}}getExcavationInfo(e,t){const i=e.getRenderTarget();return e.setRenderTarget(t.renderTargetForExcavation),e.clearColor(),e.render(t.sceneForExcavation,t.orthoCamera),e.setRenderTarget(i),{isExcavation:!0,samplerExcavation:t.renderTargetForExcavation.texture,cullOrthoMatrix:t.orthoViewProjMatrix,cullImageLayerIds:t.imageId}}addHole(e,t){const{points:i,modelIds:n}=t;let a=this.holeMap.get(e);if(!a){a=new r.Hole(this.viewer),a.setSize(this.size.width,this.size.height),a.setHoleId(e),a.addExcavationRegion(e,i),a.setBoundary(i),a.setOriginBoundary(i);let t=!1;for(const e in n)"TileGroup"!=e&&(t=!0);a.setIfExistOsgbLayer(t),this.setHoleBBoxLowestPos(a),this.holeMap.set(e,a)}for(const e in n){let t=n[e],i=[];if(t.forEach((e=>{e.pImageryId&&i.push(e.pImageryId)})),"TileGroup"===e)t.forEach((t=>{let i=!1;for(let e=0;e<this._imageLayerScene.length;e++)if(this._imageLayerScene[e].imageId===t.pImageryId){i=!0;break}i?this._imageLayerScene.forEach((e=>{e.imageId===t.pImageryId&&this.mergeExcavationScene(e,a)})):this.createExcavationGISScene(a,t.pImageryId,t.pLayerId,e)})),0===n[e].length&&this.createExcavation3DScene(a,e);else{let i=!1;for(let t=0;t<this._imageLayerScene.length;t++)if(this._imageLayerScene[t].modelId===e){i=!0;break}i?this._imageLayerScene.forEach((t=>{t.modelId===e&&this.mergeExcavationScene(t,a)})):this.createExcavationGISScene(a,t[0].pImageryId,t[0].pLayerId,e)}}this.viewer.render()}updateExcavationMaterial(e,t){this.viewer.modelManager.modelCollection.traverse((i=>{if(t.modelId==i.id&&"TileGroup"==i.id){const t=i.tileManager;t&&t.setExcavation(e)}else t.modelId==i.id&&i.setExcavation(e)})),t.pickingExcavationMaterial.updateExcavation(e),t.pickingExcavationMaterial.updateSide({isExcavation:e&&e.isExcavation})}updateImageryId(e,t){this._imageLayerScene.forEach((i=>{i.layerId===e&&(i.imageId=t)}))}removeHoleByIds(e){for(const t of this.holeMap.values())t.removeExcavationRegionsById(e);e.forEach((e=>{let t=this.holeMap.get(e);if(t){this.holeMap.delete(e);let i=[];for(let r=0;r<this._imageLayerScene.length;r++)if(this._imageLayerScene[r].sceneForExcavation.children.forEach((i=>{i.terrainExcavationId==e&&(this._imageLayerScene[r].sceneForExcavation.remove(i),this._imageLayerScene[r].holes.forEach((function(e,i,r){e===t&&r.splice(i,1)})))})),0===this._imageLayerScene[r].sceneForExcavation.children.length){i.push(r);let e={isExcavation:!1,samplerExcavation:this._imageLayerScene[r].renderTargetForExcavation.texture,cullOrthoMatrix:this._imageLayerScene[r].orthoViewProjMatrix,cullImageLayerIds:this._imageLayerScene[r].imageId};this.updateExcavationMaterial(e,this._imageLayerScene[r])}if(0!==i.length)for(let e=i.length-1;e>=0;e--)this._imageLayerScene.splice(i[e],1);0===this._imageLayerScene.length&&(this.isDirty=!0)}}))}showHoleByIdAndLayerIds(e,t){t.forEach((t=>{this._imageLayerScene.forEach((i=>{i.layerId===t&&i.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!0)}))}))}))}hideHoleByIdAndLayerIds(e,t){t.forEach((t=>{this._imageLayerScene.forEach((i=>{i.layerId===t&&i.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!1)}))}))}))}showHideLayerByLayerIds(e,t){let i=this.holeMap.get(e);this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId===e&&(t.visible=!1)}))})),t.forEach((t=>{let r=!0;this._imageLayerScene.forEach((n=>{if(n.layerId===t.pLayerId){r=!1;let t=!0;n.sceneForExcavation.children.forEach((i=>{i.terrainExcavationId===e&&(t=!1,i.visible=!0)})),t&&this.mergeExcavationScene(n,i)}})),r&&this.createExcavationGISScene(i,t.pImageryId,t.pLayerId,t.pModelId)}))}clearHoles(){let e=[];for(const t of this.holeMap.values())e.push(t.getHoleId());this.removeHoleByIds(e)}hideHoleByIds(e){for(const t of this.holeMap.values())t.hideExcavationRegionsById(e);e.forEach((e=>{this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!1)}))}))}))}showHoleByIds(e){for(const t of this.holeMap.values())t.showExcavationRegionsById(e);e.forEach((e=>{this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!0)}))}))}))}setSize(e,t){this.size={width:e,height:t},this._imageLayerScene.forEach((i=>{i.pickingExcavationRenderTarget.setSize(e,t)}))}pickExcavation(e){return 0!==this.holeMap.size&&this.renderer&&this._imageLayerScene.length,!1}calcHoleScreenHeight(e){let t=new THREE.Vector2(1/0,1/0),i=new THREE.Vector2(-1/0,-1/0);const r=this.size.width/2,n=this.size.height/2;for(let a=0;a<e.length;a++){const s=new THREE.Vector3(e[a].x,e[a].y,e[a].z).project(this.viewer.camera),o=Math.round(r*s.x+r),l=Math.round(-n*s.y+n);t.x=Math.min(o,t.x),t.y=Math.min(l,t.y),i.x=Math.max(o,i.x),i.y=Math.max(l,i.y)}return Math.abs(i.y-t.y)>6}calcBoxIntersect(e,t){var i=new THREE.Box3(e.boxMinValue,e.boxMaxValue);let r,n=this.viewer.camera.frustum.intersectsBox(i);this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(r=this.viewer.getModelManager().getModel("TileGroup").tileManager);let a=!1;r&&(a=r.isUseTerrain());var s=t.updateOriginBBox(a);let o=this.viewer.camera.frustum.intersectsBox(s);if(n||o){let e=this.calcHoleScreenHeight(t.getBoundary()),i=this.calcHoleScreenHeight(t.getOriginBoundary());return e||i}return!1}getHoleWorldBox(e){let t=e.getBoundary(),i=new THREE.Vector3(1/0,1/0,1/0),r=new THREE.Vector3(-1/0,-1/0,-1/0);for(let e=0;e<t.length;e++)i.x=Math.min(t[e].x,i.x),i.y=Math.min(t[e].y,i.y),i.z=Math.min(t[e].z,i.z),r.x=Math.max(t[e].x,r.x),r.y=Math.max(t[e].y,r.y),r.z=Math.max(t[e].z,r.z);return{boxMinValue:i,boxMaxValue:r}}updateCameraLookAtRegion(){this._imageLayerScene.forEach((e=>{let t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);e.holes.forEach((e=>{let r=this.getHoleWorldBox(e);if(this.calcBoxIntersect(r,e)){let r=e.getTerrainExcavation(e.getHoleId());if(r.getVisible()){let e=r.getAABBMin(),n=r.getAABBMax();t.x=Math.min(e.x,t.x),t.y=Math.min(e.y,t.y),t.z=Math.min(e.z,t.z),i.x=Math.max(n.x,i.x),i.y=Math.max(n.y,i.y),i.z=Math.max(n.z,i.z)}}}));const{orthoViewProjMatrix:r,orthoCamera:n}=this.createOrthoViewProjMatrixByBox({max:i,min:t});e.orthoViewProjMatrix=r,e.orthoCamera=n}))}addAllTempBoundaryPoint(e){this.tempBoundary.push(e)}setHoleBBoxLowestPos(e){let t;if(this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(t=this.viewer.getModelManager().getModel("TileGroup").tileManager),t){let i=e.getOriginBoundary();for(let r=0;r<i.length;r++){const n=this.viewer.drawingToWorld(i[r]);let a=t.worldPositionToLngLat(n),s={lon:a.x,lat:a.y,id:e.holeId,order:r};t.lngLatToWorldPositionWithObj(s,(function(t,i,r){e.setBBoxLowestPos({pos:t,id:i,order:r})}))}}}updateHolesVertex(){let e,t=0;for(const e of this.holeMap.values())t+=e.boundary.length;if(0!=t&&t==this.tempBoundary.length){for(const e of this.holeMap.values()){let t=e.holeId;e.boundary.splice(0,e.boundary.length);for(let i=0;i<this.tempBoundary.length;i++)if(this.tempBoundary[i].id==t){let t=this.viewer.worldToDrawing(this.tempBoundary[i].pos);e.boundary.push(t)}}this.tempBoundary.splice(0,this.tempBoundary.length)}this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(e=this.viewer.getModelManager().getModel("TileGroup").tileManager);var i=this;if(e&&this.isUseTerrain!=e.isUseTerrain()){this.isUseTerrain=e.isUseTerrain();for(const t of this.holeMap.values()){let r=t.getBoundary();for(let n=0;n<r.length;n++){const a=this.viewer.drawingToWorld(r[n]);let s=e.worldPositionToLngLat(a),o={lon:s.x,lat:s.y,id:t.holeId,order:n};e.lngLatToWorldPositionWithObj(o,(function(e,t,r){i.addAllTempBoundaryPoint({pos:e,id:t,order:r})}))}}}}render(e){this.renderer=e,this.excavationInfo.splice(0,this.excavationInfo.length),this.updateHolesVertex(),this.updateCameraLookAtRegion(),this._imageLayerScene.forEach((t=>{let i=this.getExcavationInfo(e,t);const r=this.viewer.modelManager.modelCollection;this.excavationInfo.push(i),r.traverse((e=>{if(t.modelId==e.id&&"TileGroup"==e.id){const t=e.tileManager;t&&t.setExcavation(i)}else t.modelId==e.id&&e.setExcavation(i)}))}))}},(()=>{class e extends r.ObjectGroup{constructor(e){super(r.ObjectGroupType.InteractionHelper,{priority:20}),this.name="InteractionHelper",this.viewer=e,this.controls={};const t=e.getScene().getRawMatrixGlobal();this.invertMatrix=(new THREE.Matrix4).copy(t).invert(),this.raycaster=new THREE.Raycaster,this.domElementEvents=[{element:this.viewer.domElement,type:"mousemove",event:e=>{var t=new THREE.Vector2(e.clientX,e.clientY),i=this.viewer.cameraControl.getRaycaster(t.x,t.y);let r=i.ray.origin.clone(),n=i.ray.direction.clone();this.raycaster.set(r,n),this.dispatchEvent({type:"HitTest",raycaster:this.raycaster}),this.dispatchEvent({type:"MouseMove",event:e});let a=!1;Object.values(this.controls).sort(((e,t)=>e.hitTestPriority-t.hitTestPriority)).some((e=>{if(e.selectedObject)a=!0;else{if(!e.hitTest)return;const t=e.hitTest(this.raycaster);t&&(a=t,this._hitControlId&&this._hitControlId!==e.controlId&&this.getControl(this._hitControlId).cancelHitTest(),this._hitControlId=e.controlId)}return a})),a||(this._hitControlId=null)}},{element:this.viewer.domElement,type:"mousedown",useCapture:!0,event:e=>{this._hitControlId&&(this.viewer.editorManager.enabled=!1),this.dispatchEvent({type:"MouseDown",event:e})}},{element:this.viewer.domElement,type:"mouseup",event:e=>{this.viewer.editorManager.enabled=!0,this.dispatchEvent({type:"MouseUp",event:e})}}],this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,(()=>{const e=this.viewer.camera._direction&&this.viewer.camera._direction.clone().applyMatrix4(this.invertMatrix).normalize(),t=this.viewer.camera.position.clone().applyMatrix4(this.invertMatrix),i=this.viewer.camera.fov;this.dispatchEvent({type:"CameraChanged",cameraDirection:e,cameraPosition:t,cameraFov:i})})),this.addDomElementEvents()}addDomElementEvents(){this.domElementEvents.forEach((({element:e,type:t,useCapture:i,event:r})=>{e.addEventListener(t,r,i)}))}removeDomElementEvents(){this.domElementEvents.forEach((({element:e,type:t,event:i})=>{e.removeEventListener(t,i)}))}addControl(e,t,i){const n=new r.Interaction.Control[t]({helper:this,id:e,...i});return this.add(n),this.controls[e]=n,n}getControl(e){return this.controls[e]}removeControl(e){const t=this.controls[e];t&&t.destroy()}destroy(){this.removeDomElementEvents(),Object.values(this.controls).forEach((e=>{e.destroy()}))}}e.getInstance=function(t){const i=t.getInteractionScene();if(!i._interactionHelper){const r=i._interactionHelper=new e(t);i.add(r);const n=t.getScene().getRawMatrixGlobal();r.applyMatrix4(n),r.updateMatrixWorld()}return i._interactionHelper},e.destroy=function(e){e._interactionHelper&&(e._interactionHelper.destroy(),e._interactionHelper=null)},r.Interaction=r.Interaction||{},r.Interaction.InteractionHelper=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.clock=new THREE.Clock,this.animationList=[],this.middlePoints=[],this.hoveredObject=null,this.selectedObject=null,this.visible=!1,this.hitTestPriority=isNaN(e.hitTestPriority)?3:e.hitTestPriority;let t=null;this.helperEvents={MouseDown:({event:e})=>{this.visible&&this.hoveredObject&&(this.selectedObject=this.hoveredObject,this.helper.dispatchEvent({type:"TransformStarted",control:this,object:this.selectedObject,id:this.controlId}),this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})},MouseMove:({event:e})=>{if(this.visible&&this.selectedObject){if(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2)return;this._isClick=!1;const i=new THREE.Vector2(e.clientX,e.clientY);this.transform(i),this.helper.dispatchEvent({type:"TransformChanged",control:this,object:this.selectedObject,id:this.controlId,clientPosition:i})}},MouseUp:({event:e})=>{if(this.visible)if(this.selectedObject){this.transformFinished();const i=this.selectedObject;this.selectedObject=null,this.helper.dispatchEvent({type:"TransformFinished",control:this,object:i,id:this.controlId}),this._isClick&&this.helper.dispatchEvent({type:"Clicked",control:this,object:i,id:this.controlId,event:e}),delete this._isClick,t=null}else 0==this.controlId.indexOf("EditClipSurfaceTool")&&2==e.button&&this._config.showEdge&&this.helper.dispatchEvent({type:"EditCompleted",control:this,id:this.controlId,event:e})}},Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.addEventListener(e,t)})),this.init&&this.init(),requestAnimationFrame((()=>{this.visible=!1!==this.getConfig().visible;const e=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=this.getViewer().camera.fov;this.updateScaleFactor&&this.updateScaleFactor({cameraPosition:e,cameraFov:t}),this.updateMatrixWorld(),this.getViewer().render()}));const i=()=>{if(this._destroyed)return;const e=this.clock.getDelta();let t=!1;this.animationList.forEach((({mixer:i,action:r,object:n})=>{r.isRunning()&&(t=!0,i.update(e),n.updateMatrixWorld(!0))})),t&&this.getViewer().render(),requestAnimationFrame(i)};i()}init(){}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}cancelHitTest(){this.visible&&(this.hoveredObject=null,this.children.forEach((e=>{e.isGrayMode?e.cancelGray():e.isHighlightMode&&e.cancelHighlight()})))}hitTest(e){if(!this.visible)return;let t=null,i=null;return this.children.some((n=>{if(!n.isEnabled)return!1;const a=n.hitTest(e);return a&&!t&&(t=n),a&&!i&&n instanceof r.Interaction.Item.EditingPoint&&(i=n),t&&i})),i&&(t=i),this.hoveredObject=t,this.children.forEach((e=>{t?(e===t?e.setHighlight():e.setGray&&e.setGray(),e.isMiddlePoint&&e!==t&&e.isHighlightMode&&e.cancelHighlight()):e.isGrayMode?e.cancelGray():e.isHighlightMode&&e.cancelHighlight()})),!!this.hoveredObject}getConfig(){return this._config}getViewer(){return this.helper.viewer}getFactor(e,t){const i=this.position.clone().clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,n=this.getViewer().domElement.offsetHeight;return this.factor=r/n,this.factor}addAnimation({mixer:e,action:t,object:i}){this.animationList.push({mixer:e,action:t,object:i})}transform(e){this.selectedObject&&this.selectedObject.transform&&this.selectedObject.transform(e)}transformFinished(){this.selectedObject&&this.selectedObject.transformFinished&&this.selectedObject.transformFinished()}addMiddlePoints(e){for(let t=0;t<e.length-1;t++){let i={x:(e[t].x+e[t+1].x)/2,y:(e[t].y+e[t+1].y)/2,z:(e[t].z+e[t+1].z)/2};const n=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",isMiddlePoint:!0,showText:!1,point:i});this.add(n),this.middlePoints.push(n)}}updatePointHintText(){let e=this.editingPoints.length<=this.miniPointNum?"左击编辑":"左击编辑，右击删除";this.editingPoints.forEach((t=>{t.setHintText(e)}))}hasIntersectionPoint(e){let t=!1;e.push(e[0]);for(let i=0;i<e.length-3;i++)for(let r=i+2;r<e.length-1;r++){if(0==i&&r==e.length-2)continue;if(this.computeSegmentsIntersect(e[i],e[i+1],e[r],e[r+1])){t=!0;break}}return t}detectTwoLineIntersected(e,t,i,r,n,a,s,o){var l,d,h;return 0!==(l=(i-e)*(o-a)-(s-n)*(r-t))&&(d=((t-r)*(s-e)+(i-e)*(o-t))/l,0<(h=((o-a)*(s-e)+(n-s)*(o-t))/l)&&h<1&&0<d&&d<1)}detectSequenceLineCrossed(e){for(let t=0;t<e.length-2;t++)for(let i=t+1;i<e.length-1;i++)if(this.detectTwoLineIntersected(e[t].x,e[t].y,e[t+1].x,e[t+1].y,e[i].x,e[i].y,e[i+1].x,e[i+1].y))return!0;return!1}computeSegmentsIntersect(e,t,i,r){var n=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),a=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);if(Math.abs(n)<=1e-5&&Math.abs(a)<=1e-5&&(e.x<i.x&&t.x<i.x&&e.x<r.x&&t.x<r.x||e.x>i.x&&t.x>i.x&&e.x>r.x&&t.x>r.x||e.y<i.y&&t.y<i.y&&e.y<r.y&&t.y<r.y||e.y>i.y&&t.y>i.y&&e.y>r.y&&t.y>r.y))return!1;if(n*a>0)return!1;var s=(i.x-e.x)*(r.y-e.y)-(i.y-e.y)*(r.x-e.x);if(s*((i.x-t.x)*(r.y-t.y)-(i.y-t.y)*(r.x-t.x))>0)return!1;var o=s/(a-n),l=o*(t.x-e.x),d=o*(t.y-e.y);return{x:e.x+l,y:e.y+d,z:0}}destroy(){for(this._destroyed=!0,Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)}));this.children.length>0;)this.children[0].destroy?this.children[0].destroy():(this.children[0].geometry.dispose(),this.children[0].material.dispose(),this.remove(this.children[0]));this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.BaseControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="TranslateControl";const{position:t,boundingBox:i}=e;t&&this.setPosition(t),i&&this.setBoundingBox(i),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e!==t?e.showDashedLine():e instanceof r.Interaction.Item.TranslatePlane&&e!==t&&(e.lastVisible=e.visible,e.visible=!1)})),this.getViewer().render())})),this.addHelperEvent("TransformFinished",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow?e.hideDashedLine():e instanceof r.Interaction.Item.TranslatePlane&&null!=e.lastVisible&&(e.visible=e.lastVisible)})),this.getViewer().render())}))}init(){const e=16,t=this.planeX=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:0,y:-16,z:e},normal:{x:1,y:0,z:0},color:"#F99D0B",name:"PlaneX"});this.add(t);const i=this.planeY=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:e,y:0,z:e},normal:{x:0,y:-1,z:0},color:"#F99D0B",name:"PlaneY"});this.add(i);const n=this.planeZ=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:e,y:-16,z:0},normal:{x:0,y:0,z:1},color:"#F99D0B",name:"PlaneZ"});this.add(n);const a=123,s=this.axisX=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:a,y:0,z:0},color:"#FF2905",name:"AxisX"});this.add(s);const o=this.axisY=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:-123,z:0},color:"#1922FB",name:"AxisY"});this.add(o);const l=this.axisZ=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:a},color:"#32D3A6",name:"AxisZ"});this.add(l);const d=this.dashedX=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:a,y:0,z:0}],color:"#FF2905",dashed:!0});d.visible=!1,this.add(d);const h=this.dashedY=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:-123,z:0}],color:"#1922FB",dashed:!0});h.visible=!1,this.add(h);const c=this.dashedZ=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:0,z:a}],color:"#32D3A6",dashed:!0});c.visible=!1,this.add(c)}updateAxisVisible(e){this.planeX.visible=e.Y&&e.Z,this.planeY.visible=e.X&&e.Z,this.planeZ.visible=e.X&&e.Y,this.dashedX.visible=!e.X,this.dashedY.visible=!e.Y,this.dashedZ.visible=!e.Z,this.axisX.visible=e.X,this.axisY.visible=e.Y,this.axisZ.visible=e.Z,this.updateMatrixWorld(),this.getViewer().render()}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov);const r=this.getFactor(t,i);if(this.scale.set(r,r,r),this.updateMatrixWorld(),this.boundingBox){const e=1/r;this.boundingBox.children.forEach((t=>{t.scale.set(e,e,e),t.updateMatrixWorld()}))}}transform(e){super.transform(e),this.updateScaleFactor()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}setBoundingBox(e){this.boundingBox&&this.remove(this.boundingBox),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox),this.updateScaleFactor()}updateBoundingBox(e){this.boundingBox&&this.boundingBox.update(e),this.updateScaleFactor()}destroy(){this.boundingBox&&(this.boundingBox.destroy(),this.helper.remove(this.boundingBox)),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.TranslateControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="StrechControl";const{position:t,boundingBox:i}=e;t&&this.setPosition(t),i&&this.setBoundingBox(i),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e!==t&&e.showDashedLine()})),this.getViewer().render())})),this.addHelperEvent("TransformFinished",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e.hideDashedLine()})),this.getViewer().render())}))}init(){const e=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:56},color:"#FFF227",name:"StrechZ"});this.add(e)}transform(e){super.transform(e),this.updateScaleFactor()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}setBoundingBox(e){this.boundingBox&&this.remove(this.boundingBox),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox),this.updateScaleFactor()}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov);const r=this.getFactor(t,i);if(this.scale.set(r,r,r),this.updateMatrixWorld(),this.boundingBox){const e=1/r;this.boundingBox.children.forEach((t=>{t.scale.set(e,e,e),t.updateMatrixWorld()}))}}updateBoundingBox(e){this.boundingBox&&this.boundingBox.update(e),this.updateScaleFactor()}destroy(){this.boundingBox&&(this.boundingBox.destroy(),this.helper.remove(this.boundingBox)),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.StrechControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="ScaleControl";const{position:t,boundingBox:i}=e;if(t&&this.setPosition(t),i){this.setBoundingBox(i);const e=new THREE.Vector3;i.getCenter(e);const t=i.max.clone().sub(e);this.setArrows(t);const n=new r.Interaction.Item.ScaleCube({helper:this.helper,control:this,length:20,color:"#F99D0B"});this.add(n),this.cube=n;const a=this.dashedX=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:t.x,y:0,z:0}],color:"#FF2905",dashed:!0});this.add(a);const s=this.dashedY=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:-t.y,z:0}],color:"#1922FB",dashed:!0});this.add(s);const o=this.dashedZ=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:0,z:t.z}],color:"#32D3A6",dashed:!0});this.add(o)}this.isFinished=!0,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({control:e,object:t})=>{if(e===this){if(!this.isFinished)return;this.isFinished=!1}e===this&&t===this.cube?this.arrows.forEach((e=>{e.originVisible=e.visible,e.visible=!1})):e===this&&(this.arrows.forEach((e=>{e.originVisible=e.visible,t!==e&&(e.visible=!1)})),this.cube.originVisible=this.cube.visible,this.cube.visible=!1)})),this.addHelperEvent("TransformFinished",(({control:e})=>{e===this&&(this.isFinished=!0,this.arrows.forEach((e=>e.visible=e.originVisible)),(!0===this.cube.originVisible||!1===this.cube.originVisible)&&(this.cube.visible=this.cube.originVisible),this.updateMatrixWorld(),this.getViewer().render())}))}init(){}setBoundingBox(e){this.boundingBox&&(this.remove(this.boundingBox),this.boundingBox.destroy()),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox)}setArrows(e){const t=40;this.arrows=[],this.planes=[];const i=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:0,y:e.y,z:e.z},{x:0,y:e.y,z:-e.z},{x:0,y:-e.y,z:-e.z},{x:0,y:-e.y,z:e.z}],position:{x:e.x,y:0,z:0},color:"#CCCCCC",opacity:.5,name:"AxisX"});this.add(i),this.planes.push(i);const n=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:0,y:e.y,z:e.z},{x:0,y:e.y,z:-e.z},{x:0,y:-e.y,z:-e.z},{x:0,y:-e.y,z:e.z}],position:{x:-e.x,y:0,z:0},color:"#CCCCCC",opacity:.5,name:"AxisXN"});this.add(n),this.planes.push(n);const a=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:e.x,y:0,z:e.z},{x:e.x,y:0,z:-e.z},{x:-e.x,y:0,z:-e.z},{x:-e.x,y:0,z:e.z}],position:{x:0,y:e.y,z:0},color:"#CCCCCC",opacity:.5,name:"AxisY"});this.add(a),this.planes.push(a);const s=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:e.x,y:0,z:e.z},{x:e.x,y:0,z:-e.z},{x:-e.x,y:0,z:-e.z},{x:-e.x,y:0,z:e.z}],position:{x:0,y:-e.y,z:0},color:"#CCCCCC",opacity:.5,name:"AxisYN"});this.add(s),this.planes.push(s);const o=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:e.x,y:e.y,z:0},{x:e.x,y:-e.y,z:0},{x:-e.x,y:-e.y,z:0},{x:-e.x,y:e.y,z:0}],position:{x:0,y:0,z:e.z},color:"#CCCCCC",opacity:.5,name:"AxisZ"});this.add(o),this.planes.push(o);const l=new r.Interaction.Item.Quadrangle({helper:this.helper,control:this,points:[{x:e.x,y:e.y,z:0},{x:e.x,y:-e.y,z:0},{x:-e.x,y:-e.y,z:0},{x:-e.x,y:e.y,z:0}],position:{x:0,y:0,z:-e.z},color:"#CCCCCC",opacity:.5,name:"AxisZN"});this.add(l),this.planes.push(l),this.planes.map((e=>e.visible=!1));const d=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:t,y:0,z:0},position:{x:e.x,y:0,z:0},color:"#FF2905",name:"AxisX"});this.add(d),this.arrows.push(d);const h=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:-40,y:0,z:0},position:{x:-e.x,y:0,z:0},color:"#FF2905",name:"AxisXN"});this.add(h),this.arrows.push(h);const c=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:t,z:0},position:{x:0,y:e.y,z:0},color:"#1922FB",name:"AxisY"});this.add(c),this.arrows.push(c);const u=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:-40,z:0},position:{x:0,y:-e.y,z:0},color:"#1922FB",name:"AxisYN"});this.add(u),this.arrows.push(u);const p=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:t},position:{x:0,y:0,z:e.z},color:"#32D3A6",name:"AxisZ"});this.add(p),this.arrows.push(p);const m=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:-40},position:{x:0,y:0,z:-e.z},color:"#32D3A6",name:"AxisZN"});this.add(m),this.arrows.push(m)}updateAxisVisible(e){this.arrows.map((t=>{"AxisX"==t.name||"AxisXN"==t.name?t.visible=e.X:"AxisY"==t.name||"AxisYN"==t.name?t.visible=e.Y:"AxisZ"!=t.name&&"AxisZN"!=t.name||(t.visible=e.Z)})),this.cube.visible=e.Uniform,this.updateMatrixWorld(),this.getViewer().render()}update(e){this.boundingBox.update(e);const t=new THREE.Vector3;e.getCenter(t);const i=e.max.clone().sub(t);this.arrows[0].updatePosition(new THREE.Vector3(i.x,0,0)),this.arrows[1].updatePosition(new THREE.Vector3(-i.x,0,0)),this.arrows[2].updatePosition(new THREE.Vector3(0,i.y,0)),this.arrows[3].updatePosition(new THREE.Vector3(0,-i.y,0)),this.arrows[4].updatePosition(new THREE.Vector3(0,0,i.z)),this.arrows[5].updatePosition(new THREE.Vector3(0,0,-i.z)),this.planes[0].updatePosition(new THREE.Vector3(i.x,0,0)),this.planes[1].updatePosition(new THREE.Vector3(-i.x,0,0)),this.planes[2].updatePosition(new THREE.Vector3(0,i.y,0)),this.planes[3].updatePosition(new THREE.Vector3(0,-i.y,0)),this.planes[4].updatePosition(new THREE.Vector3(0,0,i.z)),this.planes[5].updatePosition(new THREE.Vector3(0,0,-i.z)),this.planes[0].update([{x:0,y:i.y,z:i.z},{x:0,y:i.y,z:-i.z},{x:0,y:-i.y,z:-i.z},{x:0,y:-i.y,z:i.z}]),this.planes[1].update([{x:0,y:i.y,z:i.z},{x:0,y:i.y,z:-i.z},{x:0,y:-i.y,z:-i.z},{x:0,y:-i.y,z:i.z}]),this.planes[2].update([{x:i.x,y:0,z:i.z},{x:i.x,y:0,z:-i.z},{x:-i.x,y:0,z:-i.z},{x:-i.x,y:0,z:i.z}]),this.planes[3].update([{x:i.x,y:0,z:i.z},{x:i.x,y:0,z:-i.z},{x:-i.x,y:0,z:-i.z},{x:-i.x,y:0,z:i.z}]),this.planes[4].update([{x:i.x,y:i.y,z:0},{x:i.x,y:-i.y,z:0},{x:-i.x,y:-i.y,z:0},{x:-i.x,y:i.y,z:0}]),this.planes[5].update([{x:i.x,y:i.y,z:0},{x:i.x,y:-i.y,z:0},{x:-i.x,y:-i.y,z:0},{x:-i.x,y:i.y,z:0}]);const r={x:0,y:0,z:0};this.dashedX.update([r,{x:i.x,y:0,z:0}]),this.dashedY.update([r,{x:0,y:-i.y,z:0}]),this.dashedZ.update([r,{x:0,y:0,z:i.z}])}hitTest(e){let t=super.hitTest(e);return t?this.planes.map((e=>{this.hoveredObject.name===e.name&&(e.visible=!0)})):this.planes.map((e=>e.visible=!1)),t}updateScaleFactor(e){const{cameraPosition:t,cameraFov:i}=e,r=this.getFactor(t,i);this.arrows.forEach((e=>e.updateScaleFactor(r))),this.cube.updateScaleFactor(r),[this.dashedX,this.dashedY,this.dashedZ].forEach((e=>e.updateScaleFactor(r)))}transform(e){this.scaleInfo=null,super.transform(e);const t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov;this.updateScaleFactor({cameraPosition:t,cameraFov:i})}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.ScaleControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="RotateControl",this.axisOption={X:!0,Y:!0,Z:!0};const{position:t,boundingBox:i}=e;t&&this.setPosition(t);const n=123;if(this.dashedLines=[],i){this.setBoundingBox(i);const e=new THREE.Vector3;i.getCenter(e);const t=this.dashedX=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:n,y:0,z:0}],color:"#FF2905",dashed:!0});this.add(t),this.dashedLines.push(t);const a=this.dashedY=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:-123,z:0}],color:"#1922FB",dashed:!0});this.add(a),this.dashedLines.push(a);const s=this.dashedZ=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:0,z:n}],color:"#32D3A6",dashed:!0});this.add(s),this.dashedLines.push(s);const o=this.dashedXGray=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:n,y:0,z:0}],color:"#CCCCCC",dashed:!0});o.visible=!1,this.add(o),this.dashedLines.push(o);const l=this.dashedYGray=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:-123,z:0}],color:"#CCCCCC",dashed:!0});l.visible=!1,this.add(l),this.dashedLines.push(l);const d=this.dashedZGray=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:0,z:n}],color:"#CCCCCC",dashed:!0});d.visible=!1,this.add(d),this.dashedLines.push(d),this.rings=[];const h=this.ringX=new r.Interaction.Item.Ring({name:"ringX",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#FF2905",position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)).multiply((new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)))});this.add(h),this.rings.push(h);const c=this.ringY=new r.Interaction.Item.Ring({name:"ringY",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#1922FB",position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1))});this.add(c),this.rings.push(c);const u=this.ringZ=new r.Interaction.Item.Ring({name:"ringZ",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#32D3A6",position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0))});this.add(u),this.rings.push(u);const p=this.ringXGray=new r.Interaction.Item.Ring({name:"ringXGray",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#CCCCCC",notHitTest:!0,position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)).multiply((new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)))});p.visible=!1,this.add(p),this.rings.push(p);const m=this.ringYGray=new r.Interaction.Item.Ring({name:"ringYGray",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#CCCCCC",notHitTest:!0,position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1))});m.visible=!1,this.add(m),this.rings.push(m);const f=this.ringZGray=new r.Interaction.Item.Ring({name:"ringZGray",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:.02,thetaLength:Math.PI/2-.04,opacity:.3,color:"#CCCCCC",notHitTest:!0,position:{x:0,y:0,z:0},quaternion:(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0))});f.visible=!1,this.add(f),this.rings.push(f)}this.isFinished=!0,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({control:e,object:t})=>{if(e===this){if(!this.isFinished)return;this.isFinished=!1}if(e===this&&(t===this.ringX||t===this.ringY||t===this.ringZ)){let e,i,a="",s="";t===this.ringX?(e=new THREE.Vector3(246,0,0),i=new THREE.Vector3(-246,0,0),a="#FF2905",s=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)).multiply((new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)))):t===this.ringY?(e=new THREE.Vector3(0,246,0),i=new THREE.Vector3(0,-246,0),a="#1922FB",s=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1))):(e=new THREE.Vector3(0,0,246),i=new THREE.Vector3(0,0,-246),a="#32D3A6",s=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)));const o=this.editWholeRing=new r.Interaction.Item.Ring({name:"editWholeRing",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:0,thetaLength:2*Math.PI,opacity:.3,color:a,position:{x:0,y:0,z:0},quaternion:s});this.add(o);const l=this.editDashed=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[e,i],color:a,dashed:!0});this.add(l),this.rings.map((e=>{e.originVisible=e.visible,e.visible=!1})),this.dashedLines.map((e=>{e.originVisible=e.visible,e.visible=!1}))}})),this.addHelperEvent("TransformChanged",(({control:e,object:t})=>{if(e===this){if(this.rotateInfo){if(this.hintText&&this.remove(this.hintText),!this.textDir){let e=this.rotateInfo.textDir.clone();this.textDir=e.applyQuaternion(this.quaternion.clone().invert())}let e=new THREE.Vector3(0,0,0).add(this.textDir.normalize().multiplyScalar(159.9));this.hintText=this.getText(e,Math.round(this.rotateInfo.angleTotal/Math.PI*180)*("ringX"==this.rotateInfo.type?-1:1)+"°"),this.add(this.hintText),this.updateMatrixWorld()}this.editProgressRing&&this.remove(this.editProgressRing);let e="",i="";t===this.ringX?(e="#FF2905",i=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)).multiply((new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)))):t===this.ringY?(e="#1922FB",i=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1))):(e="#32D3A6",i=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0)));const a=this.editProgressRing=new r.Interaction.Item.Ring({name:"editProgressRing",helper:this.helper,control:this,innerRadius:104.55,outerRadius:n,thetaStart:this.rotateInfo.startRingAngle-this.rotateInfo.angleTotal,thetaLength:this.rotateInfo.angleTotal,opacity:1,color:e,position:{x:0,y:0,z:0},quaternion:i,isWholeRadius:!0});this.add(a)}})),this.addHelperEvent("TransformFinished",(({control:e})=>{e===this&&(this.isFinished=!0,this.rings.map((e=>e.visible=e.originVisible)),this.dashedLines.map((e=>e.visible=e.originVisible)),this.remove(this.editWholeRing),this.remove(this.editDashed),this.hintText&&this.remove(this.hintText),this.hintText=null,this.editProgressRing&&this.remove(this.editProgressRing),this.editProgressRing=null,this.updateMatrixWorld(),this.getViewer().render(),this.textDir=null)}))}getText(e,t){const i=e,n=t,a=document.createElement("canvas"),s=a.getContext("2d"),o='68px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';s.font=o;const l=s.measureText(t).width+75,d=l+20,h=l+20;a.width=d,a.height=h,s.font=o;const c=d/2-52.5,u=d,p=d/2+52.5;s.fillStyle="#000000",s.globalAlpha=1,s.fillRect(4,c,l+12,105),s.fillStyle="#FFFFFF",s.globalAlpha=1,s.fillText(n,40,c+75),s.strokeStyle="#000000",s.lineWidth=8,s.beginPath(),s.moveTo(0,c+20),s.arcTo(0,p,4,p,20),s.arcTo(u,p,u,p-4,20),s.arcTo(u,c,u-4,c,20),s.arcTo(0,c,0,c+4,20),s.stroke();const m=new THREE.CanvasTexture(a),f=new THREE.SpriteMaterial({map:m,depthTest:!1}),g=new THREE.Sprite(f);g.position.set(i.x,i.y,i.z);let v=d/1024*60;return v*=4,g.scale.set(v,v,v),g.renderOrder=r.EnumRenderOrder.Effect+300,g}init(){}setBoundingBox(e){this.boundingBox&&(this.remove(this.boundingBox),this.boundingBox.destroy()),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox)}update(e){this.boundingBox.update(e);const t=new THREE.Vector3;e.getCenter(t);const i={x:0,y:0,z:0};this.dashedX.update([i,{x:offset.x,y:0,z:0}]),this.dashedY.update([i,{x:0,y:-offset.y,z:0}]),this.dashedZ.update([i,{x:0,y:0,z:offset.z}])}hitTest(e){let t=super.hitTest(e);return t?(this.dashedXGray.visible=!0,this.dashedYGray.visible=!0,this.dashedZGray.visible=!0):(this.dashedXGray.visible=!this.axisOption.X,this.dashedYGray.visible=!this.axisOption.Y,this.dashedZGray.visible=!this.axisOption.Z),t}updateAxisVisible(e){this.axisOption={...this.axisOption,...e},this.ringX.visible=e.X,this.ringY.visible=e.Y,this.ringZ.visible=e.Z,this.ringXGray.visible=!e.X,this.ringYGray.visible=!e.Y,this.ringZGray.visible=!e.Z,this.dashedXGray.visible=!e.X,this.dashedYGray.visible=!e.Y,this.dashedZGray.visible=!e.Z,this.updateMatrixWorld(),this.getViewer().render()}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov);const r=this.getFactor(t,i);if(this.scale.set(r,r,r),this.updateMatrixWorld(),this.boundingBox){const e=1/r;this.boundingBox.children.forEach((t=>{t.scale.set(e,e,e),t.updateMatrixWorld()}))}}transform(e){this.rotateInfo=null,super.transform(e)}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.RotateControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="PolygonControl",this.isEditPointMode=!1,this.miniPointNum=3,this.updatePointHintText(),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t,event:i})=>{if(this.selectedObject=null,e===this.controlId)if(this.editingPoints.indexOf(t)>=0){if(2===i.button){if(this.miniPointNum>=this.editingPoints.length)return;if(t.isSelected)return;let e=this.editingPoints.indexOf(t),i=this.editingPoints.map((e=>e.position.clone()));if(i.splice(e,1),this.hasIntersectionPoint(i))return void this.pointTranslateControl.helper.dispatchEvent({type:"WarningHint",control:this.pointTranslateControl,id:this.pointTranslateControl.controlId,text:"不支持出现交叉点位。"});this.remove(t),this.editingPoints.splice(e,1);const r=this.editingPoints.map((e=>e.position.clone()));this.plane.update(r);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);return this.middlePoints=[],this.addMiddlePoints([...r,r[0]]),this.updatePointHintText(),this.translateControl.visible&&this.cancelEditPoint(),void this.translateControl.helper.dispatchEvent({type:"TransformFinished",control:this.translateControl,id:this.translateControl.controlId})}t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,t.cancelHighlight(),t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))}else if(t===this.plane&&this.selectedPoint)this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint();else if(this.middlePoints.indexOf(t)>=0){let e=this.middlePoints.indexOf(t);const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:t.position});this.add(i),this.editingPoints.splice(e+1,0,i);const n=this.editingPoints.map((e=>e.position.clone()));this.plane.update(n);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this.addMiddlePoints([...n,n[0]]),i.isSelected=!0,this.selectedPoint=i,i.setHighlight(),this.editPoint(i),this.editingPoints.forEach((e=>{e!==i&&(e.isSelected=!1,e.cancelHighlight())})),this.updatePointHintText(),this.getViewer().domElement.style.cursor="",this.translateControl.helper.dispatchEvent({type:"TransformFinished",control:this.translateControl,id:this.translateControl.controlId})}}))}init(){this.editingPoints=[];const e=this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),t=(new THREE.Box3).setFromPoints(e);e.forEach(((e,t)=>{const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e});this.add(i),this.editingPoints.push(i)})),this.addMiddlePoints([...e,e[0]]),this.addPlane(e),this.addTranslateControl(t),this.addPointTranslateControl()}addPlane(e){this.plane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:"#FFF227",edgeColor:"#FFF227"}),this.plane.enable(!1),this.add(this.plane)}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`;const t=this.center=new THREE.Vector3;e.getCenter(t),this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:t,boundingBox:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.center);this.position.set(e,i,r),this.updateScaleFactor(),this.updateMatrixWorld()}if(e===this.pointTranslateControlId){const{x:e,y:i}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,this.selectedPoint.position.z),this.selectedPoint.updateMatrixWorld();const r=this.editingPoints.map((e=>e.position.clone()));this.plane.update(r);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this.addMiddlePoints([...r,r[0]]),this.updateScaleFactor(),this.updateMatrixWorld()}}))}addPointTranslateControl(){this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2});const e=["PlaneX","PlaneY","AxisZ"];this.pointTranslateControl.children.forEach((t=>{e.indexOf(t.name)>=0&&(t.enable(!1),t.visible=!1)}))}editPoint(e){this.translateControl.visible=!1,this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor(),this.plane.enable(!0),this.getViewer().render()}cancelEditPoint(){this.translateControl.visible=!0,this.pointTranslateControl.visible=!1;const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.translateControl.setPosition(i),this.translateControl.updateBoundingBox(t),this.translateControl.updateScaleFactor(),this.plane.cancelHighlight(),this.plane.enable(!1),this.getViewer().render()}transform(e){}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.middlePoints.forEach((e=>e.updateScaleFactor(t,i)))}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}setPoints(e){if(!e||!Array.isArray(e)||e.length!==this.editingPoints.length)return;e.forEach(((e,t)=>{const i=this.editingPoints[t];i.position.set(e.x-this.position.x,e.y-this.position.y,e.z-this.position.z),i.updateMatrixWorld()}));const t=this.editingPoints.map((e=>e.position.clone()));this.plane.update(t);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this.addMiddlePoints([...t,t[0]]),this.updateScaleFactor(),this.updateMatrixWorld(),!0===this.translateControl.visible?this.cancelEditPoint():!0===this.pointTranslateControl.visible&&this.selectedPoint&&this.editPoint(this.selectedPoint)}destroy(){this.pointTranslateControl.destroy(),this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.PolygonControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="LineControl",this.isEditPointMode=!1,this.miniPointNum=2,this.updatePointHintText(),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t,event:i})=>{if(this.selectedObject=null,e===this.controlId)if(this.editingPoints.indexOf(t)>=0){if(2===i.button){if(this.miniPointNum>=this.editingPoints.length)return;if(t.isSelected)return;let e=this.editingPoints.indexOf(t);this.remove(t),this.editingPoints.splice(e,1);const i=this.editingPoints.map((e=>e.position.clone()));this.curveLine.update(i);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);return this.middlePoints=[],this.addMiddlePoints(),this.updatePointHintText(),this.translateControl.visible&&this.cancelEditPoint(),void this.translateControl.helper.dispatchEvent({type:"TransformFinished",control:this.translateControl,id:this.translateControl.controlId})}t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,t.cancelHighlight(),t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))}else if(t===this.curveLine&&this.selectedPoint)this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint();else if(this.middlePoints.indexOf(t)>=0){let e=this.middlePoints.indexOf(t);const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:t.position});this.add(i),this.editingPoints.splice(e+1,0,i);const n=this.editingPoints.map((e=>e.position.clone()));this.curveLine.update(n);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this.addMiddlePoints(),i.isSelected=!0,this.selectedPoint=i,i.setHighlight(),this.editPoint(i),this.editingPoints.forEach((e=>{e!==i&&(e.isSelected=!1,e.cancelHighlight())})),this.updatePointHintText(),this.getViewer().domElement.style.cursor="",this.translateControl.helper.dispatchEvent({type:"TransformFinished",control:this.translateControl,id:this.translateControl.controlId})}}))}init(){this.editingPoints=[];const e=this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),t=(new THREE.Box3).setFromPoints(e);e.forEach(((e,t)=>{const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e});this.add(i),this.editingPoints.push(i)})),this.addCurveLine(e),this.addMiddlePoints(),this.addTranslateControl(t),this.addPointTranslateControl()}addCurveLine(e){this.curveLine=new r.Interaction.Item.Curve({helper:this.helper,control:this,name:"CurveLine",points:e,color:"#FFF227"}),this.curveLine.enable(!1),this.add(this.curveLine)}addMiddlePoints(){let e=Math.round((this.curveLine.curvePoints.length-this.editingPoints.length)/(this.editingPoints.length-1));for(let t=0;t<this.editingPoints.length-1;t++){let i=this.curveLine.curvePoints[Math.round(e/2)+t*e+t];const n=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",isMiddlePoint:!0,showText:!1,point:i});this.add(n),this.middlePoints.push(n)}}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`;const t=this.center=new THREE.Vector3;e.getCenter(t),this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:t,boundingBox:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.center);this.position.set(e,i,r),this.updateScaleFactor(),this.updateMatrixWorld()}if(e===this.pointTranslateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,r),this.selectedPoint.updateMatrixWorld();const n=this.editingPoints.map((e=>e.position.clone()));this.curveLine.update(n);for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this.addMiddlePoints(),this.updateScaleFactor(),this.updateMatrixWorld()}}))}addPointTranslateControl(){this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2})}editPoint(e){this.translateControl.visible=!1,this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor(),this.curveLine.enable(!0),this.getViewer().render()}cancelEditPoint(){this.translateControl.visible=!0,this.pointTranslateControl.visible=!1;const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.translateControl.setPosition(i),this.translateControl.updateBoundingBox(t),this.translateControl.updateScaleFactor(),this.curveLine.cancelHighlight(),this.curveLine.enable(!1),this.getViewer().render()}transform(e){}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.middlePoints.forEach((e=>e.updateScaleFactor(t,i))),this.updateCurveRigidTimeout&&(clearTimeout(this.updateCurveRigidTimeout),this.updateCurveRigidTimeout=null),this.updateCurveRigidTimeout=setTimeout((()=>{this.curveLine.updateScaleFactor(t,i)}),200)}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){this.pointTranslateControl.destroy(),this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.LineControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="CircleControl",this.drawAngle="boolean"!=typeof e.drawAngle||e.drawAngle,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({event:e})=>{}))}init(){this.drawAngle="boolean"!=typeof this._config.drawAngle||this._config.drawAngle,this.basePosition=new THREE.Vector3(0,0,0),this.editingPoints=[];let{center:e,radius:t,thetaStart:i,thetaLength:n}=this.getConfig();this.radius=t,i=this.thetaStart=i||0,n=this.thetaLength=n||Math.PI/3,this.position.set(e.x,e.y,e.z);const a=this.pointCenter=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointCenter",point:this.basePosition,enableAnimation:!1,showText:!1});if(this.add(a),this.editingPoints.push(a),this.drawAngle){const e=this.pointStart=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointStart",point:new THREE.Vector3(t,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i),showText:!1});this.add(e),this.editingPoints.push(e);const a=()=>{this.editingSector&&(this.editingSector.visible=!1),this.circleSector&&this.circleSector.update(this.basePosition,this.radius,this.thetaStart,this.thetaLength),this.translateControl&&(this.translateControl.visible=!0),this.getViewer().render()};e.transform=t=>{this.updateSectorByPoint(e,t)},e.transformFinished=a;const s=this.pointEnd=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointEnd",point:new THREE.Vector3(t,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i+n),showText:!1});this.add(s),this.editingPoints.push(s),s.transform=e=>{this.updateSectorByPoint(s,e)},s.transformFinished=a}const s=this.circle=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"Circle",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFFFFF",opacity:.1,hitTestEdge:!0});if(this.add(s),s.transform=e=>{this.updateRadius(e)},s.transformFinished=()=>{this.translateControl&&(this.translateControl.visible=!0),this.getViewer().render()},this.drawAngle){const e=this.circleSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"CircleSector",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:i,thetaLength:n});this.add(e);const a=this.editingSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"EditingSector",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:i,thetaLength:n,enableAnimation:!1});this.add(a),a.visible=!1;const s=this.sectorAngle=new r.Interaction.Item.SectorAngle({helper:this.helper,control:this,name:"SectorAngle",center:this.basePosition,radius:t,thetaStart:i,thetaLength:n});this.add(s)}this.addTranslateControl(e)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.sectorAngle&&this.sectorAngle.updateScaleFactor(t,i),this.updateCicleRigidTimeout&&(clearTimeout(this.updateCicleRigidTimeout),this.updateCicleRigidTimeout=null),this.updateCicleRigidTimeout=setTimeout((()=>{this.circle.updateScaleFactor(t,i)}),200)}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`,this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone();this.position.set(e,i,r),this.drawAngle&&this.updateScaleFactor(),this.updateMatrixWorld()}}))}getIntersectPosition(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=new THREE.Vector3(0,0,1),n=new THREE.Plane(r),a=this.getViewer().drawingToWorld(this.getViewer().camera.position.clone()),s=-n.distanceToPoint(this.position);n.set(r,s);const o=new THREE.Ray(a,i),l=new THREE.Vector3;return o.intersectPlane(n,l),l}updateRadius(e){this.translateControl.visible=!1;const t=this.getIntersectPosition(e).clone().sub(this.position).length();this.setRadius(t)}updateSectorByPoint(e,t){this.translateControl.visible=!1;const i=this.getIntersectPosition(t).clone().sub(this.position).normalize().multiplyScalar(this.radius);if(e.position.set(i.x,i.y,i.z),e.updateMatrixWorld(),this.editingSector){this.editingSector.visible=!0;const e=this.thetaStart=new THREE.Vector2(this.pointStart.position.x,this.pointStart.position.y).angle();let t=new THREE.Vector2(this.pointEnd.position.x,this.pointEnd.position.y).angle()-e;t<0&&(t+=2*Math.PI),this.thetaLength=t,this.editingSector.update(this.basePosition,this.radius,e,t),this.sectorAngle&&this.sectorAngle.update(this.basePosition,this.radius,e,t)}this.getViewer().render()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(),this.translateControl.setPosition(e),this.getViewer().render()}setRadius(e){if(this.radius=e,this.pointStart){const t=new THREE.Vector3(e,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaStart);this.pointStart.position.set(t.x,t.y,t.z),this.pointStart.updateMatrixWorld()}if(this.pointEnd){const t=new THREE.Vector3(e,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaStart+this.thetaLength);this.pointEnd.position.set(t.x,t.y,t.z),this.pointEnd.updateMatrixWorld()}this.circle.update(this.basePosition,e),this.circleSector&&this.circleSector.update(this.basePosition,e,this.thetaStart,this.thetaLength),this.drawAngle&&(this.editingSector.update(this.basePosition,e,this.thetaStart,this.thetaLength),this.sectorAngle.radius=e,this.sectorAngle.updateScaleFactor()),this.getViewer().render()}setThetaLength(e){e>2*Math.PI&&(e=2*Math.PI),this.thetaLength=e;const t=this.thetaStart=new THREE.Vector2(this.pointStart.position.x,this.pointStart.position.y).angle(),i=t+e,r=new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i).multiplyScalar(this.radius);this.pointEnd.position.set(r.x,r.y,r.z),this.pointEnd.updateMatrixWorld(),this.circleSector&&this.circleSector.update(this.basePosition,this.radius,t,e),this.sectorAngle&&this.sectorAngle.update(this.basePosition,this.radius,t,e),this.getViewer().render()}getCircleData(){return{center:this.position.clone(),radius:this.radius,thetaStart:this.thetaStart,thetaLength:this.thetaLength}}hitTest(e){if(!this.visible)return;const t=[...this.editingPoints,this.circle];let i=null;return t.some((t=>{if(!t.isEnabled)return!1;const r=t.hitTest(e);return r&&(i=t),r})),this.hoveredObject=i,i===this.circle?(this.circle.setHighlight(),this.circleSector&&this.circleSector.setHighlight(),this.editingPoints.forEach((e=>e.cancelHighlight()))):(this.circle.cancelHighlight(),this.circleSector&&this.circleSector.cancelHighlight(),this.editingPoints.forEach((e=>{e===i?e.setHighlight():e.cancelHighlight()}))),!!this.hoveredObject}destroy(){this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.CircleControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawPolygonControl",this.editingPoints=[],this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>2?(this.showPolygon(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}addEditingPoint(e){0===this.editingPoints.length&&(this.planeZ=e.z);const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:{...e,z:this.planeZ},enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showPolygon(this.getPoints()),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push({...e,z:this.planeZ}),this.showPolygon(t),this.updateMatrixWorld()}showPolygon(e){if(!e||e.length<2)return;const t=2===e.length?e:[...e,e[0]];this.planeEdge?this.planeEdge.update(t):(this.planeEdge=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"EditingPlaneEdge",points:t,color:"#FFF227"}),this.add(this.planeEdge)),e.length<3||(this.plane?this.plane.update(e):(this.plane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:"#FFF227",edgeColor:"#FFF227",enableAnimation:!1}),this.add(this.plane)))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.plane=null,this.planeEdge=null}reset(){this.clear(),this.finished=!1}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawPolygonControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawLineControl",this.editingPoints=[],this.finished=!1,this.autoClose=e.autoClose||!1,this.autoClosePix=e.autoClosePix?e.autoClosePix:4,this.isCurve=void 0===e.isCurve||e.isCurve,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){let e=this.getPointByRayCaster();this._initPoint&&(e=this.autoClosePoint(e,!1)),e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>1?(this.isCurve?this.showCurveLine(this.getPoints()):this.showLine(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i),this._autoCloseFinished&&(this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId}),delete this._autoCloseFinished,delete this._initPoint)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}autoClosePoint(e,t=!1){const i=this.helper.viewer.worldToClient(this._initPoint),r=this.helper.viewer.worldToClient(e);return Math.abs(i.x-r.x)<this.autoClosePix&&Math.abs(i.y-r.y)<this.autoClosePix?(t&&(this._autoCloseFinished=!0),this._initPoint):e}addEditingPoint(e){this._initPoint&&this.editingPoints.length>2&&(e=this.autoClosePoint(e,!0));const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e,enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.isCurve?this.showCurveLine(this.getPoints()):this.showLine(this.getPoints()),this.autoClose&&1==this.editingPoints.length&&(this._initPoint=e),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push(e),this.isCurve?this.showCurveLine(t):this.showLine(t),this.updateMatrixWorld()}showCurveLine(e){!e||e.length<2||(this.curveLine?this.curveLine.update(e):(this.curveLine=new r.Interaction.Item.Curve({helper:this.helper,control:this,name:"CurveLine",points:e,color:"#FFF227",enableAnimation:!1}),this.add(this.curveLine)))}showLine(e){!e||e.length<2||(this.curveLine?this.curveLine.update(e):(this.curveLine=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"Line",points:e,color:"#FFF227",enableAnimation:!1}),this.add(this.curveLine)))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.curveLine=null}reset(){this.clear(),this.finished=!1}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawLineControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawCircleControl",this.editingPoints=[],this.finished=!1,this.thetaLength=Math.PI/3,this.drawAngle="boolean"!=typeof e.drawAngle||e.drawAngle,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>1?(this.showCircle(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i);2===this.getPoints().length&&(this.finished=!0,this.showCircle(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId}))}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}addEditingPoint(e){0===this.editingPoints.length&&(this.planeZ=e.z);const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:{...e,z:this.planeZ},enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showCircle(this.getPoints()),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push(new THREE.Vector3(e.x,e.y,this.planeZ)),this.showCircle(t),this.updateMatrixWorld()}showCircle(e){if(!e||e.length<2)return;const t=this.center=e[0],i=e[1].clone().sub(t),n=this.radius=i.length(),a=this.thetaStart=new THREE.Vector2(i.x,i.y).angle(),s=i.clone().applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaLength).add(t);if(this.circle)this.circle.update(t,n),this.drawAngle&&(this.circleSector.update(t,n,a,this.thetaLength),this.sectorAngle.update(t,n,a,this.thetaLength));else if(this.circle=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"Circle",center:t,radius:n,color:"#FFF227",edgeColor:"#FFFFFF",opacity:.1,enableAnimation:!1}),this.add(this.circle),this.drawAngle){this.circleSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"CircleSector",center:t,radius:n,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:a,thetaLength:this.thetaLength,enableAnimation:!1}),this.add(this.circleSector);const e=this.sectorAngle=new r.Interaction.Item.SectorAngle({helper:this.helper,control:this,name:"SectorAngle",center:t,radius:n,thetaStart:a,thetaLength:this.thetaLength});this.add(e)}2===this.editingPoints.length&&(this.editingPointEnd=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointEnd",point:s,enableAnimation:!1}),this.add(this.editingPointEnd))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.editingPointEnd&&this.editingPointEnd.updateScaleFactor(t,i),this.sectorAngle&&this.sectorAngle.updateScaleFactor(t,i)}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.circle=null,this.circleSector=null,this.sectorAngle=null}reset(){this.clear(),this.finished=!1}getCircleData(){return this.finished?{center:this.center,radius:this.radius,thetaStart:this.thetaStart,thetaLength:this.thetaLength}:null}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawCircleControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawSurfaceControl",this.editingPoints=[],this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>2?(this.showSurface(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;let n=null;if(this._config.layerInfo){const e=r.find((e=>!(!this._config.layerInfo.isMap||!e.isMap)||this._config.layerInfo.modelId==e.modelId));if(!e)return null;n=e.position}else n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}getMaxZ(){let e=Number.NEGATIVE_INFINITY;return this.getPointsData().forEach((t=>{t.z>e&&(e=t.z)})),e}updateByMove(e){const t=this.getPoints();t.push(e),this.showSurface(t),this.updateMatrixWorld()}showSurface(e){if(!e||e.length<2)return;const t=2===e.length?e:[...e,e[0]];this.planeEdge?(e=[...e,e[0]],this.planeEdge.geometry.updateGeometry({points:e})):(this.planeEdge=r.GroundPrimitiveManager.getInstance().createGroundCurve({helper:this.helper,control:this,points:t,name:"EditingSurfacePlaneEdge",color:new Glodon.Web.Graphics.Color("#FFF227",1),width:1.5,style:"Continuous",type:"polyline"}),this.planeEdge.onAdded(),this._config.layerInfo&&(this.planeEdge.setClampMode(this._config.layerInfo.clampMode),2===this._config.layerInfo.clampMode&&this.planeEdge.setVisibleModelIdMap([this._config.layerInfo.modelId]))),e.length<3||(this.surface?this.surface.geometry.updateGeometry({points:e}):(this.surface=r.GroundPrimitiveManager.getInstance().createGroundPolygon({helper:this.helper,control:this,name:"EditingSurfacePlane",points:e,color:new Glodon.Web.Graphics.Color("#FFF227",.5)}),this.surface.onAdded(),this._config.layerInfo&&(this.surface.setClampMode(this._config.layerInfo.clampMode),2===this._config.layerInfo.clampMode&&this.surface.setVisibleModelIdMap([this._config.layerInfo.modelId]))))}disposeSurface(){this.surface&&(this.surface.onRemoved(),this.surface.dispose(),this.surface=null)}disposePlaneEdge(){this.planeEdge&&(this.planeEdge.onRemoved(),this.planeEdge.dispose(),this.planeEdge=null)}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.disposeSurface(),this.disposePlaneEdge()}reset(){this.clear(),this.finished=!1}addEditingPoint(e){const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e,enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showSurface(this.getPoints()),this.updateMatrixWorld()}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawSurfaceControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="SurfaceControl",this.miniPointNum=this._config.streching&&this._config.hidePlane?2:3,this.updatePointHintText(),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t,event:i})=>{if(this.selectedObject=null,e===this.controlId)if(this.editingPoints.indexOf(t)>=0){if(2===i.button){if(this.miniPointNum>=this.editingPoints.length)return;if(t.isSelected)return;let e=this.editingPoints.indexOf(t);if(!this._config.streching||!this._config.hidePlane){let t=this.editingPoints.map((e=>e.position.clone()));if(t.splice(e,1),this.hasIntersectionPoint(t))return void this.pointTranslateControl.helper.dispatchEvent({type:"WarningHint",control:this.pointTranslateControl,id:this.pointTranslateControl.controlId,text:"不支持出现交叉点位。"})}this.remove(t),this.editingPoints.splice(e,1);const i=this.editingPoints.map((e=>e.position.clone()));this.updatePlane();for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);return this.middlePoints=[],this._config.streching&&this._config.hidePlane?this.addMiddlePoints(this.autoClosed?[...i,i[0]]:i):this.addMiddlePoints([...i,i[0]]),this.updatePointHintText(),this.pointTranslateControl&&this.pointTranslateControl.helper.dispatchEvent({type:"TransformFinished",control:this.pointTranslateControl,id:this.pointTranslateControl.controlId}),void(this.editingLines&&this.editingLines.update([...i,i[0]]))}t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,this.previousSelectedPoint=t.position.clone(),t.cancelHighlight(),t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))}else if(t===this.airPlane&&this.selectedPoint)this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint();else if(this.middlePoints.indexOf(t)>=0){let e=this.middlePoints.indexOf(t);const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,color:this._config.color,name:"EditingPoint",point:t.position});this.add(i),this.editingPoints.splice(e+1,0,i);const n=this.editingPoints.map((e=>e.position.clone()));this.updatePlane();for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this._config.streching&&this._config.hidePlane?this.addMiddlePoints(this.autoClosed?[...n,n[0]]:n):this.addMiddlePoints([...n,n[0]]),i.isSelected=!0,this.selectedPoint=i,this.previousSelectedPoint=this.selectedPoint.position.clone(),i.setHighlight(),this.editPoint(i),this.planeEdge&&(this.movingPointZ=i.position.z),this.editingPoints.forEach((e=>{e!==i&&(e.isSelected=!1,e.cancelHighlight())})),this.updatePointHintText(),this.getViewer().domElement.style.cursor="",this.pointTranslateControl&&this.pointTranslateControl.helper.dispatchEvent({type:"TransformFinished",control:this.pointTranslateControl,id:this.pointTranslateControl.controlId})}})),this.addHelperEvent("EditCompleted",(({id:e})=>{e!=this.controlId||this.horizonPlane||(this.cancelEditPoint(),this.editingPoints.map((e=>this.remove(e))),this.middlePoints.map((e=>this.remove(e))),this.addHorizonPlane(this.getPointsData()))}))}init(e){this.editingPoints=[],this.isEditingFlap=!0,this.maxZ=null==this.maxZ?this._config.maxZ:this.maxZ;const t=e||this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),i=this.getMaxHeightPoints(t),r=(new THREE.Box3).setFromPoints(i);this.points=this._config.hidePlane?t:i,this.lowPoints=JSON.parse(JSON.stringify(t)),this._config.hidePlane||this.addPlane(t),this.addPointTranslateControl(),this._config.streching?this.addSurfaceStrechControl(r,t):(!this._config.hidePlane&&this.addPlaneEdge(t),this._config.showEdge&&this.addEdge(t),this.addPoints(t))}setPoints(e){if(this.pointTranslateControl&&this.pointTranslateControl.destroy(),this.strechControl&&this.strechControl.destroy(),this.plane&&this.plane.onRemoved(),this.planeEdge&&this.planeEdge.onRemoved(),this.facade&&(this.remove(this.facade),this.remove(this.airPlane),this.facade.destroy(),this.airPlane&&this.airPlane.destroy(),this.facade=null,this.airPlane=null,this.strechControl=null),this.selectedPoint&&(this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null),this.removePoints(),this.init(e),this._config.streching){const t=this.getMaxHeightPoints(e);this.points=t,this.strechControl&&requestAnimationFrame((()=>{this.strechControl.visible=!1})),this.addPoints(t)}this.updateMatrixWorld()}addPoints(e){e.forEach(((t,i)=>{if(this._config.hidePlane&&i==e.length-1&&JSON.stringify(t)==JSON.stringify(e[0]))return this.autoClosed=!0,void(this.miniPointNum=3);const n=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,color:this._config.color,name:"EditingPoint",point:t});this.add(n),this.editingPoints.push(n)})),this.points=e,this._config.streching&&this._config.hidePlane?this.addMiddlePoints(this.points):this.addMiddlePoints([...this.points,this.points[0]]),this.updatePointHintText(),this.updateScaleFactor(),this.updateMatrixWorld()}addPlaneEdge(e){this.planeEdge=r.GroundPrimitiveManager.getInstance().createGroundCurve({helper:this.helper,control:this,name:"EditingSurfacePlaneEdge",points:[...e,e[0]],color:new Glodon.Web.Graphics.Color("#FFF227",1),width:1.5,style:"Continuous",type:"polyline"}),this.planeEdge.onAdded(),this._config.layerInfo&&(this.planeEdge.setClampMode(this._config.layerInfo.clampMode),2===this._config.layerInfo.clampMode&&this.planeEdge.setVisibleModelIdMap([this._config.layerInfo.modelId]))}addEdge(e){this.editingLines||(this.editingLines=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"Line",points:[...e,e[0]],color:this._config.color,enableAnimation:!1}),this.add(this.editingLines)),this.updateMatrixWorld()}addPlane(e){this.plane=r.GroundPrimitiveManager.getInstance().createGroundPolygon({helper:this.helper,control:this,name:"EditingSurfacePlane",points:e,color:new Glodon.Web.Graphics.Color("#FFF227",.5)}),this.plane.onAdded(),this._config.layerInfo&&(this.plane.setClampMode(this._config.layerInfo.clampMode),2===this._config.layerInfo.clampMode&&this.plane.setVisibleModelIdMap([this._config.layerInfo.modelId]))}addHorizonPlane(e){this.horizonPlane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:this._config.color,disableEdge:!0,enableAnimation:!1}),this.add(this.horizonPlane),this.updateMatrixWorld()}removePoints(){this.editingPoints.forEach((e=>this.remove(e))),this.editingPoints=[],this.middlePoints.forEach((e=>this.remove(e))),this.middlePoints=[]}getCenter(e){const t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;return t.getCenter(i)}getGroundPointHeight(e,t){const i=new THREE.Vector3(e,t,1e4),r=new THREE.Vector3(0,0,-1),n=this.helper.viewer.getComponentsByRaycaster(i,r,[]);if(this._config.layerInfo){const e=n.find((e=>!(!this._config.layerInfo.isMap||!e.isMap)||this._config.layerInfo.modelId==e.modelId));return e?[e]:[]}return n}hide(){this.horizonPlane&&this.horizonPlane.hide(),this.editingLines&&this.editingLines.hide(),this.editingPoints&&this.editingPoints.forEach((e=>e.hide())),this.pointTranslateControl&&this.pointTranslateControl.destroy(),this.updateScaleFactor(),this.updateMatrixWorld()}show(){this.horizonPlane&&this.horizonPlane.show(),this.editingLines&&this.editingLines.show(),this.editingPoints&&this.editingPoints.forEach((e=>e.show())),this.updateScaleFactor(),this.updateMatrixWorld()}addPointTranslateControl(){if(this._config.showEdge)return void this.addHelperEvent("TransformChanged",(({id:e,control:t,object:i,clientPosition:r})=>{if(e==this.controlId&&"EditingPoint"==i.name){this.selectedPoint=i;const{x:n,y:a}=this.getViewer().clientToWorld(r);this.selectedPoint.position.set(n,a,this.selectedPoint.position.z),this.selectedPoint.updateMatrixWorld();let s=this.editingPoints.map((e=>e.position.clone()));this.hasIntersectionPoint(s)&&(this.helper.dispatchEvent({type:"TransformFinished",control:t,id:e,text:"不支持出现交叉点位。"}),this.helper.dispatchEvent({type:"WarningHint",control:this,text:"不支持出现交叉点位。",id:this.controlId}),this.selectedPoint.position.set(this.previousSelectedPoint.x,this.previousSelectedPoint.y,this.selectedPoint.position.z),s=this.editingPoints.map((e=>e.position.clone()))),this.editingLines&&this.editingLines.update([...s,s[0]]),this.points=s;for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);this.middlePoints=[],this._config.streching&&this._config.hidePlane?this.addMiddlePoints(this.autoClosed?[...this.points,this.points[0]]:this.points):this.addMiddlePoints([...this.points,this.points[0]]),this.updateScaleFactor(),this.updateMatrixWorld(),this.getViewer().render()}}));this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2});const e=["PlaneX","PlaneY","AxisZ"];this.pointTranslateControl.children.forEach((t=>{e.indexOf(t.name)>=0&&(t.enable(!1),t.visible=!1)})),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.pointTranslateControlId){const{x:e,y:i}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,this.selectedPoint.position.z),this.selectedPoint.updateMatrixWorld();const r=this.editingPoints.map((e=>e.position.clone()));if(this.plane&&this.plane.geometry.updateGeometry({points:r}),this.planeEdge){this.planeEdge.geometry.updateGeometry({points:[...r,r[0]]});const t=this.getGroundPointHeight(e,i);this.movingPointZ=t.length>0?t[0].position.z:0,this.selectedPoint.position.set(e,i,this.movingPointZ)}this.points=r;for(let e=0;e<this.middlePoints.length;e++)this.remove(this.middlePoints[e]);if(this.middlePoints=[],this._config.streching&&this._config.hidePlane?this.addMiddlePoints(this.autoClosed?[...this.points,this.points[0]]:this.points):this.addMiddlePoints([...this.points,this.points[0]]),this._config.hidePlane){const e=JSON.parse(JSON.stringify(r)),t=[];e.forEach((e=>{e.z-=this.maxZ,t.push(e)})),this.lowPoints=this.autoClosed?[...t,t[0]]:t}if(this.airPlane&&this.airPlane.update(r),this.facade&&(this._config.hidePlane?this.facade.update(this.lowPoints,this.maxZ,!1):this.facade.update(r,this.maxZ)),this.strechControl){const e=this.getCenter(r);this.strechControl.setPosition(e)}}if(this.strechControl&&e===this.strechControlId){let{z:e}=t.position.clone();if(this._config.hidePlane){e-=this.getCenter(this._config.points).z}this.setCurrentHeight(e)}this.updateScaleFactor(),this.updateMatrixWorld()})),this.addHelperEvent("TransformFinished",(({id:t,control:i})=>{if(t===this.pointTranslateControlId){if(this.planeEdge){const{x:e,y:t}=i.position.clone().sub(this.position);i.setPosition({x:e,y:t,z:this.movingPointZ})}this.pointTranslateControl.children.forEach((t=>{e.indexOf(t.name)>=0&&(t.enable(!1),t.visible=!1)}))}}))}addMiddlePoints(e){for(let t=0;t<e.length-1;t++){let i={x:(e[t].x+e[t+1].x)/2,y:(e[t].y+e[t+1].y)/2,z:(e[t].z+e[t+1].z)/2};if(!this._config.streching){const e=this.getGroundPointHeight(i.x,i.y);i.z=e.length>0?e[0].position.z:0}this._config.showEdge&&(i.z=this.editingPoints[0].position.z);const n=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,color:this._config.color,name:"EditingPoint",isMiddlePoint:!0,showText:!1,point:i});this.add(n),this.middlePoints.push(n)}}updatePlane(){const e=this.editingPoints.map((e=>e.position.clone()));if(this.plane&&this.plane.geometry.updateGeometry({points:e}),this.planeEdge&&this.planeEdge.geometry.updateGeometry({points:[...e,e[0]]}),this.points=e,this._config.hidePlane){const t=JSON.parse(JSON.stringify(e)),i=[];t.forEach((e=>{e.z-=this.maxZ,i.push(e)})),this.lowPoints=this.autoClosed?[...i,i[0]]:i}if(this.airPlane&&this.airPlane.update(e),this.facade&&(this._config.hidePlane?this.facade.update(this.lowPoints,this.maxZ,!1):this.facade.update(e,this.maxZ)),this.strechControl){const t=this.getCenter(e);this.strechControl.setPosition(t)}}getCurrentHeight(){return this.maxZ}setCurrentHeight(e){this.maxZ=e;let t=[];if(this.editingPoints&&this.editingPoints.length>2?this.editingPoints.map((e=>{t.push(e.position.clone())})):t=this.points,t.forEach((t=>{t.z=e})),this.airPlane&&this.airPlane.update(t),this.facade&&(this._config.hidePlane?this.facade.update(this.lowPoints,e,!1):this.facade.update(t,e)),this.editingPoints&&this.editingPoints.forEach((t=>{t.position.z=e})),this.strechControl){const t=this.strechControl.getPosition();t.z=e,this.strechControl.setPosition(t)}}getMaxHeightPoints(e){const t=JSON.parse(JSON.stringify(e));return t.forEach((e=>{e.z=this._config.hidePlane?e.z+this.maxZ:this.maxZ})),t}addSurfaceStrechControl(e,t){const i=this.getMaxHeightPoints(t);this.facade=new r.Interaction.Item.Facade({helper:this.helper,control:this,name:"EditingPlane",points:t,zPoints:i,color:"#FFF227",hideLastFacade:this._config.hidePlane,layerInfo:this._config.layerInfo}),this.add(this.facade),this._config.hidePlane||(this.airPlane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:i,color:"#FFF227",edgeColor:"#FFF227",notHittest:!0}),this.airPlane.enable(!0),this.add(this.airPlane)),this.strechControlId=`${this.controlId}_StrechTranslate`;const n=this.getCenter(t);n.z=this._config.hidePlane?n.z+this.maxZ:this.maxZ,this.strechControl=this.helper.addControl(this.strechControlId,"StrechControl",{position:n,hitTestPriority:2})}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.middlePoints.forEach((e=>e.updateScaleFactor(t,i)))}editPoint(e){this.strechControl&&(this.strechControl.visible=!1),this._config.showEdge||(this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor()),this.getViewer().render()}cancelEditPoint(){this.pointTranslateControl&&(this.pointTranslateControl.visible=!1);const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.strechControl&&(this.strechControl.visible=!0,this.strechControl.setPosition(i),this.strechControl.updateScaleFactor()),this.getViewer().render()}toggleEditingMode(e){if(this.isEditingFlap=e,e)this.pointTranslateControl.visible=!1,this.strechControl.visible=!0,this.removePoints();else if(this.strechControl.visible=!1,this._config.hidePlane){const e=JSON.parse(JSON.stringify(this.lowPoints));this.highPoints=[],e.forEach((e=>{e.z+=this.maxZ,this.highPoints.push(e)})),this.addPoints(this.highPoints)}else this.addPoints(this.points)}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}getInitPointsData(){return this.lowPoints}getGroundPointsData(){const e=[...this.getPointsData()];return e.forEach((e=>{const t=this.getGroundPointHeight(e.x,e.y);e.z=t&&t.length>0?t[0].position.z:0})),e}destroy(){this.pointTranslateControl&&this.pointTranslateControl.destroy(),this.strechControl&&this.strechControl.destroy(),this.plane&&this.plane.onRemoved(),this.planeEdge&&this.planeEdge.onRemoved(),this.horizonPlane&&this.horizonPlane.destroy(),this.editingLines&&this.editingLines.destroy(),this.pointTranslateControlId=null,this.editingLines=null,super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.SurfaceControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this.name="DrawRectangleControl",this.controlId=e.id,this.helper=e.helper,this.color=e.color||"#32D3A6",this.viewer=e.viewer,this.enableAxisGrids=e.enableAxisGrids,this.helperEvents={},this.rectanglePoints=[],this.elevation=e.elevation,this.edgeLines=null,this.vertexPoints=null,this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&this.rectanglePoints.length>0){const e=this.enableAxisGrids&&this.viewer.snap.context.hoverObjectType?this.viewer.snap.context.pickPoint:this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(this.finished)return;const t=this.enableAxisGrids&&this.viewer.snap.context.hoverObjectType?this.viewer.snap.context.pickPoint:this.getPointByRayCaster();t&&(0==this.rectanglePoints.length?(null!=this.elevation&&(t.z=this.isMM()?1e3*this.elevation:this.elevation),this.rectanglePoints.push(t),this.showPoint(t)):t.x!=this.rectanglePoints[0].x&&t.y!=this.rectanglePoints[0].y&&(this.finished=!0,this.vertexPoints.hide(),this.rectanglePoints.push({x:this.rectanglePoints[0].x,y:t.y,z:this.rectanglePoints[0].z}),this.rectanglePoints.push({x:t.x,y:t.y,z:this.rectanglePoints[0].z}),this.rectanglePoints.push({x:this.rectanglePoints[0].x,y:this.rectanglePoints[0].y,z:this.rectanglePoints[0].z}),this.rectanglePoints.push({x:t.x,y:this.rectanglePoints[0].y,z:this.rectanglePoints[0].z}),this.rectanglePoints.push({x:t.x,y:t.y,z:this.rectanglePoints[0].z}),this.showRectangle(this.rectanglePoints),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})))})),this.addPlane()}isMM(){return"bmd"==this.viewer._manifest.Metadata.Content.Type&&"Millimeter"==this.viewer.getGlobalUnit()}addPlane(){const e=this.viewer.getViewer().getBoundingBoxWorld(),t=this.viewer.getViewer().getModelManager().getMatrixWorldGlobal(),i=e.applyMatrix4(t),r=i.max,n=i.min,a=this.isMM()?5e3:5,s=new THREE.PlaneBufferGeometry((r.x-n.x)*a,(r.y-n.y)*a);s.translate(0,0,this.isMM()?-5e4:-50),this.plane=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:2395940,alphaTest:0,visible:!1})),this.add(this.plane),this.updateMatrixWorld()}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}updateByMove(e){if(e.x!=this.rectanglePoints[0].x&&e.y!=this.rectanglePoints[0].y){const t=[{x:this.rectanglePoints[0].x,y:this.rectanglePoints[0].y,z:this.rectanglePoints[0].z},{x:this.rectanglePoints[0].x,y:e.y,z:this.rectanglePoints[0].z},{x:e.x,y:e.y,z:this.rectanglePoints[0].z},{x:e.x,y:this.rectanglePoints[0].y,z:this.rectanglePoints[0].z},{x:this.rectanglePoints[0].x,y:this.rectanglePoints[0].y,z:this.rectanglePoints[0].z}];this.showEdgeLines(t)}else this.rectangle&&this.rectangle.hide()}showPoint(e){this.vertexPoints=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"VertexPoint",point:e,color:this.color,enableAnimation:!1}),this.add(this.vertexPoints),this.updateMatrixWorld()}showEdgeLines(e){this.edgeLines?this.edgeLines.update(e):(this.edgeLines=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"EdgeLine",points:e,color:this.color}),this.add(this.edgeLines)),this.updateMatrixWorld()}showRectangle(e){!e||e.length<6||(this.rectangle?(this.rectangle.updateRectangle(e,this.color),this.rectangle.show()):(this.rectangle=new r.Interaction.Item.Rectangle({helper:this.helper,control:this,name:"Rectangle",points:e,color:this.color}),this.add(this.rectangle)),this.updateMatrixWorld())}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length){const t=e.intersectObject(this.plane);return t&&t.length>0?this.viewer.getViewer().drawingToWorld(t[0].point):null}const n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}getPoints(){return this.rectanglePoints}hide(){this.edgeLines&&this.edgeLines.hide(),this.rectangle&&this.rectangle.hide()}show(){this.edgeLines&&this.edgeLines.show(),this.rectangle&&this.rectangle.show()}clear(){this.rectanglePoints=[],this.finished=!1}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.vertexPoints&&this.vertexPoints.updateScaleFactor(t,i)}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawRectangleControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="DrawPolyLineControl",this.controlId=e.id,this.helper=e.helper,this.color=e.color||"#32D3A6",this.viewer=e.viewer,this.enableAxisGrids=e.enableAxisGrids,this.helperEvents={},this.polygonPoints=[],this.polyLinePoints=[],this.displayedPoints=[],this.elevation=e.elevation,this.tmpLine=null,this.edgeLines=[],this.vertexPoints=null,this.plane=null,this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&this.polyLinePoints.length>0){const e=this.enableAxisGrids&&this.viewer.snap.context.hoverObjectType?this.viewer.snap.context.pickPoint:this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(this.finished)return;if(this.tmpLine&&(this.tmpLine.hide(),this.tmpLine=null),2==e.button){if(this.hasIntersectionPoint(this.polyLinePoints))return this.polyLinePoints.pop(),void this.helper.dispatchEvent({type:"WarningHint",text:"不支持出现交叉点位。",points:this.polyLinePoints,id:this.controlId});let e=null;return this.polyLinePoints[0].x==this.polyLinePoints[this.polyLinePoints.length-1].x&&this.polyLinePoints[0].y==this.polyLinePoints[this.polyLinePoints.length-1].y||(e=this.showLine([this.polyLinePoints[this.polyLinePoints.length-1],this.polyLinePoints[0]])),this.polyLinePoints[0].x==this.polyLinePoints[this.polyLinePoints.length-1].x&&this.polyLinePoints[0].y==this.polyLinePoints[this.polyLinePoints.length-1].y&&this.polyLinePoints.length>2&&(e=this.showLine([this.polyLinePoints[this.polyLinePoints.length-1],this.polyLinePoints[this.polyLinePoints.length-2]])),this.edgeLines.push(e),this.finished=!0,this.displayedPoints.map((e=>e.visible=!1)),this.showPolygon(this.polyLinePoints),void this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})}const t=this.enableAxisGrids&&this.viewer.snap.context.hoverObjectType?this.viewer.snap.context.pickPoint:this.getPointByRayCaster();if(t){if(this.detectSequenceLineCrossed([...this.polyLinePoints,t]))return void this.helper.dispatchEvent({type:"WarningHint",text:"不支持出现交叉点位。",points:this.polyLinePoints,id:this.controlId});if(null!=this.elevation&&(t.z=this.isMM()?1e3*this.elevation:this.elevation),t.z=this.polyLinePoints[0]?this.polyLinePoints[0].z:t.z,this.showPoint(t),this.polyLinePoints.length>0){const e=this.showLine([this.polyLinePoints[this.polyLinePoints.length-1],t]);this.edgeLines.push(e)}this.polyLinePoints.push(t)}})),this.addPlane()}isMM(){return"bmd"==this.viewer._manifest.Metadata.Content.Type&&"Millimeter"==this.viewer.getGlobalUnit()}addPlane(){const e=this.viewer.getViewer().getBoundingBoxWorld(),t=this.viewer.getViewer().getModelManager().getMatrixWorldGlobal(),i=e.applyMatrix4(t),r=i.max,n=i.min,a=this.isMM()?5e3:5,s=new THREE.PlaneBufferGeometry((r.x-n.x)*a,(r.y-n.y)*a);s.translate(0,0,this.isMM()?-5e4:-50),this.plane=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:2395940,alphaTest:0,visible:!1})),this.add(this.plane),this.updateMatrixWorld()}updateByMove(e){this.polyLinePoints.length>0&&(this.tmpLine?(e.z=this.polyLinePoints[this.polyLinePoints.length-1].z,this.tmpLine.update([this.polyLinePoints[this.polyLinePoints.length-1],e])):(e.z=this.polyLinePoints[0].z,this.tmpLine=this.showLine([this.polyLinePoints[this.polyLinePoints.length-1],e])))}showPoint(e){const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"VertexPoint",point:e,color:this.color,enableAnimation:!1,showText:!1});this.add(t),this.updateMatrixWorld(),this.displayedPoints.push(t)}showLine(e){const t=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"Line",points:e,color:this.color,enableAnimation:!1,showText:!1});return this.add(t),this.updateMatrixWorld(),t}showPolygon(e){this.plane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:this.color,disableEdge:!0,enableAnimation:!1}),this.add(this.plane),this.updateMatrixWorld()}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length){const t=e.intersectObject(this.plane);return t&&t.length>0?this.viewer.getViewer().drawingToWorld(t[0].point):null}const n=r[0].position;return new THREE.Vector3(n.x,n.y,n.z)}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.displayedPoints.map((e=>e.updateScaleFactor(t,i)))}getPoints(){return this.polyLinePoints}hide(){this.edgeLines&&this.edgeLines.length>0&&this.edgeLines.map((e=>e.hide())),this.plane&&this.plane.hide()}show(){this.edgeLines&&this.edgeLines.length>0&&this.edgeLines.map((e=>e.show())),this.plane&&this.plane.show()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawPolyLineControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.name=e.name,this.helper=e.helper,this.control=e.control,this.enableAnimation=!1!==e.enableAnimation,this.isHighlightMode=!1,this.isGrayMode=!1,this.isEnabled=!0,this.animationStatusMap={Default:"Default",HighlightPlaying:"HighlightPlaying",HighlightFinished:"HighlightFinished",CancelHighlightPlaying:"CancelHighlightPlaying",CancelHighlightFinished:"CancelHighlightFinished",GrayPlaying:"GrayPlaying",GrayFinished:"GrayFinished",CancelGrayPlaying:"CancelGrayPlaying",CancelGrayFinished:"CancelGrayFinished"},this.animationStatus=this.animationStatusMap.Default,this.animationTimeScale=4,this.highlightActionList=[],this.grayActionList=[],this.init&&this.init()}init(){this.enableAnimation&&(this.initHighlightAnimation(),this.initGrayAnimation())}getConfig(){return this._config}getViewer(){return this.helper.viewer}initHighlightAnimation(){}setHighlight(){this.isEnabled&&this.enableAnimation&&(this.isHighlightMode||(this.isHighlightMode=!0,this.isGrayMode=!1,this.grayActionList.forEach((e=>e.stop())),this.highlightActionList.forEach((e=>{e.timeScale=this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.HighlightPlaying))}cancelHighlight(){this.isEnabled&&this.enableAnimation&&this.isHighlightMode&&(this.isHighlightMode=!1,this.isGrayMode=!1,this.grayActionList.forEach((e=>e.stop())),this.highlightActionList.forEach((e=>{e.timeScale=-this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.CancelHighlightPlaying)}initGrayAnimation(){}setGray(){this.isEnabled&&this.enableAnimation&&(this.isGrayMode||(this.isGrayMode=!0,this.isHighlightMode=!1,this.highlightActionList.forEach((e=>e.stop())),this.grayActionList.forEach((e=>{e.timeScale=this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.GrayPlaying))}cancelGray(){this.isEnabled&&this.enableAnimation&&this.isGrayMode&&(this.isGrayMode=!1,this.isHighlightMode=!1,this.highlightActionList.forEach((e=>e.stop())),this.grayActionList.forEach((e=>{e.timeScale=-this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.CancelGrayPlaying)}transform(e){}transformFinished(){}hitTest(){return!1}enable(e){e?(this.isEnabled=e,this.cancelGray()):(this.setGray(),this.isEnabled=e)}getLinearColor(e){const t=new THREE.Color(e),i=e=>{let t;return t=e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4),t},r=i(t.r),n=i(t.g),a=i(t.b);return new THREE.Color(r,n,a)}destroy(){this.children.forEach((e=>{e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose()})),this.control.remove(this)}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.BaseItem=e})(),(()=>{class e{constructor({helper:e,object:t,position:i,direction:r,color:n}){this.helper=e,this.object=t,this.position=i,this.direction=r,this.color=n,this.object.control.addHelperEvent("CameraChanged",(e=>this.updateDirection(e.cameraDirection))),this.init(),this.updateDirection()}init(){const e=new THREE.BufferGeometry,t=new Float32Array([-7,0,0,7,0,0,0,0,14]);e.setAttribute("position",new THREE.BufferAttribute(t,3));const i=new THREE.MeshBasicMaterial({color:this.color,depthTest:!1,side:2,transparent:!0,opacity:1}),n=new THREE.Mesh(e,i),a=new THREE.Vector3(...Object.values(this.direction)).normalize(),s=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),a);this.directionQuaternion=s,n.applyQuaternion(s);const o=new THREE.Vector3(...Object.values(this.position));n.position.set(o.x,o.y,o.z),n.name="arrowHead",n.renderOrder=r.EnumRenderOrder.Effect+1e3,this.object.add(n),n.updateMatrixWorld(!0),this.mesh=n}updateDirection(){const e=this.helper.viewer.camera.target.clone().sub(this.helper.viewer.camera.position).normalize().clone().applyMatrix4(this.helper.invertMatrix).normalize(),t=this.object.control.quaternion.clone().invert(),i=new THREE.Vector3(0,1,0).applyQuaternion(this.directionQuaternion),r=new THREE.Plane(new THREE.Vector3(...Object.values(this.direction)).normalize()),n=new THREE.Vector3;r.projectPoint(e.clone().applyQuaternion(t),n);const a=(new THREE.Quaternion).setFromUnitVectors(i,n.normalize()).multiply(this.directionQuaternion.clone());this.mesh.quaternion.set(a.x,a.y,a.z,a.w),this.mesh.updateMatrixWorld(!0)}}class t extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{helper:t,startPoint:i,endPoint:r,color:n}=this.getConfig(),a=this.getLinearColor(n),s=[...Object.values(i),...Object.values(r)];this.addLine(s,{color:a});const o=this.vectorStart=new THREE.Vector3(...Object.values(i)),l=this.vectorEnd=new THREE.Vector3(...Object.values(r)),d=this.direction=l.clone().sub(o);if(this.arrowHead=new e({helper:t,object:this,position:r,direction:d,color:a}),this._config.streching){const n=new THREE.Vector3(...Object.values(r)),s=new THREE.Vector3(...Object.values(i)).clone().sub(n);this.arrowTail=new e({helper:t,object:this,position:i,direction:s,color:a})}const h=d.clone().normalize().multiplyScalar(10),c=l.clone().sub(o).add(h).multiplyScalar(.5).add(o);this.rigidBody=this.addRigidBody(c,d.clone().add(h),{color:a}),this.addDashedLine(s,{color:a}),super.init()}addLine(e,t){const i=new THREE.LineGeometry;i.setPositions(e);const n=new THREE.LineMaterial({color:t.color,linewidth:4,dashed:!1,depthTest:!1,transparent:!0});n.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight);const a=this.line=new THREE.Line2(i,n);a.renderOrder=r.EnumRenderOrder.Effect+1e3,a.name="AxisArrowLine",this.add(a)}addDashedLine(e,t){const i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(e,3));const n=new THREE.LineDashedMaterial({depthTest:!1,linewidth:1,scale:1,dashSize:12,gapSize:8,...t}),a=this.dashedLine=new THREE.Line(i,n);a.computeLineDistances(),a.renderOrder=r.EnumRenderOrder.Effect,a.name="AxisArrowDashedLine",a.visible=!1,this.add(a)}showDashedLine(){this.line.visible=!1,this.arrowHead.mesh.visible=!1,this.arrowTail&&(this.arrowTail.mesh.visible=!1),this.dashedLine.visible=!0}hideDashedLine(){this.line.visible=!0,this.arrowHead.mesh.visible=!0,this.arrowTail&&(this.arrowTail.mesh.visible=!0),this.dashedLine.visible=!1}addRigidBody(e,t,i){const n=t.length(),a=new THREE.CylinderGeometry(5,5,n,3),s=r.MaterialUtil.createStandardMaterial(i);var o=new THREE.Mesh(a,s);o.name="RigidBody";const l=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),t.clone().normalize());return o.applyQuaternion(l),o.position.set(e.x,e.y,e.z),o.updateMatrixWorld(),o.visible=!1,this.add(o),o}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.line.material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[4,6]),i=new THREE.AnimationClip("Action",1,[t,e]);this.mixerHighlight=new THREE.AnimationMixer(this.line),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.line});const r=new THREE.VectorKeyframeTrack(".scale",[0,1],[1,1,1,2,2,2]),n=new THREE.AnimationClip("Action",1,[r,e]);this.mixerHighlightForHead=new THREE.AnimationMixer(this.arrowHead.mesh),this.actionHighlightForHead=this.mixerHighlightForHead.clipAction(n),this.actionHighlightForHead.setLoop(THREE.LoopOnce),this.actionHighlightForHead.timeScale=this.animationTimeScale,this.actionHighlightForHead.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlightForHead),this.control.addAnimation({mixer:this.mixerHighlightForHead,action:this.actionHighlightForHead,object:this.arrowHead.mesh}),this.arrowTail&&(this.mixerHighlightForTail=new THREE.AnimationMixer(this.arrowTail.mesh),this.actionHighlightForTail=this.mixerHighlightForTail.clipAction(n),this.actionHighlightForTail.setLoop(THREE.LoopOnce),this.actionHighlightForTail.timeScale=this.animationTimeScale,this.actionHighlightForTail.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlightForTail),this.control.addAnimation({mixer:this.mixerHighlightForTail,action:this.actionHighlightForTail,object:this.arrowTail.mesh})),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.line.material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.line),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.line});const i=new THREE.AnimationClip("Action",1,[e]);this.mixerGrayForHead=new THREE.AnimationMixer(this.arrowHead.mesh),this.actionGrayForHead=this.mixerGrayForHead.clipAction(i),this.actionGrayForHead.setLoop(THREE.LoopOnce),this.actionGrayForHead.timeScale=this.animationTimeScale,this.actionGrayForHead.clampWhenFinished=!0,this.grayActionList.push(this.actionGrayForHead),this.control.addAnimation({mixer:this.mixerGrayForHead,action:this.actionGrayForHead,object:this.arrowHead.mesh}),this.arrowTail&&(this.mixerGrayForTail=new THREE.AnimationMixer(this.arrowTail.mesh),this.actionGrayForTail=this.mixerGrayForTail.clipAction(i),this.actionGrayForTail.setLoop(THREE.LoopOnce),this.actionGrayForTail.timeScale=this.animationTimeScale,this.actionGrayForTail.clampWhenFinished=!0,this.grayActionList.push(this.actionGrayForTail),this.control.addAnimation({mixer:this.mixerGrayForTail,action:this.actionGrayForTail,object:this.arrowTail.mesh})),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.TranslateArrow=class extends t{constructor(e){super(e)}hitTest(e){return!!this.visible&&super.hitTest(e)}transform(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=this.direction.clone().applyQuaternion(this.control.quaternion),n=new THREE.Ray(this.control.position.clone(),r),a=i.clone().cross(i.clone().cross(r)),s=new THREE.Plane(a),o=this.getViewer().drawingToWorld(t.ray.origin.clone()),l=-s.distanceToPoint(o);s.set(a,l),n.intersectsPlane(s)||n.set(n.origin.clone(),r.clone().negate());const d=new THREE.Vector3;n.intersectPlane(s,d),this.mouseDownOffset=this.mouseDownOffset||d.clone().sub(this.control.position);const h=d.clone().sub(this.mouseDownOffset);this.control.position.set(h.x,h.y,h.z),this.control.updateMatrixWorld(),this.getViewer().render()}transformFinished(){this.mouseDownOffset=null}},r.Interaction.Item.ScaleArrow=class extends t{constructor(e){super(e),this.position.set(e.position.x,e.position.y,e.position.z),this.updateMatrixWorld()}updateScaleFactor(e){this.position.set(0,0,0),this.scale.set(e,e,e);const t=this.getConfig().position;this.position.set(t.x,t.y,t.z),this.updateMatrixWorld(!0)}updatePosition(e){this.getConfig().position=e,this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(!0)}hitTest(e){return!!this.visible&&super.hitTest(e)}getCanvasPosition(e){let t=this.helper.viewer.domElement.getBoundingClientRect(),i=new THREE.Vector3(e.x,e.y);return i.x-=t.left,i.y-=t.top,i}transform(e){if(this.mouseDownPoint){let t=this.getCanvasPosition(new THREE.Vector2(e.x,e.y)).clone().sub(this.mouseDownPoint);if(0==t.length())return;let i=this.getConfig().startPoint,r=this.getConfig().endPoint,n=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(this.matrix.clone()).applyMatrix4(this.control.matrix),a=new THREE.Vector3(r.x,r.y,r.z).applyMatrix4(this.matrix.clone()).applyMatrix4(this.control.matrix);n=this.helper.viewer.worldToCanvas(n),a=this.helper.viewer.worldToCanvas(a),n=new THREE.Vector3(n.x,n.y,0),a=new THREE.Vector3(a.x,a.y,0);let s=a.clone().sub(n).normalize(),o=t.clone().projectOnVector(s),l=1+(t.clone().angleTo(s)<=Math.PI/2?1:-1)*(o.length()/this.helper.viewer.domElement.clientHeight);this.control.scaleInfo={type:this.name,scaleFactor:l}}else{let t=this.getCanvasPosition(new THREE.Vector2(e.x,e.y));this.mouseDownPoint=t}}transformFinished(){this.mouseDownPoint=void 0}}})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{centerPoint:e,normal:t,color:i}=this.getConfig();this.addPlane(e,t,this.getLinearColor(i)),super.init()}addPlane(e,t,i){const n=new THREE.BufferGeometry,a=new Float32Array([-10,0,-10,10,0,-10,10,0,10,10,0,10,-10,0,10,-10,0,-10]);n.setAttribute("position",new THREE.BufferAttribute(a,3));const s=new THREE.MeshBasicMaterial({color:i,depthTest:!1,side:2,transparent:!0}),o=new THREE.Mesh(n,s);this.normal=new THREE.Vector3(...Object.values(t)).normalize();const l=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),this.normal);o.applyQuaternion(l);const d=new THREE.Vector3(...Object.values(e));o.position.set(d.x,d.y,d.z),o.name="plane",o.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(o),o.updateMatrixWorld(!0),this.mesh=o}hitTest(e){if(!this.visible)return!1;const t=[];return this.mesh.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.children[0]),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.children[0]}),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}transform(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=this.normal.clone().applyQuaternion(this.control.quaternion),n=new THREE.Plane(r),a=this.getViewer().drawingToWorld(t.ray.origin.clone()),s=-n.distanceToPoint(this.control.position);n.set(r,s);const o=new THREE.Ray(a,i),l=new THREE.Vector3;o.intersectPlane(n,l),this.mouseDownOffset=this.mouseDownOffset||l.clone().sub(this.control.position);const d=l.clone().sub(this.mouseDownOffset);this.control.position.set(d.x,d.y,d.z),this.control.updateMatrixWorld(),this.getViewer().render()}transformFinished(){this.mouseDownOffset=null}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.TranslatePlane=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.enableAnimation=!1}init(){const{boundingBoxData:e}=this.getConfig();this.addBoundingBoxEdge(e)}getEdgesGeometry(e){const t=e.max.x-e.min.x,i=e.max.y-e.min.y,r=e.max.z-e.min.z,n=new THREE.BoxGeometry(t,i,r);return new THREE.EdgesGeometry(n)}addBoundingBoxEdge(e){const t=this.getEdgesGeometry(e),i=new THREE.LineSegments(t,new THREE.LineBasicMaterial({color:this.getLinearColor(1170103)}));this.add(i);const r=t.clone(),n=new THREE.LineSegments(r,new THREE.LineBasicMaterial({color:this.getLinearColor(9674396),depthFunc:THREE.GreaterDepth}));this.add(n)}update(e){for(;this.children.length>0;){const e=this.children[0];this.remove(e),e.geometry.dispose(),e.material.dispose()}this.addBoundingBoxEdge(e),this.updateMatrixWorld()}hitTest(e){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.BoundingBox=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{length:e,color:t}=this.getConfig();this.addCube(e,this.getLinearColor(t)),super.init()}addCube(e,t){const i=new THREE.BoxGeometry(e,e,e),n=new THREE.MeshBasicMaterial({color:t,depthTest:!1,transparent:!0}),a=new THREE.Mesh(i,n);a.name="cube",a.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(a),this.cube=a;const s=new THREE.EdgesGeometry(i),o=new THREE.LineSegments(s,new THREE.LineBasicMaterial({color:3355443,transparent:!0,opacity:.3}));o.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(o)}hitTest(e){const t=[];return this.cube.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.children[0]),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.children[0]}),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}updateScaleFactor(e){this.scale.set(e,e,e),this.updateMatrixWorld()}transform(e){if(void 0===this.mouseDownX)this.mouseDownX=e.x;else{const t=1+(e.x-this.mouseDownX)/this.helper.viewer.domElement.clientWidth;this.control.scaleInfo={type:"ScaleCube",scaleFactor:t}}}transformFinished(){this.mouseDownX=void 0}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.ScaleCube=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t}=this.getConfig(),i=[];e.forEach((e=>i.push(e.x,e.y,e.z))),this.addLine(i,{color:this.getLinearColor(t)}),super.init()}addLine(e,t){t||(t={});const i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.lineMaterial||(!0===this.getConfig().dashed?this.lineMaterial=new THREE.LineDashedMaterial({depthTest:!1,linewidth:1,scale:1,dashSize:12,gapSize:8,...t}):this.lineMaterial=new THREE.LineBasicMaterial({depthTest:!1,linewidth:1,...t}));const n=new THREE.Line(i,this.lineMaterial);n.computeLineDistances(),n.renderOrder=r.EnumRenderOrder.Effect+100,this.add(n),this.line=n}update(e){this.remove(this.line),this.line.geometry.dispose();const t=[];e.forEach((e=>t.push(e.x,e.y,e.z))),this.addLine(t),this.updateMatrixWorld()}updateScaleFactor(e){!0===this.getConfig().dashed&&(this.line.material.dashSize=12*e,this.line.material.gapSize=8*e,this.line.computeLineDistances())}hide(){this.line.visible=!1}show(){this.line.visible=!0}hitTest(e){return!1}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Line=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t}=this.getConfig();this.addCurveLine(e,{color:this.getLinearColor(t)}),super.init()}addCurveLine(e,t){const i=new THREE.CatmullRomCurve3(e),r=this.curvePoints=i.getPoints(20*e.length),n=[];r.forEach((e=>n.push(e.x||0,e.y||0,e.z||0)));const a=new THREE.LineGeometry;a.setPositions(n),this.curveLineMaterial||(this.curveLineMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...t}),this.curveLineMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const s=this.curveLine=new THREE.Line2(a,this.curveLineMaterial);this.add(s),this.addRigidBody(i)}addRigidBody(e,t){const i=new THREE.TubeGeometry(e,void 0,t||4);this.rigidBodyMaterial||(this.rigidBodyMaterial=new THREE.MeshBasicMaterial);const r=this.rigidBody=new THREE.Mesh(i,this.rigidBodyMaterial);r.visible=!1,this.add(r)}update(e){this.remove(this.curveLine),this.curveLine.geometry.dispose(),this.remove(this.rigidBody),this.rigidBody.geometry.dispose(),this.addCurveLine(e),this.updateMatrixWorld(),this.getConfig().points=e}updateScaleFactor(e,t){if(this.rigidBody){const i=this.control.position.clone().add(this.control.center).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,n=this.getViewer().domElement.offsetHeight,a=this.factor=4*r/n;this.remove(this.rigidBody),this.rigidBody.geometry.dispose();const s=new THREE.CatmullRomCurve3(this.getConfig().points);this.addRigidBody(s,a)}this.updateMatrixWorld()}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}setGray(){super.setGray()}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Curve=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,zPoints:t,color:i,hideLastFacade:r}=this.getConfig();this.color=i,this.trangles=[],this.edges=[],this.hideLastFacade=r,this.addFacade(e,t),super.init()}drawTrangle(e,t,i,n){const a=new THREE.BufferGeometry,s=new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z,i.x,i.y,i.z]);a.setAttribute("position",new THREE.BufferAttribute(s,3)),a.computeVertexNormals();const o=new THREE.MeshBasicMaterial({color:this.getLinearColor(this.color),depthTest:!1,depthWrite:!0,side:2,transparent:!0,opacity:.5}),l=new THREE.Mesh(a,o);l.renderOrder=r.EnumRenderOrder.Effect,l.position.set(0,0,0),l.name="drawTrangle",this.trangles.push(l),this.add(l),this.updateMatrixWorld()}addEgeLines(e,t){e.forEach(((e,i)=>{const n=[e,t[i]],a=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"EditingFacadeEdge",points:n,color:this.color});this.edges.push(a),this.add(a),this.updateMatrixWorld()}))}addFacade(e,t){for(let i=0;i<e.length;i++)i<e.length-1?(this.drawTrangle(t[i],e[i],e[i+1]),this.drawTrangle(e[i+1],t[i+1],t[i])):this.hideLastFacade||(this.drawTrangle(t[i],e[i],e[0]),this.drawTrangle(e[0],t[0],t[i]));this.addEgeLines(e,t,this.color)}update(e,t,i=!0){let r;this.trangles.length>0&&(this.trangles.forEach((e=>{this.remove(e),e.geometry.dispose()})),this.trangles=[],this.edges.forEach((e=>{this.remove(e)})),this.edges=[]),i?(r=JSON.parse(JSON.stringify(e)),r.forEach((e=>{const t=this.getGroundPointHeight(e.x,e.y);e.z=t.length>0?t[0].position.z:0})),this.addFacade(r,e),this.addEgeLines(r,e)):(r=JSON.parse(JSON.stringify(e)),r.forEach((e=>{e.z=t+e.z}))),this.addFacade(r,e),this.addEgeLines(r,e)}getGroundPointHeight(e,t){const i=new THREE.Vector3(e,t,1e4),r=new THREE.Vector3(0,0,-1),n=this.helper.viewer.getComponentsByRaycaster(i,r,[]);if(this._config.layerInfo){const e=n.find((e=>!(!this._config.layerInfo.isMap||!e.isMap)||this._config.layerInfo.modelId==e.modelId));return e?[e]:[]}return n}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Facade=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t,edgeColor:i,notHittest:r}=this.getConfig();this.addPlane(e,{color:this.getLinearColor(t)},{color:this.getLinearColor(i)}),this.notHittest=r,super.init()}addPlane(e,t,i){const n=e.map((e=>new THREE.Vector2(e.x,e.y))),a=e[0].z,s=new THREE.Shape(n),o=new THREE.ShapeGeometry(s);this.planeMeterial||(this.planeMeterial=new THREE.MeshBasicMaterial({depthTest:!1,side:2,transparent:!0,opacity:.3,...t}));const l=this.plane=new THREE.Mesh(o,this.planeMeterial);l.renderOrder=r.EnumRenderOrder.Effect,l.position.set(0,0,a),this.add(l),!this._config.disableEdge&&this.addPlaneEdge(e,i),this.updateMatrixWorld()}addPlaneEdge(e,t){const i=[],n=e[0].z;e.forEach((e=>i.push(e.x,e.y,n))),i.push(e[0].x,e[0].y,n);const a=new THREE.LineGeometry;a.setPositions(i),this.lineMaterial||(this.lineMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...t}),this.lineMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const s=this.edgeLine=new THREE.Line2(a,this.lineMaterial);s.renderOrder=r.EnumRenderOrder.Effect+100,this.add(s)}hide(){this.plane&&(this.plane.visible=!1),this.edgeLine&&(this.edgeLine.visible=!1)}show(){this.plane&&(this.plane.visible=!0),this.edgeLine&&(this.edgeLine.visible=!0)}update(e){this.plane&&(this.remove(this.plane),this.plane.geometry.dispose()),this.edgeLine&&(this.remove(this.edgeLine),this.edgeLine.geometry.dispose()),this.addPlane(e)}hitTest(e){if(this.notHittest)return;const t=[];return this.plane.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeLine.material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.edgeLine),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.edgeLine}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Plane=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.isSelected=!1,this.text="点击可编辑",this.midlePointHightlightCursor="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAALxSURBVHgBpZXPbxJBFMeHrcBuhVIS21RkQ0Ep9NLaH8aTgt7UcNGD3o30YuJfYJr+GTTVU2/2UkmaeOihxkNTW6OHprSIRokFE/ub8hvW71t2yYILtPEl38zszO5n3nszb9bAzmccZFD6kkZ1M7CzG8GEiYmJjDqwu7t7MZVK5bRQrgneboEuQRDs1FlfX5cHALPRONMJgcfK30dHR58Fg8ELOp7RmDmXy9ma5npoXJmXnVE7NOESRTGSTCYJMAeV9cLUGsZjan9jY8OCJiuHQjBMStvb21IgEDgaHh6+rYwbIQfNtTOaRzqukIOqh3IehoaG2OzsbM/U1NRbjuMebG5uflJCYpOTk3XPKIfaZzKkg1ciksN2a73AB7TqoeKpCAWgJ1BYfY9aPD+FHkNBSPaQa5EbNj09bevu7p53u92XMfTNZDJ9Qfu16dUE9BmKQ4dQRd3Rf45LKBSiRpyZmVkwGo2hnZ2dH4ByTeGnoCRUYJpDTlBPq8RHIhEK76fP5xuhzYPuQo+gO2qYzc60BWqhHo/nBs/zBL0GOSGLXnQdgVrowMDAIN7nle84PRjDqhLTMZSW3KJm5SMFidVqNZpOp2/SBrCmi6EOzOfzDW6fnJywlZUV+bwtLi7my+XyLziZgY4A/Kh4mG8JNJvNDTAcbJbJZOjosGg0Km1tbb2kqUqlksFO/7bb7ZWDgwOmZwSUCoVCA2xtbe0dSokSfxVHRMhms75YLPbaYrHkACzs7+9TzVb1gF2KbA6H48Xe3h5bXl7+kEgk5qxWq4APR8LhMFtaWhKQllfHx8dHKLF8K5gWKpceSu09+veg66iS0Pj4+CkgEqCS3+9/qHO16cLkKwr2Jx6Pz7NaOaVLpVKxt7fXjY3wF4tFhmvNvrq6uoC5UicoAa2QCK8cBFdy2+9yuZ6PjY2der3eN319ffdZ7d48kxHUxDQ3r9PpFLD7XlYrsVs4q4Mwnv2H0SJUWv3QJVqA6VTGec3AGn+dHe0vMOiN7BipW4IAAAAASUVORK5CYII="}init(){const{point:e,showText:t,isMiddlePoint:i}=this.getConfig();this.position.set(e.x,e.y,e.z),this.showText=0!=t||t,this.isMiddlePoint=i,this.updateMatrixWorld(),this.addPoint(),this.addRigidBody(),super.init()}addPoint(){this.updateScaleFactor(),this.defaultTexture=this.getTexture("#"+this.getLinearColor(this._config&&this._config.color?this._config.color:"#FFD000").getHexString()),this.highlightTexture=this.getTexture("#"+this.getLinearColor("#32D3A6").getHexString()),this.isMiddlePoint&&(this.defaultTexture=this.getTexture("#"+this.getLinearColor("#FFD000").getHexString(),.45),this.highlightTexture=this.getTexture("#"+this.getLinearColor("#FFD000").getHexString()));const e=new THREE.SpriteMaterial({map:this.defaultTexture,depthTest:!1}),t=this.point=new THREE.Sprite(e);t.renderOrder=r.EnumRenderOrder.Effect+200,this.add(t)}getTexture(e,t){const i=document.createElement("canvas");i.width=16,i.height=16;const r=i.getContext("2d");r.beginPath(),r.arc(8,8,8,0,2*Math.PI),r.fillStyle=e,r.globalAlpha=t||1,r.fill(),r.beginPath(),r.arc(8,8,this.isMiddlePoint?5:4,0,2*Math.PI),r.fillStyle="#FFFFFF",r.globalAlpha=1,r.fill();return new THREE.CanvasTexture(i)}addRigidBody(){const e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial,i=this.rigidBody=new THREE.Mesh(e,t);this.isMiddlePoint&&this.rigidBody.scale.set(2,2,2),i.visible=!1,this.add(i)}updateScaleFactor(e,t){e=e||this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=t||this.getViewer().camera.fov;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,n=this.getViewer().domElement.offsetHeight,a=this.factor=(this.isMiddlePoint?7:10)*r/n;this.scale.set(a,a,a),this.updateMatrixWorld()}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.VectorKeyframeTrack(".scale",[0,1],[1,1,1,1.3,1.3,1.3]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?(this.point.material.map=this.defaultTexture,this.animationStatus=this.animationStatusMap.Default):this.animationStatus=this.animationStatusMap.HighlightFinished}))}hide(){this.point.visible=!1,this.hintText&&(this.hintText.visible=!1)}show(){this.point.visible=!0,this.hintText&&(this.hintText.visible=!0)}setHighlight(){this.isMiddlePoint&&(this.getViewer().domElement.style.cursor=`url(${this.midlePointHightlightCursor}),auto`),this.point.material.map=this.highlightTexture,this.hintText||!this.showText||this.isSelected||(this.hintText=new r.Interaction.Item.HintText({text:this.text,position:{x:0,y:0,z:0}}),this.add(this.hintText),this.updateMatrixWorld()),super.setHighlight()}cancelHighlight(){this.isMiddlePoint&&(this.getViewer().domElement.style.cursor=""),this.hintText&&(this.hintText.cancelHighlight(),this.remove(this.hintText),this.hintText=null),this.isSelected||super.cancelHighlight()}setHintText(e){this.text=e}setGray(){}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.EditingPoint=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){this.text=this.getConfig().text;const e=this.getConfig().position;this.setHighlight(e),super.init()}setHighlight(e){if(this.map)return;const t=e,i=this.text,n=document.createElement("canvas"),a=n.getContext("2d"),s='64px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';a.font=s;const o=a.measureText(this.text).width+75,l=2*o+20,d=2*o+20;n.width=l,n.height=d,a.font=s;const h=l/2,c=d/2+30,u=l,p=d/2+190;a.fillStyle="#000000",a.globalAlpha=.8,a.fillRect(l/2+4,d/2+34,o,152),a.fillStyle="#FFFFFF",a.globalAlpha=1,a.fillText(i,l/2+40,l/2+135),a.strokeStyle="#F2F2F2",a.lineWidth=4,a.beginPath(),a.moveTo(h,c),a.lineTo(h,p-4),a.arcTo(h,p,h+4,p,8),a.lineTo(u-4,p),a.arcTo(u,p,u,p-4,8),a.lineTo(u,c+4),a.arcTo(u,c,u-4,c,8),a.lineTo(h+4,c),a.arcTo(h,c,h,c+4,8),a.stroke();const m=new THREE.CanvasTexture(n);this.map=m;const f=new THREE.SpriteMaterial({map:m,depthTest:!1}),g=new THREE.Sprite(f);g.position.set(t.x,t.y,t.z);let v=l/1024*20;g.scale.set(v,v,v),g.renderOrder=r.EnumRenderOrder.Effect+300,this.add(g),this.updateMatrixWorld()}cancelHighlight(){this.map&&(this.map=null)}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.HintText=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{center:e,radius:t,thetaStart:i,thetaLength:r,color:n,opacity:a,edgeColor:s}=this.getConfig();this.addCircle(e,t,i,r,{color:this.getLinearColor(n),opacity:a||.3},{color:this.getLinearColor(s)}),super.init()}addCircle(e,t,i,n,a,s){i=i||0,n=n||2*Math.PI,this.center=e,this.radius=t,this.thetaStart=i,this.thetaLength=n;const o=new THREE.CircleGeometry(t,128,i,n);this.circleMaterial||(this.circleMaterial=new THREE.MeshBasicMaterial({depthTest:!1,transparent:!0,...a}));const l=this.circle=new THREE.Mesh(o,this.circleMaterial);l.renderOrder=r.EnumRenderOrder.Effect+100,l.position.set(e.x,e.y,e.z),this.add(l),this.addCircleEdge(e,t,i,n,s),this.updateMatrixWorld()}addCircleEdge(e,t,i,n,a){const s=new THREE.EllipseCurve(0,0,t,t,i,i+n,!1,0).getPoints(128),o=[];s.forEach((e=>o.push(e.x||0,e.y||0,e.z||0)));const l=new THREE.LineGeometry;l.setPositions(o),this.circleEdgeMaterial||(this.circleEdgeMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...a}),this.circleEdgeMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const d=this.edgeCurve=new THREE.Line2(l,this.circleEdgeMaterial);if(d.position.set(e.x,e.y,e.z),d.renderOrder=r.EnumRenderOrder.Effect+100,this.add(d),this.circleEdges=[],this.circleEdges.push(d),n-i!=2*Math.PI){const s=new THREE.BufferGeometry;s.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,t,0,0],3)),this.edgeMaterial||(this.edgeMaterial=new THREE.LineBasicMaterial({depthTest:!1,...a}));const o=new THREE.Line(s,this.edgeMaterial);o.rotateOnAxis(new THREE.Vector3(0,0,1),i),o.position.set(e.x,e.y,e.z),o.renderOrder=r.EnumRenderOrder.Effect+100,this.add(o),this.circleEdges.push(o);const l=new THREE.Line(s,this.edgeMaterial);l.rotateOnAxis(new THREE.Vector3(0,0,1),i+n),l.position.set(e.x,e.y,e.z),l.renderOrder=r.EnumRenderOrder.Effect+100,this.add(l),this.circleEdges.push(l)}if(this.getConfig().hitTestEdge){const i=new THREE.TorusGeometry(t,10,3,16);this.rigidBodyMaterial||(this.rigidBodyMaterial=new THREE.MeshBasicMaterial);const r=this.rigidBody=new THREE.Mesh(i,this.rigidBodyMaterial);r.position.set(e.x,e.y,e.z),r.visible=!1,this.add(r);const n=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),a=this.getViewer().camera.fov;this.updateScaleFactor(n,a)}}updateScaleFactor(e,t){if(!this.rigidBody)return;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,n=this.getViewer().domElement.offsetHeight,a=this.factor=5*r/n;this.remove(this.rigidBody),this.rigidBody.geometry.dispose();const s=new THREE.TorusGeometry(this.radius,a,3,16),o=this.rigidBody=new THREE.Mesh(s,this.rigidBodyMaterial);o.position.set(this.center.x,this.center.y,this.center.z),o.visible=!1,this.add(o),this.updateMatrixWorld()}update(e,t,i,r){this.center=e,this.radius=t,this.thetaStart=i,this.thetaLength=r,this.remove(this.circle),this.circle.geometry.dispose(),this.circleEdges.forEach((e=>{this.remove(e),e.geometry.dispose()})),this.circleEdges=[],this.rigidBody&&(this.remove(this.rigidBody),this.rigidBody.geometry.dispose()),this.addCircle(e,t,i,r),this.updateMatrixWorld()}hitTest(e){if(!this.rigidBody)return!1;const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeCurve.material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.edgeCurve),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.edgeCurve}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}setGray(){}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Circle=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.isSelected=!1,this.enableAnimation=!1}init(){const{center:e,radius:t,thetaStart:i,thetaLength:r}=this.getConfig();this.radius=t,this.angleRadius=3,this.addCircleEdge(e,i,r),this.addAngleText(e,i,r),this.updateScaleFactor()}addCircleEdge(e,t,i){const n=new THREE.EllipseCurve(0,0,this.angleRadius,this.angleRadius,t,t+i,!1,0).getPoints(128),a=(new THREE.BufferGeometry).setFromPoints(n);this.circleEdgeMaterial||(this.circleEdgeMaterial=new THREE.LineBasicMaterial({depthTest:!1,color:this.getLinearColor("#FFF227")}));const s=this.line=new THREE.Line(a,this.circleEdgeMaterial);s.renderOrder=r.EnumRenderOrder.Effect+200,s.position.set(e.x,e.y,e.z),this.add(s)}addAngleText(e,t,i){const n=this.center=new THREE.Vector3(e.x,e.y,e.z),a=new THREE.Vector3(this.angleRadius+2,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),t+i/2).add(n),s=`${Math.round(180*i/Math.PI)}°`,o=document.createElement("canvas"),l=o.getContext("2d"),d='32px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';l.font=d;const h=l.measureText(s),{width:c,actualBoundingBoxAscent:u}=h;o.width=64,o.height=64,l.font=d,l.fillStyle="#ffffff",l.fillText(s,(64-c)/2,(64+u)/2);const p=new THREE.CanvasTexture(o),m=new THREE.SpriteMaterial({map:p,depthTest:!1}),f=this.text=new THREE.Sprite(m);f.position.set(a.x,a.y,a.z),f.renderOrder=r.EnumRenderOrder.Effect+200,this.add(f)}updateScaleFactor(e,t){e=e||this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=t||this.getViewer().camera.fov;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,n=this.getViewer().domElement.offsetHeight,a=this.factor=10*r/n;if(7*a>this.radius)return void(this.visible=!1);this.visible=!0,this.line.scale.set(a,a,a),this.updateMatrixWorld();const s=this.text.position.clone().sub(this.center).normalize().multiplyScalar(5*a).add(this.center);this.text.position.set(0,0,0),this.text.scale.set(4*a,4*a,1),this.text.position.set(s.x,s.y,s.z),this.text.updateMatrixWorld()}update(e,t,i,r){this.radius=t,this.remove(this.line),this.line.geometry.dispose(),this.remove(this.text),this.text.geometry.dispose(),this.text.material.dispose(),this.addCircleEdge(e,i,r),this.addAngleText(e,i,r),this.updateScaleFactor()}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.SectorAngle=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t}=this.getConfig();this.color=t,this.addRectangle(e,t),super.init()}addRectangle(e,t){const i=new THREE.BufferGeometry,n=new Float32Array([e[0].x,e[0].y,e[0].z,e[1].x,e[1].y,e[1].z,e[2].x,e[2].y,e[2].z,e[3].x,e[3].y,e[3].z,e[4].x,e[4].y,e[4].z,e[5].x,e[5].y,e[5].z]);i.setAttribute("position",new THREE.BufferAttribute(n,3)),i.computeVertexNormals();const a=new THREE.MeshBasicMaterial({color:this.getLinearColor(t),depthTest:!1,depthWrite:!0,side:2,transparent:!0,opacity:.5}),s=this.rectangle=new THREE.Mesh(i,a);s.renderOrder=r.EnumRenderOrder.Effect,s.position.set(0,0,0),this.add(s),this.updateMatrixWorld()}updateRectangle(e,t){this.remove(this.rectangle),this.addRectangle(e,t||this.color)}hide(){this.rectangle.visible=!1}show(){this.rectangle.visible=!0}hitTest(e){if(!this.rectangle)return!1;const t=[];return this.rectangle.raycast(e,t),t.length>0}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Rectangle=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,position:t,color:i,opacity:r}=this.getConfig();this.color=i,this.opacity=r||1,this.trangles=[],this.drawTrangle(e[0],e[1],e[2]),this.drawTrangle(e[0],e[2],e[3]),this.position.set(t.x,t.y,t.z),super.init()}drawTrangle(e,t,i){const n=new THREE.BufferGeometry,a=new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z,i.x,i.y,i.z]);n.setAttribute("position",new THREE.BufferAttribute(a,3)),n.computeVertexNormals();const s=new THREE.MeshBasicMaterial({color:this.getLinearColor(this.color),depthTest:!1,depthWrite:!0,side:2,transparent:!0,opacity:this.opacity}),o=new THREE.Mesh(n,s);o.renderOrder=r.EnumRenderOrder.Effect,o.position.set(0,0,0),o.name="drawTrangle",this.trangles.push(o),this.add(o),this.updateMatrixWorld()}updatePosition(e){this.getConfig().position=e,this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(!0)}update(e){this.trangles.length>0&&(this.trangles.forEach((e=>{this.remove(e),e.geometry.dispose()})),this.trangles=[]),this.getConfig().points=e,this.drawTrangle(e[0],e[1],e[2]),this.drawTrangle(e[0],e[2],e[3])}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Quadrangle=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{position:e,innerRadius:t,outerRadius:i,thetaStart:r,thetaLength:n,color:a,opacity:s,quaternion:o,isWholeRadius:l}=this.getConfig();this.color=a,this.opacity=s||1,this.isWholeRadius=l||!1,this.addRing(t,i,r,n,{color:this.getLinearColor(a),opacity:s||1}),this.addRingEdge(t,i,r,n,{color:this.getLinearColor(a)}),this.position.set(e.x,e.y,e.z),o&&this.applyQuaternion(o),this.normal=new THREE.Vector3(0,0,1),o&&this.normal.applyQuaternion(o),super.init()}addRing(e,t,i,r,n){const a=new THREE.RingGeometry(e,t,32,8,i,r),s=new THREE.MeshBasicMaterial({depthTest:!1,side:THREE.DoubleSide,transparent:!0,...n}),o=this.ring=new THREE.Mesh(a,s);this.add(o)}addRingEdge(e,t,i,n,a){const s=new THREE.EllipseCurve(0,0,e,e,i,i+n,!1,0).getPoints(128),o=[];s.forEach((e=>o.push(e.x||0,e.y||0,e.z||0)));const l=new THREE.LineGeometry;l.setPositions(o);const d=new THREE.EllipseCurve(0,0,t,t,i,i+n,!1,0).getPoints(128),h=[];d.forEach((e=>h.push(e.x||0,e.y||0,e.z||0)));const c=new THREE.LineGeometry;c.setPositions(h),this.circleEdgeMaterial||(this.circleEdgeMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...a}),this.circleEdgeMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const u=this.edgeCurveInner=new THREE.Line2(l,this.circleEdgeMaterial);u.renderOrder=r.EnumRenderOrder.Effect+100,this.add(u),this.circleEdges=[],this.circleEdges.push(u);const p=this.edgeCurveOuter=new THREE.Line2(c,this.circleEdgeMaterial);if(p.renderOrder=r.EnumRenderOrder.Effect+100,this.add(p),this.circleEdges.push(p),n-i!=2*Math.PI){const a=new THREE.LineGeometry;a.setPositions([this.isWholeRadius?0:e,0,0,t,0,0]);const s=new THREE.Line2(a,this.circleEdgeMaterial);s.rotateOnAxis(new THREE.Vector3(0,0,1),i),s.renderOrder=r.EnumRenderOrder.Effect+100,this.add(s),this.circleEdges.push(s);const o=new THREE.Line2(a,this.circleEdgeMaterial);o.rotateOnAxis(new THREE.Vector3(0,0,1),i+n),o.renderOrder=r.EnumRenderOrder.Effect+100,this.add(o),this.circleEdges.push(o)}const m=new THREE.TorusGeometry(t-(t-e)/2,(t-e)/2,3,16,Math.PI/2);this.rigidBodyMaterial||(this.rigidBodyMaterial=new THREE.MeshBasicMaterial);const f=this.rigidBody=new THREE.Mesh(m,this.rigidBodyMaterial);f.visible=!1,this.add(f)}hitTest(e){if(!this.rigidBody||!this.visible||this.getConfig().notHitTest)return!1;const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){if(this.getConfig().notHitTest)return;const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeCurveInner.material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,2.5]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.edgeCurveInner),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.edgeCurveInner});const r=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.ring.material.color.toArray(),1,.8879231178819663,.0202885630566524]),n=new THREE.AnimationClip("Action",1,[r]);this.mixerHighlight2=new THREE.AnimationMixer(this.ring),this.actionHighlight2=this.mixerHighlight2.clipAction(n),this.actionHighlight2.setLoop(THREE.LoopOnce),this.actionHighlight2.timeScale=this.animationTimeScale,this.actionHighlight2.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight2),this.control.addAnimation({mixer:this.mixerHighlight2,action:this.actionHighlight2,object:this.ring}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){if(this.getConfig().notHitTest)return;const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeCurveInner.material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.edgeCurveInner),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.edgeCurveInner});const i=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.ring.material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),r=new THREE.AnimationClip("Action",1,[i]);this.mixerGray2=new THREE.AnimationMixer(this.ring),this.actionGray2=this.mixerGray2.clipAction(r),this.actionGray2.setLoop(THREE.LoopOnce),this.actionGray2.timeScale=this.animationTimeScale,this.actionGray2.clampWhenFinished=!0,this.grayActionList.push(this.actionGray2),this.control.addAnimation({mixer:this.mixerGray2,action:this.actionGray2,object:this.ring}),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}updatePosition(e){this.getConfig().position=e,this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(!0)}transform(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=this.normal.clone().applyQuaternion(this.control.quaternion),n=new THREE.Plane(r),a=this.getViewer().drawingToWorld(t.ray.origin.clone()),s=-n.distanceToPoint(this.control.position);n.set(r,s);const o=new THREE.Ray(a,i),l=new THREE.Vector3;o.intersectPlane(n,l),this.mouseDownOffset=this.mouseDownOffset||l.clone();let d=this.control.position.clone(),h=this.mouseDownOffset.clone().sub(d.clone()).normalize(),c=l.clone().sub(d.clone()).normalize(),u=h.angleTo(c),p=h.clone().cross(c.clone()).angleTo(r)<Math.PI/2;if("ringZ"==this.name?!p&&(u*=-1):p&&(u*=-1),!this.startPosition){this.startPosition=l.clone();let e=new THREE.Vector3(1,0,0),t=this.getConfig().quaternion;t&&e.applyQuaternion(t);let i=e.clone().applyQuaternion(this.control.quaternion),r=this.startPosition.clone().sub(d.clone()).normalize();this.startRingAngle=i.angleTo(r)}let m="",f=this.startPosition.clone().sub(d.clone()).normalize(),g=l.clone().sub(d.clone()).normalize();m=f.angleTo(g),!(f.clone().cross(g.clone()).angleTo(r)<Math.PI/2)&&(m*=-1),this.control.rotateInfo={type:this.name,angle:u,angleTotal:m,textDir:f,startRingAngle:this.startRingAngle},this.mouseDownOffset=l,this.getViewer().render()}transformFinished(){this.mouseDownOffset=null,this.startPosition=null}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Ring=e})(),function(){let e;const t=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,-1,0);let n=new THREE.Line3,a=Array.from({length:4},(()=>new THREE.Vector3)),s=new THREE.Plane;const o={};o.near=Array.from({length:4},(()=>new THREE.Vector3)),o.far=Array.from({length:4},(()=>new THREE.Vector3));const l=new THREE.Vector2;r.GroundDrawingManager=class{constructor(e){this.viewer=e,this.groundArray=[],this.drawingArray=[],this.visibleDrawingArray=[],this.generateTextureScene=new THREE.Scene,this.dwgTranslate=new THREE.Vector3,this.drawingBox=new THREE.Box3,this.orthCameras=Array.from({length:8},(()=>new THREE.OrthographicCamera(-1,1,1,-1,.1,15e3))),this.targets=[];for(let e=0;e<2;++e)this.targets[e]=Array.from({length:8},(()=>new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,{generateMipmaps:!0,depthBuffer:!1,magFilter:THREE.NearestFilter,minFilter:THREE.LinearMipmapLinearFilter})));this.transformMatrixArr=[],this.haveGroundDrawing=0,this.cascaedCount=0,this.multiSample=!1}destroy(){this.viewer=void 0,this.groundArray=void 0,this.drawingArray=void 0,this.visibleDrawingArray=void 0,this.generateTextureScene=void 0,this.dwgTranslate=void 0,this.drawingBox=void 0,this.orthCameras.forEach((e=>{r.ThreeHelper.destroyOrthographicCamera(e)})),this.orthCameras=void 0,this.targets=void 0,this.transformMatrixArr=void 0}createGroundDrawing(e,t){if(!e||!t)return null;let i=!1;for(let t=0;t<this.drawingArray.length;++t)e.id===this.drawingArray[t].id&&(i=!0);i||this.drawingArray.push(e);for(let e=0;e<t.length;++e){i=!1;for(let r=0;r<this.groundArray.length;++r)this.groundArray[r].id===t[e].id&&(i=!0);i||this.groundArray.push(t[e])}return e.id}update(){this.visibleDrawingArray=[];for(let e=0;e<this.drawingArray.length;++e)!0===this.drawingArray[e].visible&&(this.visibleDrawingArray.push(this.drawingArray[e]),this.drawingArray[e].objectGroup.visible=!1);if(this.visibleDrawingArray.length>0&&this.groundArray.length>0){this.haveGroundDrawing=1,this._createTexture();for(let e=0;e<this.orthCameras.length;++e){let t=this.orthCameras[e].projectionMatrix.clone(),i=this.orthCameras[e].matrixWorldInverse;this.transformMatrixArr[e]=t.multiply(i)}}else this.haveGroundDrawing=0}_transformDwg(){this.drawingBox.makeEmpty();for(let e=0;e<this.visibleDrawingArray.length;++e){let t=this.visibleDrawingArray[e].getBoundingBoxWorld().clone();this.drawingBox.union(t)}this.drawingBox.getCenter(this.dwgTranslate),this.dwgTranslate.negate();for(let e=0;e<this.visibleDrawingArray.length;++e){this.visibleDrawingArray[e].translate(this.dwgTranslate)}}_reTransformDwg(){this.dwgTranslate.negate();for(let e=0;e<this.visibleDrawingArray.length;++e){this.visibleDrawingArray[e].translate(this.dwgTranslate)}this.dwgTranslate.applyMatrix4(this.viewer.getScene().getRawMatrixGlobal())}_getCameraGroundDistance(){function e(t,i,r){if(t.children.length>0)for(let n=0;n<t.children.length;++n)e(t.children[n],i,r);else{let e=[];t.parent.visible&&(t.raycast(i,e),r.push(...e))}}const t=this.viewer.camera.position,r=new THREE.Raycaster(t,i);let n=[];for(let i=0;i<this.groundArray.length;++i){let a=!1,s=null;if(this.groundArray[i].isObliquePhotography){if(s=this.groundArray[i].getBoundingBoxWorld().clone(),s.applyMatrix4(this.viewer.getScene().getRawMatrixGlobal()),t.x<s.min.x||t.z<s.min.z||t.x>s.max.x||t.z>s.max.z){const e=new THREE.Ray(t,this.viewer.camera._direction),i=new THREE.Vector3;if(!e.intersectBox(s,i))continue}a=!0}let o=[];if(e(this.groundArray[i].ObjectGroup?this.groundArray[i].ObjectGroup:this.groundArray[i].objectGroup,r,o),o.length>0)n.push(...o);else if(a){const e=.5*s.min.y+.5*s.max.y,i=t.y-e;i>0&&n.push({distance:i})}}let a=Number.MAX_SAFE_INTEGER;if(n[0])for(let e=0;e<n.length;++e)a=Math.min(n[e].distance,a);return a}_setFromProjectionMatrix(e){e.realUp.y>0?(o.near[0].set(-1,1,-1),o.near[1].set(1,1,-1),o.near[2].set(-1,-1,-1),o.near[3].set(1,-1,-1)):(o.near[0].set(-1,-1,-1),o.near[1].set(1,-1,-1),o.near[2].set(-1,1,-1),o.near[3].set(1,1,-1)),o.near.forEach((function(t){t.unproject(e)})),e.realUp.y>0?(o.far[0].set(-1,1,1),o.far[1].set(1,1,1),o.far[2].set(-1,-1,1),o.far[3].set(1,-1,1)):(o.far[0].set(-1,-1,1),o.far[1].set(1,-1,1),o.far[2].set(-1,1,1),o.far[3].set(1,1,1)),o.far.forEach((function(t){t.unproject(e)}))}_practicalSplit(e,t,i,r,n,a){const s=[],o=[];!function(e,t,i,r,n){for(let a=1;a<e;a++){const s=t*(i/t)**(a/e)/i;n.push(r*s)}n.push(r)}(e,t,i,r,o),function(e,t,i,r,n){for(let a=1;a<e;a++){const s=(t+(i-t)*a/e)/i;n.push(r*s)}n.push(r)}(e,t,i,r,s);for(let t=1;t<e;t++)a.push(s[t-1]*(1-n)+o[t-1]*n);a.push(r)}_computeMaxDepth(e,t){const i={x:this.drawingBox.max.x,y:this.drawingBox.max.z},r={x:this.drawingBox.min.x,y:this.drawingBox.min.z},n=[];n[0]=new THREE.Vector2(i.x,r.y),n[1]=new THREE.Vector2(r.x,i.y),n[2]=new THREE.Vector2(i.x,i.y),n[3]=new THREE.Vector2(r.x,r.y);let a=0;const s=t.clone().sub(e).normalize();let o=[];for(let t=0;t<n.length;++t){n[t].clone().sub(e).dot(s)>0&&(a=Math.max(a,n[t].distanceTo(e)),o[t]=a)}return a>0?a:(o.sort(((e,t)=>-(e-t))),o[0])}_computeFrustumProjectPlane(e){this._setFromProjectionMatrix(e),s.set(t,0);for(let e=0;e<4;++e){let t=o.near[e],i=o.far[e];if(n.start.copy(t),n.end.copy(i),e>1&&t.sub(i).normalize().y<.1)return null;if(i.y>0&&(i.y=-1),!s.intersectLine(n,a[e]))return null}return[a[2],a[3],a[0],a[1]]}_renderCascade(e,t,i,r,n,a,s,o){const l=i,d=t[0],h=t[1],c=(new THREE.Vector3).lerpVectors(d,h,.5),u=50*(o+1);let p=s[o]+u,m=(r=p+r)/l,f=(new THREE.Vector3).lerpVectors(e[0],e[2],m),g=(new THREE.Vector3).lerpVectors(e[1],e[3],m),v=(new THREE.Vector3).lerpVectors(f,g,.5),y=(new THREE.Vector3).lerpVectors(v,c,.5),M=f.distanceTo(g);o<1&&(p=Math.max(2*p,M),M+=50,M*=1.2,y=c);const E=this.orthCameras[o];let x=this.targets[0][o];if(this._render(x,E,a,M,p,y,n,o),8===++o)return o;{const t=[f,g];return this._renderCascade(e,t,i,r,n,a,s,o)}}_render(e,t,i,n,a,s,o,d){t.left=.5*-n-1,t.right=.5*n+1,t.top=.5*a+1,t.bottom=.5*-a-1,t.near=.1,t.far=15e4,t.position.copy(s),t.position.x+=-i.scratchVector.x,t.position.y+=1e5,t.position.z+=-i.scratchVector.z,t.lookAt(s),t.updateProjectionMatrix(),o.getDrawingBufferSize(l);let h=l.x*=2,c=l.y*=2;e.setSize(h,c),o.setRenderTarget(e),1==r.GlobalData.GTAO&&o.clear(),o.render(this.generateTextureScene,t)}_createTexture(){this._transformDwg();let e=this._visibleAll();this.generateTextureScene.clear();let t=[];for(let e=0;e<this.visibleDrawingArray.length;++e){let i=this.visibleDrawingArray[e].objectGroup.parent;t.push(i),this.generateTextureScene.add(this.visibleDrawingArray[e].objectGroup)}let i=this.viewer.rendererManager.renderer.renderer,r=i.getClearAlpha();i.clear(),i.setClearAlpha(0);let n=this.viewer.camera.clone(),a=this._getCameraGroundDistance();const s=(new THREE.Vector3).copy(this.dwgTranslate);if(s.applyMatrix4(this.viewer.getScene().getRawMatrixGlobal()),n.position.x+=s.x,n.target.x+=s.x,n.position.z+=s.z,n.target.z+=s.z,a){let e=a-n.position.y;n.position.y+=e,n.target.y+=e}n.updateProjectionMatrix(),n.updateMVP();const o=this._computeFrustumProjectPlane(n);if(o){const e=(new THREE.Vector3).lerpVectors(o[0],o[1],.5),t=(new THREE.Vector3).lerpVectors(o[2],o[3],.5),a=this._computeMaxDepth(e,t),s=e.distanceTo(t);let l=s;a>0&&(l=Math.min(a,l));const d=[];this._practicalSplit(8,n.near,n.far,l,.99,d),this.cascaedCount=this._renderCascade(o,[o[0],o[1]],s,0,i,n,d,0),i.setRenderTarget(null),i.setClearAlpha(r),this.targets=[this.targets[1],this.targets[0]]}for(let e=0;e<this.visibleDrawingArray.length;++e)t[e].add(this.visibleDrawingArray[e].objectGroup);this._reductAll(e),this._reTransformDwg()}_visibleAll(){let e=new Map;function t(i){for(let e=0;e<i.children.length;++e)t(i.children[e]);let r=i.visible;e.set(i,r),i.visible=!0}for(let e=0;e<this.visibleDrawingArray.length;++e)t(this.visibleDrawingArray[e].objectGroup);return e}_reductAll(e){function t(i){for(let e=0;e<i.children.length;++e)t(i.children[e]);i.visible=e.get(i)}for(let e=0;e<this.visibleDrawingArray.length;++e)t(this.visibleDrawingArray[e].objectGroup)}deleteGroundDrawingById(e){for(let t=0;t<this.drawingArray.length;++t)if(this.drawingArray[t].id===e)return this.drawingArray[t].objectGroup.visible=!0,this.drawingArray.splice(t,1),void(0===this.drawingArray.length&&(this.clearTexture(),this.groundArray.length=0))}clearTexture(){for(let e=0;e<2;++e)for(let t=0;t<8;++t)this.targets[e][t].texture.dispose();this.transformMatrixArr=[]}getDrawingTexture(){let e=[];for(let t=0;t<8;++t)e.push(this.targets[1][t].texture);return e}getOrthTransformMatrix(){return this.transformMatrixArr}getCascadeCount(){return this.cascaedCount}isVisibleGroundMesh(e){for(let t=0;t<this.groundArray.length;++t){let i=this.groundArray[t].ObjectGroup?this.groundArray[t].ObjectGroup:this.groundArray[t].objectGroup,r=e.parent;for(;r;){if(r.uuid===i.uuid)return!0;r=r.parent}}return!1}static onBeforeRenderFunc(e,t){if("ObliquePhotographyMaterial"!==e.type&&"MapTileMaterial"!==e.type)return;if(r.GroundDrawingManager.getInstance().haveGroundDrawing>0&&r.GroundDrawingManager.getInstance().isVisibleGroundMesh(t)){e.defines.ACCEPT_DRAWING||(e.defines.ACCEPT_DRAWING="",e.needsUpdate=!0);let t=r.GroundDrawingManager.getInstance().getDrawingTexture(),i=r.GroundDrawingManager.getInstance().getOrthTransformMatrix(),n=r.GroundDrawingManager.getInstance().dwgTranslate;t&&i&&(e.uniforms.groundDrawingCascadeCount.value=r.GroundDrawingManager.getInstance().getCascadeCount(),e.uniforms.groundDrawingTexture.value=t,e.uniforms.groundDrawingOrthMVP.value=i,e.uniforms.multiSample.value=r.GroundDrawingManager.getInstance().multiSample,e.uniforms.viewportSize.value.copy(l),e.uniforms.worldCoordTranslate.value.copy(n))}else""===e.defines.ACCEPT_DRAWING&&(delete e.defines.ACCEPT_DRAWING,e.needsUpdate=!0)}static getInstance(){return e}static createInstance(t){return e||(e=new r.GroundDrawingManager(t)),e}static destroyInstance(){e&&e.destroy(),e=null}}}(),function(){const e=new THREE.Box3,t=new THREE.Plane,i=new THREE.Matrix3;class n{constructor(){}destory(){}play(){}setProgress(){}pause(){}stop(){}setTime(){}setSpeed(){}update(){}getPlane(){}addProgressChanged(){}removeProgressChanged(){}addUpdateNodeInfo(){}}class a extends n{constructor(e,t){super(),this.manager=t,this.viewer=e.viewer,this.direction=(new THREE.Vector3).copy(e.direction);const i=this.viewer.getScene().getRawMatrixGlobal();this.direction.applyMatrix4(i).normalize(),this.speedRatio=this.direction.clone().applyMatrix4(i).length(),this.modelUserIds=e.modelUserIds,this.time=e.time?e.time/1e3:0,this.speed=e.speed?e.speed*this.speedRatio:0,this.loop=!!e.loop,this.animationIndex=void 0!==e.index?e.index:-1,this.isPlaying=!1,this.isPaused=!0,this.isProgressSettled=!1,this.lastProgress=0,this.newProgress=0,this.isAnimationStarted=!1,this.planeInfo={direction:null,range:null,speed:.1},this.plane=new THREE.Vector4,this.boundingBox=new THREE.Box3,this.boxNeedsUpdate=!1,this.userIdMap=new Map;for(let[e,t]of this.modelUserIds)for(let i=0;i<t.length;++i)this.userIdMap.set(t[i],e);this.updateNodeArray=[],this.progressCallback=[],this._calculateClippingPlane(),this._updateAllMesh(),this._reset()}destory(){this.stop(),this.animationIndex=-1,this._updateAllMesh(),this.direction=null,this.planeInfo=null,this.plane=null,this.boundingBox=null,this._resetAllMesh(),this.userIdMap.clear(),this.updateNodeArray=null,this.progressCallback=null}play(){this.isPlaying=!0,this.isPaused=!1,this.isProgressSettled=!1}setProgress(e){e=Math.max(0,Math.min(1,e)),this.isPlaying=!1,this.isProgressSettled=!0,this.newProgress=e,this.lastProgress!==this.newProgress&&this._onProgressChanged()}pause(){this.isPaused=!0}stop(){this.isPlaying=!1,this.isPaused=!0,this._reset()}setTime(e){this.time=e/1e3;const t=this.planeInfo.range[1]-this.planeInfo.range[0];this.planeInfo.speed=this.time?t/this.time:this.speed}setSpeed(e){this.speed=e*this.speedRatio;const t=this.planeInfo.range[1]-this.planeInfo.range[0];this.planeInfo.speed=this.time?t/this.time:this.speed}update(){this.boxNeedsUpdate&&(this._calculateClippingPlane(),this.boxNeedsUpdate=!1);let e=!0;for(let t=0;t<this.updateNodeArray.length;++t){const i=this.updateNodeArray[t],r=i.model,n=r.tilesLoader;"0.0.3"===r.dataVersion?(e=this._updateBimTilesNodeV3(i.userIdInfo,i.userIdInfo.userId,n,r),e&&(this.updateNodeArray[t]=null)):"0.0.2"!==r.dataVersion&&"0.0.1"!==version||(e=this._updateBimTilesNodeV2(i.userIdInfo,i.userIdInfo.userId,n,r),e&&(this.updateNodeArray[t]=null))}this.updateNodeArray=this.updateNodeArray.filter((e=>e))}getPlane(e,t){if(!this.isPlaying){if(this.isProgressSettled){let e=this._projectPlane(this.plane,this.viewer.camera,t);return 0===this.newProgress&&e.set(0,0,0,0),e}return this.plane.w=this.planeInfo.range[1],this._projectPlane(this.plane,this.viewer.camera,t)}const i=this.planeInfo.range[1]-this.planeInfo.range[0];if(0===i)return this._projectPlane(this.plane,this.viewer.camera,t);let r=i*this.lastProgress;this.isPaused||(r=this._addProgress(e));let n=this.planeInfo.range[0]+r;this.newProgress>1&&(this.lastProgress<1?(this.newProgress=1,n=this.planeInfo.range[1]):this.loop?(this.newProgress=0,n=this.planeInfo.range[0]):(n=this.planeInfo.range[1],this.stop())),this.lastProgress!==this.newProgress&&this._onProgressChanged(),this.plane.w=n;const a=this._projectPlane(this.plane,this.viewer.camera,t);return 0===this.newProgress&&!1!==this.isPlaying&&a.set(0,0,0,0),a}addProgressChanged(e){this.progressCallback.push(e)}removeProgressChanged(e){for(let t=0;t<this.progressCallback.length;++t)if(this.progressCallback[t]===e){this.progressCallback.splice(t,1);break}}addUpdateNodeInfo(e,t,i,r){if(!this.updateNodeArray)return;const n=this,a=e.tilesLoader;let s;"0.0.3"===e.dataVersion?(s=n._updateBimTilesNodeV3(t,t.userId,a,e),this.boxNeedsUpdate=!0):"0.0.2"!==e.dataVersion&&"0.0.1"!==version||(s=n._updateBimTilesNodeV2(t,t.userId,a,e),this.boxNeedsUpdate=!0),s||n.updateNodeArray.push({model:e,userIdInfo:t,tileId:i,nodeId:r})}_updateAllMesh(){for(let[e,t]of this.userIdMap)this._updateUserIdMesh(t,e)}_resetAllMesh(){for(let[e,t]of this.userIdMap)this._resetUserIdMesh(t,e)}_updateBimTilesNodeV2(e,t,i){const r=e.parent||e.nodeId;let n=!0;if(e.instanceOrNot){const a=i.instancedMeshManager.getInstanceMeshNodeById(r),s=i.instancedWireframeManager.getInstanceLineNodeById(e.lineId);if(s&&(n=n&&this._updateMesh(s,t,!0,e.index)),a)for(const i of a.values()){const r=i.mesh.parent,a=r.children[0],s=r.children[1];n=n&&this._updateMesh(a,t,!0,e.index),n=n&&this._updateMesh(s,t,!0,e.index)}}else{const a=i.batchedWireframeManager.batchedMeshIdNodeMap[e.lineId];if(a)for(const e in a){const i=a[e];n=n&&this._updateMesh(i,t,!1)}const s=i.batchedMeshManager.getMeshNodeById(r);n=n&&this._updateMesh(s,t,!1)}return n}_resetBimtilesNodeV2(e,t,i){let r;const n=e.parent||e.nodeId;if(e.instanceOrNot){const a=i.instancedMeshManager.getInstanceMeshNodeById(n),s=i.instancedWireframeManager.getInstanceLineNodeById(e.lineId);if(s&&(r=this._resetMesh(s,t,!0,e.index)),a)for(const i of a.values()){const r=i.mesh.parent,n=r.children[0],a=r.children[1];this._resetMesh(n,t,!0,e.index),this._resetMesh(a,t,!0,e.index)}}else{const r=i.batchedWireframeManager.batchedMeshIdNodeMap[e.lineId];if(r)for(const e in r){const i=r[e];this._resetMesh(i,t,!1)}const a=i.batchedMeshManager.getMeshNodeById(n);this._resetMesh(a,t,!1)}}_updateBimTilesNodeV3(e,t,i,r,n=!1){const a=e.tileId;let s=!0;if(e.instanceOrNot)for(const[e,t]of a)for(const r of t.keys()){const t=`${e}_0`,r=`${t}_copy`,n=i.getInstanceMeshNodeById(t);s=s&&this._updateBimTilesNodeV3Material(n,!0);const a=i.getInstanceMeshNodeById(r);if(s=s&&this._updateBimTilesNodeV3Material(a,!0),n&&n.cloneMesh)for(let e=0;e<n.cloneMesh.length;++e)this._updateBimTilesNodeV3Material(n.cloneMesh[e],!0);if(a&&a.cloneMesh)for(let e=0;e<a.cloneMesh.length;++e)this._updateBimTilesNodeV3Material(a.cloneMesh[e],!0)}else for(const[e,t]of a)for(const r of t.keys()){const t=`${e}_${r}`;let n=i.getMeshNodeById(t);if(s=s&&this._updateBimTilesNodeV3Material(n,!1),n&&n.cloneMesh)for(let e=0;e<n.cloneMesh.length;++e)this._updateBimTilesNodeV3Material(n.cloneMesh[e],!1)}return s}_updateBimTilesNodeV3Material(e,t){if(!e)return!1;const i=e.material;let r="CLOUDSTANDARDBATCHEDV3";if(t&&(r="CLOUDSTANDARDINSTANCEDV3"),i instanceof Array){for(let e=0;e<i.length;++e)if(i[e]){if(i[e].defines&&i[e].defines.hasOwnProperty(r))continue;i[e].defines||(i[e].defines={}),i[e].defines[r]="",i[e].needsUpdate=!0}}else{if(i.defines&&i.defines.hasOwnProperty(r))return!0;i.defines||(i.defines={}),i.defines[r]="",i.needsUpdate=!0}return!0}_resetBimTilesNodeV3Material(e,t){if(!e)return!1;const i=e.material;let r="CLOUDSTANDARDBATCHEDV3";if(t&&(r="CLOUDSTANDARDINSTANCEDV3"),i instanceof Array)for(let e=0;e<i.length;++e)i[e]&&(i[e].defines&&i[e].defines.hasOwnProperty(r)&&delete i[e].defines[r],i[e].needsUpdate=!0);else i.defines&&i.defines.hasOwnProperty(r)&&delete i.defines[r],i.needsUpdate=!0;return!0}_resetBimTilesNodeV3(e,t,i,r){const n=e.tileId;if(e.instanceOrNot)for(const[e,t]of n)for(const r of t.keys()){const t=`${e}_0`,r=`${t}_copy`,n=i.getInstanceMeshNodeById(t);this._resetBimTilesNodeV3Material(n,!0);const a=i.getInstanceMeshNodeById(r);this._resetBimTilesNodeV3Material(a,!0)}else for(const[e,t]of n)for(const r of t.keys()){const t=`${e}_${r}`;let n=i.getMeshNodeById(t);this._resetBimTilesNodeV3Material(n,!1)}return!1}_updateUserIdMesh(e,t){if(!!e.tilesLoader){const i=e.getDescriptor(),r=e.tilesLoader,n=r.dataVersion;if("0.0.3"===n){let n=i.getUserIdInfoByUserId(t);for(let i of n)this._updateBimTilesNodeV3(i,t,r,e,!0)}else if("0.0.2"===n||"0.0.1"===n){let e=i.getNodeInfosByUserId(t);for(const i of e)this._updateBimTilesNodeV2(i,t,r)}}else{{const i=e._handler.defaultManager.meshManager.getMeshesByUserId(e,t);for(let e=0;e<i.length;++e){const r=i[e].mesh;r&&this._updateMesh(r,t,!1,null,!0)}const r=e._handler.defaultManager.wireframeManager.getWireFrameLineSegments();for(let e=0;e<r.length;++e){const i=r[e];i&&this._updateMesh(i,t,!1,null,!0)}}const i=e._handler.instancedManager.meshManager.nodeIdxMapFromUserId[t];for(const r in i){const n=e._handler.instancedManager.meshManager.instanceNodeMap[r][0],a=e._handler.instancedManager.meshManager.instanceNodeMap[r][1],s=e._handler.instancedManager.wireframeManager.instanceNodeMap[r];if(n)for(let e=0;e<n.length;++e){const a=n[e];if(a)for(let e=0;e<i[r].length;++e)this._updateMesh(a,t,!0,i[r][e],!0)}if(a)for(let e=0;e<a.length;++e){const n=a[e];if(n)for(let e=0;e<i[r].length;++e)this._updateMesh(n,t,!0,i[r][e],!0)}if(s)for(let e=0;e<s.length;++e){const n=s[e];if(n)for(let e=0;e<i[r].length;++e)this._updateMesh(n,t,!0,i[r][e],!0)}}}}_resetUserIdMesh(e,t){if(!!e.tilesLoader){const i=e.getDescriptor(),r=e.tilesLoader,n=r.dataVersion;if("0.0.3"===n){let n=i.getUserIdInfoByUserId(t);for(let i of n)this._resetBimTilesNodeV3(i,t,r,e)}else if("0.0.2"===n||"0.0.1"===n){let e=i.getNodeInfosByUserId(t);for(const i of e)this._resetBimtilesNodeV2(i,t,r)}}else{{const i=e._handler.defaultManager.meshManager.getMeshesByUserId(e,t);for(let e=0;e<i.length;++e){const r=i[e].mesh;r&&this._resetMesh(r,t,!1)}const r=e._handler.defaultManager.wireframeManager.getWireFrameLineSegments();for(let e=0;e<r.length;++e){const i=r[e];i&&this._resetMesh(i,t,!1)}}const i=e._handler.instancedManager.meshManager.nodeIdxMapFromUserId[t];for(const r in i){const n=e._handler.instancedManager.meshManager.instanceNodeMap[r][0],a=e._handler.instancedManager.meshManager.instanceNodeMap[r][1],s=e._handler.instancedManager.wireframeManager.instanceNodeMap[r];if(n)for(let e=0;e<n.length;++e){const a=n[e];if(a)for(let e=0;e<i[r].length;++e)this._resetMesh(a,t,!0,i[r][e])}if(a)for(let e=0;e<a.length;++e){const n=a[e];if(n)for(let e=0;e<i[r].length;++e)this._resetMesh(n,t,!0,i[r][e])}if(s)for(let e=0;e<s.length;++e){const n=s[e];if(n)for(let e=0;e<i[r].length;++e)this._resetMesh(n,t,!0,i[r][e])}}}}_resetMesh(e,t,i,r){if(e)if(i)this._resetInstanceGeometry(e),this._resetMaterial(e.material);else{for(let t=0;t<e.material.length;++t)e.material[t]&&this._resetMaterial(e.material[t]);this._resetGeometry(e)}}_updateMesh(e,t,i,r,n){if(!e)return!1;const a=this;if(i?e.isCopyMesh&&!n?this._updateInstanceMeshNodeAsync(e,r).then((()=>{a.boxNeedsUpdate=!0})):this._updateInstanceMeshNodeDirectly(e,r):e.visible||n?(this._updateBatchedMeshNodeDirectly(e,t),this.boxNeedsUpdate=!0):this._updateBatchedMeshNodeAsync(e,t).then((()=>{a.boxNeedsUpdate=!0})),e&&e.cloneMesh)for(let n=0;n<e.cloneMesh.length;++n)this._updateCloneMesh(e.cloneMesh[n],e,t,i,r);if(e&&e.selectedMeshes)for(let t=0;t<e.selectedMeshes.length;++t)this._updateSelectedMesh(e.selectedMeshes[t]);return!0}_updateSelectedMesh(e){const t=e.geometry;if(!t.attributes.growthPlaneIndex){let e=new Float32Array(t.attributes.position.count).fill(0);t.setAttribute("growthPlaneIndex",new THREE.Float32BufferAttribute(e,1))}if(t.attributes.growthPlaneIndex.array.fill(this.animationIndex+1),t.attributes.growthPlaneIndex.needsUpdate=!0,e.material instanceof Array)for(let t=0;t<e.material.length;++t)this._updateMaterial(e.material[t]);else this._updateMaterial(e.material)}_updateCloneMesh(e,t,i,r,n){if(r)this._updateInstanceGeometry(e,this.animationIndex+1,n),this._updateMaterial(e.material);else{if(e.material instanceof Array)for(let t=0;t<e.material.length;++t)e.material[t]&&this._updateMaterial(e.material[t]);else this._updateMaterial(e.material);if(t.indexGroups){const r=t.indexGroups.get(i);this._updataGeometry(e,r,this.animationIndex+1)}else if(t._indicesGroup){const r=t._indicesGroup[i];if(Array.isArray(r))for(let r=0;r<t._indicesGroup[i].length;++r){const n=t._indicesGroup[i][r];this._updataGeometry(e,n,this.animationIndex+1)}}}}_updateInstanceMeshNodeDirectly(e,t){this._updateInstanceGeometry(e,this.animationIndex+1,t),this._updateMaterial(e.material)}_updateInstanceMeshNodeAsync(e,t){const i=this;return new Promise(((r,n)=>{i._updateInstanceGeometry(e,i.animationIndex+1,t),i._updateMaterial(e.material),r()}))}_updateBatchedMeshNodeDirectly(e,t){if(e.material instanceof Array)for(let t=0;t<e.material.length;++t)e.material[t]&&this._updateMaterial(e.material[t]);else this._updateMaterial(e.material);if(e.indexGroups){const i=e.indexGroups.get(t);this._updataGeometry(e,i,this.animationIndex+1)}else if(e._indicesGroup){const i=e._indicesGroup[t];if(Array.isArray(i))for(let i=0;i<e._indicesGroup[t].length;++i){const r=e._indicesGroup[t][i];this._updataGeometry(e,r,this.animationIndex+1)}}}_updateBatchedMeshNodeAsync(e,t){return new Promise((function(i,r){for(let t=0;t<e.material.length;++t)e.material[t]&&this._updateMaterial(e.material[t]);if(e.indexGroups){const i=e.indexGroups.get(t);this._updataGeometry(e,i,this.animationIndex+1)}else if(e._indicesGroup){const i=e._indicesGroup[t];if(Array.isArray(i))for(let i=0;i<e._indicesGroup[t].length;++i){const r=e._indicesGroup[t][i];this._updataGeometry(e,r,this.animationIndex+1)}}i()}))}_resetGeometry(e){const t=e.geometry;if(!t.attributes.growthPlaneIndex){let e=new Float32Array(t.attributes.position.count).fill(0);t.setAttribute("growthPlaneIndex",new THREE.Float32BufferAttribute(e,1))}}_resetInstanceGeometry(e){const t=e.geometry;if(!t.attributes.growthPlaneIndex){let e=new Float32Array(t.attributes.vState.count).fill(0);t.setAttribute("growthPlaneIndex",new THREE.InstancedBufferAttribute(e,1))}}_updateInstanceGeometry(e,t,i){this._resetInstanceGeometry(e);const r=e.geometry;r.attributes.growthPlaneIndex.array[i]=t,r.attributes.growthPlaneIndex.needsUpdate=!0}_updataGeometry(e,t,i){this._resetGeometry(e);const r=e.geometry;if("LineSegments"===e.type||"LineSegmentsEx"===e.type)if(t instanceof Map)for(const e of t.values()){const t=e.positionStart/3,n=e.positionCount/3;for(let e=t;e<t+n;++e)r.attributes.growthPlaneIndex.array[e]=i}else{const e=t.indexStart,n=t.indexCount;for(let t=e;t<e+n;++t)r.attributes.growthPlaneIndex.array[r.index.array[t]]=i}else if(t instanceof Map)for(const e of t.values()){const t=e.positionStart/3,n=e.positionCount/3;for(let e=t;e<t+n;++e)r.attributes.growthPlaneIndex.array[e]=i}else{const e=t.positionStart/3,n=t.positionCount/3;for(let t=e;t<e+n;++t)r.attributes.growthPlaneIndex.array[t]=i}r.attributes.growthPlaneIndex.needsUpdate=!0}_updateMaterial(e){e.defines||(e.defines={}),e.defines.GROWTH_ANIMATION||(e.defines.GROWTH_ANIMATION="",e.needsUpdate=!0),e.growthAnimationPlanes=this.manager.planeUniform.value,e.refreshUniforms()}_resetMaterial(e){e.growthAnimationPlanes=null,delete e.defines.GROWTH_ANIMATION,e.refreshUniforms()}_onProgressChanged(){for(let e=0;e<this.progressCallback.length;++e)this.progressCallback[e](this.newProgress);this.lastProgress=this.newProgress}_reset(){this.lastProgress=0,this.newProgress=0;const e=this.planeInfo.direction,t=this.planeInfo.range[0];this.plane.set(e.x,e.y,e.z,t)}_projectPlane(e,r,n){t.setComponents(-e.x,-e.y,-e.z,e.w);const a=r.matrixWorldInverse;i.identity();const s=(new THREE.Matrix3).getNormalMatrix(a);return t.applyMatrix4(a,s),t.normal.normalize(),n.x=t.normal.x,n.y=t.normal.y,n.z=t.normal.z,n.w=t.constant,n}_calculateClippingPlane(){for(let[t,i]of this.modelUserIds){const r=this.viewer.getScene().getMatrixGlobal();r.multiply(t.transformMatrix);if(!!t.tilesLoader){const n=t.tilesLoader.tileReader,a=t.getDescriptor(),s=t.tilesLoader.dataVersion;if("0.0.3"===s)for(let e=0;e<i.length;++e)a.getUserIdInfoCallback(i[e],(e=>{const i=e.userId,r=n.getUserIdDrawingBoxByIndex(i,t);r&&this.boundingBox.union(r)}));else if("0.0.2"===s||"0.0.1"===s)for(let t=0;t<i.length;++t){const n=a.getNodeInfosByUserId(i[t]);for(let t=0;t<n.length;++t){const i=n[t].boundingBox;if(!i)return;e.copy(i),e.applyMatrix4(r),this.boundingBox.union(e)}}}else for(let n=0;n<i.length;++n){const a=t.getNodeInfosByUserId(i[n]);for(const t of a){const i=t.boundingBox;i&&(e.copy(i),e.applyMatrix4(r),this.boundingBox.union(e))}}}let t=[0,0];if(!this.boundingBox.isEmpty()){const e=new THREE.Vector3;this.boundingBox.getSize(e),e.multiplyScalar(.05),t=this._getClippingPlaneRange(this.direction,this.boundingBox.clone().expandByVector(e))}const i=t[1]-t[0];this.planeInfo.direction=new THREE.Vector3(this.direction.x,this.direction.y,this.direction.z),this.planeInfo.range=t,this.planeInfo.speed=this.time?i/this.time:this.speed}_getClippingPlaneRange(e,t){const i=[new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.min.x,t.max.y,t.min.z),new THREE.Vector3(t.min.x,t.max.y,t.max.z),new THREE.Vector3(t.min.x,t.min.y,t.max.z),new THREE.Vector3(t.max.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z),new THREE.Vector3(t.max.x,t.min.y,t.max.z)],r=new THREE.Plane(e,0);let n=1/0,a=-1/0;for(let e=0;e<i.length;++e){const t=r.distanceToPoint(i[e]);a<t&&(a=t),n>t&&(n=t)}return[n,a]}_addProgress(e){if(this.planeInfo.speed){const t=this.planeInfo.range[1]-this.planeInfo.range[0];let i=t*this.lastProgress;return i+=this.planeInfo.speed/e,this.newProgress=i/t,i}return 0}}a.emptyObject=new n,r.GrowthAnimationObject=a}(),function(){let e=null;class t{constructor(){this.animationMap=new Map;for(let e=0;e<65535;++e)this.animationMap.set(e,null);this.animationCount=0}destroy(){this.animationMap=void 0}getAnimationMap(){return this.animationMap}createOne(e,t){this.animationCount>=65535&&console.error("Maximum number of animations exceeded.");for(let[i,n]of this.animationMap)if(!n){e.index=i;const n=new r.GrowthAnimationObject(e,t);return this.animationMap.set(i,n),++this.animationCount,n}return null}deleteOne(e){const t=e.animationIndex;null!==this.animationMap.get(t)&&(this.animationMap.set(t,null),--this.animationCount)}}r.GrowthAnimationManager=class{constructor(e){this.viewer=e,this.planeUniform={value:new THREE.DataTexture(new Float32Array(262144),256,256,THREE.RGBAFormat,THREE.FloatType),needsUpdate:!0},this.planeUniform.value.generateMipmaps=!1,this.planeUniform.value.magFilter=THREE.NearestFilter,this.planeUniform.value.minFilter=THREE.NearestFilter,this.animationPool=new t,this.animationId=null,this.lastTime=null,this.startTime=null,this.fps=60,this.processAnimationMapPromise=null,this.userIdAnimationCache=new Map,this.nodeChangedCallback=new Set;const i=this;this._onNodeInfoChanged=function(e,t,r,n){for(let[a,s]of i.userIdAnimationCache)a.getDescriptor()===e&&s.has(t._userId)&&s.get(t._userId).addUpdateNodeInfo(a,t,r,n)}}destroy(){this.viewer=void 0,this.planeUniform=void 0,this.animationPool.destroy(),this.animationPool=void 0,this.animationId&&clearInterval(this.animationId),this.animationId=null,this.lastTime=null,this.startTime=null,this.userIdAnimationCache=void 0,this.nodeChangedCallback=void 0,this._onNodeInfoChanged=void 0}needsUpdate(){this._timeTick();const e=this.animationPool.getAnimationMap();for(let[t,i]of e)if(i&&i.isAnimationStarted)return!0;return!1}_timeTick(){this.fps=60,null===this.startTime?(this.startTime=new Date,this.lastTime=new Date):(this.startTime=new Date,this.fps=1e3/(this.startTime-this.lastTime),this.lastTime=this.startTime)}distributeConditionsByModelId(e){let t={},i=this.viewer.modelManager.getModelIds(!0),r=function(e,r){e&&(e=e.toString(),i.indexOf(e)>=0&&(t[e]||(t[e]=[]),"[object Object]"===Object.prototype.toString.call(r)?t[e].push(r):"[object Array]"===Object.prototype.toString.call(r)&&(t[e]=t[e].concat(r))))};for(let t=0;t<e.length;t++){let i=e[t];if(i.hasOwnProperty("modelId")){r(i.modelId,i)}}return t}createGrowthAnimationObject(e){const t={viewer:this.viewer,time:e.time,speed:e.speed,direction:e.direction,loop:e.loop,modelUserIds:new Map};if(!this.viewer.webgl2Support)return r.GrowthAnimationObject.emptyObject;const i=this.distributeConditionsByModelId(e.conditions);for(let e in i){const r=this.viewer.modelManager.getModel(e),n=!!r.tilesLoader;if(n){if(!this.nodeChangedCallback.has(r)){r.getDescriptor().addOnNodeInfoChanged(this._onNodeInfoChanged),this.nodeChangedCallback.add(r)}}else this.viewer.modelManager.isRenderStateChanged()&&r.applyFilter();t.modelUserIds.has(r)||t.modelUserIds.set(r,[]);const a=[];for(let t=0;t<i[e].length;++t)for(let n in i[e][t])if("objectIds"===n)for(let r of i[e][t][n])a.push(r);else"objectData"===n&&a.push(...r.filter.getMatchIds(i[e][t][n]));for(let e=0;e<a.length;++e){const i=a[e];if(n){const e=r.tilesLoader.tileReader.getIndexByUserId(i);t.modelUserIds.get(r).push(e)}else t.modelUserIds.get(r).push(i)}}const n=this.animationPool.createOne(t,this);for(let[e,i]of t.modelUserIds){this.userIdAnimationCache.has(e)||this.userIdAnimationCache.set(e,new Map);const t=e.userIdAnimationMap;for(let r=0;r<i.length;++r)if(this.userIdAnimationCache.get(e).set(i[r],n),t){const e=n.animationIndex+1,a=Math.floor(e/256),s=e%256;t.image.data[4*i[r]]=s,t.image.data[4*i[r]+1]=a}t&&(t.needsUpdate=!0)}return n.isAnimationStarted=!0,n}removeGrowthAnimationObjectFromCache(e){for(let[t,i]of this.userIdAnimationCache)for(let[t,r]of i)e===r&&i.delete(r)}deleteGrowthAnimationObject(e){this.animationPool.deleteOne(e),0===this.animationPool.animationCount&&this._endLoop()}_update(){const e=this.animationPool.getAnimationMap(),t=this.planeUniform.value.image.data;for(let[t,i]of e)i&&i.boxNeedsUpdate&&i.update();for(let[i,r]of e)if(r){const e=new THREE.Vector4;r.getPlane(this.fps,e),t[4*i]=e.x,t[4*i+1]=e.y,t[4*i+2]=e.z,t[4*i+3]=e.w,this.planeUniform.value.needsUpdate=!0}this.viewer.render()}_startLoop(){null===this.animationId&&this._animate()}_endLoop(){this.viewer.render(),clearInterval(this.animationId),this.animationId=null,this.startTime=null,this.lastTime=null}_animate(){let e=this;this.animationId=setInterval((()=>{e._update()}),50)}static getInstance(){return e}static createInstance(t){return e||(e=new r.GrowthAnimationManager(t)),e}static destroyInstance(){e&&e.destroy(),e=null}}}(),function(){let e=null;r.TreeAnimationManager=class{constructor(e){this.viewer=e,this.trunkMeshArray=[],this.leavesMeshArray=[],this.isPlaying=!1,this.isPaused=!0,this.newPlay=!0,this.runTime=void 0,this.trunkLocalMinXYZ=[-1.40628,-1.78174,0],this.trunkLocalMaxXYZ=[1.71191,1.92082,7.17496],this.leavesLocalMinXYZ=[-1.86458,-2.40559,.47203],this.leavesLocalMaxXYZ=[2.3787,2.58268,7.58762]}destroy(){this._deleteTrunkDefinesMaterial(),this._deleteLeavesDefinesMaterial(),this.viewer=null,this.trunkMeshArray=null,this.leavesMeshArray=null,this.runTime=void 0,this.trunkLocalMinXYZ=null,this.trunkLocalMaxXYZ=null,this.leavesLocalMinXYZ=null,this.leavesLocalMaxXYZ=null}addTrunkMesh(e){this.trunkMeshArray.push(e)}addLeavesMesh(e){this.leavesMeshArray.push(e)}isEnable(){return this.isPlaying&&!this.isPaused}play(){this.isPlaying&&!this.isPaused||(this.isPlaying=!0,this.isPaused=!1,this.runTime=0)}stop(){this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this.newPlay=!0,this.runTime=0)}pause(){this.isPaused||(this.isPaused=!0,this.newPlay=!1)}proceed(){this.isPaused&&this.isPlaying&&(this.isPaused=!1)}update(){if(!this.isPlaying)return;this._update(.02)}_update(e){this.newPlay?this.newPlay=!1:this.runTime+=e,this._updateTrunkMaterial(),this._updateLeavesMaterial()}_updateTrunkMaterial(){for(let e=0;e<this.trunkMeshArray.length;e++){const t=this.trunkMeshArray[e];if(!0===t.visible&&t.parent&&!0===t.parent.visible){const e=t.geometry;e.boundingBox||e.computeBoundingBox();const i=e.boundingBox.min,n=e.boundingBox.max,a=t.material;a.uniforms.runTime.value=this.runTime,a.uniforms.minZ.value=i.z,a.uniforms.maxZ.value=n.z,a.uniforms.localMinZ.value=this.trunkLocalMinXYZ[2],a.uniforms.localMaxZ.value=this.trunkLocalMaxXYZ[2],a.uniforms.scaleX.value=(n.x-i.x)/(this.trunkLocalMaxXYZ[0]-this.trunkLocalMinXYZ[0]),a.uniforms.scaleY.value=(n.y-i.y)/(this.trunkLocalMaxXYZ[1]-this.trunkLocalMinXYZ[1]),r.Utils.defined(a.defines.TREE_TRUNK_ANIMATION)||(a.defines.TREE_TRUNK_ANIMATION="",a.needsUpdate=!0)}}}_updateLeavesMaterial(){for(let e=0;e<this.leavesMeshArray.length;e++){const t=this.leavesMeshArray[e];if(!0===t.visible&&t.parent&&!0===t.parent.visible){const e=t.geometry;e.boundingBox||e.computeBoundingBox();const i=e.boundingBox.min,n=e.boundingBox.max,a=t.material;a.uniforms.runTime.value=this.runTime,a.uniforms.minZ.value=i.z,a.uniforms.maxZ.value=n.z,a.uniforms.localMinZ.value=this.leavesLocalMinXYZ[2],a.uniforms.localMaxZ.value=this.leavesLocalMaxXYZ[2],a.uniforms.scaleX.value=(n.x-i.x)/(this.leavesLocalMaxXYZ[0]-this.leavesLocalMinXYZ[0]),a.uniforms.scaleY.value=(n.y-i.y)/(this.leavesLocalMaxXYZ[1]-this.leavesLocalMinXYZ[1]),r.Utils.defined(a.defines.TREE_LEAVES_ANIMATION)||(a.defines.TREE_LEAVES_ANIMATION="",a.needsUpdate=!0)}}}_deleteTrunkDefinesMaterial(){for(let e=0;e<this.trunkMeshArray.length;e++)delete this.trunkMeshArray[e].material.defines.TREE_TRUNK_ANIMATION}_deleteLeavesDefinesMaterial(){for(let e=0;e<this.leavesMeshArray.length;e++)delete this.leavesMeshArray[e].material.defines.TREE_LEAVES_ANIMATION}static getInstance(){return e}static createInstance(t){return e||(e=new r.TreeAnimationManager(t)),e}static destroyInstance(){e&&e.destroy(),e=null}}}(),r.SceneStateHelper=function(e){this.selectionSet={},this.selectionMaterial=r.MaterialUtil.createHighlightMaterial(),this.selectionMaterial.colorState=r.EnumShaderColorState.SELECT,this.selectionMaterial.name="selection",this.selectionMaterial.setDisableHemiLight(!0),this.selectionMaterial.refreshUniforms(),this.hoverId=void 0,this.hoverMaterialDefaultParams={color:14540253,opacity:.9,transparent:!0,side:THREE.DoubleSide},this.hoverMaterial=r.MaterialUtil.createStandardMaterial(this.hoverMaterialDefaultParams),this.hoverMaterial.setDisableHemiLight(!0),this.hoverMaterial.name="hover",this.modelManager=e,this.blinkComponentIdsMap={},this.blinkComponentIdsDetailMap={},this.blinkMaterialMap={};var t=this;this.filter=e.getFilter(),this.filter.setObserverForSceneState((function(i,r){t.removeSelection(i,r),t.clearBlinkComponentsById(i,r),e.viewer.render()})),this.phongHoverMaterial=new THREE.MeshPhongMaterial(this.hoverMaterialDefaultParams),this.phongSelectionMaterial=new THREE.MeshPhongMaterial(r.GlobalData.SelectionColor)},r.SceneStateHelper.prototype={constructor:r.SceneStateHelper,destroy:function(){this.selectionSet=null,this.blinkComponentIdsMap=null,this.blinkComponentIdsDetailMap=null,this.blinkMaterialMap=null,this.modelManager=null,this.selectionMaterial.destroy(),this.selectionMaterial=null,this.hoverMaterial.destroy(),this.hoverMaterial=null,this.phongHoverMaterial.dispose(),this.phongHoverMaterial=null,this.phongSelectionMaterial.dispose(),this.phongSelectionMaterial=null,this._isSelectionsChanged=!1},isSelectionsChanged(){return this._isSelectionsChanged},setSelectionsChanged(e){this._isSelectionsChanged=e},_dispatchChangeEvent:function(){var e=this.getSelectionMap();this.modelManager.dispatchEvent({type:r.EVENTS.ON_SELECTION_CHANGED,selectionList:e})},getSelectionMap:function(){var e={};for(var t in this.selectionSet)e[t]=[...this.selectionSet[t].keys()];return e},clearSelection:function(e,t){var i=!1;if(t=r.Utils.defaultValue(t,!0),void 0===e){var n=[];for(var a in this.selectionSet)i=!1,0!==this.getSelectionSet(a).size&&(i=!0),i&&n.push(a);if(n.length){for(var s=0,o=n.length;s<o;s++)this.selectionSet[n[s]].clear(),this.modelManager.clearSelection(n[s]);t&&this._dispatchChangeEvent()}}else 0!==this.getSelectionSet(e).size&&(i=!0),i&&(this.selectionSet[e].clear(),this.modelManager.clearSelection(e),t&&this._dispatchChangeEvent());this._isSelectionsChanged=i},addSelection:function(e,t){if(!e||e.length<1)return;var i=[],n=!1;let a=!1;var s,o=this.modelManager,l=this.filter;if(void 0===t){for(var d={},h=o.getModelIds(),c=[],u=0,p=h.length;u<p;u++){var m=h[u];s=this.getSelectionSet(m),n=!1;for(var f=e.length-1;f>=0;f--){var g=e[f];o.isUserIdExist(g,m)&&(!s.has(g)&&l.isComponentActive(g,m)&&(s.set(g,m),n=!0,a=!0),d[g]=!0)}n&&c.push(m)}for(f=e.length-1;f>=0;f--){d[g=e[f]]||i.push(g)}if(i.length>0&&o.dispatchEvent({type:r.EVENTS.ON_SELECTION_FAILED,failedId:i}),s){for(var v=0,y=c.length;v<y;v++)this.modelManager.applySelection(c[v]);this._dispatchChangeEvent()}}else{s=this.getSelectionSet(t);for(f=e.length-1;f>=0;f--){g=e[f];o.isUserIdExist(g,t)?!s.has(g)&&l.isComponentActive(g,t)&&(s.set(g,t),n=!0,a=!0):i.push(g)}i.length>0&&o.dispatchEvent({type:r.EVENTS.ON_SELECTION_FAILED,failedId:i}),s&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}1==a&&(this._isSelectionsChanged=!0)},setSelection:function(e,t){if(e&&!(e.length<1))if(void 0===t){for(var i in this.selectionSet){let e=this.selectionSet[i].size>0;delete this.selectionSet[i],e&&this.modelManager.applySelection(i)}this.addSelection(e)}else this.selectionSet[t]=new Map,this.addSelection(e,t)},removeSelection:function(e,t){if(e&&!(e.length<1)){var i=!1;if(void 0===t){var r=[];for(var n in this.selectionSet){var a=this.getSelectionSet(n);i=!1;for(var s=0,o=e.length;s<o;++s){var l=e[s];a.has(l)&&(a.delete(l),i=!0)}i&&r.push(n)}if(r.length){for(s=0,o=r.length;s<o;s++)this.modelManager.applySelection(r[s]);this._dispatchChangeEvent()}}else{for(a=this.getSelectionSet(t),s=0,o=e.length;s<o;++s){l=e[s];a.has(l)&&(a.delete(l),i=!0)}i&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}this._isSelectionsChanged=i}},getSelection:function(e){var t=[];if(void 0===e)for(var i in this.selectionSet){var r=this.getSelectionSet(i);t=[...t,...r.keys()]}else t=[...this.getSelectionSet(e).keys()];return t},getSelectionWithModelId:function(e){const t=[];if(void 0===e)for(var i in this.selectionSet){var r=this.getSelectionSet(i);for(const[e,n]of r)i===n&&t.push({modelId:i,selectedId:e})}else selList=this.getSelectionSet(e);return t},hasSelection:function(e){var t=!1;if(void 0===e){for(var i in this.selectionSet)if(this.getSelectionSet(i).size>0&&(t=!0),t)break}else this.getSelection(e).size>0&&(t=!0);return t},getSelectionSet:function(e){if(void 0===e){var t=new Map;for(var i in this.selectionSet)t=new Map([...t,...this.getSelectionSet(i)]);return t}return void 0===this.selectionSet[e]&&(this.selectionSet[e]=new Map),this.selectionSet[e]},getSelectionSetWithModelId:function(){return this.selectionSet},isSelected:function(e,t){var i,r=!1;if(void 0===t){for(var n in this.selectionSet)if((i=this.selectionSet[n])&&i.has(e)){r=!0;break}}else(i=this.selectionSet[t])&&i.has(e)&&(r=!0);return r},setHoverId:function(e,t){this.hoverId=e,this.modelManager.applyHover(t)},clearHover:function(e){this.hoverId=void 0,this.modelManager.clearHover(e)},getHoverMaterial:function(e){let t=e&&e.isMeshPhongMaterial?this.phongHoverMaterial.clone():this.hoverMaterial.clone();if(e&&e.hasOwnProperty("color")){var i=e.color.clone();t.color.setHex(i.getHex()),void 0!==e.opacity?t.opacity=e.opacity:t.opacity=this.hoverMaterialDefaultParams.opacity,void 0!==e.transparent?t.transparent=e.transparent:t.transparent=this.hoverMaterialDefaultParams.transparent,void 0!==e.side?t.side=e.side:t.side=this.hoverMaterialDefaultParams.side,void 0!==e.metalness&&(t.metalness=e.metalness),void 0!==e.roughness&&(t.roughness=e.roughness),void 0!==e.bumpMap&&(t.bumpMap=e.bumpMap),void 0!==e.alphaMap&&(t.alphaMap=e.alphaMap),void 0!==e.emissiveMap&&(t.emissiveMap=e.emissiveMap),void 0!==e.envMap&&(t.envMap=e.envMap),void 0!==e.envMapIntensity&&(t.envMapIntensity=e.envMapIntensity),void 0!==e.map&&null!==e.map&&(t.map=e.map),!0===e.useCompressedColor&&(t.defines.CCOLOR="",t.useCompressedColor=!0),!0===e.vertexColors&&(t.vertexColors=!0),!0===e.useCompressedNormal&&(t.defines.CNORMAL="",t.useCompressedNormal=!0),r.Utils.isDefined(e.useCompressedUv)&&!0===e.useCompressedUv&&(t.uvCenter=e.uvCenter,t.uvHalfExtent=e.uvHalfExtent,t.defines.USE_COMPRESS_UV="",t.useCompressedUv=!0),t.opacity=r.MaterialUtil.getHoverOpacity(t.opacity),t.transparent=!0,t.needsUpdate=!0}return t.refreshUniforms(),t},getHoverColorByMaterial:function(e){var t=void 0!==e.opacity?e.opacity:this.hoverMaterialDefaultParams.opacity;if(t=r.MaterialUtil.getHoverOpacity(t),!e.hasOwnProperty("color"))return{rgbaColor:[this.hoverMaterial.color.r,this.hoverMaterial.color.g,this.hoverMaterial.color.b,t],transparent:true};var i=e.color.clone();return{rgbaColor:[i.r,i.g,i.b,t],transparent:true}},setSelectionColor:function(e,t){var i=this.selectionMaterial.color,r=this.selectionMaterial.opacity;t=null==t?r:t,"0x"+i.getHexString()==e&&r==t||(this.selectionMaterial.color.setHex(e),t&&(this.selectionMaterial.opacity=t),this.selectionMaterial.needsUpdate=!0)},getSelectionMaterial:function(){return this.selectionMaterial.clone()},getModelIdByUserId:function(e){var t,{modelId:i,objectId:r}=this.modelManager.filterHelper.distributeId(e);return i?(t=i,e=r):this.modelManager.modelCollection.some((i=>{if(i.isUserIdExist(e))return t=i.id,!0})),t},addBlinkComponentsByDetail:function(e,t,i,n){void 0===this.blinkComponentIdsDetailMap[n]&&(this.blinkComponentIdsDetailMap[n]={},this.blinkComponentIdsDetailMap[n].detail=i,this.blinkComponentIdsDetailMap[n].enable=!0,this.blinkComponentIdsDetailMap[n].materials=[],this.blinkComponentIdsDetailMap[n].models=[]);let a={};a.modelId=t,a.ids=e,this.addBlinkComponentsById(e,t,i),a.isBimtiles=!1;const s=this.modelManager.getModel(t);s instanceof r.BimTilesModel&&(a.isBimtiles=!0,e.map((e=>{s.blinkTimesMap[e]=0})),delete this.blinkComponentIdsDetailMap[n].materials),this.blinkComponentIdsDetailMap[n].models.push(a);let o=[];s.collectBlinkedMaterial(e,o),this.blinkComponentIdsDetailMap[n].materials&&this.blinkComponentIdsDetailMap[n].materials.push(...o)},setBlinkComponentsById:function(e,t,i){if(e&&0!==e.length){for(var r={},n=e.length-1;n>=0;n--){var a=e[n];r[t=t||this.getModelIdByUserId(a)]||(this.blinkComponentIdsMap[t]={},r[t]=!0),this.filter.isComponentActive(a,t)&&(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},this.blinkComponentIdsMap[t][a]=i||{})}this.modelManager.blinkManager.applyBlink(t)}},addBlinkComponentsById:function(e,t,i){if(e&&e.length){for(var r=!1,n=e.length-1;n>=0;n--){var a=e[n];t=t||this.getModelIdByUserId(a),this.blinkComponentIdsMap[t]&&this.blinkComponentIdsMap[t][a]||!this.filter.isComponentActive(a,t)||(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},r=!0),this.blinkComponentIdsMap[t]&&(this.blinkComponentIdsMap[t][a]=i||{})}r&&this.modelManager.blinkManager.applyBlink(t)}},clearBlinkComponentsById:function(e,t){if(e&&e.length){for(var i=!1,r=0,n=e.length;r<n;++r){var a=e[r];t=t||this.getModelIdByUserId(a),this.blinkComponentIdsMap[t]&&this.blinkComponentIdsMap[t][a]&&(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},delete this.blinkComponentIdsMap[t][a],i=!0)}i&&this.modelManager.blinkManager.applyBlink(t)}},clearBlinkComponentsByDetail:function(e){const t=this.blinkComponentIdsDetailMap[e];if(t){for(const e of t.models)this.clearBlinkComponentsById(e.ids,e.modelId);this.modelManager.blinkManager.clearTime(e),delete this.blinkComponentIdsDetailMap[e]}},enableBlinkComponentsByDetail(e,t){if(!this.blinkComponentIdsDetailMap[e])return;this.blinkComponentIdsDetailMap[e].enable=t;const i=this.blinkComponentIdsDetailMap[e].materials;if(i)i.map((e=>{e.resetBlinkUniformValue()}));else{this.blinkComponentIdsDetailMap[e].models}},clearAllBlinkComponents:function(e){var t=!1,i=this.blinkComponentIds;if(r.Utils.isOwnEmptyObject(i),e){var n=this.blinkComponentIdsMap[e];r.Utils.isOwnEmptyObject(n)||(t=!0,this.blinkComponentIdsMap[e]={})}else t=!0,Object.keys(this.blinkComponentIdsMap).forEach((e=>this.blinkComponentIdsMap[e]=[]));t&&this.modelManager.blinkManager.clearBlink(e)},getBlinkComponents:function(e){if(e)return Object.keys(this.blinkComponentIdsMap[e]||{});var t=[];return Object.keys(this.blinkComponentIdsMap).forEach((e=>t=t.concat(this.blinkComponentIdsMap[e]))),t},getBlinkComponentsIdMap:function(e){return this.modelManager.blinkManager.getBlinkEnabled()?e?this.blinkComponentIdsMap[e]||{}:this.blinkComponentIdsMap:null},getBlinkComponentsColor:function(e,t){if(this.blinkComponentIdsMap[e]&&this.blinkComponentIdsMap[e][t]&&this.blinkComponentIdsMap[e][t].color){const i=this.blinkComponentIdsMap[e][t].color;return new THREE.Vector4(i.red/255,i.green/255,i.blue/255,i.alpha)}},getBlinkComponentIdsDetailMap:function(){return this.modelManager.blinkManager.getBlinkEnabled()?this.blinkComponentIdsDetailMap:null},getBlinkMaterial:function(e,t){return this.blinkMaterialMap[t]&&this.blinkMaterialMap[t][e.uuid]||(void 0===this.blinkMaterialMap[t]&&(this.blinkMaterialMap[t]={}),this.blinkMaterialMap[t][e.uuid]=r.MaterialUtil.getBlinkMaterial(e,this.modelManager.blinkManager.getBlinkColor(t))),this.blinkMaterialMap[t][e.uuid]},getBlinkMaterialV3:function(e,t){return this.blinkMaterialMap[t]&&this.blinkMaterialMap[t][e.uuid]||(void 0===this.blinkMaterialMap[t]&&(this.blinkMaterialMap[t]={}),this.blinkMaterialMap[t][e.uuid]=r.MaterialUtil.getBlinkMaterialV3(e,this.modelManager.blinkManager.getBlinkColor(t))),this.blinkMaterialMap[t][e.uuid]}},r.TimeConstants={SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,MINUTES_PER_HOUR:60,HOURS_PER_DAY:24,SECONDS_PER_HOUR:3600,MINUTES_PER_DAY:1440,SECONDS_PER_DAY:86400,DAYS_PER_JULIAN_CENTURY:36525,PICOSECOND:1e-9,MODIFIED_JULIAN_DATE_DIFFERENCE:2400000.5},function(){var e;function t(e,t){t=r.JulianDate.addSeconds(e,32.184,t);var i,n=r.JulianDate.totalDays(t)-2451545;return t=r.JulianDate.addSeconds(t,(i=6.239996+.0172019696544*n,.001657*Math.sin(i+.01671*Math.sin(i))),t)}var i=r.Math.RADIANS_PER_DEGREE,n=r.Math.RADIANS_PER_ARCSECOND,a=new THREE.Matrix3;function s(e,t,i,n,s,l,d){if(i<0&&(i=-i,s+=Math.PI),i<0||i>Math.PI)throw new Error("The inclination is out of range. Inclination must be greater than or equal to zero and less than or equal to Pi radians.");var h=e*(1-t),c=n-s,u=s,p=function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");return function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");var i=Math.floor(e/r.Math.TWO_PI);e-=i*r.Math.TWO_PI;var n=Math.cos(e)-t,a=Math.sin(e)*Math.sqrt(1-t*t),s=Math.atan2(a,n);s=r.Math.zeroToTwoPi(s),e<0&&(s-=r.Math.TWO_PI);return s+=i*r.Math.TWO_PI}(function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");var i,n=Math.floor(e/r.Math.TWO_PI),a=(e-=n*r.Math.TWO_PI)+t*Math.sin(e)/(1-Math.sin(e+t)+Math.sin(e)),s=Number.MAX_VALUE;for(i=0;i<50&&Math.abs(s-a)>o;++i){a=(s=a)-(s-t*Math.sin(s)-e)/(1-t*Math.cos(s))}if(i>=50)throw new Error("Kepler equation did not converge");return s=a+n*r.Math.TWO_PI}(e,t),t)}(l-n,t),m=function(e,t){if(e<0)throw new Error("eccentricity cannot be negative.");if(e<=t)return"Circular";if(e<1-t)return"Elliptical";if(e<=1+t)return"Parabolic";return"Hyperbolic"}(t,0);if("Hyperbolic"===m&&Math.abs(r.Math.negativePiToPi(p))>=Math.acos(-1/t))throw new Error("The true anomaly of the hyperbolic orbit lies outside of the bounds of the hyperbola.");!function(e,t,i,n){if(t<0||t>Math.PI)throw new Error("inclination out of range");var a=Math.cos(e),s=Math.sin(e),o=Math.cos(t),l=Math.sin(t),d=Math.cos(i),h=Math.sin(i);r.Utils.defined(n)||(n=new THREE.Matrix3);n.set(d*a-h*s*o,-d*s-h*a*o,h*l,h*a+d*s*o,-h*s+d*a*o,-d*l,s*l,a*l,o)}(c,i,u,a);var f=h*(1+t),g=Math.cos(p),v=Math.sin(p),y=1+t*g;if(y<=r.Math.Epsilon10)throw new Error("elements cannot be converted to cartesian");var M=f/y;return r.Utils.defined(d)?(d.x=M*g,d.y=M*v,d.z=0):d=new THREE.Vector3(M*g,M*v,0),d.applyMatrix3(a)}var o=r.Math.EPSILON8;var l,d=100.46645683*i,h=1295977422.83429*n;var c;function u(a,o){return o=function(a,o){t(a,l);var d=(l.dayNumber-e.dayNumber+(l.secondsOfDay-e.secondsOfDay)/r.TimeConstants.SECONDS_PER_DAY)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY,h=d*d,c=h*d,u=c*d,p=383397.7725+.004*d,m=.055545526-16e-9*d,f=5.15668983*i,g=-8e-5*d+.02966*h-42e-6*c-13e-8*u,v=83.35324312*i,y=14643420.2669*d-38.2702*h-.045047*c+21301e-8*u,M=125.04455501*i,E=-6967919.3631*d+6.3602*h+.007625*c-3586e-8*u,x=218.31664563*i,_=1732559343.4847*d-6.391*h+.006588*c-3169e-8*u,b=297.85019547*i+n*(1602961601.209*d-6.3706*h+.006593*c-3169e-8*u),I=134.96340251*i+n*(1717915923.2178*d+31.8792*h+.051635*c-2447e-7*u),T=357.52910918*i+n*(129596581.0481*d-.5532*h+136e-6*c-1149e-8*u),S=310.17137918*i-n*(6967051.436*d+6.2068*h+.007618*c-3219e-8*u),C=2*b,w=4*b,R=6*b,B=2*I,A=3*I,P=4*I,L=2*(93.27209062*i+n*(1739527262.8478*d-12.7512*h-.001037*c+417e-8*u));p+=3400.4*Math.cos(C)-635.6*Math.cos(C-I)-235.6*Math.cos(I)+218.1*Math.cos(C-T)+181*Math.cos(C+I),m+=.014216*Math.cos(C-I)+.008551*Math.cos(C-B)-.001383*Math.cos(I)+.001356*Math.cos(C+I)-.001147*Math.cos(w-A)-914e-6*Math.cos(w-B)+869e-6*Math.cos(C-T-I)-627e-6*Math.cos(C)-394e-6*Math.cos(w-P)+282e-6*Math.cos(C-T-B)-279e-6*Math.cos(b-I)-236e-6*Math.cos(B)+231e-6*Math.cos(w)+229e-6*Math.cos(R-P)-201e-6*Math.cos(B-L),g+=486.26*Math.cos(C-L)-40.13*Math.cos(C)+37.51*Math.cos(L)+25.73*Math.cos(B-L)+19.97*Math.cos(C-T-L),y+=-55609*Math.sin(C-I)-34711*Math.sin(C-B)-9792*Math.sin(I)+9385*Math.sin(w-A)+7505*Math.sin(w-B)+5318*Math.sin(C+I)+3484*Math.sin(w-P)-3417*Math.sin(C-T-I)-2530*Math.sin(R-P)-2376*Math.sin(C)-2075*Math.sin(C-A)-1883*Math.sin(B)-1736*Math.sin(R-5*I)+1626*Math.sin(T)-1370*Math.sin(R-A),E+=-5392*Math.sin(C-L)-540*Math.sin(T)-441*Math.sin(C)+423*Math.sin(L)-288*Math.sin(B-L),_+=-3332.9*Math.sin(C)+1197.4*Math.sin(C-I)-662.5*Math.sin(T)+396.3*Math.sin(I)-218*Math.sin(C-T);var O=2*S,D=3*S;g+=46.997*Math.cos(S)*d-.614*Math.cos(C-L+S)*d+.614*Math.cos(C-L-S)*d-.0297*Math.cos(O)*h-.0335*Math.cos(S)*h+.0012*Math.cos(C-L+O)*h-16e-5*Math.cos(S)*c+4e-5*Math.cos(D)*c+4e-5*Math.cos(O)*c;var N=2.116*Math.sin(S)*d-.111*Math.sin(C-L-S)*d-.0015*Math.sin(S)*h;return y+=N,_+=N,E+=-520.77*Math.sin(S)*d+13.66*Math.sin(C-L+S)*d+1.12*Math.sin(C-S)*d-1.06*Math.sin(L-S)*d+.66*Math.sin(O)*h+.371*Math.sin(S)*h-.035*Math.sin(C-L+O)*h-.015*Math.sin(C-L+S)*h+.0014*Math.sin(S)*c-.0011*Math.sin(D)*c-9e-4*Math.sin(O)*c,s(p*=1e3,m,f+g*n,v+y*n,M+E*n,x+_*n,o)}(a,o),o.multiplyScalar(-.01215058143522694)}var p=new THREE.Vector3;r.Simon1994PlanetaryPositions=class{constructor(){}static computeSunPositionInEarthInertialFrame(a,o){return r.Utils.defined(a)||(a=r.JulianDate.now()),r.Utils.defined(o)||(o=new THREE.Vector3),c||(c=new THREE.Matrix3).set(1.0000000000000002,5619723173785822e-31,4690511510146299e-34,-5154129427414611e-31,.9174820620691819,-.39777715593191376,-223970096136568e-30,.39777715593191376,.9174820620691819),p=function(a,o){l||(l=new r.JulianDate(0,0,r.TimeStandard.TAI)),t(a,l),e||(e=new r.JulianDate(2451545,0,r.TimeStandard.TAI));var c=(l.dayNumber-e.dayNumber+(l.secondsOfDay-e.secondsOfDay)/r.TimeConstants.SECONDS_PER_DAY)/(10*r.TimeConstants.DAYS_PER_JULIAN_CENTURY),u=.3595362*c,p=149598022260.7121+957426.3679999999*Math.cos(16002*u)+-2243968.05*Math.sin(16002*u)+-2273887.624*Math.cos(21863*u)+-688150.202*Math.sin(21863*u)+927506.794*Math.cos(32004*u)+1017265.516*Math.sin(32004*u)+-119678.29599999999*Math.cos(10931*u)+807828.498*Math.sin(10931*u)+478713.18399999995*Math.cos(14529*u)+209437.01799999998*Math.sin(14529*u)+-613351.267*Math.cos(16368*u)+359034.888*Math.sin(16368*u)+284235.953*Math.cos(15318*u)+-418874.03599999996*Math.sin(15318*u)+-164557.657*Math.cos(32794*u)+329115.314*Math.sin(32794*u),m=d+h*c+-325e-7*Math.cos(10*u)+-105e-7*Math.sin(10*u)+-322e-7*Math.cos(16002*u)+-137e-7*Math.sin(16002*u)+-7899999999999999e-21*Math.cos(21863*u)+258e-7*Math.sin(21863*u)+23199999999999998e-21*Math.cos(10931*u)+35e-7*Math.sin(10931*u)+-5199999999999999e-21*Math.cos(1473*u)+-11599999999999999e-21*Math.sin(1473*u)+97e-7*Math.cos(32004*u)+-88e-7*Math.sin(32004*u)+55e-7*Math.cos(4387*u)+-112e-7*Math.sin(4387*u)+-41e-7*Math.cos(73*u)+-8e-6*Math.sin(73*u);return s(p,.0167086342-.0004203654*c,469.97289*n*c,102.93734808*i+11612.3529*n*c,174.87317577*i-8679.27034*n*c,m,o)}(a,p),o.copy(p),o.negate(),u(a,p),o.sub(p),o.applyMatrix3(c),o}}}(),function(){var e,t={UTC:0,TAI:1};class i{constructor(e,t){this.julianDate=e,this.offset=t}}function n(e,t,i){var n=t/r.TimeConstants.SECONDS_PER_DAY|0;return e+=n,(t-=r.TimeConstants.SECONDS_PER_DAY*n)<0&&(e--,t+=r.TimeConstants.SECONDS_PER_DAY),i.dayNumber=e,i.secondsOfDay=t,i}function a(e,t){return o.compare(e.julianDate,t.julianDate)}function s(t){e||(e=new i),e.julianDate=t;var n=o.leapSeconds,s=r.Utils.binarySearch(n,e,a);s<0&&(s=~s),s>=n.length&&(s=n.length-1);var l=n[s].offset;s>0&&(o.secondsDifference(n[s].julianDate,t)>l&&(l=n[--s].offset));o.addSeconds(t,l,t)}class o{constructor(e,i,a){this.dayNumber=void 0,this.secondsOfDay=void 0,e=r.Utils.defaultValue(e,0),i=r.Utils.defaultValue(i,0),a=r.Utils.defaultValue(a,t.UTC);var o=0|e;n(o,i+=(e-o)*r.TimeConstants.SECONDS_PER_DAY,this),a===t.UTC&&s(this)}static compare(e,t){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");var i=e.dayNumber-t.dayNumber;return 0!==i?i:e.secondsOfDay-t.secondsOfDay}static secondsDifference(e,t){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");return(e.dayNumber-t.dayNumber)*r.TimeConstants.SECONDS_PER_DAY+(e.secondsOfDay-t.secondsOfDay)}static addSeconds(e,t,i){if(!r.Utils.defined(e))throw new Error("julianDate is required.");if(!r.Utils.defined(t))throw new Error("seconds is required.");if(!r.Utils.defined(i))throw new Error("result is required.");return n(e.dayNumber,e.secondsOfDay+t,i)}static fromDate(e,i){if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("date must be a valid JavaScript Date.");var a=function(e,t,i,n,a,s,o){var l=(t-14)/12|0,d=e+4800+l,h=(1461*d/4|0)+(367*(t-2-12*l)/12|0)-(3*((d+100)/100|0)/4|0)+i-32075;(n-=12)<0&&(n+=24);var c=s+(n*r.TimeConstants.SECONDS_PER_HOUR+a*r.TimeConstants.SECONDS_PER_MINUTE+o*r.TimeConstants.SECONDS_PER_MILLISECOND);return c>=43200&&(h-=1),[h,c]}(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds());return r.Utils.defined(i)?(n(a[0],a[1],i),s(i),i):new o(a[0],a[1],t.UTC)}static now(e){return o.fromDate(new Date,e)}static computeTaiMinusUtc(t){e.julianDate=t;var i=o.leapSeconds,n=r.Utils.binarySearch(i,e,a);return n<0&&(n=~n,--n<0&&(n=0)),i[n].offset}static totalDays(e){if(!r.Utils.defined(e))throw new Error("julianDate is required.");return e.dayNumber+e.secondsOfDay/r.TimeConstants.SECONDS_PER_DAY}}o.leapSeconds=[new i(new o(2441317,43210,t.TAI),10),new i(new o(2441499,43211,t.TAI),11),new i(new o(2441683,43212,t.TAI),12),new i(new o(2442048,43213,t.TAI),13),new i(new o(2442413,43214,t.TAI),14),new i(new o(2442778,43215,t.TAI),15),new i(new o(2443144,43216,t.TAI),16),new i(new o(2443509,43217,t.TAI),17),new i(new o(2443874,43218,t.TAI),18),new i(new o(2444239,43219,t.TAI),19),new i(new o(2444786,43220,t.TAI),20),new i(new o(2445151,43221,t.TAI),21),new i(new o(2445516,43222,t.TAI),22),new i(new o(2446247,43223,t.TAI),23),new i(new o(2447161,43224,t.TAI),24),new i(new o(2447892,43225,t.TAI),25),new i(new o(2448257,43226,t.TAI),26),new i(new o(2448804,43227,t.TAI),27),new i(new o(2449169,43228,t.TAI),28),new i(new o(2449534,43229,t.TAI),29),new i(new o(2450083,43230,t.TAI),30),new i(new o(2450630,43231,t.TAI),31),new i(new o(2451179,43232,t.TAI),32),new i(new o(2453736,43233,t.TAI),33),new i(new o(2454832,43234,t.TAI),34),new i(new o(2456109,43235,t.TAI),35),new i(new o(2457204,43236,t.TAI),36),new i(new o(2457754,43237,t.TAI),37)],r.TimeStandard=t,r.LeapSecond=i,r.JulianDate=o}(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Plane,n=(new THREE.Frustum,new THREE.Box3),a=new THREE.Box3,s=new THREE.Matrix4,o=new THREE.Matrix4,l=!0;r.Viewer=class{constructor(e={}){this._options=r.Utils.defaultValue(e,{}),this._initEarth=r.Utils.defaultValue(this._options.setupEarth,!1),this._earthResource=this._options.earthResource,this.globalRendering=this._initEarth,this._demOptions=r.Utils.defaultValue(this._options.demOptions,{});this._baseGeoCoordinates=r.Utils.defaultValue(this._options.initialGeoCoordinates,{lon:116.40016,lat:39.91645,height:100}),this._staticResourcesHost=r.Utils.defaultValue(this._options.staticResourcesHost,"../../resources"),this._dampingOpts=r.Utils.defaultValue(this._options.damping,{}),this.domElement=null,this.camera=null,this.gisMode=r.Utils.defaultValue(this._options.gisMode,!1),this.callbacks={},this.tmpBox=new THREE.Box3,this.enableCameraNearFar=!0,this.currentHomeView=r.EnumStandardView.ISO,this.initialView=r.EnumStandardView.ISO,this.modelManager=new r.ModelManager(this),this.editorManager=new r.EditorManager,this.inputStatusMonitor=new r.InputStatusMonitor(this.editorManager),this.viewshedManager=new r.ViewshedManager(this),this.videoCastManager=new r.VideoCastManager(this),r.GroundPrimitiveManager.createInstance(this),r.GroundDrawingManager.createInstance(this),this.growthAnimationManager=r.GrowthAnimationManager.createInstance(this),r.GIS.ApproximateTerrainHeights._viewer=this,this.isRecalculationPlanes=!1,this.calculationPlanesBind=this.calculationPlanes.bind(this),this.addRenderFinishedCallback(this.calculationPlanesBind),this.transitionAnimationState=!0,this.animator=new r.CameraAnimator,this.animator.setDuration(1e3),this.IBLManager=new r.IBLManager(this),this.TextureManager=new r.TextureManager(this),this.rendererManager=new r.RendererManager(this),this.terrainOperationManager=new r.TerrainOperationManager(this),this.holesManager=new r.HolesManager(this),this.refleRefraManager=new r.RefleRefraManager(this),this.scissorViewportManager=new r.ScissorViewportManager(this),this.cameraStateWithFrustum=!1,this.filterHelper=this.modelManager.getFilterHelper(),this.ground=null,this.basePointPositionOnLonLat=null,this.virtualEarthComplete=!0,this._setupEarth(!0),this.minimumFPS=4,this.clientSize=new THREE.Vector2,this.webgl2Support=!0,this.showTileType=r.EnumShowTileType.All,this._foveatedConeLimit={priorityEnabled:r.Utils.defaultValue(e.foveatedConePriority,!0),foveatedConeFactor:r.Utils.defined(e.foveatedConeFactor)?r.Math.clamp(e.foveatedConeFactor,0,1):.1,foveatedSseRelaxation:r.Utils.defined(e.foveatedSseRelaxation)?e.foveatedSseRelaxation:0,degradedFactor:r.Utils.defined(e.degradedFactor)?r.Math.clamp(e.degradedFactor,0,1):.1},r.RequstPoolLoader.init(),r.EnableStorage=this._options.enableStorage,window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB||(r.EnableStorage=!1),this.packingMaterialTexture=null,this.curEnvironmentCubeUrl=void 0,this.versionMismatchEvent=e=>{console.log(`[BIMFACE ERROR]:The version of model ${e.modelId} is not available in sdk，please update the jssdk`)},this.registerEventListener(r.EVENTS.ON_LOAD_INVALID_MODEL_VERSION,this.versionMismatchEvent)}addCallbacks(e,t){var i=this.callbacks[e];i||(i=[],this.callbacks[e]=i),-1===i.indexOf(t)&&i.push(t)}removeCallbacks(e,t){var i=this.callbacks[e];if(i){var r=i.indexOf(t);-1!==r&&i.splice(r,1)}}removeAllCallbacks(){for(var e in this.callbacks)for(var t=this.callbacks[e],i=0,r=t.length;i<r;i++)t.splice(0,1);for(var e in this.callbacks)delete this.callbacks[e];this.callbacks={}}onCallbacks(e){var t=this.callbacks[e];if(t)for(var i=0;i<t.length;i++)t[i]&&t[i]()}addRenderCallback(e){this.addCallbacks(r.EnumRenderCallbackType.RENDER,e)}removeRenderCallback(e){this.removeCallbacks(r.EnumRenderCallbackType.RENDER,e)}onRenderCallback(){this.onCallbacks(r.EnumRenderCallbackType.RENDER)}addRenderFinishedCallback(e){this.addCallbacks(r.EnumRenderCallbackType.FINISH_RENDER,e)}removeRenderFinishedCallback(e){this.removeCallbacks(r.EnumRenderCallbackType.FINISH_RENDER,e)}onRenderFinishedCallback(){this.onCallbacks(r.EnumRenderCallbackType.FINISH_RENDER)}destroy(){this.removeAllCallbacks(),this.refleRefraManager.dispose(),this.scissorViewportManager.dispose(),this.terrainOperationManager.dispose(),this.holesManager.dispose(),this.heightLimitManager&&this.heightLimitManager.dispose(),this.clipCapsManager&&this.clipCapsManager.dispose(),this.terrainOperationManager=null,this.holesManager=null,this.refleRefraManager=null,this.scissorViewportManager=null,this.renderSettings.canvas=null,this.renderSettings.context=null,this.renderSettings=null,r.MaterialUtil.disposeAllDefaultMaterial(),this.rendererManager.destroy(),this.rendererManager=null,this.unregisterEventListener(r.EVENTS.ON_LOAD_INVALID_MODEL_VERSION,this.versionMismatchEvent),this.versionMismatchEvent=null,this.cameraControl.destroy(),this.cameraControl=null,this.camera.destroy(),this.camera=null,this.defaultCamera=null,this.viewshedManager.destroy(),this.viewshedManager=null,this.videoCastManager.destroy(),this.videoCastManager=null,this.filterHelper=null,this.editorManager.destroy(),this.inputStatusMonitor.destroy(),this.inputStatusMonitor=null,this.modelManager.onUpdateViewer=null,this.modelManager.destroy(),this.modelManager=null,this.editorManager=null,this.domElement=null,this.callbacks=null,this.tmpBox=null,this.calculationPlanesBind=null,this.animator=null,this.IBLManager=null,this._options=null,this.TextureManager.destroy(),this.TextureManager=null,r.GIS.ApproximateTerrainHeights._viewer=null,this.clientSize=null,this._baseGeoCoordinates=null,this._foveatedConeLimit=null,this._dampingOpts=null,this._demOptions=null,this._background=null,r.GrowthAnimationManager.destroyInstance(),this.growthAnimationManager=null,r.TreeAnimationManager.destroyInstance(),this.treeAnimationManager=null,r.GroundPrimitiveManager.destroyInstance(),r.GroundDrawingManager.destroyInstance(),r.RequstPoolLoader.destroy(),this.curEnvironmentCubeUrl=this.undefined}init(e,t){r.GlobalData.IsMobile=!this.isDesktop();var i,n=this,a={alpha:!0,preserveDrawingBuffer:!0,antialias:!0,maxDrawCacheNum:r.GlobalData.maxDrawCacheNum,stencil:!0,logarithmicDepthBuffer:!1,xrCompatible:!0};r.GlobalData.EnableLogarithmicDepthBuffer&&(a.logarithmicDepthBuffer=!0);try{i=document.createElement("canvas");let e=null,t=r.Utils.getOS();"macOS"!==t&&"ios"!==t||(r.GlobalData.ForcedUseWebgl1=!0);let n=()=>{this.webgl2Support=!1,e=i.getContext("webgl",a)||i.getContext("experimental-webgl",a)};!0===r.GlobalData.ForcedUseWebgl1?n():(e=i.getContext("webgl2",a),r.Utils.isDefined(e)||n()),r.Utils.isDefined(e)||(a.antialias=!1),a.context=e}catch(e){return!1}this.domElement=e,this.isGis=t,r.GeomUtil.initializeUnitInstances(),a.canvas=i,this.renderSettings=a;var s=e.offsetWidth<1?1:e.offsetWidth,o=e.offsetHeight<1?1:e.offsetHeight,l={width:s,height:o,fov:45,near:.1,far:20*r.GlobalData.SceneSize};return this.camera=this.defaultCamera=new r.Camera(r.CAMERATYPE.PERSPECTIVE,l),this.cameraControl=new r.CameraControl(this,this.getScene(),this.camera,this.domElement,(function(e){n.render(e)}),this._dampingOpts),r.GroundPrimitiveManager.getInstance().setSize(s,o),this.terrainOperationManager.setSize(s,o),this.holesManager.setSize(s,o),this.setEditorDefault(),this.getScene().lightManager.initCSM(this),this.modelManager.onUpdateViewer=function(){n.render(!0)},this.registerEventListener(r.EVENTS.ON_LOAD_INVALID_SCENE,(e=>{})),this.editorManager.registerDomEventListeners(this.domElement),!0}render(e){var t=this.getRenderer();t&&t.xr&&t.xr.enabled||this.rendererManager&&this.rendererManager.render(e)}renderWithXR(){this.rendererManager&&this.rendererManager.renderer._render()}resize(e,t){this.camera&&(this.camera.setSize(e,t),this.camera.updateProjectionMatrix(),this.getRenderer()&&(this.rendererManager.setSize(e,t),r.GroundPrimitiveManager.getInstance().setSize(e,t),this.terrainOperationManager.setSize(e,t),this.holesManager.setSize(e,t),this.modelManager.updateMaterialsValue("viewportSize",new THREE.Vector2(e,t)),this.clipCapsManager&&this.clipCapsManager.setSize(e,t),this.onCallbacks("resize"),this.render()))}resizeByFrustum(e,t){this.camera&&this.getRenderer()&&(this.camera.updateProjectionMatrixByFrustum=!0,this.camera.setSizeByFrustum(e,t),this.render(),this.camera.updateProjectionMatrixByFrustum=!1)}calculateNearFar(e,t,i){if(!this.enableCameraNearFar)return;let n,a;if(t||i){const e=this.calUserDefinedNearFar(t,i);n=e.zNear,a=e.zFar}if(!n||!a){const t=this.getScene(),i=t.getBoundingBoxWorld();if(!i)return;var s=this.camera,o=this.tmpBox;if(o.copy(i),r.GlobalData.EnableGisMap){var l=t.calculateGisMapBox(s);o.union(l)}var d=this.getCurrentEditor();if(d.name===r.EditorMode.THIRDPERSONWALK&&d.prepared){var h=d.object.box;o.union(h)}if((4==r.GlobalData.LightPreset||6==r.GlobalData.LightPreset)&&t.lightManager.shadowBox){var c=t.getShadowBoxWorld();o.union(c)}if(null!==r.ContactShadow.getInstance()){const e=r.ContactShadow.getInstance().getShadowBoxWorld();o.union(e)}if(o.applyMatrix4(t.getRawMatrixGlobal()),e&&e.fillClipPlane&&t.fillClipPlane){const e=t.fillClipPlane.getFillClipPlaneBoundingBox();o.union(e)}const n=r.GroundPrimitiveManager.getInstance();if(n){const e=n.getGroundMinHeight();void 0!==e&&(o.min.y=Math.min(o.min.y,e))}if(t.clipPlanes){const e=t.clipPlanes.getClipBoundingBox();o.union(e)}const a=this.globalRendering?.1:void 0;s.calculateNearFar(o,a)}if(n||a){let e=this.camera;n||(n=e.near),a||(a=e.far),e.setNearFar(n,a)}}calUserDefinedNearFar(e,t){const i=this.camera.position;let r,n;return e&&(e.sub(i),r=e.length()),t&&(t.sub(i),n=t.length()),{zNear:r,zFar:n}}resetSelectionColor(e,t){this.modelManager.sceneState.setSelectionColor(e,t)}calculateMinDistance(e,t){function i(e,t){for(var i=0,r=0,n=0;n<3;n++){var a=e.min.getComponent(n),s=e.max.getComponent(n),o=t.min.getComponent(n),l=t.max.getComponent(n),d=0;a>l?d=a-l:s<o&&(d=o-s),i+=d*d;var h=Math.max(l,s)-Math.min(a,o);r+=h*h}return{minDis:Math.sqrt(i),maxDis:Math.sqrt(r)}}var l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3;function c(e,t,i,r,n,a){l.fromBufferAttribute(t,i),d.fromBufferAttribute(t,r),h.fromBufferAttribute(t,n),a&&(l.applyMatrix4(a),d.applyMatrix4(a),h.applyMatrix4(a)),e.push(l),e.push(d),e.push(h)}function u(e,t,i){for(var n={start:null,end:null,minDistance:i},a=e.mesh,l=e.indexInfo,d=p(e,s),h=a.geometry,u=h.attributes.position,m=l?l.indexStart:0,f=h.getIndex().array,g=l?l.indexStart+l.indexCount:f.length,v=t.mesh,y=t.indexInfo,M=p(t,o),E=m,x=g;E<x;E+=3){var _=[];c(_,u,f[E],f[E+1],f[E+2],d);var b=r.Utils.minDistanceBetweenTriToMesh(_,v,y,M);b.minDistance<n.minDistance&&(n.minDistance=b.minDistance,n.start=b.start,n.end=b.end)}return n}function p(e,t){var i=e.modelMatrix||new THREE.Matrix4;return e.matrix?t.copy((new THREE.Matrix4).copy(i).multiply(e.matrix)):e.unitsMatrix?t.copy(e.unitsMatrix):i.clone()}var m=this.modelManager.getMinDistanceObjects(e,t);if(!m)return-1;var f=[],g={start:null,end:null,minDistance:Number.POSITIVE_INFINITY};for(var v in m)f.push(m[v]);if(f[0].length<1||f[1].length<1)return-1;var y=f[0],M=f[1],E=y.length,x=M.length,_=null,b=Number.POSITIVE_INFINITY;if(E>1||x>1){_={};for(var I=0;I<E;I++)for(var T=(R=y[I]).modelMatrix||new THREE.Matrix4,S=0;S<x;S++){var C=(A=M[S]).modelMatrix||new THREE.Matrix4;n.copy(R.boundingBox.clone()).applyMatrix4(T),R.unitsMatrix&&n.applyMatrix4(R.unitsMatrix),a.copy(A.boundingBox.clone()).applyMatrix4(C),A.unitsMatrix&&a.applyMatrix4(R.unitsMatrix);var w=i(n,a);b=b<w.maxDis?b:w.maxDis,_[I+"_"+S]=w}}for(I=0;I<E;I++){var R=y[I];for(S=0;S<x;S++){if(_){var B=_[I+"_"+S].minDis;if(B>b||B>g.minDistance)continue}var A,P=u(R,A=M[S],g.minDistance);if(P.minDistance<g.minDistance&&(g.minDistance=P.minDistance,g.start=P.start,g.end=P.end),0==g.minDistance)return g}}return _=null,g}registerDomEventListeners(){this.domElement&&this.editorManager.registerDomEventListeners(this.domElement)}unregisterDomEventListeners(){this.domElement&&this.editorManager.unregisterDomEventListeners(this.domElement)}registerEventListener(e,t){this.modelManager.addEventListener(e,t)}unregisterEventListener(e,t){this.modelManager.removeEventListener(e,t)}load(e){var t=this,i=this.getModelManager();return e.lightmapDatabagId&&(r.GlobalData.InstanceSharedMeshEnabled=!1),i.load(e,(function(){t.rendererManager.setupRenderer(t.renderSettings)}),(function(r){i.updateFilterManager(),i.getFilter().calculateVisibleComponentsBbox(),i.setDrawableModel(!0),i.checkIfFirstModelLoaded(),t.camera.dirty||e.loadConfig&&!1===e.loadConfig.zoomAll?t.render():(t.goToInitialView(),t.zoomAll()),r.materialManager&&r.materialManager.delayUpdateTexturePkgMapping(void 0,(()=>{i.setRenderStateChanged(!0),t.render()}))}))}_setupEarth(e){if(this.globeEarth||!this._initEarth)return void this.modelManager.dispatchEvent({type:r.EVENTS.ON_EARTH_ANIMATION_COMPLETE});this.virtualEarthComplete=!1,e=r.Utils.defaultValue(e,!0);const t={_baseGeoCoordinates:this._baseGeoCoordinates,earthResource:this._earthResource},i=this.globeEarth=new r.VirtualEarth(this,t);i.setupEarth().then((()=>{const t={destination:this._baseGeoCoordinates,globe:i,changeToWorkSpace:!0};this.cameraControl.zoomToHeight(t,i).then((()=>{e&&this.showWorkSpaceScene()}))})).catch((()=>{this.showWorkSpaceScene(),console.log("can not load texture, setup earth failed")}))}unload(e){var t=this;this.getModelManager().unload(e,(function(){t.render()}))}unloadAll(){this.getModelManager().unloadAll(),this.render()}showScene(e,t){var i=this;this.getModelManager().setModelVisibility(e,t,(function(){i.render()}))}showWorkSpaceScene(){this.globalRendering=!1,this.getScene().changeToWorkSpaceScene(),this.globeEarth&&(this.globeEarth.destroy(),this.globeEarth=null,this._initEarth=!1);const e=this.transitionAnimationState;this.transitionAnimationState=!1,this.setStandardView(this.initialView,null,null,(()=>{this.transitionAnimationState=e,this.virtualEarthComplete=!0,this.zoomAll(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EARTH_ANIMATION_COMPLETE}),this.setRenderStateChanged(!0),this.render()}))}isEarthComplete(){return this.virtualEarthComplete}setModelShellVisible(e,t){this.modelManager.setModelShellVisibility(e,t),this.setRenderStateChanged(!0),this.render()}clearAll(){this.getScene().clearAll()}restore(){this.getFilter().clear(),this.getScene().disableClipPlanes(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_VIEWER_RESTORED})}getScene(){return this.modelManager.scene}getInteractionScene(){return this.modelManager.interactionScene}getCapsScene(){return this.clipCapsManager&&this.clipCapsManager.capsScene}getEditorManager(){return this.editorManager}getUserdataByUserId(e,t){var i=this.modelManager.getNodeInfosByUserId(e,t);return i&&i instanceof Array?i[0].userData:null}getFilter(){return this.modelManager.getFilter()}getCurrentEditorName(){return this.editorManager.getCurrentEditorName()}getCurrentEditor(){return this.editorManager.getCurrentEditor()}setEditorMode(e){this.editorManager.setEditorMode(this,e)}setEditorDefault(){this.editorManager.setupUserInputEditor(this),this.setEditorMode(r.EditorMode.PICK)}getUserInputEditor(){return this.editorManager.getUserInputEditor()}setZoomSpeed(e){this.getUserInputEditor().setZoomSpeed(e)}getZoomSpeed(){return this.getUserInputEditor().getZoomSpeed()}setPickMode(){console.warn("CLOUD.Viewer.setPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PICK)}setRectPickMode(){console.warn("CLOUD.Viewer.setRectPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PICK_BY_RECT)}setOrbitMode(){console.warn("CLOUD.Viewer.setOrbitMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ORBIT)}setZoomMode(){console.warn("CLOUD.Viewer.setZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ZOOM)}setRectZoomMode(){console.warn("CLOUD.Viewer.setRectZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ZOOM_BY_RECT)}setPanMode(){console.warn("CLOUD.Viewer.setPanMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PAN)}setFlyMode(){console.warn("CLOUD.Viewer.setFlyMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.FLY)}setMeasureMode(){console.warn("CLOUD.Viewer.setMeasureMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.MEASURE)}setClipPlanesMode(){console.warn("CLOUD.Viewer.setClipPlanesMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.CLIP_BY_BOX)}getBoundingBoxWorld(){return this.getScene().getBoundingBoxWorld()}getBoundingBox(){return this.getScene().getBoundingBox()}zoomIn(e){void 0===e&&(e=.1),e<0&&(e=0),this.cameraControl.zoom(e),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomOut(e){void 0===e&&(e=.1),e>0?e*=-1:e=0,this.cameraControl.zoom(e),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomAll(e,t){var i=this.getScene().getBoundingBox();r.Utils.isDefined(i)&&this._zoomToLocalBBox(i,e,t)}zoomToBuilding(e,t){this.zoomAll(e,t)}zoomToSelection(e,t,i,n,a=1e3){var s=this.getScene(),o=this.modelManager.sceneState,l=this.getBoundingBoxByIds(o.getSelectionSet(n).keys(),n);if(l.isEmpty()&&(l=s.getBoundingBox()),1==this.getTransitionAnimationState()){let t=this.animator.getDuration();this.animator.setDuration(a);const n={stdView:void 0,viewer:this,box:l,margin:e,direction:void 0,callbackProcess:void 0,callbackFinished:()=>{"[object Function]"===Object.prototype.toString.call(i)&&i(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}};this.animator.setStandardView(n),this.animator.setDuration(t)}else this._zoomToLocalBBox(l,e,t)}_zoomToLocalBBox(e,t,i,n){this.camera.zoomToBBox(e,t,i,n),this.cameraControl.dirtyCamera(!0),this.render(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomToBBox(e,t,i,n,a=1e3,s){var o=new THREE.Box3;let l;if(e?(o.copy(e),o.applyMatrix4(this.getScene().getRawMatrixGlobal())):o.copy(this.getScene().getBoundingBox()),s&&(l=new THREE.Vector3(s.x,s.y,s.z),l.applyMatrix4(this.getScene().getRawMatrixGlobal()),l.normalize()),1==this.getTransitionAnimationState()){let e=this.animator.getDuration();this.animator.setDuration(a);const i={stdView:void 0,viewer:this,box:o,margin:t,direction:l,callbackProcess:void 0,callbackFinished:()=>{"[object Function]"===Object.prototype.toString.call(n)&&n(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}};this.animator.setStandardView(i),this.animator.setDuration(e)}else this._zoomToLocalBBox(o,t,i)}zoomToBBoxByDirection(i,r,n,a){if(r){if(r&&i){var s=i.clone(),o=s.getCenter(e).add(r);s.applyMatrix4(this.getScene().getRawMatrixGlobal()),o.applyMatrix4(this.getScene().getRawMatrixGlobal());var l=o.sub(s.getCenter(t));l.length()>1e-4?(l.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(s,n,a,l)):this._zoomToLocalBBox(s,n,a)}}else this.zoomToBBox(i,n,a)}zoomToBBoxWithOuterBox(i,r,n,a){if(r){if(r&&i){var s=i.clone(),o=r.getCenter(e);s.applyMatrix4(this.getScene().getRawMatrixGlobal()),o.applyMatrix4(this.getScene().getRawMatrixGlobal());var l=o.sub(s.getCenter(t));l.length()>1e-4?(l.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(s,n,a,l)):this._zoomToLocalBBox(s,n,a)}}else this.zoomToBBox(i,n,a)}getObjectsInBox(e){var t=new THREE.Box3;return t.copy(e),t.applyMatrix4(this.getScene().getRawMatrixGlobal()),r.PickUtil.getObjectsInBox(this.getScene(),t,this.modelManager,this)}setStandardView(e,t,i,n,a){var s,o=this.camera;if(s=a||this.getScene().getBoundingBox(),r.Utils.isDefined(s))if(this.transitionAnimationState){const r={stdView:e,viewer:this,box:s,margin:t,direction:void 0,callbackProcess:i,callbackFinished:n};this.animator.setStandardView(r)}else{o.setStandardView(e,s);this.camera.zoomToBBox(s,t);this.render(),n&&n()}}getLineSelectRange(){return r.GlobalData.LineSelectRange}setLineSelectRange(e){r.GlobalData.LineSelectRange=e}_setStandardView(e,t){var i=this.camera,r=this.getScene().getBoundingBox();i.setStandardView(e,r),i.zoomToBBox(r,t)}setStandardViewWithBox(e,t,i,r){if(t?t.applyMatrix4(this.getScene().getRawMatrixGlobal()):t=this.getScene().getBoundingBox(),this.transitionAnimationState){const r={stdView:e,viewer:this,box:t,margin:i,direction:void 0,callbackProcess:void 0,callbackFinished:void 0};this.animator.setStandardView(r)}else{var n=this.camera;n.setStandardView(e,t),n.zoomToBBox(t,i,r),this.render()}}setTopView(e,t,i){this.setStandardViewWithBox(r.EnumStandardView.ISO,e,t,i)}setInitialViewType(e){console.warn("CLOUD.Viewer.setInitialViewType() has been deprecated. Use CLOUD.Viewer.setInitialView() instead."),this.setInitialView(e)}setInitialView(e){this.initialView=e,this._setStandardView(e)}goToInitialView(e){this.setStandardView(this.initialView,e,null)}flyToLngLat(e){const t=r.Utils.defaultValue(e,{});return this.cameraControl.flyToLngLat(t)}setHomeViewType(e){console.warn("CLOUD.Viewer.setHomeViewType() has been deprecated. Use CLOUD.Viewer.setHomeView() instead."),this.setHomeView(e)}setHomeView(e){this.currentHomeView=e,this._setStandardView(e)}getHomeView(){return this.currentHomeView}goToHomeView(e){this.setStandardView(this.currentHomeView,e,null)}rotateByAxis(e,t,i){var r=2*Math.PI/60/60*e;if(t&&"x"!=t){if("y"!=t)return void console.warn("Illegal rotation axis for Viewer.rotateByAxis().");this.cameraControl.handleRotation(0,-r,i)}else this.cameraControl.handleRotation(-r,0,i);this.cameraControl.update(!0)}setImageResPath(e){r.GlobalData.TextureResRoot=e}setLightIntensityFactor(e){r.GlobalData.LightIntensityFactor=e}setLimitFrameTime(e){r.GlobalData.IncrementRender&&(e<=0&&(e=30),r.GlobalData.LimitFrameTime=e)}limitFrameRate(e){r.GlobalData.IncrementRender&&(e<=0&&(e=4),this.minimumFPS=e,r.GlobalData.LimitFrameTime=1e3/e)}transformCamera(e){return r.CameraUtil.transformCamera(e,this.modelManager.scene)}getCamera(){var e=this.getScene().getRawMatrixGlobal(),t=this.cameraControl.getCamera(),i=this.cameraControl.getCameraName(),n=new r.CameraInfo(i,t.position,t.target,t.realUp||t.up);if(n=r.Camera.drawingToWorld(n,e),this.cameraStateWithFrustum)var a=2*(t.near*Math.tan(.5*THREE.Math.DEG2RAD*t.fov)/t.zoom),s=t.aspect*a;let o=null;return o=t.isPerspective?new r.PerspectiveCameraInfo(n.position,n.target,n.up,t.fov,t.aspect,t.near,t.far,t.zoom,void 0,s,a):new r.OrthographicCameraInfo(n.position,n.target,n.up,t.left,t.right,t.top,t.bottom,t.near,t.far,t.zoom,void 0,s,a),o=r.Camera.nearFarDrawingToWorld(o,e),JSON.stringify(o)}setCameraStateWithFrustum(e){this.cameraStateWithFrustum=e}setCamera(e,t,i,n){this.camera.dirty=!0;var a=this,s=r.CameraUtil.parseCameraInfo(e);if(null===s)console.log("Invalid camera info string. Fail to set camera.");else if(this.switchToCamera(s.name)){var o=this.getScene().getRawMatrixGlobal(),l=r.Camera.worldToDrawing(s,o);if(l.name=s.name,l.zoom=s.zoom,l.frustumWidth=s.frustumWidth,l.frustumHeight=s.frustumHeight,n){var d=new THREE.Vector3(l.position.x,l.position.y,l.position.z),h=new THREE.Vector3(l.target.x,l.target.y,l.target.z),c=new THREE.Vector3(h.distanceTo(d),0,0),u=h.clone().sub(d).normalize(),p=new THREE.Vector3(l.up.x,l.up.y,l.up.z);p.normalize();var m=new THREE.Vector3(l.zoom,0,0);return this.camera.setZoom(m.x),this.camera.LookAt(h,u,p,c.x),void(i&&i())}if(this.transitionAnimationState){var f={position:this.camera.position.clone(),target:this.camera.target.clone(),up:this.camera.realUp.clone()||this.camera.up.clone(),zoom:this.camera.zoom};this.animator.active(f,l,this,(function(e){a.cameraControl.update(!0,!0)}),(()=>{l.frustumWidth&&l.frustumHeight&&a.resizeByFrustum(l.frustumWidth,l.frustumHeight),s=null,i&&i()}))}else{"orth"===s.name&&a.camera.setZoom(s.zoom);var g=new THREE.Vector3;g.subVectors(l.target,l.position),this.camera.LookAt(l.target,g,l.up),t&&this.cameraControl.updateCamera(),s.frustumWidth&&s.frustumHeight&&(a.cameraControl.update(!0,!0),a.resizeByFrustum(s.frustumWidth,s.frustumHeight)),i&&i()}}}setCameraMinimumElevation(e){if(null!=e){this.camera.minimumElevation=e,e>0?this.cameraControl.updateMinPitch(0):this.cameraControl.updateMinPitch(-Math.PI/2);let t=JSON.parse(this.getCamera());e>t.position.z&&(t.position.z=e,t=JSON.stringify(t),this.setCamera(t,!0,null,!1))}else this.camera.minimumElevation=null,this.cameraControl.updateMinPitch(-Math.PI/2)}getRenderBufferScreenShot(e,t){var i=this.getRenderer().domElement,r=i.toDataURL("image/png"),n=i.width,a=i.height,s=window.devicePixelRatio||1,o=n/s,l=a/s;if(!o||!l)return t?(t(r),null):r;var d,h,c,u=0,p=0;if(o>l||n/a<o/l?(d=o,p=l/2-(h=a/n*o)/2):(h=l,u=o/2-(d=n/a*l)/2),t)return(c=new Image).onload=function(){var i=document.createElement("canvas"),r=i.getContext("2d");i.width=o,i.height=l,e&&(r.fillStyle=e,r.fillRect(0,0,o,l)),r.drawImage(c,u,p,d,h);var n=i.toDataURL("image/png");t(n)},c.src=r,null;(c=new Image).src=r;var m=document.createElement("canvas"),f=m.getContext("2d");return m.width=o,m.height=l,e&&(f.fillStyle=e,f.fillRect(0,0,o,l)),f.drawImage(c,u,p,d,h),m.toDataURL("image/png")}screenShot(e,t,i){var r=this;var n=function(e,t,i){var n=r.getRenderer().domElement,a=n.toDataURL("image/png"),s=n.width,o=n.height,l=(window.devicePixelRatio,e),d=t;if(!l||!d)return i?(i(a),null):a;var h,c,u=0,p=0;if(l>d||s/o<l/d?(h=l,p=d/2-(c=o/s*l)/2):(c=d,u=l/2-(h=s/o*d)/2),i){var m=new Image;return m.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=l,e.height=d,t.drawImage(m,u,p,h,c);var r=e.toDataURL("image/png");i(r)},m.src=a,null}}(e,t,i);return this.render(),n}canvas2image(e,t){var i,r=this;return t?(this.getRenderBufferScreenShot(e,(function(e){t(e),r.render()})),null):(i=this.getRenderBufferScreenShot(e),this.render(),i)}lockAxisZ(t,i){var r=this.cameraControl;if(r){var n=r.getZenith(),a=this.getBoundingBox().getCenter(e);if(t&&void 0!==i||(i=null),i){const e=i[0],t=i[1];n>t?r.handleRotation(0,t-n,a):n<e&&r.handleRotation(0,e-n,a),this.render()}this.cameraControl.lockAxisZ(t),this.cameraControl.setLockAxisZRange(i)}}isLockedAxisZ(){return this.cameraControl.isLockedAxisZ()}enableTranslucentByDClick(e){r.GlobalData.EnableDemolishByDClick=e}enableHitDetection(e){r.GlobalData.EnableHitDetection=e}rotateCamera(e){this.cameraControl.processRotate(e),this.cameraControl.update()}setRotationCenter(e){this.rotationCenter=new THREE.Vector3(e.x,e.y,e.z)}clearRotationCenter(){this.rotationCenter=void 0}getRotationCenter(){return this.rotationCenter}getActiveCameraInfo(){var e={};e.up=new THREE.Vector3,e.dir=new THREE.Vector3,e.quaternion=new THREE.Quaternion;var t=this.camera;return t.getWorldDirection(e.dir),e.up.copy(t.realUp||t.up),t.getWorldQuaternion(e.quaternion),e}calculationPlanes(){if(this.isRecalculationPlanes){this.isRecalculationPlanes=!1;var i=this.getScene(),n=this.getBoundingBoxByIds();n.isEmpty()&&(n=i.getBoundingBox()),r.ClipPlaneManager.getInstance(i).calculationPlanes(n.getSize(t),n.getCenter(e)),this.render()}}recalculationPlanes(){this.isRecalculationPlanes=!0}setOctantDepth(e){r.GlobalData.OctantDepth=e}resizePool(e){r.GlobalData.maxObjectNumInPool=e,this.modelManager.updateSceneRenderable(),this.render()}setCategoriesToHighPriority(e,t){var i=0==t?"inner":"outer";this.modelManager.setCategoriesToHighPriority(e,i)}clearCategoriesFromHighPriority(e){var t=0==e?"inner":"outer";this.modelManager.clearCategoriesFromHighPriority(t)}clearAllCategoriesFromHighPriority(){this.modelManager.clearAllCategoriesFromHighPriority()}isolate(e,t){this.getFilter().isolate(e,t)}setIsolateMaterial(e){this.getFilter().setIsolateMaterial(e)}resetIsolateMaterial(){this.getFilter().resetIsolateMaterial()}setOrbitButton(e){const t=this.editorManager.userInputEditor;r.Utils.isDefined(t)&&t.switchHandMode(e)}showPickedInformation(e){r.UIHelper.showPickedInformation(e)}setOrbitEnabled(e){r.EditorConfig.NoRotate=!0!==e}getOrbitEnabled(){return!r.EditorConfig.NoRotate}setSelectPadCallback(e){var t=this.editorManager.getCurrentEditor();t&&t.selectPad&&(t.selectPad.callback=e)}setDeviceMobile(e){r.GlobalData.IsMobile=e||!1}setPointRotateMode(e){r.EditorConfig.RotatePivotMode=e}worldToDrawing(e){return this.cameraControl?this.getScene().worldToDrawing(e):(console.log("camera is not initialized!!!"),null)}drawingToWorld(e){return this.cameraControl?this.getScene().drawingToWorld(e):(console.log("camera is not initialized!!!"),null)}worldToCanvas(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),a=this.getScene().worldToDrawing(e);return r.CameraUtil.drawingToCanvas(n,a,i.width,i.height)}intersectReferencePlane(){r.CameraUtil.intersectReferencePlane(this.camera,this.getScene())}canvasToWorld(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),a=this.getScene(),s=r.CameraUtil.canvasToDrawing(n,e,i.width,i.height),o=a.drawingToWorld(s);return{x:o.x,y:o.y,z:o.z}}worldToClient(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),a=this.getScene().worldToDrawing(e),s=r.CameraUtil.drawingToCanvas(n,a,i.width,i.height);return s?(s.x+=i.left,s.y+=i.top,s):null}worldPointsToClient(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),null;var n=i.getContainerDimensions();if(!n)return null;var a=i.getCamera(),s=this.getScene(),o=s.worldToDrawing(e),l=s.worldToDrawing(t),d=r.CameraUtil.drawingPointsToCanvas(a,o,l,n.width,n.height);return d?(d.start.x+=n.left,d.start.y+=n.top,d.end.x+=n.left,d.end.y+=n.top,d):null}clientToWorld(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;(s={x:e.x,y:e.y,z:e.z}).x-=i.left,s.y-=i.top;var n=t.getCamera(),a=this.getScene(),s=r.CameraUtil.canvasToDrawing(n,s,i.width,i.height),o=a.drawingToWorld(s);return{x:o.x,y:o.y,z:o.z}}insideCamera(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);return t.getFrustum().containsPoint(i)}locateToPointWithParallelEye(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);t.flyToPointWithParallelEye(i)}locateToPoint(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);t.flyToPoint(i)}enableHover(e){e||(this.modelManager.clearHover(),this.render()),r.GlobalData.Hover=e}enableMouseMovePick(e){r.GlobalData.MouseMovePick=e}getObjectsByClientCoordinates(e){return new r.IntersectHelper(this).getObjectsByClientCoordinates(e)}getIBLManager(){return this.IBLManager}loadEnvMap(e,t){if(this.curEnvironmentCubeUrl===e&&void 0!==this.environmentCubeMap)return this.modelManager.updateMaterialsValue("envMap",this.environmentCubeMap),void this.setRenderStateChanged(!0);this.curEnvironmentCubeUrl=e;var i=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],r=[];const n=t?e:"/"+e;for(var a=0;a<6;++a)r.push(n+"/EnvMap_"+i[a]);var s=this,o=new THREE.HDRCubeTextureLoader;o.setDataType(THREE.FloatType),o.load(r,(function(e){s.environmentCubeMap=e,s.modelManager.updateMaterialsValue("envMap",e),s.setRenderStateChanged(!0),s.render()}))}setEnvMapIntensity(e){this.modelManager.updateMaterialsValue("envMapIntensity",e),this.setRenderStateChanged(!0),this.render()}closeEnvMap(){this.modelManager.updateMaterialsValue("envMap",null),this.setRenderStateChanged(!0),this.render()}isSupportSSAO(){return!r.GlobalData.IncrementRender}isSSAOEnabled(){return r.GlobalData.SSAO}enableSSAO(e){return 0!=this.isSupportSSAO()&&(r.GlobalData.SSAO==e||(r.GlobalData.SSAO=e,this.setRenderStateChanged(!0),this.render()),!0)}isSupportSSR(){return!r.GlobalData.IncrementRender}isSSREnabled(){return r.GlobalData.SSR}enableSSR(e){return 0!=this.isSupportSSR()&&(r.GlobalData.SSR==e||(r.GlobalData.SSR=e,this.setRenderStateChanged(!0),this.render()),!0)}isSSAOEnabled(){return r.GlobalData.SSAO}enableGTAO(e){return 0!=this.isSupportSSAO()&&(r.GlobalData.GTAO==e||(r.GlobalData.GTAO=e,this.setRenderStateChanged(!0),this.render()),!0)}switchNewStyleMaterial(e){this.modelManager.switchNewStyleMaterial(e),this.setRenderStateChanged(!0),this.render()}enableColorWithoutLight(e){this.modelManager.enableColorWithoutLight(e),this.setRenderStateChanged(!0),this.render()}createGround(e){const t=new r.Ground(e);return this.ground=t,t}removeGround(){this.ground&&(this.ground.remove(),this.ground=null)}addPlane(e,t,i,n){var a=new THREE.Vector3;a.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),a.multiplyScalar(.5);var s=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(s,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(a),o.renderOrder=r.EnumRenderOrder.ClipPlane,this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.CUSTOMPLANE,{globalSpace:!0}).add(o),o.updateMatrixWorld(!0);var l=this,d=new THREE.TextureLoader;return d.setCrossOrigin("anonymous"),d.load(i,(function(e){o.material.map=e,o.material.needsUpdate=!0,l.setRenderStateChanged(!0),n&&n()})),o}removePlane(e){var t=this.getScene().getObjectGroup(r.ObjectGroupType.CUSTOMPLANE);t&&t.remove(e)}clearPlane(){var e=this.getScene().getObjectGroup(r.ObjectGroupType.CUSTOMPLANE);e&&e.clear()}enableTextureMapping(e){r.GlobalData.EnableTextureMapping=e}enableLightmap(e){r.GlobalData.EnableLightmap!=e&&(r.GlobalData.EnableLightmap=e)}setLightmapIntensity(e){r.GlobalData.LightmapIntensity!=e&&(r.GlobalData.LightmapIntensity=e)}setReverseWheelDirection(e){r.EditorConfig.ReverseWheelDirection=!!e}getReverseWheelDirection(){return r.EditorConfig.ReverseWheelDirection}setMovementSpeedRate(e){void 0!==e&&(r.EditorConfig.MovementSpeedRate=e)}getMovementSpeedRate(){return r.EditorConfig.MovementSpeedRate}moveTo(e,t,i){var r=this.editorManager.editor;r&&r.moveTo(e,t,i)}rotateTo(e){var t=this.editorManager.editor;t&&t.rotateTo(e)}enableOcclusionTranslucent(e){r.GlobalData.OcclusionTranslucentEnabled=!!e}setOcclusionOpacity(e){r.GlobalData.OcclusionOpacity=e}setOcclusionDistanceToCamera(e){r.GlobalData.OcclusionDistanceToCamera=e}fitAndRotateBySelection(){this.cameraControl&&this.cameraControl.fitAndRotateBySelection()}setRoamingWalkHeight(e,t,i){if(e instanceof Array){var n=this.cameraControl;if(!n)return console.log("camera is not initialized!!!"),!1;if(t<=0&&(t=1750),void 0===i&&(i=!0),n.setCameraHeight(e,t),i){var a=this.editorManager.getCurrentEditor();a&&a.name===r.EditorMode.WALK&&a.update&&n.flyOnWorld()}}else console.log("elevations is not arry")}setRoamingWalkAbsoluteHeight(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),!1;if(void 0===t&&(t=!0),i.setCameraAbsoluteHeight(e),t){var n=this.editorManager.getCurrentEditor();n&&n.name===r.EditorMode.WALK&&n.update&&i.flyOnWorld()}}cameraToWorld(e){return this.camera?r.Camera.drawingToWorld(e,this.getScene().getRawMatrixGlobal()):null}cameraToDrawing(e){return this.camera?r.Camera.worldToDrawing(e,this.getScene().getRawMatrixGlobal()):null}clearSelection(e){this.modelManager.sceneState.clearSelection(e)}addToSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.addSelection(t,e.id)}),t)}removeFromSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.removeSelection(t,e.id)}),t)}setSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.setSelection(t,e.id)}),t)}getSelection(e){const t=this.modelManager;let i=t.sceneState.getSelection(e,e);const r=t.getModel(e);return r&&r.traversePluginModels&&r.traversePluginModels((e=>{let r=t.sceneState.getSelection(e.id);i=[...i,...r]})),i}getSelectionWithModelId(e){return this.modelManager.sceneState.getSelectionWithModelId(e)}setSelectionColor(e){this.modelManager.sceneState.setSelectionColor(e)}pickByPoint(e,t){var i=this.cameraControl;if(!1===i.enabled)return!1;var r,n=new THREE.Vector2(e.x,e.y),a=i.getIntersectContext(n);r=t?i.intersector.pickGlobe(a):i.intersector.pick(a);var s=this.getScene();if(r){s.intersectToWorld(r,this);var o={};return o.faceIndex=r.faceIndex,o.meshId=r.userId,o.worldPosition=r.worldPosition,o.worldBoundingBox=r.worldBoundingBox,o}return null}pickByPointWithNormal(e){var t=this.getScene(),i=this.cameraControl;if(!1===i.enabled)return null;var r=new THREE.Vector2(e.x,e.y),n=i.getIntersectContext(r),a=i.intersector.pick(n);if(!a)return null;t.intersectToWorld(a,this),a.cx=r.x,a.cy=r.y;var s=[];s.push(a);var o=t.getRawMatrixGlobal(),l=a.face.normal.clone(),d=a.worldPosition.clone(),h=new THREE.Ray(d,l);h.applyMatrix4(o);var c=i.intersector.getIntersectByRay(n,h);return c&&(t.intersectToWorld(c,this),s.push(c)),s}toDefaultOrthographicCamera(e){this.switchToCamera("orth"),(e||void 0===e)&&this.render()}toDefaultPerspectiveCamera(e){this.switchToCamera("persp"),(e||void 0===e)&&this.render()}getCameraNameList(){return["pesp","orth"].concat(this.modelManager.getCameraNameList())}switchToCamera(e,t=!0){var i=!0;if("persp"===e)this.camera=this.defaultCamera,this.camera.toPerspective();else if("orth"===e)this.camera=this.defaultCamera,this.camera.toOrthographic();else{var r=this.modelManager.getCamera(e);r?this.camera=r:(console.log("Fail to switch because not found camera '"+e+"'"),i=!1)}return i&&this.cameraControl.setCamera(this.camera),t&&this.modelManager.forceUpdateGTAOPass(),i}getNumOfElements(e){return this.modelManager.getNumOfElements(e)}getNumOfRenderables(e){return this.modelManager.getNumOfRenderables(e)}getNumOfTriangles(e){return this.modelManager.getNumOfTriangles(e)}getNumOfVertices(e){return this.modelManager.getNumOfVertices(e)}setLightPreset(e){r.GlobalData.LightPreset=e,this.getScene().lightPreset(),this.setRenderStateChanged(!0)}getLightPreset(){return r.GlobalData.LightPreset}setAmbientLightIntensity(e){var t=this.getScene().ambientLight;t&&(t.intensity=e,this.setRenderStateChanged(!0))}getAmbientLightIntensity(){var e=this.getScene().ambientLight;return e?e.intensity:void 0}setWalkHeightLocked(e){var t=this.editorManager.getCurrentEditor();t&&t.name===r.EditorMode.WALK&&t.setHeightLocked(e)}setWalkLookMousePressed(e){var t=this.editorManager.getCurrentEditor();t&&t.name===r.EditorMode.WALK&&t.setDragLook(e)}setWalkSpeedRate(e){var t=this.editorManager.getCurrentEditor();t&&(t.name===r.EditorMode.WALK||r.EditorMode.THIRDPERSONWALK)&&(r.EditorConfig.WalkSpeedRate=e)}getWalkSpeedRate(){return r.EditorConfig.WalkSpeedRate}setDrawingStyle(e){r.GlobalData.DrawingStyle=e;const t=e=>{this.modelManager.traverseModels(void 0,(t=>{t instanceof r.BimTilesModel&&t.setBorderLineVisible(e)}))};switch(e){case r.DrawingStyle.SHADINGWITHLINE:t(!0);break;case r.DrawingStyle.SHADING:default:t(!1)}this.setRenderStateChanged(!0)}getWireframeColor(){let e;return this.modelManager.traverseModels(void 0,(t=>{const i=t.wireframeManager;return i?(e=i.getWireframeColor(),!0):t instanceof r.BimTilesModel?(e=t.getWireframeColor(),!0):void 0})),e||r.MaterialUtil.DefaultWireframeColor}setWireframeColor(e){this.modelManager.traverseModels((t=>{const i=t.wireframeManager;i&&i.setWireframeColor(new THREE.Color(e.red/255,e.green/255,e.blue/255),e.alpha),t instanceof r.BimTilesModel&&t.setWireframeColor(new THREE.Color(e.red/255,e.green/255,e.blue/255),e.alpha)})),this.setRenderStateChanged(!0)}restoreWireframeColor(){this.modelManager.traverseModels((e=>{const t=e.wireframeManager;t&&t.restoreWireframeColor(),e instanceof r.BimTilesModel&&e.restoreWireframeColor()})),this.setRenderStateChanged(!0)}setInstanceMode(e){if(!r.GlobalData.Instance===e){if(r.GlobalData.Instance=e,e)this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}).visible=!0;else this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}).visible=!1;this.setRenderStateChanged(!0)}}setTransitionAnimationState(e){this.transitionAnimationState=e}getTransitionAnimationState(){return this.transitionAnimationState}clipConditionPoint(e){const t=r.FillClipPlaneManager.getInstance(this.getScene());if(!(t&&t.isEnabled()&&t.uniforms.vClipPlane.value))return!1;const n=t.uniforms.vClipPlane.value;for(var a=0;a<n.length;++a){const t=n[a];i.setComponents(-t.x,-t.y,-t.z,-t.w),i.normalize();const r=i.normal;if(e.dot(r)<-i.constant)return!0}return!1}clipPoint(e){if(!this.getRenderer())return!1;let t,i=!1;const n=r.FillClipPlaneManager.getCreatedFillClipPlane(this.getScene());n&&n.isEnabled()&&(t=n.uniforms.vClipPlane.value);const a=this.getScene().clipPlanes;a&&a.isEnabled()&&(i=this.editorManager.getToolByName("clipByBox").isReverse,t=a.uniforms.vClipPlane.value);const s=this.getScene().clipRegion;s&&(i=r.ClipRegionManager.isReverse,t=s.uniforms.vClipPlane.value);let o=!1;if(t){const i=new THREE.Plane;for(let r=0;r<t.length;++r){const n=t[r];i.setComponents(n.x,n.y,n.z,n.w);const a=i.normal.negate();e.dot(a)<i.constant&&(o=!0)}}return i?!o:o}getExplosionExtent(e){return this.modelManager.explosionManager.getExplosionExtent(e)}setExplosionExtent(e,t){r.GlobalData.EnableExplosion&&this.modelManager.explosionManager.setExplosionExtent(e,t)}setExplosionCenter(e,t){r.GlobalData.EnableExplosion&&this.modelManager.explosionManager.setExplosionCenter(e,t)}setFloorExplosion(e,t,i,n){r.GlobalData.EnableExplosion&&this.modelManager.explosionManager.setFloorExplosion(e,t,i,n)}getFloorExplosionExtent(e){return this.modelManager.explosionManager.getFloorExplosionExtent(e)}getFloorExplosionDirection(e){return this.modelManager.explosionManager.getFloorExplosionDirection(e)}getFloorExplosionList(e){return this.modelManager.explosionManager.getFloorExplosionList(e)}setFloorInfos(e,t){this.modelManager.explosionManager.setFloorInfos(e,t)}getFloorInfos(e){return this.modelManager.explosionManager.getFloorInfos(e)}setExposureShift(e){this.exposureShift=e,r.GlobalData.ToneMapping=1,this.modelManager.setExposureShift(e),this.setRenderStateChanged(!0)}getExposureShift(){return this.exposureShift}setColorSaturation(e){this.colorSaturation=e,this.modelManager.setColorSaturation(e),this.setRenderStateChanged(!0)}getColorSaturation(){return this.colorSaturation}setColorTemperature(e,t){this.colorTemperature=e,this.colorTemperatureStrength=t,this.modelManager.setColorTemperature(e,t),this.setRenderStateChanged(!0)}getColorTemperature(){return[this.colorTemperature,this.colorTemperatureStrength]}setColorContrast(e){this.colorContrast=e,this.modelManager.setColorContrast(e),this.setRenderStateChanged(!0)}getColorContrast(){return this.colorContrast}setRenderStateChanged(e){this.modelManager&&this.modelManager.setRenderStateChanged(e)}isDesktop(){return r.Utils.isDesktop()}getComponentInfoByUserId(e,t){return this.modelManager.getComponentInfoByUserId(e,t)}getBoundingBoxByIds(e,t,i=!1){var r=this.modelManager.getBoundingBoxByIds(e,t,i);return r.isEmpty()||r.applyMatrix4(this.getScene().getRawMatrixGlobal()),r}getBoundingBoxByIdsWithModelIdSet(e){let t=new THREE.Box3;for(const i in e){let r=this.modelManager.getBoundingBoxByIds(Object.keys(e[i]),i);t.union(r)}return t.isEmpty()||t.applyMatrix4(this.getScene().getRawMatrixGlobal()),t}convertAnnotationsToV3(e){return r.Compatibility.convertAnnotationsToV3(this,e)}loadMpkOnDemand(e,t,i){var r=this;this.modelManager.getLoadOnDemandDirector().loadMpkOnDemandByConditionsWithDelay(e,(function(){r.rendererManager.forceRenderClearScreen();const e={};l&&(e.forceUpdate=!0,l=!1),r.getModelManager().updateScene(null,e)}),t,i)}getBoundingBoxOnDemand(){return this.modelManager.hasLoadOnDemandDirector()?this.modelManager.getLoadOnDemandDirector().getBoundingBoxOnDemand():null}updateGlowEffect(e,t){var i=this;i.rendererManager&&i.rendererManager.renderer&&i.rendererManager.renderer instanceof r.BatchedRenderer&&null!=i.rendererManager.renderer.composer&&i.rendererManager.renderer.composer.updateGlowEffect(e,t)}setGlowEffectById(e,t,i){var n=this;if(n.rendererManager&&n.rendererManager.renderer&&n.rendererManager.renderer instanceof r.BatchedRenderer){null==n.rendererManager.renderer.composer&&n.rendererManager.renderer._createComposer();var a=n.rendererManager.renderer.composer;if(null==t||0==t.length)return;null!=i.isGis&&1==i.isGis?a.isGis=!0:a.isGis=!1,"body"==i.type&&a.setGlowEffectById(e,t,i),"outline"==i.type&&null!=a.highlightoutlinePass&&a.highlightoutlinePass.setHighLightOutlineById(e,t,i)}}removeGlowEffectById(e,t){this.rendererManager.renderer.composer&&((r.GlobalData.GlowCount>0||r.GlobalData.BloomCount>0)&&this.rendererManager.renderer.composer.removeGlowEffectById(e,t),r.GlobalData.HighLightOutlineCount>0&&null!=this.rendererManager.renderer.composer.highlightoutlinePass&&this.rendererManager.renderer.composer.highlightoutlinePass.removeHighLightOutlineById(e,t))}snowOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.snowEffectOpt();i.snowEffectOpt(e)}}rainOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.rainEffectOpt();i.rainEffectOpt(e)}}fogOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.fogEffectOpt();i.fogEffectOpt(e)}}skylineOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.skylineOpt();i.skylineOpt(e)}}getSkyline3D(){return r.GroundPrimitiveManager.getInstance().getSkyline3D()}updateDemMaterialsSide(){var e;this.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e=t.tileManager)})),e&&e.updateMaterialsSide()}addRingScanEffect(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;r.GlobalData.ScanRingCount++;var n=i.addRingScanEffect(e);return t.render(),n}console.warn("请在场景加载成功后,添加环状扫描特效.")}deleteRingScanEffect(e){var t=this;t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer&&null!=t.rendererManager.renderer.composer&&(t.rendererManager.renderer.composer.removeRingScanEffect(e)&&r.GlobalData.ScanRingCount--,t.render())}addFanScanEffect(e){const t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();const i=t.rendererManager.renderer.composer;r.GlobalData.FanScanCount++;const n=i.addFanScanEffect(e);return t.render(),n}console.warn("请在场景加载成功后,添加扇形扫描特效.")}deleteFanScanEffect(e){const t=this;t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer&&null!=t.rendererManager.renderer.composer&&(t.rendererManager.renderer.composer.removeFanScanEffect(e)&&r.GlobalData.FanScanCount--,t.render())}ssaoOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.ssaoEffectOpt();i.ssaoEffectOpt(e)}}ssrOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.ssrEffectOpt();i.ssrEffectOpt(e)}}createAreaInfo(e,t){var i=new r.AreaInfo(e);return i.checkRoomBoundary(t)?i:null}createAreaInfoWithHoles(e,t,i){var n=new r.AreaInfo(e);return n.checkRoomBoundaryWithHoles(t,i)?n:null}enableBlinkComponents(e){this.modelManager.blinkManager.isBlinkPermited()||(this.modelManager.blinkManager.enableBlink(e),this.render())}setBlinkComponentsById(e,t,i){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.setBlinkComponentsById(e,t,i)}addBlinkComponentsById(e,t,i){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsById(e,t,i)}addBlinkComponentsByDetail(e,t,i,r){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsByDetail(e,t,i,r)}clearBlinkComponentsById(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsById(e,t)}clearBlinkComponentsByDetail(e){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsByDetail(e)}enableBlinkComponentsByDetail(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.enableBlinkComponentsByDetail(e,t)}clearAllBlinkComponents(e){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearAllBlinkComponents(e)}getBlinkComponents(e){return this.modelManager.blinkManager.isBlinkPermited()?null:this.modelManager.sceneState.getBlinkComponents(e)}setOutLineColor(e){this.modelManager.traverseModels(void 0,(t=>{t instanceof r.BimTilesModel&&t.setWireframeColor(e)})),this.setRenderStateChanged(!0)}setBlinkColor(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.blinkManager.setBlinkColor(e.color,e.opacity,t)}setBlinkIntervalTime(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.blinkManager.setBlinkIntervalTime(e,t)}enableSnap(e){this.editorManager.getToolByName("pickByRect").enableSnap(e)}pickToPoint(e,t){return this.editorManager.editor.pickHelper.pickToPoint(e,t)}getViewportSize(){return this.rendererManager&&this.rendererManager.getRendererSize()}getRenderer(){return this.rendererManager&&this.rendererManager.getRenderer()}getModelManager(){return this.modelManager}getReceivingPlane(){return this.getScene().getReceivingPlane()}enablePackingMaterial(e){r.GlobalData.IsPackingMaterialEnable=e;this.modelManager.traverseModels(void 0,(t=>{t instanceof r.BimTilesModelV3&&t.setPackingMaterialEnable(e)})),this.setRenderStateChanged(!0)}enableShadow(e){let t=4;this.modelManager.isBimtilesAsset()||this.gisMode||(t=e?6:3),t==r.GlobalData.LightPreset&&4!==t||(this.setLightPreset(t),console.log("enableShadow lightPreset:"+t+"  bias:"+this.getScene().lightManager.lightCastShadow.shadow.bias),this.enableShadowForObjects(e))}enableShadowForObjects(e){let t=this.getScene();e?t.lightManager.shadowLightNum++:t.lightManager.shadowLightNum--;let i=this.getRenderer();if(i.shadowMap.needsUpdate=!0,(!(t.lightManager.shadowLightNum>0)||e)&&r.GlobalData.EnableShadowMap!=e){r.GlobalData.EnableShadowMap=e,i.shadowMap.enabled=e,i.shadowMap.type=THREE.PCFSoftShadowMap,i.shadowMap.autoUpdate=!1;for(var n=this.getScene().getObjectGroups(),a=0;a<n.length;a++){var s=t.getObjectGroupType(n[a].name);if(s.groupType!=r.ObjectGroupType.IBLCUBE&&s.groupType!=r.ObjectGroupType.EXTERNALCOMPONENTMANAGER){var o,l=!0,d=!0;s.databagId?o=this.modelManager.getModel(s.databagId):s.groupType==r.GlobalData.TilePlaneGroupName&&(o=this.modelManager.getModel(r.ObjectGroupType.TILEGROUP)),o&&(l=o.castShadow,d=o.receiveShadow),this.traverseGroupEnableShadow(n[a],l,d)}}}}traverseGroupEnableShadow(e,t,i){var n=this;!function(e){if(e instanceof THREE.Mesh){var a=e.material;if(a instanceof Array){if("PhongLightingMaterial"==a[0].type)return;e.castShadow=!1===a[0].transparent&&t,e.receiveShadow=i;for(var s=0;s<a.length;s++)a[s]&&(a[s].needsUpdate=!0,o=a[s].defines);r.GlobalData.EnableShadowMap&&o&&o.hasOwnProperty("USE_INSTANCE")&&(e.customDepthMaterial=n.getInstanceDepthMaterial())}else{if("PhongLightingMaterial"==a.type)return;e.castShadow=!1===a.transparent&&t,e.receiveShadow=i,a.needsUpdate=!0;var o=a.defines;r.GlobalData.EnableShadowMap&&(a instanceof r.CloudStandardInstanceMaterialV3||a instanceof H.IBLInstanceMaterialV3||o&&o.hasOwnProperty("USE_INSTANCE"))&&(e.customDepthMaterial=n.getInstanceDepthMaterial())}}}(e);for(var a=e.children,s=0,o=a.length;s<o;s++)this.traverseGroupEnableShadow(a[s],t,i)}getInstanceDepthMaterial(){return this.modelManager.getInstanceDepthMaterial()}updateShadowMap(){r.GlobalData.EnableShadowMap&&(this.getRenderer().shadowMap.needsUpdate=!0)}enableVR(e){this.rendererManager.enableVR(e)}enableDamping(e){(e=r.Utils.defaultValue(e,!1))?this.cameraControl.enableDamping():this.cameraControl.disableDamping()}setDampingFactor(e){(e=r.Utils.defaultValue(e,10))>=10&&(e=10),e<=1&&(e=1),e=11-e,this.cameraControl.dynamicDampingFactor(e/10)}calcShadowDirection(e,t){var i=r.JulianDate.fromDate(t),n=r.GIS.Transforms.computeTemeToPseudoFixedMatrix(i),a=r.Simon1994PlanetaryPositions.computeSunPositionInEarthInertialFrame(i);a.applyMatrix3(n);var s=r.Tile.TileMath.fromDegrees(e[0],e[1],0),o=r.GIS.Transforms.eastNorthUpToFixedFrame(s);o.invert();var l=new THREE.Vector4(a.x,a.y,a.z,1);l.applyMatrix4(o);var d=new THREE.Vector3;return d.set(l.x,l.y,l.z),d.normalize(),(d=this.worldToDrawing(d)).normalize(),d}getMaterialsByComponentId(e,t){const i=this.getModelManager().getModel(e),r=i.getFilter()._getOverrideMaterialById(t);if(r)return[r];const n=i.getNodeInfosByUserId(t);let a={};for(let e=0,t=n.length;e<t;e++){const t=n[e].materialId;if(a[t])continue;let r=i.getMaterialByMaterialId(t,n[e]);r&&(a[t]=r.clone(),a[t].name=a[t].name.toString())}return Object.values(a)}cloneModel(e,t){const i=this.getModelManager().getModel(e);return r.Utils.isDefined(i)?i.clone({modelId:t}):(console.log(`can not find model with id ${e}`),null)}getHeightLimitManager(){return this.heightLimitManager||(this.heightLimitManager=new r.HeightLimitManager(this)),this.heightLimitManager}getClipCapsManager(){return this.clipCapsManager||(this.clipCapsManager=new r.ClipCapsManager(this)),this.clipCapsManager}enableEmbeddedView(e){null!=this.scissorViewportManager&&(e?this.scissorViewportManager.show():this.scissorViewportManager.hide())}setEmbeddedView(e){null!=this.scissorViewportManager&&this.scissorViewportManager.effectOpt(e)}setSceneUnit(e){this.modelManager.setSceneUnit(e)}getSceneUnit(){return this.modelManager.getSceneUnit()}getClientSize(){var e=this.domElement===document?this.domElement.body:this.domElement;return this.clientSize.set(e.clientWidth,e.clientHeight),this.clientSize}enableOIT(e){this.rendererManager.enableOIT(e),this.rendererManager._isSupportOIT()?this.modelManager.updateAlphaMapProperties(!0):this.modelManager.updateAlphaMapProperties(!1)}setOITAntialiasMode(e){this.rendererManager.setOITAntialiasMode(e),this.render()}restoreMaterialByMaterialId(e,t){let i=this.modelManager.getModel(e).materialManager,r=i.materialIdMap;if(!r)return!1;let n=r[t];if(null==n)return!1;let a=i.materials[n];i.restoreMaterialParam(a);let s=i.instanceMaterials[n];if(!s)return!0;for(let e=0;e<s.length;e++)i.restoreMaterialParam(s[e]);return!0}overrideMaterialByMaterialId(e,t,i,r){function n(e){if(a.storeMaterialParam(e),i.diffuse_color){var t=i.diffuse_color.split(",");e.color.setRGB(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),e.opacity=parseFloat(t[3])}var n=e.opacity<1;e.transparent=n,e.map=r,e.needsUpdate=!0}let a=this.modelManager.getModel(e).materialManager,s=a.materialIdMap[t];if(null==s)return!1;n(a.materials[s]);let o=a.instanceMaterials[s];if(!o)return!0;for(let e=0;e<o.length;e++)n(o[e]);return!0}loadMaterialIds(e,t,i){let n=this.modelManager.getModel(e);if(!(n instanceof r.Model))return console.log("ERROR:only support BMD now"),void(i&&i());let a=n.materialManager.materialIdMap;a?t&&t(Object.keys(a)):n._getHandler().loader._loadMaterialId(t,i)}setSelectionByMaterialId(e,t){let i=this;this.loadMaterialIds(e,(function(r){let n=i.modelManager.getModel(e),a=n.materialManager.materialIdMap[t];i.clearSelection();let s=i.rendererManager.getPickingEffecter();if(null!=a){if(!n.materialIdUserIdMap){let e=n.getAllNodeInfos(),t=Object.keys(e),i={};for(let r=0;r<t.length;r++){let n=e[t[r]],a={};for(let e=0;e<n.length;e++){let t=n[e].materialId;a[t]||(a[t]=!0,i[t]||(i[t]=[]),i[t].push(n[e].userId))}}n.materialIdUserIdMap=i}s.selectedMaterialId=a,i.addToSelection(n.materialIdUserIdMap[a])}else s.selectedMaterialId=void 0}))}hasBimtilesModel(){if(void 0!==this.hasBimtile)return this.hasBimtile;return this.modelManager.traverseModels(void 0,(e=>{e instanceof r.BimTilesModel&&(this.hasBimtile=!0)})),this.hasBimtile}shouldUseCompressedNormal(){let e=!1;return this.modelManager.traverseModels(void 0,(t=>{t instanceof r.BimTilesModel&&!0===t.isUseCompressedNormal()&&(e=!0)})),e}setFoveatedConePriorityEnabled(e){this._foveatedConeLimit.priorityEnabled=e}setDegradedFactor(e){this._foveatedConeLimit.degradedFactor=r.Math.clamp(e,0,1)}setFoveatedConeFactor(e){this._foveatedConeLimit.foveatedConeFactor=r.Math.clamp(e,0,1)}setFoveatedSseRelaxation(e){this._foveatedConeLimit.foveatedSseRelaxation=e}getComponentsByRaycaster(e,t,i){e=new THREE.Vector3(e.x,e.y,e.z),t=new THREE.Vector3(t.x,t.y,t.z);const n=this.worldToDrawing(e),a=this.worldToDrawing(t).normalize(),s=new r.Raycaster(n,a),o=new r.IntersectHelper(this),l=this.cameraControl.getIntersectContext(null);s.viewportSize=l.viewportSize,s.camera=l.camera;const d=o.getObjectsByRaycaster(l,s,!0);let h=[];const c=this.getFilter();for(const t of d){const n=this.drawingToWorld(t.point);let a={id:t.userId,modelId:t.modelId,distance:e.distanceTo(n),position:n,normal:t.face?t.face.normal:void 0};const s=t.modelId;if(!r.Utils.defined(s)){a.isMap=!0,h.push(a);continue}let o=this.getUserdataByUserId(t.userId,s);null===o&&(o={}),o.modelId=s,o.userId=t.userId;const l=i.length;let d=[];for(let e=0;e<l;e++){const t=i[e];t.modelId&&t.modelId!==s||(t.modelId&&1===Object.keys(t)||d.push(Object.assign({},t)))}0===d.length&&0!==l||c.isMatchConditions(o,d,s)&&h.push(a)}return h}getComponentsByRaycasterConditions(e,t,i){const n=this.getComponentsByRaycaster(e,t,[]),a=this.getFilter();let s=[];for(const e of n){const t=e.modelId;if(!r.Utils.defined(t)){e.isMap=!0,s.push(e);continue}const n=e.id;let o=this.getUserdataByUserId(n,t);null===o&&(o={});let l=!1;for(const e of i)if(t==e.modelId){if(void 0===e.userId&&void 0===e.objectData){l=!0;break}if(e.userId&&e.userId.indexOf(n)>-1){l=!0;break}if(e.objectData&&a.isMatchConditions(o,e.objectData,t)){l=!0;break}}!0!==l&&0!==i.length||s.push(e)}return s}setShowTileType(e){e!=this.showTileType&&(this.showTileType=e,this.render())}getAllModelUserIds(){let e={};return this.modelManager.traverseValidModels((t=>{if(!t.getFilter())return;const i=t.getAllUserIds();e[t.id]=i})),e}_enableStopUpdateScene(e){this.inputStatusMonitor.enableStopUpdateScene(e)}getTerrainHeightRange(){return this.getScene().getTerrainHeightRange()}getSceneHeightRangeWorld(){const e=this.getBoundingBoxWorld();return{max:e.max.z,min:e.min.z}}getSceneHeightRange(){const e=this.getBoundingBox();return{max:e.max.y,min:e.min.y}}enableRecordFPS(e){const t=this.rendererManager.renderer;t&&t.enableRecordFPS&&t.enableRecordFPS(e)}getFPSInfo(){const e=this.rendererManager.renderer;return e&&e.getFPS?e.getFPS():{}}isWorkerEnabled(){return r.GlobalData.WorkerEnabled}isMeshCreateLimitEnabled(){return this.isWorkerEnabled()&&r.GlobalData.EnableMeshCreateLimit}isEnableSchedulingSort(){return r.GlobalData.EnableSchedulingSort}enableGroundDrawingMultiSample(e){r.GroundDrawingManager.getInstance().multiSample=e}getBackground(){return this._background}setBackground(e,t,i){}enableOverrideWithSameParameter(e){this.modelManager.traverseValidModels((t=>{t.enableOverrideWithSameParameter&&t.enableOverrideWithSameParameter(e)})),this.render()}}})()}();